åªè®°å½•éƒ¨åˆ†ã€‚



## å¤šå¤„ç†å™¨ç¼–ç¨‹

<img src="pic/image-20241110231300436.png" alt="image-20241110231300436" style="zoom:50%;" />

- è¯æ˜å…±äº«å†…å­˜

    > **==DEMO==**
    >
    > **å¹¶å‘çº¿ç¨‹æ¨¡å‹**ï¼š**å¹¶å‘çº¿ç¨‹èƒ½å¤Ÿè¯»å†™å…±äº«çš„ heap å †åŒº**ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæ¯ä¸ªçº¿ç¨‹æŒæœ‰å±€éƒ¨å˜é‡çš„å‰¯æœ¬ã€‚Mosaic ä¸ä¼šè‡ªåŠ¨åœ¨æ¯æ¡è¯­å¥ä¹‹åè¿›è¡Œçº¿ç¨‹è°ƒåº¦ï¼šæˆ‘ä»¬éœ€è¦æ‰‹å·¥æ’å…¥ `sys_sched`ã€‚







## å¹¶å‘æ§åˆ¶ï¼šäº’æ–¥ï¼ˆ1ï¼‰

<img src="pic/image-20241118211713662.png" alt="image-20241118211713662" style="zoom:50%;" />

æ€ä¹ˆåº”å¯¹ï¼Ÿ



### é˜»æ­¢å¹¶å‘ï¼ˆå¹¶è¡Œï¼‰çš„å‘ç”Ÿ

ä»€ä¹ˆå«äº’æ–¥ï¼Ÿä»€ä¹ˆå«å¹¶å‘ï¼Ÿ

> **Concurrent** means happening at the same time

â€è¦æ±‚æ•´ä¸ªä¸–ç•Œæœ‰å°æ®µæ—¶é—´åªå±äºè‡ªå·±ï¼Œä»»ä½•äººéƒ½ä¸èƒ½æ‰“æ–­â€œ

â€äººæƒ³è±¡æˆçº¿ç¨‹ï¼Œå¤šçº¿ç¨‹æƒ³è±¡æˆç‰©ç†ä¸–ç•Œâ€œ

- **äº’æ–¥** (äº’ç›¸æ’æ–¥)ï¼šé˜»æ­¢å¹¶å‘

<img src="pic/image-20241118211611213.png" alt="image-20241118211611213" style="zoom:50%;" />

**é‚£å¦‚ä½•å®ç°äº’æ–¥ï¼Ÿ**

å•æ ¸å®ç°äº’æ–¥ï¼šå…³ä¸­æ–­

<img src="pic/image-20241118214211804.png" alt="image-20241118214211804" style="zoom:50%;" />

> ###### **==DEMO==**
>
> **Stop-the-world å®ç°äº’æ–¥**ï¼šå¯¹äºæ“ä½œç³»ç»Ÿä¸Šçš„åº”ç”¨ç¨‹åºï¼Œå…³é—­ä¸­æ–­æ˜¯ä¸èƒ½å®¹å¿çš„ï¼šè¿™ä¼šä½¿å¾®å°çš„ bug æˆ–æ˜¯æ¶æ„çš„ç¨‹åºç ´åè®¡ç®—æœºçš„è¿è¡Œã€‚æ“ä½œç³»ç»Ÿæ­£æ˜¯å› ä¸ºç»Ÿæ²»äº†ä¸­æ–­ï¼Œæ‰å®ç°äº†å¯¹åº”ç”¨ç¨‹åºçš„ç®¡ç†ã€‚**åœ¨æ“ä½œç³»ç»Ÿå†…æ ¸çš„å®ç°ä¸­ï¼Œå…³é—­ä¸­æ–­æ˜¯ä¸€ä¸ªå¸¸è§çš„æ“ä½œã€‚**
>
> ```C
> // Clear FL_IF in the CPU.
> // Interrupt disabled.
> asm volatile("cli");
>                                                                                                                         
> // Set FL_IF in the CPU.
> // Interrupt enabled.
> asm volatile("sti");
> 
> ```

> ä¾‹å¤–ï¼šä¸å¯å±è”½ä¸­æ–­ NMI (Non-Maskable Interrupts) [Non Maskable Interrupt - OSDev Wiki](https://wiki.osdev.org/Non_Maskable_Interrupt)
>
> - å¯ä»¥åˆ©ç”¨ NMI å®ç°é”™è¯¯ç›‘æ§
>     - è®¾ç½®ç¡¬ä»¶å®šæ—¶è§¦å‘
>     - æ“ä½œç³»ç»Ÿå®šæ—¶å¤ä½å®šæ—¶å™¨
>     - è§¦å‘ timeoutï¼Œæ‰§è¡Œ NMI å¤„ç†ç¨‹åº
>         - ä¾‹å¦‚ï¼Œé‡å¯è®¡ç®—æœº
>
> ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¸ªä¸å¯å±è”½ä¸­æ–­ï¼Ÿ
>
> å…¶å®åˆšå¼€å§‹æˆ‘å¯¹è¿™ä¸ªæ¦‚å¿µæ˜¯å¾ˆè¿·ç³Šçš„ï¼Œå¹¶æ²¡æœ‰å…·ä½“å¤§å°è±¡å’Œæ¦‚å¿µï¼Œå› ä¸ºè‡ªå·±å¹¶ä¸æ˜¯å¯¹ç”µè„‘ç‰¹åˆ«çš„ç†Ÿæ‚‰ï¼Œæ¯•ç«Ÿæ˜¯è¯´ä»ä¸Šå¤§å­¦æ‰å¼€å§‹æ¥è§¦ï¼Œå­¦ä¹ å®ŒæˆPAï¼Œå¯¹è½¯ä»¶å’Œç¡¬ä»¶æœ‰äº†ä¸€å®šå¯¹äº†è§£ä¹‹åï¼Œå…¶å®è®¡ç®—æœºä¸­çš„ä»»ä½•ä¸œè¥¿éƒ½æ˜¯äººé€ å‡ºæ¥çš„ï¼Œå—åˆ°å„ç§å„æ ·çš„å› ç´ è½¯ä»¶å’Œç¡¬ä»¶éƒ½ä¼šæœ‰é”™è¯¯ï¼ˆå½“ç„¶ç°åœ¨çš„è®¡ç®—æœºè½¯ç¡¬ä»¶å¯èƒ½ç›¸å¯¹å®Œå–„ï¼‰ï¼Œå¾ˆå¤šçš„é”™è¯¯æƒ…å†µåœ¨ç¡¬ä»¶å’Œè½¯ä»¶ä¸Šéƒ½ä¼šé€šè¿‡å„ç§æ–¹å¼æ¥å‘ŠçŸ¥æˆ‘ä»¬å®ƒåäº†ï¼Œè€Œè¿™ç§æ–¹å¼å°±æ˜¯å‰äººé‡åˆ°äº†ç±»ä¼¼çš„é—®é¢˜ï¼Œä»–ä»¬æƒ³å‡ºæ¥äº†ä¸€ç§æ–¹æ¡ˆï¼Œæœ€ç»ˆå®æ–½åˆ°è®¡ç®—æœºä¸Šã€‚
>
> NMI æˆ–è®¸å°±æ˜¯è¿™ä¹ˆä¸€ç§æ–¹å¼ï¼ˆæˆ‘åªæ˜¯è¿™ä¹ˆæ–¹ä¾¿ç†è§£ï¼Œåªæ˜¯çŒœçš„ï¼‰ã€‚æ‰€ä»¥æˆ‘å¯¹ NMI åŠä¸­æ–­å¤„ç†ç¨‹åº çš„ç†è§£å…¶å®ä¹Ÿå°±æ˜¯å¤„ç†ä¸€äº›ä¸å¯æ¢å¤æå…¶é‡è¦çš„ç¡¬ä»¶æ•…éšœé”™è¯¯ä»¥åŠè®©æˆ‘ä»¬ä¿®å¤å®ƒï¼Œä¸ç„¶è®¡ç®—æœºå°±æ²¡æ³•å·¥ä½œå•¦ã€‚æ¯”å¦‚èŠ¯ç‰‡å†…éƒ¨æŸå¤„å‡ºç°æ•…éšœï¼›å†…å­˜æ¡æŸåï¼Œæ“ä½œç³»ç»Ÿæ€ä¹ˆèƒ½å‘ç°ï¼ŸECCã€å¥‡å¶æ ¡éªŒï¼Ÿ
> è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆå¾ˆå¤šè€å¼çš„æœºå™¨ä¸Šä¼šæœ‰å¤ä½æŒ‰é”®ã€‚
>
> å¯èƒ½ä¸Šé¢è¿˜æ˜¯å¾ˆè¿·ç³Šï¼Œå†ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨åµŒå…¥å¼ä¸­æŒºæœ‰ç”¨çš„ï¼šåœ¨å¤„ç†å™¨å› é™ç”µæ”¾ç”µè€Œé™·å…¥å¾ªç¯æ—¶ã€‚å½“å¸¸è§„ä¸­æ–­å…³é—­æ—¶ï¼Œç³»ç»Ÿæ— æ³•æ¢å¤é”™è¯¯çŠ¶æ€ï¼Œè€ŒNMIå› å…¶ä¸å¯å±è”½æ€§ï¼Œå¯ä»¥é€šè¿‡æ¥è‡ªçœ‹é—¨ç‹—å®šæ—¶å™¨ã€åå¤„ç†å™¨æˆ–äººå·¥æŒ‰é’®çš„ä¿¡å·ä½¿å¤„ç†å™¨æ¢å¤å·¥ä½œçŠ¶æ€ã€‚
>
> å†å¦‚ï¼šNMIå¤„ç†ç¨‹åºå¯ä»¥å¤„ç†å¦‚çƒ­äº‹ä»¶æˆ–ç”µæºæ•…éšœç­‰æƒ…å†µï¼Œä»¥é˜²æ­¢æŸåæˆ–ç¡®ä¿åœ¨æ–­ç”µå‰å°†æ•°æ®å¤‡ä»½åˆ°éæ˜“å¤±æ€§å­˜å‚¨ã€‚



é‚£å¤šå¤„ç†å™¨å‘¢ï¼Ÿ

<img src="pic/image-20241118211902945.png" alt="image-20241118211902945" style="zoom:50%;" />



### ä½¿ç”¨ load/store å®ç°äº’æ–¥ï¼ˆï¼‰

ä¸»è¦æ˜¯**Peterson ç®—æ³•**ã€‚ç›´æ¥çœ‹çœ‹è®²ä¹‰å’Œè§†é¢‘è®²è§£å§ã€‚



### åœ¨å¤šå¤„ç†å™¨ä¸Šå®ç°äº’æ–¥

<img src="pic/image-20241118212608893.png" alt="image-20241118212608893" style="zoom:50%;" />

éœ€è¦æ„è¯†åˆ°ï¼š**å› ä¸ºäººç±»æ˜¯â€œsequential creaturesâ€ï¼Œå¯¼è‡´è¿‡å»çš„å¾ˆå¤šè®¾è®¡æ˜¯æ²¡æœ‰è€ƒè™‘å¹¶å‘çš„ï¼ˆå¤šå¤„ç†å™¨ã€å…±äº«å†…å­˜ï¼‰ï¼Œè€Œæˆ‘ä»¬åœ¨å…±äº«å†…å­˜ä¸Šå®ç°äº’æ–¥çš„å¤±è´¥å’ŒæˆåŠŸå°è¯•åï¼Œæˆ‘ä»¬æ„è¯†åˆ°è½¯ä»¶éœ€è¦å’Œç¡¬ä»¶ååŒå·¥ä½œï¼Œå¹¶åœ¨ç¡¬ä»¶åŸå­æŒ‡ä»¤åŸºç¡€ä¸Šå®ç°äº†åŸºç¡€ç‰ˆæœ¬çš„è‡ªæ—‹é”ã€‚**

å…³é”®åœ¨äºç¡¬ä»¶å®ç°ï¼Œåœ¨ OS è¯¾ä¸Šå¯ä¸ç”¨æ·±ç©¶ï¼Œä¸å±äºæœ¬é—¨è¯¾çš„èŒƒå›´ã€‚

> æ›´å¤šå†…å®¹ï¼š
>
> [x86 - How are atomic operations implemented at a hardware level? - Stack Overflow](https://stackoverflow.com/questions/14758088/how-are-atomic-operations-implemented-at-a-hardware-level)
>
> [computer architecture - How does an atomic operation guarantee consistency from a hardware perspective? - Super User](https://superuser.com/questions/400786/how-does-an-atomic-operation-guarantee-consistency-from-a-hardware-perspective)
>
> [è®¡ç®—æœºåŸå­ï¼ˆatomicï¼‰æ“ä½œçš„å®ç°åŸç†è§£æ - çŸ¥ä¹](https://zhuanlan.zhihu.com/p/649646816)
>
> è¿™é‡Œå¯ä»¥æ€»ç»“ä¸ºï¼š
>
> Extra transistors in the chip to implement **special cache** and memory coherency and **bus synchronization procotols**. The long answer is way too long.
>
> å†è¿›ä¸€æ­¥ä¸¾ä¾‹ç›¸å…³å®ç°æ‰‹æ®µï¼š
>
> æ€»çº¿é”å®šã€ç¼“å­˜é”å®šã€ç›¸å…³ç¼“å­˜ä¸€è‡´æ€§åè®®ã€LL/SCï¼ˆLR/SCï¼ˆarmv8çš„ç‹¬å åŠ è½½ã€ç‹¬å å­˜å‚¨ï¼‰ï¼‰
>
> å…·ä½“æ€ä¹ˆå®ç°ï¼Ÿæˆ‘è§‰å¾—è¿™åº”è¯¥å±äºä½“ç³»ç»“æ„ã€å¤šæ ¸å¤„ç†å™¨è®¾è®¡ä¸Šçš„ç›¸å…³å†…å®¹äº†ï¼Œçœ‹çœ‹æ€ä¹ˆå¯¹æ€»çº¿æ“ä½œï¼Ÿ
>
> [å†…å­˜ä¸€è‡´æ€§(Memory Consistency) - çŸ¥ä¹](https://zhuanlan.zhihu.com/p/422848235)
>
> å¯ä»¥å†å¥½å¥½æ€»ç»“ã€‚ã€‚**==TODO==**



å®ç°ã€‚

> ä¸º add/inc ç­‰æŒ‡ä»¤å¢åŠ  lock çš„å‰ç¼€ï¼Œå¤„ç†å™¨ç¡¬ä»¶ä¼šå®ç°å°†è¿™æ¡æŒ‡ä»¤å®ç°ä¸ºåŸå­æŒ‡ä»¤ã€‚

![image-20250108234540240](pic/image-20250108234540240.png)

æå‡ºè¿™ä¸ªè‡ªæ—‹é”è¿˜æ˜¯æŒºè‡ªç„¶çš„ï¼Œé¡ºç€ä¹‹å‰ä¸Šå•æ‰€çš„ä¾‹å­ï¼Œå•æ‰€æœ‰äººï¼ˆçº¿ç¨‹1ï¼‰ï¼Œæˆ‘ï¼ˆçº¿ç¨‹2ï¼‰å°±ä¸€ç›´åœ¨é—¨å£ç­‰ç€å‘—ï¼Ÿæˆ‘å°±å µåœ¨è¿™å‘—ï¼Œä»€ä¹ˆæ—¶å€™çº¿ç¨‹1å¥½äº†ï¼Œæˆ‘å†è¿›å»ä¸Šå•æ‰€å‘—ã€‚

> çœ‹åˆ°è¿™é‡Œæ€»æ˜¯ä¼šæƒ³ç€ä¼˜åŒ–ï¼Œè¿™ä¸ªçº¿ç¨‹å µäº†ï¼ŒOS è®© CPU æ‰§è¡Œåˆ«çš„ çº¿ç¨‹ï¼Œåˆ«æµªè´¹å‘€ã€‚æœ‰æ²¡æœ‰èƒ½ä¸å µçš„æ–¹æ³•ï¼Ÿè‚¯å®šæœ‰ï¼äº’æ–¥é”å—ï¼Ÿåœ¨ `FreeRTOS` é‡Œç”¨è¿‡ä¸€ç‚¹ï¼Œä½†æ˜¯æ˜¯å•æ ¸ä¸Šçš„ MCU çš„ã€‚

<img src="pic/image-20241118212545883.png" alt="image-20241118212545883" style="zoom: 50%;" />

ç»ˆäºï¼Œæˆ‘ä»¬å€ŸåŠ©**è®¡ç®—æœºç¡¬ä»¶æä¾›çš„çŸ­æ—¶åŸå­æ€§**å®ç°äº†å¤šå¤„ç†å™¨é—´çš„äº’æ–¥ã€‚







## å¹¶å‘æ§åˆ¶ï¼šäº’æ–¥ï¼ˆ2ï¼‰

### ç°å®è¦æ±‚ä½†æœ‰äººä¸éµå®ˆ

ç†æƒ³çš„å®ç°ä»¥åŠæ•ˆæœã€‚

![image-20250109120936754](pic/image-20250109120936754.png)

éƒ½å¾—éµå¾ªè¿™ä¸ªè§„åˆ™ã€‚å¦‚æœæ²¡æœ‰ï¼Ÿå¿˜è®°åŠ é”ã€å†åŠ äº†ä¸€æ¬¡ï¼Ÿ

![image-20250109120904253](pic/image-20250109120904253.png)



### æ“ä½œç³»ç»Ÿå†…æ ¸ä¸­çš„è‡ªæ—‹é”

> ä¹‹å‰è¯¾ä¸Šçš„ä¾‹å­æ˜¯åœ¨åº”ç”¨ç¨‹åºä¸Šçš„å®ç°äº’æ–¥ï¼Œå› ä¸ºåº”ç”¨ç¨‹åºä¸èƒ½å…³ä¸­æ–­ã€‚
>
> ä½†åˆ«å¿˜äº†ï¼Œæ“ä½œç³»ç»Ÿæ‰æ˜¯ç¬¬ä¸€ä¸ªå¹¶å‘ç¨‹åºï¼Œæˆ‘ä»¬éœ€è¦è§£å†³å†…æ ¸ä¸­æ€ä¹ˆåšåˆ°äº’æ–¥ä»¥å®ç°æ­£ç¡®çš„å¹¶å‘ï¼Œ
>
> åªæœ‰æ“ä½œç³»ç»Ÿä¸ºå®é™…è®¡ç®—ä¸­çš„å¹¶å‘æ‰“ä¸‹åŸºç¡€ï¼Œåº”ç”¨ç¨‹åºæ‰èƒ½ç›´åˆ°å¦‚ä½•ç®¡ç†å¤šä¸ªçº¿ç¨‹å’Œè¿›ç¨‹ã€‚

ä½†æˆ‘è¿˜å¯ä»¥æ¥ç€ä¹‹å‰åº”ç”¨ç¨‹åºçš„å†…å®¹æ¥å®ç°å†…æ ¸ç›¸å…³çš„å†…å®¹ã€‚æœ‰äº†lockï¼Œé‚£å°±èƒ½ä¿è¯äº’æ–¥ï¼Ÿå¯¹äºå†…æ ¸æ¥è¯´ï¼Ÿå›æƒ³è®¡ç®—æœºçŠ¶æ€æœºçš„æ¨¡å‹ï¼š

![image-20250109122200699](pic/image-20250109122200699.png)

ä¹Ÿå°±æ˜¯è¯´ï¼Œèƒ½æ”¹å˜å½“å‰è®¡ç®—æœºçš„çŠ¶æ€çš„ï¼Œè¿˜æœ‰ä¸­æ–­ã€‚

> - æ“ä½œç³»ç»Ÿæ¥ç®¡äº†å®Œæ•´çš„è®¡ç®—æœºç³»ç»Ÿ
>     - æ¯ä¸ªå¤„ç†å™¨éƒ½å¹¶è¡Œ x++
>     - æ¯ä¸ªå¤„ç†å™¨ä¸­æ–­å‘ç”Ÿæ—¶æ‰§è¡Œ x += 1000000000
>     - (å‡æƒ³ x æ˜¯æ“ä½œç³»ç»Ÿä¸­çš„æ•°æ®ç»“æ„ï¼Œä¾‹å¦‚è¿›ç¨‹è¡¨)
> - å¦‚ä½•æ­£ç¡®å®ç° x çš„åŸå­è®¿é—®ï¼Ÿ
>     - ä»…ä»…è‡ªæ—‹æ˜¯ä¸å¤Ÿçš„
>     - **å› ä¸ºè¿˜æœ‰ä¸­æ–­**

lock() -> sum++ -> ä¸­æ–­æ¥äº† -> (æœ‰ä¸´ç•ŒåŒºï¼Œä¸­æ–­ä¹Ÿæƒ³å¯¹sum++) -> (ä½†æ˜¯ä¹‹å‰å·²ç»lockè¿‡ï¼Œæ‰€ä»¥å°±æ­»åœ¨è¿™é‡Œäº†ï¼deadlock)

> ä¸­æ–­çš„å‘æ˜ï¼Œç”±äº IO æ¯” CPU æ…¢å¾ˆå¤šï¼ŒIO åšå®Œäº†å†å‘Šè¯‰ CPU æ¥å¤„ç†æˆ‘ç›¸å…³çš„ï¼Œå®ƒä»¬æ˜¯å¼‚æ­¥çš„ã€‚



é‚£æ€ä¹ˆåšï¼Ÿä¹‹å‰è¿˜æ²¡å®ç°åŸå­æ€§çš„æ—¶å€™ï¼Œå•æ ¸æ€ä¹ˆåšçš„äº’æ–¥ï¼šå…³ä¸­æ–­ï¼ŒåŠ åˆ°è¿™é‡Œæ¥ã€‚

é‚£ä¹Ÿè‡ªç„¶å¸¦æ¥ä¸€ä¸ªé—®é¢˜ï¼šæ˜¯åœ¨lockå‰å…³ä¸­æ–­è¿˜æ˜¯lockåå…³ä¸­æ–­ï¼Ÿ

è‡ªç„¶æ˜¯åœ¨ lock å‰å…³ä¸­æ–­ï¼Œå¦‚æœæ˜¯åœ¨lockåï¼Œé‚£åœ¨é‚£ä¸€ç¬é—´è¿˜æ˜¯ä¼šæ¥ä¸­æ–­ï¼Œä¾ç„¶ä¼šé€ æˆdeadlockã€‚

> `disable irq` -> `lock` -> `sum++` ->`enable irq`

æœ‰ä¸ªé—®é¢˜ï¼Œåˆ°æœ€åçš„æ—¶å€™ï¼Œå˜æˆäº†å¼€ä¸­æ–­ï¼Œä½†å¦‚æœåœ¨ `disable irq` ä¹‹å‰çš„ CPU çŠ¶æ€å°±æ˜¯ å…³ä¸­æ–­å‘¢ï¼Ÿ

æ‰€ä»¥ï¼Œéœ€è¦ä¿å­˜ä¸­æ–­çŠ¶æ€ï¼

> å“¦ï¼Œè¿™å°±æ˜¯æˆ‘åœ¨ NEMU ç§»æ¤ Linux çš„æ—¶å€™çœ‹çš„ Linux kernel ä»£ç é‡Œçš„ `arch/risc-v` é‡Œçœ‹åˆ°çš„ `arch_local_save_flags` ï¼Ÿ
>
> ```C
> #ifdef CONFIG_TRACE_IRQFLAGS_SUPPORT
> #define irqs_disabled()                 \
>     ({                      \
>         unsigned long _flags;           \
>         raw_local_save_flags(_flags);       \
>         raw_irqs_disabled_flags(_flags);    \
>     })
> #else /* !CONFIG_TRACE_IRQFLAGS_SUPPORT */
> #define irqs_disabled() raw_irqs_disabled()                                                                               
> #endif /* CONFIG_TRACE_IRQFLAGS_SUPPORT */
> //include/linux/irqflags.h
> 
> #define raw_local_save_flags(flags)         \                                                                             
>     do {                        \
>         typecheck(unsigned long, flags);    \
>         flags = arch_local_save_flags();    \
>     } while (0)
> // include/linux/irqflags.h
> 
> /* read interrupt enabled status */
> static inline unsigned long arch_local_save_flags(void)
> {
>     return csr_read(CSR_STATUS);
> }
> 
> /* unconditionally enable interrupts */
> static inline void arch_local_irq_enable(void)
> {
>     csr_set(CSR_STATUS, SR_IE);
> }
> // arch/riscv/include/asm/irqflags.h
> ```

<img src="pic/image-20250109130549323.png" alt="image-20250109130549323" style="zoom:50%;" />

> æ— è®ºå®ç°ä»€ä¹ˆï¼Œå…ˆè®¤ä¸ºæ˜¯å¯¹çš„ï¼Œå…ˆå†™ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Ÿ
>
> å®ç°ä¸€ä¸ªè‡ªæ—‹é”ï¼Œç›¸æ¯”å®ç°ä¸€ä¸ªè‡ªæ—‹é”çš„test driver ä¸é‚£ä¹ˆé‡è¦ã€‚ï¼Ÿï¼Ÿ





### 7.2 æ“ä½œç³»ç»Ÿå†…æ ¸ä¸­çš„ (åŠ) æ— é”äº’æ–¥ï¼šRead-Copy-Update ğŸŒ¶ï¸

**åœ¨çœŸæ­£çš„æ“ä½œç³»ç»Ÿä¸­å®ç°äº’æ–¥ï¼Œå…¶å®æ²¡æœ‰é‚£ä¹ˆç®€å•ã€‚**

> è¦çœŸæ­£åœ¨æ“ä½œç³»ç»Ÿå†…æ ¸ä¸­ç”¨èµ·æ¥ï¼Œè¿˜è¦è€ƒè™‘å¾ˆå¤šã€‚
>
> Scalability(ä¼¸ç¼©æ€§ã€å»¶å±•æ€§...): æ€§èƒ½çš„æ–°ç»´åº¦
>
> - ä¸¥è°¨çš„ç»Ÿè®¡å¾ˆéš¾
>     - CPU åŠ¨æ€åŠŸè€—
>     - ç³»ç»Ÿä¸­çš„å…¶ä»–è¿›ç¨‹
>     - è¶…çº¿ç¨‹
>     - NUMA
>     - â€¦â€¦
>
> [Benchmarking crimes](https://gernot-heiser.org/benchmarking-crimes.html) by Gernot Heiser

å‡å¦‚é‡‡ç”¨ä¸Šé¢çš„é‚£ç§æ–¹æ¡ˆå®ç°äº’æ–¥ï¼šè‡ªæ—‹ + å…³ä¸­æ–­ã€‚

é¦–å…ˆï¼Œè‡ªæ—‹é”çš„ç¼ºç‚¹ï¼Œscalability éå¸¸å·®ï¼Œæ¯æ¬¡éœ€è¦å¹¶å‘æ§åˆ¶çš„æ—¶å€™ï¼Œå†…æ ¸å°±å¡åœ¨é‚£é‡Œä¸åŠ¨ï¼Œå¦‚æœæ—¶é—´å¾ˆé•¿ï¼Œæå¤§åœ°æµªè´¹äº†ç¡¬ä»¶èµ„æºã€‚

å†è€…ï¼Œå…³ä¸­æ–­åŒæ ·ä¹Ÿä¸èƒ½å…³å¤ªé•¿ï¼Œå…³ 1 ç§’çš„ä¸­æ–­ï¼Œå°±å¿½ç•¥äº†å¾ˆå¤šçš„æ—¶é’Ÿä¸­æ–­ï¼ˆå°±å‡å¦‚10msæ¥ä¸€ä¸ªï¼Œ100ä¸ªï¼‰ï¼Œåœ¨è¿™äº›æ—¶é’Ÿä¸­æ–­ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸ä¼šåˆ‡æ¢åˆ°åˆ«çš„çº¿ç¨‹ï¼Œé‚£è¿™æ ·å¾ˆå¤šçº¿ç¨‹/ä»»åŠ¡è€—è´¹çš„æ—¶é—´å¾ˆé•¿ï¼Œæå¤§å½±å“æ€§èƒ½ã€‚

ç»¼ä¸Šï¼Œåœ¨å†…æ ¸ä¸­ï¼Œä¸Šé¢è¿™ç§æ–¹æ¡ˆå°¤å…¶è‡ªæ—‹é”ï¼Œåªèƒ½ç”¨åœ¨å¾ˆçŸ­çš„ä¸´ç•ŒåŒºï¼ˆæ¯”å¦‚å¹¶å‘çš„æ•°æ®ç»“æ„ï¼Œå¾€ä¸€ä¸ªé“¾è¡¨é‡Œæ·»åŠ ä¸€ä¸ªå…ƒç´ ã€æŒ‰é”®æŒ‰ä¸‹é”®ç æ”¾é˜Ÿåˆ—ï¼‰ï¼Œä¸´ç•Œå‡ ä¹ä¸æ‹¥å µï¼Œè¦è¿…é€Ÿç»“æŸã€‚

![image-20250109213447063](pic/image-20250109213447063.png)

> - Kernel é‡Œæœ‰ ~180K ä¸ªå¹¶å‘æ§åˆ¶å‡½æ•°è°ƒç”¨ï¼
>
>     è‡ªæ—‹é”å½“ç„¶ä¸ scale
>
>     [An Analysis of Linux Scalability to Many Cores | USENIX](https://www.usenix.org/conference/osdi10/analysis-linux-scalability-many-cores)

æ€ä¹ˆåŠï¼Ÿ

> - è®¸å¤šæ“ä½œç³»ç»Ÿå†…æ ¸å¯¹è±¡å…·æœ‰ â€œ**read-mostly**â€ ç‰¹ç‚¹
>     - è·¯ç”±è¡¨
>         - æ¯ä¸ªæ•°æ®åŒ…éƒ½è¦è¯»
>         - ç½‘ç»œæ‹“æ‰‘æ”¹å˜æ—¶æ‰å˜æ›´
>     - ç”¨æˆ·å’Œç»„ä¿¡æ¯
>         - æ— æ—¶ä¸åˆ»åœ¨æ£€æŸ¥ (Permission Denied)
>         - ä½†å‡ ä¹ä»ä¸ä¿®æ”¹ç”¨æˆ·

è¯»å†™ä¸å¯¹ç§°æ€§

å†™æ—¶å¤åˆ¶

å¤šç‰ˆæœ¬

è¯» ä¸ä¸Šé”ï¼Œå†™ ä¸Šé”







### åº”ç”¨ç¨‹åºä¸­çš„äº’æ–¥

ç°åœ¨è€ƒè™‘åœ¨å¤šæ ¸çš„åº”ç”¨ç¨‹åºä¸­ï¼Œè‡ªæ—‹å¸¦æ¥çš„æ€§èƒ½é—®é¢˜

- æ€§èƒ½é—®é¢˜ (1)

    é™¤äº†è¿›å…¥ä¸´ç•ŒåŒºçš„çº¿ç¨‹ï¼Œå…¶ä»–å¤„ç†å™¨ä¸Šçš„çº¿ç¨‹éƒ½åœ¨**ç©ºè½¬**

    - äº‰æŠ¢é”çš„å¤„ç†å™¨è¶Šå¤šï¼Œåˆ©ç”¨ç‡è¶Šä½
    - å¦‚æœä¸´ç•ŒåŒºè¾ƒé•¿ï¼Œä¸å¦‚æŠŠå¤„ç†å™¨è®©ç»™å…¶ä»–çº¿ç¨‹

- æ€§èƒ½é—®é¢˜ (2)

    åº”ç”¨ç¨‹åºä¸èƒ½å…³ä¸­æ–­â€¦â€¦

    - æŒæœ‰è‡ªæ—‹é”çš„çº¿ç¨‹è¢«åˆ‡æ¢
    - å¯¼è‡´ 100% çš„èµ„æºæµªè´¹
    - (å¦‚æœåº”ç”¨ç¨‹åºèƒ½ â€œå‘Šè¯‰â€ æ“ä½œç³»ç»Ÿå°±å¥½äº†)

æƒ³æƒ³ï¼Œå¦‚æœåœ¨64æ ¸çš„64ä¸ªçº¿ç¨‹å¯¹ä¸€ä¸ªèµ„æºè¿›è¡ŒæŠ¢å ï¼Œæœ‰ä¸€ä¸ªæŠ¢åˆ°äº†ï¼Œé‚£å‰©ä¸‹çš„ 63 ä¸ªæ€ä¹ˆåšï¼Ÿç©ºè½¬ï¼Ÿä¸€ç›´æµªè´¹å•Šï¼

æ²¡æ³•è¿›å…¥ä¸´ç•ŒåŒºè¿›è¡Œè®¡ç®—ï¼Œé‚£æœ€è‡ªç„¶çš„æƒ³æ³•æ˜¯ä»€ä¹ˆï¼Ÿæ—¢ç„¶ä¸€ç›´åœ¨è¿™ç­‰ç€ä¸è¡Œï¼Œé‚£å°±ä¸ç­‰äº†ï¼Ÿå»åšæœ‰æ„ä¹‰çš„è®¡ç®—ï¼Ÿ

å›æƒ³è®¡ç®—æœºçŠ¶æ€æœºæ¨¡å‹ï¼Œå¦‚æœçŠ¶æ€ä¸€ç›´å¡åœ¨è¿™é‡Œï¼Œæ€ä¹ˆåŠï¼Ÿè¿˜æ˜¯åº”ç”¨ç¨‹åºï¼Ÿåªèƒ½ `syscall`ã€‚ï¼ˆä¹Ÿå°±æ˜¯äº’æ–¥é”ï¼‰

æŠŠè¿™ç§é”æ”¾åˆ° kernel å®ç°å°±å¥½å•¦ï¼Œå› ä¸º kernel æœ‰èƒ½åŠ›åšä¸Šä¸‹æ–‡åˆ‡æ¢å‘€ï¼Œèƒ½åˆ‡æ¢åˆ«çš„çº¿ç¨‹ã€‚

![image-20250109220653328](pic/image-20250109220653328.png)

> è¿™ä¸ª OJ ä¾‹å­è¿˜æ˜¯æŒºå½¢è±¡çš„å“ˆå“ˆï¼Œåˆæ¯”å¦‚ç­‰æˆç»©çš„æ—¶å€™ï¼Œåˆ«ç­‰äº†ï¼Œæœ¬æ¥å°±å•¥ä¹Ÿå¹²ä¸äº†ï¼Œå»åšåˆ«çš„ã€‚

> æƒ³åˆ°ä¹‹å‰å­¦ä¹  `FreeRTOS` çš„äº’æ–¥é”äº†ï¼Œæ—¢ç„¶ç­‰ä¸åˆ°ï¼Œé‚£å°±ç”¨ `mutex_acquire` æ”¾å¼ƒè¿™ä¸ªä»»åŠ¡ï¼Œå»åšåˆ«çš„çº¿ç¨‹çš„ä»»åŠ¡å§ã€‚æœ‰ç‚¹ç±»ä¼¼ã€‚

æ¨¡å‹ï¼š

<img src="pic/image-20250109221906985.png" alt="image-20250109221906985" style="zoom: 67%;" />

æˆ‘è§‰å¾—è¿™ä¸ªå›¾å·²ç»å½¢è±¡åœ°æè¿°äº†ã€‚

æ‰€ä»¥ä¸€å¥—é…å¥—æ“ä½œï¼Œå’Œè‡ªæ—‹é”çš„éƒ½æŒºç±»ä¼¼

```c
mutex_lock()	// acquire
mutex_unlock()	// release
```







#### `pthread Mutex Lock`  

> - ä¸€ä¸ªè¶³å¤Ÿé«˜æ€§èƒ½çš„å®ç°
>     - å…·æœ‰ç›¸å½“ä¸é”™çš„ scalability
>     - æ›´å¤šçº¿ç¨‹äº‰æŠ¢æ—¶ä¹Ÿæ²¡æœ‰æä¸ºæ˜¾è‘—çš„æ€§èƒ½ä¸‹é™
>
> - ä½¿ç”¨æ–¹æ³•ï¼šä¸è‡ªæ—‹é”å®Œå…¨ä¸€è‡´
>
>     ```C
>     pthread_mutex_t lock; 
>     pthread_mutex_init(&lock, NULL); 
>     pthread_mutex_lock(&lock); 
>     pthread_mutex_unlock(&lock); 
>     ```





#### Futex: Fast Userspace muTexes ğŸŒ¶ï¸

> ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬ä¸Šé”å’Œè§£é”åˆä¼šæœ‰ `syscall`ï¼Œè€Œè¿™ä¸ªä¸ä¼šï¼Œè¿™ç§æ–¹æ³•ä¼šæŠŠå°½å¯èƒ½å¤šçš„è¿ç®—æ”¾åˆ°ç”¨æˆ·ç©ºé—´

- å°å­©å­æ‰åšé€‰æ‹©ã€‚æ“ä½œç³»ç»Ÿå½“ç„¶æ˜¯å…¨éƒ½è¦å•¦ï¼

    - **æ€§èƒ½ä¼˜åŒ–çš„æœ€å¸¸è§æŠ€å·§ï¼š**

        **è€ƒè™‘å¹³å‡è€Œä¸æ˜¯æç«¯æƒ…å†µ**

        - **RCU å°±ç”¨äº†è¿™ä¸ªæ€æƒ³ï¼**

- Fast Path: è‡ªæ—‹ä¸€æ¬¡

    - ä¸€æ¡åŸå­æŒ‡ä»¤ï¼ŒæˆåŠŸç›´æ¥è¿›å…¥ä¸´ç•ŒåŒº

- Slow Path: è‡ªæ—‹å¤±è´¥

    - è¯·æ±‚ç³»ç»Ÿè°ƒç”¨ `futex_wait`
    - è¯·æ“ä½œç³»ç»Ÿå¸®æˆ‘è¾¾åˆ°è‡ªæ—‹çš„æ•ˆæœ
        - (å®é™…ä¸Šå¹¶ä¸çœŸçš„è‡ªæ—‹)



æ€ä¹ˆå®ç°ï¼Ÿ

> - æ¯”ä½ æƒ³è±¡çš„å¤æ‚
>    - å¦‚æœæ²¡æœ‰é”çš„äº‰æŠ¢ï¼ŒFast Path ä¸èƒ½è°ƒç”¨ `futex_wake`
>     - è‡ªæ—‹å¤±è´¥ â†’ è°ƒç”¨ `futex_wait`â†’ çº¿ç¨‹ç¡çœ 
>        - å¦‚æœåˆšå¼€å§‹ç³»ç»Ÿè°ƒç”¨ï¼Œè‡ªæ—‹é”è¢«ç«‹å³é‡Šæ”¾ï¼Ÿ
>         - å¦‚æœä»»ä½•æ—¶å€™éƒ½å¯èƒ½å‘ç”Ÿä¸­æ–­ï¼Ÿ
>
>      - å¹¶å‘ï¼šæ°´é¢ä¸‹çš„å†°å±±
>    - [LWN: A futex overview and update](https://lwn.net/Articles/360699/)
>     - [Futexes are tricky](https://cis.temple.edu/~giorgio/cis307/readings/futex.pdf) by Ulrich Drepper

å…³é”®åœ¨äºç”¨ç³»ç»Ÿè°ƒç”¨æ¥å®ç°è¿™ä¸ªï¼Ÿ

**==TODOï¼šç•™å‘==**





#### å¯¹æ¯”ä¸‰ç§äº’æ–¥æ‰‹æ®µ

å­¦ä¹ åˆ°äº†ï¼Œåœ¨ AI æ—¶ä»£ï¼Œä½¿ç”¨è‰¯å¥½çš„ prompt å­¦ä¼šç§‘å­¦åœ°æé—®ï¼Œæ€»èƒ½å¤§å¹…æé«˜ä½ çš„æ•ˆç‡ï¼Œä½†æˆ‘è®¤ä¸ºæˆ‘åº”è¯¥æ¸…æ¥šæˆ‘æ­£åœ¨åšä»€ä¹ˆï¼Œæˆ‘æœ‰ä»€ä¹ˆç›®çš„ï¼Œèƒ½å¦æ¸…æ™°åœ°æè¿°å‡ºæˆ‘çš„éœ€æ±‚ã€‚

![image-20250109230621303](pic/image-20250109230621303.png)





ç®€å•æ€»ç»“ï¼š

æˆ‘ç†è§£çš„æ˜¯äº’æ–¥æ˜¯æˆ‘ä»¬å®ç°çš„ç»ˆæç›®çš„ï¼Œè€Œé”æ˜¯ä¸€ç§æ¯”è¾ƒå¸¸ç”¨çš„æ‰‹æ®µã€‚
åœ¨å•æ ¸å¤„ç†å™¨ä¸­ã€‚æ— è®ºæ˜¯åº”ç”¨ç¨‹åºè¿˜æ˜¯æ“ä½œç³»ç»Ÿå†…æ ¸ã€‚ä»¥å…³ä¸­æ–­ä¸ºåŸºç¡€ï¼Œå®ç°è‡ªæ—‹é”ã€äº’æ–¥é”ç­‰é”ï¼Œå³å¯å®ç°äº’æ–¥ï¼›å¦‚æœè¿™ç§å•æ ¸å¤„ç†å™¨è¿˜æ”¯æŒåŸå­æ“ä½œï¼Œé‚£å°±å¯ä»¥ç”¨åŸå­æ“ä½œä¸ºåŸºç¡€ï¼Œå®ç°è‡ªæ—‹é”ã€äº’æ–¥é”ç­‰é”ï¼Œç”±æ­¤æ¥å®ç°äº’æ–¥ã€‚

> å¯¹äºåµŒå…¥å¼æ“ä½œç³»ç»Ÿæ¥è¯´ï¼Œåº”è¯¥æå‡ºä¸è‡ªæ—‹ä¼šæ›´åŠ è‡ªç„¶ç‚¹ï¼Œæ¯”å¦‚åœ¨å•æ ¸ä¸Šçš„ `FreeRTOS`ï¼Œé‡åˆ°æ•°æ®ç«äº‰ï¼ŒæŸä¸ªçº¿ç¨‹é‡åˆ°é”ï¼Œç¬¬ä¸€ååº”åº”è¯¥æ˜¯è®©è¿™ä¸ªçº¿ç¨‹ç¡çœ ï¼Ÿè¿™æ ·ç›¸å¯¹ä¸å½±å“æ€§èƒ½ï¼Ÿä¹Ÿå°±æ˜¯ä¸Šé¢é‚£ä¸ªåº”ç”¨ç¨‹åºçš„äº’æ–¥é”ã€‚

åœ¨å¤šæ ¸å¤„ç†å™¨ä¸­ã€‚å¯¹äºåº”ç”¨ç¨‹åºï¼Œä»…ä»…é åŸå­æŒ‡ä»¤å³å¯å®ç°äº’æ–¥ï¼Œå› ä¸ºä¸å…è®¸å…³ä¸­æ–­ã€‚ä½†å¦‚æœæ˜¯æ“ä½œç³»ç»Ÿå†…æ ¸ï¼Œé‚£æœ‰åŸå­æŒ‡ä»¤è¿˜ä¸å¤Ÿï¼Œå› ä¸ºä¸­æ–­ä¹Ÿèƒ½å½±å“åˆ°ç¨‹åºçš„çŠ¶æ€è¿ç§»ï¼Œï¼ˆå›æƒ³ä¸Šé¢çš„ä¾‹å­ï¼Œï¼‰å› æ­¤è¿˜éœ€è¦å…³ä¸­æ–­ã€‚



>  è¿™ä¸ªæ—¶å€™æ„Ÿè§‰ä¼šä¸ä¼šå†…å®¹ç¨å¾®å¤šäº†ç‚¹ï¼Ÿå¯ä»¥å°† OS è¯¾åˆ†æˆ OS å†…æ ¸å’Œ OS åº”ç”¨ä¸¤é—¨è¯¾ï¼Ÿ



## è°ƒè¯•ç†è®ºä¸å®è·µ

> - å¹¶å‘ç¼–ç¨‹ï¼šä¸èƒ½ç›¸ä¿¡è‡ªå·±
>
>     -  å¹¶å‘ bug çš„è§¦å‘éœ€è¦ï¼š
>         - ç¼–è¯‘å™¨ + ç¼–è¯‘é€‰é¡¹ + ç‰¹åˆ«çš„æœºå™¨ + ç‰¹åˆ«çš„è¿æ°”
>     -  å†…å­˜æ¨¡å‹ï¼š[ä¸“å®¶ä¹Ÿåšä¸å¯¹](https://github.com/seL4/seL4/pull/199)
>     -  æµ‹è¯•å…¨å¯¹
>         - Online Judge è¢«æ‹’ç» 
>
> - åˆå­¦è€…ï¼šå¦‚æœå¯ä»¥ï¼Œåªç”¨ â€œç»å¯¹æ­£ç¡®â€ çš„å®ç°
>
>     è‡ªå¸¦ä¸€åˆ‡ barrier çš„å‡½æ•°
>
>     - `atomic_xchg`
>     - `pthread_mutex_lock`
>
> æ­£å¥½çš„ä¾‹å­ï¼Œå¯¹æˆ‘ä»¬åˆå­¦è€…æ¥è¯´ï¼Œå°±ç”¨ä¸šç•Œæˆç†Ÿåšå¥½çš„åº“ã€‚



### å¬æ•…äº‹

ç¡¬ä»¶bug [Original Pentium FDIV flaw e-mail](https://faculty.lynchburg.edu/~nicely/pentbug/bugmail1.html)

è½¯ä»¶bugã€‚

> â€œ...attempted to convert large, unexpected 64-bit floating point numbers representing horizontal velocity into 16-bit integers. This resulted in an overflow error, causing the onboard computer to crash.â€





### è°ƒè¯•ç†è®º

>  å¬è€å¸ˆå¥½å¥½è®²å°±è¡Œè¿™èŠ‚è¯¾ã€‚ä¸‹é¢éƒ½æ˜¯pptçš„å†…å®¹ã€‚





ç¨‹åº/è½¯ä»¶æ˜¯äººç±»éœ€æ±‚åœ¨ä¿¡æ¯ä¸–ç•Œçš„æŠ•å½±ã€‚

- â€œè½¯ä»¶â€ çš„ä¸¤å±‚å«ä¹‰
    - äººç±»éœ€æ±‚åœ¨ä¿¡æ¯ä¸–ç•Œçš„æŠ•å½±
        - ç†è§£é”™éœ€æ±‚ â†’ bug
    - è®¡ç®—è¿‡ç¨‹çš„ç²¾ç¡® (æ•°å­¦) æè¿°
        - å®ç°é”™è¯¯ â†’ bug

- è°ƒè¯•ä¸ºä»€ä¹ˆå›°éš¾ï¼Ÿ
    - Bug çš„è§¦å‘ç»å†äº†æ¼«é•¿çš„è¿‡ç¨‹
    - å¯è§‚æµ‹çš„ç°è±¡æœªå¿…èƒ½ç›´æ¥å¯¹åº”åˆ° root cause ä¸Š





==éœ€æ±‚ â†’ è®¾è®¡ â†’ ä»£ç  (**Fault/bug**) â†’ æ‰§è¡Œ (**Error**) â†’ å¤±è´¥ (**Failure**)==

- æˆ‘ä»¬åªèƒ½è§‚æµ‹åˆ° failure (å¯è§‚æµ‹çš„ç»“æœé”™)ï¼Œä½†æ˜¯æˆ‘ä»¬çŠ¯é”™çš„æ˜¯ fault
- æˆ‘ä»¬å¯ä»¥æ£€æŸ¥çŠ¶æ€çš„æ­£ç¡®æ€§ (ä½†éå¸¸è´¹æ—¶)
- æ— æ³•é¢„çŸ¥ bug åœ¨å“ªé‡Œ (æ¯ä¸€è¡Œ â€œçœ‹èµ·æ¥â€ éƒ½æŒºå¯¹çš„)
- äººæ€»æ˜¯ â€œé»˜è®¤â€ (ä¸é»˜è®¤ï¼Œæµªè´¹çš„æ—¶é—´å°±å¤ªå¤šäº†)



> **è°ƒè¯•ç†è®ºï¼šå¦‚æœæˆ‘ä»¬èƒ½åˆ¤å®šä»»æ„ç¨‹åºçŠ¶æ€çš„æ­£ç¡®æ€§ï¼Œé‚£ä¹ˆç»™å®šä¸€ä¸ª failureï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡äºŒåˆ†æŸ¥æ‰¾å®šä½åˆ°ç¬¬ä¸€ä¸ª error çš„çŠ¶æ€ï¼Œæ­¤æ—¶çš„ä»£ç å°±æ˜¯ fault (bug)ã€‚**

å…¶å®ä»å¾ˆä¹…ä¹‹å‰å°±å­¦ä¼šç”¨è¿™ç§æ€æƒ³äº†ã€‚åœ¨ç¨‹åºå‡ºé”™ä¹‹å‰åŠ ä¸€æ¡ logã€‚ä¸æ–­äºŒåˆ†ï¼Œæ€»èƒ½æ‰¾åˆ°bugã€‚ 



è¿›ä¸€æ­¥æ¨è®º

- ä¸ºä»€ä¹ˆæˆ‘ä»¬å–œæ¬¢ â€œå•æ­¥è°ƒè¯•â€ï¼Ÿ
    - ä»ä¸€ä¸ªå‡å®šæ­£ç¡®çš„çŠ¶æ€å‡ºå‘
    - æ¯ä¸ªè¯­å¥çš„è¡Œä¸ºæœ‰é™ï¼Œå®¹æ˜“åˆ¤å®šæ˜¯å¦æ˜¯ errorã€‚æˆ‘ä»¬å¯¹æ¯ä¸€æ¡è¯­å¥æ‰§è¡Œçš„åæœ/çŠ¶æ€è¿ç§»åº”è¯¥éƒ½æ˜¯æ˜ç™½çš„ã€‚
    - single step(step in)ã€step over(step out)
- ä¸ºä»€ä¹ˆè°ƒè¯•ç†è®ºçœ‹èµ·æ¥å¾ˆæ²¡ç”¨ï¼Ÿ
    - â€œåˆ¤å®šçŠ¶æ€æ­£ç¡®â€ éå¸¸å›°éš¾
    - (æ˜¯å¦åœ¨è°ƒè¯• DP é¢˜/å›¾è®ºç®—æ³•æ—¶é™·å…¥æ—¶é—´é»‘æ´ï¼Ÿ)

>  **è§‚å¯ŸçŠ¶æ€æœºæ‰§è¡Œçš„ä¸¤ä¸ªåŸºæœ¬å·¥å…·**
>
>  - `printf` â†’ è‡ªå®šä¹‰ log çš„ trace
>     
>     - çµæ´»å¯æ§ã€èƒ½å¿«é€Ÿå®šä½é—®é¢˜å¤§æ¦‚ä½ç½®ã€é€‚ç”¨äºå¤§å‹è½¯ä»¶
>     - æ— æ³•ç²¾ç¡®å®šä½ã€å¤§é‡çš„ logs ç®¡ç†èµ·æ¥æ¯”è¾ƒéº»çƒ¦
>     
>     è®© LLM å¸®æˆ‘ä»¬ `printf` è°ƒè¯•
>     
>  - `gdb` â†’ æŒ‡ä»¤/è¯­å¥çº§ trace
>     
>     - ç²¾ç¡®ã€æŒ‡ä»¤çº§ å®šä½ã€ä»»æ„**æŸ¥çœ‹ç¨‹åºå†…éƒ¨çŠ¶æ€**
>     - è€—è´¹å¤§é‡æ—¶é—´



- **æ€»ç»“**

    é‡åˆ° â€œä»»ä½•é—®é¢˜â€ æ—¶å€™ï¼Œå…ˆ self-checkï¼ˆé‡åˆ°é—®é¢˜å¿ƒé‡Œé»˜å¿µ/é—®è‡ªå·±ï¼‰ï¼š

    1. æ˜¯æ€æ ·çš„ç¨‹åº (çŠ¶æ€æœº) åœ¨è¿è¡Œï¼Ÿ

        > èƒ½ä¸èƒ½å°†æ•´ä¸ªçŠ¶æ€æœºæ‰“å‡ºæ¥çœ‹ï¼Ÿå°±åƒ `make -nB` é‚£æ ·

    2. æˆ‘ä»¬é‡åˆ°äº†æ€æ ·çš„ failureï¼Ÿ

    3. æˆ‘ä»¬èƒ½ä»çŠ¶æ€æœºçš„è¿è¡Œä¸­ä»æ˜“åˆ°éš¾å¾—åˆ°ä»€ä¹ˆä¿¡æ¯ï¼Ÿï¼ˆ`printf`ã€`gdb`....ï¼‰

    4. å¦‚ä½•äºŒåˆ†æ£€æŸ¥è¿™äº›ä¿¡æ¯å’Œ error ä¹‹é—´çš„å…³è”ï¼Ÿ





### è°ƒè¯•ä¸€åˆ‡

#### example0

**ä¸‡èƒ½æ–¹æ³•ï¼šå‡è®¾ä½ é‡åˆ°çš„é—®é¢˜æ˜¯åˆ«äººä¹Ÿé‡åˆ°çš„ï¼šStackOverflowã€GPTã€Google...**

```bash
bash: curl: command not found 
```

```bash
fatal error: 'sys/cdefs.h': No such file or directory #include <sys/cdefs.h> 
```

````bash
/usr/bin/ld: cannot find -lgcc: No such file or directory 
````

```bash
make[2]: *** run: No such file or directory.  Stop. Makefile:31: recipe for target 'run' failed 
```

- ä½†å¦‚æœè¿™æ˜¯ä¸€ä¸ªå…¨æ–°çš„é—®é¢˜ï¼Ÿæˆ–è€…è¯´ç¬¬ä¸€ä¸ªè§£å†³ä¸Šè¿°é—®é¢˜å¹¶åˆ†äº«åˆ°ç½‘ä¸Šçš„äººæ˜¯æ€ä¹ˆåšçš„ï¼Ÿåˆ«äººæ˜¯æ€ä¹ˆæƒ³çš„ï¼Ÿ

    ä¸€åˆ‡éƒ½æ˜¯çŠ¶æ€æœºï¼Œå°†çŠ¶æ€æœºçš„æŸä¸€ä¾§é¢æ‰“å¼€ï¼Œçœ‹ `error`ã€‚

    å¦‚ä¸Šé¢ï¼šå¤§éƒ¨åˆ† Error å’Œ Failure éƒ½æ¯”è¾ƒæ¥è¿‘

    - å‡ºé”™æ—¶ï¼Œä½¿ç”¨ `perror` æ‰“å°æ—¥å¿—ï¼Œè¿™ä¸ª `error message` å·²ç»ç¼©çŸ­äº† `failure` å’Œ `error` çš„è·ç¦»ï¼Œå»è¿›ä¸€æ­¥è§£å†³ã€‚

    å†è¿›ä¸€æ­¥ï¼Œè¿˜æ˜¯æ‰¾ä¸åˆ°åŸå› ï¼Ÿ

    - **å‡ºé”™åŸå› æŠ¥å‘Šä¸å‡†ç¡®**
    - ç¨‹åºæ‰§è¡Œçš„è¿‡ç¨‹çœ‹ä¸åˆ°
        - é‚£æˆ‘ä»¬æƒ³åŠæ³• â€œçœ‹åˆ°â€ çŠ¶æ€æœºçš„æ‰§è¡Œè¿‡ç¨‹å°±å¥½äº†ï¼ï¼ˆå°†çŠ¶æ€æœºæ‹†å¼€ï¼‰

    > - ç†è§£çŠ¶æ€æœºæ‰§è¡Œï¼šä¸æ˜¯ â€œè°ƒè¯•â€ï¼Œä¹Ÿæ˜¯ â€œè°ƒè¯•â€ 
    >     - `ssh`ï¼šä½¿ç”¨ `-v` é€‰é¡¹æ£€æŸ¥æ—¥å¿—   `verbose`
    >     - `gcc`ï¼šä½¿ç”¨ `-v` é€‰é¡¹æ‰“å°å„ç§è¿‡ç¨‹
    >     - `make`ï¼šä½¿ç”¨ `-nB` é€‰é¡¹æŸ¥çœ‹å®Œæ•´å‘½ä»¤å†å²
    >
    > - è°ƒè¯•ï¼šä¸ä»…æ˜¯ â€œè°ƒè¯•å™¨â€
    >     - Profiler: `perf` - â€œé‡‡æ ·â€ çŠ¶æ€æœº
    >     - Trace: `strace` - è¿½è¸ªç³»ç»Ÿè°ƒç”¨



#### example1ï¼š`sys/cdefs.h: No such file or directory`

- (è¿™çœ‹èµ·æ¥æ˜¯ç”¨ `perror()` æ‰“å°å‡ºæ¥çš„ï¼)
- é—®é¢˜åˆ†æ
    - `#include` = å¤åˆ¶ç²˜è´´ï¼Œè‡ªç„¶ä¼šç»è¿‡è·¯å¾„è§£æ
    - æ˜æ˜ `/usr/include/x86_64-linux-gnu/sys/cdefs.h` æ˜¯å­˜åœ¨çš„ (`man 1 locate`) 
- ä¸¤ç§æ–¹æ³•
    - æ—¥å¿— --verbose
    - straceï¼Œç›´æ¥çœ‹è®¿é—®è¿‡çš„æ–‡ä»¶ï¼

ç®€å•å°è¯•ä¸‹è€å¸ˆè¯¾ä¸Šçš„æ“ä½œï¼šä¸‡èƒ½å¤´æ–‡ä»¶æ€ä¹ˆå·¥ä½œçš„ï¼š

```bash
strace -f g++ a.cc 2>&1 | vim -

vim:
:%!grep \.h
:%!grep -v ENOENT
:%!grep open
```

ç‰›å•Šï¼Œåˆä¸€æ¬¡æ„Ÿå—åˆ°UNIXå·¥å…·çš„å‰å®³

> LLM
>
> - **`strace` å‘½ä»¤**ï¼š
>     - `strace` æ˜¯ä¸€ä¸ªå¼ºå¤§çš„è°ƒè¯•å·¥å…·ï¼Œå¯ä»¥è·Ÿè¸ªè¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨å’Œä¿¡å·ã€‚å®ƒå¯ä»¥å¸®åŠ©ä½ ç†è§£ç¨‹åºåœ¨è¿è¡Œæ—¶ä¸æ“ä½œç³»ç»Ÿäº¤äº’çš„ç»†èŠ‚ã€‚
>     - `-f` é€‰é¡¹ç”¨äºè·Ÿè¸ªæ‰€æœ‰è¢« `g++` åˆ›å»ºçš„å­è¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨ã€‚è¿™å¯¹äºç¼–è¯‘è¿‡ç¨‹ç‰¹åˆ«æœ‰ç”¨ï¼Œå› ä¸º `g++` ä¼šåˆ›å»ºå¤šä¸ªå­è¿›ç¨‹æ¥å¤„ç†ä¸åŒçš„ç¼–è¯‘æ­¥éª¤ã€‚
>
> - `2>&1`
>
>     å°†æ ‡å‡†é”™è¯¯é‡å®šå‘åˆ°æ ‡å‡†è¾“å‡ºï¼Œç¡®ä¿æ‰€æœ‰è¾“å‡ºéƒ½é€šè¿‡ç®¡é“ä¼ é€’ã€‚
>
> - `| vim -`
>
>     - `|`ï¼šç®¡é“ç¬¦å·ï¼Œå°†å‰ä¸€ä¸ªå‘½ä»¤çš„è¾“å‡ºä½œä¸ºä¸‹ä¸€ä¸ªå‘½ä»¤çš„è¾“å…¥ã€‚
>     - `vim -`ï¼šåœ¨ Vim ä¸­æ‰“å¼€æ ‡å‡†è¾“å…¥çš„å†…å®¹ã€‚`-` è¡¨ç¤ºä»æ ‡å‡†è¾“å…¥è¯»å–æ•°æ®ã€‚
>
> - `:%!grep`
>
>     - `:%!grep` æ˜¯ä¸€ä¸ª Vim å‘½ä»¤ï¼Œç”¨äºå¯¹å½“å‰ç¼–è¾‘çš„æ–‡ä»¶çš„æ‰€æœ‰è¡Œï¼ˆ`%` è¡¨ç¤ºå½“å‰æ–‡ä»¶çš„æ‰€æœ‰è¡Œï¼‰åº”ç”¨ `grep` å‘½ä»¤ï¼Œå¹¶å°†ç»“æœæ›¿æ¢å½“å‰æ–‡ä»¶çš„å†…å®¹ã€‚
>     - è¿™ä¸ªå‘½ä»¤éå¸¸æœ‰ç”¨ï¼Œå¯ä»¥å¿«é€Ÿè¿‡æ»¤æ–‡ä»¶å†…å®¹ï¼Œåªä¿ç•™åŒ¹é…ç‰¹å®šæ¨¡å¼çš„è¡Œã€‚
>     - `:%` æ˜¯ä¸€ä¸ª Vim èŒƒå›´æŒ‡å®šç¬¦ï¼Œè¡¨ç¤ºå½“å‰æ–‡ä»¶çš„æ‰€æœ‰è¡Œã€‚
>     - `:%!command` è¡¨ç¤ºå¯¹å½“å‰æ–‡ä»¶çš„æ‰€æœ‰è¡Œåº”ç”¨ `command`ï¼Œå¹¶å°†ç»“æœæ›¿æ¢å½“å‰æ–‡ä»¶çš„å†…å®¹ã€‚
>     - `:%grep command` è¡¨ç¤ºåœ¨å½“å‰æ–‡ä»¶çš„æ‰€æœ‰è¡Œä¸­æŸ¥æ‰¾åŒ¹é… `command` çš„è¡Œï¼Œå¹¶å°†ç»“æœä¿å­˜åœ¨ä¸´æ—¶æ–‡ä»¶ä¸­ã€‚
>
>     > - **`!`**ï¼šåœ¨ Vim å‘½ä»¤ä¸­ï¼Œ`!` ç”¨äºè¡¨ç¤ºâ€œè¿‡æ»¤â€æˆ–â€œæ›¿æ¢â€æ“ä½œã€‚å…·ä½“æ¥è¯´ï¼Œ`:%!command` è¡¨ç¤ºå¯¹å½“å‰æ–‡ä»¶çš„æ‰€æœ‰è¡Œåº”ç”¨ `command`ï¼Œå¹¶å°† `command` çš„è¾“å‡ºç»“æœæ›¿æ¢å½“å‰æ–‡ä»¶çš„å†…å®¹ã€‚
>     > - **æ²¡æœ‰ `!`**ï¼šå¦‚æœæ²¡æœ‰ `!`ï¼Œåˆ™è¡¨ç¤ºä¸è¿›è¡Œæ›¿æ¢æ“ä½œï¼Œè€Œæ˜¯å°†ç»“æœä¿å­˜åœ¨å¿«é€Ÿä¿®å¤åˆ—è¡¨ä¸­ï¼Œä¸ä¿®æ”¹å½“å‰æ–‡ä»¶çš„å†…å®¹ã€‚

- æ€»ç»“
    1. **ç¡®è®¤æ–‡ä»¶å­˜åœ¨**ï¼šä½¿ç”¨ `locate` æˆ– `find` ç¡®è®¤æ–‡ä»¶ç¡®å®å­˜åœ¨ã€‚
    2. **æ£€æŸ¥ç¼–è¯‘å™¨æœç´¢è·¯å¾„**ï¼šä½¿ç”¨ `gcc -v` æˆ– `clang -v` æŸ¥çœ‹ç¼–è¯‘å™¨çš„æœç´¢è·¯å¾„ã€‚
    3. **ä½¿ç”¨ `strace`**ï¼šè·Ÿè¸ªç¼–è¯‘å™¨æ‰§è¡Œæ—¶è®¿é—®çš„æ–‡ä»¶ï¼Œç¡®è®¤æ˜¯å¦å°è¯•è®¿é—®äº†æ­£ç¡®çš„è·¯å¾„ã€‚
    4. **æ˜¾å¼æŒ‡å®šè·¯å¾„**ï¼šå¦‚æœéœ€è¦ï¼Œä½¿ç”¨ `-I` é€‰é¡¹æ˜¾å¼æŒ‡å®šæœç´¢è·¯å¾„ã€‚





#### example2ï¼šreal bug

- è£…äº† 100 å°ä¸€æ¨¡ä¸€æ ·çš„æœºå™¨ï¼Œä½†æœ‰ä¸€å°å‡ºé—®é¢˜äº†
    - åå­—å« â€œpmâ€ çš„ Kernel thread å ç”¨ 100% CPU
    - LLM æœ‰éå¸¸å¥½çš„è§£é¢˜ç›´è§‰

> è¿˜æ˜¯è®°ä½è¿™å¥è¯ï¼ševerything is state machineã€‚æˆ–è€…ç”¨æ›´å¥½è®°çš„ä¸€å¥è¯ï¼Œå†¤æœ‰å¤´å€ºæœ‰ä¸»ï¼Œé‡åˆ° bugè‚¯å®šæœ‰å€ºä¸»ï¼Œè‚¯å®šæ˜¯å“ªé‡Œå¯¼è‡´ CPU å‡ºé—®é¢˜çš„ã€‚
>
> ç”¨ `sudo perf top` 
>
> é€šè¿‡ `perf` å·¥å…·é‡‡æ ·çŠ¶æ€æœºï¼Œæ¯ä¸€ä¸ªé‡‡æ ·ç‚¹ï¼Œçœ‹åˆ°åº•æ˜¯å“ªä¸€ä¸ªå‡½æ•°å ç”¨æ—¶é—´ï¼Œåœ¨æ¯ä¸€ä¸ªé‡‡æ ·ç‚¹è¿›è¡Œ `backtrace` æ‰“å°å½“å‰çº¿ç¨‹è°ƒç”¨å †æ ˆã€‚->  å‘ç° `xhci` ï¼šUSB subsystem -> æ‰¾åˆ°äº†è¢«æ’çƒ‚äº†çš„ USB æ¥å£ï¼ŒçŸ­è·¯äº†ï¼Œå¯¼è‡´ç”µæºç®¡ç†å‡ºäº†é—®é¢˜ã€‚ã€‚ 

æ€ä¹ˆåšåˆ°çš„ï¼Ÿ

everything is state machineã€‚

ä¼šä½¿ç”¨ç›¸å…³çš„å·¥å…·



#### example3

![image-20250110185657629](pic/image-20250110185657629.png)

é€šè¿‡æŠ¥é”™ä¿¡æ¯çŸ¥é“ï¼Œè¿™æ˜¯ä»£ç æ‰“å°å‡ºæ¥çš„æŠ¥é”™ä¿¡æ¯ï¼Œé‚£èƒ½ä¸èƒ½æ‰¾åˆ°è¿™æ¡æŠ¥é”™ä¿¡æ¯åœ¨å“ªé‡Œï¼Ÿå› ä¸ºè¿™æ˜¯ä¸€ä¸ª Ubuntu çš„å®‰è£…é•œåƒï¼Œæ‰€ä»¥èƒ½ä¸èƒ½è§£å¼€ï¼Œç„¶åç›´æ¥æœç´¢æˆ–è€… `grep`ï¼Ÿæœ€åæ‰¾åˆ°äº†ä¸€å¤„åœ°æ–¹ï¼ˆshellè„šæœ¬ï¼‰ï¼Œé€šè¯»/è°ƒè¯•ä¸Šä¸‹æ–‡ä»£ç ï¼ŒçŸ¥é“è¿™éƒ¨åˆ†ä»£ç æ˜¯ç”¨æ¥æ‰«æç³»ç»Ÿæ‰€æœ‰çš„ç£ç›˜ï¼Œæ‰¾åˆ°ä¸€ä¸ªå®‰è£…ç£ç›˜å°±å®‰è£…ã€‚è‚¯å®šæœ‰åŸå› ä¸ºä»€ä¹ˆæ²¡æ‰¾åˆ°ç£ç›˜ã€‚æ€ä¹ˆè§£å†³ï¼Ÿè¿›ä¸€æ­¥çœ‹æ‰‹å†Œï¼Œå¼ºè¡ŒæŒ‡å®šä¸€ä¸ªè®¾å¤‡å®‰è£…/åˆ«çš„æ–¹æ³•





#### summary

ä¸Šé¢è¿™äº›ä¾‹å­å…ˆæŠ›å¼€å„ç§å„æ ·çš„å‰ç½®åŸºç¡€çŸ¥è¯†ä¸è°ˆï¼Œæˆ‘æ˜¯ä¸€ä¸ªåˆå­¦è€…ï¼Œæˆ‘é‡åˆ°çš„é—®é¢˜åˆ«äººè‚¯å®šä¹Ÿé‡åˆ°è¿‡ã€‚ä½†æ˜¯æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ¯”è¾ƒå¥½çš„æˆ–è€…æ¯”è¾ƒ principal approachï¼ˆeverything is state machineï¼‰ï¼Œå‡ºé”™äº†ä¸€å®šæ˜¯è‡ªå·±çš„é—®é¢˜ï¼Œæˆ‘ä»¬èƒ½è§£å†³å®ƒï¼Œå®ƒä¸€å®šæ˜¯æœ‰åŸå› çš„ï¼Œä¸€æ­¥æ­¥åœ°å»è§£å†³é—®é¢˜ï¼Œæ‰©å……è‡ªå·±çš„åŸºç¡€çŸ¥è¯†ã€‚

> å®é™…ä¸Šæˆ‘è§‰å¾—æ•´ä¸ªè°ƒè¯•ç†è®ºä¸å•å•èƒ½ç”¨åœ¨è½¯ä»¶ï¼Œç”Ÿæ´»ä¸­çš„ç»™æ–¹é¢åº”è¯¥éƒ½èƒ½ç”¨ï¼Ÿé¢˜å¤–è¯ã€‚

å†å›åˆ°è°ƒè¯•ç¨‹åºã€‚æˆ‘ä»¬ä¾æ—§éœ€è¦ [RTFM: Top (Debugging with GDB](https://sourceware.org/gdb/current/onlinedocs/gdb.html/) 

> åˆä¸€æ¬¡æé†’è‡ªå·±è¯¥è¯»è¯»æ‰‹å†Œäº†ï¼Œæ€»èƒ½å‘ç°ä¸€äº›å¾ˆå¥½ç©çš„ä¸œè¥¿ã€‚

- å¦åˆ™æˆ‘ä»¬ç”šè‡³ä¸çŸ¥é“ `gdb` æœ‰å¤šå¼ºå¤§

Cheat Sheet é‡Œæ²¡æœ‰çš„åŠŸèƒ½

- Text UI (æˆ‘å·²ç»é»˜è®¤å¯åŠ¨)
- Stack, optimized code, macros, ...
- Reverse execution
- Record and replay
- Scheduler

> åˆä¸€ä¸ªä¾‹å­ï¼šçŠ¶æ€æœºå›æº¯ï¼Ÿé€†ç€çŠ¶æ€æœºçš„æ‰§è¡Œæµã€‚

åªè¦ä½ æƒ³è¿™ä¸ªä¸œè¥¿ï¼Œé‚£è¿™ä¸ªä¸œè¥¿ä¸ºä»€ä¹ˆæ²¡æœ‰ï¼Œä¸ºä»€ä¹ˆä¸å¯ä»¥æœ‰ï¼Ÿé‚£åº”è¯¥æœ‰æ‰å¯¹ï¼Ÿ

> ![image-20250110191752496](pic/image-20250110191752496.png)
>
> å½“æˆ‘ç¬¬ä¸€æ¬¡çœ‹åˆ°è¿™æ®µè¯çš„æ—¶å€™ï¼Œæˆ‘å…¶å®å¹¶æ²¡æœ‰æ„è¯†ä»–ç©¶ç«Ÿæƒ³å‘Šè¯‰æˆ‘ä»€ä¹ˆï¼Œç®€å•åœ°è®¤è¯†äº†ä¸€ä¸ªç»“è®ºï¼šAI Copilot èƒ½å¤Ÿå¸®æˆ‘æŠŠäº‹æƒ…åšå¾—æ›´å¥½ã€‚
>
> è‡ªä»é«˜ä¸­ä»¥æ¥éƒ½æ˜¯ä¹ æƒ¯æ¥å—åˆ«äººä¼ æˆçš„çŸ¥è¯†ï¼Œå­¦ä¹ æŠ€æœ¯æ€»æ˜¯ä¼šå»çœ‹åˆ«äººçš„æ€»ç»“/æ•™ç¨‹ï¼Œæ€»æ˜¯æƒ³ç€åˆ«äººåš¼çƒ‚äº†æ‰ç¢äº†å‘Šè¯‰æˆ‘ï¼Œä»æ¥æ²¡æƒ³è¿‡ä¸ºä»€ä¹ˆæˆ‘ä¸èƒ½å»é˜…è¯»ç¬¬ä¸€æ‰‹çš„èµ„æ–™ã€‚ï¼ˆå½“ç„¶ï¼Œæˆ‘è§‰å¾—åˆå­¦è€…éƒ½æ˜¯ä»è¿™ä¸ªé˜¶æ®µè¿‡æ¥çš„ï¼Œé‚£ä¹‹åå‘¢ï¼Ÿæ²¡æœ‰è¿™ç§èƒ½åŠ›ä¸ä¸€ç›´è¦ç­‰ç€åˆ«äººï¼Ÿï¼‰
>
> åœ¨åš PA çš„æ—¶å€™å·²ç»æˆ–å¤šæˆ–å°‘å‘Šè¯‰è‡ªå·±åº”è¯¥æ¥å—ä¸€æ‰‹çš„çŸ¥è¯†ï¼Œåº”è¯¥æœé›†å„ç§èµ„æ–™ç‹¬ç«‹å®Œæˆï¼Œä½†åœ¨æ˜¨æ™šä¸€éƒ¨åˆ†ä¹‹åï¼Œä¸çŸ¥æ˜¯ä»¥å‰çš„ä¹ æƒ¯ä½¿ç„¶è¿˜æ˜¯è‡ªå·±çš„æƒ°æ€§å¤ªå¼ºï¼Œå¯¼è‡´åˆæœ‰ç‚¹å˜å›ä¹‹å‰çš„çŠ¶å†µï¼Œæ€»æ˜¯è¢«è¿«ç”¨è‚Œè‚‰è®°å¿†å®Œæˆå„ç§ä»»åŠ¡ã€‚
>
> è¿™é‡Œè€å¸ˆç»™äº†ä¸€ä¸ªæé†’ï¼ŒAI Copilot æˆ–è®¸èƒ½å¤Ÿå……å½“è¿™ä¹ˆä¸€ä¸ªè§‚å¯Ÿè€…ï¼Œæˆ–è€…è¯´ç›‘ç£è€…çš„è§’è‰²ã€‚copilot æˆ–è®¸èƒ½å¤Ÿè®°å½•æˆ‘ä»¬åˆšæ‰åšè¿‡çš„äº‹æƒ…ï¼Œä»–èƒ½å¸®æˆ‘ä»¬æ€»ç»“æˆ–è€…ç»™å‡ºä¸€äº›å»ºè®®æ¥æé†’æˆ‘ä»¬æ˜¯ä¸æ˜¯èƒ½åšå¾—æ›´å¥½ã€‚æˆ–è®¸æœªæ¥æ€»ä¼šæœ‰è¿™ä¸ªå‘æ˜çš„å‡ºç°ï¼Ÿæˆ–è®¸è¿™å°±æ˜¯ä¸€ä¸ªé¡¹ç›®ï¼Ÿæˆ–è®¸å¯ä»¥å°è¯•ä¸‹ï¼Œæ–°çš„å‘æ˜å¾€å¾€éƒ½æ˜¯ç”±è¿™æ ·çš„æƒ³æ³•é“¸é€ è€Œæˆã€‚
>
> å¦å¤–å¯¹äºè‡ªå·±æ¥è¯´ï¼Œè¶ç°åœ¨è¿˜å¹´è½»ï¼Œå¯ä»¥é¡¶ç€è‚Œè‚‰è®°å¿†æˆ–è€…è¶ç€è‚Œè‚‰è®°å¿†è¿˜æ²¡å®ç°çš„æ—¶å€™ï¼Œå»å­¦ä¹ æ–°çš„å†…å®¹ã€‚
>
> > è¿™é‡Œæƒ³èµ·æ¥ä¹‹å‰è‡ªå·±çš„ä¸€äº›çœ‹æ³•ï¼šä¸å–œæ¬¢æŠ˜è…¾å’Œå­¦ä¹ æ–°çš„æŠ€æœ¯ï¼Œç°åœ¨çœ‹æ¥å…¶å®æ˜¯ä¸çŸ›ç›¾çš„ï¼Œå­¦ä¹ æ–°çš„æŠ€æœ¯å¯èƒ½è§£å†³çš„æ˜¯åŒæ ·çš„é—®é¢˜ï¼Œä½†æŸä¸€å¤©è¿™å°±èƒ½ç”¨åœ¨åˆ«çš„åœ°æ–¹ï¼Œæœ€ç»ˆæ€ä¹ˆè§£å†³/åˆ†æé—®é¢˜ï¼Œæ˜¯å‡­ç€ä½ é‚£ä¸ªæ—¶å€™çš„å…·ä½“æƒ…å†µå…·ä½“åˆ†æçš„ã€‚æ‰€ä»¥ï¼Œå»å­¦å§ï¼





### è°ƒè¯•ç†è®ºçš„åº”ç”¨

**éœ€æ±‚ â†’ è®¾è®¡ â†’ ä»£ç  â†’ Fault â†’ Error â†’ Failure**

ä»ä¸Šé¢è¿™å¯¹äºæˆ‘ä»¬è®¾è®¡ç»™å‡ºä¸‰ä¸ªç›¸å¯¹é‡è¦çš„å»ºè®®ï¼š

1. **==éœ€æ±‚ â†’ è®¾è®¡ â†’ ä»£ç  â†’ Fault==** â†’ Error â†’ Failure

    - **å†™å¥½ä»£ç **ï¼šä¸è¦åœ¨å†™ä»£ç çš„æ—¶å€™å¿˜è®°éœ€æ±‚å’Œè®¾è®¡

        è¿™é‡Œæˆ‘çš„ä½“ä¼šæ˜¯ï¼šå¤šèŠ±ä¸€äº›æ—¶é—´åœ¨è‡ªå·±çš„è®¾è®¡å’Œéœ€æ±‚åˆ†æä¸Šï¼Œæƒ³æƒ³è‡ªå·±ä»¥å‰å†™ä»£ç éƒ½æ˜¯å­å“§å­å“§æ— è„‘ä¸Šå¤´å†™ï¼Œé‡åˆ°bugäº†ï¼Œä¸€ç›´è°ƒï¼Œè§£å†³ä¸äº†å°±é—® AIï¼ŒæŸ¥èµ„æ–™ï¼Œå‡­ç€è‡ªå·±çš„ç›´è§‰ä¸€å¾€æ— å‰ï¼Œä½†è‡ªå·±çš„ç›´è§‰åˆå¾€å¾€æ²¡æœ‰è€å¸ˆé‚£ä¹ˆå¥½ã€‚

        å…¶å®æˆ‘å¯ä»¥å…ˆåœ¨çº¸ä¸Šæˆ–è€… markdown ç®€å•å†™å†™æ•´ä¸ªçš„æµç¨‹ï¼Œè‡ªå·±å¿ƒé‡Œåº”è¯¥æœ‰ä¸ªåº•çš„ï¼Œæˆ–è®¸ä»£ç å†™çš„å°‘äº†ï¼Œé¡¹ç›®åšçš„å°‘ã€‚

    - ä¸è¨€è‡ªæ˜ (Self-explanatory)

        - èƒ½é€šè¿‡å­—é¢çŸ¥é“éœ€æ±‚ (æµç¨‹)

    - ä¸è¨€è‡ªè¯ (Self-evident)

        - èƒ½é€šè¿‡å­—é¢ç¡®è®¤ä»£ç å’Œéœ€æ±‚ä¸€è‡´

    **ä»£ç é¦–å…ˆæ˜¯ç»™äººçœ‹åˆ°ï¼Œå…¶æ¬¡æ‰æ˜¯æœºå™¨æ‰§è¡Œçš„**

    > **ä¸€ä¸ªè¯„åˆ¤æ ‡å‡†**
    >
    > - AI æ˜¯å¦èƒ½æ­£ç¡®ç†è§£/ç»´æŠ¤ä½ çš„ä»£ç : [toybox](http://git.nju.edu.cn/jyy/toybox)
    >
    > > Programs are meant to be read by humans and only incidentally for computers to execute. (Donald E. Knuth)

2. éœ€æ±‚ â†’ è®¾è®¡ â†’ ä»£ç  â†’ **==Fault â†’ Error==** â†’ Failure

    - **åšå¥½æµ‹è¯•**ï¼šæœªæµ‹ä»£ç æ°¸è¿œæ˜¯é”™çš„
        - æ®‹é…·çš„ç°å®ï¼šç›¸ä¿¡è‡ªå·±å†™ä¸å¯¹ä»£ç 
        - LLM ä¸€æ ·ç»å¸¸çŠ¯ â€œå‚»â€ é”™

    > Small Scope Hypothesis
    >
    > If a system does not have a counterexample (i.e., an error or a bug) for a certain property within a small scope (a limited size or configuration), then it is unlikely to have a counterexample in a larger scope. (Daniel Jackson)
    >
    > **==TODO==**

    å®é™…ä¸Šæˆ‘å¯¹è¿™éƒ¨åˆ†çš„å†…å®¹ï¼Œå®é™…ä¸Šå¹¶ä¸æ˜¯ç‰¹åˆ«åœ°äº†è§£ï¼Œå¤§å®¶ä¸€ç›´åœ¨è¯´çš„æµ‹è¯•é©±åŠ¨å¼€å‘ï¼ˆTDDï¼‰æˆ‘ä¹Ÿä¸æ‡‚ï¼Œè‡ªå·±çš„ç»å†ä¹Ÿå°±åªæ˜¯åœ¨åš PA çš„æ—¶å€™ï¼Œè‡ªå·±å®ç°ä¸€ä¸ªå‡½æ•°åŠŸèƒ½ï¼Œç„¶åç”¨è¿™ä¸ªå‡½æ•°ï¼Œçœ‹çœ‹æœ‰æ²¡è¾¾æˆæƒ³è¦çš„æ•ˆæœï¼Ÿï¼ˆæ¯”å¦‚ `strcpy`ã€`strcmp`ç­‰ï¼‰ä¸è¿‡å¾ˆå¤šæ—¶å€™éƒ½æ˜¯å€ŸåŠ© GPT æ¥å¸®åŠ©æˆ‘å†™è¿™ä¸ªä¸œè¥¿ã€‚æ‰€ä»¥è¿™é‡Œç•™å‘ï¼Œå‡†å¤‡å»çœ‹çœ‹ç›¸å…³çš„ä¹¦ç±ã€‚ **==TODO==**

    

3. éœ€æ±‚ â†’ è®¾è®¡ â†’ ä»£ç  â†’ Fault â†’ **==Error â†’ Failure==**

    - å¤šå†™æ–­è¨€

        ï¼šæŠŠä»£ç ä¸­çš„ â€œéšè—æ€§è´¨â€ å†™å‡ºæ¥

        - Error æš´éœ²çš„è¶Šæ™šï¼Œè°ƒè¯•è¶Šå›°éš¾
        - è¿½æº¯å¯¼è‡´ assert failure çš„å˜é‡å€¼ (slice) é€šå¸¸å¯ä»¥å¿«é€Ÿå®šä½åˆ° bug

    > â€œThere are two ways of constructing a software design: One way is to make it so simple that there are obviously no deficiencies, and the other way is to make it so complicated that there are no obvious deficienciesâ€ (Tony Hoare)

    å…¶å®è¯´æ¥æƒ­æ„§ï¼Œåš PA çš„æ—¶å€™ä¸€ç›´éƒ½çŸ¥é“è¦å¤šå†™æ–­è¨€ï¼Œä½†æ˜¯åªæœ‰åœ¨æƒ³èµ·æ¥çš„æ—¶å€™æ‰ä¼šåšï¼Œå¹¶æ²¡æœ‰æŠŠè¿™ä¸ªå½“ä½œä¸€ä¸ªä¹ æƒ¯ï¼Œä¹‹åå…»æˆä¹ æƒ¯å§ã€‚

    ![image-20250111210424564](pic/image-20250111210424564.png)

    > ä»¥å¾€éƒ½æ˜¯å…ˆå­¦äº†æŸä¸ªä¸œè¥¿çš„æ€§è´¨ï¼Œç„¶åå……åˆ†åº”ç”¨ä»–çš„æ€§è´¨æ¥å®å„ç§å„æ ·çš„åŠŸèƒ½ï¼Œä½†æ˜¯ç°åœ¨ï¼Œæˆ‘å®ç°å¾—ä¸æ­£ç¡®ï¼Œæ­£ç¡®çš„æ€§è´¨è‡ªç„¶ä¹Ÿå°±ä¸æ»¡è¶³ï¼Œè‡ªç„¶ä¹Ÿå°±éœ€è¦ä¸Šé¢è¿™äº›çœ‹èµ·æ¥å‚»é‡Œå‚»æ°”çš„æ–­è¨€æ¥å¸®åŠ©æˆ‘æ‰¾å‡º bugsã€‚

    æœ‰äº› â€œæ˜æ˜¾â€ çš„æ–­è¨€ï¼Œå†™èµ·æ¥ä¼šå½»åº•ç ´åä»£ç çš„å¯è¯»æ€§

    ```C
    assert(first(obj) <= ptr && ptr < last(obj)); *ptr = 1; // Assumes ptr is valid. 
    ```

    - ä½†å¦‚æœæœ‰è¿™æ ·çš„æ–­è¨€ï¼Œä½ å°±ä¸ç”¨æ‹…å¿ƒæ•°ç»„è¶Šç•Œäº†ï¼

        Bad practice: `int elements[MaxN + 100];`

    - ä¸€ä¸ªç¥å¥‡çš„ç¼–è¯‘é€‰é¡¹

        ```C
        -fsanitize=address
        ```

        Address Sanitizer; asan â€œåŠ¨æ€ç¨‹åºåˆ†æâ€

    è¿™ç§äº‹æƒ…ç¼–è¯‘å™¨åº”è¯¥ç”±ç¼–è¯‘å™¨åšï¼Œä¸ç„¶æ¯æ¬¡éƒ½åŠ ï¼ŒçœŸå¾—å¾ˆéº»çƒ¦ã€‚





## å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥ï¼ˆ1ï¼‰

åŒæ­¥æ˜¯ä»€ä¹ˆï¼Ÿè¿™ä¸ªä¸œè¥¿æ˜¯å¹²å•¥çš„ï¼Ÿ

å›æƒ³ï¼šå¹¶å‘æ§åˆ¶çš„è¦æ±‚ï¼Ÿäº’æ–¥å®ç°çš„æ˜¯ä»€ä¹ˆï¼Ÿ

äº’æ–¥ä¿è¯äº†æˆ‘ä»¬çš„åŸå­æ€§ï¼Œä½†æ˜¯æƒ³è¦è°ƒæ§ä¸¤ä»½ä»£ç æ‰§è¡Œçš„é¡ºåºå…³ç³»è¿˜æ˜¯åšä¸åˆ°çš„ã€‚



**Synchronizationï¼šæ§åˆ¶å¹¶å‘ï¼šä½¿å¾— â€œä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šéšæ—¶é—´å˜åŒ–çš„é‡åœ¨å˜åŒ–è¿‡ç¨‹ä¸­==ä¿æŒä¸€å®šçš„ç›¸å¯¹å…³ç³»==â€**

è¿˜æ˜¯è®°ä½æ–¹æ³•ï¼š

- çº¿ç¨‹ = æˆ‘ä»¬è‡ªå·±
- å…±äº«å†…å­˜ = ç‰©ç†ç©ºé—´



### çº¿ç¨‹åŒæ­¥

#### example1ï¼šæ¼”å¥éŸ³ä¹

- æ¼”å¥éŸ³ä¹ä¸­çš„åŒæ­¥
    - æ¯ä¸ªä¹æ‰‹éƒ½æ˜¯ä¸€ä¸ª â€œçº¿ç¨‹â€
    - èŠ‚æ‹ *i*  åˆ°è¾¾ â†’ æ¼”å¥ n~i~

```C
void T_player() {
    while (!end) {
        wait_next_beat(); // åŒæ­¥ï¼Œç­‰å¾…æŒ‡æŒ¥å‘å‡ºèŠ‚æ‹æŒ‡ä»¤
        play_next_note(); // æ¼”å¥å¯¹åº”èŠ‚æ‹
    }
}
```



#### example2ï¼šçº¦ä¼š

ä¸¤äººçº¦å®šå‡ ç‚¹å‡ åˆ†åŒæ—¶åœ¨ xxx åœ°ç‚¹è§é¢ã€‚

å¦‚æœæŸäººå…ˆåˆ°äº†ï¼Œé‚£ä»–å°±å¾—ä¸€ç›´ç­‰å¦ä¸€ä¸ªäººï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥å»ç©åˆ«çš„ä¸œè¥¿ï¼Œä½†æ˜¯åˆ°çº¦å®šæ—¶é—´ï¼Œå¿…é¡»å‡ºç°åœ¨é‚£é‡Œï¼‰ã€‚





#### example3ï¼šæ›´è¿›ä¸€æ­¥

**åœ¨æŸä¸ªç¬é—´è¾¾åˆ° â€œäº’ç›¸å·²çŸ¥â€ çš„çŠ¶æ€**

- NPY: ç­‰æˆ‘æ´—ä¸ªå¤´å°±å‡ºé—¨
- NPY: ç­‰æˆ‘æ‰“å®Œè¿™å±€æ¸¸æˆå°±æ¥
- èˆå‹ï¼šç­‰æˆ‘ä¿®å¥½è¿™ä¸ª bug å°±åƒé¥­
- å¯¼å¸ˆï¼šç­‰æˆ‘å‡ºå·®å›æ¥å°±è®¨è®ºè¿™ä¸ªè¯¾é¢˜
- join(): ç­‰æ‰€æœ‰çº¿ç¨‹ç»“æŸå°±ç»§ç»­

- â€œå…ˆåˆ°å…ˆç­‰â€ï¼Œåœ¨æ¡ä»¶è¾¾æˆçš„ç¬é—´å†æ¬¡æ¢å¤å¹¶è¡Œ

    åŒæ—¶å¼€å§‹å‡ºå»ç©/åƒé¥­/è®¨è®º



#### çŠ¶æ€æœºè§†è§’

æŒºæ¸…æ™°çš„å›¾ï¼Œä¸¤ä¸ªçº¿ç¨‹éƒ½åœ¨åˆå§‹çš„æŸä¸ªçŠ¶æ€ä¸Šï¼Œå“ªæ€•ä¹‹åä¸æ–­çŠ¶æ€è¿ç§»ï¼Œåšäº†å¾ˆå¤šåˆ«çš„äº‹æƒ…ï¼Œ

ä½†å¹¶å‘æ§åˆ¶ï¼ˆåŒæ­¥ï¼‰å°±è¦æ±‚æˆ‘ä»¬åœ¨ä¹‹ååˆå›åˆ°ç»Ÿä¸€çš„çŠ¶æ€ä¸Šï¼ˆå†æ¬¡æ¢å¤å¹¶è¡Œï¼‰ï¼Œå†å›çœ‹ä¹‹å‰çš„ä¾‹å­åº”è¯¥ä¹ŸæŒºå¥½ç†è§£çš„ã€‚

![image-20250112110354311](pic/image-20250112110354311.png)

åœ¨æŸä¸€ä¸ªæ—¶åˆ»ï¼š

æ‰€æœ‰çš„ players éƒ½å®Œæˆäº†ç¬¬ n æ‹ï¼ˆå¤„äºç›¸åŒçš„çŠ¶æ€ï¼‰

ç„¶åæŒ‡æŒ¥ä¸‹è¾¾å‘½ä»¤ï¼šæ‰“ n+1 æ‹

ï¼ˆå¯èƒ½æœ‰äººï¼ˆçº¿ç¨‹ï¼‰ä¼šèµ°ç¥ï¼Œä¼šæŠ¢æ‹ï¼ˆç»å†å¤æ‚çš„è°ƒåº¦ï¼Œå¤šæ ¸éƒ½åšå„è‡ªçš„äº‹æƒ…ï¼Œä½†æœ€ç»ˆå›åˆ°åŒä¸€çŠ¶æ€ï¼‰ï¼‰

æ‰€æœ‰äººç¬¬ n+1 æ‹å®Œæˆï¼ˆå¤„äºç›¸åŒçš„çŠ¶æ€ï¼Œåªæ˜¯æ‹å­æ•° + 1ï¼‰

![image-20250112111059315](pic/image-20250112111059315.png)

```c
void T_player() {
	while (!end) {
		wait_next_beat();
		play_next_note();
	}
}
void T_conductor() {
	while (!end) {
		wait_next_beat();
		release(); 
	}
} 
// release() ä¹‹åï¼Œplayer éƒ½ä¼šæ¼”å¥ä¸‹ä¸€æ‹
// ä¼ªä»£ç 
```

æœ‰äº†å…·ä½“ä¾‹å­è¾…åŠ©ç†è§£ï¼Œæ¥ç€å°±åˆ°äº†æ€ä¹ˆå®ç°åŒæ­¥ã€‚è¿˜æ˜¯ä»¥æ€ä¹ˆå®ç°æ¼”å¥éŸ³ä¹ä¸ºä¾‹ï¼šæ€ä¹ˆç­‰å¾…ä¸‹ä¸€ä¸ªæ‹ï¼Ÿ

å…¶å®åˆšå¼€å§‹æˆ‘è§‰å¾—è‡ªæ—‹åº”è¯¥å°±èƒ½è§£å†³é—®é¢˜çš„ï¼Œå°±æ¯”å¦‚åŠ ä¸ª if åˆ¤æ–­çœ‹æ˜¯å¦æ”¶åˆ°äº†æŒ‡æŒ¥çš„å‘½ä»¤ï¼Œæ²¡æ”¶åˆ°å°±ä¸€ç›´ç©ºè½¬è‡ªæ—‹ï¼Œä½†è¿™æ ·ä¼šä¸ä¼šå¤ªæ…¢ï¼Ÿ

> å…¶å®è¿˜çœŸæ˜¯ï¼šæˆ‘æƒ³çš„ if åˆ¤æ–­å°±æ˜¯åŒæ­¥æ¡ä»¶ï¼Œä¹Ÿå°±æ˜¯åŒæ­¥çš„å…³é”®ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆä¸ç”¨ whileï¼Ÿ

- çº¿ç¨‹æœ‰å…ˆåï¼Œå…ˆæ¥å…ˆç­‰å¾…

```c
void wait_next_beat() {
retry:
	if (!next_beat_has_come) {
		goto retry;
	}
}
```





### ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ä¸æ¡ä»¶å˜é‡(â­)

> â€99% çš„å®é™…å¹¶å‘é—®é¢˜éƒ½å¯ä»¥ç”¨ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹æ¥è§£å†³â€œï¼Œeg. å°†ç®—æ³•å¹¶è¡ŒåŒ–
>
> â€æ¡ä»¶å˜é‡èƒ½è§£å†³ 100% çš„å¹¶å‘é—®é¢˜â€œ



- Producer å’Œ Consumer å…±äº«ä¸€ä¸ªç¼“å†²åŒº
    - Producer (ç”Ÿäº§æ•°æ®)ï¼šå¦‚æœ**ç¼“å†²åŒº**æœ‰ç©ºä½ï¼Œæ”¾å…¥ï¼›å¦åˆ™ç­‰å¾…
    - Consumer (æ¶ˆè´¹æ•°æ®)ï¼šå¦‚æœ**ç¼“å†²åŒº**æœ‰æ•°æ®ï¼Œå–èµ°ï¼›å¦åˆ™ç­‰å¾…

```c
void produce(Object obj); 
Object consume();
```

**==åŒæ­¥ï¼Œå…³é”®åœ¨äºå®ç°åŒæ­¥çš„æ¡ä»¶ã€‚ç­‰åˆ°æŸä¸€ä¸ªæ¡ä»¶æˆç«‹æ—¶æ‰èƒ½åšæŸäº‹==**



è¿›ä¸€æ­¥ç®€åŒ–ï¼š

```c
void produce() { printf("("); } 
void consume() { printf(")"); } 
```

- ç”Ÿäº§ = æ‰“å°å·¦æ‹¬å· (push into buffer)    æ”¾å…¥ç¼“å†²åŒº

- æ¶ˆè´¹ = æ‰“å°å³æ‹¬å· (pop from buffer)    ä»ç¼“å†²åŒºä¸­å–å‡º

- åœ¨ `printf` å‰åå¢åŠ ä»£ç ï¼Œä½¿å¾—æ‰“å°çš„æ‹¬å·åºåˆ—æ»¡è¶³

    **ç¼“å†²åŒºæœªæ»¡ï¼šå¯ä»¥æ‰“å°å·¦æ‹¬å·**

    **ç¼“å†²åŒºæœ‰è´§ï¼šå¯ä»¥æ‰“å°å³æ‹¬å·**

    - ä¸€å®šæ˜¯æŸä¸ªåˆæ³•æ‹¬å·åºåˆ—çš„å‰ç¼€
    - æ‹¬å·åµŒå¥—çš„æ·±åº¦ä¸è¶…è¿‡ n
        - n=3ï¼š`((())())(((` åˆæ³•
        - n=3ï¼š`(((())))`, `(()))` ä¸åˆæ³•

```C
void produce() {
    wait_until(æ‹¬å·æ·±åº¦ < n) {
        printf("(");
    }
}

void consume() {
    wait_until(æ‹¬å·æ·±åº¦ > 0) {
        printf(")");
    }
}
```



#### version1

```C
int n, depth = 0;
void T_produce() {
    while (1) {
retry:
        mutex_lock(&lk);
        int ready = (depth < n);
        mutex_unlock(&lk);
        if (!ready) goto retry;

        // context switch
        // assert(depth < n);

        mutex_lock(&lk);
        printf("(");
        depth++;
        mutex_unlock(&lk);
    }
}

void T_consume() {
    while (1) {
retry:
        mutex_lock(&lk);
        int ready = (depth > 0);
        mutex_unlock(&lk);
        if (!ready) goto retry;

        // assert(depth > 0);

        mutex_lock(&lk);
        printf(")");
        depth--;
        mutex_unlock(&lk);
    }
}
```

why wrongï¼Ÿ

æŒºå¥½ç†è§£çš„ï¼Œè¿˜æ˜¯ä¹‹å‰çš„é‚£æ ·ï¼Œç¬¬ 8 è¡Œçš„ ready æ˜¯ä¸€ä¸ªå…±äº«èµ„æºæ¥çš„ï¼Œæ²¡å¯¹å®ƒåŠ é”ï¼Œè‡ªç„¶å°±æœ‰å¯èƒ½è¯»åˆ°çš„æ˜¯æ—§çš„ readyï¼ˆåˆšå¥½ç¬¬ 8 è¡Œåä¸Šä¸‹æ–‡åˆ‡æ¢ã€æ¥ä¸­æ–­ï¼Œå› ä¸ºè¿˜æ²¡æœ‰æ›´æ–°ç¼“å†²åŒºï¼Œå¯¼è‡´åˆ«çš„çº¿ç¨‹çš„ç¬¬ 13 åˆ° ç¬¬ 16 è¡Œçš„ä»£ç å°±ä¼šå°†ç¼“å†²åŒºå¡«æ»¡ï¼Œè¿™ä¸ªæ—¶å€™ 11 è¡Œçš„ assert å°±æœ‰é—®é¢˜ï¼‰ã€‚

åªè¦å­˜åœ¨å¤šä¸ªæ¶ˆè´¹è€…ï¼Œé‚£å°±ä¼šåœ¨å¹¶å‘çš„æ—¶å€™å½±å“åˆ° ready çš„å€¼ã€‚

ä¹Ÿå¾ˆå®¹æ˜“è§£å†³ï¼Œå…¶å®å°±æ˜¯ 5 åˆ° 8 è¡Œå¯¹ ready é”çš„æ—¶é—´ä¸å¤Ÿé•¿ï¼Œå°†æ•´ä¸ª produce çš„æ“ä½œéƒ½å˜æˆåŸå­çš„ï¼Œéƒ½é”ä½ã€‚



#### version2

```C
#define CAN_PRODUCE (depth < n)
#define CAN_CONSUME (depth > 0)

void T_produce() {
    while (1) {
retry:
        mutex_lock(&lk);
        if (!CAN_PRODUCE) {
            mutex_unlock(&lk);
            goto retry;
        }

        // The check of sync condition (depth < n) is within
        // the same critical section. As long as we safely
        // protected the shared state, this condition should
        // always hold at this point.
        assert(depth < n);

        printf("(");
        depth++;

        // And at this point, the condition (depth > 0) is
        // satisfied. However, a consumer could proceed with
        // checking depth only if the lock is released.
        mutex_unlock(&lk);
    }
}

void T_consume() {
    while (1) {
retry:
        mutex_lock(&lk);
        if (!CAN_CONSUME) {
            mutex_unlock(&lk);
            goto retry;
        }

        assert(depth > 0);

        printf(")");
        depth--;

        mutex_unlock(&lk);
    }
}

```

ç”±æ­¤å¾—å‡ºè¿™ä¸ªä¸‡èƒ½æ¨¡å‹ï¼Œå…³é”®åœ¨äºæ€ä¹ˆæ¢è¿™ä¸ªåŒæ­¥æ¡ä»¶ã€‚

è¿›ä¸€æ­¥ï¼ŒOS å¼€å‘è€…å°†ä¸Šé¢çš„å†…å®¹æ”¹è¿›å˜æˆäº†ç”¨æ¡ä»¶å˜é‡æ¥å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ã€‚







#### conditional variable

å¯¹äºä¸Šé¢çš„å®ç°ï¼Œæœ€å¤§çš„é—®é¢˜å°±æ˜¯çº¿ç¨‹æµªè´¹ `cpu`ï¼Œä¾ç„¶è‡ªæ—‹ç©ºè½¬ã€‚

> å¦‚æœ ç”Ÿäº§è€…å·²ç»æ”¾æ…¢äº†èµ„æºåˆ°ç¼“å†²åŒºï¼Œä½†æ˜¯æ¶ˆè´¹è€…è¿˜æ²¡æœ‰æ¶ˆè´¹å®Œï¼Œé‚£ç”Ÿäº§è€…å°±ä¸€ç›´è‡ªæ—‹åœ¨é‚£äº†ã€‚

è¿›ä¸€æ­¥ä¸Šé¢è§‚å¯Ÿä¸Šé¢ç‰¹å¾ï¼šåŒæ­¥æ¡ä»¶ + è‡ªæ—‹ã€‚ 

å›æƒ³å‰å‡ è¯¾çš„å†…å®¹ï¼Œæ—¢ç„¶ç©ºè½¬æµªè´¹èµ„æºï¼Œé‚£å°±ä½ ç¡å»å§ï¼Œè®©åˆ«äººï¼ˆçº¿ç¨‹ï¼‰æ¥åšã€‚

å¦å¤–ï¼ŒåŒæ­¥æ¡ä»¶ -> å˜é‡



å…·ä½“æ¥è¯´ï¼Œåœ¨åŒæ­¥æ¡ä»¶ä¸æˆç«‹çš„æ—¶å€™ï¼ˆä¾ç„¶è§£é”é”ï¼‰ï¼Œä¸ä½¿ç”¨ retryï¼Œè€Œæ˜¯ç­‰åˆ°æ¡ä»¶æ»¡è¶³æŸäººå°†æˆ‘å”¤é†’ï¼Œé†’æ¥ä¹‹åå†ä¸Šé”ã€‚

```C
mutex_lock(&lk);
while (!CAN_PRODUCE) {
    mutex_unlock(&lk);
    wait_for_someone_wake_me_up();
    mutex_lock(&lk);	
}
```

- æŠŠæ¡ä»¶ç”¨ä¸€ä¸ªå˜é‡æ¥æ›¿ä»£ï¼š`CAN_PRODUCE`  -> `cond_t cv`
- æ¡ä»¶ä¸æ»¡è¶³æ—¶ç­‰å¾…ï¼Œæ¡ä»¶æ»¡è¶³æ—¶å”¤é†’ï¼š`wait_for_someone_wake_me_up` + `mutex_lock`  -> `cond_wait`

```C
mutex_t lk = MUTEX_INIT();
cond_t cv = COND_INIT();

#define CAN_PRODUCE (depth < n)
#define CAN_CONSUME (depth > 0)
void T_produce() {
    while (1) {
        mutex_lock(&lk);
        while (!CAN_PRODUCE) {
            cond_wait(&cv, &lk);
            // We are here if the thread is being waked up, with
            // the mutex being acquired. Then we check once again,
            // and move out of the loop if CAN_PRODUCE holds.
        }

        // We still hold the mutex--and we check again.
        assert(CAN_PRODUCE);

        printf("(");
        depth++;

        cond_broadcast(&cv);
        mutex_unlock(&lk);
    }
}
void T_consume() {
    while (1) {
        mutex_lock(&lk);
        while (!CAN_CONSUME) {
            cond_wait(&cv, &lk);
        }

        printf(")");
        depth--;

        cond_broadcast(&cv);
        mutex_unlock(&lk);
    }
}

```

 ```C
 cond_wait(&cv, &lk)ï¼› // å¯¹äºè¿™ä¸ªåŒæ­¥æ¡ä»¶cvä¸æˆç«‹ï¼Œè¿›å…¥ç¡çœ æ¨¡å¼ï¼Œè¿›å…¥ç­‰å¾…ï¼ŒåŒæ—¶é‡Šæ”¾é”lkï¼Œè¢«å”¤é†’ååˆé‡æ–°ä¸Šé”
 
 //æœ‰äººåœ¨ç­‰å¾…æˆ‘çš„æ¡ä»¶ï¼Œæˆ‘å°†ä»–å”¤é†’
 cond_signal(&cv);  // Wake up a (random) thread
 cond_broadcast(&cv);  // Wake up all threads
 ```



- **æ¡ä»¶å˜é‡çš„æ­£ç¡®æ‰“å¼€æ–¹å¼**

    **ä½¿ç”¨ while å¾ªç¯å’Œ broadcast**

    - **æ€»æ˜¯åœ¨å”¤é†’åå†æ¬¡æ£€æŸ¥åŒæ­¥æ¡ä»¶**
    - **æ€»æ˜¯å”¤é†’æ‰€æœ‰æ½œåœ¨å¯èƒ½è¢«å”¤é†’çš„äºº**

    ```C
    mutex_lock(&mutex);
    while (!COND) {
      wait(&cv, &mutex);
    }
    assert(cond);
    
    ...
    
    mutex_unlock(&mutex);
    
    ```

    åªè¦æœ‰æˆ‘å¯¹å…±äº«èµ„æºåšäº†ä¸€äº›æ”¹åŠ¨ï¼Œæˆ‘éƒ½å«é†’è¿™ä¸ªä¸–ç•Œçš„æ‰€æœ‰äººï¼ˆçº¿ç¨‹ï¼‰å»æ£€æŸ¥ä¸€ä¸‹è‡ªå·±çš„åŒæ­¥æ¡ä»¶ï¼ˆå¹¿æ’­ï¼‰ï¼Œå¦‚æœæ¡ä»¶æ»¡è¶³äº†ï¼Œé‚£å°±å¯ä»¥å»æ‰§è¡Œäº†ã€‚

> è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªç‰ˆæœ¬ï¼šä½¿ç”¨çš„æ˜¯ `if` å’Œ `cond_signal` å»å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ï¼Œä½†æ˜¯éœ€è¦ä¸¤ä¸ªæ¡ä»¶å˜é‡ï¼Œå…·ä½“ä¸ºä»€ä¹ˆï¼Œç®€å•å°±æ˜¯ï¼šæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±åŒæ­¥æ¡ä»¶ã€‚æ¯ä¸€ä¸ªçº¿ç¨‹åŒæ­¥æ¡ä»¶ä¸ä¸€æ ·ã€‚ï¼ˆä¸¤ç±»ä¸åŒçš„çº¿ç¨‹ï¼šç”Ÿäº§è€…ã€æ¶ˆè´¹è€…ï¼‰
>
> è¯¦ç»†å†…å®¹çœ‹æ•™æï¼š[ç¬¬ 30 ç«  - Condition Variables](https://pages.cs.wisc.edu/~remzi/OSTEP/threads-cv.pdf)

**==å¯ä»¥è®°ä½è¿™ç§ä»£ç æ¨¡æ¿å†™æ³•ï¼Œæ€»èƒ½è§£å†³å¹¶å‘é—®é¢˜==**





### åŒæ­¥æœºåˆ¶çš„åº”ç”¨

è§£å†³åŒæ­¥é—®é¢˜çš„æ ¸å¿ƒï¼šå¼„æ¸…æ¥šåŒæ­¥æ¡ä»¶ã€‚



#### å¹¶è¡Œè®¡ç®—ï¼šå®ç°è®¡ç®—å›¾

å¦‚æœç”¨å¤šå¤„ç†å™¨å¹¶è¡Œç¼–ç¨‹å®Œæˆå¾ˆå¤§çš„**è®¡ç®—ä»»åŠ¡**ï¼Œé¦–å…ˆè¦åšçš„å°±æ˜¯å°†ä»»åŠ¡åˆ†æˆè‹¥å¹²æ­¥ï¼šè®¡ç®—ä»»åŠ¡æ„æˆæœ‰å‘æ— ç¯å›¾

> é…åˆä¾‹å­å’Œå›¾ï¼ˆç®—ç´ æ•°è¡¨ï¼‰ï¼š
>
> <img src="pic/image-20250114215612517.png" alt="image-20250114215612517" style="zoom: 67%;" />

- (u,v)âˆˆE(*u*,*v*)âˆˆ*E* è¡¨ç¤º v*v* è¦ç”¨åˆ°å‰ u*u* çš„å€¼

- **åªè¦è°ƒåº¦å™¨ (ç”Ÿäº§è€…) åˆ†é…ä»»åŠ¡æ•ˆç‡å¤Ÿé«˜ï¼Œç®—æ³•å°±èƒ½å¹¶è¡Œ**

    > è¿™æ˜¯ç‰©ç†å†…å­˜åˆ†é…çš„æƒ³æ³•å—ï¼Ÿè¿™ä¸ªè°ƒåº¦å™¨æ€ä¹ˆå®ç°ï¼Ÿå¾ˆé‡è¦ã€‚

```C
void T_worker() {
    while (1) {
        consume().run();
    }
}
void T_scheduler() {
    while (!jobs.empty()) {
        for (auto j : jobs.find_ready()) {
            produce(j);
        }
    }
}
```



- **å®ç°**

    - ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹

        ç”Ÿäº§è€…éå†è®¡ç®—å›¾ï¼Œæ¶ˆè´¹è€…å®é™…åšè®¡ç®—ã€‚ï¼ˆä»¥ç´ æ•°è¡¨ä¸ºä¾‹ï¼Œéå†æ—¶é—´å‡ å¾®ç§’ï¼Œè®¡ç®—æ—¶é—´å‡ ç§’ï¼Œå°±å¾ˆå¥½ï¼‰

        ç”Ÿäº§è€…éå†åï¼Œå°†ä¸€ä¸ªä¸ªä»»åŠ¡æ”¾è‡³ç¼“å†²åŒºä¸­ã€‚æ¯ä¸€ä¸ªæ¶ˆè´¹è€… worker å°±å»ç¼“å†²åŒºä¸­å–ä»»åŠ¡è®¡ç®—ã€‚

        **==åªè¦èƒ½å°†ä»»åŠ¡åˆ†è§£æˆæœ‰å‘æ— ç¯å›¾çš„å½¢å¼ï¼Œç”¨ä¸€ä¸ªç”Ÿäº§è€…ï¼Œå¤šä¸ªæ¶ˆè´¹è€…å³å¯å®ç°å¤šä»»åŠ¡å¹¶è¡Œã€‚==**

        ```c++
        // author: kimi
        
        #include <stdio.h>
        #include <stdlib.h>
        #include <pthread.h>
        #include <queue>
        #include <vector>
        #include <mutex>
        #include <condition_variable>
        
        std::queue<int> jobs;
        std::mutex mtx;
        std::condition_variable cv;
        bool done = false;
        
        void produce(int job) {
            std::lock_guard<std::mutex> lock(mtx);
            jobs.push(job);
            cv.notify_one();
        }
        
        int consume() {
            std::unique_lock<std::mutex> lock(mtx);
            cv.wait(lock, [] { return !jobs.empty() || done; });
            if (jobs.empty()) {
                return -1; // è¡¨ç¤ºæ²¡æœ‰æ›´å¤šä»»åŠ¡
            }
            int job = jobs.front();
            jobs.pop();
            return job;
        }
        
        void T_worker() {
            while (1) {
                int job = consume();
                if (job == -1) {
                    break;
                }
                // æ‰§è¡Œä»»åŠ¡
                printf("Processing job: %d\n", job);
                // æ¨¡æ‹Ÿè®¡ç®—æ—¶é—´
                sleep(1);
            }
        }
        
        void T_scheduler() {
            for (int i = 0; i < 10; ++i) {
                produce(i);
            }
            done = true;
            cv.notify_all();
        }
        
        int main() {
            const int num_workers = 4;
            std::vector<pthread_t> workers(num_workers);
        
            for (int i = 0; i < num_workers; ++i) {
                pthread_create(&workers[i], NULL, (void *(*)(void *))T_worker, NULL);
            }
        
            T_scheduler();
        
            for (int i = 0; i < num_workers; ++i) {
                pthread_join(workers[i], NULL);
            }
        
            return 0;
        }
        ```

        1. **ç”Ÿäº§è€…ï¼ˆT_schedulerï¼‰**ï¼š
            - ç”Ÿæˆ 10 ä¸ªä»»åŠ¡ï¼Œå¹¶å°†å®ƒä»¬æ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—ä¸­ã€‚
            - è®¾ç½® `done` æ ‡å¿—ä¸º `true`ï¼Œè¡¨ç¤ºæ²¡æœ‰æ›´å¤šä»»åŠ¡ã€‚
            - é€šçŸ¥æ‰€æœ‰ç­‰å¾…çš„æ¶ˆè´¹è€…çº¿ç¨‹ã€‚
        2. **æ¶ˆè´¹è€…ï¼ˆT_workerï¼‰**ï¼š
            - ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡ã€‚
            - å¦‚æœä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºä¸” `done` æ ‡å¿—ä¸º `true`ï¼Œåˆ™é€€å‡ºå¾ªç¯ã€‚
            - å¤„ç†ä»»åŠ¡ï¼Œæ¨¡æ‹Ÿè®¡ç®—æ—¶é—´ã€‚
        3. å…³é”®ç‚¹
            - **ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹**ï¼šç”Ÿäº§è€…è´Ÿè´£ç”Ÿæˆä»»åŠ¡å¹¶æ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ¶ˆè´¹è€…ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡å¹¶æ‰§è¡Œã€‚
            - **æ¡ä»¶å˜é‡**ï¼šç”¨äºçº¿ç¨‹é—´çš„åŒæ­¥ï¼Œç¡®ä¿æ¶ˆè´¹è€…çº¿ç¨‹åœ¨ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºæ—¶ç­‰å¾…ï¼Œç”Ÿäº§è€…çº¿ç¨‹åœ¨ç”Ÿæˆä»»åŠ¡åé€šçŸ¥æ¶ˆè´¹è€…çº¿ç¨‹ã€‚
            - **äº’æ–¥é”**ï¼šä¿æŠ¤å…±äº«èµ„æºï¼ˆä»»åŠ¡é˜Ÿåˆ—ï¼‰çš„è®¿é—®ï¼Œç¡®ä¿çº¿ç¨‹å®‰å…¨ã€‚

    

    > more exampleï¼šçº¿ç¨‹æ± 
    >
    > æ¯ä¸€ä¸ª worker å°±æ˜¯ä¸€ä¸ªå·¥ä½œçš„çº¿ç¨‹ï¼ŒæŠŠä¸€ä¸ªä¸ªå°çš„ä»»åŠ¡æ”¾åˆ°çº¿ç¨‹æ± ï¼Œç„¶åçº¿ç¨‹æ± æœ‰ä¸ªè°ƒåº¦å™¨ï¼Œè°ƒåº¦å™¨å†å°†è¿™äº›ä»»åŠ¡å†åˆ†ç»™ workerã€‚

    

    **å½“ç„¶è¿˜èƒ½ç”¨æ¡ä»¶å˜é‡å®ç°åŒæ­¥**

    - æ¡ä»¶å˜é‡

        ä¸ºæ¯ä¸€ä¸ªè®¡ç®—èŠ‚ç‚¹éƒ½è®¾ç½®ä¸€ä¸ªæ¡ä»¶å˜é‡

        ```C++
        // kimi 
        // ä¸»è¦çœ‹é€»è¾‘
        
        #include <iostream>
        #include <vector>
        #include <queue>
        #include <mutex>
        #include <condition_variable>
        #include <thread>
        #include <functional>
        #include <unordered_map>
        #include <list>
        
        // ä»»åŠ¡èŠ‚ç‚¹
        struct Task {
            int id;
            std::function<void()> func;
            std::vector<int> dependencies;
            int ready_count = 0;
        };
        
        // è®¡ç®—å›¾
        class ComputeGraph {
        public:
            void addTask(int id, std::function<void()> func, const std::vector<int>& dependencies) {
                tasks[id] = {id, func, dependencies, 0};
                for (int dep : dependencies) {
                    task_dependencies[dep].push_back(id);
                }
            }
        
            void run() {
                // åˆå§‹åŒ–å°±ç»ªä»»åŠ¡é˜Ÿåˆ—
                for (auto& [id, task] : tasks) {
                    if (task.dependencies.empty()) {
                        ready_tasks.push(id);
                    }
                }
        
                // å¯åŠ¨è°ƒåº¦çº¿ç¨‹
                scheduler_thread = std::thread(&ComputeGraph::scheduler, this);
        
                // å¯åŠ¨å·¥ä½œçº¿ç¨‹
                for (int i = 0; i < num_workers; ++i) {
                    workers.push_back(std::thread(&ComputeGraph::worker, this));
                }
        
                // ç­‰å¾…è°ƒåº¦çº¿ç¨‹ç»“æŸ
                scheduler_thread.join();
        
                // ç­‰å¾…å·¥ä½œçº¿ç¨‹ç»“æŸ
                for (auto& worker : workers) {
                    worker.join();
                }
            }
        
        private:
            std::unordered_map<int, Task> tasks;
            std::unordered_map<int, std::list<int>> task_dependencies;
            std::queue<int> ready_tasks;
            std::mutex mtx;
            std::condition_variable cv;
            bool done = false;
            std::vector<std::thread> workers;
            std::thread scheduler_thread;
            int num_workers = 4;
        
            void scheduler() {
                while (!ready_tasks.empty()) {
                    int task_id = ready_tasks.front();
                    ready_tasks.pop();
        
                    // é€šçŸ¥å·¥ä½œçº¿ç¨‹
                    cv.notify_one();
                }
        
                // è®¾ç½® done æ ‡å¿—ï¼Œé€šçŸ¥æ‰€æœ‰å·¥ä½œçº¿ç¨‹
                done = true;
                cv.notify_all();
            }
        
            void worker() {
                while (1) {
                    std::unique_lock<std::mutex> lock(mtx);
                    cv.wait(lock, [this] { return !ready_tasks.empty() || done; });
        
                    if (done && ready_tasks.empty()) {
                        break;
                    }
        
                    int task_id = ready_tasks.front();
                    ready_tasks.pop();
                    lock.unlock();
        
                    // æ‰§è¡Œä»»åŠ¡
                    tasks[task_id].func();
        
                    // æ›´æ–°ä¾èµ–å…³ç³»
                    for (int dependent_id : task_dependencies[task_id]) {
                        std::lock_guard<std::mutex> lock(mtx);
                        tasks[dependent_id].ready_count++;
                        if (tasks[dependent_id].ready_count == tasks[dependent_id].dependencies.size()) {
                            ready_tasks.push(dependent_id);
                        }
                    }
                }
            }
        };
        
        void task1() {
            std::cout << "Task 1" << std::endl;
        }
        
        void task2() {
            std::cout << "Task 2" << std::endl;
        }
        
        void task3() {
            std::cout << "Task 3" << std::endl;
        }
        
        void task4() {
            std::cout << "Task 4" << std::endl;
        }
        
        int main() {
            ComputeGraph graph;
        
            // æ·»åŠ ä»»åŠ¡
            graph.addTask(1, task1, {});
            graph.addTask(2, task2, {1});
            graph.addTask(3, task3, {1});
            graph.addTask(4, task4, {2, 3});
        
            // è¿è¡Œè®¡ç®—å›¾
            graph.run();
        
            return 0;
        }
        ```

        

    - example





#### åœºæ™¯ï¼šåŠ¨æ€è§„åˆ’ 

> è¿˜æœ‰å“ªäº›åœºæ™¯å¹¶è¡ŒåŠ é€Ÿï¼Ÿ
>

![image-20250114164832957](pic/image-20250114164832957.png)

å¦‚æœä¸€ä¸ªç®—æ³•çš„åä¸€æ­¥å®Œå…¨ä¾èµ–äºå‰ä¸€æ­¥ï¼Œé‚£è¿™ä¸ªç®—æ³•å°±ä¸å¥½å¹¶è¡Œçš„ã€‚æ‰€ä»¥è¦å°†è¿™ä¸ªæœ‰å‘æ— ç¯å›¾åšå¾—å¾ˆå®½å¾ˆå®½çš„ï¼Œè¦è¶³å¤Ÿå®½ã€‚

> è¿™å°±æœ‰ä¸ªé—®é¢˜ï¼Œæ€ä¹ˆçœ‹è¿™ä¸ªå¹¶è¡Œä¹‹åçš„æ€§èƒ½å’Œæ²¡å¹¶è¡Œçš„æ€§èƒ½å·®å¼‚ï¼Ÿé€šè¿‡ä»€ä¹ˆå·¥å…·ï¼Ÿä»€ä¹ˆæŒ‡æ ‡ï¼Ÿ



ä¸€ä¸ªé¢è¯•é—®é¢˜ï¼šå¤šå¤„ç†å™¨å¾ˆæ™®åŠçš„æƒ…å†µä¸‹ï¼Œæ€ä¹ˆå°†ä¸€ä¸ªé—®é¢˜å¹¶è¡ŒåŠ é€Ÿï¼Ÿ

ç¬¬ä¸€ååº” åº”è¯¥æ˜¯ äº†è§£è®¡ç®—å›¾æ˜¯ä»€ä¹ˆï¼Œå®ƒçš„ç»“æ„æ˜¯ä»€ä¹ˆï¼Œå®ƒçš„åˆ‡åˆ†æ–¹æ³•ã€‚

> æ¥è‡ª AIï¼š
>
> 1. **è®¡ç®—å›¾çš„æ¦‚å¿µ**
>    
>    - è®¡ç®—å›¾æ˜¯ä¸€ç§ç”¨äºè¡¨ç¤ºè®¡ç®—è¿‡ç¨‹çš„æœ‰å‘å›¾ã€‚åœ¨å›¾ä¸­ï¼ŒèŠ‚ç‚¹ï¼ˆé¡¶ç‚¹ï¼‰é€šå¸¸è¡¨ç¤ºæ“ä½œï¼ˆå¦‚åŠ æ³•ã€ä¹˜æ³•ç­‰ï¼‰æˆ–è€…å˜é‡ï¼ˆè¾“å…¥ã€ä¸­é—´ç»“æœã€è¾“å‡ºç­‰ï¼‰ï¼Œè¾¹è¡¨ç¤ºæ•°æ®çš„æµå‘ã€‚ä¾‹å¦‚ï¼Œåœ¨æ·±åº¦å­¦ä¹ ä¸­ï¼Œä¸€ä¸ªç®€å•çš„ç¥ç»ç½‘ç»œçš„å‰å‘ä¼ æ’­è¿‡ç¨‹å¯ä»¥è¡¨ç¤ºä¸ºè®¡ç®—å›¾ã€‚å‡è®¾æœ‰ä¸€ä¸ªä¸¤å±‚çš„ç¥ç»ç½‘ç»œï¼Œè¾“å…¥å±‚æœ‰ä¸€ä¸ªèŠ‚ç‚¹ \( x \)ï¼Œéšè—å±‚æœ‰ä¸€ä¸ªèŠ‚ç‚¹ \( h \)ï¼Œè¾“å‡ºå±‚æœ‰ä¸€ä¸ªèŠ‚ç‚¹ \( y \)ã€‚å…¶ä¸­éšè—å±‚èŠ‚ç‚¹ \( h \) çš„è®¡ç®—æ˜¯ \( h = W_1x + b_1 \)ï¼Œè¾“å‡ºå±‚èŠ‚ç‚¹ \( y \) çš„è®¡ç®—æ˜¯ \( y = W_2h + b_2 \)ã€‚è¿™é‡Œ \( W_1, W_2, b_1, b_2 \) æ˜¯æƒé‡å’Œåç½®å‚æ•°ã€‚é‚£ä¹ˆè®¡ç®—å›¾ä¸­ä¼šæœ‰èŠ‚ç‚¹ \( x, h, y \) ä»¥åŠå¯¹åº”çš„æƒé‡å’Œåç½®èŠ‚ç‚¹ï¼Œè¾¹è¡¨ç¤ºæ•°æ®ä»è¾“å…¥å±‚æµå‘éšè—å±‚ï¼Œå†ä»éšè—å±‚æµå‘è¾“å‡ºå±‚ã€‚
>    - è®¡ç®—å›¾åœ¨æ•°æ®æµç¼–ç¨‹æ¨¡å‹ä¸­éå¸¸é‡è¦ã€‚å®ƒèƒ½å¤Ÿæ¸…æ™°åœ°æè¿°æ•°æ®æ˜¯å¦‚ä½•åœ¨å„ä¸ªæ“ä½œä¹‹é—´æµåŠ¨çš„ï¼Œä»¥åŠå„ä¸ªæ“ä½œä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚è¿™ç§å›¾ç»“æ„ä½¿å¾—å¹¶è¡Œè®¡ç®—å’Œè‡ªåŠ¨å¾®åˆ†ç­‰æ“ä½œå˜å¾—æ–¹ä¾¿ã€‚ä¾‹å¦‚ï¼Œåœ¨è‡ªåŠ¨å¾®åˆ†ä¸­ï¼Œé€šè¿‡è®¡ç®—å›¾å¯ä»¥å¾ˆå®¹æ˜“åœ°åº”ç”¨é“¾å¼æ³•åˆ™æ¥è®¡ç®—æ¢¯åº¦ï¼Œå› ä¸ºå›¾çš„ç»“æ„å·²ç»æ˜ç¡®äº†æ“ä½œçš„é¡ºåºå’Œä¾èµ–å…³ç³»ã€‚
>    
> 2. **åˆ‡åˆ†è®¡ç®—å›¾**
>
>    - ä»»åŠ¡åˆ’åˆ†ï¼šæ ¹æ®è®¡ç®—å›¾çš„ç»“æ„ï¼Œå°†è®¡ç®—ä»»åŠ¡åˆ’åˆ†åˆ°ä¸åŒçš„å¤„ç†å™¨ä¸Šã€‚å¯ä»¥é‡‡ç”¨å‡ ç§å¸¸è§çš„åˆ‡åˆ†æ–¹æ³•ï¼š
>        - **æŒ‰èŠ‚ç‚¹åˆ’åˆ†**ï¼šå°†è®¡ç®—å›¾ä¸­çš„èŠ‚ç‚¹ï¼ˆæ“ä½œï¼‰åˆ†é…ç»™ä¸åŒçš„å¤„ç†å™¨ã€‚ä¾‹å¦‚ï¼Œåœ¨æ·±åº¦å­¦ä¹ çš„ç¥ç»ç½‘ç»œå‰å‘ä¼ æ’­è®¡ç®—å›¾ä¸­ï¼Œå¯ä»¥å°†ä¸åŒå±‚çš„æ“ä½œåˆ†é…åˆ°ä¸åŒçš„å¤„ç†å™¨ã€‚å¦‚æœæ˜¯ä¸€ä¸ªæœ‰ 10 å±‚çš„ç¥ç»ç½‘ç»œï¼Œå¯ä»¥å°†å‰ 5 å±‚çš„æ“ä½œåˆ†é…ç»™å¤„ç†å™¨ 1ï¼Œå 5 å±‚çš„æ“ä½œåˆ†é…ç»™å¤„ç†å™¨ 2ã€‚ä½†æ˜¯è¿™ç§æ–¹æ³•éœ€è¦è€ƒè™‘æ•°æ®ä¼ è¾“çš„å¼€é”€ï¼Œå› ä¸ºä¸åŒå±‚ä¹‹é—´å¯èƒ½éœ€è¦ä¼ è¾“æ•°æ®ã€‚
>        - **æŒ‰è¾¹åˆ’åˆ†**ï¼šå¦‚æœè®¡ç®—å›¾ä¸­çš„è¾¹ä»£è¡¨æ•°æ®ä¼ è¾“ï¼Œå¯ä»¥è€ƒè™‘æŒ‰ç…§æ•°æ®ä¼ è¾“çš„è·¯å¾„æ¥åˆ’åˆ†ä»»åŠ¡ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ªæ•°æ®æµå›¾ä¸­ï¼Œæ•°æ®ä»èŠ‚ç‚¹ A æµå‘èŠ‚ç‚¹ Bï¼Œå†æµå‘èŠ‚ç‚¹ Cã€‚å¯ä»¥å°† A åˆ° B çš„æ•°æ®å¤„ç†å’Œä¼ è¾“åˆ†é…ç»™ä¸€ä¸ªå¤„ç†å™¨ï¼ŒB åˆ° C çš„å¤„ç†å’Œä¼ è¾“åˆ†é…ç»™å¦ä¸€ä¸ªå¤„ç†å™¨ã€‚è¿™ç§æ–¹æ³•é€‚ç”¨äºæ•°æ®ä¼ è¾“å’Œå¤„ç†ç´§å¯†ç›¸å…³çš„åœºæ™¯ã€‚
>        - **åŒºåŸŸåˆ’åˆ†**ï¼šå¯¹äºä¸€äº›å…·æœ‰ç©ºé—´å±€éƒ¨æ€§çš„è®¡ç®—å›¾ï¼Œå¦‚å›¾åƒå¤„ç†ä¸­çš„åƒç´ æ“ä½œè®¡ç®—å›¾ï¼Œå¯ä»¥æŒ‰ç…§å›¾åƒçš„åŒºåŸŸæ¥åˆ’åˆ†ä»»åŠ¡ã€‚å°†å›¾åƒåˆ†æˆå¤šä¸ªåŒºåŸŸï¼Œæ¯ä¸ªå¤„ç†å™¨è´Ÿè´£ä¸€ä¸ªåŒºåŸŸå†…çš„åƒç´ æ“ä½œã€‚è¿™ç§æ–¹æ³•å¯ä»¥å‡å°‘æ•°æ®ä¼ è¾“ï¼Œå› ä¸ºç›¸é‚»åƒç´ ä¹‹é—´çš„æ“ä½œå¾€å¾€æœ‰æ•°æ®å±€éƒ¨æ€§ã€‚
>    - **è´Ÿè½½å‡è¡¡**ï¼šåœ¨åˆ‡åˆ†è®¡ç®—å›¾æ—¶ï¼Œè¦å°½é‡ä¿è¯å„ä¸ªå¤„ç†å™¨çš„è´Ÿè½½å‡è¡¡ã€‚å¦‚æœä¸€ä¸ªå¤„ç†å™¨åˆ†é…åˆ°çš„ä»»åŠ¡é‡è¿‡å¤§ï¼Œè€Œå…¶ä»–å¤„ç†å™¨ä»»åŠ¡é‡è¿‡å°ï¼Œä¼šå¯¼è‡´å¤„ç†å™¨ä¹‹é—´ç­‰å¾…ï¼Œé™ä½æ•´ä½“æ•ˆç‡ã€‚å¯ä»¥é€šè¿‡ä¼°ç®—æ¯ä¸ªæ“ä½œçš„è®¡ç®—å¤æ‚åº¦æ¥åˆ†é…ä»»åŠ¡ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ªè®¡ç®—å›¾ä¸­ï¼Œæœ‰äº›æ“ä½œæ˜¯ç®€å•çš„åŠ æ³•ï¼Œæœ‰äº›æ“ä½œæ˜¯å¤æ‚çš„çŸ©é˜µæ±‚é€†ã€‚å¯ä»¥å°†è®¡ç®—å¤æ‚åº¦é«˜çš„æ“ä½œé€‚å½“åˆ†æ•£åˆ°ä¸åŒçš„å¤„ç†å™¨ä¸Šï¼Œä½¿æ¯ä¸ªå¤„ç†å™¨çš„è®¡ç®—æ—¶é—´å¤§è‡´ç›¸å½“ã€‚
>
> 3. **å¤„ç†æ•°æ®ä¼ è¾“å’ŒåŒæ­¥**
>
>    - æ•°æ®ä¼ è¾“ä¼˜åŒ–
>
>        ï¼šåœ¨å¤šå¤„ç†å™¨å¹¶è¡Œè®¡ç®—ä¸­ï¼Œæ•°æ®ä¼ è¾“æ˜¯ä¸€ä¸ªå…³é”®é—®é¢˜ã€‚å½“è®¡ç®—å›¾è¢«åˆ‡åˆ†åˆ°ä¸åŒçš„å¤„ç†å™¨åï¼Œå¤„ç†å™¨ä¹‹é—´å¯èƒ½éœ€è¦ä¼ è¾“æ•°æ®ã€‚å¯ä»¥é‡‡ç”¨ä»¥ä¸‹æ–¹æ³•ä¼˜åŒ–æ•°æ®ä¼ è¾“ï¼š
>
>        - **å‡å°‘ä¼ è¾“é‡**ï¼šåªä¼ è¾“å¿…è¦çš„æ•°æ®ã€‚ä¾‹å¦‚ï¼Œåœ¨çŸ©é˜µä¹˜æ³•å¹¶è¡Œè®¡ç®—ä¸­ï¼Œå¦‚æœå°†çŸ©é˜µ A*A* çš„ä¸åŒè¡Œåˆ†é…ç»™ä¸åŒçš„å¤„ç†å™¨ï¼Œé‚£ä¹ˆæ¯ä¸ªå¤„ç†å™¨åªéœ€è¦ä¼ è¾“å®ƒæ‰€è´Ÿè´£è¡Œç›¸å…³çš„æ•°æ®ï¼Œè€Œä¸æ˜¯æ•´ä¸ªçŸ©é˜µ A*A*ã€‚
>        - **ä½¿ç”¨é«˜æ•ˆä¼ è¾“åè®®**ï¼šåœ¨åˆ†å¸ƒå¼è®¡ç®—ç¯å¢ƒä¸­ï¼Œå¯ä»¥ä½¿ç”¨ MPIï¼ˆMessage Passing Interfaceï¼‰ç­‰é«˜æ•ˆçš„é€šä¿¡åè®®æ¥ä¼ è¾“æ•°æ®ã€‚MPI æä¾›äº†ä¸°å¯Œçš„é€šä¿¡æ“ä½œï¼Œå¦‚ç‚¹å¯¹ç‚¹é€šä¿¡ã€é›†ä½“é€šä¿¡ï¼ˆå¦‚å¹¿æ’­ã€å½’çº¦ç­‰ï¼‰ï¼Œå¯ä»¥é’ˆå¯¹ä¸åŒçš„æ•°æ®ä¼ è¾“éœ€æ±‚é€‰æ‹©åˆé€‚çš„é€šä¿¡æ“ä½œã€‚
>
>    - **åŒæ­¥æœºåˆ¶**ï¼šä¸ºäº†ä¿è¯è®¡ç®—çš„æ­£ç¡®æ€§ï¼Œéœ€è¦åœ¨å¤„ç†å™¨ä¹‹é—´è¿›è¡ŒåŒæ­¥ã€‚å¯ä»¥ä½¿ç”¨äº’æ–¥é”ã€ä¿¡å·é‡ã€å±éšœï¼ˆBarrierï¼‰ç­‰åŒæ­¥åŸè¯­ã€‚ä¾‹å¦‚ï¼Œåœ¨è®¡ç®—å›¾ä¸­ï¼Œå¦‚æœä¸€ä¸ªæ“ä½œä¾èµ–äºå¤šä¸ªå…¶ä»–æ“ä½œçš„ç»“æœï¼Œå¯ä»¥åœ¨è¿™äº›æ“ä½œæ‰§è¡Œå®Œæ¯•åï¼Œé€šè¿‡å±éšœåŒæ­¥ï¼Œç¡®ä¿æ‰€æœ‰ä¾èµ–çš„æ“ä½œéƒ½å®Œæˆåï¼Œå†æ‰§è¡Œå½“å‰æ“ä½œã€‚åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå¯ä»¥ä½¿ç”¨äº’æ–¥é”æ¥æ§åˆ¶å¯¹å…±äº«èµ„æºï¼ˆå¦‚è®¡ç®—å›¾ä¸­çš„ä¸­é—´ç»“æœå­˜å‚¨åŒºï¼‰çš„è®¿é—®ï¼Œé˜²æ­¢æ•°æ®ç«äº‰ã€‚
>
> 2. **è®¡ç®—å›¾æ‰€å±çš„çŸ¥è¯†é¢†åŸŸ**
>    
>    - **æ•°æ®ç»“æ„ä¸ç®—æ³•**ï¼šè®¡ç®—å›¾æœ¬èº«æ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œå®ƒç”¨å›¾çš„å½¢å¼æ¥ç»„ç»‡æ•°æ®å’Œæ“ä½œã€‚åœ¨æ•°æ®ç»“æ„ä¸­ï¼Œå›¾æ˜¯ä¸€ç§åŸºæœ¬çš„æ•°æ®ç»“æ„ï¼ŒåŒ…æ‹¬æœ‰å‘å›¾å’Œæ— å‘å›¾ç­‰ç±»å‹ã€‚è®¡ç®—å›¾æ˜¯å›¾çš„ä¸€ç§åº”ç”¨å½¢å¼ã€‚ä»ç®—æ³•è§’åº¦æ¥çœ‹ï¼Œå¯¹è®¡ç®—å›¾çš„æ“ä½œï¼Œå¦‚éå†ï¼ˆç”¨äºå‰å‘ä¼ æ’­è®¡ç®—ç»“æœæˆ–è€…åå‘ä¼ æ’­è®¡ç®—æ¢¯åº¦ï¼‰ã€æ‹“æ‰‘æ’åºï¼ˆç¡®å®šæ“ä½œçš„æ‰§è¡Œé¡ºåºï¼Œç‰¹åˆ«æ˜¯åœ¨æœ‰ä¾èµ–å…³ç³»çš„æ“ä½œä¸­ï¼‰ç­‰éƒ½æ¶‰åŠåˆ°ç®—æ³•çŸ¥è¯†ã€‚ä¾‹å¦‚ï¼Œæ‹“æ‰‘æ’åºç®—æ³•å¯ä»¥ç”¨äºç¡®å®šåœ¨è®¡ç®—å›¾ä¸­å„ä¸ªèŠ‚ç‚¹ï¼ˆæ“ä½œï¼‰çš„æ‰§è¡Œé¡ºåºï¼Œç¡®ä¿åœ¨æ‰§è¡Œä¸€ä¸ªæ“ä½œä¹‹å‰ï¼Œå…¶ä¾èµ–çš„æ‰€æœ‰æ“ä½œéƒ½å·²ç»å®Œæˆã€‚
>    - **è®¡ç®—æœºä½“ç³»ç»“æ„å’Œæ“ä½œç³»ç»Ÿ**ï¼šå½“æ¶‰åŠåˆ°å¤šçº¿ç¨‹è®¡ç®—å›¾æ—¶ï¼Œå°±åƒé¢˜ç›®ä¸­æåˆ°çš„ä½¿ç”¨äº’æ–¥é”æ¥å®ç°è®¡ç®—å›¾çš„è®¡ç®—ï¼Œè¿™å°±å’Œæ“ä½œç³»ç»Ÿä¸­çš„çº¿ç¨‹åŒæ­¥æœºåˆ¶ç›¸å…³ã€‚äº’æ–¥é”æ˜¯æ“ä½œç³»ç»Ÿæä¾›çš„ä¸€ç§åŒæ­¥åŸè¯­ï¼Œç”¨äºä¿è¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å¯¹å…±äº«èµ„æºçš„äº’æ–¥è®¿é—®ã€‚åœ¨è®¡ç®—å›¾çš„å¤šçº¿ç¨‹å®ç°ä¸­ï¼Œé€šè¿‡åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­å¯¹äº’æ–¥é”è¿›è¡Œ acquireï¼ˆè·å–ï¼‰å’Œ releaseï¼ˆé‡Šæ”¾ï¼‰æ“ä½œï¼Œæ¥æ§åˆ¶è®¡ç®—å›¾ä¸­å„ä¸ªèŠ‚ç‚¹ï¼ˆæ“ä½œï¼‰çš„æ‰§è¡Œé¡ºåºï¼Œç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§å’Œæ“ä½œçš„æ­£ç¡®æ€§ã€‚è¿™ä½“ç°äº†æ“ä½œç³»ç»Ÿåœ¨å¤šçº¿ç¨‹ç¼–ç¨‹å’Œèµ„æºç®¡ç†æ–¹é¢çš„çŸ¥è¯†ã€‚
>    - **å¹¶è¡Œè®¡ç®—å’Œåˆ†å¸ƒå¼è®¡ç®—**ï¼šåœ¨å¤§è§„æ¨¡çš„è®¡ç®—ä»»åŠ¡ä¸­ï¼Œå¦‚æ·±åº¦å­¦ä¹ è®­ç»ƒï¼Œè®¡ç®—å›¾å¯ä»¥åˆ†å¸ƒåœ¨å¤šä¸ªå¤„ç†å™¨æˆ–è€…å¤šå°æœºå™¨ä¸Šè¿›è¡Œå¹¶è¡Œè®¡ç®—ã€‚è¿™å°±æ¶‰åŠåˆ°å¹¶è¡Œè®¡ç®—ä¸­çš„ä»»åŠ¡åˆ’åˆ†ã€æ•°æ®ä¼ è¾“ã€è´Ÿè½½å‡è¡¡ç­‰çŸ¥è¯†ã€‚ä¾‹å¦‚ï¼Œåœ¨åˆ†å¸ƒå¼è®­ç»ƒä¸­ï¼Œè®¡ç®—å›¾çš„ä¸åŒéƒ¨åˆ†å¯èƒ½åœ¨ä¸åŒçš„æœºå™¨ä¸Šæ‰§è¡Œï¼Œéœ€è¦é€šè¿‡ç½‘ç»œé€šä¿¡æ¥ä¼ è¾“æ•°æ®ï¼Œå¹¶ä¸”è¦åˆç†åœ°åˆ’åˆ†è®¡ç®—å›¾çš„ä»»åŠ¡åˆ°å„ä¸ªæœºå™¨ä¸Šï¼Œä»¥æé«˜è®¡ç®—æ•ˆç‡ã€‚
>    
> 2. **åˆ©ç”¨å¤šå¤„ç†å™¨æ¶æ„ç‰¹æ€§**
>    
>    - **å¤šæ ¸å¤„ç†å™¨ä¼˜åŒ–**ï¼šå¯¹äºå¤šæ ¸å¤„ç†å™¨ï¼Œå¯ä»¥åˆ©ç”¨çº¿ç¨‹åº“ï¼ˆå¦‚ POSIX çº¿ç¨‹åº“ pthreadsï¼‰æ¥åˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Œå¹¶å°†è®¡ç®—å›¾çš„ä»»åŠ¡åˆ†é…ç»™ä¸åŒçš„çº¿ç¨‹ã€‚æ¯ä¸ªçº¿ç¨‹å¯ä»¥åœ¨ä¸€ä¸ªæ ¸å¿ƒä¸Šæ‰§è¡Œï¼Œä»è€Œå®ç°å¹¶è¡ŒåŠ é€Ÿã€‚åŒæ—¶ï¼Œè¦è€ƒè™‘åˆ°ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ã€‚åœ¨å¤šæ ¸å¤„ç†å™¨ä¸­ï¼Œæ¯ä¸ªæ ¸å¿ƒæœ‰è‡ªå·±çš„ç¼“å­˜ï¼Œå½“å¤šä¸ªçº¿ç¨‹è®¿é—®å…±äº«æ•°æ®æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç¼“å­˜ä¸ä¸€è‡´ã€‚å¯ä»¥é€šè¿‡åˆç†çš„æ•°æ®åˆ†é…å’Œè®¿é—®æ¨¡å¼æ¥å‡å°‘ç¼“å­˜ä¸ä¸€è‡´çš„å½±å“ã€‚ä¾‹å¦‚ï¼Œå°½é‡è®©çº¿ç¨‹è®¿é—®æœ¬åœ°ç¼“å­˜ä¸­çš„æ•°æ®ï¼Œå‡å°‘è·¨æ ¸å¿ƒçš„ç¼“å­˜è®¿é—®ã€‚
>    - **åˆ†å¸ƒå¼ç³»ç»Ÿä¼˜åŒ–**ï¼šåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¯ä»¥åˆ©ç”¨å¤šå°æœºå™¨çš„å¤„ç†å™¨èµ„æºã€‚å¯ä»¥ä½¿ç”¨åˆ†å¸ƒå¼è®¡ç®—æ¡†æ¶ï¼ˆå¦‚ Apache Hadoopã€Apache Spark ç­‰ï¼‰æ¥ç®¡ç†è®¡ç®—ä»»åŠ¡ã€‚è¿™äº›æ¡†æ¶æä¾›äº†ä»»åŠ¡è°ƒåº¦ã€æ•°æ®å­˜å‚¨å’Œç®¡ç†ç­‰åŠŸèƒ½ã€‚ä¾‹å¦‚ï¼Œåœ¨ Spark ä¸­ï¼Œå¯ä»¥å°†è®¡ç®—å›¾çš„ä»»åŠ¡å®šä¹‰ä¸º RDDï¼ˆResilient Distributed Datasetï¼‰æ“ä½œï¼ŒSpark ä¼šè‡ªåŠ¨å°†è¿™äº›æ“ä½œåˆ†é…åˆ°ä¸åŒçš„èŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼Œå¹¶ä¸”å¤„ç†èŠ‚ç‚¹ä¹‹é—´çš„æ•°æ®ä¼ è¾“å’Œä»»åŠ¡è°ƒåº¦ã€‚åŒæ—¶ï¼Œè¦è€ƒè™‘åˆ°ç½‘ç»œå¸¦å®½å’Œå»¶è¿Ÿå¯¹åˆ†å¸ƒå¼è®¡ç®—çš„å½±å“ï¼Œåˆç†åœ°è®¾è®¡æ•°æ®å­˜å‚¨å’Œä¼ è¾“ç­–ç•¥ã€‚
>    
> 3. **æ€»ç»“**
>    
>    - è®¡ç®—å›¾æ˜¯ä¸€ç§å¼ºå¤§çš„å·¥å…·ï¼Œç”¨äºè¡¨ç¤ºå’Œç®¡ç†å¤æ‚çš„è®¡ç®—è¿‡ç¨‹ã€‚å®ƒè·¨è¶Šäº†æ•°æ®ç»“æ„ä¸ç®—æ³•ã€è®¡ç®—æœºä½“ç³»ç»“æ„å’Œæ“ä½œç³»ç»Ÿã€å¹¶è¡Œè®¡ç®—å’Œåˆ†å¸ƒå¼è®¡ç®—ç­‰å¤šä¸ªçŸ¥è¯†é¢†åŸŸã€‚é€šè¿‡åˆç†åœ°æ„å»ºå’Œæ“ä½œè®¡ç®—å›¾ï¼Œå¯ä»¥å®ç°é«˜æ•ˆçš„è®¡ç®—ï¼Œç‰¹åˆ«æ˜¯åœ¨æ·±åº¦å­¦ä¹ ç­‰éœ€è¦å¤§é‡è®¡ç®—çš„é¢†åŸŸã€‚åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œåˆ©ç”¨äº’æ–¥é”ç­‰åŒæ­¥æœºåˆ¶æ¥æ§åˆ¶è®¡ç®—å›¾çš„æ‰§è¡Œï¼Œæ˜¯ç¡®ä¿è®¡ç®—æ­£ç¡®æ€§çš„é‡è¦æ‰‹æ®µã€‚

> æ¥è‡ª AIï¼š
>
> 1. ä»»åŠ¡åˆ†è§£
>
>     å°†å¤§ä»»åŠ¡åˆ†è§£ä¸ºå¤šä¸ªå°ä»»åŠ¡æ˜¯å¹¶è¡ŒåŒ–çš„ç¬¬ä¸€æ­¥ã€‚è¿™äº›å°ä»»åŠ¡å¯ä»¥æ˜¯ç‹¬ç«‹çš„ï¼Œä¹Ÿå¯ä»¥å­˜åœ¨ä¾èµ–å…³ç³»ã€‚ä»»åŠ¡åˆ†è§£çš„ç›®æ ‡æ˜¯ç¡®ä¿æ¯ä¸ªä»»åŠ¡çš„è®¡ç®—é‡å¤§è‡´ç›¸ç­‰ï¼Œä»¥å®ç°è´Ÿè½½å‡è¡¡ã€‚
>
>     - ç¤ºä¾‹ï¼šçŸ©é˜µä¹˜æ³•
>
>         å‡è®¾ä½ éœ€è¦è®¡ç®—ä¸¤ä¸ªçŸ©é˜µçš„ä¹˜ç§¯ \( C = A \times B \)ã€‚å¯ä»¥å°†çŸ©é˜µ \( A \) å’Œ \( B \) åˆ†è§£ä¸ºå¤šä¸ªå­çŸ©é˜µï¼Œæ¯ä¸ªå­çŸ©é˜µçš„ä¹˜ç§¯å¯ä»¥å¹¶è¡Œè®¡ç®—ã€‚
>
>         ```c
>         void matrix_multiply_parallel(float *A, float *B, float *C, int N) {
>             #pragma omp parallel for
>             for (int i = 0; i < N; i++) {
>                 for (int j = 0; j < N; j++) {
>                     C[i * N + j] = 0;
>                     for (int k = 0; k < N; k++) {
>                         C[i * N + j] += A[i * N + k] * B[k * N + j];
>                     }
>                 }
>             }
>         }
>         ```
>
> 2. ä½¿ç”¨å¹¶è¡Œç¼–ç¨‹æ¨¡å‹
>
>     é€‰æ‹©åˆé€‚çš„å¹¶è¡Œç¼–ç¨‹æ¨¡å‹å¯ä»¥å¤§å¤§ç®€åŒ–å¹¶è¡ŒåŒ–çš„å¤æ‚æ€§ã€‚å¸¸è§çš„å¹¶è¡Œç¼–ç¨‹æ¨¡å‹åŒ…æ‹¬ï¼š
>
>     - **OpenMP**ï¼šç”¨äºå¤šçº¿ç¨‹å¹¶è¡Œç¼–ç¨‹ï¼Œæ”¯æŒ Cã€C++ å’Œ Fortranã€‚
>
>     - **MPI**ï¼šç”¨äºåˆ†å¸ƒå¼å†…å­˜å¹¶è¡Œç¼–ç¨‹ï¼Œé€‚ç”¨äºé«˜æ€§èƒ½è®¡ç®—é›†ç¾¤ã€‚
>
>     - **CUDA**ï¼šç”¨äº NVIDIA GPU çš„å¹¶è¡Œç¼–ç¨‹ï¼Œé€‚ç”¨äºé«˜æ€§èƒ½è®¡ç®—å’Œæœºå™¨å­¦ä¹ ã€‚
>
>     - **Intel TBB**ï¼šç”¨äºå¤šæ ¸ CPU çš„å¹¶è¡Œç¼–ç¨‹ï¼Œæä¾›é«˜çº§å¹¶è¡Œç®—æ³•å’Œæ•°æ®ç»“æ„ã€‚
>
>     - ç¤ºä¾‹ï¼šOpenMP
>
>         ä½¿ç”¨ OpenMP å¯ä»¥è½»æ¾åœ°å°†å¾ªç¯å¹¶è¡ŒåŒ–ï¼š
>
>         ```c
>         #include <omp.h>
>         
>         void compute() {
>             #pragma omp parallel for
>             for (int i = 0; i < N; i++) {
>                 // è®¡ç®—ä»»åŠ¡
>             }
>         }
>         ```
>
>
> 3. è´Ÿè½½å‡è¡¡
>
>     ç¡®ä¿æ¯ä¸ªå¤„ç†å™¨çš„è´Ÿè½½å¤§è‡´ç›¸ç­‰ï¼Œä»¥é¿å…æŸäº›å¤„ç†å™¨è¿‡è½½è€Œå…¶ä»–å¤„ç†å™¨é—²ç½®ã€‚è´Ÿè½½å‡è¡¡å¯ä»¥é€šè¿‡é™æ€æˆ–åŠ¨æ€è°ƒåº¦å®ç°ã€‚
>
>     - **é™æ€è°ƒåº¦**ï¼šåœ¨ä»»åŠ¡å¼€å§‹å‰ï¼Œå°†ä»»åŠ¡å‡åŒ€åˆ†é…ç»™æ¯ä¸ªå¤„ç†å™¨ã€‚
>     - **åŠ¨æ€è°ƒåº¦**ï¼šåœ¨è¿è¡Œæ—¶æ ¹æ®å¤„ç†å™¨çš„è´Ÿè½½æƒ…å†µåŠ¨æ€åˆ†é…ä»»åŠ¡ã€‚
>
>     - ç¤ºä¾‹ï¼šåŠ¨æ€è°ƒåº¦
>
>         ä½¿ç”¨ OpenMP çš„åŠ¨æ€è°ƒåº¦ï¼š
>
>         ```c
>         #include <omp.h>
>         
>         void compute() {
>             #pragma omp parallel for schedule(dynamic)
>             for (int i = 0; i < N; i++) {
>                 // è®¡ç®—ä»»åŠ¡
>             }
>         }
>         ```
>
>
> 4. å‡å°‘é€šä¿¡å¼€é”€
>
>     åœ¨å¹¶è¡Œè®¡ç®—ä¸­ï¼Œé€šä¿¡å¼€é”€æ˜¯ä¸€ä¸ªä¸»è¦çš„æ€§èƒ½ç“¶é¢ˆã€‚å°½é‡å‡å°‘å¤„ç†å™¨ä¹‹é—´çš„é€šä¿¡ï¼Œæˆ–è€…ä½¿ç”¨é«˜æ•ˆçš„é€šä¿¡ç®—æ³•å’Œåº“ã€‚
>
>     - **å±€éƒ¨æ€§ä¼˜åŒ–**ï¼šç¡®ä¿æ¯ä¸ªå¤„ç†å™¨è®¿é—®çš„æ•°æ®å°½å¯èƒ½å±€éƒ¨åŒ–ï¼Œå‡å°‘å†…å­˜è®¿é—®å»¶è¿Ÿã€‚
>     - **æ‰¹é‡é€šä¿¡**ï¼šå°†å¤šä¸ªå°çš„é€šä¿¡æ“ä½œåˆå¹¶ä¸ºä¸€ä¸ªå¤§çš„é€šä¿¡æ“ä½œï¼Œå‡å°‘é€šä¿¡å¼€é”€ã€‚
>
>     - ç¤ºä¾‹ï¼šæ‰¹é‡é€šä¿¡
>
>         ä½¿ç”¨ MPI è¿›è¡Œæ‰¹é‡é€šä¿¡ï¼š
>
>         ```c
>         #include <mpi.h>
>         
>         void communicate() {
>             MPI_Request requests[10];
>             MPI_Status statuses[10];
>         
>             for (int i = 0; i < 10; i++) {
>                 MPI_Isend(data[i], count, MPI_INT, dest, tag, MPI_COMM_WORLD, &requests[i]);
>             }
>         
>             MPI_Waitall(10, requests, statuses);
>         }
>         ```
>
>
> 5. ä½¿ç”¨å¹¶è¡Œç®—æ³•
>
>     é€‰æ‹©é€‚åˆå¹¶è¡ŒåŒ–çš„ç®—æ³•å¯ä»¥æ˜¾è‘—æé«˜æ€§èƒ½ã€‚ä¾‹å¦‚ï¼Œåˆ†æ²»ç®—æ³•ã€å½’å¹¶æ’åºã€å¿«é€Ÿæ’åºç­‰éƒ½å¯ä»¥å¹¶è¡ŒåŒ–ã€‚
>
>     - ç¤ºä¾‹ï¼šå¹¶è¡Œå½’å¹¶æ’åº
>
>         ä½¿ç”¨ OpenMP å®ç°å¹¶è¡Œå½’å¹¶æ’åºï¼š
>
>         ```c
>         #include <omp.h>
>         
>         void merge_sort_parallel(int *array, int left, int right) {
>             if (left < right) {
>                 int mid = (left + right) / 2;
>                 #pragma omp parallel sections
>                 {
>                     #pragma omp section
>                     {
>                         merge_sort_parallel(array, left, mid);
>                     }
>                     #pragma omp section
>                     {
>                         merge_sort_parallel(array, mid + 1, right);
>                     }
>                 }
>                 merge(array, left, mid, right);
>             }
>         }
>         ```
>
>
> 6. åˆ©ç”¨ç¡¬ä»¶ç‰¹æ€§
>
>     å……åˆ†åˆ©ç”¨å¤šå¤„ç†å™¨ç¡¬ä»¶çš„ç‰¹æ€§ï¼Œå¦‚å¤šæ ¸ CPUã€GPUã€FPGA ç­‰ï¼Œå¯ä»¥è¿›ä¸€æ­¥æé«˜å¹¶è¡Œè®¡ç®—çš„æ•ˆç‡ã€‚
>
>     - **å¤šæ ¸ CPU**ï¼šä½¿ç”¨ OpenMP æˆ– Intel TBB è¿›è¡Œå¤šçº¿ç¨‹å¹¶è¡Œç¼–ç¨‹ã€‚
>     - **GPU**ï¼šä½¿ç”¨ CUDA æˆ– OpenCL è¿›è¡Œå¹¶è¡Œè®¡ç®—ã€‚
>     - **FPGA**ï¼šä½¿ç”¨ç¡¬ä»¶æè¿°è¯­è¨€ï¼ˆHDLï¼‰è¿›è¡Œå®šåˆ¶åŒ–å¹¶è¡Œè®¡ç®—ã€‚
>
>     - ç¤ºä¾‹ï¼šCUDA
>
>         ä½¿ç”¨ CUDA è¿›è¡Œå¹¶è¡Œè®¡ç®—ï¼š
>
>          ```c
>         __global__ void vector_add(int *a, int *b, int *c, int n) {
>             int index = threadIdx.x + blockIdx.x * blockDim.x;
>             if (index < n) {
>                 c[index] = a[index] + b[index];
>             }
>         }
>         int main() {
>             int n = 1024;
>             int *a, *b, *c;
>             int *d_a, *d_b, *d_c;
>             
>             // åˆ†é…ä¸»æœºå†…å­˜
>             a = (int *)malloc(n * sizeof(int));
>             b = (int *)malloc(n * sizeof(int));
>             c = (int *)malloc(n * sizeof(int));
>             
>             // åˆ†é…è®¾å¤‡å†…å­˜
>             cudaMalloc((void **)&d_a, n * sizeof(int));
>             cudaMalloc((void **)&d_b, n * sizeof(int));
>             cudaMalloc((void **)&d_c, n * sizeof(int));
>             
>             // åˆå§‹åŒ–æ•°æ®
>             for (int i = 0; i < n; i++) {
>                 a[i] = i;
>                 b[i] = i;
>             }
>             
>             // ä»ä¸»æœºå¤åˆ¶æ•°æ®åˆ°è®¾å¤‡
>             cudaMemcpy(d_a, a, n * sizeof(int), cudaMemcpyHostToDevice);
>             cudaMemcpy(d_b, b, n * sizeof(int), cudaMemcpyHostToDevice);
>         
>             // å¯åŠ¨å†…æ ¸
>             int threadsPerBlock = 256;
>             int blocksPerGrid = (n + threadsPerBlock - 1) / threadsPerBlock;
>             vector_add<<<blocksPerGrid, threadsPerBlock>>>(d_a, d_b, d_c, n);
>             
>             // ä»è®¾å¤‡å¤åˆ¶æ•°æ®åˆ°ä¸»æœº
>             cudaMemcpy(c, d_c, n * sizeof(int), cudaMemcpyDeviceToHost);
>             
>             // é‡Šæ”¾è®¾å¤‡å†…å­˜
>             cudaFree(d_a);
>             cudaFree(d_b);
>             cudaFree(d_c);
>             
>             // é‡Šæ”¾ä¸»æœºå†…å­˜
>             free(a);
>             free(b);
>             free(c);
>             return 0;
>         }
>          ```





#### ä¹ é¢˜/é¢è¯•é¢˜

å¯¹äºè¿™ç§ä¸Šé¢çš„æ–¹æ³•ä¸å¥½è§£å†³çš„æ–¹æ³•ï¼Œå»æƒ³åŒæ­¥æ¡ä»¶æ˜¯ä»€ä¹ˆã€‚

<img src="pic/image-20250114204356246.png" alt="image-20250114204356246" style="zoom: 67%;" />

> **å¥‡æ€ªçš„åŒæ­¥é—®é¢˜**ï¼šæˆ‘ä»¬å¯ä»¥æ„é€ å‡º â€œå¥‡æ€ªâ€ çš„åŒæ­¥æ¡ä»¶ï¼Œä¾‹å¦‚æœ‰ä¸‰ç§çº¿ç¨‹ï¼Œåˆ†åˆ«æ­»å¾ªç¯æ‰“å° `<`ã€`>`ã€`_`ã€‚å¦‚ä½•åŒæ­¥è¿™äº›çº¿ç¨‹ï¼Œä½¿å¾—å±å¹•ä¸Šçœ‹åˆ°çš„æ€»æ˜¯ `<><_` å’Œ `><>_` çš„ç»„åˆï¼Ÿè€Œåªè¦æˆ‘ä»¬èƒ½åˆ—å‡ºåŒæ­¥æ¡ä»¶ï¼Œå°±å¯ä»¥ç›´æ¥ä½¿ç”¨æ¡ä»¶å˜é‡è§£å†³ã€‚

è§‚å¯Ÿï¼Œçœ‹çœ‹å„ä¸ªå­—ç¬¦å‡ºç°çš„ä½ç½®ï¼Œéƒ½çŸ¥é“è¦æƒ³ç€æ‰¾åŒæ­¥æ¡ä»¶æ˜¯ä»€ä¹ˆï¼šæ¯ç§å­—ç¬¦å‡ºç°çš„ä½ç½®çš„è¦æ±‚ã€‚

ä»€ä¹ˆæ—¶å€™èƒ½æ‰“å° `<`ï¼Ÿåœ¨å¼€å¤´/ `_`ã€`>` åé¢ã€‚

ä»€ä¹ˆæ—¶å€™èƒ½æ‰“å° `>`ï¼Ÿåœ¨å¼€å¤´/ `_`ã€`<` åé¢ã€‚

ä»€ä¹ˆæ—¶å€™èƒ½æ‰“å° `_`ï¼Ÿå‡ºç°åœ¨æœ€åä¸€ä¸ªå­—ç¬¦ã€‚

è€å¸ˆç»™å‡ºçš„è¿›ä¸€æ­¥æ€»ç»“ï¼šéœ€è¦çŸ¥é“ä¸€ä¸ªæ‰“å°çš„ historyã€‚

ç”±å½“å‰çš„çŠ¶æ€ï¼ˆå†å²ï¼‰æ¥çœ‹æœªæ¥ä»€ä¹ˆå¯ä»¥åšä»€ä¹ˆä¸å¯ä»¥åšï¼ŸçŠ¶æ€æœºï¼





### Summary

å†æ¬¡å›é¡¾ï¼Œä»€ä¹ˆå«åŒæ­¥ï¼Ÿè®°ä½é‚£ä¸ªæ¼”å¥éŸ³ä¹çš„ä¾‹å­ã€‚ç®€å•ç†è§£å°±æ˜¯å¤§å®¶å›åˆ°åŒä¸€èµ·è·‘çº¿ï¼Œä¸€èµ·ç­‰æ‹ã€‚

æ¯ä¸€ä¸ªäººéƒ½æœ‰è‡ªå·±ç»§ç»­çš„æ¡ä»¶ã€‚





## å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥ï¼ˆ2ï¼‰

### ä¿¡å·é‡

#### ä½¿ç”¨äº’æ–¥é”å®ç°åŒæ­¥



#### **ä½¿ç”¨äº’æ–¥é”å®ç°è®¡ç®—å›¾**







### ä½¿ç”¨ä¿¡å·é‡å®ç°åŒæ­¥





### ä¿¡å·é‡ã€æ¡ä»¶å˜é‡ã€åŒæ­¥









## çœŸå®ä¸–ç•Œçš„å¹¶å‘ç¼–ç¨‹







## å¹¶å‘bugs



## åº”å¯¹å¹¶å‘bugs







