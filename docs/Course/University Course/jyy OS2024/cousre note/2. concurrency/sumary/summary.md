## Summary and Expand

åœ¨å¬å®Œå¹¶å‘éƒ¨åˆ†ä¹‹åå†å›è¿‡å¤´æ¥åšä¸€äº›æ€»ç»“ã€‚

è¿‡å»äººä»¬åœ¨è½¯ä»¶ä¸Šå®ç°äº’æ–¥åšäº†å¾ˆå¤šåŠªåŠ›ï¼ˆPeterson ç®—æ³•ï¼‰ï¼Œä½†ç”±äºç¡¬ä»¶å­˜åœ¨å¤©ç„¶çš„å¹¶å‘æ€§ï¼Œä»¥åŠå„ç§ç¡¬ä»¶å› ç´ ï¼ˆæµæ°´çº¿ã€å¤šå‘ç”Ÿã€ä¸­æ–­...ï¼‰å¯¼è‡´å®ç°åŸå­æ€§çš„å›°éš¾ï¼Œæœ€ç»ˆè¿˜æ˜¯å›åˆ°ç¡¬ä»¶ä¸Šè§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒåŒæ—¶ä¹Ÿå¼•å‡ºäº†å„ç§è½¯ä»¶ä¸Šçš„æŒºå¤šè®©äººå›°æƒ‘çš„å®ç°ã€‚

### äº’æ–¥ï¼šatomic ä¹‹ä¸‹

ä»åŸå­æ“ä½œçš„å‡è®¾å¼€å§‹æ€»ç»“ï¼š

- åŒ…å«ä¸€ä¸ªåŸå­æŒ‡ä»¤

    - æŒ‡ä»¤çš„æ‰§è¡Œä¸èƒ½è¢«æ‰“æ–­

- åŒ…å«ä¸€ä¸ª compiler barrier

    - æ— è®ºä½•ç§ä¼˜åŒ–éƒ½ä¸å¯è¶Šè¿‡æ­¤å‡½æ•°

    > è¿™ä¸€ç‚¹å¾ˆé‡è¦â€”â€”ä¾‹å¦‚æˆ‘ä»¬ä»Šå¤©çš„ç¼–è¯‘å™¨æ”¯æŒ Link-time Optimization (LTO)ï¼Œå¦‚æœç¼ºå°‘ compiler barrierï¼Œç¼–è¯‘ä¼˜åŒ–å¯ä»¥ç©¿è¿‡ volatile æ ‡è®°çš„æ±‡ç¼–æŒ‡ä»¤ã€‚

- åŒ…å«ä¸€ä¸ª memory fence

    ä¿è¯æ“ä½œæ‰§è¡Œå‰æŒ‡ä»¤çš„å†™å…¥ï¼Œèƒ½å¯¹å…¶ä»–å¤„ç†å™¨ä¹‹åçš„ load å¯è§ï¼›

    - ä¿è¯å¤„ç†å™¨åœ¨ stop-the-world å‰æ‰€æœ‰å¯¹å†…å­˜çš„ store éƒ½ â€œç”Ÿæ•ˆâ€
    - å³å¯¹ resume-the-world ä¹‹åçš„ load å¯è§

> ```C
> int xchg(int volatile *ptr, int newval) {
>   int result;
>   asm volatile(
>     // æŒ‡ä»¤è‡ªå¸¦ memory barrier
>     "lock xchgl %0, %1"
>     : "+m"(*ptr), "=a"(result)
>     : "1"(newval)
>     // Compiler barrier
>     : "memory"
>   );
>   return result;
> }
> ```



é€šè¿‡çœ‹è¿™ä¸‰ä¸ªç‚¹ï¼Œä¸€ä¸‹å°±çŸ¥é“äº†åŸå­æ“ä½œã€compiler barrierã€memory barrier æ˜¯å®ç°ç°ä»£å¤šå¤„ç†å™¨ç³»ç»Ÿä¸Šçš„äº’æ–¥çš„é‡ç‚¹ï¼Œä½†å¯¹äºæƒ³æ¢ç©¶åˆ°åº•çš„äººæ¥è¯´å°±æ„Ÿè§‰å¿ƒä¸­å µå¡ï¼ˆå°±è¿™ä¹ˆå¡äº†ä¸‰ä¸ªæ¦‚å¿µï¼Ÿï¼‰ï¼Œç”±æ­¤å†ç®€å•äº†è§£ä¸€ç‚¹ç¡¬ä»¶å› ç´ ï¼Œå°±èƒ½çŸ¥é“å…¶ä¸­çš„ç¼˜ç”±ã€‚

- **åŸå­æ“ä½œ**

    æˆ‘è‡ªå·±ç†è§£ä¸ºåŸå­æ“ä½œæ˜¯ä¸èƒ½è¢«å„ç§å„æ ·çš„äº‹ä»¶æ‰€åˆ†å‰²ã€‚

    ä¹‹å‰è®¤ä¸ºçš„è§‚ç‚¹ï¼šä¸€æ¡æ±‡ç¼–æŒ‡ä»¤æ˜¯åŸå­çš„ï¼Œæ˜¯ä¸å¯åˆ†å‰²çš„æœ€å°æ‰§è¡Œå•ä½ã€‚

    ä½†æ˜¯ç²—ç•¥å­¦ä¹ è¿‡è®¡ç®—æœºç»„æˆåŸç†ï¼ˆå¹¶ä¸æ·±å…¥ï¼‰å’Œ PA å’Œä¸Šå®Œå¹¶å‘ä¹‹åï¼Œäº†è§£åˆ°æµæ°´çº¿ã€å¾®æ“ä½œã€è¶…æ ‡é‡ã€ç¼“å­˜ç­‰ç­‰æ¦‚å¿µã€‚å‘ç°ä» CPU çš„è§†è§’æ¥è¯´æœºå™¨æŒ‡ä»¤è¿˜çœŸä¸æ˜¯æœ€å°çš„æ‰§è¡Œå•ä½ã€‚å…·ä½“ä» CPU çš„å¾®æ¶æ„å†å²å­¦èµ·ï¼ˆ**å¯èƒ½å¾ˆå¤šå†…å®¹æ˜¯æ— å…³çš„ï¼Œåªæ˜¯ç”¨äºè‡ªå·±ç†æ¸…é€»è¾‘çš„**ï¼‰ï¼ŒåŒæ—¶å€ŸåŠ© AI æ€»ç»“ï¼š

    1. **æ—©æœŸé˜¶æ®µï¼ˆ1960s-1980sï¼‰ï¼šä½æ•ˆä½†ç®€å•æ­£ç¡®**

        - **æŠ€æœ¯ç‰¹ç‚¹**ï¼š

            - **å•å‘¨æœŸæ‰§è¡Œ**ï¼šæŒ‡ä»¤åœ¨ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå†…å®Œæˆï¼ˆæ— æµæ°´çº¿ï¼‰ã€‚

            - **æµæ°´çº¿**ï¼šå•æ¡æŒ‡ä»¤çš„æ‰§è¡Œæ‹†åˆ†ä¸ºå¤šä¸ªé˜¶æ®µï¼ˆå¦‚å–æŒ‡ã€è¯‘ç ã€æ‰§è¡Œã€è®¿å­˜ã€å†™å›ï¼‰ï¼Œæ¯ä¸ªé˜¶æ®µç”±ç‹¬ç«‹ç¡¬ä»¶å•å…ƒå¤„ç†ï¼Œæå‡ååé‡ã€‚

                å¸¦æ¥**å¹¶è¡Œæ€§**ï¼šä¸åŒæŒ‡ä»¤çš„ä¸åŒé˜¶æ®µå¯åŒæ—¶æ‰§è¡Œï¼ˆå¦‚æŒ‡ä»¤Aåœ¨æ‰§è¡Œé˜¶æ®µæ—¶ï¼ŒæŒ‡ä»¤Båœ¨è¯‘ç é˜¶æ®µï¼‰ã€‚

            - **å¾®æ“ä½œï¼ˆMicro-Opsï¼‰åˆ†è§£**

                å¤æ‚æŒ‡ä»¤ï¼ˆå¦‚ x86 æ¶æ„çš„ `ADD [MEM], REG`ï¼‰åœ¨ CPU å†…éƒ¨ä¼šè¢«è§£ç ä¸ºå¤šä¸ª**å¾®æ“ä½œ**ï¼ˆÎ¼Opsï¼‰ï¼Œæ¯ä¸ªå¾®æ“ä½œå¯¹åº”ä¸€ä¸ªç®€å•çš„ç¡¬ä»¶æ“ä½œï¼ˆå¦‚å†…å­˜è¯»å–ã€ALU è®¡ç®—ã€ç»“æœå†™å›ï¼‰ã€‚

                - **CISC ä¸ RISC å¯¹æ¯”**ï¼š
                    - **CISC**ï¼ˆå¦‚ x86ï¼‰æŒ‡ä»¤å¤æ‚ï¼Œé€šå¸¸éœ€è¦æ‹†è§£ä¸ºå¤šä¸ª Î¼Opsã€‚
                    - **RISC**ï¼ˆå¦‚ ARMï¼‰æŒ‡ä»¤ç®€å•ï¼Œå¯èƒ½ 1:1 å¯¹åº” Î¼Opsï¼Œä½†ä»éœ€æµæ°´çº¿å¤„ç†ã€‚
                - **åŸå­æ€§ç¼ºå¤±**ï¼šå•æ¡æœºå™¨æŒ‡ä»¤è¢«è½¬åŒ–ä¸ºå¤šä¸ª Î¼Opsï¼Œæ¯ä¸ª Î¼Ops æ‰æ˜¯ CPU è°ƒåº¦çš„æœ€å°æ‰§è¡Œå•ä½ã€‚

        - **åŸå­æ€§**

            - **å¯¹å¤–åŸå­æ€§**ï¼šæµæ°´çº¿è®¾è®¡ï¼š**å¯¹å¤–éšè—å†…éƒ¨é˜¶æ®µåˆ†å‰²**ï¼Œä½¿æŒ‡ä»¤çš„æœ€ç»ˆç»“æœè¡¨ç°ä¸ºåŸå­æ€§ï¼ˆå³ç¨‹åºå‘˜è§†è§’çš„â€œä¸å¯åˆ†å‰²â€ï¼‰ã€‚

                ä½†**å†…éƒ¨å…³é”®**ï¼š**æäº¤é˜¶æ®µï¼ˆRetirementï¼‰**

                - **ç»“æœæäº¤**ï¼š
                    æŒ‡ä»¤çš„å†™å›æ“ä½œï¼ˆæ›´æ–°å¯„å­˜å™¨æˆ–å†…å­˜ï¼‰ä»…åœ¨æµæ°´çº¿çš„æœ€ç»ˆé˜¶æ®µï¼ˆæäº¤é˜¶æ®µï¼‰ç”Ÿæ•ˆã€‚
                - **åŸå­æ€§å‡è±¡**ï¼š
                    å³ä½¿æŒ‡ä»¤åœ¨æµæ°´çº¿ä¸­è¢«åˆ†è§£ä¸ºå¤šä¸ªé˜¶æ®µï¼Œç¡¬ä»¶ç¡®ä¿æ‰€æœ‰å‰¯ä½œç”¨ï¼ˆå¦‚å¯„å­˜å™¨ä¿®æ”¹ã€å†…å­˜å†™å…¥ï¼‰ä¸€æ¬¡æ€§å¯¹å¤–å¯è§ï¼Œä»è€Œç»´æŒåŸå­æ€§ã€‚

            - **ä¿è¯åŸå­æ€§**

                é‚£ä¸ªæ—¶ä»£å®ç°åŸå­æ€§æ¯”è¾ƒç®€å•ï¼Œå› ä¸ºä¸»è¦çš„åŸå­æ€§å¨èƒæ¥è‡ª**ä¸­æ–­**ã€‚ç”±æ­¤è½¯ä»¶ä¸Š**å…³ä¸­æ–­**ï¼Œå°±èƒ½ç¡®ä¿æŒ‡ä»¤æ‰§è¡Œçš„é¡ºåºã€‚ä½†è¿™å¹¶ä¸èƒ½ä¿è¯ç¡¬ä»¶çš„å¹¶è¡Œå½±å“ sequenceå‘€ï¼Ÿintelæ˜¯è¿™ä¹ˆåšçš„ï¼š

                - **æ€»çº¿é”**ï¼šé€šè¿‡ç¡¬ä»¶ä¿¡å·ï¼ˆå¦‚ `LOCK#`ï¼‰ç›´æ¥é”ä½å†…å­˜æ€»çº¿ï¼Œé˜»æ­¢å…¶ä»–è®¾å¤‡å¹²æ‰°ã€‚ï¼‰

                    `LOCK XCHG [x], AX ; åŸå­äº¤æ¢`

                å¹´ä»£æœ‰ç‚¹ä¹…è¿œï¼Œä¸å¤ªèƒ½å¤Ÿæ‰¾åˆ°æå‡ºè¿™ä¸ªè®¾è®¡çš„åŸç”±äº†ï¼Œä½†åˆæ¬¡çœ‹åˆ°è¿™ä¸ªæ¦‚å¿µæƒ³ç€æ˜¯ä¸ºäº†**é¿å…é¢‘ç¹å¼€å…³ä¸­æ–­çš„æ€§èƒ½å¼€é”€**å§ï¼Ÿåæ¥ï¼Œçœ‹åˆ°intel 1982å¹´æ¨å‡ºçš„ intel 8237 DMA è®¾å¤‡ï¼Œçªç„¶å°±æ˜ç™½ï¼šåœ¨å•æ ¸å¤„ç†å™¨ç³»ç»Ÿä¸­ï¼Œé™¤äº†CPUï¼Œè¿˜æœ‰å…¶ä»–æ€»çº¿ä¸»è®¾å¤‡ï¼ˆå¦‚DMAæ§åˆ¶å™¨ã€I/Oæ§åˆ¶å™¨ï¼‰ä¹Ÿä¼š**è®¿é—®å†…å­˜**ã€‚å¦‚æœæ²¡æœ‰æ€»çº¿é”ï¼ŒCPUå’ŒDMAæ§åˆ¶å™¨å¯èƒ½ä¼šåŒæ—¶è®¿é—®å…±äº«èµ„æºï¼Œå¯¼è‡´æ•°æ®ç«äº‰ï¼

                ç”±æ­¤åœ¨ç¡¬ä»¶ä¸Šå®ç°åŸå­æ€§ï¼šæ€»çº¿é”å¯ä»¥ç¡®ä¿åœ¨CPUæ‰§è¡Œå…³é”®æ“ä½œæ—¶ï¼Œå…¶ä»–æ€»çº¿ä¸»è®¾å¤‡æ— æ³•è®¿é—®å…±äº«èµ„æºã€‚

            - **æ¾„æ¸…**

                ä»è®¡ç®—æœºä½“ç³»ç»“æ„çš„è§’åº¦æ¥çœ‹ï¼Œæµæ°´çº¿æŠ€æœ¯æœ¬èº«å¹¶ä¸ä¼šç›´æ¥ç ´åæŒ‡ä»¤çš„åŸå­æ€§ï¼Œä½†éœ€è¦ç¡¬ä»¶è®¾è®¡å±‚é¢çš„ç‰¹æ®Šæœºåˆ¶æ¥ç»´æŠ¤åŸå­æ€§ã€‚

                - **å†’é™©ï¼ˆHazardï¼‰çš„å½±å“**ï¼š
                    æ•°æ®å†’é™©ã€æ§åˆ¶å†’é™©ä¼šå¯¼è‡´æµæ°´çº¿åœé¡¿æˆ–æ¸…ç©ºï¼Œä½†è¿™æ˜¯ä¸ºäº†ç»´æŠ¤**æ‰§è¡Œæ­£ç¡®æ€§**ï¼Œè€ŒéåŸå­æ€§ã€‚
                - **åŸå­æ€§ä¿éšœ**ï¼š
                    å³ä½¿æµæ°´çº¿ä¸­å­˜åœ¨å†’é™©ï¼Œç¡¬ä»¶é€šè¿‡æäº¤é˜¶æ®µçš„åŸå­æäº¤æœºåˆ¶ï¼Œç¡®ä¿æŒ‡ä»¤ç»“æœå¯¹å¤–è¡¨ç°ä¸ºåŸå­ã€‚

    2. **æ€§èƒ½ä¼˜åŒ–é˜¶æ®µï¼ˆ1980s-2000sï¼‰ï¼šå¹¶è¡Œã€åŠ é€ŸæŠ€æœ¯**

        - **æŠ€æœ¯é©æ–°**ï¼š
            - **å¤šæ ¸å¤„ç†å™¨**ï¼šå¤©ç„¶å¹¶è¡Œæ€§
            - **è¶…æ ‡é‡**ï¼ˆ1990sï¼‰ï¼šæ¯ä¸ªå‘¨æœŸå‘å°„å¤šæ¡æŒ‡ä»¤ï¼ˆå¦‚ Intel Pentium åŒå‘å°„ï¼‰ã€‚
            - **Cache**ï¼šæ—¶é—´å±€éƒ¨æ€§åŸç†ï¼ŒåŠ é€Ÿã€‚
            - **ä¹±åºæ‰§è¡Œ**ï¼ˆ1990sï¼‰ï¼šåŠ¨æ€è°ƒåº¦æŒ‡ä»¤æ‰§è¡Œé¡ºåºï¼Œæ©ç›–å»¶è¿Ÿã€‚
        - **åŸå­æ€§ç ´å**ï¼š
            - **å¤šå‘å°„**ï¼šå¤šå‘å°„ä½¿å¾—å¤šæ ¸å¿ƒåŒæ—¶æ‰§è¡Œå¤šæ¡æŒ‡ä»¤ï¼Œå¯¼è‡´å¯¹å…±äº«èµ„æºçš„å¹¶å‘è®¿é—®ã€‚å¦‚æœè¿™äº›æŒ‡ä»¤æ¶‰åŠå¯¹åŒä¸€å†…å­˜ä½ç½®çš„è¯»å†™æ“ä½œï¼Œå°±ä¼šç ´ååŸå­æ€§ã€‚
            - **ä¹±åºæ‰§è¡Œ**ï¼šä¹±åºæ‰§è¡Œå…è®¸CPUæ ¹æ®èµ„æºå¯ç”¨æ€§å’Œä¾èµ–å…³ç³»é‡æ–°æ’åˆ—æŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºã€‚è™½ç„¶ä¹±åºæ‰§è¡Œæœ¬èº«ä¸ä¼šç ´åå•ä¸ªçº¿ç¨‹å†…çš„æŒ‡ä»¤é¡ºåºï¼Œä½†åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œå¯èƒ½ä¼šå¯¼è‡´æŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºä¸ç¨‹åºé€»è¾‘ä¸ä¸€è‡´ã€‚
            - **Cache**ï¼šè™½è¯´é€šè¿‡å¤šæ ¸ã€ç¼“å­˜åŠ å¿«äº†æ•°æ®è®¿é—®é€Ÿåº¦ï¼Œä½†åŒæ—¶æé«˜äº†ç³»ç»Ÿçš„å¤æ‚æ€§ï¼ŒåŒæ­¥å„æ ¸å¿ƒï¼Œç¼“å­˜å’Œå†…å­˜ä¸­çš„æ•°æ®ä¹Ÿæˆäº†ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœåŒæ–¹çš„æ•°æ®éƒ½ä¸ä¸€è‡´ï¼Œé‚£ä¿è¯åŸå­æ€§ä¹Ÿæ˜¯æ²¡æ„ä¹‰çš„ã€‚

        ä½†æ€»çš„æ¥è¯´ï¼Œæ€»çº¿é”åœ¨ç®€å•ç¯å¢ƒä¸‹ä¾ç„¶å¥æ•ˆï¼Œä½†æ˜¯ç²—ç²’åº¦ï¼Œæ€§èƒ½å·®ï¼Œæœ‰æ²¡æœ‰æ›´å¥½çš„ï¼Ÿï¼ˆæœ‰çš„æœ‰çš„ğŸ¤£ğŸ¤£ğŸ¤£ï¼‰

        ç°åœ¨çš„ç›®çš„å°±æ˜¯ä¸ºäº†åŒæ­¥å„æ ¸å¿ƒçš„å„ç¼“å­˜ä¸­çš„æ•°æ®ï¼Œè€Œå®é™…ä¸Šè¿™éƒ¨åˆ†å°±æ˜¯å¸¸å¸¸å¬åˆ° ç¼“å­˜ä¸€è‡´æ€§ï¼ˆCache Coherenceï¼‰ã€‚

        > ç”±äºæˆæœ¬å’Œæ€§èƒ½ï¼ˆç©ºé—´å’Œæ—¶é—´ï¼‰çš„trade-offï¼Œç°ä»£çš„å¤šå¤„ç†å™¨ç³»ç»Ÿä½¿ç”¨å¤šçº§
        > é«˜é€Ÿç¼“å­˜ï¼ˆMultilevel Cacheï¼‰æ¥ç¼“å­˜é«˜é¢‘è®¿é—®çš„æ•°æ®ï¼Œå„ä¸ªæ ¸å¿ƒæœ‰è‡ªå·±çš„å¤šçº§ç¼“å­˜ï¼š
        >
        > ![img](pic/0723f72f3016fede96b545e2898c0541.jpeg)
        >
        > ç”±äºä¸åŒæ ¸å¿ƒå‡æ‹¥æœ‰ç§æœ‰çš„é«˜é€Ÿç¼“å­˜ï¼ˆå¦‚ä¸€çº§ç¼“å­˜ï¼‰ï¼ŒæŸä¸€åœ°å€ä¸Šçš„æ•°æ®å¯èƒ½åŒæ—¶å­˜åœ¨äºå¤šä¸ªæ ¸å¿ƒçš„ä¸€çº§ç¼“å­˜ä¸­ã€‚    
        >
        > å½“è¿™äº›æ ¸å¿ƒåŒæ—¶ä½¿ç”¨å†™å›ç­–ç•¥ä¿®æ”¹è¯¥åœ°å€çš„æ•°æ®æ—¶ï¼Œä¼šå¯¼è‡´ä¸åŒæ ¸å¿ƒä¸Šä¸€çº§ç¼“å­˜ä¸­è¯¥åœ°å€æ•°æ®ä¸ä¸€è‡´ï¼Œè¿åäº†å…±äº«å†…å­˜çš„æŠ½è±¡ã€‚
        >
        > ä¸ºäº†ä¿è¯ç§æœ‰ç¼“å­˜ä¹‹é—´ä¹Ÿèƒ½å°±æŸä¸€åœ°å€çš„å€¼è¾¾æˆå…±è¯†ï¼Œå¤šæ ¸ç¡¬ä»¶æä¾›äº†**ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼ˆCache Coherence Protocolï¼‰**  

        å…¶ä¸­æ¯”è¾ƒå‡ºåçš„å°±æ˜¯ MESIï¼ˆModified/Exclusive/Shared/Invalid çŠ¶æ€ï¼‰åŒæ­¥ç¼“å­˜è¡Œï¼Œå…·ä½“å†…å®¹ä¸å±•å¼€ï¼Œç®€å•æ¦‚è¿°åé¢å†è¯´ã€‚

----

ä½†å…ˆåœåœï¼Œå®é™…ä¸Šåˆ°è¿™é‡Œï¼Œæˆ‘è‡ªå·±åˆè¿›ä¸€æ­¥å¯¹åŸå­æŒ‡ä»¤åˆ†æˆäº†ä¸¤ç§ï¼Œå€ŸåŠ© AI æ€»ç»“ï¼š

1. **æŒ‡ä»¤æ‰§è¡Œçš„åŸå­æ€§**

    - **å®šä¹‰**ï¼šä¸€æ¡æŒ‡ä»¤åœ¨ CPU å†…éƒ¨æ˜¯å¦ä¸å¯åˆ†å‰²ï¼ˆå³æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸ä¼šè¢«ä¸­æ–­æˆ–ä¸å…¶ä»–æŒ‡ä»¤äº¤ç»‡ï¼‰ã€‚

        **ç¤ºä¾‹**ï¼šx86 çš„ `ADD REG, [MEM]` å¯èƒ½è¢«æ‹†è§£ä¸º `LOADâ†’ALUâ†’STORE`ï¼Œä½†ç¡¬ä»¶ä¿è¯å…¶å¯¹å¤–è¡¨ç°ä¸ºåŸå­ï¼ˆé”æ€»çº¿ï¼‰ã€‚

2. **ï¼ˆå…±äº«ï¼‰å†…å­˜æ“ä½œçš„åŸå­æ€§ï¼ˆé‡ç‚¹ï¼‰**

    - **å®šä¹‰**ï¼šå¯¹å†…å­˜çš„è¯»å†™æ“ä½œæ˜¯å¦å¯¹å…¶ä»–è§‚å¯Ÿè€…ï¼ˆå…¶ä»– CPU æ ¸ã€DMA è®¾å¤‡ç­‰ï¼‰è¡¨ç°ä¸ºç¬é—´å®Œæˆï¼Œä¸”ä¸­é—´çŠ¶æ€ä¸å¯è§ã€‚
    - **å…³é”®çŸ›ç›¾**ï¼š
        - **ç¼“å­˜å±‚çº§**ï¼šCPU é€šè¿‡ç¼“å­˜ï¼ˆL1/L2/L3ï¼‰è®¿é—®å†…å­˜ï¼Œä¿®æ”¹ç¼“å­˜åéœ€é€šè¿‡ä¸€è‡´æ€§åè®®ï¼ˆå¦‚ MESIï¼‰åŒæ­¥åˆ°å…¶ä»–æ ¸ã€‚
        - **æ€»çº¿å»¶è¿Ÿ**ï¼šå³ä½¿å•æ¡æŒ‡ä»¤å†…éƒ¨æ˜¯åŸå­çš„ï¼Œå…¶å†…å­˜æ“ä½œç»“æœå¯èƒ½å»¶è¿Ÿä¼ æ’­åˆ°å…¶ä»–è§‚å¯Ÿè€…ã€‚

    > ä¹‹åä¸»è¦å…³æ³¨å†…å­˜æ“ä½œçš„åŸå­æ€§ã€‚ï¼ˆåŸå› ï¼Ÿï¼‰

    å®é™…ä¸Šï¼Œå½“æˆ‘è‡ªå·±æƒ³å‡ºè¿™éƒ¨åˆ†å†…å®¹çš„æ—¶å€™ï¼Œå†è¯¢é—® DeepSeek åï¼Œå‘ç°å…¶å®å°±æ˜¯ memory consistency çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯è€å¸ˆåé¢è¯´çš„ memory barrier çš„åº•å±‚å†…å®¹ã€‚ç”±æ­¤ç»§ç»­ç»§ç»­å±•å¼€

----

- Memory barrier

    > ä¿è¯æ“ä½œæ‰§è¡Œå‰æŒ‡ä»¤çš„å†™å…¥ï¼Œèƒ½å¯¹å…¶ä»–å¤„ç†å™¨ä¹‹åçš„ load å¯è§

    åˆçœ‹è¿™å¥è¯å¯èƒ½ä¼šæ„Ÿè§‰åˆ°è¿·æƒ‘ï¼Œä½†å®ƒè¦†ç›–åˆ°äº†é‡ç‚¹ï¼Œè¿˜æ˜¯ä»ä¹‹å‰çš„ç†è§£å…¥æ‰‹ã€‚

    å…³äºå†…å­˜ï¼Œæ— éå°±æ˜¯è¯»å†™ï¼ˆå½“ç„¶ï¼Œè®¨è®ºçš„æ˜¯ä¸åŒåœ°å€ï¼Œå¦‚æœæ˜¯åŒä¸€ä¸ªåœ°å€æˆ–è€…å­˜åœ¨ä¾èµ–çš„ï¼Œå¤„ç†å™¨å†…éƒ¨ä¼šåšå¥½çš„ï¼ˆhazardï¼‰ï¼‰ã€‚

    > ä½†éœ€è¦æ³¨æ„ï¼Œè¿™æ˜¯å…±äº«å†…å­˜ï¼Œæœ‰å¤šä¸ªè®¾å¤‡å…±åŒä½¿ç”¨ï¼ˆå¤šæ ¸ã€cacheã€DMAã€å„ç§æ§åˆ¶å™¨...ï¼‰ï¼Œé‚£å°±ä¼šå¼•å‡ºä¸€ä¸ªè°å…ˆè°åçš„é¡ºåºé—®é¢˜ï¼Œå¦‚æœå¤šä¸ªè®¾å¤‡éƒ½è®¤ä¸ºæ˜¯è‡ªå·±å…ˆï¼Œé‚£è¯»å†™æ•°æ®éƒ½åªä¼šå–è‡ªå·±çš„é‚£ä¸€ä»½ã€‚ä¾‹å­ï¼Œï¼ˆåƒé€›æ¼«å±•æ’é˜Ÿé¢†ç¼–å·è´´çº¸ä¸€æ ·ï¼Œæ¥ä¸€ä¸ªäººåŠ å°±1ï¼Œå¦‚æœè§„å®šäº†å¥½é¡ºåºï¼Œæ¯ä¸ªäººé¢†åˆ°çš„è´´çº¸æ˜¯ä¸€æ ·çš„ï¼Œå¦‚æœå¤šä¸ªäººä¸€èµ·æ¥ï¼Œé‚£æœ‰äº›äººå°±ä¼šé¢†åˆ°ç›¸åŒçš„å·ç ï¼‰

    å…·ä½“æ¥è¯´å°±æ˜¯è¯»/å†™æ“ä½œçš„ç»„åˆï¼šè¯»è¯»ã€è¯»å†™ã€å†™è¯»ã€å†™å†™ã€‚å…¶å®ä¸ç®¡æ€ä¹ˆæ ·ï¼Œåªè¦ç¡¬ä»¶æˆ–è€…è½¯ä»¶æ¸…æ¥šè¿™ä¸ªé¡ºåºï¼Œæœ‰ä¸€æ–¹èƒ½åšå‡ºåˆç†çš„å†³ç­–å°±å¯ä»¥ï¼

    åŒæ—¶ï¼Œè¿˜æœ‰ä¸€ç‚¹ï¼Œå¯¹å…±äº«å†…å­˜çš„æ“ä½œè¦å¯¹å„ä¸ªè®¾å¤‡ï¼ˆå¤šæ ¸ã€DMA...ï¼‰éƒ½å¯è§ã€‚å¦‚æœä¸å¯è§ï¼Œç›¸å½“äºæœ‰æ ¸å¿ƒç¥ä¸çŸ¥é¬¼ä¸è§‰åœ°æ”¹äº†è¿™ä¸ªåœ°å€çš„æ•°æ®ï¼Œé‚£åˆ«çš„æ ¸å¿ƒä¹Ÿéƒ½æ˜¯é”™çš„ã€‚

    > åŒæ ·ä¹Ÿæ˜¯æ’é˜Ÿé¢†ç¼–å·è´´çº¸ï¼Œç¼–å·è´´çº¸å°±è¿™äº›ï¼Œæœ‰äººæ¥äº†ä½†æ˜¯ä¸é¢†ï¼Œæˆ–è€…é¢†äº†ä½†æ˜¯æ²¡å†™ç¼–å·ï¼Œè¿™ä¹Ÿæ˜¯ä¸è¡Œçš„ã€‚

    ç”¨ç°ä»£ç†è®ºæ€»ç»“çš„å°±æ˜¯ä¸¤ä¸ªé‡è¦çš„ç‚¹ï¼šæ“ä½œé¡ºåºå’Œå¯è§æ€§ã€‚

    > DeepSeekï¼š
    >
    > 1. **æ“ä½œé¡ºåºçš„ç±»å‹**
    >     - **ç¨‹åºé¡ºåºï¼ˆProgram Orderï¼‰**ï¼šä»£ç ä¸­ç¼–å†™çš„æ“ä½œé¡ºåºï¼ˆå¼€å‘è€…é¢„æœŸï¼‰ã€‚
    >     - **æ‰§è¡Œé¡ºåºï¼ˆExecution Orderï¼‰**ï¼šå®é™…ç¡¬ä»¶/ç¼–è¯‘å™¨ä¼˜åŒ–åå¯èƒ½çš„é¡ºåºï¼ˆå¯èƒ½é‡æ’ï¼‰ã€‚
    >
    > 2. **å¯è§æ€§ï¼ˆVisibilityï¼‰**
    >     - **å®šä¹‰**ï¼šä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„ä¿®æ”¹ä½•æ—¶å¯¹å…¶ä»–çº¿ç¨‹å¯è§ã€‚
    >     - **é—®é¢˜**ï¼šè‹¥çº¿ç¨‹Aå†™å…¥å˜é‡`x`ï¼Œçº¿ç¨‹Bå¯èƒ½æ— æ³•ç«‹å³çœ‹åˆ°æ–°å€¼ï¼ˆå› ç¼“å­˜æœªåŒæ­¥ã€å†™ç¼“å†²åŒºå»¶è¿Ÿç­‰ï¼‰ã€‚
    >
    > 3. **æ ¸å¿ƒçŸ›ç›¾**
    >     - **æ€§èƒ½ä¼˜åŒ–**ï¼šç¡¬ä»¶ï¼ˆå¦‚ä¹±åºæ‰§è¡Œï¼‰å’Œç¼–è¯‘å™¨ï¼ˆå¦‚æŒ‡ä»¤é‡æ’ï¼‰ä¼šè°ƒæ•´æ“ä½œé¡ºåºä»¥æé«˜æ€§èƒ½ã€‚
    >     - **æ­£ç¡®æ€§éœ€æ±‚**ï¼šå¤šçº¿ç¨‹ç¨‹åºéœ€æŒ‰å¼€å‘è€…é¢„æœŸçš„é¡ºåºå’Œå¯è§æ€§æ‰§è¡Œï¼Œå¦åˆ™é€»è¾‘å¯èƒ½é”™è¯¯ã€‚

    è¿™ä¸ªæ—¶å€™å†çœ‹å¤„ç†å™¨çš„ä¹±åºæ‰§è¡Œï¼Œä¸å°±ä¼šæœ‰ä¸Šé¢çš„é—®é¢˜äº†å—ï¼Ÿ

    å†å›å»çœ‹å„ä¸ªæ•™æèµ„æ–™è¯´åˆ°çš„ Consistency  model å°±ç›¸å¯¹å®¹æ˜“ç†è§£ç‚¹ã€‚

    > ã€Šæ“ä½œç³»ç»Ÿç³»ç»ŸåŸç†ä¸å®ç°ã€‹ç¬¬åäºŒç«  å¤šæ ¸ä¸å¤šæ ¸å¤„ç†å™¨â€”â€”é™ˆæµ·æ³¢ã€å¤è™æ–Œ

    > å½“ç„¶ï¼Œå¦‚æœå†ç»†è‡´ä¸€ç‚¹å­¦ä¹ ä¸€ä¸‹ç†è®ºï¼Œä¼šå‘ç°è¿˜æœ‰ä¸€ä¸ªè¯å« Linearizabilityï¼Œå…·ä½“å¯ Wikipediaï¼Œæ”¾æœ€åäº†ï¼Œè¿™é‡Œä¸å±•å¼€ã€‚

    > å…·ä½“è¿˜æ˜¯ä»¥å…·ä½“ä¾‹å­ï¼šx86çš„ TSO ä¸€è‡´æ€§ æ¨¡å‹æ¥ç†è§£ï¼Œæˆ‘è§‰å¾—è¿™éƒ¨åˆ†æˆ‘ä¸å¤ªèƒ½å†™å‡ºæ¥ï¼Œè‡ªå·±è¿˜æ˜¯æœ‰ä¸€äº›æ²¡æœ‰å¼„æ‡‚çš„åœ°æ–¹ï¼Œç›´æ¥çœ‹æ•™æï¼Œç•™å‘ **==æœªæ¥è¡¥å……==**ã€‚
    >
    > ![image-20250222001630722](pic/image-20250222001630722.png)

    ä»¥ x86 çš„ TSOä¸€è‡´æ€§æ¨¡å‹æ¥è¯´ï¼Œå…¶ä¿è¯å¯¹ä¸åŒåœ°å€ä¸”æ— ä¾èµ–çš„è¯»è¯»ã€è¯»å†™ã€å†™å†™æ“ä½œä¹‹é—´çš„å…¨å±€å¯è§é¡ºåºï¼Œåªæœ‰å†™è¯»çš„å…¨å±€å¯è§é¡ºåºä¸èƒ½å¾—åˆ°ä¿è¯ï¼Œé‚£å°±æ˜¯è¯´åœ¨é‡åˆ°è¿™ç§æƒ…å†µçš„æ—¶å€™ï¼ŒåŠ ä¸Š `mfence` å°±èƒ½ä¿è¯é¡ºåºçš„æ­£ç¡®ã€‚

    > ç®€å•æ€»ç»“ä¸€äº› consistency çš„å±‚çº§å…³ç³»ï¼Œæˆ‘ä¸ªäººå­¦ä¹ ç†è§£ç”¨ï¼š
    >
    > 1. **ç¼“å­˜ä¸€è‡´æ€§**æ˜¯ç¡¬ä»¶å±‚çš„æœºåˆ¶ï¼Œè§£å†³å¤šæ ¸ç¼“å­˜æ•°æ®åŒæ­¥é—®é¢˜ã€‚
    > 2. **ä¸€è‡´æ€§æ¨¡å‹**æ˜¯ç¡¬ä»¶/è½¯ä»¶æ¥å£çš„è§„åˆ™ï¼Œå®šä¹‰å†…å­˜æ“ä½œçš„å¯è§æ€§ä¸é¡ºåºæ€§ã€‚
    > 3. **ç¼–ç¨‹è¯­è¨€å†…å­˜æ¨¡å‹**æ˜¯é«˜å±‚æŠ½è±¡ï¼Œå±è”½ç¡¬ä»¶å·®å¼‚ï¼Œæä¾›è·¨å¹³å°çš„å¤šçº¿ç¨‹è¯­ä¹‰ã€‚ï¼ˆè¿™é‡Œæ²¡è®²ï¼‰
    >
    > - å±‚çº§å…³ç³»ï¼ˆLLM æ€»ç»“ï¼‰
    >     - **å†…å­˜æ¨¡å‹ï¼ˆMemory Modelsï¼‰**ï¼šä½äºä¸Šå±‚ï¼Œä¸»è¦é¢å‘ç¨‹åºå‘˜å’Œç¼–è¯‘å™¨ï¼Œå®šä¹‰äº†å¤šçº¿ç¨‹ç¨‹åºä¸­å†…å­˜æ“ä½œçš„è¯­ä¹‰å’Œè§„åˆ™ã€‚å†…å­˜æ¨¡å‹å†³å®šäº†ç¼–è¯‘å™¨å¦‚ä½•å¯¹å†…å­˜æ“ä½œè¿›è¡Œä¼˜åŒ–å’Œé‡æ’åºï¼Œä»¥ç”Ÿæˆé«˜æ•ˆçš„æœºå™¨ä»£ç ã€‚
    >     - **ä¸€è‡´æ€§æ¨¡å‹ï¼ˆConsistency Modelï¼‰**ï¼šä½äºä¸­é—´å±‚ï¼Œæ˜¯å†…å­˜æ¨¡å‹å’Œç¼“å­˜ä¸€è‡´æ€§åè®®çš„æ¡¥æ¢ã€‚å®ƒå®šä¹‰äº†ç¡¬ä»¶å±‚é¢å¦‚ä½•å®ç°å†…å­˜æ¨¡å‹çš„è§„åˆ™ï¼ŒåŒ…æ‹¬ç¼“å­˜ä¸€è‡´æ€§åè®®å¦‚ä½•ä¸å¤„ç†å™¨çš„å†…å­˜æ“ä½œååŒå·¥ä½œï¼Œä»¥ä¿è¯æ•´ä¸ªç³»ç»Ÿçš„å†…å­˜ä¸€è‡´æ€§ã€‚
    >     - **ç¼“å­˜ä¸€è‡´æ€§ï¼ˆCache Coherenceï¼‰**ï¼šä½äºä¸‹å±‚ï¼Œä¸»è¦é¢å‘ç¡¬ä»¶å®ç°ï¼Œç¡®ä¿å¤šä¸ªå¤„ç†å™¨æ ¸å¿ƒçš„ç¼“å­˜ä¸­å…±äº«æ•°æ®çš„ä¸€è‡´æ€§ã€‚ç¼“å­˜ä¸€è‡´æ€§åè®®æ˜¯å®ç°ä¸€è‡´æ€§æ¨¡å‹çš„åŸºç¡€ï¼Œé€šè¿‡å®šä¹‰ç¼“å­˜è¡Œçš„çŠ¶æ€å’ŒçŠ¶æ€è½¬æ¢è§„åˆ™ï¼Œæ¥ç»´æŠ¤ç¼“å­˜æ•°æ®çš„ä¸€è‡´æ€§ã€‚

- Complier barrier

    é‚£è¿™ä¸ª Compiler barrier åˆæ˜¯ä»€ä¹ˆï¼Ÿåˆ«å¿˜äº†ï¼Œå¤„ç†å™¨ä¼šè¿›è¡ŒæŒ‡ä»¤é‡æ’ï¼Œç¼–è¯‘å™¨ä¹Ÿä¼šè¿›è¡Œä»£ç ä¼˜åŒ–é‡æ’ä»£ç å‘€ï¼ä½†æ˜¯äºŒè€…åŒºåˆ«ï¼Ÿåˆæ˜¯ä»€ä¹ˆï¼Ÿæˆ‘ä¸æ¸…æ¥šï¼Œè®© AI ç»™æˆ‘ç”Ÿæˆï¼š

    | **ç‰¹æ€§**     | **ç¼–è¯‘å™¨å±éšœ**                             | **å†…å­˜å±éšœ**                                  |
    | :----------- | :----------------------------------------- | :-------------------------------------------- |
    | **ä½œç”¨å¯¹è±¡** | **ç¼–è¯‘å™¨ä¼˜åŒ–ï¼ˆé˜»æ­¢ç¼–è¯‘å™¨é‡æ’ä»£ç ï¼‰**       | **ç¡¬ä»¶æ‰§è¡Œï¼ˆé˜»æ­¢ CPU æˆ–å†…å­˜æ§åˆ¶å™¨é‡æ’æŒ‡ä»¤ï¼‰** |
    | **å½±å“èŒƒå›´** | **ä»£ç ç”Ÿæˆçš„é¡ºåºï¼ˆé™æ€ï¼‰**                 | **å†…å­˜æ“ä½œçš„æ‰§è¡Œé¡ºåºï¼ˆåŠ¨æ€ï¼‰**                |
    | **å…¸å‹å®ç°** | `asm volatile("" ::: "memory")`ï¼ˆGCCè¯­æ³•ï¼‰ | `mfence`ï¼ˆx86ï¼‰ã€`dmb`ï¼ˆARMï¼‰                 |
    | **ç›®æ ‡é—®é¢˜** | é˜²æ­¢ç¼–è¯‘å™¨ä¼˜åŒ–ç ´åä»£ç é¡ºåºï¼ˆå¦‚ LTO ä¼˜åŒ–ï¼‰  | é˜²æ­¢ç¡¬ä»¶é‡æ’å¯¼è‡´å†…å­˜æ“ä½œé¡ºåºä¸ç¬¦åˆé¢„æœŸ        |

    å“¦ï¼è¿˜æ˜¯å›åˆ°ä¹‹å‰æ€»ç»“çš„ï¼Œå‰é¢å…³æ³¨çš„å°±æ˜¯åœ¨å¯¹äºå†…å­˜çš„æ“ä½œï¼Œæ— è®ºæ˜¯åŸå­æ€§è¿˜æ˜¯memory barrierï¼Œæ˜¯ç¡¬ä»¶ä¸Šçš„é™åˆ¶ï¼Œè€Œè¿™é‡Œæ›´å¤šå…³æ³¨çš„æ˜¯è½¯ä»¶ä»£ç ä¸Šçš„é™åˆ¶ï¼

    å›åˆ°è€å¸ˆä¸Šè¯¾ç»™å‡ºçš„ä¾‹å­ï¼š

    > æ“ä½œè‡ªå¸¦ä¸€ä¸ª compiler barrierï¼Œé˜²æ­¢ä¼˜åŒ–è·¨è¿‡å‡½æ•°è°ƒç”¨ã€‚è¿™ä¸€ç‚¹å¾ˆé‡è¦â€”â€”ä¾‹å¦‚æˆ‘ä»¬ä»Šå¤©çš„ç¼–è¯‘å™¨æ”¯æŒ Link-time Optimization (LTO)ï¼Œå¦‚æœç¼ºå°‘ compiler barrierï¼Œç¼–è¯‘ä¼˜åŒ–å¯ä»¥ç©¿è¿‡ volatile æ ‡è®°çš„æ±‡ç¼–æŒ‡ä»¤ï¼›

    - **ç¼–è¯‘å™¨ä¼˜åŒ–ç ´åé¡ºåºï¼ˆå¦‚ LTOï¼‰**

        - **åœºæ™¯**ï¼š
            ä½¿ç”¨ `volatile` æ±‡ç¼–æŒ‡ä»¤æ—¶ï¼Œç¼–è¯‘å™¨å¯èƒ½å°†ç›¸é‚»çš„é `volatile` ä»£ç é‡æ’åˆ°æ±‡ç¼–æŒ‡ä»¤ä¹‹å¤–ã€‚

        - **ç¤ºä¾‹**ï¼š

            ```c
            extern void device_write(int val);
            
            void write_to_device() {
                //.... compute... -> result = 42
                int data = result;
                asm volatile("movl %0, (DEVICE_ADDR)" : : "r"(data)); // è®¾å¤‡å†™å…¥
                status_flag = 1; // å¯èƒ½è¢«ç¼–è¯‘å™¨é‡æ’åˆ°æ±‡ç¼–æŒ‡ä»¤å‰
            }
            ```

        - **è§£å†³æ–¹æ¡ˆ**ï¼šæ’å…¥ç¼–è¯‘å™¨å±éšœ

            ```c
            void write_to_device() {
                //.... compute... -> result = 42
                int data = 42;
                asm volatile("movl %0, (DEVICE_ADDR)" : : "r"(data));
                asm volatile("" ::: "memory"); // é˜»æ­¢ç¼–è¯‘å™¨é‡æ’
                status_flag = 1;
            }
            ```

        

    - **ç¡¬ä»¶é‡æ’ç ´åå†…å­˜é¡ºåºï¼ˆå¦‚ x86 TSOï¼‰**

        - **åœºæ™¯**ï¼š
            x86 çš„ TSO æ¨¡å‹å…è®¸ **Storeâ†’Load é‡æ’**ï¼Œå¯¼è‡´åç»­è¯»æ“ä½œçœ‹åˆ°æ—§å€¼ã€‚

        - **ç¤ºä¾‹**ï¼š

            ```c
            int x = 0, y = 0;
            
            void thread1() {
                x = 1;          // Store
                int r = y;      // Loadï¼ˆå¯èƒ½å…ˆäºx=1æ‰§è¡Œï¼‰
            }
            
            void thread2() {
                y = 1;
                while (x == 0) {} // å¯èƒ½æ­»å¾ªç¯
            }
            ```

        - **è§£å†³æ–¹æ¡ˆ**ï¼šæ’å…¥å†…å­˜å±éšœ

            ```c
            void thread1() {
                x = 1;
                asm volatile("mfence" ::: "memory"); // å†…å­˜å±éšœ
                int r = y; // ç¡®ä¿x=1å¯¹å…¶ä»–æ ¸å¯è§åå†è¯»y
            }
            ```

    

    å½“ç„¶ï¼Œæˆ‘è§‰å¾—å¯¹äºå¼€å‘è€…æ¥è¯´ï¼Œmemory barrierã€compiler barrier ä¸€èµ·ç”¨ä¸æ˜¯æ›´å¥½ï¼Ÿï¼ˆæˆ‘æ²¡æœ‰å¤ªå¤šçš„ç»éªŒï¼Œå†å­¦ä¹ ï¼‰

    æ‰€ä»¥æˆ‘å†æ€»ç»“ï¼š

    - **memory barrier ä¸ compiler barrier ååŒ**

        ä¹Ÿå°±æ˜¯æä¾›**å®Œæ•´å±éšœ**ï¼šå®é™…ä»£ç ä¸­é€šå¸¸åŒæ—¶ä½¿ç”¨ç¼–è¯‘å™¨å±éšœå’Œå†…å­˜å±éšœï¼Œä¾‹å¦‚ï¼š

        ```c
        // x86çš„mfenceéšå«ç¼–è¯‘å™¨å±éšœ
        #define barrier() asm volatile("mfence" ::: "memory")
        ```

        - `mfence` æ—¢æ˜¯å†…å­˜å±éšœï¼ˆé˜»æ­¢ç¡¬ä»¶é‡æ’ï¼‰ï¼Œ`:::"memory"`ä¹Ÿæ˜¯ç¼–è¯‘å™¨å±éšœï¼ˆé˜»æ­¢ç¼–è¯‘å™¨é‡æ’ï¼‰ã€‚

    - **è‡ªå·±ç†è§£çš„è¯¯åŒº**

        - **è¯¯åŒº1**ï¼š**`volatile` å˜é‡éšå«å†…å­˜å±éšœã€‚**

            - **äº‹å®**ï¼š`volatile` ä»…é˜»æ­¢ç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œä¸ç”Ÿæˆå†…å­˜å±éšœæŒ‡ä»¤ã€‚
            - **ä¿®æ­£**ï¼šéœ€æ˜¾å¼ä½¿ç”¨å±éšœï¼ˆå¦‚ `mfence`ï¼‰ã€‚

            > å›é¡¾ volatile ï¼Œå®é™…ä¸Šè¦æ±‚æ¯ä¸€æ¬¡æ“ä½œéƒ½å»å†…å­˜ã€é˜²æ­¢ç¼–è¯‘å™¨ä¼˜åŒ–

        - **è¯¯åŒº2**ï¼šç¼–è¯‘å™¨å±éšœèƒ½è§£å†³ç¡¬ä»¶é‡æ’ã€‚

            - **äº‹å®**ï¼šç¼–è¯‘å™¨å±éšœä»…æ§åˆ¶ä»£ç ç”Ÿæˆé¡ºåºï¼Œä¸é™åˆ¶ç¡¬ä»¶é‡æ’ã€‚
            - **ä¿®æ­£**ï¼šéœ€ç»“åˆå†…å­˜å±éšœã€‚




ç”±ä¸Šä¸‰ä¸ªå‡è®¾çš„åŸºç¡€ï¼ŒåŸå­æ“ä½œå°±æˆä¸ºäº†æˆ‘ä»¬ç®€åŒ–ç¨‹åºæ‰§è¡Œçš„åŸºç¡€æœºåˆ¶ã€‚

- é€šè¿‡è‡ªæ—‹ (spin)ï¼Œå¯ä»¥å¾ˆç›´è§‚åœ°å®ç° â€œè½®è¯¢â€ å¼çš„äº’æ–¥ã€‚
- ä¸ºäº†èŠ‚çº¦å…±äº«å†…å­˜çº¿ç¨‹åœ¨è‡ªæ—‹ä¸Šæµªè´¹çš„å¤„ç†å™¨ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ç³»ç»Ÿè°ƒç”¨è¯·æ±‚æ“ä½œç³»ç»Ÿæ¥å¸®åŠ©ç°æˆå®Œæˆäº’æ–¥ã€‚



> å‚è€ƒèµ„æ–™
>
> - æ“ä½œç³»ç»Ÿç³»ç»ŸåŸç†ä¸å®ç°ã€‹â€”â€”é™ˆæµ·æ³¢ã€å¤è™æ–Œ
> - [Linearizability - Wikipedia](https://en.wikipedia.org/wiki/Linearizability)
> - [Consistency model - Wikipedia](https://en.wikipedia.org/wiki/Consistency_model#Consistency_and_replication)
> - [Cache coherence - Wikipedia](https://en.wikipedia.org/wiki/Cache_coherence)
> - [Atomic vs. Non-Atomic Operations](https://preshing.com/20130618/atomic-vs-non-atomic-operations/)



ä¹‹åçš„åŒæ­¥ã€å¹¶å‘bugs éƒ½å»ºç«‹äºæ­¤åŸºç¡€ä¸Šï¼Œäº§ç”Ÿå„ç§é—®é¢˜ï¼Œé‚£äº›æœ‰ç©ºå†æ€»ç»“ï¼ˆæˆ–è€… AI ç”Ÿäº§ä¸€ç‰ˆï¼Ÿï¼‰