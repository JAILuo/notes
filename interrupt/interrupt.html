
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://jailuo.github.io/notes/interrupt/interrupt.html">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.48">
    
    
      
        <title>Interrupt - Messy Notes</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.6f8fc17f.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../css/timeago.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#introduciton" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../index.html" title="Messy Notes" class="md-header__button md-logo" aria-label="Messy Notes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Messy Notes
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Interrupt
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256l137.3-137.4c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/JAILuo/notes" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="Messy Notes" class="md-nav__button md-logo" aria-label="Messy Notes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Messy Notes
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/JAILuo/notes" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    首页
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Article
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Article
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="/article/concurrency sumary/summary.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    concurrency-summary
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="/article/toolchain/toolchain.mc" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    toolchain
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="/article/mount/mount.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mount
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Course
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Course
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    University Course
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            University Course
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1_1" id="__nav_3_1_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    jyy OS2024
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_1">
            <span class="md-nav__icon md-icon"></span>
            jyy OS2024
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_1_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1_1_1" id="__nav_3_1_1_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    course note
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_3_1_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_1_1">
            <span class="md-nav__icon md-icon"></span>
            course note
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Course/University%20Course/jyy%20OS2024/cousre%20note/1.%20introduction/introduction.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    introduction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Course/University%20Course/jyy%20OS2024/cousre%20note/2.%20concurrency/concurrency.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    concurrency
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Course/University%20Course/jyy%20OS2024/cousre%20note/3.%20virtualization/virtualization.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    virtualization
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Course/University%20Course/jyy%20OS2024/cousre%20note/4.%20kernel/kernel.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    kernel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Course/University%20Course/jyy%20OS2024/cousre%20note/5.%20persistence/persistence.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    persistence
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_1_2" >
        
          
          <label class="md-nav__link" for="__nav_3_1_1_2" id="__nav_3_1_1_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Mini Labs
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_3_1_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_1_2">
            <span class="md-nav__icon md-icon"></span>
            Mini Labs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Course/University%20Course/jyy%20OS2024/Mini%20Labs/M1/M1.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    M1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Course/University%20Course/jyy%20OS2024/Mini%20Labs/M2/M2.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    M2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Course/University%20Course/jyy%20OS2024/Mini%20Labs/M3/M3.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    M3
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_1_3" >
        
          
          <label class="md-nav__link" for="__nav_3_1_1_3" id="__nav_3_1_1_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    OS Labs
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_3_1_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_1_3">
            <span class="md-nav__icon md-icon"></span>
            OS Labs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Course/University%20Course/jyy%20OS2024/OS%20Labs/L0/L0.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    L0
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Course/University%20Course/jyy%20OS2024/OS%20Labs/L1/L1.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    L1
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    GeekTime
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            GeekTime
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2_1" >
        
          
          <label class="md-nav__link" for="__nav_3_2_1" id="__nav_3_2_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    深入理解计算机组成原理
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2_1">
            <span class="md-nav__icon md-icon"></span>
            深入理解计算机组成原理
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Course/GeekTime/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/%E4%B8%80%E5%91%A8%E7%9B%AE/1.%20%E6%8C%87%E4%BB%A4%E4%B8%8E%E8%BF%90%E7%AE%97/%E6%8C%87%E4%BB%A4%E4%B8%8E%E8%BF%90%E7%AE%97.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1. 指令与运算
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Course/GeekTime/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/%E4%B8%80%E5%91%A8%E7%9B%AE/2.%20%E5%A4%84%E7%90%86%E5%99%A8/%E5%A4%84%E7%90%86%E5%99%A8.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2. 处理器
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Course/GeekTime/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/%E4%B8%80%E5%91%A8%E7%9B%AE/3.%20%E5%AD%98%E5%82%A8%E4%B8%8EIO%E7%B3%BB%E7%BB%9F/%E5%AD%98%E5%82%A8%E4%B8%8EIO%E7%B3%BB%E7%BB%9F.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3. 存储与IO系统
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Course/GeekTime/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/%E4%B8%80%E5%91%A8%E7%9B%AE/4.%20%E5%BA%94%E7%94%A8/%E5%BA%94%E7%94%A8.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4. 应用
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2_2" id="__nav_3_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    计算基础实战课
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2_2">
            <span class="md-nav__icon md-icon"></span>
            计算基础实战课
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Course/GeekTime/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80%E5%AE%9E%E6%88%98%E8%AF%BE/1.%20MiniCPU%E8%AE%BE%E8%AE%A1/MiniCPU%E8%AE%BE%E8%AE%A1.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1. MiniCPU设计
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Course/GeekTime/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80%E5%AE%9E%E6%88%98%E8%AF%BE/2.%20%E8%AF%AD%E8%A8%80%E5%92%8C%E6%8C%87%E4%BB%A4/%E8%AF%AD%E8%A8%80%E5%92%8C%E6%8C%87%E4%BB%A4.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2. 语言和指令
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Course/GeekTime/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80%E5%AE%9E%E6%88%98%E8%AF%BE/3.%20%E5%BA%94%E7%94%A8%E5%92%8C%E5%86%85%E5%AD%98/%E5%BA%94%E7%94%A8%E5%92%8C%E5%86%85%E5%AD%98.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3. 应用和内存
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Course/GeekTime/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80%E5%AE%9E%E6%88%98%E8%AF%BE/4.%20IO%E4%B8%8E%E6%96%87%E4%BB%B6/IO%E5%92%8C%E6%96%87%E4%BB%B6.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4. IO与文件
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Course/GeekTime/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80%E5%AE%9E%E6%88%98%E8%AF%BE/5.%20%E7%BB%BC%E5%90%88%E5%BA%94%E7%94%A8/synthesis.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5. 综合应用
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Course/GeekTime/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80%E5%AE%9E%E6%88%98%E8%AF%BE/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E5%92%8C%E5%B7%A5%E5%85%B7%E9%93%BE/%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    环境配置和工具链
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    ysyx
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            ysyx
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    NJU-ICS2023-PA
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            NJU-ICS2023-PA
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ysyx/pa/pa1/pa1.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PA1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ysyx/pa/pa2/pa2.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PA2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ysyx/pa/pa3/pa3.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PA3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ysyx/pa/pa4/pa4.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PA4
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ysyx/pa/c_marco/macro.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    C Macro
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ysyx/pa/summary/summary.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Summary
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ysyx/pa/Linux_porting/porting.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Linux Porting
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ysyx/digital-circuit/digital%20circuit.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Digital Circuit
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tools
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Tools
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Tools/GDB/GDB.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GDB
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Vim
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            Vim
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Tools/vim/usage/usage.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    usage
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Tools/vim/vim-plugin/vim.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    vim-plugin
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Tools/doxygen/doxygen.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    doxygen
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Tools/gcc/gcc.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    gcc
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Tools/Git/Git.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Git
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Tools/md2slider/md2slider.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    md2slider
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Tools/tmux/tmux.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    tmux
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Todo%20List/todo.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TODO List
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduciton" class="md-nav__link">
    <span class="md-ellipsis">
      Introduciton
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#isr" class="md-nav__link">
    <span class="md-ellipsis">
      ISR要短？
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ISR要短？">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      1. 中断屏蔽与优先级抢占的博弈
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      2. 上下文切换开销的误区
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      3. 资源竞争与系统可维护性
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    <span class="md-ellipsis">
      4. 性能优化的权衡策略
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      结论：短中断的实质是“最小化关键路径”
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      并发问题
    </span>
  </a>
  
    <nav class="md-nav" aria-label="并发问题">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-cpu" class="md-nav__link">
    <span class="md-ellipsis">
      1. CPU占用率计算解析
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. CPU占用率计算解析">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      公式解释：
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      示例验证：
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      核心矛盾：
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-dma" class="md-nav__link">
    <span class="md-ellipsis">
      2. 何时使用DMA应对高频中断？
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. 何时使用DMA应对高频中断？">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      高频中断的定义与判断依据
    </span>
  </a>
  
    <nav class="md-nav" aria-label="高频中断的定义与判断依据">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1cpu" class="md-nav__link">
    <span class="md-ellipsis">
      步骤1：计算单次中断的CPU占用时间
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_1" class="md-nav__link">
    <span class="md-ellipsis">
      步骤2：计算每秒中断占用的总时间
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3dma" class="md-nav__link">
    <span class="md-ellipsis">
      步骤3：确定DMA的使用阈值
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dma" class="md-nav__link">
    <span class="md-ellipsis">
      DMA的典型应用场景
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_1" class="md-nav__link">
    <span class="md-ellipsis">
      3. 中断处理时间与中断频率的权衡
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. 中断处理时间与中断频率的权衡">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vs" class="md-nav__link">
    <span class="md-ellipsis">
      高频低耗时 vs 低频高耗时
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      设计建议
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      总结
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      中断频率怎么得出来的
    </span>
  </a>
  
    <nav class="md-nav" aria-label="中断频率怎么得出来的">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      分步解析与答案：
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1_1" class="md-nav__link">
    <span class="md-ellipsis">
      1. 中断频率的来源：硬件决定而非计算
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. 中断频率的来源：硬件决定而非计算">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a" class="md-nav__link">
    <span class="md-ellipsis">
      a. 定时器中断
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b" class="md-nav__link">
    <span class="md-ellipsis">
      b. 外部事件中断
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#c" class="md-nav__link">
    <span class="md-ellipsis">
      c. 传感器中断
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_2" class="md-nav__link">
    <span class="md-ellipsis">
      2. 多中断处理策略
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. 多中断处理策略">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a_1" class="md-nav__link">
    <span class="md-ellipsis">
      a. 中断优先级与嵌套
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b_1" class="md-nav__link">
    <span class="md-ellipsis">
      b. 中断合并与批量处理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#c_1" class="md-nav__link">
    <span class="md-ellipsis">
      c. 高频中断的硬件卸载
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-linux" class="md-nav__link">
    <span class="md-ellipsis">
      3. 操作系统（如Linux）中的中断处理
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. 操作系统（如Linux）中的中断处理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-top-halfbottom-half" class="md-nav__link">
    <span class="md-ellipsis">
      a. 上半部（Top Half）与下半部（Bottom Half）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b-threaded-irqs" class="md-nav__link">
    <span class="md-ellipsis">
      b. 中断线程化（Threaded IRQs）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#c_2" class="md-nav__link">
    <span class="md-ellipsis">
      c. 操作系统中的并发问题
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#d" class="md-nav__link">
    <span class="md-ellipsis">
      d. 实时性挑战
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      总结
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      中断的一些基础
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#basic1" class="md-nav__link">
    <span class="md-ellipsis">
      basic1
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stm32-hal" class="md-nav__link">
    <span class="md-ellipsis">
      STM32 HAL库中断例子
    </span>
  </a>
  
    <nav class="md-nav" aria-label="STM32 HAL库中断例子">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_2" class="md-nav__link">
    <span class="md-ellipsis">
      1. 核心概念：非阻塞与中断驱动
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_3" class="md-nav__link">
    <span class="md-ellipsis">
      2. 函数详解
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. 函数详解">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hal_uart_receive_ituart_handletypedef-huart-uint8_t-pdata-uint16_t-size" class="md-nav__link">
    <span class="md-ellipsis">
      HAL_UART_Receive_IT(UART_HandleTypeDef *huart, uint8_t *pData, uint16_t Size)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hal_uart_transmit_ituart_handletypedef-huart-uint8_t-pdata-uint16_t-size" class="md-nav__link">
    <span class="md-ellipsis">
      HAL_UART_Transmit_IT(UART_HandleTypeDef *huart, uint8_t *pData, uint16_t Size)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_2" class="md-nav__link">
    <span class="md-ellipsis">
      3. 中断触发时机总结
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4_1" class="md-nav__link">
    <span class="md-ellipsis">
      4. 何时使用它们？
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    <span class="md-ellipsis">
      5. 注意事项
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#receive_it" class="md-nav__link">
    <span class="md-ellipsis">
      流程图示意 (以 Receive_IT 为例)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      中断服务程序中为什么不能进行调度？
    </span>
  </a>
  
    <nav class="md-nav" aria-label="中断服务程序中为什么不能进行调度？">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      核心原因：一句话概括
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      底层原理详解
    </span>
  </a>
  
    <nav class="md-nav" aria-label="底层原理详解">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-vs" class="md-nav__link">
    <span class="md-ellipsis">
      1. 两种上下文：中断上下文 vs. 进程上下文
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-task_struct" class="md-nav__link">
    <span class="md-ellipsis">
      2. 调度信息的核心：task_struct 里具体是什么？
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-sleep" class="md-nav__link">
    <span class="md-ellipsis">
      3. 为什么中断中调用 sleep() 或互斥锁会崩溃？
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-task_struct" class="md-nav__link">
    <span class="md-ellipsis">
      4. 为什么中断上下文不能有 task_struct？为什么不能有？
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      总结与类比
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      中断线程化和中断上下半部？
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#todo" class="md-nav__link">
    <span class="md-ellipsis">
      TODO
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#todo_1" class="md-nav__link">
    <span class="md-ellipsis">
      TODO
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>Interrupt</h1>

<h2 id="introduciton">Introduciton</h2>
<p>中断这个概念都说了很多次了。</p>
<p>欸，有个比较有意思的地方，中断是怎么被配置的？？怎么对应到哪个IO口上的？？MCU core或者Soc 内部是怎么做的？</p>
<p>TODO</p>
<h2 id="isr">ISR要短？</h2>
<p>在嵌入式MCU和SoC驱动开发中，要求中断服务程序（ISR）尽量简短的核心原因在于<strong>平衡实时性、系统可靠性和性能开销</strong>。以下是关键点的分层次解析：</p>
<hr />
<h3 id="1">1. <strong>中断屏蔽与优先级抢占的博弈</strong></h3>
<ul>
<li><strong>中断嵌套的局限性</strong>：<br />
     即使系统支持中断嵌套，高优先级中断可以抢占低优先级中断，但<strong>同优先级中断通常会被屏蔽</strong>。若ISR执行时间过长，会导致：<ul>
<li>同优先级或低优先级的中断无法及时响应，可能丢失关键事件（如传感器数据）。</li>
<li>高优先级中断虽可抢占，但频繁抢占会加剧堆栈压力（需多次保存上下文）。</li>
</ul>
</li>
<li><strong>裸机系统的致命问题</strong>：<br />
     在无操作系统的场景下，ISR通常全程关闭中断（或仅允许更高优先级中断）。若ISR耗时过长，<strong>所有低优先级中断和主循环任务会被完全冻结</strong>，破坏系统实时性。</li>
</ul>
<hr />
<h3 id="2">2. <strong>上下文切换开销的误区</strong></h3>
<ul>
<li><strong>操作系统的上下文切换</strong>：<br />
     在RTOS中，中断可能触发任务调度（如通过信号量唤醒任务），此时上下文切换的开销确实存在。但<strong>ISR本身的执行时间越长，任务调度延迟越高</strong>，反而得不偿失。</li>
<li><strong>裸机的“伪上下文切换”</strong>：<br />
     即使没有OS，中断仍需保存/恢复CPU寄存器（硬件自动完成）。若ISR极短（如仅设置标志位），保存/恢复的周期可能小于主循环轮询开销。但对于高频中断（如1MHz的GPIO），<strong>必须通过硬件优化（如DMA）减少中断次数</strong>，而非依赖延长ISR。</li>
</ul>
<hr />
<h3 id="3">3. <strong>资源竞争与系统可维护性</strong></h3>
<ul>
<li><strong>共享资源的锁定时长</strong>：<br />
     ISR与主循环共享的变量或外设若被长时间占用，会增大竞态风险。例如：
     <div class="highlight"><pre><span></span><code><span class="c1">// 错误示例：ISR中直接处理复杂逻辑</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">UART_ISR</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">UART_RX_NOT_EMPTY</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">process_data</span><span class="p">(</span><span class="n">UART_READ</span><span class="p">());</span><span class="w"> </span><span class="c1">// 耗时操作阻塞其他中断</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
     正确做法是ISR仅读取数据到缓冲区，主循环处理实际逻辑。</li>
<li><strong>代码可测试性与调试</strong>：<br />
     冗长的ISR难以测试和维护，且可能引入不可预测的时序问题（如死锁）。</li>
</ul>
<hr />
<h3 id="4">4. <strong>性能优化的权衡策略</strong></h3>
<ul>
<li><strong>高频中断场景的应对</strong>：  <ul>
<li><strong>硬件加速</strong>：使用DMA传输数据，将中断频率从“每字节一次”降为“整块数据完成一次”。</li>
<li><strong>中断合并</strong>：配置外设在多个事件后触发中断（如UART接收FIFO满）。</li>
</ul>
</li>
<li><strong>低延迟需求的妥协</strong>：<br />
     若必须长耗时操作（如实时控制算法），可设计为：
     <div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">MotorControl_ISR</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">read_sensors</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">needs_complex_calculation</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">trigger_low_priority_software_interrupt</span><span class="p">();</span><span class="w"> </span><span class="c1">// 交由低优先级ISR或任务处理</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></li>
</ul>
<hr />
<h3 id="_1">结论：短中断的实质是“最小化关键路径”</h3>
<ul>
<li><strong>核心原则</strong>：ISR应仅完成<strong>不可延迟的最小操作</strong>（如清除中断标志、读写硬件寄存器、设置事件标志），其余逻辑移交主循环或低优先级任务。</li>
<li><strong>数据对比</strong>：  <ul>
<li>假设ISR执行100周期，主循环处理1000周期，中断频率1kHz：  </li>
<li>短ISR：CPU占用率 = (100 + 1000) * 1000 / 1e6 (假设100MHz) = 1.1%。  </li>
<li>长ISR（合并操作）：若ISR直接处理需1100周期，则占用率 = 1100 * 1000 / 1e6 = 1.1%——看似相同，但主循环完全停滞，实时任务无法响应。</li>
</ul>
</li>
<li><strong>最终取舍</strong>：短中断牺牲局部性能，换取系统级实时性和可靠性，这是嵌入式系统的典型设计哲学。</li>
</ul>
<h2 id="_2">并发问题</h2>
<blockquote>
<p>还有，这个是怎么计算出来的：
假设ISR执行100周期，主循环处理1000周期，中断频率1kHz：</p>
<p>短ISR：CPU占用率 = (100 + 1000) * 1000 / 1e6 (假设100MHz) = 1.1%。</p>
<p>长ISR（合并操作）：若ISR直接处理需1100周期，则占用率 = 1100 * 1000 / 1e6 = 1.1%——看似相同，但主循环完全停滞，实时任务无法响应。
为什么这个除以这个？</p>
<p>能够给一个值，来具体看看什么时候应该用到DMA来应对高频中断？具体怎么才算高频中断？每多少时间触发一次？这个时间又是怎么算出来的？？（等等，我似乎弄混了中断程序时间的长短和中断频率的高低！）</p>
</blockquote>
<h3 id="1-cpu"><strong>1. CPU占用率计算解析</strong></h3>
<h4 id="_3"><strong>公式解释：</strong></h4>
<p>用户提到的计算中，分母是CPU主频（假设100MHz = 1e8 cycles/sec），分子是<strong>每秒消耗的总CPU周期数</strong>，公式为：
[
\text{CPU占用率} = \frac{(\text{ISR周期数} + \text{主循环处理周期数}) \times \text{中断频率}}{\text{CPU主频}} \times 100\%
]</p>
<h4 id="_4"><strong>示例验证：</strong></h4>
<ul>
<li>
<p><strong>短ISR场景</strong>：</p>
</li>
<li>
<p>ISR执行周期：100 cycles</p>
</li>
<li>
<p>主循环处理周期：1000 cycles</p>
</li>
<li>
<p>中断频率：1kHz（每秒1000次）</p>
</li>
<li>
<p>CPU主频：100MHz（1e8 cycles/sec）
    $$
    \text{总周期/秒} = (100 + 1000) \times 1000 = 1,100,000 \, \text{cycles}
    $$</p>
<p>$$
\text{CPU占用率} = \frac{1,100,000}{1e8} \times 100\% = 1.1\%
$$</p>
</li>
<li>
<p><strong>长ISR场景</strong>：</p>
</li>
<li>
<p>ISR直接处理所有逻辑：1100 cycles</p>
</li>
<li>
<p>主循环无法执行（被中断阻塞）
    $$
    \text{总周期/秒} = 1100 \times 1000 = 1,100,000 \, \text{cycles}
    $$</p>
<p>$$
\text{CPU占用率} = \frac{1,100,000}{1e8} \times 100\% = 1.1\% \, (\text{但主循环完全停滞！})
$$</p>
</li>
</ul>
<h4 id="_5"><strong>核心矛盾：</strong></h4>
<ul>
<li><strong>短ISR</strong>：CPU占用率相同，但主循环仍可运行（处理其他任务）。</li>
<li><strong>长ISR</strong>：主循环被阻塞，系统失去响应能力，即使CPU占用率相同。</li>
</ul>
<hr />
<h3 id="2-dma"><strong>2. 何时使用DMA应对高频中断？</strong></h3>
<h4 id="_6"><strong>高频中断的定义与判断依据</strong></h4>
<p>高频中断的判断需综合考虑 <strong>中断频率</strong> 和 <strong>单次中断处理时间</strong>，目标是避免CPU被中断占用过多周期。具体阈值可通过以下步骤确定：</p>
<h5 id="1cpu"><strong>步骤1：计算单次中断的CPU占用时间</strong></h5>
<p>$$
\text{单次中断占用时间} = \frac{\text{ISR周期数}}{\text{CPU主频}}
$$</p>
<p>例如：
- ISR周期数 = 100 cycles
- CPU主频 = 100MHz → 1 cycle = 10ns
- 单次中断时间 = 100 × 10ns = 1μs</p>
<h5 id="2_1"><strong>步骤2：计算每秒中断占用的总时间</strong></h5>
<p>$$
\text{总占用时间} = \text{单次中断时间} \times \text{中断频率}
$$</p>
<ul>
<li>若中断频率为1MHz（每秒1e6次）：
  $$
  \text{总占用时间} = 1μs \times 1e6 = 1秒
  $$
  → CPU占用率 = 100%（完全不可行，必须使用DMA）。</li>
</ul>
<h5 id="3dma"><strong>步骤3：确定DMA的使用阈值</strong></h5>
<ul>
<li>
<p><strong>经验法则</strong>：若中断占用的CPU时间超过总时间的10%~20%，需考虑DMA。</p>
</li>
<li>
<p><strong>数学推导</strong>：
  $$
  假设允许的CPU占用率为 C_{\text{max}}
  $$</p>
</li>
</ul>
<p>$$
  \text{最大允许中断频率} = \frac{C_{\text{max}} \times \text{CPU主频}}{\text{ISR周期数}}
  $$</p>
<p>例如：</p>
<ul>
<li>
<p>$$
      C_{\text{max}} = 10\%
      $$</p>
</li>
<li>
<p>CPU主频 = 100MHz</p>
</li>
<li>
<p>ISR周期数 = 100 cycles
    $$
    \text{最大中断频率} = \frac{0.1 \times 1e8}{100} = 100,000 \, \text{Hz} = 100\text{kHz}
    $$
    若实际中断频率超过100kHz，必须使用DMA。</p>
</li>
</ul>
<h4 id="dma"><strong>DMA的典型应用场景</strong></h4>
<ul>
<li><strong>高速数据传输</strong>：如UART、SPI、I2C接收/发送数据。</li>
<li><strong>硬件特性支持</strong>：外设具有DMA请求信号（如FIFO缓冲区满）。</li>
<li><strong>示例</strong>：</li>
<li><strong>无DMA</strong>：UART每接收1字节触发一次中断，1Mbps波特率下每秒中断125,000次（假设8N1格式）。</li>
<li><strong>有DMA</strong>：DMA自动接收多个字节，仅在缓冲区满时触发一次中断，中断频率降低至1kHz以下。</li>
</ul>
<hr />
<h3 id="3_1"><strong>3. 中断处理时间与中断频率的权衡</strong></h3>
<h4 id="vs"><strong>高频低耗时 vs 低频高耗时</strong></h4>
<ul>
<li>
<p><strong>高频低耗时</strong>（如1MHz中断，每次1 cycle）：
  $$
  \text{CPU占用率} = \frac{1 \times 1e6}{1e8} = 1\% \, (\text{可接受})
  $$</p>
</li>
<li>
<p><strong>低频高耗时</strong>（如1kHz中断，每次1000 cycles）：
  $$
  \text{CPU占用率} = \frac{1000 \times 1e3}{1e8} = 1\% \, (\text{可接受，但主循环可能被阻塞})
  $$</p>
</li>
</ul>
<h4 id="_7"><strong>设计建议</strong></h4>
<ul>
<li><strong>高频中断</strong>：即使单次处理时间短，也需通过DMA或硬件加速减少中断次数。</li>
<li><strong>低频中断</strong>：若单次处理时间过长（如 &gt; 总周期的10%），需拆分逻辑，ISR仅标记事件，主循环处理实际任务。</li>
</ul>
<hr />
<h3 id="_8"><strong>总结</strong></h3>
<ul>
<li><strong>CPU占用率计算</strong>：关注总周期消耗，而非单一任务的执行时间。</li>
<li><strong>DMA使用阈值</strong>：通过中断频率和处理时间计算，通常超过10% CPU占用率时需优化。</li>
<li><strong>高频中断定义</strong>：1. 中断频率 &gt; 100kHz；2. 或中断占用CPU时间 &gt; 10%。</li>
</ul>
<h2 id="_9">中断频率怎么得出来的</h2>
<blockquote>
<p>要是有多个中断，那具体怎么安排处理这个高频中断？？感觉还是挺复杂的？</p>
<p>那接着，如果使用到了OS，那对于外部的设备，也是需要使用中断的呀，那上面的问题又会变成什么呢？？比如说Linux 的。</p>
</blockquote>
<h3 id="_10"><strong>分步解析与答案：</strong></h3>
<hr />
<h3 id="1_1"><strong>1. 中断频率的来源：硬件决定而非计算</strong></h3>
<p>中断频率<strong>主要由硬件配置或外部事件触发条件决定</strong>，而非通过数学计算得出。以下是常见中断源的频率确定方式：</p>
<h4 id="a"><strong>a. 定时器中断</strong></h4>
<ul>
<li>
<p><strong>配置寄存器决定频率</strong>：<br />
  例如，STM32的定时器通过预分频器（Prescaler）和自动重载值（Auto-Reload Register）计算中断频率：
  $$
  \text{中断频率} = \frac{\text{定时器时钟源}}{\text{(Prescaler + 1)*(AutoReload + 1)}}
  $$</p>
</li>
<li>
<p>假设时钟源为80MHz，Prescaler=79，AutoReload=999：
    $$
    \text{中断频率} = \frac{80\text{MHz}}{(79+1) \times (999+1)} = \frac{80,000,000}{80 \times 1000} = 1\text{kHz}
    $$</p>
</li>
</ul>
<h4 id="b"><strong>b. 外部事件中断</strong></h4>
<ul>
<li>
<p><strong>由物理信号触发</strong>：<br />
  如UART接收数据时，每收到一个字节触发一次中断，中断频率取决于<strong>波特率</strong>：
  $$
  \text{中断频率} = \frac{\text{波特率}}{\text{每帧位数}}
  $$</p>
</li>
<li>
<p>波特率115200，8N1格式（每帧10位）：
    $$
    \text{中断频率} = \frac{115200}{10} = 11,520 \, \text{Hz} = 11.52\text{kHz}
    $$</p>
</li>
</ul>
<h4 id="c"><strong>c. 传感器中断</strong></h4>
<ul>
<li>
<p><strong>由传感器输出信号决定</strong>：<br />
  如旋转编码器每转一圈产生N个脉冲，中断频率为：
  $$
  \text{中断频率} = \frac{\text{转速（RPM）} \times N}{60}
  $$</p>
</li>
<li>
<p>转速3000 RPM，每转100脉冲：
    $$
    \text{中断频率} = \frac{3000 \times 100}{60} = 5,000 \, \text{Hz} = 5\text{kHz}
    $$</p>
</li>
</ul>
<hr />
<h3 id="2_2"><strong>2. 多中断处理策略</strong></h3>
<p>当系统存在多个中断时，需通过<strong>优先级分配、中断合并、硬件优化</strong>等方式管理高频中断。</p>
<h4 id="a_1"><strong>a. 中断优先级与嵌套</strong></h4>
<ul>
<li><strong>优先级配置</strong>：<br />
  在MCU中，通过中断控制器（如NVIC）为每个中断分配优先级。高优先级中断可抢占低优先级中断。<br />
<strong>示例</strong>：  </li>
<li>高频实时中断（如电机控制PWM）设为最高优先级。</li>
<li>
<p>低频非关键中断（如按键检测）设为最低优先级。</p>
</li>
<li>
<p><strong>中断嵌套的风险</strong>：<br />
  若多个高优先级中断频繁嵌套，可能导致<strong>堆栈溢出</strong>。需限制嵌套深度或使用静态分配的堆栈。</p>
</li>
</ul>
<h4 id="b_1"><strong>b. 中断合并与批量处理</strong></h4>
<ul>
<li><strong>硬件FIFO与DMA</strong>：<br />
  例如，UART接收数据时，使用接收FIFO或DMA，将“每字节中断”合并为“缓冲区满中断”，降低中断频率。</li>
<li>原始中断频率：11.52kHz（每字节中断）。</li>
<li>
<p>使用16字节FIFO后，中断频率降为：11.52kHz / 16 = 720Hz。</p>
</li>
<li>
<p><strong>软件定时器轮询</strong>：<br />
  对于低频中断（如温度传感器），可将其转换为定时器中断驱动的轮询，减少中断数量。</p>
</li>
</ul>
<h4 id="c_1"><strong>c. 高频中断的硬件卸载</strong></h4>
<ul>
<li><strong>专用外设</strong>：
  使用PWM模块生成波形，避免通过中断模拟PWM信号。</li>
<li><strong>硬件加速器</strong>：
  如加密、CRC计算等任务交由硬件加速器完成，减少CPU中断负担。</li>
</ul>
<hr />
<h3 id="3-linux"><strong>3. 操作系统（如Linux）中的中断处理</strong></h3>
<p>在OS环境下，中断处理需与内核调度机制协同，引入了新的设计模式和挑战。</p>
<h4 id="a-top-halfbottom-half"><strong>a. 上半部（Top Half）与下半部（Bottom Half）</strong></h4>
<ul>
<li><strong>上半部</strong>
  在中断上下文中执行，要求快速完成<strong>关键操作</strong>（如读取寄存器、应答硬件），通常<strong>关闭中断</strong>。</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">// Linux驱动示例：上半部</span>
<span class="n">irqreturn_t</span><span class="w"> </span><span class="nf">irq_handler</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">irq</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">dev_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">my_device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev_id</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// 1. 读取硬件状态</span>
<span class="w">    </span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">reg_base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">STATUS_REG</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// 2. 调度下半部</span>
<span class="w">    </span><span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bottom_half</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li><strong>下半部</strong>：<br />
  通过<strong>软中断、Tasklet或工作队列</strong>延后处理非实时任务，可休眠和调度。
  <div class="highlight"><pre><span></span><code><span class="c1">// Tasklet示例：下半部</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">bottom_half_tasklet</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">my_device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">my_device</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// 处理数据（可休眠）</span>
<span class="w">    </span><span class="n">process_data</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></li>
</ul>
<h4 id="b-threaded-irqs"><strong>b. 中断线程化（Threaded IRQs）</strong></h4>
<p>Linux支持将中断处理线程化，减少对实时任务的影响：
- <strong>配置方式</strong>：
  使用 <code>request_threaded_irq</code> 注册中断处理函数，分为快速响应和线程化处理两部分。</p>
<div class="highlight"><pre><span></span><code><span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span><span class="w"> </span><span class="n">quick_handler</span><span class="p">,</span><span class="w"> </span><span class="n">threaded_handler</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">dev</span><span class="p">);</span>
</code></pre></div>
<ul>
<li>
<p><strong>优势</strong>：  </p>
</li>
<li>
<p>线程化部分可调度，避免阻塞其他中断。</p>
</li>
<li>支持优先级设置（如实时线程）。</li>
</ul>
<h4 id="c_2"><strong>c. 操作系统中的并发问题</strong></h4>
<ul>
<li><strong>用户态与内核态数据共享</strong>：
  需通过 <code>copy_to_user</code>/<code>copy_from_user</code> 安全传递数据，避免内存越界。</li>
<li><strong>内核锁机制</strong>：
  使用自旋锁（<code>spin_lock</code>）或互斥锁（<code>mutex</code>）保护共享资源，但需注意：</li>
<li><strong>上半部中不能休眠</strong>，只能使用自旋锁。</li>
<li><strong>下半部可休眠</strong>，可使用互斥锁。</li>
</ul>
<h4 id="d"><strong>d. 实时性挑战</strong></h4>
<ul>
<li><strong>调度延迟</strong>：
  若中断线程优先级低于实时任务，可能导致响应延迟。需设置中断线程为最高实时优先级。</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># 设置中断线程优先级（Linux实时策略）</span>
chrt<span class="w"> </span>-f<span class="w"> </span>-p<span class="w"> </span><span class="m">99</span><span class="w"> </span>&lt;IRQ_thread_PID&gt;
</code></pre></div>
<hr />
<h3 id="_11"><strong>总结</strong></h3>
<ol>
<li><strong>中断频率</strong>由硬件配置或外部事件决定，需通过寄存器、信号特性或物理参数计算。</li>
<li><strong>多中断处理</strong>依赖优先级、硬件优化和任务拆分，高频中断需卸载至DMA或专用外设。</li>
<li><strong>OS中的中断</strong>通过上半部/下半部机制平衡实时性与功能性，但需注意锁和调度策略。</li>
</ol>
<h2 id="_12">中断的一些基础</h2>
<ul>
<li>
<p>中断嵌套</p>
</li>
<li>
<p>中断延时</p>
</li>
<li>
<p>丢中断</p>
</li>
<li>
<p>缓冲</p>
<blockquote>
<p>以HID键盘为例：中断线程化+流缓冲来实现高速IO的响应与IO数据完整性</p>
</blockquote>
</li>
</ul>
<h2 id="basic1">basic1</h2>
<p>在计算机领域，“中断”这个概念本身<strong>没有参数和返回值</strong>。中断是一种<strong>机制</strong>，是 CPU 响应外部事件（硬件中断）或内部异常/指令（软件中断）而暂停当前执行流，转而执行特定处理程序的过程。</p>
<p>但是，<strong>中断服务程序</strong>（ISR, Interrupt Service Routine）或者说<strong>中断处理函数</strong>，是<strong>可以有参数和返回值</strong>的，但这取决于具体的中断类型、操作系统和编程环境，并且其使用方式与普通函数有显著区别：</p>
<ol>
<li>
<p><strong>硬件中断处理程序 (ISR):</strong></p>
<ul>
<li><strong>参数：</strong> <strong>通常没有显式的参数传递机制。</strong> CPU 在响应中断时，硬件会自动将关键状态（如程序计数器、标志寄存器等）压入栈中，但这不被视为传递给 ISR 的参数。ISR 需要的信息（如哪个设备引发的中断、中断状态寄存器值）通常通过：<ul>
<li><strong>查询共享数据结构：</strong> 操作系统内核维护的数据结构（如中断向量表、设备状态寄存器）。</li>
<li><strong>隐式约定：</strong> 某些架构或驱动程序框架可能有约定，将特定寄存器或内存位置用于传递中断源信息。</li>
</ul>
</li>
<li><strong>返回值：</strong> <strong>通常没有显式的返回值给调用者（即中断机制本身）。</strong> ISR 的主要职责是快速处理事件、清除中断标志、进行必要的数据操作（如将接收到的数据放入缓冲区、更新状态），然后返回。它的“结果”体现在它对系统状态（共享内存、队列、标志位）的修改上。ISR 执行完毕后，CPU 恢复之前被中断的上下文继续执行。</li>
<li><strong>关键点：</strong> ISR 需要<strong>极其高效</strong>和<strong>可重入</strong>（可能被更高优先级中断打断）。显式的参数传递和返回通常开销过大且复杂，不符合这些要求。</li>
</ul>
</li>
<li>
<p><strong>软件中断 / 系统调用 (通过 <code>int</code> 指令或类似机制):</strong></p>
<ul>
<li><strong>参数：</strong> <strong>有明确的参数传递机制。</strong> 用户程序在触发软件中断（如 Linux 的 <code>int 0x80</code> 或 <code>syscall</code> 指令）之前，会按照操作系统规定的<strong>调用约定</strong>（Calling Convention）将系统调用号（标识要执行哪个服务）和所需的参数放入特定的<strong>寄存器</strong>或<strong>栈</strong>中。</li>
<li><strong>返回值：</strong> <strong>有明确的返回值机制。</strong> 操作系统内核处理完系统调用后，会按照调用约定将结果（成功/失败、数据、错误码）放入特定的<strong>寄存器</strong>（通常是 EAX/RAX）或<strong>栈</strong>中，供用户程序在中断返回后读取。</li>
<li><strong>关键点：</strong> 这里的软件中断是<strong>用户态程序主动请求内核服务</strong>的一种方式。参数和返回值的传递遵循清晰定义的 ABI（应用二进制接口），类似于普通函数调用，但跨越了用户态/内核态的边界。</li>
</ul>
</li>
<li>
<p><strong>信号处理程序 (类 Unix 系统中的异步事件通知):</strong></p>
<ul>
<li><strong>参数：</strong> <strong>有一个标准化的参数（信号编号 <code>signum</code>）。</strong> 当信号被递送给进程时，操作系统在调用用户注册的信号处理函数时，会传递一个整数参数，表示<strong>是哪个信号</strong>（如 <code>SIGINT</code>, <code>SIGSEGV</code>）。某些信号（如 <code>SIGSEGV</code>, <code>SIGILL</code>）可能有额外的上下文信息（通过 <code>siginfo_t</code> 结构体和第三个 <code>ucontext_t</code> 参数），但这需要特定的设置 (<code>SA_SIGINFO</code> 标志)。</li>
<li><strong>返回值：</strong> <strong>没有显式返回值 (<code>void</code>)。</strong> 信号处理函数通过修改全局状态、设置标志位或调用如 <code>_exit()</code>、 <code>longjmp()</code> 等函数来影响进程行为。</li>
<li><strong>关键点：</strong> 信号处理函数类似于异步的 ISR，执行时机不确定，需要遵守特定的限制（异步信号安全函数）。</li>
</ul>
</li>
</ol>
<p><strong>总结对比：</strong></p>
<table>
<thead>
<tr>
<th style="text-align: left;">中断类型/处理程序</th>
<th style="text-align: left;">是否有参数？</th>
<th style="text-align: left;">是否有返回值？</th>
<th style="text-align: left;">主要目的</th>
<th style="text-align: left;">参数/返回值传递方式</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>中断机制本身</strong></td>
<td style="text-align: left;"><strong>❌ 无</strong></td>
<td style="text-align: left;"><strong>❌ 无</strong></td>
<td style="text-align: left;">事件通知，强制切换执行流</td>
<td style="text-align: left;">N/A</td>
</tr>
<tr>
<td style="text-align: left;"><strong>硬件 ISR</strong></td>
<td style="text-align: left;"><strong>❌ 无显式参数</strong></td>
<td style="text-align: left;"><strong>❌ 无显式返回值</strong></td>
<td style="text-align: left;">快速响应硬件事件</td>
<td style="text-align: left;">通过查询寄存器/共享内存获取信息</td>
</tr>
<tr>
<td style="text-align: left;"><strong>软件中断 (系统调用)</strong></td>
<td style="text-align: left;"><strong>✅ 有 (系统调用号 + 参数)</strong></td>
<td style="text-align: left;"><strong>✅ 有 (结果/错误码)</strong></td>
<td style="text-align: left;">用户程序请求内核服务</td>
<td style="text-align: left;">遵循调用约定 (寄存器/栈)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>信号处理程序</strong></td>
<td style="text-align: left;"><strong>✅ 有 (信号编号 <code>signum</code>)</strong></td>
<td style="text-align: left;"><strong>❌ 无显式返回值 (<code>void</code>)</strong></td>
<td style="text-align: left;">处理进程收到的异步事件通知 (如 Ctrl+C)</td>
<td style="text-align: left;">操作系统传递信号编号 (可能还有上下文)</td>
</tr>
</tbody>
</table>
<p><strong>简单来说：</strong></p>
<ul>
<li>“中断”这个<strong>事件</strong>本身没有参数和返回值。</li>
<li>响应中断而执行的<strong>处理代码（ISR、系统调用处理函数、信号处理函数）</strong> 可以有参数和返回值，但其传递和使用方式<strong>与普通函数调用截然不同</strong>，并且受到严格限制（尤其是硬件 ISR 和信号处理函数）。</li>
</ul>
<h2 id="stm32-hal">STM32 HAL库中断例子</h2>
<p>理解 <code>HAL_UART_Receive_IT()</code> 和 <code>HAL_UART_Transmit_IT()</code> 的关键在于 <strong>非阻塞操作</strong> 和 <strong>中断驱动</strong>。它们不是直接收发数据的函数，而是启动一个由中断驱动的收发过程。让我一步步拆解：</p>
<h3 id="1_2">1. 核心概念：非阻塞与中断驱动</h3>
<ul>
<li><strong>非阻塞：</strong> 当你调用这些函数时，它们<strong>不会等待</strong>数据传输完成才返回。它们只是告诉UART硬件：“准备好后，开始接收/发送这些数据，完成后用中断通知我”。函数本身会立即返回到你的主程序（或其他代码），让你可以同时做其他事情。</li>
<li><strong>中断驱动：</strong> 数据传输的实际过程（每个字节的发送或接收）是由 <strong>硬件中断</strong> 来管理和推进的。UART硬件在特定事件发生时（比如发送寄存器空了可以放新数据了，或者接收寄存器收到新数据了）会触发中断。中断服务程序会处理这些事件。</li>
</ul>
<h3 id="2_3">2. 函数详解</h3>
<h4 id="hal_uart_receive_ituart_handletypedef-huart-uint8_t-pdata-uint16_t-size"><code>HAL_UART_Receive_IT(UART_HandleTypeDef *huart, uint8_t *pData, uint16_t Size)</code></h4>
<ul>
<li><strong>作用：</strong> 启动一个 <strong>非阻塞的接收过程</strong>。</li>
<li><strong>参数：</strong><ul>
<li><code>huart</code>: 指向UART外设句柄的指针（包含配置信息）。</li>
<li><code>pData</code>: 指向 <strong>用户提供的缓冲区</strong> 的指针。接收到的数据将被存放到这里。</li>
<li><code>Size</code>: 你想要接收的 <strong>字节总数</strong>。</li>
</ul>
</li>
<li><strong>内部操作：</strong><ol>
<li>函数内部会记录你提供的缓冲区地址 (<code>pData</code>) 和要接收的总字节数 (<code>Size</code>)。</li>
<li>设置一个内部计数器（通常叫 <code>RxXferCount</code>）为 <code>Size</code>。</li>
<li><strong>关键一步：</strong> 使能UART的 <strong>RXNE (Receive register Not Empty) 中断</strong>。这意味着当UART接收寄存器收到一个字节（不再是空的）时，就会触发中断。</li>
<li>函数<strong>立即返回</strong> <code>HAL_OK</code>（如果参数有效），表示接收过程已启动。此时你的主程序可以继续执行其他任务。</li>
</ol>
</li>
<li><strong>中断触发时机与处理：</strong><ul>
<li><strong>触发条件：</strong> UART硬件接收到<strong>一个字节</strong>的数据，将其放入接收数据寄存器 (RDR)，并设置 RXNE 标志。</li>
<li><strong>中断服务程序执行：</strong><ol>
<li>硬件检测到 RXNE 标志且 RXNE 中断使能，触发 UART 全局中断。</li>
<li>CPU 跳转到 UART 的 <strong>中断服务程序 (ISR)</strong>，通常是 <code>USARTx_IRQHandler()</code>。</li>
<li>ISR 内部会调用 HAL 库的 <code>HAL_UART_IRQHandler(&amp;huartX)</code>。</li>
<li><code>HAL_UART_IRQHandler</code> 检查中断源。发现是 RXNE 中断，于是：<ul>
<li>从 UART 的 RDR 寄存器读取<strong>一个字节</strong>。</li>
<li>将这个字节放入你之前通过 <code>HAL_UART_Receive_IT</code> 提供的缓冲区 (<code>pData</code>) 的<strong>当前位置</strong>。</li>
<li>递增缓冲区指针 (<code>pData++</code>)。</li>
<li>递减内部接收计数器 (<code>RxXferCount--</code>)。</li>
<li>检查计数器：如果 <code>RxXferCount &gt; 0</code>：<ul>
<li>等待下一个字节的到来（RXNE 中断保持使能，过程会重复）。</li>
</ul>
</li>
<li>如果 <code>RxXferCount == 0</code>：<ul>
<li><strong>关键一步：</strong> <strong>关闭 RXNE 中断</strong>（因为目标字节数已收到）。</li>
<li>调用 <strong>接收完成回调函数</strong> <code>HAL_UART_RxCpltCallback(huart)</code>。</li>
</ul>
</li>
</ul>
</li>
</ol>
</li>
</ul>
</li>
<li><strong>用户需要做什么：</strong><ul>
<li>提供足够大的缓冲区 (<code>pData</code>) 来存放 <code>Size</code> 个字节。</li>
<li>在代码中 <strong>实现接收完成回调函数</strong> <code>void HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart)</code>。这是你知道接收完成并处理数据的地方！在这个函数里，你可以解析收到的数据、置标志位通知主程序、或者启动下一次接收等。</li>
<li>确保全局中断和UART接收中断是使能的（通常在CubeMX生成的初始化代码里已经做了）。</li>
</ul>
</li>
</ul>
<h4 id="hal_uart_transmit_ituart_handletypedef-huart-uint8_t-pdata-uint16_t-size"><code>HAL_UART_Transmit_IT(UART_HandleTypeDef *huart, uint8_t *pData, uint16_t Size)</code></h4>
<ul>
<li><strong>作用：</strong> 启动一个 <strong>非阻塞的发送过程</strong>。</li>
<li><strong>参数：</strong><ul>
<li><code>huart</code>: 指向UART外设句柄的指针。</li>
<li><code>pData</code>: 指向 <strong>包含待发送数据</strong> 的用户缓冲区的指针。</li>
<li><code>Size</code>: 你想要发送的 <strong>字节总数</strong>。</li>
</ul>
</li>
<li><strong>内部操作：</strong><ol>
<li>函数内部记录缓冲区地址 (<code>pData</code>) 和要发送的总字节数 (<code>Size</code>)。</li>
<li>设置内部发送计数器 (<code>TxXferCount</code>) 为 <code>Size</code>。</li>
<li><strong>关键一步：</strong> 使能UART的 <strong>TXE (Transmit register Empty) 中断</strong>。这意味着当UART发送数据寄存器 (TDR) <strong>空了</strong>（可以放入下一个字节）时，就会触发中断。<em>(注意：有些UART也可能使用 TC (Transmission Complete) 中断来处理最后一个字节的完成事件，但TXE中断是驱动发送过程的核心)</em></li>
<li>函数<strong>立即返回</strong> <code>HAL_OK</code>（如果参数有效），表示发送过程已启动。</li>
</ol>
</li>
<li><strong>中断触发时机与处理：</strong><ul>
<li><strong>触发条件：</strong> UART硬件将TDR寄存器里的一个字节移入发送移位寄存器，此时TDR<strong>变空</strong>，并设置 TXE 标志。</li>
<li><strong>中断服务程序执行：</strong><ol>
<li>硬件检测到 TXE 标志且 TXE 中断使能，触发 UART 全局中断。</li>
<li>CPU 跳转到 UART 的 ISR (<code>USARTx_IRQHandler</code>)。</li>
<li>ISR 调用 <code>HAL_UART_IRQHandler(&amp;huartX)</code>。</li>
<li><code>HAL_UART_IRQHandler</code> 检查中断源。发现是 TXE 中断，于是：<ul>
<li>检查内部发送计数器 (<code>TxXferCount &gt; 0</code>？)</li>
<li>如果 <code>TxXferCount &gt; 0</code>：<ul>
<li>从你之前通过 <code>HAL_UART_Transmit_IT</code> 提供的缓冲区 (<code>pData</code>) 的<strong>当前位置</strong>取出<strong>一个字节</strong>。</li>
<li>将这个字节写入 UART 的 TDR 寄存器（硬件会自动将其发送出去）。</li>
<li>递增缓冲区指针 (<code>pData++</code>)。</li>
<li>递减内部发送计数器 (<code>TxXferCount--</code>)。</li>
<li><em>(TXE 中断保持使能，当下一个字节导致TDR再次变空时，中断会再次触发，重复此过程)</em></li>
</ul>
</li>
<li>如果 <code>TxXferCount == 0</code> (所有字节都已放入TDR)：<ul>
<li><strong>关键一步：</strong> <strong>关闭 TXE 中断</strong>（因为没数据要发了）。</li>
<li><strong>可选但常见：</strong> 使能 <strong>TC (Transmission Complete) 中断</strong>。TC 中断在<strong>最后一个字节</strong>从移位寄存器<strong>完全移出</strong>（包括停止位）时触发。当 TC 中断发生时：<ul>
<li><code>HAL_UART_IRQHandler</code> 检测到 TC 中断。</li>
<li>关闭 TC 中断。</li>
<li>调用 <strong>发送完成回调函数</strong> <code>HAL_UART_TxCpltCallback(huart)</code>。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ol>
</li>
</ul>
</li>
<li><strong>用户需要做什么：</strong><ul>
<li>提供包含有效数据的缓冲区 (<code>pData</code>)，长度至少为 <code>Size</code>。</li>
<li>在代码中 <strong>实现发送完成回调函数</strong> <code>void HAL_UART_TxCpltCallback(UART_HandleTypeDef *huart)</code>。这是你知道整个数据块已<strong>物理发送完成</strong>的地方（如果启用了TC中断）。你可以在这里释放缓冲区、启动下一次发送、通知其他任务等。</li>
<li>确保全局中断和UART发送中断(TXE/TC)是使能的。</li>
</ul>
</li>
</ul>
<h3 id="3_2">3. 中断触发时机总结</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">函数</th>
<th style="text-align: left;">启动时使能的中断</th>
<th style="text-align: left;">触发该中断的硬件条件</th>
<th style="text-align: left;">中断服务程序中的关键动作</th>
<th style="text-align: left;">完成时调用的回调函数</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>HAL_UART_Receive_IT</code></td>
<td style="text-align: left;"><strong>RXNE</strong></td>
<td style="text-align: left;"><strong>接收寄存器非空</strong> (收到一个字节)</td>
<td style="text-align: left;">从RDR读1字节 -&gt; 存入用户缓冲区 -&gt; 计数器减1 -&gt; 若收完则关中断回调</td>
<td style="text-align: left;"><code>HAL_UART_RxCpltCallback</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>HAL_UART_Transmit_IT</code></td>
<td style="text-align: left;"><strong>TXE</strong></td>
<td style="text-align: left;"><strong>发送寄存器变空</strong> (可以放下一个字节了)</td>
<td style="text-align: left;">从用户缓冲区取1字节 -&gt; 写入TDR -&gt; 计数器减1 -&gt; 若发完则关TXE开TC</td>
<td style="text-align: left;"><code>HAL_UART_TxCpltCallback</code> (由TC中断触发)</td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: left;">(后续) <strong>TC</strong></td>
<td style="text-align: left;"><strong>发送移位寄存器变空</strong> (最后一个字节发完)</td>
<td style="text-align: left;">关TC中断 -&gt; 调用发送完成回调</td>
<td style="text-align: left;"><code>HAL_UART_TxCpltCallback</code></td>
</tr>
</tbody>
</table>
<h3 id="4_1">4. 何时使用它们？</h3>
<ul>
<li>当你需要 <strong>异步操作</strong>，不想让CPU死等UART传输完成时（避免阻塞主循环）。</li>
<li>当数据传输需要一定时间（尤其是低速波特率或大数据量），你想让CPU在这段时间处理其他任务时。</li>
<li>当你需要 <strong>及时响应</strong> 接收到的数据时（通过RXNE中断和回调）。</li>
</ul>
<h3 id="5">5. 注意事项</h3>
<ul>
<li><strong>回调函数：</strong> 这是你处理完成事件的核心！<strong>必须在你的用户代码中实现它们</strong>。HAL库提供了弱定义的空函数 <code>__weak void HAL_UART_xxxCpltCallback(...)</code>，你需要重写它们。</li>
<li><strong>缓冲区生命周期：</strong> 传递给 <code>xxx_IT</code> 函数的缓冲区 (<code>pData</code>) 必须在该次传输完成（回调被调用）之前保持有效（通常是全局变量、静态变量或动态分配的内存）。不能在传输过程中释放或覆盖。</li>
<li><strong>中断使能：</strong> 确保在初始化UART时，相应的中断（USART全局中断、RXNE/TXE/TC中断）已经在NVIC（嵌套向量中断控制器）中使能。CubeMX通常会帮你配置好。</li>
<li><strong>重入问题：</strong> 不要在传输/接收尚未完成时（即回调被调用之前）再次调用同一个UART的 <code>HAL_UART_xxx_IT</code> 函数来启动新的传输/接收。否则会破坏内部状态（缓冲区指针、计数器）。等待回调完成后再启动下一次。</li>
<li><strong>错误处理：</strong> 同样存在错误回调函数 <code>HAL_UART_ErrorCallback</code>，用于处理帧错误、噪声错误、溢出错误等。建议实现它。</li>
</ul>
<h3 id="receive_it">流程图示意 (以 Receive_IT 为例)</h3>
<div class="highlight"><pre><span></span><code>+---------------------+      +-----------------------+      +-----------------------+
| Your Main Program   |      | UART Hardware         |      | Interrupt Service    |
|                     |      |                       |      | Routine (ISR) &amp; HAL  |
+----------+----------+      +-----------+-----------+      +-----------+-----------+
           |                             |                            ^ |
           | Call                        |                            | |
           | HAL_UART_Receive_IT(...)    |                            | |
           |---------------------------&gt; |                            | |
           |                             |                            | |
           | (Returns immediately)       | Enable RXNE Interrupt      | |
           | &lt;---------------------------|                            | |
           |                             |                            | |
           | Do other work...            |                            | |
           |                             |                            | |
           |                             | Receive 1 byte -&gt; Set RXNE | |
           |                             |---------------------------&gt; |
           |                             |                            | |
           |                             |                            | Check RXNE Int
           |                             |                            | Read byte from RDR
           |                             |                            | Store byte in *pData
           |                             |                            | pData++, RxXferCount--
           |                             |                            | Is RxXferCount == 0?
           |                             |                            |    | No: Keep RXNE Int on
           |                             |                            |    |     (wait next byte)
           |                             |                            |    |
           |                             |                            |    | Yes: Disable RXNE Int
           |                             |                            |    | Call HAL_UART_RxCpltCallback
           |                             |                            |    |----------------------&gt; (Your Code!)
           |                             |                            | &lt;-------------------------+
           | &lt; - - - - - - - - - - - - - - - - - - - - - - - - - - - - (Callback runs)
           | (Your program is notified)  |                            | |
           |                             |                            | |
</code></pre></div>
<p><strong>简单来说：</strong></p>
<ol>
<li>你调用 <code>Receive_IT</code> / <code>Transmit_IT</code> <strong>启动</strong>过程并<strong>使能中断</strong>。</li>
<li><strong>硬件</strong>在数据到来(TX空/RX有数据)时<strong>触发中断</strong>。</li>
<li><strong>中断服务程序</strong> 处理单个字节（存/取），更新指针和计数器。</li>
<li>当<strong>所有字节完成</strong>，中断服务程序<strong>关闭中断</strong>并<strong>调用你的回调函数</strong>通知你。</li>
<li>你的<strong>回调函数</strong>处理完成事件（如处理收到的数据、准备下次发送）。</li>
</ol>
<p>理解了中断使能、中断触发条件、中断服务程序的动作以及回调函数的角色，就能清晰掌握这两个函数的工作机制了。</p>
<p><img alt="img" src="pic/mermaid-202568%20172451.png" /></p>
<h2 id="_13">中断服务程序中为什么不能进行调度？</h2>
<blockquote>
<p>为什么中断中不能调用一些互斥锁，sleep的？核心原因？底层原理？会导致任务挂起，但中断上下文没有进程调度信息，无法恢复。但是为什么会导致这个？？为什么没有？为什么不能有？调度信息怎么什么？和进程相关的？具体是什么信息！要具体！才能真正搞清楚问题！</p>
</blockquote>
<p>非常好！这是一个触及操作系统内核核心设计的深刻问题。你问到了点子上，仅仅知道“不能做”是不够的，必须深入其“所以然”。你的思考方向完全正确——问题的根源就在于<strong>中断上下文与进程上下文根本性的差异</strong>，以及调度器赖以工作的<strong>数据结构</strong>。</p>
<p>我们将层层剥茧，彻底搞清楚这个问题。</p>
<h3 id="_14">核心原因：一句话概括</h3>
<p><strong>因为中断上下文不是一个进程（或线程），它没有与之关联的 <code>task_struct</code> 结构体（进程控制块 PCB），而所有调度、阻塞、睡眠操作都完全依赖于当前进程的 <code>task_struct</code>。</strong></p>
<hr />
<h3 id="_15">底层原理详解</h3>
<h4 id="1-vs">1. 两种上下文：中断上下文 vs. 进程上下文</h4>
<ul>
<li>
<p><strong>进程上下文 (Process Context)</strong>：</p>
<ul>
<li><strong>身份</strong>： 内核代表一个进程执行操作（例如，执行系统调用）。内核在替进程“打工”。</li>
<li><strong>可调度性</strong>： 可以被调度。在任何时刻，只要条件允许（比如时间片用完、主动睡眠），内核就可以暂停当前进程的执行，切换到另一个进程。</li>
<li><strong>资源</strong>： 拥有完整的进程资源信息，最主要的就是 <code>task_struct</code>。它包含了进程的所有元数据：PID、优先级、内存映射、打开的文件、信号处理、内核栈、<strong>调度状态（<code>state</code>）</strong>、<strong>调度队列</strong>等。</li>
</ul>
</li>
<li>
<p><strong>中断上下文 (Interrupt Context)</strong>：</p>
<ul>
<li><strong>身份</strong>： 内核代表硬件执行操作。是硬件在“中断”CPU，让内核赶紧来处理一个紧急事件。</li>
<li><strong>可调度性</strong>： <strong>绝对不可调度</strong>。中断处理需要尽快完成，以便恢复被中断代码的执行。它拥有最高的优先级。</li>
<li><strong>资源</strong>： <strong>没有 <code>task_struct</code></strong>！它只是“借道”执行，借用当前<strong>被中断的进程</strong>的内核栈的一小部分空间来运行。它不知道自己是谁，它只知道自己正在处理哪个中断。</li>
</ul>
</li>
</ul>
<h4 id="2-task_struct">2. 调度信息的核心：<code>task_struct</code> 里具体是什么？</h4>
<p>你问得非常对，“调度信息”到底是什么？它不是一个模糊的概念，而是实实在在存储在 <code>task_struct</code> 里的字段。主要包括：</p>
<ul>
<li><code>state</code>: 明确记录进程的<strong>当前状态</strong>。例如：<ul>
<li><code>TASK_RUNNING</code> (可运行)</li>
<li><code>TASK_INTERRUPTIBLE</code> (可中断的睡眠，等待信号或资源)</li>
<li><code>TASK_UNINTERRUPTIBLE</code> (不可中断的睡眠，通常等待磁盘I/O等)</li>
<li><code>TASK_STOPPED</code> (暂停)</li>
<li><code>TASK_ZOMBIE</code> (僵尸)</li>
<li><strong>当调用 <code>sleep()</code> 时，核心操作就是设置 <code>current-&gt;state = TASK_INTERRUPTIBLE</code>（或其它睡眠状态）。</strong></li>
</ul>
</li>
<li><code>thread_info</code> / <code>flags</code>: 包含底层CPU状态信息，如寄存器快照。</li>
<li><code>pid</code> / <code>tgid</code>: 进程和线程组ID。</li>
<li><code>prio</code>， <code>static_prio</code>， <code>normal_prio</code>: 各种优先级，调度器据此决定运行哪个进程。</li>
<li><code>sched_class</code>: 指向所属调度类（如公平调度 <code>fair_sched_class</code>，实时调度 <code>rt_sched_class</code>）。</li>
<li><code>se</code> (调度实体): 在调度器队列中的节点，包含虚拟运行时间（vruntime）、权重等信息，用于CFS调度算法。</li>
<li><code>stack</code>: 指向内核栈的指针。</li>
<li><code>tasks</code>: 列表头，用于将进程链接到各种内核链表（如就绪队列、等待队列）。</li>
</ul>
<p><strong>关键点：</strong> 当一个进程要睡眠时，调度器会：
1.  将其 <code>state</code> 改为非 <code>TASK_RUNNING</code>。
2.  将其从<strong>就绪队列</strong>中移除。
3.  将其加入到另一个<strong>等待队列</strong>（比如等待某个锁释放的队列）。
4.  然后调用 <code>schedule()</code> 函数选择下一个进程运行。
5.  在未来的某个时刻（比如锁被释放了），另一个进程会将其 <code>state</code> 改回 <code>TASK_RUNNING</code> 并重新放回<strong>就绪队列</strong>，这样它才有机会再次被调度。</p>
<h4 id="3-sleep">3. 为什么中断中调用 <code>sleep()</code> 或互斥锁会崩溃？</h4>
<p>现在我们把两者结合起来看：</p>
<ol>
<li><strong>场景</strong>： 进程A正在运行 -&gt; 网卡产生中断 -&gt; CPU跳转到中断处理程序执行。</li>
<li><strong>在中断处理程序中</strong>，代码调用了 <code>mutex_lock(&amp;my_lock)</code>，但此时锁被进程B持有。</li>
<li><strong>如果允许阻塞</strong>，中断处理程序应该做什么？<ul>
<li>它需要将<strong>当前执行体</strong>的状态改为睡眠，并加入等待队列。</li>
<li><strong>但“当前执行体”是谁？</strong> 是中断本身吗？它没有 <code>task_struct</code>，无法设置状态，也无法加入队列。</li>
<li>那是<strong>被中断的进程A</strong>吗？如果把进程A的状态改为睡眠，那么中断返回后，进程A就会被挂起。<strong>这导致了极其严重的问题：</strong><ul>
<li><strong>进程A莫名其妙睡了</strong>： 进程A的代码可能根本不知道这个锁的存在，它只是在正常执行，被中断打断了一下，然后就再也不会被调度了。这完全是错误的。</li>
<li><strong>破坏性</strong>： 中断是异步的，它可以打断任何进程。如果中断处理程序可以随意修改被中断进程的状态，那整个系统的稳定性将荡然无存。一个高优先级的实时进程可能因为一个无关的中断处理程序等锁而被睡眠，彻底违背了调度策略。</li>
<li><strong>可能永远无法唤醒</strong>： 即使锁被释放了，谁会去唤醒“中断上下文”呢？等待队列上挂的是进程A，但进程A并不是真的在等这个锁。唤醒操作无法正确进行。</li>
</ul>
</li>
</ul>
</li>
<li><strong>调用 <code>sleep()</code> 同理</strong>：<code>sleep(n)</code> 的期望是“让<strong>当前进程</strong>睡眠n秒”。但在中断上下文中，“当前进程”是被中断的进程。让一个无关的进程去睡眠，后果是灾难性的。</li>
</ol>
<h4 id="4-task_struct">4. 为什么中断上下文不能有 <code>task_struct</code>？为什么不能有？</h4>
<p>这是一个设计哲学问题，是为了保证操作系统的<strong>响应速度</strong>、<strong>简单性</strong>和<strong>稳定性</strong>。</p>
<ol>
<li><strong>中断的使命是“快”</strong>： 硬件中断是来通知紧急事件的（例如网卡收到了数据包、磁盘完成了IO）。处理必须迅速，以便能继续响应新的中断。如果中断处理程序本身又去睡眠、等锁，会导致中断被长时间关闭，其他硬件事件无法被处理，可能造成数据丢失或系统无响应。</li>
<li><strong>简化设计</strong>： 中断是“突如其来”的，它不应该与复杂的进程调度和阻塞耦合在一起。将它们分离，使得中断管理和进程管理两个子系统变得清晰和简单。</li>
<li><strong>避免递归和死锁</strong>： 想象一下，如果中断有 <code>task_struct</code> 并能被调度，那么它在等锁时可能被切换出去。切换过程中可能又来了新的中断，这会导致极其复杂的嵌套和难以调试的死锁问题。禁止中断上下文睡眠从根本上杜绝了这类问题。</li>
</ol>
<p><strong>所以，不是“不能有”，而是操作系统设计者“故意不让它有”。这是一种经过深思熟虑的、牺牲灵活性来换取极致可靠性和性能的设计选择。</strong></p>
<h3 id="_16">总结与类比</h3>
<ul>
<li><strong>进程</strong>就像公司的<strong>正式员工</strong>。每个员工都有完整的人事档案（<code>task_struct</code>），可以派他出去出差（调度出去），也可以让他先等着，处理别的事（睡眠），然后再叫他回来（调度回来）。</li>
<li><strong>中断</strong>就像是一个<strong>火警警报</strong>。警报响起时，所有员工（进程）都要立刻停下手中的工作，让专业的消防员（中断处理程序）来处理。<ul>
<li>消防员的使命是：<strong>最快速度处理火情，然后消失</strong>，让一切恢复原样。</li>
<li>你绝对不希望消防员在处理火情时，说：“我先睡一觉”或者“这个灭火器被锁在柜子里了，我站在这里等钥匙送来”。他必须用现有的资源（原子操作、自旋锁）立即解决问题，或者如果问题太复杂（需要睡眠），就记录下来，交给后续的员工（下半部/线程）来处理，然后自己立刻撤离。</li>
</ul>
</li>
</ul>
<p>因此，在Linux内核中，解决中断中处理复杂任务的方法是：
*   <strong>上半部 (Top Half)</strong>： 中断处理程序本身，只做最紧急、不可延迟的工作（通常是确认中断和拷贝数据），通常用<strong>自旋锁</strong>来保护共享资源（因为自旋锁不会睡眠）。
*   <strong>下半部 (Bottom Half)</strong>： 如软中断(softirq)、 tasklets、工作队列(workqueue)。尤其是<strong>工作队列</strong>，它是在进程上下文中执行的，<strong>拥有完整的 <code>task_struct</code></strong>，因此可以安全地调用 <code>mutex_lock()</code>, <code>sleep()</code> 等所有可能阻塞的函数。</p>
<h2 id="_17">中断线程化和中断上下半部？</h2>
<p>一个是模型，一个是具体的方法</p>
<h2 id="todo">TODO</h2>
<h2 id="todo_1">TODO</h2>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class="timeago" datetime="2025-10-08T18:45:41+02:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2025-10-08</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class="timeago" datetime="2025-05-04T12:12:33+02:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2025-05-04</span>
  </span>

    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="https://github.com/JAILuo" target="_blank" rel="noopener" title="JAILuo" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.footer"], "search": "../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.83f73b43.min.js"></script>
      
        <script src="../js/timeago.min.js"></script>
      
        <script src="../js/timeago_mkdocs_material.js"></script>
      
        <script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
      
    
  </body>
</html>