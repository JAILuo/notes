
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://jailuo.github.io/notes/interview/notes/operating-system/os.html">
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.48">
    
    
      
        <title>Os - Messy Notes</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.6f8fc17f.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../css/timeago.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../index.html" title="Messy Notes" class="md-header__button md-logo" aria-label="Messy Notes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Messy Notes
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Os
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256l137.3-137.4c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/JAILuo/notes" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../index.html" title="Messy Notes" class="md-nav__button md-logo" aria-label="Messy Notes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Messy Notes
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/JAILuo/notes" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../index.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    é¦–é¡µ
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Article
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Article
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="/article/concurrency sumary/summary.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    concurrency-summary
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="/article/toolchain/toolchain.mc" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    toolchain
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="/article/mount/mount.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mount
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Course
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Course
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    University Course
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            University Course
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1_1" id="__nav_3_1_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    jyy OS2024
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_1">
            <span class="md-nav__icon md-icon"></span>
            jyy OS2024
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_1_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1_1_1" id="__nav_3_1_1_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    course note
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_3_1_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_1_1">
            <span class="md-nav__icon md-icon"></span>
            course note
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Course/University%20Course/jyy%20OS2024/cousre%20note/1.%20introduction/introduction.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    introduction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Course/University%20Course/jyy%20OS2024/cousre%20note/2.%20concurrency/concurrency.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    concurrency
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Course/University%20Course/jyy%20OS2024/cousre%20note/3.%20virtualization/virtualization.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    virtualization
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Course/University%20Course/jyy%20OS2024/cousre%20note/4.%20kernel/kernel.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    kernel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Course/University%20Course/jyy%20OS2024/cousre%20note/5.%20persistence/persistence.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    persistence
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_1_2" >
        
          
          <label class="md-nav__link" for="__nav_3_1_1_2" id="__nav_3_1_1_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Mini Labs
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_3_1_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_1_2">
            <span class="md-nav__icon md-icon"></span>
            Mini Labs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Course/University%20Course/jyy%20OS2024/Mini%20Labs/M1/M1.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    M1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Course/University%20Course/jyy%20OS2024/Mini%20Labs/M2/M2.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    M2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Course/University%20Course/jyy%20OS2024/Mini%20Labs/M3/M3.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    M3
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_1_3" >
        
          
          <label class="md-nav__link" for="__nav_3_1_1_3" id="__nav_3_1_1_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    OS Labs
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_3_1_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_1_3">
            <span class="md-nav__icon md-icon"></span>
            OS Labs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Course/University%20Course/jyy%20OS2024/OS%20Labs/L0/L0.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    L0
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Course/University%20Course/jyy%20OS2024/OS%20Labs/L1/L1.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    L1
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    GeekTime
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            GeekTime
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2_1" >
        
          
          <label class="md-nav__link" for="__nav_3_2_1" id="__nav_3_2_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    æ·±å…¥ç†è§£è®¡ç®—æœºç»„æˆåŸç†
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2_1">
            <span class="md-nav__icon md-icon"></span>
            æ·±å…¥ç†è§£è®¡ç®—æœºç»„æˆåŸç†
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Course/GeekTime/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/%E4%B8%80%E5%91%A8%E7%9B%AE/1.%20%E6%8C%87%E4%BB%A4%E4%B8%8E%E8%BF%90%E7%AE%97/%E6%8C%87%E4%BB%A4%E4%B8%8E%E8%BF%90%E7%AE%97.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1. æŒ‡ä»¤ä¸è¿ç®—
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Course/GeekTime/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/%E4%B8%80%E5%91%A8%E7%9B%AE/2.%20%E5%A4%84%E7%90%86%E5%99%A8/%E5%A4%84%E7%90%86%E5%99%A8.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2. å¤„ç†å™¨
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Course/GeekTime/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/%E4%B8%80%E5%91%A8%E7%9B%AE/3.%20%E5%AD%98%E5%82%A8%E4%B8%8EIO%E7%B3%BB%E7%BB%9F/%E5%AD%98%E5%82%A8%E4%B8%8EIO%E7%B3%BB%E7%BB%9F.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3. å­˜å‚¨ä¸IOç³»ç»Ÿ
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Course/GeekTime/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/%E4%B8%80%E5%91%A8%E7%9B%AE/4.%20%E5%BA%94%E7%94%A8/%E5%BA%94%E7%94%A8.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4. åº”ç”¨
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2_2" id="__nav_3_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    è®¡ç®—åŸºç¡€å®æˆ˜è¯¾
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2_2">
            <span class="md-nav__icon md-icon"></span>
            è®¡ç®—åŸºç¡€å®æˆ˜è¯¾
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Course/GeekTime/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80%E5%AE%9E%E6%88%98%E8%AF%BE/1.%20MiniCPU%E8%AE%BE%E8%AE%A1/MiniCPU%E8%AE%BE%E8%AE%A1.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1. MiniCPUè®¾è®¡
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Course/GeekTime/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80%E5%AE%9E%E6%88%98%E8%AF%BE/2.%20%E8%AF%AD%E8%A8%80%E5%92%8C%E6%8C%87%E4%BB%A4/%E8%AF%AD%E8%A8%80%E5%92%8C%E6%8C%87%E4%BB%A4.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2. è¯­è¨€å’ŒæŒ‡ä»¤
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Course/GeekTime/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80%E5%AE%9E%E6%88%98%E8%AF%BE/3.%20%E5%BA%94%E7%94%A8%E5%92%8C%E5%86%85%E5%AD%98/%E5%BA%94%E7%94%A8%E5%92%8C%E5%86%85%E5%AD%98.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3. åº”ç”¨å’Œå†…å­˜
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Course/GeekTime/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80%E5%AE%9E%E6%88%98%E8%AF%BE/4.%20IO%E4%B8%8E%E6%96%87%E4%BB%B6/IO%E5%92%8C%E6%96%87%E4%BB%B6.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4. IOä¸æ–‡ä»¶
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Course/GeekTime/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80%E5%AE%9E%E6%88%98%E8%AF%BE/5.%20%E7%BB%BC%E5%90%88%E5%BA%94%E7%94%A8/synthesis.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5. ç»¼åˆåº”ç”¨
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Course/GeekTime/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80%E5%AE%9E%E6%88%98%E8%AF%BE/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E5%92%8C%E5%B7%A5%E5%85%B7%E9%93%BE/%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ç¯å¢ƒé…ç½®å’Œå·¥å…·é“¾
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    ysyx
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            ysyx
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    NJU-ICS2023-PA
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            NJU-ICS2023-PA
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ysyx/pa/pa1/pa1.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PA1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ysyx/pa/pa2/pa2.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PA2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ysyx/pa/pa3/pa3.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PA3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ysyx/pa/pa4/pa4.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PA4
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ysyx/pa/c_marco/macro.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    C Macro
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ysyx/pa/summary/summary.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Summary
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ysyx/pa/Linux_porting/porting.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Linux Porting
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ysyx/digital-circuit/digital%20circuit.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Digital Circuit
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tools
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Tools
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tools/GDB/GDB.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GDB
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Vim
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            Vim
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tools/vim/usage/usage.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    usage
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tools/vim/vim-plugin/vim.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    vim-plugin
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tools/doxygen/doxygen.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    doxygen
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tools/gcc/gcc.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    gcc
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tools/Git/Git.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Git
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tools/md2slider/md2slider.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    md2slider
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Tools/tmux/tmux.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    tmux
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Todo%20List/todo.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TODO List
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      ä¸­æ–­çš„æ¦‚å¿µæµç¨‹å’Œç†è§£
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ä¸­æ–­çš„æ¦‚å¿µæµç¨‹å’Œç†è§£">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸ”’ æ ¸å¿ƒè§£å†³æ€è·¯
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸ› ï¸ å…·ä½“æ–¹æ¡ˆåŠä»£ç ç¤ºä¾‹
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ğŸ› ï¸ å…·ä½“æ–¹æ¡ˆåŠä»£ç ç¤ºä¾‹">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      1. å…³é—­ä¸­æ–­ï¼ˆæœ€å¸¸ç”¨ï¼‰
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-cpu" class="md-nav__link">
    <span class="md-ellipsis">
      2. åŸå­æ“ä½œï¼ˆä¾èµ– CPU æ”¯æŒï¼‰
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      3. æ— é”è®¾è®¡ï¼ˆé¿å…å…±äº«ï¼‰
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      âš ï¸ å…³é”®æ³¨æ„äº‹é¡¹
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸŒŸ æ€»ç»“
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      çº¿ç¨‹å®‰å…¨
    </span>
  </a>
  
    <nav class="md-nav" aria-label="çº¿ç¨‹å®‰å…¨">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸ”¥ å¤šæ ¸ç¯å¢ƒä¸‹çš„å¹¶å‘å®‰å…¨æŒ‘æˆ˜ä¸è§£å†³æ–¹æ¡ˆ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸ§  å¤šæ ¸åŒæ­¥æ ¸å¿ƒåŸç†
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ğŸ§  å¤šæ ¸åŒæ­¥æ ¸å¿ƒåŸç†">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-memory-order" class="md-nav__link">
    <span class="md-ellipsis">
      1. åŸå­æ“ä½œä¸å†…å­˜åºï¼ˆMemory Orderï¼‰
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      2. ç¼“å­˜ä¸€è‡´æ€§åè®®
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸ› ï¸ å¤šæ ¸åŒæ­¥æ–¹æ¡ˆå®ç°
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ğŸ› ï¸ å¤šæ ¸åŒæ­¥æ–¹æ¡ˆå®ç°">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-spinlock" class="md-nav__link">
    <span class="md-ellipsis">
      1. è‡ªæ—‹é”ï¼ˆSpinlockï¼‰
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-read-write-lock" class="md-nav__link">
    <span class="md-ellipsis">
      2. è¯»å†™é”ï¼ˆRead-Write Lockï¼‰
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-rcuread-copy-update" class="md-nav__link">
    <span class="md-ellipsis">
      3. RCUï¼ˆRead-Copy-Updateï¼‰
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-lock-free-queue" class="md-nav__link">
    <span class="md-ellipsis">
      4. æ— é”æ•°æ®ç»“æ„ï¼ˆLock-Free Queueï¼‰
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      âš¡ å¤šæ ¸åŒæ­¥æ€§èƒ½ä¼˜åŒ–æŠ€å·§
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸ›‘ å¤šæ ¸è°ƒè¯•ä¸éªŒè¯
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      ğŸ“Š å¤šæ ¸åŒæ­¥æ–¹æ¡ˆé€‰å‹è¡¨
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      âœ… å¤šæ ¸åŒæ­¥é»„é‡‘æ³•åˆ™
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      è¿›ç¨‹é—´é€šä¿¡
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      è¿›ç¨‹çº¿ç¨‹åŒºåˆ«
    </span>
  </a>
  
    <nav class="md-nav" aria-label="è¿›ç¨‹çº¿ç¨‹åŒºåˆ«">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_1" class="md-nav__link">
    <span class="md-ellipsis">
      1. æ ¸å¿ƒå®šä¹‰
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_1" class="md-nav__link">
    <span class="md-ellipsis">
      2. å…³é”®å·®å¼‚
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_1" class="md-nav__link">
    <span class="md-ellipsis">
      3. è®¾è®¡æ„ä¹‰ä¸åœºæ™¯
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-linux" class="md-nav__link">
    <span class="md-ellipsis">
      4. åº•å±‚å®ç°ï¼ˆä»¥Linuxä¸ºä¾‹ï¼‰
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    <span class="md-ellipsis">
      5. é«˜çº§æ‰©å±•
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#30" class="md-nav__link">
    <span class="md-ellipsis">
      æ€»ç»“å›ç­”ï¼ˆ30ç§’ç²¾ç®€ç‰ˆï¼‰
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      å…±äº«å†…å­˜çš„åŸç†
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#page-fault" class="md-nav__link">
    <span class="md-ellipsis">
      Page fault
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Page fault">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-page-fault" class="md-nav__link">
    <span class="md-ellipsis">
      1. Page Faultè§¦å‘æ¡ä»¶
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_2" class="md-nav__link">
    <span class="md-ellipsis">
      2. è§¦å‘ä¸å¤„ç†çš„è´£ä»»æ–¹
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_2" class="md-nav__link">
    <span class="md-ellipsis">
      3. å…¸å‹å¤„ç†åœºæ™¯
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    <span class="md-ellipsis">
      4. æ€§èƒ½è§‚æµ‹ä¸è°ƒè¯•
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5_1" class="md-nav__link">
    <span class="md-ellipsis">
      5. å…³é”®è®¾è®¡è€ƒé‡
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-rtos" class="md-nav__link">
    <span class="md-ellipsis">
      6. å¯¹æ¯”RTOSçš„ç‰¹æ®Šæ€§
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#risc-v" class="md-nav__link">
    <span class="md-ellipsis">
      RISC-V ä¸Šä¸‹æ–‡åˆ‡æ¢
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mmu-cache" class="md-nav__link">
    <span class="md-ellipsis">
      å…³äº MMU å’Œ cache
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1_2" class="md-nav__link">
    <span class="md-ellipsis">
      å†…å­˜ç®¡ç†1ï¼šä¼™ä¼´ç³»ç»Ÿçš„åŸç†
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2slab" class="md-nav__link">
    <span class="md-ellipsis">
      å†…å­˜ç®¡ç†2ï¼šslabçš„åŸç†
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      å†…å­˜ç®¡ç†ï¼šé¡µé¢å›æ”¶
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      é¡µé¢è¿ç§»/å‹ç¼©æœºåˆ¶
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      ä»å­˜å‚¨ä»‹è´¨çœ‹å¯åŠ¨æµç¨‹
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ä»å­˜å‚¨ä»‹è´¨çœ‹å¯åŠ¨æµç¨‹">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    <span class="md-ellipsis">
      ä¸€ã€å¯åŠ¨æµç¨‹é˜¶æ®µåˆ†è§£
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ä¸€ã€å¯åŠ¨æµç¨‹é˜¶æ®µåˆ†è§£">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1bootromsoc" class="md-nav__link">
    <span class="md-ellipsis">
      é˜¶æ®µ1ï¼šBootROMï¼ˆå›ºåŒ–åœ¨SoCå†…éƒ¨ï¼‰
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2splsecondary-program-loader" class="md-nav__link">
    <span class="md-ellipsis">
      é˜¶æ®µ2ï¼šSPLï¼ˆSecondary Program Loaderï¼‰
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3bootloaderu-boot" class="md-nav__link">
    <span class="md-ellipsis">
      é˜¶æ®µ3ï¼šä¸»Bootloaderï¼ˆå¦‚U-Bootï¼‰
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4kernel" class="md-nav__link">
    <span class="md-ellipsis">
      é˜¶æ®µ4ï¼šå†…æ ¸å¯åŠ¨ï¼ˆKernelï¼‰
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5user-space" class="md-nav__link">
    <span class="md-ellipsis">
      é˜¶æ®µ5ï¼šç”¨æˆ·ç©ºé—´ï¼ˆUser Spaceï¼‰
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    <span class="md-ellipsis">
      äºŒã€æå‡ä¸“ä¸šæ€§çš„æ–¹æ³•è®º
    </span>
  </a>
  
    <nav class="md-nav" aria-label="äºŒã€æå‡ä¸“ä¸šæ€§çš„æ–¹æ³•è®º">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_3" class="md-nav__link">
    <span class="md-ellipsis">
      1. æ·±åº¦æŒæ¡å·¥å…·é“¾
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_3" class="md-nav__link">
    <span class="md-ellipsis">
      2. ç†è§£è¡Œä¸šæ ‡å‡†è®¾è®¡æ¨¡å¼
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_3" class="md-nav__link">
    <span class="md-ellipsis">
      3. å®æˆ˜ä¼˜åŒ–æŠ€å·§
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4_1" class="md-nav__link">
    <span class="md-ellipsis">
      4. å­¦ä¹ è·¯å¾„å»ºè®®
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    <span class="md-ellipsis">
      ä¸‰ã€ç»ˆæç›®æ ‡ï¼šæ„å»ºå®Œæ•´çŸ¥è¯†ä½“ç³»
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1_4" class="md-nav__link">
    <span class="md-ellipsis">
      1. å­˜å‚¨ä»‹è´¨åˆ†ç±»ä¸ä½œç”¨
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. å­˜å‚¨ä»‹è´¨åˆ†ç±»ä¸ä½œç”¨">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 æŒ‰å­˜å‚¨ä½ç½®åˆ†ç±»
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12" class="md-nav__link">
    <span class="md-ellipsis">
      1.2 æŒ‰åŠŸèƒ½åˆ†ç±»
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-soc" class="md-nav__link">
    <span class="md-ellipsis">
      2. SoCå†…éƒ¨å­˜å‚¨è¯¦è§£
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. SoCå†…éƒ¨å­˜å‚¨è¯¦è§£">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-sram" class="md-nav__link">
    <span class="md-ellipsis">
      2.1 SRAMï¼ˆé™æ€éšæœºå­˜å‚¨å™¨ï¼‰
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-mask-rom-otp" class="md-nav__link">
    <span class="md-ellipsis">
      2.2 Mask ROM / OTPï¼ˆä¸€æ¬¡æ€§ç¼–ç¨‹å­˜å‚¨å™¨ï¼‰
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-soc" class="md-nav__link">
    <span class="md-ellipsis">
      3. SoCå¤–éƒ¨å­˜å‚¨è¯¦è§£
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. SoCå¤–éƒ¨å­˜å‚¨è¯¦è§£">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-volatile" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 ä¸»å†…å­˜ï¼ˆVolatileï¼Œæ˜“å¤±æ€§ï¼‰
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-non-volatile" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 éæ˜“å¤±æ€§å­˜å‚¨ï¼ˆNon-Volatileï¼‰
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4_2" class="md-nav__link">
    <span class="md-ellipsis">
      4. å¯åŠ¨ä»‹è´¨é€‰æ‹©ä¸å¯¹æ¯”
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. å¯åŠ¨ä»‹è´¨é€‰æ‹©ä¸å¯¹æ¯”">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 å¸¸è§å¯åŠ¨ä»‹è´¨
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42" class="md-nav__link">
    <span class="md-ellipsis">
      4.2 å¯åŠ¨æµç¨‹ä¸­çš„å­˜å‚¨å±‚çº§
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5_2" class="md-nav__link">
    <span class="md-ellipsis">
      5. å…³é”®é—®é¢˜è§£ç­”
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. å…³é”®é—®é¢˜è§£ç­”">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#q1-socflash" class="md-nav__link">
    <span class="md-ellipsis">
      Q1: SoCå¤–æ¥çš„Flashé€šå¸¸æ˜¯ä»€ä¹ˆç±»å‹ï¼Ÿ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#q2-emmcnand-flash" class="md-nav__link">
    <span class="md-ellipsis">
      Q2: eMMCå’ŒNAND Flashçš„åŒºåˆ«ï¼Ÿ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#q3-ddrsram" class="md-nav__link">
    <span class="md-ellipsis">
      Q3: DDRå’ŒSRAMçš„åˆ†å·¥ï¼Ÿ
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6" class="md-nav__link">
    <span class="md-ellipsis">
      6. è®¾è®¡å»ºè®®
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dtb" class="md-nav__link">
    <span class="md-ellipsis">
      å°†ç¼–è¯‘ç”Ÿæˆçš„è®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆdtbï¼‰ä¸ç³»ç»Ÿé•œåƒç»‘å®š
    </span>
  </a>
  
    <nav class="md-nav" aria-label="å°†ç¼–è¯‘ç”Ÿæˆçš„è®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆdtbï¼‰ä¸ç³»ç»Ÿé•œåƒç»‘å®š">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_5" class="md-nav__link">
    <span class="md-ellipsis">
      1. ç¡®è®¤ç¡¬ä»¶å¹³å°å’Œå¼•å¯¼æ–¹å¼
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-dtb" class="md-nav__link">
    <span class="md-ellipsis">
      2. éƒ¨ç½²dtbæ–‡ä»¶
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. éƒ¨ç½²dtbæ–‡ä»¶">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#u-boot" class="md-nav__link">
    <span class="md-ellipsis">
      é€šç”¨æ­¥éª¤ï¼ˆä»¥U-Bootä¸ºä¾‹ï¼‰
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_4" class="md-nav__link">
    <span class="md-ellipsis">
      3. é…ç½®å¼•å¯¼ç¨‹åº
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. é…ç½®å¼•å¯¼ç¨‹åº">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#u-boot_1" class="md-nav__link">
    <span class="md-ellipsis">
      U-Bootç¯å¢ƒå˜é‡é…ç½®
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configtxt" class="md-nav__link">
    <span class="md-ellipsis">
      æ ‘è“æ´¾é…ç½®ï¼ˆconfig.txtï¼‰
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-dtb" class="md-nav__link">
    <span class="md-ellipsis">
      4. å†…æ ¸ä¸dtbç»‘å®šï¼ˆå¯é€‰ï¼‰
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. å†…æ ¸ä¸dtbç»‘å®šï¼ˆå¯é€‰ï¼‰">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dtb_1" class="md-nav__link">
    <span class="md-ellipsis">
      åµŒå…¥dtbåˆ°å†…æ ¸é•œåƒ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uimage" class="md-nav__link">
    <span class="md-ellipsis">
      ç”Ÿæˆå¤åˆé•œåƒï¼ˆå¦‚uImageï¼‰
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5_3" class="md-nav__link">
    <span class="md-ellipsis">
      5. éªŒè¯å¯åŠ¨æµç¨‹
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6_1" class="md-nav__link">
    <span class="md-ellipsis">
      6. å¸¸è§é—®é¢˜æ’æŸ¥
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    <span class="md-ellipsis">
      æ€»ç»“æ­¥éª¤
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    <span class="md-ellipsis">
      æ–‡ä»¶ç³»ç»Ÿé•œåƒ
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dtb_2" class="md-nav__link">
    <span class="md-ellipsis">
      DTB é…åˆ æ–‡ä»¶ç³»ç»Ÿé•œåƒ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DTB é…åˆ æ–‡ä»¶ç³»ç»Ÿé•œåƒ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    <span class="md-ellipsis">
      ä¸€ã€æ ¸å¿ƒç›®æ ‡å¯¹æ¯”
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    <span class="md-ellipsis">
      äºŒã€æŠ€æœ¯æµç¨‹å…³è”
    </span>
  </a>
  
    <nav class="md-nav" aria-label="äºŒã€æŠ€æœ¯æµç¨‹å…³è”">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_6" class="md-nav__link">
    <span class="md-ellipsis">
      1. ç³»ç»Ÿå¯åŠ¨ä¾èµ–é“¾
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_4" class="md-nav__link">
    <span class="md-ellipsis">
      2. ä¼ä¸šçº§é•œåƒæ„å»ºç¤ºä¾‹
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    <span class="md-ellipsis">
      ä¸‰ã€è®¾è®¡å†³ç­–ä¸å·¥ç¨‹å®è·µ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ä¸‰ã€è®¾è®¡å†³ç­–ä¸å·¥ç¨‹å®è·µ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-vs" class="md-nav__link">
    <span class="md-ellipsis">
      1. åˆ†ç¦»éƒ¨ç½² vs å†…åµŒæ•´åˆ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_5" class="md-nav__link">
    <span class="md-ellipsis">
      2. ä¼ä¸šçº§å¯é æ€§è®¾è®¡
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    <span class="md-ellipsis">
      å››ã€é«˜çº§è°ƒè¯•æŠ€å·§
    </span>
  </a>
  
    <nav class="md-nav" aria-label="å››ã€é«˜çº§è°ƒè¯•æŠ€å·§">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_7" class="md-nav__link">
    <span class="md-ellipsis">
      1. åŠ¨æ€åˆ‡æ¢æµ‹è¯•
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-dtb_1" class="md-nav__link">
    <span class="md-ellipsis">
      2. æ–‡ä»¶ç³»ç»Ÿä¸DTBäº¤å‰éªŒè¯
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    <span class="md-ellipsis">
      äº”ã€è¡Œä¸šæ¼”è¿›ä¸æœªæ¥è¶‹åŠ¿
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    <span class="md-ellipsis">
      æ€»ç»“
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#todo" class="md-nav__link">
    <span class="md-ellipsis">
      TODO
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#todo_1" class="md-nav__link">
    <span class="md-ellipsis">
      TODO
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>Os</h1>

<h2 id="_1"><strong>ä¸­æ–­çš„æ¦‚å¿µæµç¨‹å’Œç†è§£</strong></h2>
<p>æµç¨‹ï¼šä¿å­˜ç°åœºï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæ¢å¤ç°åœºã€‚</p>
<p>æˆ‘ç­”çš„é‡ç‚¹ä¸»è¦åœ¨å•æ ¸ä¸Šçš„å¹¶å‘ï¼šåœ¨å•æ ¸è£¸æœºç¯å¢ƒä¸‹ï¼Œè™½ç„¶ä¸å­˜åœ¨çœŸæ­£çš„å¹¶è¡Œæ‰§è¡Œï¼Œä½†<strong>ä¸­æ–­ä¸ä¸»ç¨‹åºä¹‹é—´çš„æŠ¢å ä¼šå¯¼è‡´å…±äº«å˜é‡çš„ç«æ€æ¡ä»¶</strong>ã€‚ä»¥ä¸‹æ˜¯è§£å†³æ–¹æ¡ˆçš„æ¸…æ™°æ€»ç»“ï¼š</p>
<hr />
<h3 id="_2">ğŸ”’ æ ¸å¿ƒè§£å†³æ€è·¯</h3>
<p>å•æ ¸ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜æºäº<strong>ä¸­æ–­æŠ¢å ä¸»ç¨‹åºæ‰§è¡Œæµ</strong>ï¼ˆæˆ–ç›¸åï¼‰ã€‚è¦ä¿è¯äº’æ–¥ï¼Œæ ¸å¿ƒæ˜¯<strong>ç¡®ä¿è®¿é—®å…±äº«èµ„æºçš„ä»£ç æ®µï¼ˆä¸´ç•ŒåŒºï¼‰ä¸å¯è¢«ä¸­æ–­æ‰“æ–­</strong>ã€‚å¸¸è§æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<hr />
<h3 id="_3">ğŸ› ï¸ å…·ä½“æ–¹æ¡ˆåŠä»£ç ç¤ºä¾‹</h3>
<h4 id="1">1. <strong>å…³é—­ä¸­æ–­ï¼ˆæœ€å¸¸ç”¨ï¼‰</strong></h4>
<ul>
<li>
<p><strong>åŸç†</strong>ï¼šåœ¨æ“ä½œå…±äº«å˜é‡å‰å…³é—­å…¨å±€ä¸­æ–­ï¼Œæ“ä½œå®Œæˆåç«‹å³æ¢å¤ï¼Œé˜²æ­¢ä¸­æ–­æŠ¢å ã€‚</p>
</li>
<li>
<p><strong>å®ç°</strong>ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="c1">// ä»¥ ARM Cortex-M ä¸ºä¾‹ï¼š</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">enter_critical</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__disable_irq</span><span class="p">();</span><span class="w">      </span><span class="c1">// å…³é—­å…¨å±€ä¸­æ–­</span>
<span class="w">    </span><span class="n">__enable_irq</span><span class="p">();</span><span class="w">       </span><span class="c1">// æ¢å¤ä¸­æ–­ï¼ˆä»…ç¤ºä¾‹ï¼Œå®é™…éœ€ä¿å­˜çŠ¶æ€ï¼‰</span>
<span class="p">}</span>

<span class="c1">// ä½¿ç”¨ç¤ºä¾‹ï¼š</span>
<span class="k">volatile</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">shared_var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">update_shared_var</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__disable_irq</span><span class="p">();</span><span class="w">       </span><span class="c1">// è¿›å…¥ä¸´ç•ŒåŒº</span>
<span class="w">    </span><span class="n">shared_var</span><span class="o">++</span><span class="p">;</span><span class="w">          </span><span class="c1">// å®‰å…¨æ“ä½œå…±äº«å˜é‡</span>
<span class="w">    </span><span class="n">__enable_irq</span><span class="p">();</span><span class="w">       </span><span class="c1">// é€€å‡ºä¸´ç•ŒåŒº</span>
<span class="p">}</span>
</code></pre></div>
</li>
<li>
<p><strong>æ³¨æ„</strong>ï¼šéœ€ç¡®ä¿ä¸´ç•ŒåŒºæçŸ­ï¼ˆå¾®ç§’çº§ï¼‰ï¼Œé¿å…å½±å“ä¸­æ–­å“åº”ã€‚</p>
</li>
</ul>
<h4 id="2-cpu">2. <strong>åŸå­æ“ä½œï¼ˆä¾èµ– CPU æ”¯æŒï¼‰</strong></h4>
<ul>
<li>
<p><strong>åŸç†</strong>ï¼šåˆ©ç”¨ CPU æä¾›çš„åŸå­æŒ‡ä»¤ï¼ˆå¦‚ LDREX/STREXã€CASï¼‰ï¼Œç¡®ä¿è¯»-æ”¹-å†™æ“ä½œä¸å¯åˆ†å‰²ã€‚</p>
</li>
<li>
<p><strong>å®ç°</strong>ï¼ˆARM Cortex-M åŸå­è‡ªå¢ï¼‰ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">atomic_inc</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__LDREXW</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">  </span><span class="c1">// åŸå­åŠ è½½å¹¶ä¿®æ”¹</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">__STREXW</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">));</span><span class="w"> </span><span class="c1">// åŸå­å­˜å‚¨ï¼Œå¤±è´¥åˆ™é‡è¯•</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</li>
</ul>
<h4 id="3">3. <strong>æ— é”è®¾è®¡ï¼ˆé¿å…å…±äº«ï¼‰</strong></h4>
<ul>
<li>
<p><strong>åŸç†</strong>ï¼šé€šè¿‡ FIFO é˜Ÿåˆ—æˆ–åŒç¼“å†²ä¼ é€’æ•°æ®ï¼Œå‡å°‘ç›´æ¥å…±äº«å˜é‡ã€‚</p>
</li>
<li>
<p><strong>ç¤ºä¾‹</strong>ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="cp">#define BUFFER_SIZE 32</span>
<span class="k">volatile</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">buffer</span><span class="p">[</span><span class="n">BUFFER_SIZE</span><span class="p">];</span>
<span class="k">volatile</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">tail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="c1">// ä¸»ç¨‹åºå†™å…¥</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">push_data</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">buffer</span><span class="p">[</span><span class="n">head</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="w">    </span><span class="n">head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">head</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">BUFFER_SIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// ISR è¯»å–</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">ISR</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tail</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">head</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">process_data</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">tail</span><span class="p">]);</span>
<span class="w">        </span><span class="n">tail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">tail</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">BUFFER_SIZE</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</li>
</ul>
<hr />
<h3 id="_4">âš ï¸ å…³é”®æ³¨æ„äº‹é¡¹</h3>
<ol>
<li>
<p><strong>volatile å…³é”®å­—</strong>ï¼šé˜²æ­¢ç¼–è¯‘å™¨ä¼˜åŒ–å°†å˜é‡ç¼“å­˜åˆ°å¯„å­˜å™¨ï¼Œç¡®ä¿æ¯æ¬¡è®¿é—®å†…å­˜ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="k">volatile</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">shared_var</span><span class="p">;</span><span class="w">  </span><span class="c1">// å¿…é¡»æ·»åŠ ï¼</span>
</code></pre></div>
</li>
<li>
<p><strong>ä¸´ç•ŒåŒºé•¿åº¦</strong>ï¼šå…³é—­ä¸­æ–­çš„æ—¶é—´å¿…é¡»æçŸ­ï¼Œå¦‚æ‰§è¡Œç®€å•ç®—æœ¯æˆ–ä½æ“ä½œã€‚</p>
</li>
<li>
<p><strong>åµŒå¥—ä¸­æ–­å¤„ç†</strong>ï¼šè‹¥å…è®¸ä¸­æ–­åµŒå¥—ï¼Œéœ€åœ¨ ISR å†…ä¹Ÿä¿æŠ¤å…±äº«èµ„æºã€‚</p>
</li>
</ol>
<hr />
<h3 id="_5">ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”</h3>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>ä¼˜ç‚¹</th>
<th>ç¼ºç‚¹</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td>å…³é—­ä¸­æ–­</td>
<td>ç®€å•å¯é ï¼Œé€šç”¨æ€§å¼º</td>
<td>å½±å“ä¸­æ–­å“åº”å»¶è¿Ÿ</td>
<td>çŸ­ä¸´ç•ŒåŒºæ“ä½œ</td>
</tr>
<tr>
<td>åŸå­æ“ä½œ</td>
<td>æ— é”ï¼Œä¸å½±å“ä¸­æ–­å“åº”</td>
<td>ä¾èµ–ç‰¹å®š CPU æŒ‡ä»¤</td>
<td>ç®€å•è¯»-æ”¹-å†™æ“ä½œ</td>
</tr>
<tr>
<td>æ— é”è®¾è®¡</td>
<td>é¿å…ç«äº‰ï¼Œæé«˜ç³»ç»Ÿç¨³å®šæ€§</td>
<td>è®¾è®¡å¤æ‚åº¦é«˜ï¼Œå†…å­˜å ç”¨å¤§</td>
<td>é«˜é¢‘æ•°æ®ä¼ é€’åœºæ™¯</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="_6">ğŸŒŸ æ€»ç»“</h3>
<p>åœ¨å•æ ¸è£¸æœºç³»ç»Ÿä¸­ï¼Œ<strong>å…³é—­ä¸­æ–­æ˜¯æœ€ç›´æ¥æœ‰æ•ˆçš„äº’æ–¥æ‰‹æ®µ</strong>ï¼Œä½†éœ€ä¸¥æ ¼é™åˆ¶ä¸´ç•ŒåŒºé•¿åº¦ã€‚ç»“åˆå…·ä½“åœºæ™¯é€‰æ‹©åŸå­æ“ä½œæˆ–æ— é”è®¾è®¡ï¼Œå¯è¿›ä¸€æ­¥æå‡ç³»ç»Ÿæ•ˆç‡å’Œå¯é æ€§ã€‚</p>
<h2 id="_7">çº¿ç¨‹å®‰å…¨</h2>
<h3 id="_8">ğŸ”¥ <strong>å¤šæ ¸ç¯å¢ƒä¸‹çš„å¹¶å‘å®‰å…¨æŒ‘æˆ˜ä¸è§£å†³æ–¹æ¡ˆ</strong></h3>
<p>å¤šæ ¸ç³»ç»Ÿçš„å¹¶å‘é—®é¢˜æ¯”å•æ ¸å¤æ‚æ•°ä¸ªæ•°é‡çº§ï¼Œå…¶æ ¸å¿ƒæŒ‘æˆ˜åœ¨äºï¼š  </p>
<ol>
<li><strong>ç¡¬ä»¶å¹¶è¡Œæ€§</strong>ï¼šå¤šä¸ªç‰©ç†æ ¸å¿ƒ<strong>åŒæ—¶æ‰§è¡ŒæŒ‡ä»¤</strong>ï¼Œå¯¹å…±äº«èµ„æºçš„è®¿é—®å¯èƒ½çœŸæ­£å¹¶è¡Œã€‚  </li>
<li><strong>ç¼“å­˜ä¸€è‡´æ€§</strong>ï¼šå„æ ¸å¿ƒç¼“å­˜ä¸­çš„å…±äº«æ•°æ®å‰¯æœ¬éœ€é€šè¿‡åè®®ï¼ˆå¦‚MESIï¼‰åŒæ­¥ï¼Œä½†ä»éœ€è½¯ä»¶ä»‹å…¥ä¿è¯å¯è§æ€§ã€‚  </li>
<li><strong>å†…å­˜ä¹±åº</strong>ï¼šCPU/ç¼–è¯‘å™¨å¯èƒ½å¯¹æŒ‡ä»¤é‡æ’ï¼Œå¯¼è‡´æ„å¤–è¡Œä¸ºã€‚  </li>
</ol>
<p>ä»¥ä¸‹ä¸ºå¤šæ ¸è£¸æœºç³»ç»Ÿçš„ä¸“ä¸šçº§è§£å†³æ–¹æ¡ˆï¼š</p>
<hr />
<h3 id="_9">ğŸ§  <strong>å¤šæ ¸åŒæ­¥æ ¸å¿ƒåŸç†</strong></h3>
<h4 id="1-memory-order"><strong>1. åŸå­æ“ä½œä¸å†…å­˜åºï¼ˆMemory Orderï¼‰</strong></h4>
<ul>
<li><strong>åŸå­æ€§</strong>ï¼šç¡®ä¿æ“ä½œä¸å¯åˆ†å‰²ï¼ˆå¦‚ <code>atomic_add</code>ï¼‰ã€‚  </li>
<li><strong>å¯è§æ€§</strong>ï¼šä¿®æ”¹åçš„å€¼å¯¹å…¶ä»–æ ¸å¿ƒç«‹å³å¯è§ï¼ˆé€šè¿‡å†…å­˜å±éšœå¼ºåˆ¶åˆ·æ–°ç¼“å­˜ï¼‰ã€‚  </li>
<li><strong>é¡ºåºæ€§</strong>ï¼šé˜²æ­¢æŒ‡ä»¤é‡æ’ç ´åé€»è¾‘ï¼ˆä½¿ç”¨ <code>acquire</code>/<code>release</code> è¯­ä¹‰ï¼‰ã€‚  </li>
</ul>
<h4 id="2"><strong>2. ç¼“å­˜ä¸€è‡´æ€§åè®®</strong></h4>
<ul>
<li><strong>MESIåè®®</strong>ï¼šç¼“å­˜è¡ŒçŠ¶æ€åˆ†ä¸º Modified/Exclusive/Shared/Invalidï¼Œç¡¬ä»¶è‡ªåŠ¨ç»´æŠ¤ä¸€è‡´æ€§ã€‚  </li>
<li><strong>ä¼ªå…±äº«ï¼ˆFalse Sharingï¼‰</strong>ï¼šä¸åŒæ ¸å¿ƒé¢‘ç¹ä¿®æ”¹åŒä¸€ç¼“å­˜è¡Œçš„ä¸åŒå˜é‡ï¼Œå¯¼è‡´æ€§èƒ½æš´è·Œã€‚éœ€å¯¹é½æ•°æ®ç»“æ„è‡³ç¼“å­˜è¡Œå¤§å°ï¼ˆé€šå¸¸64å­—èŠ‚ï¼‰ã€‚  </li>
</ul>
<hr />
<h3 id="_10">ğŸ› ï¸ <strong>å¤šæ ¸åŒæ­¥æ–¹æ¡ˆå®ç°</strong></h3>
<h4 id="1-spinlock"><strong>1. è‡ªæ—‹é”ï¼ˆSpinlockï¼‰</strong></h4>
<ul>
<li>
<p><strong>åŸç†</strong>ï¼šé€šè¿‡åŸå­æŒ‡ä»¤å®ç°å¿™ç­‰å¾…é”ï¼Œé€‚ç”¨äº<strong>çŸ­æœŸä¸´ç•ŒåŒº</strong>ã€‚  </p>
</li>
<li>
<p><strong>ä»£ç å®ç°</strong>ï¼ˆARMv8æ±‡ç¼–+Cå°è£…ï¼‰ï¼š  </p>
<div class="highlight"><pre><span></span><code><span class="c1">// è‡ªæ—‹é”ç»“æ„ä½“ï¼ˆå¯¹é½åˆ°ç¼“å­˜è¡Œé¿å…ä¼ªå…±äº«ï¼‰</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">    </span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="mi">64</span><span class="p">)));</span><span class="w">  </span>
<span class="p">}</span><span class="w"> </span><span class="n">spinlock_t</span><span class="p">;</span><span class="w">  </span>

<span class="kt">void</span><span class="w"> </span><span class="nf">spinlock_lock</span><span class="p">(</span><span class="n">spinlock_t</span><span class="w"> </span><span class="o">*</span><span class="n">lock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="c1">// ä½¿ç”¨LDREX/STREXå®ç°åŸå­CAS  </span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__LDREXW</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">    </span><span class="c1">// æ£€æŸ¥æ˜¯å¦æœªé”å®š  </span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__STREXW</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// å°è¯•åŠ é”  </span>
<span class="w">                </span><span class="n">__DMB</span><span class="p">();</span><span class="w">                     </span><span class="c1">// å†…å­˜å±éšœä¿è¯åç»­æ“ä½œå¯è§æ€§  </span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w">  </span>
<span class="w">            </span><span class="p">}</span><span class="w">  </span>
<span class="w">        </span><span class="p">}</span><span class="w">  </span>
<span class="w">        </span><span class="n">__WFE</span><span class="p">();</span><span class="w">                            </span><span class="c1">// è¿›å…¥ä½åŠŸè€—ç­‰å¾…çŠ¶æ€ï¼ˆARMæŒ‡ä»¤ï¼‰  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="p">}</span><span class="w">  </span>

<span class="kt">void</span><span class="w"> </span><span class="nf">spinlock_unlock</span><span class="p">(</span><span class="n">spinlock_t</span><span class="w"> </span><span class="o">*</span><span class="n">lock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">    </span><span class="n">__DMB</span><span class="p">();</span><span class="w">                                </span><span class="c1">// ä¿è¯ä¸´ç•ŒåŒºæ“ä½œå®Œæˆ  </span>
<span class="w">    </span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="n">__SEV</span><span class="p">();</span><span class="w">                                </span><span class="c1">// å”¤é†’å…¶ä»–æ ¸å¿ƒï¼ˆARMæŒ‡ä»¤ï¼‰  </span>
<span class="p">}</span><span class="w">  </span>
</code></pre></div>
</li>
<li>
<p><strong>å…³é”®ä¼˜åŒ–</strong>ï¼š  </p>
<ul>
<li>ä½¿ç”¨ <code>__WFE()</code>/<code>__SEV()</code> å‡å°‘å¿™ç­‰å¾…åŠŸè€—ã€‚  </li>
<li>å¯¹é½é”ç»“æ„ä½“åˆ°ç¼“å­˜è¡Œï¼Œé¿å…ä¼ªå…±äº«ã€‚  </li>
</ul>
</li>
</ul>
<hr />
<h4 id="2-read-write-lock"><strong>2. è¯»å†™é”ï¼ˆRead-Write Lockï¼‰</strong></h4>
<ul>
<li>
<p><strong>åŸç†</strong>ï¼šåŒºåˆ†è¯»é”ï¼ˆå…±äº«ï¼‰å’Œå†™é”ï¼ˆç‹¬å ï¼‰ï¼Œæå‡è¯»å¤šå†™å°‘åœºæ™¯æ€§èƒ½ã€‚  </p>
</li>
<li>
<p><strong>å®ç°</strong>ï¼ˆåŸºäºåŸå­è®¡æ•°å™¨ï¼‰ï¼š  </p>
<div class="highlight"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">    </span><span class="n">spinlock_t</span><span class="w"> </span><span class="n">guard</span><span class="p">;</span><span class="w">      </span><span class="c1">// ä¿æŠ¤å†…éƒ¨çŠ¶æ€  </span>
<span class="w">    </span><span class="k">volatile</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">readers</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="k">volatile</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">writer</span><span class="p">;</span><span class="w">   </span><span class="c1">// 0=æ— å†™è€…ï¼Œ1=æœ‰å†™è€…  </span>
<span class="p">}</span><span class="w"> </span><span class="n">rwlock_t</span><span class="p">;</span><span class="w">  </span>

<span class="kt">void</span><span class="w"> </span><span class="nf">read_lock</span><span class="p">(</span><span class="n">rwlock_t</span><span class="w"> </span><span class="o">*</span><span class="n">lock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">    </span><span class="n">spinlock_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">guard</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">writer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// ç­‰å¾…å†™è€…é‡Šæ”¾  </span>
<span class="w">        </span><span class="n">spinlock_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">guard</span><span class="p">);</span><span class="w">  </span>
<span class="w">        </span><span class="n">spinlock_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">guard</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="w">    </span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">readers</span><span class="o">++</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="n">spinlock_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">guard</span><span class="p">);</span><span class="w">  </span>
<span class="p">}</span><span class="w">  </span>

<span class="kt">void</span><span class="w"> </span><span class="nf">write_lock</span><span class="p">(</span><span class="n">rwlock_t</span><span class="w"> </span><span class="o">*</span><span class="n">lock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">    </span><span class="n">spinlock_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">guard</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">writer</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">readers</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="n">spinlock_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">guard</span><span class="p">);</span><span class="w">  </span>
<span class="w">        </span><span class="n">spinlock_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">guard</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="w">    </span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">writer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="n">spinlock_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">guard</span><span class="p">);</span><span class="w">  </span>
<span class="p">}</span><span class="w">  </span>
</code></pre></div>
</li>
</ul>
<hr />
<h4 id="3-rcuread-copy-update"><strong>3. RCUï¼ˆRead-Copy-Updateï¼‰</strong></h4>
<ul>
<li><strong>åŸç†</strong>ï¼šè¯»æ“ä½œæ— é”ï¼Œå†™æ“ä½œå¤åˆ¶æ•°æ®ååŸå­æ›¿æ¢æŒ‡é’ˆï¼Œå»¶è¿Ÿé‡Šæ”¾æ—§æ•°æ®ã€‚  </li>
<li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šè¯»æå¤šå†™æå°‘ï¼ˆå¦‚è·¯ç”±è¡¨ã€é…ç½®æ•°æ®ï¼‰ã€‚  </li>
<li><strong>å®ç°æ­¥éª¤</strong>ï¼š  <ol>
<li><strong>å†™è€…</strong>ï¼š  <ul>
<li>å¤åˆ¶å¾…ä¿®æ”¹æ•°æ®ç”Ÿæˆæ–°ç‰ˆæœ¬ã€‚  </li>
<li>åŸå­æ›¿æ¢å…¨å±€æŒ‡é’ˆæŒ‡å‘æ–°æ•°æ®ã€‚  </li>
<li>å»¶è¿Ÿé‡Šæ”¾æ—§æ•°æ®ï¼ˆç¡®ä¿æ‰€æœ‰è¯»è€…å·²é€€å‡ºä¸´ç•ŒåŒºï¼‰ã€‚  </li>
</ul>
</li>
<li><strong>è¯»è€…</strong>ï¼š  <ul>
<li>ç›´æ¥è¯»å–å…¨å±€æŒ‡é’ˆï¼Œæ— éœ€åŠ é”ã€‚  </li>
</ul>
</li>
</ol>
</li>
</ul>
<hr />
<h4 id="4-lock-free-queue"><strong>4. æ— é”æ•°æ®ç»“æ„ï¼ˆLock-Free Queueï¼‰</strong></h4>
<ul>
<li>
<p><strong>åŸç†</strong>ï¼šé€šè¿‡CASåŸå­æŒ‡ä»¤å®ç°æ— é”é˜Ÿåˆ—ï¼Œé¿å…çº¿ç¨‹é˜»å¡ã€‚  </p>
</li>
<li>
<p><strong>å®ç°</strong>ï¼ˆå¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…MPMCé˜Ÿåˆ—ï¼‰ï¼š  </p>
<div class="highlight"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">    </span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">head</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">tail</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="p">[</span><span class="n">QUEUE_SIZE</span><span class="p">];</span><span class="w">  </span>
<span class="p">}</span><span class="w"> </span><span class="n">lockfree_queue_t</span><span class="p">;</span><span class="w">  </span>

<span class="kt">bool</span><span class="w"> </span><span class="nf">enqueue</span><span class="p">(</span><span class="n">lockfree_queue_t</span><span class="w"> </span><span class="o">*</span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">item</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">curr_tail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__atomic_load_n</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">,</span><span class="w"> </span><span class="n">__ATOMIC_RELAXED</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">next_tail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">curr_tail</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">QUEUE_SIZE</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">next_tail</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">__atomic_load_n</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span><span class="w"> </span><span class="n">__ATOMIC_ACQUIRE</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"> </span><span class="c1">// é˜Ÿåˆ—æ»¡  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="w">    </span><span class="n">q</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">curr_tail</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">item</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="n">__atomic_store_n</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">,</span><span class="w"> </span><span class="n">next_tail</span><span class="p">,</span><span class="w"> </span><span class="n">__ATOMIC_RELEASE</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w">  </span>
<span class="p">}</span><span class="w">  </span>

<span class="kt">bool</span><span class="w"> </span><span class="nf">dequeue</span><span class="p">(</span><span class="n">lockfree_queue_t</span><span class="w"> </span><span class="o">*</span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">**</span><span class="n">item</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">curr_head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__atomic_load_n</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span><span class="w"> </span><span class="n">__ATOMIC_RELAXED</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">curr_head</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">__atomic_load_n</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">,</span><span class="w"> </span><span class="n">__ATOMIC_ACQUIRE</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"> </span><span class="c1">// é˜Ÿåˆ—ç©º  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="w">    </span><span class="o">*</span><span class="n">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">q</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">curr_head</span><span class="p">];</span><span class="w">  </span>
<span class="w">    </span><span class="n">__atomic_store_n</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">curr_head</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">QUEUE_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">__ATOMIC_RELEASE</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w">  </span>
<span class="p">}</span><span class="w">  </span>
</code></pre></div>
</li>
<li>
<p><strong>å†…å­˜åºè¯´æ˜</strong>ï¼š  </p>
<ul>
<li><code>__ATOMIC_ACQUIRE</code>ï¼šä¿è¯åç»­è¯»å†™ä¸ä¼šé‡æ’åˆ°è¯¥æ“ä½œä¹‹å‰ã€‚  </li>
<li><code>__ATOMIC_RELEASE</code>ï¼šä¿è¯ä¹‹å‰è¯»å†™ä¸ä¼šé‡æ’åˆ°è¯¥æ“ä½œä¹‹åã€‚  </li>
</ul>
</li>
</ul>
<hr />
<h3 id="_11">âš¡ <strong>å¤šæ ¸åŒæ­¥æ€§èƒ½ä¼˜åŒ–æŠ€å·§</strong></h3>
<ol>
<li>
<p><strong>æ•°æ®å±€éƒ¨æ€§è®¾è®¡</strong>ï¼š  </p>
<ul>
<li>æ¯ä¸ªæ ¸å¿ƒç»´æŠ¤ç‹¬ç«‹æ•°æ®ç»“æ„ï¼ˆå¦‚Per-CPUå˜é‡ï¼‰ï¼Œå‡å°‘å…±äº«å†²çªã€‚  </li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">// Per-CPUè®¡æ•°å™¨ï¼ˆARMv8è·å–CPU IDï¼‰  </span>
<span class="cp">#define get_cpu_id() (__builtin_arm_rsr64(&quot;MPIDR_EL1&quot;) &amp; 0xFF)  </span>
<span class="kt">uint64_t</span><span class="w"> </span><span class="n">counters</span><span class="p">[</span><span class="n">NR_CPUS</span><span class="p">]</span><span class="w"> </span><span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="mi">64</span><span class="p">)));</span><span class="w">  </span>

<span class="kt">void</span><span class="w"> </span><span class="nf">increment_counter</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">    </span><span class="n">counters</span><span class="p">[</span><span class="n">get_cpu_id</span><span class="p">()]</span><span class="o">++</span><span class="p">;</span><span class="w">  </span>
<span class="p">}</span><span class="w">  </span>
</code></pre></div>
</li>
<li>
<p><strong>åˆ†å±‚é”ï¼ˆHierarchical Lockingï¼‰</strong>ï¼š  </p>
<ul>
<li>ç²—ç²’åº¦é”ä¿æŠ¤å¤§èŒƒå›´æ•°æ®ï¼Œç»†ç²’åº¦é”ä¿æŠ¤å­ç»“æ„ï¼Œé™ä½é”äº‰ç”¨ã€‚  </li>
</ul>
</li>
<li>
<p><strong>é¿å…é” convoy æ•ˆåº”</strong>ï¼š  </p>
<ul>
<li>ä½¿ç”¨ try_lock è€Œéé˜»å¡é”ï¼Œå¤±è´¥åæ‰§è¡Œå…¶ä»–ä»»åŠ¡ã€‚  </li>
</ul>
</li>
</ol>
<hr />
<h3 id="_12">ğŸ›‘ <strong>å¤šæ ¸è°ƒè¯•ä¸éªŒè¯</strong></h3>
<ol>
<li>
<p><strong>ç¡¬ä»¶è§‚å¯Ÿç‚¹</strong>ï¼š  </p>
<ul>
<li>ä½¿ç”¨è°ƒè¯•å™¨ï¼ˆå¦‚JTAGï¼‰è®¾ç½®å†…å­˜ç›‘è§†ç‚¹ï¼Œæ•è·éæ³•è®¿é—®ã€‚  </li>
</ul>
</li>
<li>
<p><strong>å½¢å¼åŒ–éªŒè¯å·¥å…·</strong>ï¼š  </p>
<ul>
<li>ä½¿ç”¨SPINã€TLA+ç­‰å·¥å…·å¯¹åŒæ­¥åè®®å»ºæ¨¡éªŒè¯ã€‚  </li>
</ul>
</li>
<li>
<p><strong>å‹åŠ›æµ‹è¯•</strong>ï¼š  </p>
<ul>
<li>å¯åŠ¨å¤šä¸ªæ ¸å¿ƒåŒæ—¶é«˜é¢‘æ“ä½œå…±äº«èµ„æºï¼Œæ³¨å…¥éšæœºå»¶è¿Ÿï¼š  </li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">test_spinlock</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">    </span><span class="n">spinlock_t</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w">  </span>
<span class="w">    </span><span class="n">parallel_run_on_all_cores</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="mf">1e6</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">            </span><span class="n">spinlock_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span><span class="w">  </span>
<span class="w">            </span><span class="n">shared_data</span><span class="o">++</span><span class="p">;</span><span class="w">  </span>
<span class="w">            </span><span class="n">spinlock_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span><span class="w">  </span>
<span class="w">            </span><span class="n">random_delay</span><span class="p">();</span><span class="w">  </span>
<span class="w">        </span><span class="p">}</span><span class="w">  </span>
<span class="w">    </span><span class="p">});</span><span class="w">  </span>
<span class="p">}</span><span class="w">  </span>
</code></pre></div>
</li>
</ol>
<hr />
<h3 id="_13">ğŸ“Š <strong>å¤šæ ¸åŒæ­¥æ–¹æ¡ˆé€‰å‹è¡¨</strong></h3>
<table>
<thead>
<tr>
<th><strong>åœºæ™¯</strong></th>
<th><strong>æ¨èæ–¹æ¡ˆ</strong></th>
<th><strong>æ€§èƒ½</strong></th>
<th><strong>å¤æ‚åº¦</strong></th>
<th><strong>é€‚ç”¨æ ¸æ•°</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>çŸ­ä¸´ç•ŒåŒº</td>
<td>è‡ªæ—‹é”</td>
<td>â˜…â˜…â˜…â˜…â˜…</td>
<td>â˜…â˜…â˜†â˜†â˜†</td>
<td>2-64</td>
</tr>
<tr>
<td>è¯»å¤šå†™å°‘</td>
<td>è¯»å†™é”/RCU</td>
<td>â˜…â˜…â˜…â˜…â˜†</td>
<td>â˜…â˜…â˜…â˜…â˜†</td>
<td>2-1024</td>
</tr>
<tr>
<td>æ— é˜»å¡æ•°æ®ä¼ é€’</td>
<td>æ— é”é˜Ÿåˆ—</td>
<td>â˜…â˜…â˜…â˜…â˜†</td>
<td>â˜…â˜…â˜…â˜…â˜…</td>
<td>2-256</td>
</tr>
<tr>
<td>æé«˜é¢‘è®¡æ•°å™¨</td>
<td>Per-CPUå˜é‡+æ±‡æ€»</td>
<td>â˜…â˜…â˜…â˜…â˜…</td>
<td>â˜…â˜…â˜†â˜†â˜†</td>
<td>ä»»æ„</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="_14">âœ… <strong>å¤šæ ¸åŒæ­¥é»„é‡‘æ³•åˆ™</strong></h3>
<ol>
<li><strong>èƒ½ä¸å…±äº«å°±ä¸å…±äº«</strong>ï¼šé€šè¿‡æ¶æ„è®¾è®¡ï¼ˆå¦‚æ•°æ®åˆ†åŒºï¼‰å‡å°‘å…±äº«éœ€æ±‚ã€‚  </li>
<li><strong>èƒ½æ— é”å°±ä¸åŠ é”</strong>ï¼šä¼˜å…ˆä½¿ç”¨åŸå­æ“ä½œæˆ–æ— é”æ•°æ®ç»“æ„ã€‚  </li>
<li><strong>èƒ½ç»†ç²’åº¦å°±ä¸ç²—ç²’åº¦</strong>ï¼šå‡å°é”ç²’åº¦ï¼Œé™ä½äº‰ç”¨æ¦‚ç‡ã€‚  </li>
<li><strong>æ°¸è¿œå‡è®¾ä»£ç ä¼šè¢«ä¹±åºæ‰§è¡Œ</strong>ï¼šæ­£ç¡®ä½¿ç”¨å†…å­˜å±éšœï¼  </li>
</ol>
<p>å¤šæ ¸å¹¶å‘ç¼–ç¨‹æ˜¯è½¯ä»¶å·¥ç¨‹çš„å·…å³°æŒ‘æˆ˜ä¹‹ä¸€ï¼Œéœ€ç»“åˆç¡¬ä»¶ç‰¹æ€§ã€ç®—æ³•è®¾è®¡ã€éªŒè¯æ‰‹æ®µä¸‰ä½ä¸€ä½“æ–¹èƒ½æ„å»ºå¯é ç³»ç»Ÿã€‚</p>
<h2 id="_15">è¿›ç¨‹é—´é€šä¿¡</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">é€šä¿¡æ–¹å¼</th>
<th style="text-align: left;">å®šä¹‰ä¸æè¿°</th>
<th style="text-align: left;">ç‰¹ç‚¹</th>
<th style="text-align: left;">ä¼˜ç‚¹</th>
<th style="text-align: left;">ç¼ºç‚¹</th>
<th style="text-align: left;">é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">ç®¡é“ï¼ˆPipeï¼‰</td>
<td style="text-align: left;">ä¸€ç§åŸºäºæ–‡ä»¶æè¿°ç¬¦çš„é€šä¿¡æœºåˆ¶ï¼Œç”¨äºå…·æœ‰äº²ç¼˜å…³ç³»çš„è¿›ç¨‹ä¹‹é—´ã€‚æ•°æ®åœ¨ç®¡é“ä¸­ä»¥å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„æ–¹å¼ä¼ è¾“ã€‚</td>
<td style="text-align: left;">åŠåŒå·¥é€šä¿¡ï¼ˆé»˜è®¤ï¼‰ï¼Œåªèƒ½å•å‘ä¼ è¾“ï¼›éœ€è¦äº²ç¼˜å…³ç³»ã€‚</td>
<td style="text-align: left;">ç®€å•æ˜“ç”¨ï¼Œç³»ç»Ÿå¼€é”€å°ã€‚</td>
<td style="text-align: left;">é€šä¿¡èƒ½åŠ›æœ‰é™ï¼Œåªèƒ½åœ¨æœ‰äº²ç¼˜å…³ç³»çš„è¿›ç¨‹é—´ä½¿ç”¨ã€‚</td>
<td style="text-align: left;">çˆ¶å­è¿›ç¨‹é—´çš„ç®€å•æ•°æ®ä¼ è¾“ï¼Œå¦‚å‘½ä»¤è¡Œå·¥å…·é“¾ã€‚</td>
</tr>
<tr>
<td style="text-align: left;">æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Queueï¼‰</td>
<td style="text-align: left;">ä¸€ç§åŸºäºæ¶ˆæ¯çš„é€šä¿¡æœºåˆ¶ï¼Œæ¶ˆæ¯è¢«é¡ºåºæ”¾ç½®åœ¨é˜Ÿåˆ—ä¸­ï¼Œè¿›ç¨‹å¯ä»¥å‘é˜Ÿåˆ—å‘é€å’Œæ¥æ”¶æ¶ˆæ¯ã€‚</td>
<td style="text-align: left;">å…¨åŒå·¥é€šä¿¡ï¼ŒåŸºäºæ¶ˆæ¯çš„é€šä¿¡ã€‚</td>
<td style="text-align: left;">è§£è€¦å‘é€å’Œæ¥æ”¶è¿›ç¨‹ï¼Œçµæ´»æ€§é«˜ã€‚</td>
<td style="text-align: left;">éœ€è¦ç³»ç»Ÿæ”¯æŒï¼Œé…ç½®ç›¸å¯¹å¤æ‚ã€‚</td>
<td style="text-align: left;">éœ€è¦å¯é æ¶ˆæ¯ä¼ é€’çš„åœºæ™¯ï¼Œå¦‚åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æ¶ˆæ¯ä¸­é—´ä»¶ã€‚</td>
</tr>
<tr>
<td style="text-align: left;">å…±äº«å†…å­˜ï¼ˆShared Memoryï¼‰</td>
<td style="text-align: left;">å¤šä¸ªè¿›ç¨‹å…±äº«åŒä¸€å—å†…å­˜åŒºåŸŸï¼Œè¿›ç¨‹é€šè¿‡è¯»å†™å…±äº«å†…å­˜æ¥äº¤æ¢æ•°æ®ã€‚</td>
<td style="text-align: left;">é«˜æ•ˆï¼Œç›´æ¥å†…å­˜è®¿é—®ã€‚</td>
<td style="text-align: left;">é€šä¿¡é€Ÿåº¦å¿«ï¼Œé€‚åˆå¤§æ•°æ®é‡ä¼ è¾“ã€‚</td>
<td style="text-align: left;">åŒæ­¥å’Œäº’æ–¥é—®é¢˜éœ€è¦é¢å¤–å¤„ç†ã€‚</td>
<td style="text-align: left;">é«˜æ€§èƒ½è¦æ±‚çš„åœºæ™¯ï¼Œå¦‚å®æ—¶æ•°æ®å¤„ç†ã€‚</td>
</tr>
<tr>
<td style="text-align: left;">ä¿¡å·é‡ï¼ˆSemaphoreï¼‰</td>
<td style="text-align: left;">ä¸€ç§ç”¨äºè¿›ç¨‹åŒæ­¥å’Œäº’æ–¥çš„æœºåˆ¶ï¼Œé€šè¿‡ä¿¡å·é‡å˜é‡æ¥æ§åˆ¶å¤šä¸ªè¿›ç¨‹å¯¹èµ„æºçš„è®¿é—®ã€‚</td>
<td style="text-align: left;">ç”¨äºåŒæ­¥å’Œäº’æ–¥ï¼Œä¸ç›´æ¥ç”¨äºæ•°æ®ä¼ è¾“ã€‚</td>
<td style="text-align: left;">ç¡®ä¿èµ„æºçš„æ­£ç¡®è®¿é—®ã€‚</td>
<td style="text-align: left;">ä»…ç”¨äºæ§åˆ¶ï¼Œä¸èƒ½ç›´æ¥ä¼ è¾“æ•°æ®ã€‚</td>
<td style="text-align: left;">å¤šè¿›ç¨‹è®¿é—®å…±äº«èµ„æºæ—¶çš„åŒæ­¥æ§åˆ¶ã€‚</td>
</tr>
<tr>
<td style="text-align: left;">ä¿¡å·ï¼ˆSignalï¼‰</td>
<td style="text-align: left;">ä¸€ç§è½¯ä»¶ä¸­æ–­æœºåˆ¶ï¼Œç”¨äºé€šçŸ¥è¿›ç¨‹å‘ç”Ÿäº†å¼‚æ­¥äº‹ä»¶ã€‚</td>
<td style="text-align: left;">å¼‚æ­¥é€šçŸ¥ï¼Œç®€å•å¿«é€Ÿã€‚</td>
<td style="text-align: left;">å®ç°ç®€å•ï¼Œé€‚ç”¨äºç®€å•çš„å¼‚æ­¥é€šçŸ¥ã€‚</td>
<td style="text-align: left;">ä¼ è¾“ä¿¡æ¯é‡å°‘ï¼Œå¤„ç†å‡½æ•°ç®€å•ã€‚</td>
<td style="text-align: left;">å¼‚æ­¥äº‹ä»¶é€šçŸ¥ï¼Œå¦‚é”®ç›˜ä¸­æ–­ã€å­è¿›ç¨‹ç»ˆæ­¢é€šçŸ¥ã€‚</td>
</tr>
<tr>
<td style="text-align: left;">å¥—æ¥å­—ï¼ˆSocketï¼‰</td>
<td style="text-align: left;">ä¸€ç§ç½‘ç»œé€šä¿¡æ¥å£ï¼Œå…è®¸ä¸åŒä¸»æœºä¸Šçš„è¿›ç¨‹ä¹‹é—´è¿›è¡Œé€šä¿¡ã€‚</td>
<td style="text-align: left;">å¯ä»¥è·¨ç½‘ç»œé€šä¿¡ï¼Œçµæ´»ã€‚</td>
<td style="text-align: left;">é€šç”¨æ€§å¼ºï¼Œé€‚ç”¨äºåˆ†å¸ƒå¼ç³»ç»Ÿã€‚</td>
<td style="text-align: left;">æ€§èƒ½ç›¸å¯¹è¾ƒä½ï¼Œé…ç½®å¤æ‚ã€‚</td>
<td style="text-align: left;">åˆ†å¸ƒå¼ç³»ç»Ÿã€å®¢æˆ·ç«¯-æœåŠ¡å™¨æ¶æ„ã€‚</td>
</tr>
<tr>
<td style="text-align: left;">æ–‡ä»¶/è®°å½•é”å®šï¼ˆFile/Record Lockingï¼‰</td>
<td style="text-align: left;">é€šè¿‡é”å®šæ–‡ä»¶æˆ–è®°å½•æ¥é˜²æ­¢å¤šä¸ªè¿›ç¨‹åŒæ—¶è®¿é—®åŒä¸€æ–‡ä»¶æˆ–è®°å½•ã€‚</td>
<td style="text-align: left;">ç”¨äºæ–‡ä»¶å…±äº«åœºæ™¯ã€‚</td>
<td style="text-align: left;">é˜²æ­¢æ•°æ®ä¸ä¸€è‡´ã€‚</td>
<td style="text-align: left;">æ€§èƒ½å½±å“ï¼Œé”å®šç®¡ç†å¤æ‚ã€‚</td>
<td style="text-align: left;">å¤šè¿›ç¨‹è®¿é—®åŒä¸€æ–‡ä»¶çš„åœºæ™¯ã€‚</td>
</tr>
<tr>
<td style="text-align: left;">å†…å­˜æ˜ å°„æ–‡ä»¶ï¼ˆMemory-Mapped Filesï¼‰</td>
<td style="text-align: left;">å°†æ–‡ä»¶æ˜ å°„åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œå¤šä¸ªè¿›ç¨‹å¯ä»¥é€šè¿‡æ˜ å°„çš„å†…å­˜åŒºåŸŸå…±äº«æ–‡ä»¶æ•°æ®ã€‚</td>
<td style="text-align: left;">ç»“åˆæ–‡ä»¶I/Oå’Œå…±äº«å†…å­˜çš„ä¼˜ç‚¹ã€‚</td>
<td style="text-align: left;">é«˜æ•ˆå¤„ç†å¤§æ–‡ä»¶ã€‚</td>
<td style="text-align: left;">å¤æ‚åº¦è¾ƒé«˜ï¼Œéœ€è¦ç®¡ç†æ–‡ä»¶æ˜ å°„ã€‚</td>
<td style="text-align: left;">å¤§æ–‡ä»¶å…±äº«å’Œå¤„ç†ï¼Œå¦‚æ•°æ®åº“ç³»ç»Ÿã€‚</td>
</tr>
</tbody>
</table>
<p>â€‹   </p>
<h2 id="_16">è¿›ç¨‹çº¿ç¨‹åŒºåˆ«</h2>
<p><strong>è¿›ç¨‹ã€çº¿ç¨‹åŒºåˆ«</strong></p>
<p>è¿›ç¨‹å’Œçº¿ç¨‹æ˜¯æ“ä½œç³»ç»Ÿå¹¶å‘è®¾è®¡çš„æ ¸å¿ƒæ¦‚å¿µï¼Œä¸»è¦åŒºåˆ«ä½“ç°åœ¨ <strong>èµ„æºéš”ç¦»æ€§ã€æ‰§è¡Œç²’åº¦ã€é€šä¿¡æœºåˆ¶</strong> ç­‰æ–¹é¢ï¼Œä»¥ä¸‹æ˜¯è¯¦ç»†å¯¹æ¯”ï¼š</p>
<hr />
<h4 id="1_1"><strong>1. æ ¸å¿ƒå®šä¹‰</strong></h4>
<ul>
<li>
<p><strong>è¿›ç¨‹</strong>ï¼š 
    æ“ä½œç³»ç»Ÿ<strong>èµ„æºåˆ†é…çš„åŸºæœ¬å•ä½</strong>ï¼Œæ‹¥æœ‰ç‹¬ç«‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€æ–‡ä»¶æè¿°ç¬¦ã€ä¿¡å·å¤„ç†å™¨ç­‰èµ„æºã€‚ 
    <strong>ç¤ºä¾‹</strong>ï¼šæµè§ˆå™¨ä¸­æ¯ä¸ªæ ‡ç­¾é¡µé€šå¸¸ä½œä¸ºç‹¬ç«‹è¿›ç¨‹è¿è¡Œï¼Œé˜²æ­¢å•é¡µé¢å´©æºƒå½±å“æ•´ä¸ªæµè§ˆå™¨ã€‚</p>
</li>
<li>
<p><strong>çº¿ç¨‹</strong>ï¼š 
    æ“ä½œç³»ç»Ÿ<strong>è°ƒåº¦çš„åŸºæœ¬å•ä½</strong>ï¼Œå…±äº«è¿›ç¨‹çš„èµ„æºï¼ˆå¦‚å†…å­˜ã€æ–‡ä»¶ï¼‰ï¼Œä½†æ‹¥æœ‰ç‹¬ç«‹çš„æ ˆã€å¯„å­˜å™¨å’Œç¨‹åºè®¡æ•°å™¨ã€‚
    <strong>ç¤ºä¾‹</strong>ï¼šWebæœåŠ¡å™¨ï¼ˆå¦‚Nginxï¼‰ä½¿ç”¨å¤šçº¿ç¨‹å¤„ç†å¹¶å‘è¯·æ±‚ï¼Œå…±äº«ç›‘å¬ç«¯å£å’Œç¼“å­˜æ•°æ®ã€‚</p>
</li>
</ul>
<hr />
<h4 id="2_1"><strong>2. å…³é”®å·®å¼‚</strong></h4>
<table>
<thead>
<tr>
<th><strong>ç»´åº¦</strong></th>
<th><strong>è¿›ç¨‹</strong></th>
<th><strong>çº¿ç¨‹</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>åœ°å€ç©ºé—´</strong></td>
<td>ç‹¬ç«‹è™šæ‹Ÿåœ°å€ç©ºé—´ï¼ˆéœ€åˆ‡æ¢é¡µè¡¨ï¼‰</td>
<td>å…±äº«è¿›ç¨‹åœ°å€ç©ºé—´ï¼ˆæ— éœ€åˆ‡æ¢é¡µè¡¨ï¼‰</td>
</tr>
<tr>
<td><strong>èµ„æºéš”ç¦»æ€§</strong></td>
<td>å®Œå…¨éš”ç¦»ï¼ˆå†…å­˜ã€æ–‡ä»¶ã€CPUæ—¶é—´ç‰‡ç­‰ï¼‰</td>
<td>å…±äº«è¿›ç¨‹èµ„æºï¼ˆå†…å­˜ã€æ–‡ä»¶ï¼‰ï¼Œéš”ç¦»æ ˆ/å¯„å­˜å™¨</td>
</tr>
<tr>
<td><strong>åˆ›å»º/åˆ‡æ¢å¼€é”€</strong></td>
<td>é«˜ï¼ˆå¤åˆ¶é¡µè¡¨ã€åˆ·æ–°TLBã€å†…æ ¸æ•°æ®ç»“æ„ï¼‰</td>
<td>ä½ï¼ˆä»…éœ€åˆ†é…æ ˆå’Œå¯„å­˜å™¨ä¸Šä¸‹æ–‡ï¼‰</td>
</tr>
<tr>
<td><strong>é€šä¿¡æœºåˆ¶</strong></td>
<td>å¤æ‚ï¼ˆç®¡é“ã€å…±äº«å†…å­˜ã€Socketç­‰IPCæœºåˆ¶ï¼‰</td>
<td>ç›´æ¥è¯»å†™å…±äº«å†…å­˜ï¼ˆéœ€åŒæ­¥æœºåˆ¶å¦‚é”/ä¿¡å·é‡ï¼‰</td>
</tr>
<tr>
<td><strong>å®¹é”™æ€§</strong></td>
<td>é«˜ï¼ˆè¿›ç¨‹å´©æºƒä¸å½±å“å…¶ä»–è¿›ç¨‹ï¼‰</td>
<td>ä½ï¼ˆçº¿ç¨‹å´©æºƒå¯èƒ½å¯¼è‡´æ•´ä¸ªè¿›ç¨‹ç»ˆæ­¢ï¼‰</td>
</tr>
<tr>
<td><strong>ç³»ç»Ÿè°ƒç”¨</strong></td>
<td><code>fork()</code>, <code>exec()</code>, <code>wait()</code></td>
<td><code>pthread_create()</code>, <code>clone(CLONE_VM)</code></td>
</tr>
</tbody>
</table>
<hr />
<h4 id="3_1"><strong>3. è®¾è®¡æ„ä¹‰ä¸åœºæ™¯</strong></h4>
<ul>
<li>
<p><strong>é€‰æ‹©è¿›ç¨‹çš„åœºæ™¯</strong>ï¼š</p>
<ul>
<li>éœ€è¦å¼ºéš”ç¦»æ€§ï¼ˆå¦‚å®‰å…¨æ•æ„Ÿçš„æ²™ç›’ç¯å¢ƒï¼‰ã€‚</li>
<li>å¤šä»»åŠ¡éœ€ç‹¬ç«‹è¿è¡Œï¼ˆå¦‚åŒæ—¶è¿è¡Œæµè§ˆå™¨å’Œç¼–è¯‘å™¨ï¼‰ã€‚
    <strong>ä»£ä»·</strong>ï¼šä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€å¤§ï¼Œé€šä¿¡æˆæœ¬é«˜ã€‚</li>
</ul>
</li>
<li>
<p><strong>é€‰æ‹©çº¿ç¨‹çš„åœºæ™¯</strong>ï¼š </p>
<ul>
<li>é«˜å¹¶å‘ä»»åŠ¡ï¼ˆå¦‚æ•°æ®åº“è¿æ¥æ± ã€å®æ—¶æ•°æ®å¤„ç†ï¼‰ã€‚ </li>
<li>éœ€è¦é«˜æ•ˆå…±äº«æ•°æ®ï¼ˆå¦‚GUIåº”ç”¨çš„äº‹ä»¶å¤„ç†çº¿ç¨‹ï¼‰ã€‚ 
    <strong>é£é™©</strong>ï¼šéœ€è°¨æ…å¤„ç†ç«æ€æ¡ä»¶ï¼ˆRace Conditionsï¼‰å’Œæ­»é”ã€‚</li>
</ul>
</li>
</ul>
<hr />
<h4 id="4-linux"><strong>4. åº•å±‚å®ç°ï¼ˆä»¥Linuxä¸ºä¾‹ï¼‰</strong></h4>
<ul>
<li><strong>è¿›ç¨‹</strong>ï¼šé€šè¿‡<code>fork()</code>ç³»ç»Ÿè°ƒç”¨åˆ›å»ºï¼Œå†…æ ¸å¤åˆ¶çˆ¶è¿›ç¨‹çš„<code>task_struct</code>å’Œ<code>mm_struct</code>ï¼ˆåœ°å€ç©ºé—´æè¿°ç¬¦ï¼‰ï¼Œé‡‡ç”¨<strong>å†™æ—¶å¤åˆ¶ï¼ˆCopy-on-Writeï¼‰</strong> ä¼˜åŒ–å†…å­˜å¤åˆ¶å¼€é”€ã€‚</li>
<li><strong>çº¿ç¨‹</strong>ï¼šé€šè¿‡<code>clone()</code>ç³»ç»Ÿè°ƒç”¨åˆ›å»ºï¼ŒæŒ‡å®š<code>CLONE_VM</code>æ ‡å¿—å…±äº«åœ°å€ç©ºé—´ï¼Œçº¿ç¨‹çš„<code>task_struct</code>å¤ç”¨è¿›ç¨‹çš„<code>mm_struct</code>ã€‚</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">// Linuxä¸­åˆ›å»ºçº¿ç¨‹çš„ç®€åŒ–é€»è¾‘</span>
<span class="n">clone</span><span class="p">(</span><span class="n">CLONE_VM</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">CLONE_FS</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">CLONE_FILES</span><span class="p">,</span><span class="w"> </span><span class="n">stack_ptr</span><span class="p">,</span><span class="w"> </span><span class="p">...);</span>
</code></pre></div>
<hr />
<h4 id="5"><strong>5. é«˜çº§æ‰©å±•</strong></h4>
<ul>
<li><strong>åç¨‹ï¼ˆCoroutineï¼‰</strong>ï¼šç”¨æˆ·çº§çº¿ç¨‹ï¼Œç”±ç¨‹åºè‡ªè¡Œè°ƒåº¦ï¼ˆå¦‚Goçš„Goroutineï¼‰ï¼Œåˆ‡æ¢å¼€é”€æä½ï¼ˆçº³ç§’çº§ï¼‰ï¼Œé€‚ç”¨äºç™¾ä¸‡çº§å¹¶å‘ã€‚</li>
<li><strong>å®¹å™¨æŠ€æœ¯</strong>ï¼šç°ä»£å®¹å™¨ï¼ˆå¦‚Dockerï¼‰æœ¬è´¨æ˜¯è½»é‡çº§è¿›ç¨‹ç»„ï¼Œé€šè¿‡å‘½åç©ºé—´ï¼ˆNamespaceï¼‰å’Œæ§åˆ¶ç»„ï¼ˆCGroupï¼‰å®ç°èµ„æºéš”ç¦»ã€‚</li>
</ul>
<hr />
<h3 id="30"><strong>æ€»ç»“å›ç­”ï¼ˆ30ç§’ç²¾ç®€ç‰ˆï¼‰</strong></h3>
<p>â€œè¿›ç¨‹æ˜¯èµ„æºéš”ç¦»çš„å•ä½ï¼Œæ‹¥æœ‰ç‹¬ç«‹åœ°å€ç©ºé—´ï¼Œé€‚åˆéœ€è¦é«˜å®‰å…¨æ€§çš„åœºæ™¯ï¼›çº¿ç¨‹æ˜¯æ‰§è¡Œè°ƒåº¦çš„å•ä½ï¼Œå…±äº«è¿›ç¨‹èµ„æºï¼Œé€‚åˆé«˜å¹¶å‘ä»»åŠ¡ã€‚è¿›ç¨‹åˆ‡æ¢å¼€é”€å¤§ä½†éš”ç¦»æ€§å¼ºï¼Œçº¿ç¨‹å¼€é”€å°ä½†éœ€å¤„ç†åŒæ­¥é—®é¢˜ã€‚ç°ä»£ç³»ç»Ÿå¸¸æ··åˆä½¿ç”¨äºŒè€…ï¼Œå¦‚Chromeç”¨å¤šè¿›ç¨‹éš”ç¦»æ ‡ç­¾é¡µï¼Œç”¨å¤šçº¿ç¨‹åŠ é€Ÿæ¸²æŸ“ã€‚â€</p>
<h2 id="_17">å…±äº«å†…å­˜çš„åŸç†</h2>
<p><strong><mark>TODO</mark></strong></p>
<p><code>mmap</code> ç³»ç»Ÿè°ƒç”¨ï¼Œkernel åˆ†é…ä¸€å—å†…å­˜åï¼Œå°†å…¶æ˜ å°„åˆ°ä¸åŒè¿›ç¨‹å„è‡ªç‹¬æœ‰çš„è¿›ç¨‹åœ°å€ç©ºé—´ã€‚</p>
<h2 id="page-fault">Page fault</h2>
<p><a href="https://tinylab.org/riscv-mmu/#:~:text=å½“ D ä½ä¸º 0 æ—¶ï¼Œå¯¹æ­¤é¡µé¢è¿›è¡Œå†™æ“ä½œä¼šè§¦å‘ Page Fault (store),Page Fault (å¯¹åº”è®¿é—® ç±»å‹) å¼‚å¸¸ä¸”å°†è¯¥åŸŸç½®ä¸º 1ã€‚ è¯¥ä½å¤ä½ä¸º 0ã€‚">RISCV MMU æ¦‚è¿° - æ³°æ™“ç§‘æŠ€</a></p>
<h4 id="1-page-fault"><strong>1. Page Faultè§¦å‘æ¡ä»¶</strong></h4>
<p>å½“CPUè®¿é—®<strong>è™šæ‹Ÿå†…å­˜åœ°å€</strong>æ—¶ï¼Œè‹¥å‘ç”Ÿä»¥ä¸‹ä»»ä¸€æƒ…å†µï¼Œå°†è§¦å‘Page Faultå¼‚å¸¸ï¼š
- <strong>é¡µé¢æœªåŠ è½½</strong>ï¼ˆMajor Faultï¼‰ï¼šè™šæ‹Ÿåœ°å€æœ‰æ•ˆï¼Œä½†å¯¹åº”ç‰©ç†é¡µæœªè½½å…¥å†…å­˜ï¼ˆå¦‚æ–‡ä»¶æ˜ å°„é¡µæœªè¯»å–ï¼‰ã€‚
- <strong>æƒé™é”™è¯¯</strong>ï¼ˆMinor Faultï¼‰ï¼šè®¿é—®æ–¹å¼ï¼ˆè¯»/å†™/æ‰§è¡Œï¼‰ä¸é¡µè¡¨é¡¹æƒé™ä¸åŒ¹é…ï¼ˆå¦‚å†™åªè¯»é¡µï¼‰ã€‚
- <strong>éæ³•è®¿é—®</strong>ï¼ˆSegmentation Faultï¼‰ï¼šè™šæ‹Ÿåœ°å€æ— æ•ˆï¼ˆå¦‚ç©ºæŒ‡é’ˆè®¿é—®ï¼‰ã€‚</p>
<hr />
<h4 id="2_2"><strong>2. è§¦å‘ä¸å¤„ç†çš„è´£ä»»æ–¹</strong></h4>
<ul>
<li>
<p><strong>ç¡¬ä»¶è§¦å‘</strong>ï¼šç”±<strong>CPUçš„MMUï¼ˆå†…å­˜ç®¡ç†å•å…ƒï¼‰</strong>å®Œæˆï¼š</p>
</li>
<li>
<p>åœ¨åœ°å€è½¬æ¢è¿‡ç¨‹ä¸­ï¼Œè‹¥ç›®æ ‡é¡µè¡¨é¡¹æ ‡è®°ä¸º"ä¸å­˜åœ¨"ï¼ˆPresentä½=0ï¼‰æˆ–æƒé™ä¸ç¬¦ï¼ŒMMUæŠ›å‡ºPage Faultå¼‚å¸¸ï¼Œé€šçŸ¥ CPUã€‚</p>
</li>
<li>
<p>CPUè®°å½•é”™è¯¯ä¿¡æ¯åˆ°<strong><code>CR2</code>/<code>mtval</code></strong>ï¼ˆä¿å­˜è§¦å‘å¼‚å¸¸çš„è™šæ‹Ÿåœ°å€ï¼‰å’Œé”™è¯¯ä»£ç ï¼ˆæŒ‡ç¤ºé”™è¯¯ç±»å‹ï¼‰ã€‚</p>
</li>
<li>
<p><strong>è½¯ä»¶å¤„ç†</strong>ï¼šç”±<strong>æ“ä½œç³»ç»Ÿå†…æ ¸çš„Page Fault Handler</strong>å“åº”ï¼š</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">// Linuxå†…æ ¸å¤„ç†æµç¨‹ç¤ºä¾‹ï¼ˆä¼ªä»£ç ï¼‰</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">handle_page_fault</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">pt_regs</span><span class="w"> </span><span class="o">*</span><span class="n">regs</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">error_code</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_cr2</span><span class="p">();</span><span class="w">  </span><span class="c1">// è·å–è§¦å‘åœ°å€</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_area_struct</span><span class="w"> </span><span class="o">*</span><span class="n">vma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">find_vma</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">vma</span><span class="p">)</span><span class="w"> </span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">invalid_access</span><span class="p">;</span><span class="w">            </span><span class="c1">// åœ°å€ä¸åœ¨è¿›ç¨‹åœ°å€ç©ºé—´</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error_code</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">PF_PROT</span><span class="p">)</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">permission_denied</span><span class="p">;</span><span class="w">         </span><span class="c1">// æƒé™é”™è¯¯</span>

<span class="w">    </span><span class="n">handle_mm_fault</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="p">);</span><span class="w">      </span><span class="c1">// åˆ†é…ç‰©ç†é¡µ/è°ƒæ•´é¡µè¡¨</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>

<span class="nl">invalid_access</span><span class="p">:</span>
<span class="w">    </span><span class="n">force_sig</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">);</span><span class="w">                 </span><span class="c1">// å‘é€æ®µé”™è¯¯ä¿¡å·</span>
<span class="p">}</span>
</code></pre></div>
<hr />
<h4 id="3_2"><strong>3. å…¸å‹å¤„ç†åœºæ™¯</strong></h4>
<table>
<thead>
<tr>
<th><strong>åœºæ™¯</strong></th>
<th><strong>å¤„ç†åŠ¨ä½œ</strong></th>
<th><strong>ç¤ºä¾‹</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Major Fault</strong></td>
<td>ä»ç£ç›˜åŠ è½½é¡µé¢åˆ°ç‰©ç†å†…å­˜</td>
<td>ç¨‹åºé¦–æ¬¡è®¿é—®<code>.text</code>ä»£ç æ®µ</td>
</tr>
<tr>
<td><strong>Copy-on-Write</strong></td>
<td>å¤åˆ¶åŸé¡µå¹¶ä¿®æ”¹é¡µè¡¨é¡¹</td>
<td><code>fork()</code>åå­è¿›ç¨‹å†™å…±äº«å†…å­˜</td>
</tr>
<tr>
<td><strong>å †æ ˆè‡ªåŠ¨æ‰©å±•</strong></td>
<td>åˆ†é…æ–°çš„ç‰©ç†é¡µå¹¶æ˜ å°„</td>
<td>æ ˆç©ºé—´ä¸è¶³æ—¶è‡ªåŠ¨å¢é•¿</td>
</tr>
<tr>
<td><strong>å†…å­˜æ˜ å°„æ–‡ä»¶</strong></td>
<td>ä»æ–‡ä»¶è¯»å–æ•°æ®å¡«å……é¡µé¢</td>
<td><code>mmap</code>è®¿é—®æ–‡ä»¶å†…å®¹</td>
</tr>
<tr>
<td><strong>Swap In</strong></td>
<td>ä»äº¤æ¢åˆ†åŒºæ¢å…¥é¡µé¢</td>
<td>ç‰©ç†å†…å­˜ä¸è¶³åè¢«æ¢å‡ºçš„é¡µé‡æ–°è®¿é—®</td>
</tr>
</tbody>
</table>
<hr />
<h4 id="4"><strong>4. æ€§èƒ½è§‚æµ‹ä¸è°ƒè¯•</strong></h4>
<ul>
<li>
<p><strong>ä½¿ç”¨å·¥å…·è§‚æµ‹Page Fault</strong>ï¼š
  <div class="highlight"><pre><span></span><code><span class="c1"># ç»Ÿè®¡è¿›ç¨‹çš„Page Faultæ¬¡æ•°ï¼ˆminflt/s majflt/sï¼‰</span>
pidstat<span class="w"> </span>-r<span class="w"> </span>-p<span class="w"> </span>&lt;PID&gt;<span class="w"> </span><span class="m">1</span>

<span class="c1"># ä½¿ç”¨perfè·Ÿè¸ªPage Faultäº‹ä»¶</span>
perf<span class="w"> </span>record<span class="w"> </span>-e<span class="w"> </span>page-faults<span class="w"> </span>-ag<span class="w"> </span>--<span class="w"> </span>sleep<span class="w"> </span><span class="m">5</span>
perf<span class="w"> </span>script
</code></pre></div></p>
</li>
<li>
<p><strong>Pythonæµ‹è¯•è„šæœ¬è§¦å‘ç‰¹å®šåœºæ™¯</strong>ï¼š
  <div class="highlight"><pre><span></span><code><span class="c1"># å¼ºåˆ¶è§¦å‘Major Faultï¼ˆæ–‡ä»¶æ˜ å°„ï¼‰</span>
<span class="kn">import</span> <span class="nn">mmap</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;test.bin&quot;</span><span class="p">,</span> <span class="s2">&quot;r+b&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">mm</span> <span class="o">=</span> <span class="n">mmap</span><span class="o">.</span><span class="n">mmap</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">mm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xff</span><span class="s1">&#39;</span>  <span class="c1"># ç¬¬ä¸€æ¬¡è®¿é—®è§¦å‘æ–‡ä»¶é¡µåŠ è½½</span>
</code></pre></div></p>
</li>
</ul>
<hr />
<h4 id="5_1"><strong>5. å…³é”®è®¾è®¡è€ƒé‡</strong></h4>
<ol>
<li><strong>å»¶è¿Ÿæ•æ„Ÿ</strong>ï¼šMajor Faultéœ€ç£ç›˜I/Oï¼Œè€—æ—¶å¯èƒ½è¾¾æ¯«ç§’çº§ï¼Œéœ€é€šè¿‡é¢„è¯»ï¼ˆreadaheadï¼‰ä¼˜åŒ–ã€‚</li>
<li><strong>å†…å­˜è¶…è½½ç®¡ç†</strong>ï¼šé€šè¿‡é¡µé¢ç½®æ¢ç®—æ³•ï¼ˆLRU/Clockï¼‰é€‰æ‹©ç‰ºç‰²é¡µï¼Œé¿å…é¢‘ç¹SwapæŠ–åŠ¨ã€‚</li>
<li><strong>ç”¨æˆ·æ€åä½œ</strong>ï¼š<code>mlock()</code>å¯é”å®šå…³é”®é¡µé¢é¿å…æ¢å‡ºï¼Œ<code>madvise()</code>æä¾›è®¿é—®æ¨¡å¼æç¤ºã€‚</li>
</ol>
<hr />
<h4 id="6-rtos"><strong>6. å¯¹æ¯”RTOSçš„ç‰¹æ®Šæ€§</strong></h4>
<p>åœ¨<strong>å®æ—¶æ“ä½œç³»ç»Ÿï¼ˆå¦‚FreeRTOSï¼‰</strong>ä¸­ï¼š
- é€šå¸¸<strong>æ— è™šæ‹Ÿå†…å­˜æœºåˆ¶</strong>ï¼ŒPage Faultä¸å­˜åœ¨ã€‚
- å†…å­˜ç®¡ç†ä¸ºé™æ€åˆ†é…æˆ–ç®€å•åˆ†åŒºï¼Œç¡®ä¿ç¡®å®šæ€§å“åº”ã€‚
- è‹¥éœ€ç±»ä¼¼åŠŸèƒ½ï¼ˆå¦‚åŠ è½½å¤–éƒ¨æ•°æ®ï¼‰ï¼Œéœ€æ‰‹åŠ¨å®ç°åˆ†é¡µé€»è¾‘ã€‚</p>
<h2 id="risc-v">RISC-V ä¸Šä¸‹æ–‡åˆ‡æ¢</h2>
<blockquote>
<p>ä¸»è¦é…åˆæˆ‘è‡ªå·±å®ç°çš„å¤„ç†å™¨å’Œ OS å®ç°ä¸€æ­¥æ­¥è®²è§£ã€‚</p>
</blockquote>
<p>ç†è§£çš„æ ¸å¿ƒæ€æƒ³ï¼šæ¥ä¸­æ–­/å¼‚å¸¸çš„æ—¶å€™ï¼Œæˆ‘éœ€è¦ä¿å­˜ä¸Šä¸‹æ–‡çš„çŠ¶æ€/å¯„å­˜å™¨ç°åœºï¼Œé‚£å°±éœ€è¦å¼€è¾Ÿç©ºé—´æ¥ä¿å­˜ä¸€äº›å†…å®¹ï¼š OS æˆ–è€… am æ¡†æ¶ æŠŠä¸€æ®µå†…å­˜ç©ºé—´åˆå§‹åŒ–æˆç¨‹åºï¼ˆçº¿ç¨‹/è¿›ç¨‹ï¼‰èƒ½å¤Ÿè¿è¡Œçš„ä¸Šä¸‹æ–‡ï¼Œå¹¶åœ¨ä¸­æ–­/å¼‚å¸¸è¿”å›æ—¶åˆ‡æ¢åˆ°äº‹å…ˆå‡†å¤‡çš„ä¸Šä¸‹æ–‡ã€‚è¿™å°±èµ‹äºˆäº†æˆ‘ä»¬å®ç° â€œåˆ‡æ¢â€ çš„æ ¹æœ¬æœºåˆ¶ã€‚ä¸‹é¢è®¨è®ºæ›´å¤šä¸€äº›ç»†èŠ‚ã€‚    </p>
<p>é¦–å…ˆï¼Œæœ€ç®€å•ä»ä¸€ä¸ªç¨‹åºåˆ°å¤šé“ç¨‹åºçš„å‘å±•ï¼Œå°±æ˜¯ç›´æ¥å°†ä¸åŒçš„ç¨‹åºæ”¾åˆ°ç¼–å¥½çš„åœ°å€çš„å„ä¸ªéƒ¨åˆ†ï¼Œæ¯”å¦‚ï¼š<code>0x100~0x100</code> ç¬¬ä¸€ä¸ªç¨‹åºã€‚ã€ã€ä»¥æ­¤ç±»æ¨ã€‚</p>
<hr />
<p>åœ¨ä¹‹åï¼Œæ¯”è¾ƒç®€å•çš„çš„æ˜¯ï¼Œæœ€ç®€å•çš„ï¼Œåœ¨åªæœ‰å†…æ ¸ç©ºé—´çš„çš„æ—¶å€™ï¼Œæˆ–è€…è¯´åˆšå¼€å§‹å†™çš„æ—¶å€™ï¼Œåªæœ‰å†…æ ¸çº¿ç¨‹ï¼Œå¾ˆè‡ªç„¶çš„ï¼Œåªä¿å­˜äº†é€šç”¨å¯„å­˜å™¨å’Œä¸€äº›ç”¨åˆ°çš„çš„ç³»ç»Ÿç‰¹æ®Šå¯„å­˜å™¨ã€‚ </p>
<p>åˆ°è¿™é‡Œï¼Œå®é™…ä¸Šå°±æ˜¯æœ‰ç‚¹ç±»ä¼¼äº <code>thread-os</code>ï¼Œå°±æ˜¯ä»¥ thread ä¸ºå•ä½ï¼Œè¿›è¡Œä»»åŠ¡å¤„ç†ï¼Œä¿å­˜çš„è¿™äº›å†…å®¹æ˜¯æ¯ä¸€ä¸ªçº¿ç¨‹è‡ªå·±çš„çŠ¶æ€ï¼ˆregisterã€PCã€shared memoryï¼‰ã€‚å½“ç„¶ï¼Œè¿™ä¸ªæ—¶å€™çš„ç†è§£æ˜¯ ç¨‹åºéƒ½æ˜¯è¿è¡Œåœ¨å†…æ ¸æ€çš„ã€‚å†å²ä¸Šçš„è¿™ä¸ªé˜¶æ®µï¼Œå…¶å®æ˜¯æ²¡æœ‰è¿›ç¨‹è¿™ä¸€æ¦‚å¿µçš„ã€‚</p>
<p>åˆ°è¿™é‡Œå°±æœ‰ç‚¹åƒä¸€ä¸ªåµŒå…¥å¼æ“ä½œç³»ç»Ÿäº†ï¼Ÿè¿˜æ˜¯è¯´è¦æœ‰ç”¨æˆ·çº¿ç¨‹ï¼ˆä»»åŠ¡ï¼‰çš„æ‰æ˜¯ï¼Ÿ</p>
<hr />
<p>ç„¶åï¼Œæ·»åŠ æ‰©å±•å®ç°ï¼š</p>
<ul>
<li>
<p>å¤„ç†å™¨ï¼šæ·»åŠ å†…æ ¸æ€å’Œç”¨æˆ·æ€</p>
</li>
<li>
<p>OS</p>
<ul>
<li>
<p>æ·»åŠ  ç‰¹æƒçº§åŒºåˆ†ï¼Œå½“ç„¶ï¼Œåªæ˜¯ç®€å•åšä¸ªæ ‡å¿—ï¼Œå¹¶æ²¡æœ‰é™åˆ¶å„ç§æŒ‡ä»¤æ‰§è¡Œçš„ç‰¹æƒçº§ï¼›</p>
</li>
<li>
<p>ç„¶åæ·»åŠ ç”¨æˆ·çº¿ç¨‹çš„æ¦‚å¿µï¼Œè¿™ä¸ªæ—¶å€™ä¹Ÿåªæ˜¯ç®€å•çš„é€šè¿‡åœ°å€æ¥åˆ’åˆ†å†…æ ¸çº¿ç¨‹å’Œç”¨æˆ·çº¿ç¨‹ï¼ˆæ¯”å¦‚ <code>0x80000000</code> ä»¥ä¸Šä¸ºå†…æ ¸çº¿ç¨‹ï¼Œ<code>0x40000000~0x80000000</code> ä¸ºç”¨æˆ·çº¿ç¨‹çš„ã€‚ï¼‰</p>
</li>
</ul>
</li>
</ul>
<p>æœ‰ä¸€äº›å…·ä½“çš„ç»†èŠ‚å’Œæ”¹å˜ï¼š</p>
<p>ä¿å­˜ä¸Šä¸‹æ–‡çš„çš„æ—¶å€™ï¼Œé‚£å†…æ ¸åº”è¯¥ä¹Ÿå’Œç”¨æˆ·çº¿ç¨‹ä¸€æ ·æœ‰è‡ªå·±çš„æ ˆï¼Ÿè€Œä¸æ˜¯å’Œç”¨æˆ·å…±ç”¨ä¸€ä¸ªæ ˆï¼Œå› ä¸ºåˆ‡æ¢åˆ°å†…æ ¸çš„æ—¶å€™è¿˜æ˜¯ä¼šéœ€è¦ä¿å­˜</p>
<p>æ‰€ä»¥ï¼Œæˆ‘åŠ å…¥äº†å…³äºå†…æ ¸æ ˆå’Œç”¨æˆ·æ ˆçš„åˆ‡æ¢ï¼ˆæ€»ç»“å†…æ ¸æ ˆå’Œç”¨æˆ·æ ˆåˆ‡æ¢çš„é€»è¾‘ï¼‰ï¼Œä¹Ÿåªæ˜¯ç”¨ç®€å•çš„å¯„å­˜å™¨è¡¨ç¤ºå¤„äºå“ªä¸€ä¸ªç‰¹æƒçº§ï¼Œ<strong>å®ç°æ–¹å¼</strong>ï¼š</p>
<ul>
<li><strong>ç‰¹æƒæŒ‡ä»¤</strong>ï¼šä»…åœ¨å†…æ ¸æ€å¯æ‰§è¡Œï¼ˆå¦‚ä¿®æ”¹é¡µè¡¨ã€I/Oæ“ä½œï¼‰ã€‚</li>
<li><strong>ä¸­æ–­/å¼‚å¸¸å¤„ç†</strong>ï¼šç”¨æˆ·æ€ç¨‹åºè§¦å‘å¼‚å¸¸æ—¶åˆ‡æ¢åˆ°å†…æ ¸æ€ã€‚</li>
</ul>
<blockquote>
<p>è¿™ä¸ªæ—¶å€™è¿˜æ²¡æœ‰å¼•å…¥MMUä¸åˆ†é¡µæœºåˆ¶ã€‚</p>
<p>è€Œè¿™ä¸ªæ—¶å€™ç”¨çš„è¡¨è¿°è¿˜æ˜¯ çº¿ç¨‹ï¼Œæ²¡æœ‰ç”¨è¿›ç¨‹ï¼Œå› ä¸ºæ²¡æœ‰é€šè¿‡è™šæ‹Ÿå†…å­˜çš„æœºåˆ¶æ¥ä¿è¯ç¨‹åºçš„éš”ç¦»ï¼Œåªç”¨äº† ç‰¹æƒçº§æ¥ä¿æŠ¤ã€‚</p>
</blockquote>
<hr />
<p>ä½†ä¹‹åè¿›ä¸€æ­¥æ·±å…¥ï¼Œæˆ‘è¿˜å¼•å…¥äº† MMU å’Œé¡µè¡¨æœºåˆ¶ï¼Œæ”¯æŒè™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€çš„è½¬æ¢ã€‚è¿™ä¸ªæ—¶å€™åˆå¸¦æ¥äº†å¾ˆå¤šé—®é¢˜ï¼š</p>
<ul>
<li>è¦ä¸ºç”¨æˆ·è¿›ç¨‹å®ç°åœ°å€ç©ºé—´çš„å†…å®¹</li>
<li>å†…æ ¸æ ˆå’Œç”¨æˆ·æ ˆçš„è¿›ä¸€æ­¥åŒºåˆ†ï¼Œå°¤å…¶æ˜¯åœ¨ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ—¶å€™å¯¹äºå†…æ ¸æ ˆã€ç”¨æˆ·æ ˆåˆ‡æ¢ã€‚</li>
<li>åœ¨å¼€å¯ MMU çš„æƒ…å†µä¸‹ï¼Œæ¯ä¸ªç”¨æˆ·è¿›ç¨‹æœ‰è‡ªå·±çš„é¡µè¡¨åŸºåœ°å€ï¼Œå†…æ ¸è®¿é—®çš„éƒ½æ˜¯åŒä¸€ç‰‡ä»£ç ï¼Œä½†ä¹Ÿéœ€è¦æœ‰é¡µè¡¨ï¼Œè¿™å°±å¸¦æ¥äº†é—®é¢˜ï¼Œæ˜¯åœ¨æ¯ä¸€æ¬¡ä¸Šä¸‹</li>
</ul>
<p>å»çœ‹äº†å®é™…ç³»ç»Ÿçš„å®ç°ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="c1">// arch/riscv/include/asm/pgalloc.h</span>
<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sync_kernel_mappings</span><span class="p">(</span><span class="n">pgd_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgd</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">pgd</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">USER_PTRS_PER_PGD</span><span class="p">,</span>
<span class="w">           </span><span class="n">init_mm</span><span class="p">.</span><span class="n">pgd</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">USER_PTRS_PER_PGD</span><span class="p">,</span>
<span class="w">           </span><span class="p">(</span><span class="n">PTRS_PER_PGD</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">USER_PTRS_PER_PGD</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">pgd_t</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="n">pgd_t</span><span class="w"> </span><span class="o">*</span><span class="nf">pgd_alloc</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">pgd_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgd</span><span class="p">;</span>

<span class="w">    </span><span class="n">pgd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">pgd_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">__get_free_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">pgd</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">memset</span><span class="p">(</span><span class="n">pgd</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">USER_PTRS_PER_PGD</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">pgd_t</span><span class="p">));</span>
<span class="w">        </span><span class="cm">/* Copy kernel mappings */</span>
<span class="w">        </span><span class="n">sync_kernel_mappings</span><span class="p">(</span><span class="n">pgd</span><span class="p">);</span><span class="w">                                                                                        </span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">pgd</span><span class="p">;</span>
<span class="p">}</span>


<span class="c1">// arch/riscv/include/asm/pgtable.h</span>

<span class="cm">/* Number of entries in the page global directory */</span>
<span class="cp">#define PTRS_PER_PGD    (PAGE_SIZE / sizeof(pgd_t))</span>
<span class="cm">/* Number of entries in the page table */</span>
<span class="cp">#define PTRS_PER_PTE    (PAGE_SIZE / sizeof(pte_t))</span>

<span class="cm">/* Number of PGD entries that a user-mode program can use */</span>
<span class="cp">#define USER_PTRS_PER_PGD   (TASK_SIZE / PGDIR_SIZE)  </span>


<span class="c1">// arch/riscv/include/asm/pgtable-32.h</span>
<span class="cm">/* Size of region mapped by a page global directory */</span>
<span class="cp">#define PGDIR_SHIFT     22</span>
<span class="cp">#define PGDIR_SIZE      (_AC(1, UL) &lt;&lt; PGDIR_SHIFT)                                                                       </span>
<span class="cp">#define PGDIR_MASK      (~(PGDIR_SIZE - 1))</span>

<span class="c1">// arch/riscv/include/asm/pgtable-64.h</span>
<span class="cp">#define PGDIR_SHIFT_L3  30</span>
<span class="cp">#define PGDIR_SHIFT_L4  39</span>
<span class="cp">#define PGDIR_SHIFT_L5  48</span>
<span class="cp">#define PGDIR_SIZE_L3   (_AC(1, UL) &lt;&lt; PGDIR_SHIFT_L3)</span>

<span class="cp">#define PGDIR_SHIFT     (pgtable_l5_enabled ? PGDIR_SHIFT_L5 : \</span>
<span class="cp">        (pgtable_l4_enabled ? PGDIR_SHIFT_L4 : PGDIR_SHIFT_L3))</span>
<span class="cm">/* Size of region mapped by a page global directory */</span>
<span class="cp">#define PGDIR_SIZE      (_AC(1, UL) &lt;&lt; PGDIR_SHIFT)                                                                       </span>
<span class="cp">#define PGDIR_MASK      (~(PGDIR_SIZE - 1))</span>
</code></pre></div>
<p>é¡µç›®å½•ä¸€çº§ä¸€å…±æœ‰å¤šå°‘ä¸ªé¡µè¡¨é¡¹ã€‚ç®¡ç†æ•´ä¸ªç³»ç»Ÿè™šæ‹Ÿå†…å­˜ï¼ŒæŒ‰å½“å‰çš„é¡µè¡¨å¤§å°ï¼Œéœ€è¦å¤šå°‘ä¸ªé¡µç›®å½•é¡¹ã€‚</p>
<blockquote>
<p><strong>æ­¥éª¤è§£æ</strong>ï¼š</p>
<ol>
<li>
<p><strong>è™šæ‹Ÿåœ°å€åˆ’åˆ†</strong>ï¼š</p>
<ul>
<li>RISC-V Sv39 ä½¿ç”¨ 39 ä½è™šæ‹Ÿåœ°å€ï¼Œåˆ†ä¸ºä¸‰çº§é¡µè¡¨ç´¢å¼•ï¼š<ul>
<li><strong>VPN2</strong>ï¼ˆ9 ä½ï¼‰ï¼šç´¢å¼•é¡µå…¨å±€ç›®å½•ï¼ˆPGDï¼‰ã€‚</li>
<li><strong>VPN1</strong>ï¼ˆ9 ä½ï¼‰ï¼šç´¢å¼•é¡µä¸­é—´ç›®å½•ï¼ˆPMDï¼‰ã€‚</li>
<li><strong>VPN0</strong>ï¼ˆ9 ä½ï¼‰ï¼šç´¢å¼•é¡µè¡¨é¡¹ï¼ˆPTEï¼‰ã€‚</li>
</ul>
</li>
<li>å‰©ä½™ 12 ä½ä¸ºé¡µå†…åç§»ã€‚</li>
</ul>
</li>
<li>
<p><strong>å†…æ ¸ç©ºé—´åœ°å€èŒƒå›´</strong>ï¼š</p>
<ul>
<li>
<p>å†…æ ¸è™šæ‹Ÿåœ°å€é€šå¸¸ä» <code>0x80000000</code> å¼€å§‹ï¼Œä¾‹å¦‚ <code>0x80000000~0xFFFFFFFFFFFFFFFF</code>ã€‚</p>
</li>
<li>
<p>å¯¹äºåœ°å€ <code>0x80000000</code>ï¼Œå…¶ VPN2 å€¼ä¸ºï¼š</p>
<p>å¤åˆ¶</p>
<div class="highlight"><pre><span></span><code>VPN2 = (0x80000000 &gt;&gt; 30) &amp; 0x1FF = 256
</code></pre></div>
<p>å› æ­¤ï¼Œå†…æ ¸ç©ºé—´çš„ PGD æ¡ç›®ç´¢å¼•èŒƒå›´ä¸º <strong>256~511</strong>ã€‚</p>
</li>
</ul>
</li>
<li>
<p><strong>å†…æ ¸é¡µè¡¨åˆå§‹åŒ–</strong>ï¼š</p>
<ul>
<li>å†…æ ¸å¯åŠ¨æ—¶ï¼Œé€šè¿‡ <code>paging_init()</code> åˆå§‹åŒ–å†…æ ¸é¡µè¡¨ï¼ˆ<code>swapper_pg_dir</code>ï¼‰ï¼Œå°†å†…æ ¸ä»£ç ã€è®¾å¤‡å†…å­˜ç­‰æ˜ å°„åˆ°é«˜åŠéƒ¨åˆ†è™šæ‹Ÿåœ°å€ã€‚</li>
<li>ç”¨æˆ·è¿›ç¨‹åˆ›å»ºæ—¶ï¼Œå¤åˆ¶å†…æ ¸ PGD çš„é«˜åŠéƒ¨åˆ†æ¡ç›®åˆ°ç”¨æˆ·é¡µè¡¨ï¼Œç¡®ä¿å†…æ ¸æ˜ å°„å…±äº«ã€‚</li>
</ul>
</li>
</ol>
</blockquote>
<p>å…·ä½“å¯ä»¥çœ‹çœ‹ kernel memory layout çš„æ–‡æ¡£ï¼š<a href="https://www.kernel.org/doc/html/latest/arch/riscv/vm-layout.html">Virtual Memory Layout on RISC-V Linux â€” The Linux Kernel documentation</a></p>
<blockquote>
<p>äº†è§£åˆ°çš„ä¸€äº›ç›¸å¯¹å‰æ²¿èµ„æ–™ï¼š</p>
<p><a href="https://unix.stackexchange.com/questions/598171/how-are-the-kernel-page-tables-shared-among-all-processes">memory - How are the kernel page tables shared among all processes? - Unix &amp; Linux Stack Exchange</a></p>
</blockquote>
<p>ç»¼ä¸Šï¼š</p>
<p>æ ¹æ®ä¹‹å‰çš„å¤šæ¬¡å›ç­”ï¼Œæˆ‘ç°åœ¨æ€»ç»“å‡ºæˆ‘è‡ªå·±å®ç°çš„RISC-V çš„OSçš„å…³äºé¡µè¡¨çš„ç›®å‰çš„æœºåˆ¶ã€‚æˆ‘ç†è§£çš„å¦‚ä¸‹ï¼š</p>
<p>é¦–å…ˆï¼Œåœ¨åªæœ‰ä¸€ä¸ªé¡µè¡¨å¯„å­˜å™¨çš„æ—¶å€™ï¼ˆä¸åƒARMçš„åŒé¡µè¡¨ï¼‰ï¼Œåœ¨ç³»ç»Ÿåˆšåˆšå¯åŠ¨çš„æ—¶å€™ï¼Œåšçš„æ˜¯ <code>vme_init</code> çš„å·¥ä½œï¼Œä¸ºæè¿°å†…æ ¸é¡µè¡¨çš„ç»“æ„åˆ†é…ä½¿ç”¨ç©ºé—´ï¼š<code>kas.ptr = pgalloc_f(PGSIZE);</code> æ‰€ä»¥è¿™ä¸ª <code>ptr</code> æŒ‡çš„æ˜¯å†…æ ¸ç©ºé—´ä¸‹çš„é¡µè¡¨åŸºåœ°å€ï¼Œæ˜¯æ‰€æœ‰ç¨‹åºå…±äº«çš„ï¼</p>
<p>ç„¶åï¼Œæ¥ç€ä¸ºç¨‹åºå†…å­˜åˆ’åˆ†å¥½çš„çš„æ¯ä¸€éƒ¨åˆ†å†…å­˜åŒºï¼ˆzoneã€æˆ–è€…ç†è§£ä¸ºæ± ï¼Ÿï¼‰è¿›è¡ŒMMUæ˜ å°„ï¼›æœ€åå°†å†…æ ¸çš„é¡µè¡¨åŸºå€æ”¾åˆ° <code>satp</code> å¯„å­˜å™¨ä¸­ï¼š<code>set_satp(kas.ptr);</code>ã€‚</p>
<p>æ¥ç€ï¼Œå°±æ˜¯ç”¨æˆ·è¿›ç¨‹çš„å†…å®¹ï¼Œæ—¢ç„¶ç°åœ¨æœ‰äº†MMUçš„æ”¯æŒï¼Œé‚£å°±è¦åˆ›å»ºã€è§„åˆ’è¿›ç¨‹åœ°å€ç©ºé—´äº†ã€‚</p>
<ul>
<li>
<p>é¦–å…ˆåšçš„å°±æ˜¯å»ºç«‹ç”¨æˆ·è¿›ç¨‹åœ°å€ç©ºé—´ <code>protect(&amp;pcb-&gt;as);</code></p>
<p>è¿™ä¸ªæ—¶å€™åšçš„å°±æ˜¯ï¼Œä¸ºè¯¥è¿›ç¨‹åˆ†é…æè¿°ç”¨æˆ·é¡µè¡¨çš„ç»“æ„çš„ç©ºé—´ï¼š <code>PTE *updir = (PTE*)(pgalloc_usr(PGSIZE));  as-&gt;ptr = updir;</code></p>
</li>
<li>
<p>å¦å¤–ï¼Œå‘Šè¯‰ç”¨æˆ·è¿›ç¨‹å¯ä»¥ç”¨çš„èŒƒå›´ï¼š<code>#define USER_SPACE RANGE(0x40000000, 0x80000000)</code>ã€ç„¶åç›®å‰ OS é…ç½®çš„é¡µè¡¨å¤§å°ï¼š4KBã€‚</p>
</li>
<li>
<p><strong>ç„¶åæœ€é‡è¦çš„æ˜¯ï¼Œè¿›è¡Œå†…æ ¸é¡µè¡¨çš„æ‹·è´ï¼<code>memcpy(updir, kas.ptr, PGSIZE);</code></strong></p>
<blockquote>
<p>è¿™é‡Œä¸ºä»€ä¹ˆæ˜¯è¿™ä¹ˆæ˜ å°„ï¼Œè¿˜çœŸæœ‰ç‚¹æ„æ€ï¼ï¼ï¼</p>
<p>è¿˜ç•™äº†ä¸€äº›ç–‘æƒ‘ï¼</p>
</blockquote>
</li>
<li>
<p>ç„¶åå°±åˆ°äº†å®é™… loadä¸€ä¸ªç¨‹åºï¼šè®¡ç®—è¿™ä¸ª <code>elf</code> ç¨‹åºè¦å ç”¨å¤šå°‘çš„ <code>page</code>ï¼Œç„¶ååˆ†é…ï¼Œç„¶åå°±æ˜¯ä¸ºè¿™ä¸ª <code>elf</code> ç¨‹åºå»ºç«‹ <code>mmu</code> æ˜ å°„ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nr_page</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcb</span><span class="o">-&gt;</span><span class="n">as</span><span class="p">,</span>
<span class="w">        </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">start_addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PGSIZE</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">j</span><span class="p">,</span>
<span class="w">        </span><span class="n">p_page</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PGSIZE</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">j</span><span class="p">,</span>
<span class="w">        </span><span class="n">PTE_R</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_W</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_X</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<blockquote>
<p>è¿™é‡Œæ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯è¿™ä¸ªæ˜ å°„ï¼š</p>
<p>å…·ä½“æ¥è¯´å°±æ˜¯åœ¨è¯¥è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œç„¶åä¸ºelfç¨‹åºçš„åœ°å€å»ºç«‹æ˜ å°„ï¼Ÿï¼ˆè¿™é‡Œä¸ºä»€ä¹ˆæ˜¯è¿™ä¸¤ä¸ªåœ°å€å»ºç«‹æ˜ å°„ï¼Ÿæˆ‘è¿™é‡Œåšçš„éƒ½æ˜¯æ’ç­‰æ˜ å°„ï¼‰ã€‚</p>
</blockquote>
</li>
</ul>
<p>ä¹‹åå°±æ˜¯è¦ä¸ºè¿™ä¸ªç”¨æˆ·è¿›ç¨‹åˆ›å»ºç”¨æˆ·æ ˆï¼</p>
<div class="highlight"><pre><span></span><code><span class="n">ucontext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcb</span><span class="o">-&gt;</span><span class="n">as</span><span class="p">,</span><span class="w"> </span><span class="n">kstack</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="n">entry</span><span class="p">);</span>

<span class="n">Context</span><span class="w"> </span><span class="o">*</span><span class="nf">ucontext</span><span class="p">(</span><span class="n">AddrSpace</span><span class="w"> </span><span class="o">*</span><span class="n">as</span><span class="p">,</span><span class="w"> </span><span class="n">Area</span><span class="w"> </span><span class="n">kstack</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">entry</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">stack_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kstack</span><span class="p">.</span><span class="n">end</span><span class="p">;</span>
<span class="w">    </span><span class="n">Context</span><span class="w"> </span><span class="o">*</span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Context</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">((</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">stack_end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">Context</span><span class="p">));</span>
<span class="w">    </span><span class="c1">// just pass the difftest</span>
<span class="w">    </span><span class="c1">//base-&gt;mstatus = 0x1800; // MPP bit[12:11] 0b11 = 3</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">mstatus_t</span><span class="w"> </span><span class="n">mstatus_tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">mpie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">mie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="c1">// read note and manual</span>
<span class="w">        </span><span class="p">.</span><span class="n">mxr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="c1">// about S-mode, OS will do this, design processor core don&#39;t care?</span>
<span class="w">        </span><span class="p">.</span><span class="n">mpp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PRIV_MODE_U</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="n">base</span><span class="o">-&gt;</span><span class="n">mstatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mstatus_tmp</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
<span class="w">    </span><span class="n">base</span><span class="o">-&gt;</span><span class="n">pdir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">;</span>
<span class="w">    </span><span class="n">base</span><span class="o">-&gt;</span><span class="n">np</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PRIV_MODE_U</span><span class="p">;</span>
<span class="w">    </span><span class="n">base</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">kstack</span><span class="p">.</span><span class="n">end</span><span class="p">;</span>
<span class="w">    </span><span class="n">base</span><span class="o">-&gt;</span><span class="n">mepc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">entry</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">base</span><span class="p">;</span>
<span class="p">}</span><span class="w">                </span>
</code></pre></div>
<p>è¿™é‡Œä¸»è¦åˆ°æ˜¯<code>pdir</code>ï¼ˆpage directoryï¼‰ï¼Œè¿™æ˜¯ç”¨æˆ·è¿›ç¨‹åœ°å€ç©ºé—´çš„é¡µè¡¨åŸºåœ°å€èµ‹å€¼ï¼ï¼ˆè¿™å’Œå‰é¢ <code>protect(&amp;pcb-&gt;as);</code> é‚£é‡Œè”ç³»èµ·æ¥äº†ï¼</p>
<blockquote>
<p>ä¸€å¼€å§‹çš„å›°æƒ‘ï¼š<code>memcpy kernel map space</code>ï¼Œå°† <code>kas.ptr</code> æ‹·è´ç»™ <code>updir</code>ï¼Œé‚£ä¸æ˜¯è¦†ç›– <code>pdir</code>ï¼Ÿæ˜¯ä¸æ˜¯å†…æ ¸å’Œç”¨æˆ·å…±ç”¨ä¸€éƒ¨åˆ†ï¼Ÿ</p>
</blockquote>
<p>æ¥ç€ï¼Œä¸»è¦æ˜¯æŒ‡å®šå‡½æ•°å‚æ•°ï¼Œè¿™é‡Œç”¨æ ˆå­˜å¥½äº† <code>argc</code>ã€<code>argv</code>ã€<code>envp</code> çš„å†…å®¹ï¼Œä¹‹åä¼ é€’ç»™ <code>crt</code> è°ƒç”¨ <code>main</code> å‡½æ•°çš„åœ°æ–¹ï¼Œå†è§£æï¼Œè¿™é‡Œå¯ä»¥ä¸ç”¨è¿‡äºå…³æ³¨ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="cp">#define GPRx gpr[10] </span><span class="c1">// a0</span>
<span class="n">pcb</span><span class="o">-&gt;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">GPRx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">base_2_app</span><span class="p">;</span>
</code></pre></div>
<p>ç„¶åï¼šæŒ‡å®šè¯¥ç”¨æˆ·è¿›ç¨‹çš„æ ˆæŒ‡é’ˆï¼ˆ<code>sp/gpr[2]</code>ï¼‰ï¼Œä¸ºæ¯ä¸€ä¸ªè¿›ç¨‹ä¸åŒçš„ç”¨æˆ·æ ˆçš„ç‰©ç†æ˜ å°„åˆ°åŒä¸€ç‰©ç†åœ°å€ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="n">pcb</span><span class="o">-&gt;</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="n">pcb</span><span class="o">-&gt;</span><span class="n">as</span><span class="p">.</span><span class="n">area</span><span class="p">.</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">new_user_stack_bottom</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">space_count</span><span class="p">));</span>

<span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ustack_top_vaddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pcb</span><span class="o">-&gt;</span><span class="n">as</span><span class="p">.</span><span class="n">area</span><span class="p">.</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">;</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcb</span><span class="o">-&gt;</span><span class="n">as</span><span class="p">,</span>
<span class="w">        </span><span class="n">ustack_top_vaddr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">PGSIZE</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">i</span><span class="p">),</span>
<span class="w">        </span><span class="n">new_user_stack_top</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">PGSIZE</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">i</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="n">PTE_R</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PTE_W</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>è¿™ä¸ªendæ˜¯ç”¨æˆ·åœ°å€ç©ºé—´ç»“å°¾ï¼š0x80000000ï¼Œç„¶åå‡å»æœ¬è¿›ç¨‹çš„ç”¨æˆ·åœ°å€ç©ºé—´æ ˆåº•ï¼ˆé«˜åœ°å€ï¼‰å’Œå·²ç»å ç”¨äº†ä¸€éƒ¨åˆ†æ ˆçš„å†…å®¹ï¼ˆspace_countï¼‰ã€‚</p>
<blockquote>
<p>è¿™é‡Œä¹Ÿæœ‰ä¸€ä¸ªæœ‰æ„æ€çš„åœ°æ–¹ï¼Œä¹Ÿæ˜¯é‚£ä¸ªæ—¶å€™æœ‰å›°æƒ‘çš„ï¼šæ˜ å°„åˆ°åŒä¸€åœ°å€ï¼Ÿ</p>
<blockquote>
<p>ç”¨æˆ·æ ˆæ˜ å°„åˆ° <code>as.area.end - 8 * PGSIZE</code> è¿™é‡Œã€‚æˆ‘çš„é—®é¢˜ä¸æ˜¯ä»–æ˜ å°„åˆ°å“ªé‡Œçš„é—®é¢˜ï¼Œè€Œæ˜¯å¥½åƒæ¯åˆ›å»ºä¸€ä¸ªè¿›ç¨‹çš„ç”¨æˆ·æ ˆç©ºé—´éƒ½æŒ‡å‘è¿™é‡Œï¼Ÿï¼Ÿï¼Ÿè¿™å¾ˆæ˜æ˜¾ä¸å¯¹å‘€ï¼ <code>new_user_stack_top</code> è¿™ä¸ªæ˜¯æœ‰ <code>page_alloc</code> å®é™…åˆ†é…äº†8é¡µçš„èµ·å§‹åœ°å€çš„ï¼Œä½†æ˜¯æŒ‰ç…§ä¸Šé¢çš„è¯´æ³•ï¼Œé‚£ä¸æ˜¯æ‰€æœ‰çš„ç”¨æˆ·è¿›ç¨‹çš„ç”¨æˆ·æ ˆçš„å®é™…ç‰©ç†åœ°å€éƒ½æ˜ å°„åˆ°è¿™é‡Œï¼Ÿ</p>
<p>ä¸å¯¹ï¼æ˜¯ç»™æ¯ä¸ªè¿›ç¨‹ä¸€ç§é”™è§‰ï¼Œæ„Ÿè§‰è¿™ä¸€å—åœ°æ–¹éƒ½æ˜¯å®ƒçš„ï¼ä½†è¿™æ˜¯è™šæ‹Ÿåœ°å€ï¼Œå®é™…è®¿é—®çš„ç‰©ç†åœ°å€ï¼ˆå°±æ˜¯é‚£ä¸ªnew_user_stack_topï¼Œåˆ†é…çš„8ä¸ªPAGEï¼‰æ˜¯ä¸ä¸€æ ·çš„ï¼ï¼æˆ‘è¿™ç†è§£å¯¹ä¸å¯¹ï¼Ÿå› ä¸ºè¿™æ˜¯åœ¨æˆ‘è‡ªå·±å†™çš„ OS çš„ï¼Œé‚£æˆ‘æƒ³åœ¨ Linuxä¸­éªŒè¯ï¼Œæ€ä¹ˆåšï¼Ÿæœ‰ä»€ä¹ˆtestç¨‹åºå—ï¼Ÿ</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="c1">// test.c</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">stack_var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;PID=%d, &amp;stack_var=%p, stack_var=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">getpid</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stack_var</span><span class="p">,</span><span class="w"> </span><span class="n">stack_var</span><span class="p">);</span>
<span class="w">    </span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>gcc<span class="w"> </span>test.c<span class="w"> </span>-o<span class="w"> </span><span class="nb">test</span>
$<span class="w"> </span>./test<span class="w"> </span><span class="p">&amp;</span><span class="w"> </span>./test
<span class="nv">PID</span><span class="o">=</span><span class="m">100</span>,<span class="w"> </span><span class="p">&amp;</span><span class="nv">stack_var</span><span class="o">=</span>0x7ffeeb6d9a5c,<span class="w"> </span><span class="nv">stack_var</span><span class="o">=</span><span class="m">42</span>
<span class="nv">PID</span><span class="o">=</span><span class="m">101</span>,<span class="w"> </span><span class="p">&amp;</span><span class="nv">stack_var</span><span class="o">=</span>0x7ffeeb6d9a5c,<span class="w"> </span><span class="nv">stack_var</span><span class="o">=</span><span class="m">42</span>
</code></pre></div>
<p>ç†è®ºçŒœæµ‹æ˜¯è¿™æ ·ï¼šè™šæ‹Ÿåœ°å€ç›¸åŒï¼Œä½†ä¸¤ä¸ªè¿›ç¨‹çš„<code>stack_var</code>ä½äºä¸åŒçš„ç‰©ç†é¡µï¼ŒéªŒè¯äº†æ˜ å°„éš”ç¦»æ€§ã€‚</p>
<p>ä½†æ˜¯å®é™…ä¸Šç”±äºå‰å‡ å¹´ meltdown æ¼æ´ï¼Œç°ä»£çš„ Linux ä¼šæœ‰ ASLRï¼Œä¸ºäº†å®‰å…¨ï¼</p>
<p>å…·ä½“åœ°, æˆ‘ä»¬å¸Œæœ›åœ¨CTEæ¢å¤è¿›ç¨‹ä¸Šä¸‹æ–‡çš„æ—¶å€™æ¥åˆ‡æ¢åœ°å€ç©ºé—´. ä¸ºæ­¤, æˆ‘ä»¬éœ€è¦å°†è¿›ç¨‹çš„åœ°å€ç©ºé—´æè¿°ç¬¦æŒ‡é’ˆ<code>as-&gt;ptr</code>åŠ å…¥åˆ°ä¸Šä¸‹æ–‡ä¸­, æ¡†æ¶ä»£ç å·²ç»å®ç°äº†è¿™ä¸€åŠŸèƒ½(è§<code>abstract-machine/am/include/arch/$ISA-nemu.h</code>), åœ¨x86ä¸­è¿™ä¸€æˆå‘˜ä¸º<code>cr3</code>, è€Œåœ¨mips32/riscv32ä¸­åˆ™ä¸º<code>pdir</code>. </p>
<blockquote>
<p>å†…æ ¸æ˜ å°„ï¼Ÿ</p>
<p>å¯¹äºx86å’Œriscv32, åœ¨<code>protect()</code>ä¸­åˆ›å»ºåœ°å€ç©ºé—´çš„æ—¶å€™, æœ‰ä¸€å¤„ä»£ç ç”¨äºæ‹·è´å†…æ ¸æ˜ å°„:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// map kernel space</span>
<span class="n">memcpy</span><span class="p">(</span><span class="n">updir</span><span class="p">,</span><span class="w"> </span><span class="n">kas</span><span class="p">.</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">);</span>
</code></pre></div>
<p>å°è¯•æ³¨é‡Šè¿™å¤„ä»£ç , é‡æ–°ç¼–è¯‘å¹¶è¿è¡Œ, ä½ ä¼šçœ‹åˆ°å‘ç”Ÿäº†é”™è¯¯. è¯·è§£é‡Šä¸ºä»€ä¹ˆä¼šå‘ç”Ÿè¿™ä¸ªé”™è¯¯.</p>
</blockquote>
<p>ä¸ºæ­¤, æˆ‘ä»¬éœ€è¦æ€è€ƒå†…æ ¸çº¿ç¨‹çš„è°ƒåº¦ä¼šå¯¹åˆ†é¡µæœºåˆ¶é€ æˆä»€ä¹ˆæ ·çš„å½±å“. å†…æ ¸çº¿ç¨‹å’Œç”¨æˆ·è¿›ç¨‹æœ€å¤§çš„ä¸åŒ, å°±æ˜¯å®ƒæ²¡æœ‰ç”¨æˆ·æ€çš„åœ°å€ç©ºé—´: å†…æ ¸çº¿ç¨‹çš„ä»£ç , æ•°æ®å’Œæ ˆéƒ½æ˜¯ä½äºå†…æ ¸çš„åœ°å€ç©ºé—´. é‚£åœ¨å¯åŠ¨åˆ†é¡µæœºåˆ¶ä¹‹å, å¦‚æœ<code>__am_irq_handle()</code>è¦è¿”å›ä¸€ä¸ªå†…æ ¸çº¿ç¨‹çš„ç°åœº, æˆ‘ä»¬æ˜¯å¦éœ€è¦è€ƒè™‘é€šè¿‡<code>__am_switch()</code>åˆ‡æ¢åˆ°å†…æ ¸çº¿ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´å‘¢?</p>
<p>ç­”æ¡ˆæ˜¯, ä¸éœ€è¦. è¿™æ˜¯å› ä¸ºAMåˆ›å»ºçš„æ‰€æœ‰è™šæ‹Ÿåœ°å€ç©ºé—´éƒ½ä¼šåŒ…å«å†…æ ¸æ˜ å°„, æ— è®ºåœ¨åˆ‡æ¢ä¹‹å‰æ˜¯ä½äºå“ªä¸€ä¸ªè™šæ‹Ÿåœ°å€ç©ºé—´, å†…æ ¸çº¿ç¨‹éƒ½å¯ä»¥åœ¨è¿™ä¸ªè™šæ‹Ÿåœ°å€ç©ºé—´ä¸Šæ­£ç¡®è¿è¡Œ. å› æ­¤æˆ‘ä»¬åªè¦åœ¨<code>kcontext()</code>ä¸­å°†ä¸Šä¸‹æ–‡çš„åœ°å€ç©ºé—´æè¿°ç¬¦æŒ‡é’ˆè®¾ç½®ä¸º<code>NULL</code>, æ¥è¿›è¡Œç‰¹æ®Šçš„æ ‡è®°, ç­‰åˆ°å°†æ¥åœ¨<code>__am_irq_handle()</code>ä¸­è°ƒç”¨<code>__am_switch()</code>æ—¶, å¦‚æœå‘ç°åœ°å€ç©ºé—´æè¿°ç¬¦æŒ‡é’ˆä¸º<code>NULL</code>, å°±ä¸è¿›è¡Œè™šæ‹Ÿåœ°å€ç©ºé—´çš„åˆ‡æ¢.
</p>
</blockquote>
<h2 id="mmu-cache">å…³äº MMU å’Œ cache</h2>
<h2 id="1_2">å†…å­˜ç®¡ç†1ï¼šä¼™ä¼´ç³»ç»Ÿçš„åŸç†</h2>
<h2 id="2slab">å†…å­˜ç®¡ç†2ï¼šslabçš„åŸç†</h2>
<h2 id="_18">å†…å­˜ç®¡ç†ï¼šé¡µé¢å›æ”¶</h2>
<h2 id="_19">é¡µé¢è¿ç§»/å‹ç¼©æœºåˆ¶</h2>
<h2 id="_20">ä»å­˜å‚¨ä»‹è´¨çœ‹å¯åŠ¨æµç¨‹</h2>
<p>æœ¬æ–‡å†…å®¹å¯¹æ ‡ARMæ¶æ„åµŒå…¥å¼ç³»ç»Ÿï¼ˆå¦‚æ ‘è“æ´¾ã€i.MXç³»åˆ—ï¼‰çš„æ ‡å‡†æµç¨‹ã€‚</p>
<hr />
<h3 id="_21"><strong>ä¸€ã€å¯åŠ¨æµç¨‹é˜¶æ®µåˆ†è§£</strong></h3>
<h4 id="1bootromsoc"><strong>é˜¶æ®µ1ï¼šBootROMï¼ˆå›ºåŒ–åœ¨SoCå†…éƒ¨ï¼‰</strong></h4>
<ul>
<li>
<p><strong>åŠ è½½å†…å®¹</strong>ï¼š </p>
<ul>
<li>ä»<strong>å†…éƒ¨Mask ROM</strong>æ‰§è¡Œåˆå§‹ä»£ç ï¼ˆä¸å¯ä¿®æ”¹ï¼‰ã€‚</li>
<li>åŠ è½½<strong>å¤–éƒ¨å­˜å‚¨ä»‹è´¨ï¼ˆå¦‚SPI NOR Flashï¼‰</strong>ä¸­çš„ç¬¬ä¸€çº§Bootloaderï¼ˆå¦‚SPLï¼‰ã€‚</li>
</ul>
</li>
<li>
<p><strong>æ ¸å¿ƒç›®çš„</strong>ï¼š </p>
<ul>
<li><strong>ç¡¬ä»¶åˆå§‹åŒ–</strong>ï¼šé…ç½®SoCçš„æ—¶é’Ÿã€å¼•è„šå¤ç”¨ã€åŸºæœ¬DDRæ—¶åºã€‚</li>
<li><strong>ä»‹è´¨æ¢æµ‹</strong>ï¼šæ ¹æ®SoCå¯åŠ¨å¼•è„šç”µå¹³ï¼ˆBoot Modeï¼‰ï¼Œé€‰æ‹©ä»SDå¡ã€eMMCæˆ–NOR FlashåŠ è½½ä¸‹ä¸€é˜¶æ®µä»£ç ã€‚</li>
<li><strong>å®‰å…¨éªŒè¯</strong>ï¼šéªŒè¯SPLçš„æ•°å­—ç­¾åï¼ˆSecure Bootåœºæ™¯ï¼‰ã€‚</li>
</ul>
</li>
<li>
<p><strong>ä¸“ä¸šè®¾è®¡é€»è¾‘</strong>ï¼š 
    BootROMå›ºåŒ–åœ¨ç¡…ç‰‡ä¸­ï¼Œä¿è¯ç³»ç»Ÿä¸Šç”µå<strong>æ— éœ€å¤–éƒ¨å¹²é¢„å³å¯æ‰¾åˆ°å¯åŠ¨è·¯å¾„</strong>ã€‚å…¶ä»£ç ä½“ç§¯ä¸¥æ ¼å—é™ï¼ˆé€šå¸¸&lt;64KBï¼‰ï¼Œå› æ­¤åªèƒ½åŠ è½½<strong>æå°å‹çš„å¼•å¯¼ç¨‹åºï¼ˆSPLï¼‰</strong>ã€‚</p>
</li>
</ul>
<hr />
<h4 id="2splsecondary-program-loader"><strong>é˜¶æ®µ2ï¼šSPLï¼ˆSecondary Program Loaderï¼‰</strong></h4>
<ul>
<li>
<p><strong>åŠ è½½å†…å®¹</strong>ï¼š  </p>
<ul>
<li>ä»<strong>å¤–éƒ¨å­˜å‚¨ï¼ˆå¦‚SDå¡ã€eMMCï¼‰</strong>åŠ è½½å®Œæ•´ç‰ˆBootloaderï¼ˆå¦‚U-Bootï¼‰ã€‚</li>
</ul>
</li>
<li>
<p><strong>æ ¸å¿ƒç›®çš„</strong>ï¼š  </p>
<ul>
<li><strong>æ‰©å±•ç¡¬ä»¶åˆå§‹åŒ–</strong>ï¼šå®ŒæˆDDRå†…å­˜è®­ç»ƒã€å¤æ‚å¤–è®¾ï¼ˆå¦‚PCIe/USBï¼‰æ—¶é’Ÿé…ç½®ã€‚</li>
<li><strong>ä»‹è´¨é©±åŠ¨åŠ è½½</strong>ï¼šæä¾›è®¿é—®eMMC/NANDçš„é©±åŠ¨ç¨‹åºï¼ˆBootROMé€šå¸¸ä»…æ”¯æŒSPI NORï¼‰ã€‚</li>
<li><strong>è§£å‹ä¸é‡å®šä½</strong>ï¼šè‹¥ä¸»Bootloaderè¢«å‹ç¼©ï¼ˆå¦‚LZMAï¼‰ï¼ŒSPLè´Ÿè´£è§£å‹åˆ°DDRä¸­ã€‚</li>
</ul>
</li>
<li>
<p><strong>ä¸“ä¸šè®¾è®¡é€»è¾‘</strong>ï¼š 
    SPLæ˜¯BootROMä¸ä¸»Bootloaderä¹‹é—´çš„æ¡¥æ¢ã€‚ç”±äºBootROMæ— æ³•ç›´æ¥å¤„ç†å¤§å®¹é‡å­˜å‚¨ï¼ˆå¦‚eMMCï¼‰ï¼Œéœ€é€šè¿‡SPLå®ç°<strong>ç¡¬ä»¶èƒ½åŠ›æ‰©å±•</strong>ã€‚</p>
</li>
</ul>
<hr />
<h4 id="3bootloaderu-boot"><strong>é˜¶æ®µ3ï¼šä¸»Bootloaderï¼ˆå¦‚U-Bootï¼‰</strong></h4>
<ul>
<li>
<p><strong>åŠ è½½å†…å®¹</strong>ï¼š  </p>
<ul>
<li>ä»å­˜å‚¨ä»‹è´¨åŠ è½½<strong>å†…æ ¸é•œåƒï¼ˆzImage/uImageï¼‰</strong>ã€<strong>è®¾å¤‡æ ‘ï¼ˆ.dtbï¼‰</strong>ã€<strong>initramfs</strong>åˆ°DDRæŒ‡å®šåœ°å€ã€‚</li>
</ul>
</li>
<li>
<p><strong>æ ¸å¿ƒç›®çš„</strong>ï¼š  </p>
<ul>
<li><strong>åŠ¨æ€é…ç½®</strong>ï¼šé€šè¿‡ç¯å¢ƒå˜é‡ï¼ˆ<code>bootcmd</code>ï¼‰å®šä¹‰å¯åŠ¨å‚æ•°ï¼ˆå¦‚å†…æ ¸å‘½ä»¤è¡Œå‚æ•°<code>console=ttyS0,115200</code>ï¼‰ã€‚</li>
<li><strong>ç¡¬ä»¶æŠ½è±¡</strong>ï¼šæä¾›ç»Ÿä¸€çš„å­˜å‚¨è®¿é—®æ¥å£ï¼ˆå¦‚<code>fatload mmc 0:1 $kernel_addr_r zImage</code>ï¼‰ã€‚</li>
<li><strong>å®‰å…¨æ‰©å±•</strong>ï¼šæ”¯æŒå†…æ ¸éªŒç­¾ã€FITé•œåƒï¼ˆFlattened Image Treeï¼‰ç­‰é«˜çº§ç‰¹æ€§ã€‚</li>
</ul>
</li>
<li>
<p><strong>ä¸“ä¸šè®¾è®¡é€»è¾‘</strong>ï¼š<br />
    Bootloaderéœ€<strong>å¹³è¡¡çµæ´»æ€§ä¸å¯é æ€§</strong>ã€‚ä¾‹å¦‚ï¼ŒU-Bootçš„<code>bootcmd</code>å…è®¸å¼€å‘è€…é€šè¿‡è„šæœ¬åŒ–æ§åˆ¶å¯åŠ¨æµç¨‹ï¼Œè€Œè®¾å¤‡æ ‘åˆ†ç¦»ç¡¬ä»¶æè¿°ä¸å†…æ ¸ä»£ç ï¼Œå®ç°<strong>è·¨å¹³å°å…¼å®¹æ€§</strong>ã€‚</p>
</li>
</ul>
<hr />
<h4 id="4kernel"><strong>é˜¶æ®µ4ï¼šå†…æ ¸å¯åŠ¨ï¼ˆKernelï¼‰</strong></h4>
<ul>
<li>
<p><strong>åŠ è½½å†…å®¹</strong>ï¼š  </p>
<ul>
<li>ä»DDRä¸­è·å–<strong>è®¾å¤‡æ ‘äºŒè¿›åˆ¶ï¼ˆDTBï¼‰</strong>ï¼Œè§£æç¡¬ä»¶æ‹“æ‰‘ã€‚</li>
<li>æŒ‚è½½<strong>æ ¹æ–‡ä»¶ç³»ç»Ÿï¼ˆrootfsï¼‰</strong>ï¼ˆä»eMMC/NET/NFSç­‰åŠ è½½ï¼‰ã€‚</li>
</ul>
</li>
<li>
<p><strong>æ ¸å¿ƒç›®çš„</strong>ï¼š  </p>
<ul>
<li><strong>ç¡¬ä»¶é©±åŠ¨åˆå§‹åŒ–</strong>ï¼šæ ¹æ®DTBä¿¡æ¯åŠ è½½å¯¹åº”é©±åŠ¨ï¼ˆå¦‚GPIOã€I2Cæ§åˆ¶å™¨ï¼‰ã€‚</li>
<li><strong>è¿›ç¨‹ç®¡ç†</strong>ï¼šå¯åŠ¨ç¬¬ä¸€ä¸ªç”¨æˆ·æ€è¿›ç¨‹ï¼ˆ<code>init</code>æˆ–<code>systemd</code>ï¼‰ã€‚</li>
<li><strong>èµ„æºåˆ†é…</strong>ï¼šå»ºç«‹å†…å­˜æ˜ å°„ã€ä¸­æ–­è·¯ç”±è¡¨ã€‚</li>
</ul>
</li>
<li>
<p><strong>ä¸“ä¸šè®¾è®¡é€»è¾‘</strong>ï¼š<br />
    å†…æ ¸é€šè¿‡DTBå®ç°<strong>ç¡¬ä»¶æè¿°ä¸ä»£ç è§£è€¦</strong>ï¼Œé¿å…ä¸ºæ¯ä¸ªæ¿å¡å®šåˆ¶å†…æ ¸ã€‚æ ¹æ–‡ä»¶ç³»ç»Ÿçš„ä½ç½®ç”±å†…æ ¸å‚æ•°ï¼ˆ<code>root=/dev/mmcblk0p2</code>ï¼‰æŒ‡å®šï¼Œåˆ†ç¦»<strong>ç³»ç»Ÿè¿è¡Œ</strong>ä¸<strong>æ•°æ®å­˜å‚¨</strong>é€»è¾‘ã€‚</p>
</li>
</ul>
<hr />
<h4 id="5user-space"><strong>é˜¶æ®µ5ï¼šç”¨æˆ·ç©ºé—´ï¼ˆUser Spaceï¼‰</strong></h4>
<ul>
<li>
<p><strong>åŠ è½½å†…å®¹</strong>ï¼š  </p>
<ul>
<li>ä»æ ¹æ–‡ä»¶ç³»ç»Ÿæ‰§è¡Œ<code>/sbin/init</code>ï¼ŒåŠ è½½åŠ¨æ€åº“ï¼ˆå¦‚<code>libc.so</code>ï¼‰ã€é…ç½®æ–‡ä»¶ã€‚</li>
</ul>
</li>
<li>
<p><strong>æ ¸å¿ƒç›®çš„</strong>ï¼š  </p>
<ul>
<li><strong>æœåŠ¡ç®¡ç†</strong>ï¼šå¯åŠ¨å®ˆæŠ¤è¿›ç¨‹ï¼ˆå¦‚SSHã€ç½‘ç»œæœåŠ¡ï¼‰ã€‚</li>
<li><strong>æƒé™æ§åˆ¶</strong>ï¼šé€šè¿‡<code>/etc/fstab</code>æŒ‚è½½åˆ†åŒºï¼Œåˆ‡æ¢érootç”¨æˆ·ã€‚</li>
</ul>
</li>
<li>
<p><strong>ä¸“ä¸šè®¾è®¡é€»è¾‘</strong>ï¼š<br />
    ç”¨æˆ·ç©ºé—´é€šè¿‡<strong>å±‚æ¬¡åŒ–åˆå§‹åŒ–</strong>ï¼ˆå¦‚SysV initã€systemdï¼‰ç®¡ç†æœåŠ¡ä¾èµ–å…³ç³»ï¼Œç¡®ä¿ç³»ç»Ÿä»åº•å±‚ç¡¬ä»¶åˆ°ä¸Šå±‚åº”ç”¨çš„å®Œæ•´å¯æ§åˆ¶æ€§ã€‚</p>
</li>
</ul>
<hr />
<h3 id="_22"><strong>äºŒã€æå‡ä¸“ä¸šæ€§çš„æ–¹æ³•è®º</strong></h3>
<h4 id="1_3"><strong>1. æ·±åº¦æŒæ¡å·¥å…·é“¾</strong></h4>
<ul>
<li>
<p><strong>é€†å‘åˆ†æå·¥å…·</strong>ï¼š  </p>
<ul>
<li>
<p>ä½¿ç”¨<code>objdump</code>åæ±‡ç¼–BootROMä»£ç ï¼ˆéœ€JTAGè°ƒè¯•å™¨ï¼‰ï¼š  </p>
<div class="highlight"><pre><span></span><code>arm-none-eabi-objdump<span class="w"> </span>-D<span class="w"> </span>-marm<span class="w"> </span>bootrom.bin<span class="w"> </span>&gt;<span class="w"> </span>disassembly.txt
</code></pre></div>
</li>
<li>
<p>é€šè¿‡<code>fdtdump</code>è§£æDTBï¼š  </p>
<div class="highlight"><pre><span></span><code>fdtdump<span class="w"> </span>my_board.dtb<span class="w"> </span><span class="p">|</span><span class="w"> </span>less
</code></pre></div>
</li>
</ul>
</li>
<li>
<p><strong>è°ƒè¯•æŠ€æœ¯</strong>ï¼š  </p>
<ul>
<li>
<p>U-Bootä¸­é€šè¿‡<code>md</code>å‘½ä»¤æŸ¥çœ‹å†…å­˜å†…å®¹ï¼š  </p>
<div class="highlight"><pre><span></span><code>md<span class="w"> </span>0x80000000<span class="w"> </span><span class="m">100</span><span class="w">  </span><span class="c1"># æŸ¥çœ‹DDRèµ·å§‹åœ°å€çš„256å­—èŠ‚</span>
</code></pre></div>
</li>
<li>
<p>ä½¿ç”¨OpenOCD + JTAGå•æ­¥è·Ÿè¸ªSPLæ‰§è¡Œæµç¨‹ã€‚</p>
</li>
</ul>
</li>
</ul>
<hr />
<h4 id="2_3"><strong>2. ç†è§£è¡Œä¸šæ ‡å‡†è®¾è®¡æ¨¡å¼</strong></h4>
<ul>
<li>
<p><strong>XIPï¼ˆExecute In Placeï¼‰</strong>ï¼š<br />
    åœ¨NOR Flashä¸Šç›´æ¥è¿è¡Œä»£ç ï¼ˆæ— éœ€åŠ è½½åˆ°RAMï¼‰ï¼ŒèŠ‚çœå¯åŠ¨æ—¶é—´ã€‚éœ€åœ¨é“¾æ¥è„šæœ¬ä¸­æŒ‡å®šä»£ç æ®µåœ°å€ï¼š  </p>
<div class="highlight"><pre><span></span><code>.text : {
    *(.text)
} &gt; FLASH
</code></pre></div>
</li>
<li>
<p><strong>Chain of Trust</strong>ï¼š<br />
    å®‰å…¨å¯åŠ¨æµç¨‹ç¤ºä¾‹ï¼š  </p>
<div class="highlight"><pre><span></span><code>BootROM â†’ éªŒç­¾SPL â†’ SPLéªŒç­¾U-Boot â†’ U-BootéªŒç­¾Kernel
</code></pre></div>
</li>
</ul>
<hr />
<h4 id="3_3"><strong>3. å®æˆ˜ä¼˜åŒ–æŠ€å·§</strong></h4>
<ul>
<li>
<p><strong>Bootæ—¶é—´ä¼˜åŒ–</strong>ï¼š  </p>
<ul>
<li>
<p>æµ‹é‡å„é˜¶æ®µè€—æ—¶ï¼š  </p>
<div class="highlight"><pre><span></span><code><span class="c1"># U-Bootä¸­å¯ç”¨æ—¶é—´æˆ³</span>
setenv<span class="w"> </span>bootargs<span class="w"> </span><span class="s2">&quot;... initcall_debug=1&quot;</span>
dmesg<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;initcall&quot;</span>
</code></pre></div>
</li>
<li>
<p>å¹¶è¡Œåˆå§‹åŒ–ï¼šåœ¨è®¾å¤‡æ ‘ä¸­æ ‡è®°<code>status = "okay"</code>çš„è®¾å¤‡ï¼Œå†…æ ¸å¯å¼‚æ­¥æ¢æµ‹é©±åŠ¨ã€‚</p>
</li>
</ul>
</li>
<li>
<p><strong>å­˜å‚¨æ‹“æ‰‘è®¾è®¡</strong>ï¼š  </p>
<table>
<thead>
<tr>
<th><strong>åœºæ™¯</strong></th>
<th><strong>æ¨èå­˜å‚¨æ–¹æ¡ˆ</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>å·¥ä¸šæ§åˆ¶å™¨</td>
<td>NOR (Boot) + eMMC (Rootfs)</td>
</tr>
<tr>
<td>æ¶ˆè´¹ç”µå­</td>
<td>eMMCç»Ÿä¸€å­˜å‚¨ï¼ˆåˆ†åŒºéš”ç¦»Boot/Kernelï¼‰</td>
</tr>
<tr>
<td>å¼€å‘åŸå‹æœº</td>
<td>SDå¡å¯åŠ¨ + NFSæŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿ</td>
</tr>
</tbody>
</table>
</li>
</ul>
<hr />
<h4 id="4_1"><strong>4. å­¦ä¹ è·¯å¾„å»ºè®®</strong></h4>
<ol>
<li>
<p><strong>ç¡¬ä»¶æ‰‹å†Œç²¾è¯»</strong>ï¼š  </p>
<ul>
<li>ç ”è¯»SoCçš„ã€ŠBootROM Technical Reference Manualã€‹ï¼Œç†è§£å¯åŠ¨å¼•è„šé…ç½®ã€æ—¶é’Ÿæ ‘åˆå§‹åŒ–æ—¶åºã€‚</li>
</ul>
</li>
<li>
<p><strong>ä»£ç è§£å‰–</strong>ï¼š  </p>
<ul>
<li>åˆ†æU-Bootçš„<code>board_init_f</code>ï¼ˆæ—©æœŸåˆå§‹åŒ–ï¼‰ä¸<code>board_init_r</code>ï¼ˆè¿è¡Œæ—¶åˆå§‹åŒ–ï¼‰åŒºåˆ«ã€‚</li>
</ul>
</li>
<li>
<p><strong>å‚ä¸å¼€æºç¤¾åŒº</strong>ï¼š  </p>
<ul>
<li>æäº¤U-Booté©±åŠ¨è¡¥ä¸ï¼ˆå¦‚æ”¯æŒæ–°å‹eMMCèŠ¯ç‰‡ï¼‰ã€‚</li>
<li>å¤ç°å¹¶ä¿®å¤Linuxå†…æ ¸çš„Device Treeç»‘å®šè­¦å‘Šã€‚</li>
</ul>
</li>
</ol>
<hr />
<h3 id="_23"><strong>ä¸‰ã€ç»ˆæç›®æ ‡ï¼šæ„å»ºå®Œæ•´çŸ¥è¯†ä½“ç³»</strong></h3>
<ul>
<li>
<p><strong>æ ¸å¿ƒèƒ½åŠ›çŸ©é˜µ</strong>ï¼š  </p>
<table>
<thead>
<tr>
<th><strong>èƒ½åŠ›ç»´åº¦</strong></th>
<th><strong>å…·ä½“æŠ€èƒ½</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>ç¡¬ä»¶æ¥å£å±‚</td>
<td>ç†è§£eMMCçš„CMDçº¿åè®®ã€DDRè®­ç»ƒç®—æ³•</td>
</tr>
<tr>
<td>å›ºä»¶å±‚</td>
<td>ç¼–å†™U-Booté©±åŠ¨ã€å®šåˆ¶SPL</td>
</tr>
<tr>
<td>æ“ä½œç³»ç»Ÿå±‚</td>
<td>è°ƒæ•´å†…æ ¸è°ƒåº¦ç­–ç•¥ã€ä¼˜åŒ–DTBè¦†ç›–æœºåˆ¶</td>
</tr>
<tr>
<td>å®‰å…¨å±‚</td>
<td>å®ç°Secure Booté“¾ã€é˜²å¾¡å›ºä»¶çº§æ”»å‡»</td>
</tr>
</tbody>
</table>
</li>
</ul>
<p>é€šè¿‡ç³»ç»Ÿæ€§ç†è§£å­˜å‚¨ä»‹è´¨ä¸å¯åŠ¨æµç¨‹çš„å…³è”ï¼Œæ‚¨å°†èƒ½å¤Ÿè®¾è®¡å‡º<strong>é«˜å¯é æ€§ã€å¯ç»´æŠ¤æ€§</strong>çš„åµŒå…¥å¼ç³»ç»Ÿï¼Œå¹¶åœ¨å‡ºç°å¯åŠ¨æ•…éšœæ—¶å¿«é€Ÿå®šä½é—®é¢˜å±‚çº§ï¼ˆå¦‚ï¼šâ€œDDRæœªåˆå§‹åŒ–â€å±äºSPLé˜¶æ®µé—®é¢˜ï¼Œâ€œç½‘å¡é©±åŠ¨å¤±è´¥â€å±äºå†…æ ¸é˜¶æ®µé—®é¢˜ï¼‰ã€‚</p>
<blockquote>
<p>ä»¥ä¸‹æ˜¯åµŒå…¥å¼ç³»ç»Ÿä¸­å­˜å‚¨ä»‹è´¨åˆ†ç±»åŠSoCä¸å­˜å‚¨å…³ç³»çš„ç³»ç»Ÿæ€§æ€»ç»“ï¼Œå¸®åŠ©ä½ æ›´ä¸“ä¸šåœ°ç†è§£è¿™ä¸€é¢†åŸŸçš„æ ¸å¿ƒæ¦‚å¿µï¼š</p>
<hr />
<h3 id="1_4"><strong>1. å­˜å‚¨ä»‹è´¨åˆ†ç±»ä¸ä½œç”¨</strong></h3>
<h4 id="11"><strong>1.1 æŒ‰å­˜å‚¨ä½ç½®åˆ†ç±»</strong></h4>
<table>
<thead>
<tr>
<th><strong>ç±»å‹</strong></th>
<th><strong>ä½ç½®</strong></th>
<th><strong>å…¸å‹è®¾å¤‡</strong></th>
<th><strong>ä½œç”¨</strong></th>
<th><strong>æ€§èƒ½ç‰¹ç‚¹</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>å†…éƒ¨å­˜å‚¨</strong></td>
<td>é›†æˆåœ¨SoCå†…éƒ¨</td>
<td>SRAM, Mask ROM</td>
<td>å­˜æ”¾BootROMä»£ç ã€å®‰å…¨å¯åŠ¨å¯†é’¥</td>
<td>ä½å»¶è¿Ÿã€å°å®¹é‡ï¼ˆKBçº§ï¼‰</td>
</tr>
<tr>
<td><strong>å¤–éƒ¨å­˜å‚¨</strong></td>
<td>è¿æ¥åœ¨SoCå¤–éƒ¨</td>
<td>DDR SDRAM, eMMC, NAND</td>
<td>è¿è¡Œç³»ç»Ÿã€å­˜å‚¨å›ºä»¶å’Œç”¨æˆ·æ•°æ®</td>
<td>å¤§å®¹é‡ï¼ˆMB~TBçº§ï¼‰</td>
</tr>
</tbody>
</table>
<h4 id="12"><strong>1.2 æŒ‰åŠŸèƒ½åˆ†ç±»</strong></h4>
<table>
<thead>
<tr>
<th><strong>ç±»å‹</strong></th>
<th><strong>è®¾å¤‡ç¤ºä¾‹</strong></th>
<th><strong>å¯åŠ¨æµç¨‹ä¸­çš„ä½œç”¨</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>å¯åŠ¨ä»‹è´¨</strong></td>
<td>NOR Flash, SDå¡, eMMC</td>
<td>å­˜æ”¾Bootloaderã€å†…æ ¸ã€è®¾å¤‡æ ‘ã€æ ¹æ–‡ä»¶ç³»ç»Ÿ</td>
</tr>
<tr>
<td><strong>ä¸»å†…å­˜</strong></td>
<td>DDR3/4 SDRAM, LPDDR</td>
<td>è¿è¡Œæ“ä½œç³»ç»Ÿå’Œåº”ç”¨ç¨‹åº</td>
</tr>
<tr>
<td><strong>æŒä¹…å­˜å‚¨</strong></td>
<td>eMMC, NAND Flash, SDå¡</td>
<td>å­˜å‚¨ç”¨æˆ·æ•°æ®å’Œå›ºä»¶é•œåƒ</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="2-soc"><strong>2. SoCå†…éƒ¨å­˜å‚¨è¯¦è§£</strong></h3>
<h4 id="21-sram"><strong>2.1 SRAMï¼ˆé™æ€éšæœºå­˜å‚¨å™¨ï¼‰</strong></h4>
<ul>
<li><strong>ç‰¹ç‚¹</strong>ï¼šé«˜é€Ÿã€ä½å»¶è¿Ÿã€æ— éœ€åˆ·æ–°ï¼Œä½†å®¹é‡å°ï¼ˆé€šå¸¸å‡ åKB~å‡ MBï¼‰ã€‚</li>
<li><strong>ç”¨é€”</strong>ï¼š<ul>
<li>BootROMæ‰§è¡Œæ—¶çš„ä¸´æ—¶ç¼“å­˜ã€‚</li>
<li>CPUä¸€çº§/äºŒçº§ç¼“å­˜ï¼ˆéƒ¨åˆ†SoCè®¾è®¡ï¼‰ã€‚</li>
<li>å…³é”®ä¸­æ–­æœåŠ¡ä¾‹ç¨‹ï¼ˆISRï¼‰çš„å¿«é€Ÿæ‰§è¡Œã€‚</li>
</ul>
</li>
</ul>
<h4 id="22-mask-rom-otp"><strong>2.2 Mask ROM / OTPï¼ˆä¸€æ¬¡æ€§ç¼–ç¨‹å­˜å‚¨å™¨ï¼‰</strong></h4>
<ul>
<li><strong>ç‰¹ç‚¹</strong>ï¼šå‡ºå‚å›ºåŒ–ä»£ç ï¼Œä¸å¯ä¿®æ”¹ï¼ˆOTPå…è®¸ä¸€æ¬¡å†™å…¥ï¼‰ã€‚</li>
<li><strong>ç”¨é€”</strong>ï¼š<ul>
<li>SoCå¯åŠ¨çš„ç¬¬ä¸€é˜¶æ®µä»£ç ï¼ˆBootROMï¼‰ã€‚</li>
<li>å®‰å…¨å¯åŠ¨å¯†é’¥ã€è®¾å¤‡å”¯ä¸€IDå­˜å‚¨ã€‚</li>
</ul>
</li>
</ul>
<hr />
<h3 id="3-soc"><strong>3. SoCå¤–éƒ¨å­˜å‚¨è¯¦è§£</strong></h3>
<h4 id="31-volatile"><strong>3.1 ä¸»å†…å­˜ï¼ˆVolatileï¼Œæ˜“å¤±æ€§ï¼‰</strong></h4>
<table>
<thead>
<tr>
<th><strong>è®¾å¤‡</strong></th>
<th><strong>ç‰¹ç‚¹</strong></th>
<th><strong>å…¸å‹å®¹é‡</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>DDR SDRAM</strong></td>
<td>é«˜å¸¦å®½ã€åŠ¨æ€åˆ·æ–°ï¼Œéœ€åˆå§‹åŒ–æ—¶åº</td>
<td>128MB~8GB</td>
</tr>
<tr>
<td><strong>LPDDR</strong></td>
<td>ä½åŠŸè€—ç‰ˆæœ¬ï¼Œç”¨äºç§»åŠ¨è®¾å¤‡</td>
<td>åŒDDR</td>
</tr>
</tbody>
</table>
<h4 id="32-non-volatile"><strong>3.2 éæ˜“å¤±æ€§å­˜å‚¨ï¼ˆNon-Volatileï¼‰</strong></h4>
<table>
<thead>
<tr>
<th><strong>è®¾å¤‡</strong></th>
<th><strong>æ¥å£</strong></th>
<th><strong>å…¸å‹ç”¨é€”</strong></th>
<th><strong>æ€§èƒ½ç‰¹ç‚¹</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>NOR Flash</strong></td>
<td>SPI, Parallel</td>
<td>å­˜å‚¨Bootloaderï¼ˆXIPæ”¯æŒï¼‰</td>
<td>éšæœºè¯»å–å¿«ï¼Œå†™å…¥æ…¢</td>
</tr>
<tr>
<td><strong>NAND Flash</strong></td>
<td>eMMC, SDå¡, UFS</td>
<td>å­˜å‚¨å†…æ ¸ã€æ–‡ä»¶ç³»ç»Ÿ</td>
<td>é«˜å®¹é‡ï¼Œå—æ“ä½œ</td>
</tr>
<tr>
<td><strong>eMMC</strong></td>
<td>eMMCåè®®</td>
<td>æ‰‹æœº/åµŒå…¥å¼ç³»ç»Ÿä¸»å­˜å‚¨</td>
<td>é›†æˆæ§åˆ¶å™¨ï¼Œæ˜“ç”¨</td>
</tr>
<tr>
<td><strong>SDå¡</strong></td>
<td>SDIOæ¥å£</td>
<td>å¼€å‘æ¿ä¸´æ—¶å¯åŠ¨ä»‹è´¨</td>
<td>å¯æ’æ‹”ï¼Œä½æˆæœ¬</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="4_2"><strong>4. å¯åŠ¨ä»‹è´¨é€‰æ‹©ä¸å¯¹æ¯”</strong></h3>
<h4 id="41"><strong>4.1 å¸¸è§å¯åŠ¨ä»‹è´¨</strong></h4>
<table>
<thead>
<tr>
<th><strong>ä»‹è´¨</strong></th>
<th><strong>ä¼˜ç‚¹</strong></th>
<th><strong>ç¼ºç‚¹</strong></th>
<th><strong>å…¸å‹åº”ç”¨åœºæ™¯</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>NOR Flash</strong></td>
<td>æ”¯æŒXIPï¼Œå¯é æ€§é«˜</td>
<td>å®¹é‡å°ï¼ˆMBçº§ï¼‰ï¼Œæˆæœ¬é«˜</td>
<td>å·¥ä¸šè®¾å¤‡Bootloaderå­˜å‚¨</td>
</tr>
<tr>
<td><strong>eMMC</strong></td>
<td>é›†æˆæ§åˆ¶å™¨ï¼Œé«˜å¯é æ€§</td>
<td>ç„Šæ­»ä¸å¯æ›´æ¢</td>
<td>æ‰‹æœºã€æ™ºèƒ½ç¡¬ä»¶ä¸»å­˜å‚¨</td>
</tr>
<tr>
<td><strong>SDå¡</strong></td>
<td>å¯æ’æ‹”ï¼Œçµæ´»</td>
<td>é€Ÿåº¦æ…¢ï¼Œæ˜“æŸå</td>
<td>æ ‘è“æ´¾ç­‰å¼€å‘æ¿å¯åŠ¨ä»‹è´¨</td>
</tr>
<tr>
<td><strong>SPI NAND</strong></td>
<td>ä½æˆæœ¬ï¼Œå¤§å®¹é‡</td>
<td>éœ€åå—ç®¡ç†ï¼Œé©±åŠ¨å¤æ‚</td>
<td>æ¶ˆè´¹ç”µå­è®¾å¤‡</td>
</tr>
</tbody>
</table>
<h4 id="42"><strong>4.2 å¯åŠ¨æµç¨‹ä¸­çš„å­˜å‚¨å±‚çº§</strong></h4>
<ol>
<li><strong>BootROMé˜¶æ®µ</strong>ï¼š<ul>
<li>ä»SoCå†…éƒ¨Mask ROMæ‰§è¡Œï¼ŒåŠ è½½å¤–éƒ¨SPI NOR Flashä¸­çš„Bootloaderã€‚</li>
</ul>
</li>
<li><strong>Bootloaderé˜¶æ®µ</strong>ï¼š<ul>
<li>U-Bootä»eMMC/SDå¡åŠ è½½å†…æ ¸ï¼ˆ<code>zImage</code>ï¼‰ã€è®¾å¤‡æ ‘ï¼ˆ<code>.dtb</code>ï¼‰ã€initramfsã€‚</li>
</ul>
</li>
<li><strong>å†…æ ¸é˜¶æ®µ</strong>ï¼š<ul>
<li>å†…æ ¸è§£å‹åè¿è¡Œåœ¨DDRå†…å­˜ä¸­ï¼Œä»æ ¹æ–‡ä»¶ç³»ç»Ÿï¼ˆeMMC/NANDï¼‰æŒ‚è½½<code>/</code>ã€‚</li>
</ul>
</li>
</ol>
<hr />
<h3 id="5_2"><strong>5. å…³é”®é—®é¢˜è§£ç­”</strong></h3>
<h4 id="q1-socflash"><strong>Q1: SoCå¤–æ¥çš„Flashé€šå¸¸æ˜¯ä»€ä¹ˆç±»å‹ï¼Ÿ</strong></h4>
<ul>
<li><strong>ç­”</strong>ï¼šæ ¹æ®éœ€æ±‚é€‰æ‹©ï¼š<ul>
<li><strong>NOR Flash</strong>ï¼šç”¨äºå­˜æ”¾Bootloaderï¼ˆæ”¯æŒXIPç›´æ¥æ‰§è¡Œï¼‰ã€‚</li>
<li><strong>eMMC/NAND</strong>ï¼šå­˜æ”¾å†…æ ¸ã€æ–‡ä»¶ç³»ç»Ÿç­‰å¤§å®¹é‡æ•°æ®ã€‚</li>
<li><strong>SDå¡</strong>ï¼šå¼€å‘è°ƒè¯•æ—¶çš„ä¸´æ—¶å¯åŠ¨ä»‹è´¨ã€‚</li>
</ul>
</li>
</ul>
<h4 id="q2-emmcnand-flash"><strong>Q2: eMMCå’ŒNAND Flashçš„åŒºåˆ«ï¼Ÿ</strong></h4>
<ul>
<li><strong>eMMC</strong> = NAND Flash + å†…ç½®æ§åˆ¶å™¨ + æ ‡å‡†å°è£…ï¼Œæä¾›é€šç”¨æ¥å£ï¼ˆå¦‚MMCåè®®ï¼‰ï¼Œæ— éœ€å¼€å‘è€…ç®¡ç†åå—ã€‚</li>
<li><strong>åŸå§‹NAND</strong>ï¼šéœ€SoCå†…ç½®æ§åˆ¶å™¨ï¼Œå¼€å‘è€…éœ€å®ç°åå—ç®¡ç†å’ŒECCæ ¡éªŒã€‚</li>
</ul>
<h4 id="q3-ddrsram"><strong>Q3: DDRå’ŒSRAMçš„åˆ†å·¥ï¼Ÿ</strong></h4>
<ul>
<li><strong>SRAM</strong>ï¼šç”¨äºå¯¹å»¶è¿Ÿæ•æ„Ÿçš„ç¼“å­˜åœºæ™¯ï¼ˆå¦‚CPU L1 Cacheï¼‰ã€‚</li>
<li><strong>DDR</strong>ï¼šä½œä¸ºä¸»å†…å­˜è¿è¡Œæ“ä½œç³»ç»Ÿå’Œåº”ç”¨ç¨‹åºã€‚</li>
</ul>
<hr />
<h3 id="6"><strong>6. è®¾è®¡å»ºè®®</strong></h3>
<ol>
<li>
<p><strong>å¯åŠ¨ä»‹è´¨é€‰å‹</strong>ï¼š</p>
<ul>
<li>éœ€è¦å¯é æ€§ â†’ é€‰æ‹©eMMCæˆ–NOR Flashã€‚</li>
<li>éœ€è¦çµæ´»è°ƒè¯• â†’ ä½¿ç”¨SDå¡ã€‚</li>
</ul>
</li>
<li>
<p><strong>å­˜å‚¨æ‹“æ‰‘ç¤ºä¾‹</strong>ï¼š</p>
<div class="highlight"><pre><span></span><code>[SoCå†…éƒ¨]
  Mask ROM â†’ åˆå§‹åŒ– â†’ åŠ è½½SPI NORä¸­çš„U-Boot
[SoCå¤–éƒ¨]
  U-Boot â†’ ä»eMMCåŠ è½½å†…æ ¸/dt â†’ DDRè¿è¡Œ â†’ æŒ‚è½½eMMCä¸­çš„æ ¹æ–‡ä»¶ç³»ç»Ÿ
</code></pre></div>
</li>
<li>
<p><strong>è°ƒè¯•æŠ€å·§</strong>ï¼š</p>
<ul>
<li>ä½¿ç”¨<code>mmc info</code>ï¼ˆU-Bootå‘½ä»¤ï¼‰æŸ¥çœ‹SDå¡/eMMCä¿¡æ¯ã€‚</li>
<li>é€šè¿‡<code>fdt addr &lt;åœ°å€&gt;</code>éªŒè¯è®¾å¤‡æ ‘æ˜¯å¦æ­£ç¡®åŠ è½½ã€‚</li>
</ul>
</li>
</ol>
<hr />
<p>é€šè¿‡ç†è§£å­˜å‚¨å±‚çº§å’Œä»‹è´¨ç‰¹æ€§ï¼Œä½ å¯ä»¥æ›´ä¸“ä¸šåœ°ä¸ºåµŒå…¥å¼ç³»ç»Ÿè®¾è®¡å­˜å‚¨æ¶æ„ï¼Œé¿å…èµ„æºå†²çªå’Œæ€§èƒ½ç“¶é¢ˆã€‚</p>
</blockquote>
<h2 id="dtb">å°†ç¼–è¯‘ç”Ÿæˆçš„è®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆdtbï¼‰ä¸ç³»ç»Ÿé•œåƒç»‘å®š</h2>
<p>å°†ç¼–è¯‘ç”Ÿæˆçš„è®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆdtbï¼‰ä¸ç³»ç»Ÿé•œåƒç»‘å®šçš„è¿‡ç¨‹å–å†³äºç¡¬ä»¶å¹³å°å’Œå¼•å¯¼ç¨‹åºï¼ˆå¦‚U-Bootï¼‰ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†æ­¥éª¤ï¼š</p>
<hr />
<h3 id="1_5"><strong>1. ç¡®è®¤ç¡¬ä»¶å¹³å°å’Œå¼•å¯¼æ–¹å¼</strong></h3>
<ul>
<li>å¸¸è§å¼•å¯¼ç¨‹åºï¼šU-Bootã€GRUBã€æ ‘è“æ´¾ä¸“ç”¨å¼•å¯¼ç­‰ã€‚</li>
<li>ç¡®å®šdtbæ–‡ä»¶çš„å­˜å‚¨ä½ç½®ï¼ˆå¦‚SDå¡åˆ†åŒºã€Flashç­‰ï¼‰ã€‚</li>
</ul>
<hr />
<h3 id="2-dtb"><strong>2. éƒ¨ç½²dtbæ–‡ä»¶</strong></h3>
<h4 id="u-boot"><strong>é€šç”¨æ­¥éª¤ï¼ˆä»¥U-Bootä¸ºä¾‹ï¼‰</strong></h4>
<ul>
<li>
<p><strong>å°†dtbå¤åˆ¶åˆ°å¯åŠ¨ä»‹è´¨</strong>ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="c1"># ç¤ºä¾‹ï¼šå°†dtbå¤åˆ¶åˆ°SDå¡çš„ç¬¬ä¸€ä¸ªåˆ†åŒºï¼ˆFATæ ¼å¼ï¼‰</span>
sudo<span class="w"> </span>cp<span class="w"> </span>my_board.dtb<span class="w"> </span>/mnt/boot/
</code></pre></div>
</li>
<li>
<p><strong>å¸¸è§å­˜å‚¨è·¯å¾„</strong>ï¼š</p>
<ul>
<li><code>/boot/</code> æˆ– <code>/boot/dtb/</code></li>
<li>SDå¡/FATåˆ†åŒºçš„æ ¹ç›®å½•æˆ–æŒ‡å®šå­ç›®å½•ï¼ˆå¦‚æ ‘è“æ´¾çš„<code>/overlays/</code>ï¼‰ã€‚</li>
</ul>
</li>
</ul>
<hr />
<h3 id="3_4"><strong>3. é…ç½®å¼•å¯¼ç¨‹åº</strong></h3>
<h4 id="u-boot_1"><strong>U-Bootç¯å¢ƒå˜é‡é…ç½®</strong></h4>
<ul>
<li>
<p><strong>è®¾ç½®dtbåŠ è½½åœ°å€å’Œæ–‡ä»¶å</strong>ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="c1"># åœ¨U-Bootå‘½ä»¤è¡Œä¸­è®¾ç½®ï¼ˆä»¥ARMä¸ºä¾‹ï¼‰</span>
setenv<span class="w"> </span>fdt_addr<span class="w"> </span>0x83000000<span class="w">    </span><span class="c1"># dtbçš„å†…å­˜åŠ è½½åœ°å€</span>
setenv<span class="w"> </span>fdtfile<span class="w"> </span>my_board.dtb<span class="w">   </span><span class="c1"># dtbæ–‡ä»¶å</span>
saveenv<span class="w">                       </span><span class="c1"># ä¿å­˜é…ç½®</span>
</code></pre></div>
</li>
<li>
<p><strong>å¯åŠ¨å‘½ä»¤ç¤ºä¾‹</strong>ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="c1"># åŠ è½½å†…æ ¸ã€dtbå’Œæ ¹æ–‡ä»¶ç³»ç»Ÿåå¯åŠ¨</span>
load<span class="w"> </span>mmc<span class="w"> </span><span class="m">0</span>:1<span class="w"> </span><span class="si">${</span><span class="nv">kernel_addr</span><span class="si">}</span><span class="w"> </span>zImage
load<span class="w"> </span>mmc<span class="w"> </span><span class="m">0</span>:1<span class="w"> </span><span class="si">${</span><span class="nv">fdt_addr</span><span class="si">}</span><span class="w"> </span><span class="si">${</span><span class="nv">fdtfile</span><span class="si">}</span>
bootz<span class="w"> </span><span class="si">${</span><span class="nv">kernel_addr</span><span class="si">}</span><span class="w"> </span>-<span class="w"> </span><span class="si">${</span><span class="nv">fdt_addr</span><span class="si">}</span>
</code></pre></div>
</li>
</ul>
<h4 id="configtxt"><strong>æ ‘è“æ´¾é…ç½®ï¼ˆconfig.txtï¼‰</strong></h4>
<ul>
<li>
<p>åœ¨SDå¡çš„<code>config.txt</code>ä¸­æŒ‡å®šdtbï¼š</p>
<div class="highlight"><pre><span></span><code><span class="na">device_tree</span><span class="o">=</span><span class="s">my_board.dtb</span>
<span class="c1"># æˆ–ä½¿ç”¨è¦†ç›–ï¼ˆoverlayï¼‰</span>
<span class="na">dtoverlay</span><span class="o">=</span><span class="s">my_overlay.dtbo</span>
</code></pre></div>
</li>
</ul>
<hr />
<h3 id="4-dtb"><strong>4. å†…æ ¸ä¸dtbç»‘å®šï¼ˆå¯é€‰ï¼‰</strong></h3>
<h4 id="dtb_1"><strong>åµŒå…¥dtbåˆ°å†…æ ¸é•œåƒ</strong></h4>
<ul>
<li>
<p>ç¼–è¯‘æ—¶ç›´æ¥åŒ…å«dtbï¼ˆéœ€å†…æ ¸é…ç½®æ”¯æŒï¼‰ï¼š</p>
<div class="highlight"><pre><span></span><code>make<span class="w"> </span>dtbs<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>make<span class="w"> </span>zImage
</code></pre></div>
</li>
</ul>
<h4 id="uimage"><strong>ç”Ÿæˆå¤åˆé•œåƒï¼ˆå¦‚uImageï¼‰</strong></h4>
<ul>
<li>
<p>ä½¿ç”¨<code>mkimage</code>æ‰“åŒ…å†…æ ¸å’Œdtbï¼š</p>
<div class="highlight"><pre><span></span><code>mkimage<span class="w"> </span>-A<span class="w"> </span>arm<span class="w"> </span>-O<span class="w"> </span>linux<span class="w"> </span>-T<span class="w"> </span>kernel<span class="w"> </span>-C<span class="w"> </span>none<span class="w"> </span>-a<span class="w"> </span>0x80008000<span class="w"> </span>-e<span class="w"> </span>0x80008000<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>-d<span class="w"> </span>zImage:my_board.dtb<span class="w"> </span>uImage
</code></pre></div>
</li>
</ul>
<hr />
<h3 id="5_3"><strong>5. éªŒè¯å¯åŠ¨æµç¨‹</strong></h3>
<ul>
<li>
<p><strong>æ£€æŸ¥U-BootåŠ è½½çš„åœ°å€</strong>ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="c1"># åœ¨U-Bootä¸­æ‰‹åŠ¨åŠ è½½å¹¶å¯åŠ¨</span>
fatload<span class="w"> </span>mmc<span class="w"> </span><span class="m">0</span>:1<span class="w"> </span><span class="si">${</span><span class="nv">fdt_addr</span><span class="si">}</span><span class="w"> </span>my_board.dtb
fdt<span class="w"> </span>addr<span class="w"> </span><span class="si">${</span><span class="nv">fdt_addr</span><span class="si">}</span><span class="w">          </span><span class="c1"># éªŒè¯dtbè§£æ</span>
bootz<span class="w"> </span><span class="si">${</span><span class="nv">kernel_addr</span><span class="si">}</span><span class="w"> </span>-<span class="w"> </span><span class="si">${</span><span class="nv">fdt_addr</span><span class="si">}</span>
</code></pre></div>
</li>
<li>
<p><strong>å†…æ ¸å¯åŠ¨æ—¥å¿—</strong>ï¼š</p>
<div class="highlight"><pre><span></span><code>dmesg<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;Machine model&quot;</span><span class="w">   </span><span class="c1"># ç¡®è®¤æ­£ç¡®åŠ è½½äº†dtb</span>
</code></pre></div>
</li>
</ul>
<hr />
<h3 id="6_1"><strong>6. å¸¸è§é—®é¢˜æ’æŸ¥</strong></h3>
<ul>
<li><strong>åœ°å€å†²çª</strong>ï¼šç¡®ä¿dtbåŠ è½½åœ°å€ä¸ä¸å†…æ ¸æˆ–initrdé‡å ã€‚</li>
<li><strong>è·¯å¾„é”™è¯¯</strong>ï¼šæ£€æŸ¥U-Bootä¸­æ–‡ä»¶è·¯å¾„ä¸å®é™…å­˜å‚¨ä½ç½®æ˜¯å¦ä¸€è‡´ã€‚</li>
<li><strong>dtbç‰ˆæœ¬ä¸åŒ¹é…</strong>ï¼šç¡®ä¿dtbä¸å†…æ ¸ç‰ˆæœ¬å…¼å®¹ã€‚</li>
</ul>
<hr />
<h3 id="_24"><strong>æ€»ç»“æ­¥éª¤</strong></h3>
<ol>
<li><strong>ç¼–è¯‘dtb</strong>ï¼š<code>dtc -I dts -O dtb -o my_board.dtb my_board.dts</code></li>
<li><strong>å¤åˆ¶åˆ°å¯åŠ¨ä»‹è´¨</strong>ï¼šå¦‚<code>/boot/dtb/</code>æˆ–SDå¡åˆ†åŒºã€‚</li>
<li><strong>é…ç½®å¼•å¯¼ç¨‹åº</strong>ï¼šè®¾ç½®åŠ è½½åœ°å€å’Œå¯åŠ¨å‘½ä»¤ã€‚</li>
<li><strong>å¯åŠ¨éªŒè¯</strong>ï¼šé€šè¿‡æ—¥å¿—ç¡®è®¤dtbç”Ÿæ•ˆã€‚</li>
</ol>
<p>æ ¹æ®å…·ä½“å¹³å°è°ƒæ•´ç»†èŠ‚ï¼Œå‚è€ƒç¡¬ä»¶æ–‡æ¡£ç¡®ä¿å…¼å®¹æ€§ã€‚</p>
<h2 id="_25">æ–‡ä»¶ç³»ç»Ÿé•œåƒ</h2>
<h2 id="dtb_2">DTB é…åˆ æ–‡ä»¶ç³»ç»Ÿé•œåƒ</h2>
<p>åœ¨åµŒå…¥å¼Linuxç³»ç»Ÿå¼€å‘ä¸­ï¼Œæ–‡ä»¶ç³»ç»Ÿæ‰“åŒ…å’Œè®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆDTBï¼‰ç»‘å®šæ˜¯ä¸¤ä¸ª<strong>ç‹¬ç«‹ä½†ç´§å¯†åä½œçš„å…³é”®æ­¥éª¤</strong>ï¼Œå®ƒä»¬å…±åŒç¡®ä¿ç³»ç»Ÿä»ç¡¬ä»¶åˆå§‹åŒ–åˆ°ç”¨æˆ·ç©ºé—´æœåŠ¡çš„å®Œæ•´å¯åŠ¨æµç¨‹ã€‚ä»¥ä¸‹æ˜¯ä¸¤è€…çš„æŠ€æœ¯å…³è”å’Œå·®å¼‚çš„æ·±åº¦è§£æï¼š</p>
<hr />
<h3 id="_26"><strong>ä¸€ã€æ ¸å¿ƒç›®æ ‡å¯¹æ¯”</strong></h3>
<table>
<thead>
<tr>
<th><strong>æ­¥éª¤</strong></th>
<th><strong>æ–‡ä»¶ç³»ç»Ÿæ‰“åŒ…</strong></th>
<th><strong>DTBç»‘å®š</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ç›®æ ‡</strong></td>
<td>æ„å»ºç”¨æˆ·ç©ºé—´è¿è¡Œç¯å¢ƒ</td>
<td>æä¾›ç¡¬ä»¶æè¿°ä¾›å†…æ ¸åˆå§‹åŒ–</td>
</tr>
<tr>
<td><strong>æ•°æ®å†…å®¹</strong></td>
<td>åº”ç”¨ç¨‹åºã€åº“ã€é…ç½®æ–‡ä»¶ç­‰</td>
<td>SoCå¤–è®¾å¯„å­˜å™¨åœ°å€ã€ä¸­æ–­å·ç­‰ç¡¬ä»¶ä¿¡æ¯</td>
</tr>
<tr>
<td><strong>å­˜å‚¨ä½ç½®</strong></td>
<td>ç‹¬ç«‹åˆ†åŒºï¼ˆå¦‚ext4ã€UBIFSï¼‰</td>
<td>Bootåˆ†åŒºï¼ˆFATï¼‰ã€å†…æ ¸é•œåƒå†…åµŒ</td>
</tr>
<tr>
<td><strong>åŠ è½½é˜¶æ®µ</strong></td>
<td>å†…æ ¸å¯åŠ¨åæŒ‚è½½</td>
<td>BootloaderåŠ è½½å†…æ ¸å‰ä¼ é€’</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="_27"><strong>äºŒã€æŠ€æœ¯æµç¨‹å…³è”</strong></h3>
<h4 id="1_6"><strong>1. ç³»ç»Ÿå¯åŠ¨ä¾èµ–é“¾</strong></h4>
<div class="highlight"><pre><span></span><code>graph LR
    Bootloader --&gt;|åŠ è½½DTB| DTB[è®¾å¤‡æ ‘äºŒè¿›åˆ¶]
    Bootloader --&gt;|åŠ è½½å†…æ ¸| Kernel[Linuxå†…æ ¸]
    Kernel --&gt;|è§£æDTB| Hardware[ç¡¬ä»¶åˆå§‹åŒ–]
    Kernel --&gt;|æŒ‚è½½| RootFS[æ ¹æ–‡ä»¶ç³»ç»Ÿ]
    RootFS --&gt;|å¯åŠ¨| App[ç”¨æˆ·æ€åº”ç”¨]
</code></pre></div>
<ul>
<li><strong>å…³é”®äº¤äº’ç‚¹</strong>ï¼š  <ul>
<li><strong>DTBä½ç½®</strong>ï¼šè‹¥DTBå­˜å‚¨åœ¨æ ¹æ–‡ä»¶ç³»ç»Ÿå†…ï¼ˆå¦‚<code>/boot/</code>ç›®å½•ï¼‰ï¼Œåˆ™éœ€ç¡®ä¿æ–‡ä»¶ç³»ç»Ÿæ‰“åŒ…æ—¶åŒ…å«æ­£ç¡®DTBæ–‡ä»¶ã€‚  </li>
<li><strong>å†…æ ¸é…ç½®</strong>ï¼šè‹¥ä½¿ç”¨<code>CONFIG_ARM_APPENDED_DTB</code>å°†DTBé™„åŠ åˆ°å†…æ ¸é•œåƒï¼Œåˆ™æ–‡ä»¶ç³»ç»Ÿæ‰“åŒ…æ— éœ€å¤„ç†DTBã€‚</li>
</ul>
</li>
</ul>
<h4 id="2_4"><strong>2. ä¼ä¸šçº§é•œåƒæ„å»ºç¤ºä¾‹</strong></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># æ„å»ºå®Œæ•´çƒ§å½•é•œåƒï¼ˆSDå¡å¸ƒå±€ç¤ºä¾‹ï¼‰</span>
<span class="c1">#!/bin/bash</span>
<span class="c1"># 1. åˆ›å»ºåˆ†åŒºè¡¨</span>
dd<span class="w"> </span><span class="k">if</span><span class="o">=</span>/dev/zero<span class="w"> </span><span class="nv">of</span><span class="o">=</span>system.img<span class="w"> </span><span class="nv">bs</span><span class="o">=</span>1M<span class="w"> </span><span class="nv">count</span><span class="o">=</span><span class="m">2048</span>
parted<span class="w"> </span>system.img<span class="w"> </span>mklabel<span class="w"> </span>msdos
parted<span class="w"> </span>system.img<span class="w"> </span>mkpart<span class="w"> </span>primary<span class="w"> </span>fat32<span class="w"> </span>1MiB<span class="w"> </span>128MiB<span class="w">   </span><span class="c1"># Bootåˆ†åŒºï¼ˆFATï¼‰</span>
parted<span class="w"> </span>system.img<span class="w"> </span>mkpart<span class="w"> </span>primary<span class="w"> </span>ext4<span class="w"> </span>128MiB<span class="w"> </span><span class="m">100</span>%<span class="w">    </span><span class="c1"># RootFSåˆ†åŒº</span>

<span class="c1"># 2. æ ¼å¼åŒ–å¹¶å¡«å……Bootåˆ†åŒº</span>
sudo<span class="w"> </span>losetup<span class="w"> </span>-Pf<span class="w"> </span>system.img
sudo<span class="w"> </span>mkfs.vfat<span class="w"> </span>/dev/loop0p1
sudo<span class="w"> </span>mount<span class="w"> </span>/dev/loop0p1<span class="w"> </span>/mnt/boot
sudo<span class="w"> </span>cp<span class="w"> </span>zImage<span class="w"> </span>my_board.dtb<span class="w"> </span>/mnt/boot/<span class="w">              </span><span class="c1"># DTBéƒ¨ç½²åˆ°Bootåˆ†åŒº</span>
sudo<span class="w"> </span>umount<span class="w"> </span>/mnt/boot

<span class="c1"># 3. æ„å»ºæ ¹æ–‡ä»¶ç³»ç»Ÿ</span>
sudo<span class="w"> </span>mkfs.ext4<span class="w"> </span>/dev/loop0p2
sudo<span class="w"> </span>mount<span class="w"> </span>/dev/loop0p2<span class="w"> </span>/mnt/rootfs
sudo<span class="w"> </span>rsync<span class="w"> </span>-a<span class="w"> </span>rootfs/<span class="w"> </span>/mnt/rootfs/<span class="w">                  </span><span class="c1"># æ–‡ä»¶ç³»ç»Ÿæ‰“åŒ…</span>
sudo<span class="w"> </span>umount<span class="w"> </span>/mnt/rootfs
sudo<span class="w"> </span>losetup<span class="w"> </span>-d<span class="w"> </span>/dev/loop0
</code></pre></div>
<hr />
<h3 id="_28"><strong>ä¸‰ã€è®¾è®¡å†³ç­–ä¸å·¥ç¨‹å®è·µ</strong></h3>
<h4 id="1-vs"><strong>1. åˆ†ç¦»éƒ¨ç½² vs å†…åµŒæ•´åˆ</strong></h4>
<table>
<thead>
<tr>
<th><strong>æ–¹æ¡ˆ</strong></th>
<th><strong>ä¼˜ç‚¹</strong></th>
<th><strong>ç¼ºç‚¹</strong></th>
<th><strong>é€‚ç”¨åœºæ™¯</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>DTBç‹¬ç«‹å­˜å‚¨</strong></td>
<td>çµæ´»æ›´æ–°DTBæ— éœ€é‡ç¼–è¯‘å†…æ ¸</td>
<td>éœ€ç®¡ç†å¤šæ–‡ä»¶ç‰ˆæœ¬å…¼å®¹æ€§</td>
<td>å¿«é€Ÿè¿­ä»£çš„å¼€å‘é˜¶æ®µ</td>
</tr>
<tr>
<td><strong>DTBé™„åŠ åˆ°å†…æ ¸</strong></td>
<td>ç®€åŒ–å¯åŠ¨æµç¨‹ï¼Œé¿å…è·¯å¾„é”™è¯¯</td>
<td>å†…æ ¸é•œåƒä½“ç§¯å¢å¤§</td>
<td>é‡äº§å›ºä»¶ï¼ˆç‰ˆæœ¬å›ºåŒ–ï¼‰</td>
</tr>
<tr>
<td><strong>DTBåµŒå…¥æ ¹æ–‡ä»¶ç³»ç»Ÿ</strong></td>
<td>ç»Ÿä¸€å­˜å‚¨ç®¡ç†</td>
<td>éœ€å†…æ ¸å·²æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿæ‰èƒ½è¯»å–</td>
<td>ç‰¹æ®Šå®‰å…¨éœ€æ±‚åœºæ™¯</td>
</tr>
</tbody>
</table>
<h4 id="2_5"><strong>2. ä¼ä¸šçº§å¯é æ€§è®¾è®¡</strong></h4>
<ul>
<li>
<p><strong>åŒå¤‡ä»½ç­–ç•¥</strong>ï¼š  </p>
<div class="highlight"><pre><span></span><code><span class="c1"># åœ¨Bootåˆ†åŒºå­˜å‚¨ä¸¤ä»½DTBï¼ˆä¸»ç”¨+å¤‡ç”¨ï¼‰</span>
sudo<span class="w"> </span>cp<span class="w"> </span>my_board.dtb<span class="w"> </span>/mnt/boot/
sudo<span class="w"> </span>cp<span class="w"> </span>my_board.dtb<span class="w"> </span>/mnt/boot/backup.dtb
</code></pre></div>
<p>U-Bootè„šæœ¬å¢åŠ å›é€€é€»è¾‘ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span>fatload<span class="w"> </span>mmc<span class="w"> </span><span class="m">0</span>:1<span class="w"> </span><span class="si">${</span><span class="nv">fdt_addr</span><span class="si">}</span><span class="w"> </span><span class="si">${</span><span class="nv">fdtfile</span><span class="si">}</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;DTBåŠ è½½æˆåŠŸ&quot;</span><span class="p">;</span>
<span class="k">else</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;å›é€€åˆ°å¤‡ç”¨DTB&quot;</span><span class="p">;</span>
<span class="w">    </span>fatload<span class="w"> </span>mmc<span class="w"> </span><span class="m">0</span>:1<span class="w"> </span><span class="si">${</span><span class="nv">fdt_addr</span><span class="si">}</span><span class="w"> </span>backup.dtb<span class="p">;</span>
<span class="k">fi</span>
</code></pre></div>
</li>
<li>
<p><strong>ç‰ˆæœ¬ç»‘å®šæ ¡éªŒ</strong>ï¼š<br />
    åœ¨DTBå¤´éƒ¨æ·»åŠ CRC32æ ¡éªŒç ï¼Œå¹¶åœ¨U-Bootä¸­éªŒè¯ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="c1">// DTBç¼–è¯‘æ—¶æ³¨å…¥ç‰ˆæœ¬ä¿¡æ¯</span>
<span class="cp">#define DTB_MAGIC 0xd00dfeed</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">fdt_header</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">magic</span><span class="p">;</span><span class="w">             </span><span class="c1">// å¿…é¡»ä¸ºDTB_MAGIC</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">totalsize</span><span class="p">;</span><span class="w">         </span><span class="c1">// åŒ…å«å¤´éƒ¨çš„æ€»å¤§å°</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">off_dt_struct</span><span class="p">;</span><span class="w">     </span><span class="c1">// ç»“æ„ä½“åç§»</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">off_dt_strings</span><span class="p">;</span><span class="w">    </span><span class="c1">// å­—ç¬¦ä¸²å—åç§»</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">off_mem_rsvmap</span><span class="p">;</span><span class="w">    </span><span class="c1">// å†…å­˜ä¿ç•™åŒºåç§»</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">version</span><span class="p">;</span><span class="w">           </span><span class="c1">// æ ¼å¼ç‰ˆæœ¬</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">last_comp_version</span><span class="p">;</span><span class="w"> </span><span class="c1">// å‘ä¸‹å…¼å®¹ç‰ˆæœ¬</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">boot_cpuid_phys</span><span class="p">;</span><span class="w">   </span><span class="c1">// ç‰©ç†CPU ID</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">size_dt_strings</span><span class="p">;</span><span class="w">   </span><span class="c1">// å­—ç¬¦ä¸²å—å¤§å°</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">size_dt_struct</span><span class="p">;</span><span class="w">    </span><span class="c1">// ç»“æ„ä½“å¤§å°</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">crc32</span><span class="p">;</span><span class="w">            </span><span class="c1">// è‡ªå®šä¹‰CRC32æ ¡éªŒ</span>
<span class="p">};</span>
</code></pre></div>
</li>
</ul>
<hr />
<h3 id="_29"><strong>å››ã€é«˜çº§è°ƒè¯•æŠ€å·§</strong></h3>
<h4 id="1_7"><strong>1. åŠ¨æ€åˆ‡æ¢æµ‹è¯•</strong></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># åœ¨U-Bootä¸­ä¸´æ—¶æ›´æ¢DTBæµ‹è¯•ï¼ˆæ— éœ€é‡æ–°çƒ§å½•ï¼‰</span>
tftp<span class="w"> </span><span class="si">${</span><span class="nv">fdt_addr</span><span class="si">}</span><span class="w"> </span><span class="m">192</span>.168.1.100:new_board.dtb
bootz<span class="w"> </span><span class="si">${</span><span class="nv">kernel_addr</span><span class="si">}</span><span class="w"> </span>-<span class="w"> </span><span class="si">${</span><span class="nv">fdt_addr</span><span class="si">}</span>
</code></pre></div>
<h4 id="2-dtb_1"><strong>2. æ–‡ä»¶ç³»ç»Ÿä¸DTBäº¤å‰éªŒè¯</strong></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿä¸­çš„DTBæ˜¯å¦ä¸Bootåˆ†åŒºä¸€è‡´</span>
sudo<span class="w"> </span>mount<span class="w"> </span>/dev/mmcblk0p2<span class="w"> </span>/mnt
diff<span class="w"> </span>/mnt/boot/my_board.dtb<span class="w"> </span>/mnt/root/backup.dtb
sha1sum<span class="w"> </span>/mnt/boot/my_board.dtb
</code></pre></div>
<hr />
<h3 id="_30"><strong>äº”ã€è¡Œä¸šæ¼”è¿›ä¸æœªæ¥è¶‹åŠ¿</strong></h3>
<ul>
<li>
<p><strong>è®¾å¤‡æ ‘ä¸ACPIèåˆ</strong>ï¼š 
    ARMæœåŠ¡å™¨é¢†åŸŸé€æ¸é‡‡ç”¨ACPIè¡¨+è®¾å¤‡æ ‘æ··åˆæ¨¡å¼ï¼ˆ<code>CONFIG_ARM64_ACPI_PARKING_PROTOCOL</code>ï¼‰ã€‚</p>
</li>
<li>
<p><strong>å®‰å…¨å¢å¼º</strong>ï¼š 
    ä½¿ç”¨æ•°å­—ç­¾ååŒæ—¶ä¿æŠ¤DTBå’Œæ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚DM-Verity + DTBç­¾åï¼‰ã€‚</p>
</li>
<li>
<p><strong>æ™ºèƒ½åŒ–éƒ¨ç½²</strong>ï¼š 
    é€šè¿‡AIæ¨¡å‹åŠ¨æ€ç”Ÿæˆä¼˜åŒ–åçš„DTBï¼ˆæ ¹æ®ç¡¬ä»¶ä¼ æ„Ÿå™¨æ•°æ®è°ƒæ•´æ—¶é’Ÿç­–ç•¥ï¼‰ã€‚</p>
</li>
</ul>
<hr />
<h3 id="_31"><strong>æ€»ç»“</strong></h3>
<p>æ–‡ä»¶ç³»ç»Ÿæ‰“åŒ…ä¸DTBç»‘å®šæ˜¯åµŒå…¥å¼Linuxç³»ç»Ÿçš„<strong>â€œè¡€è‚‰â€ä¸â€œéª¨æ¶â€</strong>å…³ç³»ï¼š</p>
<ul>
<li><strong>æ–‡ä»¶ç³»ç»Ÿ</strong>æä¾›ç”¨æˆ·æ€æœåŠ¡è¿è¡Œæ‰€éœ€çš„â€œå™¨å®˜â€ï¼ˆåº”ç”¨ç¨‹åºã€é…ç½®ï¼‰ã€‚</li>
<li><strong>DTB</strong>å®šä¹‰ç¡¬ä»¶â€œéª¨éª¼â€ç»“æ„ï¼Œç¡®ä¿å†…æ ¸æ­£ç¡®é©±åŠ¨å¤–è®¾ã€‚</li>
</ul>
<p>è¦æˆä¸ºä¸“ä¸šå¼€å‘è€…ï¼Œéœ€æŒæ¡ï¼š</p>
<ol>
<li><strong>å…¨é“¾è·¯æ€ç»´</strong>ï¼šç†è§£ä»Bootloaderåˆ°ç”¨æˆ·ç©ºé—´çš„å®Œæ•´æ•°æ®æµã€‚</li>
<li><strong>é˜²å¾¡æ€§è®¾è®¡</strong>ï¼šä¸ºå…³é”®ç»„ä»¶ï¼ˆDTBã€æ–‡ä»¶ç³»ç»Ÿè¶…çº§å—ï¼‰æ·»åŠ å†—ä½™å’Œæ ¡éªŒã€‚</li>
<li><strong>å·¥å…·é“¾ç²¾é€š</strong>ï¼šç†Ÿç»ƒä½¿ç”¨<code>dtc</code>ã€<code>mkimage</code>ã€<code>dd</code>ç­‰æ„å»ºå·¥å…·ã€‚</li>
</ol>
<blockquote>
<p>å»ºè®®ä¸‹ä¸€æ­¥ï¼šåœ¨çœŸå®ç¡¬ä»¶ä¸Šå®è·µç ´åæ€§æµ‹è¯•ï¼ˆå¦‚æ•…æ„æŸåDTBæˆ–æ–‡ä»¶ç³»ç»Ÿï¼‰ï¼Œè§‚å¯Ÿç³»ç»Ÿè¡Œä¸ºå¹¶ç¼–å†™æ¢å¤è„šæœ¬ã€‚</p>
</blockquote>
<h2 id="todo">TODO</h2>
<h2 id="todo_1">TODO</h2>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class="timeago" datetime="2025-03-28T09:36:27+01:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2025-03-28</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class="timeago" datetime="2025-03-26T07:48:07+01:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2025-03-26</span>
  </span>

    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="https://github.com/JAILuo" target="_blank" rel="noopener" title="JAILuo" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.footer"], "search": "../../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.83f73b43.min.js"></script>
      
        <script src="../../../js/timeago.min.js"></script>
      
        <script src="../../../js/timeago_mkdocs_material.js"></script>
      
        <script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
      
    
  </body>
</html>