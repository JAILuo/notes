
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://jailuo.github.io/notes/Course/University%20Course/jyy%20OS2024/cousre%20note/2.%20concurrency/concurrency.html">
      
      
        <link rel="prev" href="../1.%20introduction/introduction.html">
      
      
        <link rel="next" href="../3.%20virtualization/virtualization.html">
      
      
      <link rel="icon" href="../../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.48">
    
    
      
        <title>concurrency - Messy Notes</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/main.6f8fc17f.min.css">
      
        
        <link rel="stylesheet" href="../../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../../css/timeago.css">
    
    <script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../../../index.html" title="Messy Notes" class="md-header__button md-logo" aria-label="Messy Notes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Messy Notes
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              concurrency
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256l137.3-137.4c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/JAILuo/notes" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../../index.html" title="Messy Notes" class="md-nav__button md-logo" aria-label="Messy Notes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Messy Notes
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/JAILuo/notes" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../index.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    é¦–é¡µ
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Course
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Course
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" checked>
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    University Course
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            University Course
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_1" checked>
        
          
          <label class="md-nav__link" for="__nav_2_1_1" id="__nav_2_1_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    jyy OS2024
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_1_1">
            <span class="md-nav__icon md-icon"></span>
            jyy OS2024
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_1_1" checked>
        
          
          <label class="md-nav__link" for="__nav_2_1_1_1" id="__nav_2_1_1_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    course note
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_2_1_1_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_1_1_1">
            <span class="md-nav__icon md-icon"></span>
            course note
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1.%20introduction/introduction.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    introduction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    concurrency
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="concurrency.html" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    concurrency
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      å¤šå¤„ç†å™¨ç¼–ç¨‹
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      å¹¶å‘æ§åˆ¶ï¼šäº’æ–¥ï¼ˆ1ï¼‰
    </span>
  </a>
  
    <nav class="md-nav" aria-label="å¹¶å‘æ§åˆ¶ï¼šäº’æ–¥ï¼ˆ1ï¼‰">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      é˜»æ­¢å¹¶å‘ï¼ˆå¹¶è¡Œï¼‰çš„å‘ç”Ÿ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="é˜»æ­¢å¹¶å‘ï¼ˆå¹¶è¡Œï¼‰çš„å‘ç”Ÿ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#demo" class="md-nav__link">
    <span class="md-ellipsis">
      DEMO
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loadstore" class="md-nav__link">
    <span class="md-ellipsis">
      ä½¿ç”¨ load/store å®ç°äº’æ–¥ï¼ˆï¼‰
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      åœ¨å¤šå¤„ç†å™¨ä¸Šå®ç°äº’æ–¥
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      å¹¶å‘æ§åˆ¶ï¼šäº’æ–¥ï¼ˆ2ï¼‰
    </span>
  </a>
  
    <nav class="md-nav" aria-label="å¹¶å‘æ§åˆ¶ï¼šäº’æ–¥ï¼ˆ2ï¼‰">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      ç°å®è¦æ±‚ä½†æœ‰äººä¸éµå®ˆ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      æ“ä½œç³»ç»Ÿå†…æ ¸ä¸­çš„è‡ªæ—‹é”
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72-read-copy-update" class="md-nav__link">
    <span class="md-ellipsis">
      7.2 æ“ä½œç³»ç»Ÿå†…æ ¸ä¸­çš„ (åŠ) æ— é”äº’æ–¥ï¼šRead-Copy-Update ğŸŒ¶ï¸
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      åº”ç”¨ç¨‹åºä¸­çš„äº’æ–¥
    </span>
  </a>
  
    <nav class="md-nav" aria-label="åº”ç”¨ç¨‹åºä¸­çš„äº’æ–¥">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pthread-mutex-lock" class="md-nav__link">
    <span class="md-ellipsis">
      pthread Mutex Lock
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#futex-fast-userspace-mutexes" class="md-nav__link">
    <span class="md-ellipsis">
      Futex: Fast Userspace muTexes ğŸŒ¶ï¸
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      å¯¹æ¯”ä¸‰ç§äº’æ–¥æ‰‹æ®µ
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      è°ƒè¯•ç†è®ºä¸å®è·µ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="è°ƒè¯•ç†è®ºä¸å®è·µ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      å¬æ•…äº‹
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      è°ƒè¯•ç†è®º
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      è°ƒè¯•ä¸€åˆ‡
    </span>
  </a>
  
    <nav class="md-nav" aria-label="è°ƒè¯•ä¸€åˆ‡">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example0" class="md-nav__link">
    <span class="md-ellipsis">
      example0
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example1syscdefsh-no-such-file-or-directory" class="md-nav__link">
    <span class="md-ellipsis">
      example1ï¼šsys/cdefs.h: No such file or directory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example2real-bug" class="md-nav__link">
    <span class="md-ellipsis">
      example2ï¼šreal bug
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example3" class="md-nav__link">
    <span class="md-ellipsis">
      example3
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      summary
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      è°ƒè¯•ç†è®ºçš„åº”ç”¨
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1_1" class="md-nav__link">
    <span class="md-ellipsis">
      å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥ï¼ˆ1ï¼‰
    </span>
  </a>
  
    <nav class="md-nav" aria-label="å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥ï¼ˆ1ï¼‰">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      çº¿ç¨‹åŒæ­¥
    </span>
  </a>
  
    <nav class="md-nav" aria-label="çº¿ç¨‹åŒæ­¥">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example1" class="md-nav__link">
    <span class="md-ellipsis">
      example1ï¼šæ¼”å¥éŸ³ä¹
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example2" class="md-nav__link">
    <span class="md-ellipsis">
      example2ï¼šçº¦ä¼š
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example3_1" class="md-nav__link">
    <span class="md-ellipsis">
      example3ï¼šæ›´è¿›ä¸€æ­¥
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      çŠ¶æ€æœºè§†è§’
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-" class="md-nav__link">
    <span class="md-ellipsis">
      ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ä¸æ¡ä»¶å˜é‡(â­)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ä¸æ¡ä»¶å˜é‡(â­)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#version1" class="md-nav__link">
    <span class="md-ellipsis">
      version1
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#version2" class="md-nav__link">
    <span class="md-ellipsis">
      version2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conditional-variable" class="md-nav__link">
    <span class="md-ellipsis">
      conditional variable
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      åŒæ­¥æœºåˆ¶çš„åº”ç”¨
    </span>
  </a>
  
    <nav class="md-nav" aria-label="åŒæ­¥æœºåˆ¶çš„åº”ç”¨">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      å¹¶è¡Œè®¡ç®—ï¼šå®ç°è®¡ç®—å›¾
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      åœºæ™¯ï¼šåŠ¨æ€è§„åˆ’
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      ä¹ é¢˜/é¢è¯•é¢˜
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#summary_1" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2_1" class="md-nav__link">
    <span class="md-ellipsis">
      å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥ï¼ˆ2ï¼‰
    </span>
  </a>
  
    <nav class="md-nav" aria-label="å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥ï¼ˆ2ï¼‰">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      ä¿¡å·é‡
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ä¿¡å·é‡">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      ä½¿ç”¨äº’æ–¥é”å®ç°åŒæ­¥
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    <span class="md-ellipsis">
      ä½¿ç”¨äº’æ–¥é”å®ç°è®¡ç®—å›¾
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    <span class="md-ellipsis">
      å®ç°ä¿¡å·é‡
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    <span class="md-ellipsis">
      ä½¿ç”¨ä¿¡å·é‡å®ç°åŒæ­¥
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ä½¿ç”¨ä¿¡å·é‡å®ç°åŒæ­¥">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    <span class="md-ellipsis">
      å¤§éƒ¨åˆ†åº”ç”¨åœºæ™¯
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-join" class="md-nav__link">
    <span class="md-ellipsis">
      ä¾‹å­ï¼ˆ1ï¼‰ï¼šä¿¡å·é‡å®ç°çº¿ç¨‹ join
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-" class="md-nav__link">
    <span class="md-ellipsis">
      ä¾‹å­ï¼ˆ2ï¼‰ï¼šä¿¡å·é‡å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    <span class="md-ellipsis">
      ä¿¡å·é‡ã€æ¡ä»¶å˜é‡ã€åŒæ­¥
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    <span class="md-ellipsis">
      çœŸå®ä¸–ç•Œçš„å¹¶å‘ç¼–ç¨‹
    </span>
  </a>
  
    <nav class="md-nav" aria-label="çœŸå®ä¸–ç•Œçš„å¹¶å‘ç¼–ç¨‹">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    <span class="md-ellipsis">
      æˆ‘ä»¬èº«è¾¹çš„å¹¶å‘ç¼–ç¨‹
    </span>
  </a>
  
    <nav class="md-nav" aria-label="æˆ‘ä»¬èº«è¾¹çš„å¹¶å‘ç¼–ç¨‹">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#web-20" class="md-nav__link">
    <span class="md-ellipsis">
      Web 2.0 æ—¶ä»£çš„å¹¶å‘ç¼–ç¨‹
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    <span class="md-ellipsis">
      æŠ€æœ¯æ€è€ƒ
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    <span class="md-ellipsis">
      é«˜æ€§èƒ½è®¡ç®—ä¸­çš„å¹¶è¡Œç¼–ç¨‹
    </span>
  </a>
  
    <nav class="md-nav" aria-label="é«˜æ€§èƒ½è®¡ç®—ä¸­çš„å¹¶è¡Œç¼–ç¨‹">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example" class="md-nav__link">
    <span class="md-ellipsis">
      example
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#openmp" class="md-nav__link">
    <span class="md-ellipsis">
      OpenMP
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    <span class="md-ellipsis">
      æ•°æ®ä¸­å¿ƒä¸­çš„å¹¶å‘ç¼–ç¨‹
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    <span class="md-ellipsis">
      äººå·¥æ™ºèƒ½æ—¶ä»£çš„å¹¶å‘ç¼–ç¨‹
    </span>
  </a>
  
    <nav class="md-nav" aria-label="äººå·¥æ™ºèƒ½æ—¶ä»£çš„å¹¶å‘ç¼–ç¨‹">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example_1" class="md-nav__link">
    <span class="md-ellipsis">
      example
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simd" class="md-nav__link">
    <span class="md-ellipsis">
      SIMD
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simt" class="md-nav__link">
    <span class="md-ellipsis">
      SIMT
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bugs" class="md-nav__link">
    <span class="md-ellipsis">
      å¹¶å‘bugs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="å¹¶å‘bugs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_32" class="md-nav__link">
    <span class="md-ellipsis">
      æ­»é”
    </span>
  </a>
  
    <nav class="md-nav" aria-label="æ­»é”">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_33" class="md-nav__link">
    <span class="md-ellipsis">
      æ­»é”äº§ç”Ÿçš„å¿…è¦æ¡ä»¶
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_34" class="md-nav__link">
    <span class="md-ellipsis">
      å®é™…ç³»ç»Ÿä¸­é¿å…æ­»é”ï¼Ÿ
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-racerace-condition" class="md-nav__link">
    <span class="md-ellipsis">
      æ•°æ®ç«äº‰/data race/race condition ï¼ˆé‡è¦ï¼‰
    </span>
  </a>
  
    <nav class="md-nav" aria-label="æ•°æ®ç«äº‰/data race/race condition ï¼ˆé‡è¦ï¼‰">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_35" class="md-nav__link">
    <span class="md-ellipsis">
      å®šä¹‰
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_36" class="md-nav__link">
    <span class="md-ellipsis">
      ä¾‹å­
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#more-bugcomplex" class="md-nav__link">
    <span class="md-ellipsis">
      é¢„å‘Š more bug/complex
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_37" class="md-nav__link">
    <span class="md-ellipsis">
      åŸå­æ€§/é¡ºåºè¿å
    </span>
  </a>
  
    <nav class="md-nav" aria-label="åŸå­æ€§/é¡ºåºè¿å">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#atomicity-violation" class="md-nav__link">
    <span class="md-ellipsis">
      åŸå­æ€§è¿å(Atomicity Violation)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#order-violation" class="md-nav__link">
    <span class="md-ellipsis">
      é¡ºåºè¿å (Order Violation)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bugs_1" class="md-nav__link">
    <span class="md-ellipsis">
      åº”å¯¹å¹¶å‘bugs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="åº”å¯¹å¹¶å‘bugs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_38" class="md-nav__link">
    <span class="md-ellipsis">
      è½¯ä»¶å±æœº
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_39" class="md-nav__link">
    <span class="md-ellipsis">
      åº”å¯¹æ­»é”
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_40" class="md-nav__link">
    <span class="md-ellipsis">
      åº”å¯¹æ­»å±€ï¼šç»å¤„é€¢ç”Ÿ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="åº”å¯¹æ­»å±€ï¼šç»å¤„é€¢ç”Ÿ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_41" class="md-nav__link">
    <span class="md-ellipsis">
      åŠ¨æ€ç¨‹åºåˆ†æ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lockdep-lock-ordering" class="md-nav__link">
    <span class="md-ellipsis">
      Lockdepï¼šè¿è¡Œæ—¶ lock ordering æ£€æŸ¥
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#threadsanitizer" class="md-nav__link">
    <span class="md-ellipsis">
      ThreadSanitizerï¼šè¿è¡Œæ—¶çš„æ•°æ®ç«äº‰æ£€æŸ¥
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#summarysanitizer" class="md-nav__link">
    <span class="md-ellipsis">
      Summaryï¼šSanitizer
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deadline" class="md-nav__link">
    <span class="md-ellipsis">
      åº”å¯¹æ­»çº¿ (Deadline)ï¼šé˜²å¾¡æ€§ç¼–ç¨‹
    </span>
  </a>
  
    <nav class="md-nav" aria-label="åº”å¯¹æ­»çº¿ (Deadline)ï¼šé˜²å¾¡æ€§ç¼–ç¨‹">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canarystack-guard" class="md-nav__link">
    <span class="md-ellipsis">
      Canaryï¼šStack Guard
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lockdep" class="md-nav__link">
    <span class="md-ellipsis">
      é˜²å¾¡æ€§ç¼–ç¨‹ï¼šä½é…ç‰ˆ Lockdep
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#addresssanitizer" class="md-nav__link">
    <span class="md-ellipsis">
      é˜²å¾¡æ€§ç¼–ç¨‹ï¼šä½é…ç‰ˆ AddressSanitizer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#threadsanitizer_1" class="md-nav__link">
    <span class="md-ellipsis">
      é˜²å¾¡æ€§ç¼–ç¨‹ï¼šä½é…ç‰ˆ ThreadSanitizer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#semanticsanitizer" class="md-nav__link">
    <span class="md-ellipsis">
      é˜²å¾¡æ€§ç¼–ç¨‹ï¼šSemanticSanitizer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#summary_2" class="md-nav__link">
    <span class="md-ellipsis">
      Summaryï¼šè¿™æ‰æ˜¯çœŸæ­£çš„ â€œç¼–ç¨‹â€
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary_3" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_42" class="md-nav__link">
    <span class="md-ellipsis">
      ä¸€äº›é—®é¢˜
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ä¸€äº›é—®é¢˜">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#barriersequence" class="md-nav__link">
    <span class="md-ellipsis">
      barrierã€sequence
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paper" class="md-nav__link">
    <span class="md-ellipsis">
      paper
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#todo" class="md-nav__link">
    <span class="md-ellipsis">
      TODO
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../3.%20virtualization/virtualization.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    virtualization
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../4.%20persistence/persistence.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    persistence
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_1_2" >
        
          
          <label class="md-nav__link" for="__nav_2_1_1_2" id="__nav_2_1_1_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Mini Labs
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_2_1_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_1_2">
            <span class="md-nav__icon md-icon"></span>
            Mini Labs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Mini%20Labs/M1/M1.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    M1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Mini%20Labs/M2/M2.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    M2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Mini%20Labs/M3/M3.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    M3
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_1_3" >
        
          
          <label class="md-nav__link" for="__nav_2_1_1_3" id="__nav_2_1_1_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    OS Labs
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_2_1_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_1_3">
            <span class="md-nav__icon md-icon"></span>
            OS Labs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../OS%20Labs/L0/L0.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    L0
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../OS%20Labs/L1/L1.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    L1
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    GeekTime
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            GeekTime
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_2_1" id="__nav_2_2_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    æ·±å…¥ç†è§£è®¡ç®—æœºç»„æˆåŸç†
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2_1">
            <span class="md-nav__icon md-icon"></span>
            æ·±å…¥ç†è§£è®¡ç®—æœºç»„æˆåŸç†
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../GeekTime/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/%E4%B8%80%E5%91%A8%E7%9B%AE/1.%20%E6%8C%87%E4%BB%A4%E4%B8%8E%E8%BF%90%E7%AE%97/%E6%8C%87%E4%BB%A4%E4%B8%8E%E8%BF%90%E7%AE%97.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1. æŒ‡ä»¤ä¸è¿ç®—
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../GeekTime/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/%E4%B8%80%E5%91%A8%E7%9B%AE/2.%20%E5%A4%84%E7%90%86%E5%99%A8/%E5%A4%84%E7%90%86%E5%99%A8.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2. å¤„ç†å™¨
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../GeekTime/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/%E4%B8%80%E5%91%A8%E7%9B%AE/3.%20%E5%AD%98%E5%82%A8%E4%B8%8EIO%E7%B3%BB%E7%BB%9F/%E5%AD%98%E5%82%A8%E4%B8%8EIO%E7%B3%BB%E7%BB%9F.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3. å­˜å‚¨ä¸IOç³»ç»Ÿ
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../GeekTime/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/%E4%B8%80%E5%91%A8%E7%9B%AE/4.%20%E5%BA%94%E7%94%A8/%E5%BA%94%E7%94%A8.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4. åº”ç”¨
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2_2" id="__nav_2_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    è®¡ç®—åŸºç¡€å®æˆ˜è¯¾
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2_2">
            <span class="md-nav__icon md-icon"></span>
            è®¡ç®—åŸºç¡€å®æˆ˜è¯¾
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../GeekTime/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80%E5%AE%9E%E6%88%98%E8%AF%BE/1.%20MiniCPU%E8%AE%BE%E8%AE%A1/MiniCPU%E8%AE%BE%E8%AE%A1.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1. MiniCPUè®¾è®¡
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../GeekTime/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80%E5%AE%9E%E6%88%98%E8%AF%BE/2.%20%E8%AF%AD%E8%A8%80%E5%92%8C%E6%8C%87%E4%BB%A4/%E8%AF%AD%E8%A8%80%E5%92%8C%E6%8C%87%E4%BB%A4.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2. è¯­è¨€å’ŒæŒ‡ä»¤
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../GeekTime/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80%E5%AE%9E%E6%88%98%E8%AF%BE/3.%20%E5%BA%94%E7%94%A8%E5%92%8C%E5%86%85%E5%AD%98/%E5%BA%94%E7%94%A8%E5%92%8C%E5%86%85%E5%AD%98.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3. åº”ç”¨å’Œå†…å­˜
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../GeekTime/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80%E5%AE%9E%E6%88%98%E8%AF%BE/4.%20IO%E4%B8%8E%E6%96%87%E4%BB%B6/IO%E5%92%8C%E6%96%87%E4%BB%B6.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4. IOä¸æ–‡ä»¶
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../GeekTime/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80%E5%AE%9E%E6%88%98%E8%AF%BE/5.%20%E7%BB%BC%E5%90%88%E5%BA%94%E7%94%A8/synthesis.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5. ç»¼åˆåº”ç”¨
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../GeekTime/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80%E5%AE%9E%E6%88%98%E8%AF%BE/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E5%92%8C%E5%B7%A5%E5%85%B7%E9%93%BE/%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ç¯å¢ƒé…ç½®å’Œå·¥å…·é“¾
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    ysyx
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            ysyx
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    NJU-ICS2023-PA
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            NJU-ICS2023-PA
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../ysyx/pa/pa1/pa1.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PA1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../ysyx/pa/pa2/pa2.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PA2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../ysyx/pa/pa3/pa3.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PA3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../ysyx/pa/pa4/pa4.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PA4
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../ysyx/pa/c_marco/macro.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    C Macro
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../ysyx/pa/summary/summary.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Summary
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../ysyx/pa/Linux_porting/porting.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Linux Porting
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../ysyx/digital-circuit/digital%20circuit.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Digital Circuit
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      å¤šå¤„ç†å™¨ç¼–ç¨‹
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      å¹¶å‘æ§åˆ¶ï¼šäº’æ–¥ï¼ˆ1ï¼‰
    </span>
  </a>
  
    <nav class="md-nav" aria-label="å¹¶å‘æ§åˆ¶ï¼šäº’æ–¥ï¼ˆ1ï¼‰">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      é˜»æ­¢å¹¶å‘ï¼ˆå¹¶è¡Œï¼‰çš„å‘ç”Ÿ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="é˜»æ­¢å¹¶å‘ï¼ˆå¹¶è¡Œï¼‰çš„å‘ç”Ÿ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#demo" class="md-nav__link">
    <span class="md-ellipsis">
      DEMO
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loadstore" class="md-nav__link">
    <span class="md-ellipsis">
      ä½¿ç”¨ load/store å®ç°äº’æ–¥ï¼ˆï¼‰
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      åœ¨å¤šå¤„ç†å™¨ä¸Šå®ç°äº’æ–¥
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      å¹¶å‘æ§åˆ¶ï¼šäº’æ–¥ï¼ˆ2ï¼‰
    </span>
  </a>
  
    <nav class="md-nav" aria-label="å¹¶å‘æ§åˆ¶ï¼šäº’æ–¥ï¼ˆ2ï¼‰">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      ç°å®è¦æ±‚ä½†æœ‰äººä¸éµå®ˆ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      æ“ä½œç³»ç»Ÿå†…æ ¸ä¸­çš„è‡ªæ—‹é”
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72-read-copy-update" class="md-nav__link">
    <span class="md-ellipsis">
      7.2 æ“ä½œç³»ç»Ÿå†…æ ¸ä¸­çš„ (åŠ) æ— é”äº’æ–¥ï¼šRead-Copy-Update ğŸŒ¶ï¸
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      åº”ç”¨ç¨‹åºä¸­çš„äº’æ–¥
    </span>
  </a>
  
    <nav class="md-nav" aria-label="åº”ç”¨ç¨‹åºä¸­çš„äº’æ–¥">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pthread-mutex-lock" class="md-nav__link">
    <span class="md-ellipsis">
      pthread Mutex Lock
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#futex-fast-userspace-mutexes" class="md-nav__link">
    <span class="md-ellipsis">
      Futex: Fast Userspace muTexes ğŸŒ¶ï¸
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      å¯¹æ¯”ä¸‰ç§äº’æ–¥æ‰‹æ®µ
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      è°ƒè¯•ç†è®ºä¸å®è·µ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="è°ƒè¯•ç†è®ºä¸å®è·µ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      å¬æ•…äº‹
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      è°ƒè¯•ç†è®º
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      è°ƒè¯•ä¸€åˆ‡
    </span>
  </a>
  
    <nav class="md-nav" aria-label="è°ƒè¯•ä¸€åˆ‡">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example0" class="md-nav__link">
    <span class="md-ellipsis">
      example0
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example1syscdefsh-no-such-file-or-directory" class="md-nav__link">
    <span class="md-ellipsis">
      example1ï¼šsys/cdefs.h: No such file or directory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example2real-bug" class="md-nav__link">
    <span class="md-ellipsis">
      example2ï¼šreal bug
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example3" class="md-nav__link">
    <span class="md-ellipsis">
      example3
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      summary
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      è°ƒè¯•ç†è®ºçš„åº”ç”¨
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1_1" class="md-nav__link">
    <span class="md-ellipsis">
      å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥ï¼ˆ1ï¼‰
    </span>
  </a>
  
    <nav class="md-nav" aria-label="å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥ï¼ˆ1ï¼‰">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      çº¿ç¨‹åŒæ­¥
    </span>
  </a>
  
    <nav class="md-nav" aria-label="çº¿ç¨‹åŒæ­¥">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example1" class="md-nav__link">
    <span class="md-ellipsis">
      example1ï¼šæ¼”å¥éŸ³ä¹
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example2" class="md-nav__link">
    <span class="md-ellipsis">
      example2ï¼šçº¦ä¼š
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example3_1" class="md-nav__link">
    <span class="md-ellipsis">
      example3ï¼šæ›´è¿›ä¸€æ­¥
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      çŠ¶æ€æœºè§†è§’
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#-" class="md-nav__link">
    <span class="md-ellipsis">
      ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ä¸æ¡ä»¶å˜é‡(â­)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ä¸æ¡ä»¶å˜é‡(â­)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#version1" class="md-nav__link">
    <span class="md-ellipsis">
      version1
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#version2" class="md-nav__link">
    <span class="md-ellipsis">
      version2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conditional-variable" class="md-nav__link">
    <span class="md-ellipsis">
      conditional variable
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      åŒæ­¥æœºåˆ¶çš„åº”ç”¨
    </span>
  </a>
  
    <nav class="md-nav" aria-label="åŒæ­¥æœºåˆ¶çš„åº”ç”¨">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      å¹¶è¡Œè®¡ç®—ï¼šå®ç°è®¡ç®—å›¾
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      åœºæ™¯ï¼šåŠ¨æ€è§„åˆ’
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      ä¹ é¢˜/é¢è¯•é¢˜
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#summary_1" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2_1" class="md-nav__link">
    <span class="md-ellipsis">
      å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥ï¼ˆ2ï¼‰
    </span>
  </a>
  
    <nav class="md-nav" aria-label="å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥ï¼ˆ2ï¼‰">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      ä¿¡å·é‡
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ä¿¡å·é‡">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      ä½¿ç”¨äº’æ–¥é”å®ç°åŒæ­¥
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    <span class="md-ellipsis">
      ä½¿ç”¨äº’æ–¥é”å®ç°è®¡ç®—å›¾
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    <span class="md-ellipsis">
      å®ç°ä¿¡å·é‡
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    <span class="md-ellipsis">
      ä½¿ç”¨ä¿¡å·é‡å®ç°åŒæ­¥
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ä½¿ç”¨ä¿¡å·é‡å®ç°åŒæ­¥">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    <span class="md-ellipsis">
      å¤§éƒ¨åˆ†åº”ç”¨åœºæ™¯
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-join" class="md-nav__link">
    <span class="md-ellipsis">
      ä¾‹å­ï¼ˆ1ï¼‰ï¼šä¿¡å·é‡å®ç°çº¿ç¨‹ join
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-" class="md-nav__link">
    <span class="md-ellipsis">
      ä¾‹å­ï¼ˆ2ï¼‰ï¼šä¿¡å·é‡å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    <span class="md-ellipsis">
      ä¿¡å·é‡ã€æ¡ä»¶å˜é‡ã€åŒæ­¥
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    <span class="md-ellipsis">
      çœŸå®ä¸–ç•Œçš„å¹¶å‘ç¼–ç¨‹
    </span>
  </a>
  
    <nav class="md-nav" aria-label="çœŸå®ä¸–ç•Œçš„å¹¶å‘ç¼–ç¨‹">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    <span class="md-ellipsis">
      æˆ‘ä»¬èº«è¾¹çš„å¹¶å‘ç¼–ç¨‹
    </span>
  </a>
  
    <nav class="md-nav" aria-label="æˆ‘ä»¬èº«è¾¹çš„å¹¶å‘ç¼–ç¨‹">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#web-20" class="md-nav__link">
    <span class="md-ellipsis">
      Web 2.0 æ—¶ä»£çš„å¹¶å‘ç¼–ç¨‹
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    <span class="md-ellipsis">
      æŠ€æœ¯æ€è€ƒ
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    <span class="md-ellipsis">
      é«˜æ€§èƒ½è®¡ç®—ä¸­çš„å¹¶è¡Œç¼–ç¨‹
    </span>
  </a>
  
    <nav class="md-nav" aria-label="é«˜æ€§èƒ½è®¡ç®—ä¸­çš„å¹¶è¡Œç¼–ç¨‹">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example" class="md-nav__link">
    <span class="md-ellipsis">
      example
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#openmp" class="md-nav__link">
    <span class="md-ellipsis">
      OpenMP
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    <span class="md-ellipsis">
      æ•°æ®ä¸­å¿ƒä¸­çš„å¹¶å‘ç¼–ç¨‹
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    <span class="md-ellipsis">
      äººå·¥æ™ºèƒ½æ—¶ä»£çš„å¹¶å‘ç¼–ç¨‹
    </span>
  </a>
  
    <nav class="md-nav" aria-label="äººå·¥æ™ºèƒ½æ—¶ä»£çš„å¹¶å‘ç¼–ç¨‹">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example_1" class="md-nav__link">
    <span class="md-ellipsis">
      example
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simd" class="md-nav__link">
    <span class="md-ellipsis">
      SIMD
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simt" class="md-nav__link">
    <span class="md-ellipsis">
      SIMT
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bugs" class="md-nav__link">
    <span class="md-ellipsis">
      å¹¶å‘bugs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="å¹¶å‘bugs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_32" class="md-nav__link">
    <span class="md-ellipsis">
      æ­»é”
    </span>
  </a>
  
    <nav class="md-nav" aria-label="æ­»é”">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_33" class="md-nav__link">
    <span class="md-ellipsis">
      æ­»é”äº§ç”Ÿçš„å¿…è¦æ¡ä»¶
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_34" class="md-nav__link">
    <span class="md-ellipsis">
      å®é™…ç³»ç»Ÿä¸­é¿å…æ­»é”ï¼Ÿ
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-racerace-condition" class="md-nav__link">
    <span class="md-ellipsis">
      æ•°æ®ç«äº‰/data race/race condition ï¼ˆé‡è¦ï¼‰
    </span>
  </a>
  
    <nav class="md-nav" aria-label="æ•°æ®ç«äº‰/data race/race condition ï¼ˆé‡è¦ï¼‰">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_35" class="md-nav__link">
    <span class="md-ellipsis">
      å®šä¹‰
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_36" class="md-nav__link">
    <span class="md-ellipsis">
      ä¾‹å­
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#more-bugcomplex" class="md-nav__link">
    <span class="md-ellipsis">
      é¢„å‘Š more bug/complex
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_37" class="md-nav__link">
    <span class="md-ellipsis">
      åŸå­æ€§/é¡ºåºè¿å
    </span>
  </a>
  
    <nav class="md-nav" aria-label="åŸå­æ€§/é¡ºåºè¿å">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#atomicity-violation" class="md-nav__link">
    <span class="md-ellipsis">
      åŸå­æ€§è¿å(Atomicity Violation)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#order-violation" class="md-nav__link">
    <span class="md-ellipsis">
      é¡ºåºè¿å (Order Violation)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bugs_1" class="md-nav__link">
    <span class="md-ellipsis">
      åº”å¯¹å¹¶å‘bugs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="åº”å¯¹å¹¶å‘bugs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_38" class="md-nav__link">
    <span class="md-ellipsis">
      è½¯ä»¶å±æœº
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_39" class="md-nav__link">
    <span class="md-ellipsis">
      åº”å¯¹æ­»é”
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_40" class="md-nav__link">
    <span class="md-ellipsis">
      åº”å¯¹æ­»å±€ï¼šç»å¤„é€¢ç”Ÿ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="åº”å¯¹æ­»å±€ï¼šç»å¤„é€¢ç”Ÿ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_41" class="md-nav__link">
    <span class="md-ellipsis">
      åŠ¨æ€ç¨‹åºåˆ†æ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lockdep-lock-ordering" class="md-nav__link">
    <span class="md-ellipsis">
      Lockdepï¼šè¿è¡Œæ—¶ lock ordering æ£€æŸ¥
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#threadsanitizer" class="md-nav__link">
    <span class="md-ellipsis">
      ThreadSanitizerï¼šè¿è¡Œæ—¶çš„æ•°æ®ç«äº‰æ£€æŸ¥
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#summarysanitizer" class="md-nav__link">
    <span class="md-ellipsis">
      Summaryï¼šSanitizer
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deadline" class="md-nav__link">
    <span class="md-ellipsis">
      åº”å¯¹æ­»çº¿ (Deadline)ï¼šé˜²å¾¡æ€§ç¼–ç¨‹
    </span>
  </a>
  
    <nav class="md-nav" aria-label="åº”å¯¹æ­»çº¿ (Deadline)ï¼šé˜²å¾¡æ€§ç¼–ç¨‹">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canarystack-guard" class="md-nav__link">
    <span class="md-ellipsis">
      Canaryï¼šStack Guard
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lockdep" class="md-nav__link">
    <span class="md-ellipsis">
      é˜²å¾¡æ€§ç¼–ç¨‹ï¼šä½é…ç‰ˆ Lockdep
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#addresssanitizer" class="md-nav__link">
    <span class="md-ellipsis">
      é˜²å¾¡æ€§ç¼–ç¨‹ï¼šä½é…ç‰ˆ AddressSanitizer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#threadsanitizer_1" class="md-nav__link">
    <span class="md-ellipsis">
      é˜²å¾¡æ€§ç¼–ç¨‹ï¼šä½é…ç‰ˆ ThreadSanitizer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#semanticsanitizer" class="md-nav__link">
    <span class="md-ellipsis">
      é˜²å¾¡æ€§ç¼–ç¨‹ï¼šSemanticSanitizer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#summary_2" class="md-nav__link">
    <span class="md-ellipsis">
      Summaryï¼šè¿™æ‰æ˜¯çœŸæ­£çš„ â€œç¼–ç¨‹â€
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary_3" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_42" class="md-nav__link">
    <span class="md-ellipsis">
      ä¸€äº›é—®é¢˜
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ä¸€äº›é—®é¢˜">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#barriersequence" class="md-nav__link">
    <span class="md-ellipsis">
      barrierã€sequence
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#paper" class="md-nav__link">
    <span class="md-ellipsis">
      paper
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#todo" class="md-nav__link">
    <span class="md-ellipsis">
      TODO
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>concurrency</h1>

<p>åªè®°å½•éƒ¨åˆ†ã€‚</p>
<h2 id="_1">å¤šå¤„ç†å™¨ç¼–ç¨‹</h2>
<p><img src="pic/image-20241110231300436.png" alt="image-20241110231300436" style="zoom:50%;" /></p>
<ul>
<li>
<p>è¯æ˜å…±äº«å†…å­˜</p>
<blockquote>
<p><strong><mark>DEMO</mark></strong></p>
<p><strong>å¹¶å‘çº¿ç¨‹æ¨¡å‹</strong>ï¼š<strong>å¹¶å‘çº¿ç¨‹èƒ½å¤Ÿè¯»å†™å…±äº«çš„ heap å †åŒº</strong>ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæ¯ä¸ªçº¿ç¨‹æŒæœ‰å±€éƒ¨å˜é‡çš„å‰¯æœ¬ã€‚Mosaic ä¸ä¼šè‡ªåŠ¨åœ¨æ¯æ¡è¯­å¥ä¹‹åè¿›è¡Œçº¿ç¨‹è°ƒåº¦ï¼šæˆ‘ä»¬éœ€è¦æ‰‹å·¥æ’å…¥ <code>sys_sched</code>ã€‚</p>
</blockquote>
</li>
</ul>
<h2 id="1">å¹¶å‘æ§åˆ¶ï¼šäº’æ–¥ï¼ˆ1ï¼‰</h2>
<p><img src="pic/image-20241118211713662.png" alt="image-20241118211713662" style="zoom:50%;" /></p>
<p>æ€ä¹ˆåº”å¯¹ï¼Ÿ</p>
<h3 id="_2">é˜»æ­¢å¹¶å‘ï¼ˆå¹¶è¡Œï¼‰çš„å‘ç”Ÿ</h3>
<p>ä»€ä¹ˆå«äº’æ–¥ï¼Ÿä»€ä¹ˆå«å¹¶å‘ï¼Ÿ</p>
<blockquote>
<p><strong>Concurrent</strong> means happening at the same time</p>
</blockquote>
<p>â€è¦æ±‚æ•´ä¸ªä¸–ç•Œæœ‰å°æ®µæ—¶é—´åªå±äºè‡ªå·±ï¼Œä»»ä½•äººéƒ½ä¸èƒ½æ‰“æ–­â€œ</p>
<p>â€äººæƒ³è±¡æˆçº¿ç¨‹ï¼Œå¤šçº¿ç¨‹æƒ³è±¡æˆç‰©ç†ä¸–ç•Œâ€œ</p>
<ul>
<li><strong>äº’æ–¥</strong> (äº’ç›¸æ’æ–¥)ï¼šé˜»æ­¢å¹¶å‘</li>
</ul>
<p><img src="pic/image-20241118211611213.png" alt="image-20241118211611213" style="zoom:50%;" /></p>
<p><strong>é‚£å¦‚ä½•å®ç°äº’æ–¥ï¼Ÿ</strong></p>
<p>å•æ ¸å®ç°äº’æ–¥ï¼šå…³ä¸­æ–­</p>
<p><img src="pic/image-20241118214211804.png" alt="image-20241118214211804" style="zoom:50%;" /></p>
<blockquote>
<h6 id="demo"><strong><mark>DEMO</mark></strong></h6>
<p><strong>Stop-the-world å®ç°äº’æ–¥</strong>ï¼šå¯¹äºæ“ä½œç³»ç»Ÿä¸Šçš„åº”ç”¨ç¨‹åºï¼Œå…³é—­ä¸­æ–­æ˜¯ä¸èƒ½å®¹å¿çš„ï¼šè¿™ä¼šä½¿å¾®å°çš„ bug æˆ–æ˜¯æ¶æ„çš„ç¨‹åºç ´åè®¡ç®—æœºçš„è¿è¡Œã€‚æ“ä½œç³»ç»Ÿæ­£æ˜¯å› ä¸ºç»Ÿæ²»äº†ä¸­æ–­ï¼Œæ‰å®ç°äº†å¯¹åº”ç”¨ç¨‹åºçš„ç®¡ç†ã€‚<strong>åœ¨æ“ä½œç³»ç»Ÿå†…æ ¸çš„å®ç°ä¸­ï¼Œå…³é—­ä¸­æ–­æ˜¯ä¸€ä¸ªå¸¸è§çš„æ“ä½œã€‚</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">// Clear FL_IF in the CPU.</span>
<span class="c1">// Interrupt disabled.</span>
<span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;cli&quot;</span><span class="p">);</span>
<span class="w">                                                                                                                        </span>
<span class="c1">// Set FL_IF in the CPU.</span>
<span class="c1">// Interrupt enabled.</span>
<span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;sti&quot;</span><span class="p">);</span>
</code></pre></div>
<p>ä¾‹å¤–ï¼šä¸å¯å±è”½ä¸­æ–­ NMI (Non-Maskable Interrupts) <a href="https://wiki.osdev.org/Non_Maskable_Interrupt">Non Maskable Interrupt - OSDev Wiki</a></p>
<ul>
<li>å¯ä»¥åˆ©ç”¨ NMI å®ç°é”™è¯¯ç›‘æ§<ul>
<li>è®¾ç½®ç¡¬ä»¶å®šæ—¶è§¦å‘</li>
<li>æ“ä½œç³»ç»Ÿå®šæ—¶å¤ä½å®šæ—¶å™¨</li>
<li>è§¦å‘ timeoutï¼Œæ‰§è¡Œ NMI å¤„ç†ç¨‹åº<ul>
<li>ä¾‹å¦‚ï¼Œé‡å¯è®¡ç®—æœº</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¸ªä¸å¯å±è”½ä¸­æ–­ï¼Ÿ</p>
<p>å…¶å®åˆšå¼€å§‹æˆ‘å¯¹è¿™ä¸ªæ¦‚å¿µæ˜¯å¾ˆè¿·ç³Šçš„ï¼Œå¹¶æ²¡æœ‰å…·ä½“å¤§å°è±¡å’Œæ¦‚å¿µï¼Œå› ä¸ºè‡ªå·±å¹¶ä¸æ˜¯å¯¹ç”µè„‘ç‰¹åˆ«çš„ç†Ÿæ‚‰ï¼Œæ¯•ç«Ÿæ˜¯è¯´ä»ä¸Šå¤§å­¦æ‰å¼€å§‹æ¥è§¦ï¼Œå­¦ä¹ å®ŒæˆPAï¼Œå¯¹è½¯ä»¶å’Œç¡¬ä»¶æœ‰äº†ä¸€å®šå¯¹äº†è§£ä¹‹åï¼Œå…¶å®è®¡ç®—æœºä¸­çš„ä»»ä½•ä¸œè¥¿éƒ½æ˜¯äººé€ å‡ºæ¥çš„ï¼Œå—åˆ°å„ç§å„æ ·çš„å› ç´ è½¯ä»¶å’Œç¡¬ä»¶éƒ½ä¼šæœ‰é”™è¯¯ï¼ˆå½“ç„¶ç°åœ¨çš„è®¡ç®—æœºè½¯ç¡¬ä»¶å¯èƒ½ç›¸å¯¹å®Œå–„ï¼‰ï¼Œå¾ˆå¤šçš„é”™è¯¯æƒ…å†µåœ¨ç¡¬ä»¶å’Œè½¯ä»¶ä¸Šéƒ½ä¼šé€šè¿‡å„ç§æ–¹å¼æ¥å‘ŠçŸ¥æˆ‘ä»¬å®ƒåäº†ï¼Œè€Œè¿™ç§æ–¹å¼å°±æ˜¯å‰äººé‡åˆ°äº†ç±»ä¼¼çš„é—®é¢˜ï¼Œä»–ä»¬æƒ³å‡ºæ¥äº†ä¸€ç§æ–¹æ¡ˆï¼Œæœ€ç»ˆå®æ–½åˆ°è®¡ç®—æœºä¸Šã€‚</p>
<p>NMI æˆ–è®¸å°±æ˜¯è¿™ä¹ˆä¸€ç§æ–¹å¼ï¼ˆæˆ‘åªæ˜¯è¿™ä¹ˆæ–¹ä¾¿ç†è§£ï¼Œåªæ˜¯çŒœçš„ï¼‰ã€‚æ‰€ä»¥æˆ‘å¯¹ NMI åŠä¸­æ–­å¤„ç†ç¨‹åº çš„ç†è§£å…¶å®ä¹Ÿå°±æ˜¯å¤„ç†ä¸€äº›ä¸å¯æ¢å¤å’Œæå…¶é‡è¦çš„ç¡¬ä»¶æ•…éšœé”™è¯¯ï¼Œä»¥åŠè®©æˆ‘ä»¬ä¿®å¤å®ƒï¼Œä¸ç„¶è®¡ç®—æœºå°±æ²¡æ³•å·¥ä½œå•¦ã€‚æ¯”å¦‚èŠ¯ç‰‡å†…éƒ¨æŸå¤„å‡ºç°æ•…éšœï¼›å†…å­˜æ¡æŸåï¼Œæ“ä½œç³»ç»Ÿæ€ä¹ˆèƒ½å‘ç°ï¼ŸECCã€å¥‡å¶æ ¡éªŒï¼Ÿ
è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆå¾ˆå¤šè€å¼çš„æœºå™¨ä¸Šä¼šæœ‰å¤ä½æŒ‰é”®ã€‚</p>
<p>å¯èƒ½ä¸Šé¢è¿˜æ˜¯å¾ˆè¿·ç³Šï¼Œå†ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨åµŒå…¥å¼ä¸­æŒºæœ‰ç”¨çš„ï¼šåœ¨å¤„ç†å™¨å› é™ç”µæ”¾ç”µè€Œé™·å…¥å¾ªç¯æ—¶ã€‚å½“å¸¸è§„ä¸­æ–­å…³é—­æ—¶ï¼Œç³»ç»Ÿæ— æ³•æ¢å¤é”™è¯¯çŠ¶æ€ï¼Œè€ŒNMIå› å…¶ä¸å¯å±è”½æ€§ï¼Œå¯ä»¥é€šè¿‡æ¥è‡ªçœ‹é—¨ç‹—å®šæ—¶å™¨ã€åå¤„ç†å™¨æˆ–äººå·¥æŒ‰é’®çš„ä¿¡å·ä½¿å¤„ç†å™¨æ¢å¤å·¥ä½œçŠ¶æ€ã€‚</p>
<p>å†å¦‚ï¼šNMIå¤„ç†ç¨‹åºå¯ä»¥å¤„ç†å¦‚çƒ­äº‹ä»¶æˆ–ç”µæºæ•…éšœç­‰æƒ…å†µï¼Œä»¥é˜²æ­¢æŸåæˆ–ç¡®ä¿åœ¨æ–­ç”µå‰å°†æ•°æ®å¤‡ä»½åˆ°éæ˜“å¤±æ€§å­˜å‚¨ã€‚</p>
</blockquote>
<p>é‚£å¤šå¤„ç†å™¨å‘¢ï¼Ÿ</p>
<p><img src="pic/image-20241118211902945.png" alt="image-20241118211902945" style="zoom:50%;" /></p>
<h3 id="loadstore">ä½¿ç”¨ load/store å®ç°äº’æ–¥ï¼ˆï¼‰</h3>
<p>è½¯ä»¶æ€ä¹ˆåšï¼Ÿæƒ³å‡ºäº† <strong>Peterson ç®—æ³•</strong>ã€‚ç›´æ¥çœ‹çœ‹è®²ä¹‰å’Œè§†é¢‘è®²è§£å§ã€‚</p>
<h3 id="_3">åœ¨å¤šå¤„ç†å™¨ä¸Šå®ç°äº’æ–¥</h3>
<p><img src="pic/image-20241118212608893.png" alt="image-20241118212608893" style="zoom:50%;" /></p>
<p>éœ€è¦æ„è¯†åˆ°ï¼š<strong>å› ä¸ºäººç±»æ˜¯â€œsequential creaturesâ€ï¼Œå¯¼è‡´è¿‡å»çš„å¾ˆå¤šè®¾è®¡æ˜¯æ²¡æœ‰è€ƒè™‘å¹¶å‘çš„ï¼ˆå¤šå¤„ç†å™¨ã€å…±äº«å†…å­˜ï¼‰ï¼Œè€Œæˆ‘ä»¬åœ¨å…±äº«å†…å­˜ä¸Šå®ç°äº’æ–¥çš„å¤±è´¥å’ŒæˆåŠŸå°è¯•åï¼Œæˆ‘ä»¬æ„è¯†åˆ°è½¯ä»¶éœ€è¦å’Œç¡¬ä»¶ååŒå·¥ä½œï¼Œå¹¶åœ¨ç¡¬ä»¶åŸå­æŒ‡ä»¤åŸºç¡€ä¸Šå®ç°äº†åŸºç¡€ç‰ˆæœ¬çš„è‡ªæ—‹é”ã€‚</strong></p>
<p>å…³é”®åœ¨äºç¡¬ä»¶å®ç°ï¼Œåœ¨ OS è¯¾ä¸Šå¯ä¸ç”¨æ·±ç©¶ï¼Œä¸å±äºæœ¬é—¨è¯¾çš„èŒƒå›´ã€‚</p>
<blockquote>
<p>æ›´å¤šå†…å®¹ï¼š</p>
<p><a href="https://stackoverflow.com/questions/14758088/how-are-atomic-operations-implemented-at-a-hardware-level">x86 - How are atomic operations implemented at a hardware level? - Stack Overflow</a></p>
<p><a href="https://superuser.com/questions/400786/how-does-an-atomic-operation-guarantee-consistency-from-a-hardware-perspective">computer architecture - How does an atomic operation guarantee consistency from a hardware perspective? - Super User</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/649646816">è®¡ç®—æœºåŸå­ï¼ˆatomicï¼‰æ“ä½œçš„å®ç°åŸç†è§£æ - çŸ¥ä¹</a></p>
<p>è¿™é‡Œå¯ä»¥æ€»ç»“ä¸ºï¼š</p>
<p>Extra transistors in the chip to implement <strong>special cache</strong> and memory coherency and <strong>bus synchronization procotols</strong>. The long answer is way too long.</p>
<p>å†è¿›ä¸€æ­¥ä¸¾ä¾‹ç›¸å…³å®ç°æ‰‹æ®µï¼š</p>
<p>æ€»çº¿é”å®šã€ç¼“å­˜é”å®šã€ç›¸å…³ç¼“å­˜ä¸€è‡´æ€§åè®®ã€LL/SCï¼ˆLR/SCï¼ˆarmv8çš„ç‹¬å åŠ è½½ã€ç‹¬å å­˜å‚¨ï¼‰ï¼‰</p>
<p>å…·ä½“æ€ä¹ˆå®ç°ï¼Ÿæˆ‘è§‰å¾—è¿™åº”è¯¥å±äºä½“ç³»ç»“æ„ã€å¤šæ ¸å¤„ç†å™¨è®¾è®¡ä¸Šçš„ç›¸å…³å†…å®¹äº†ï¼Œçœ‹çœ‹æ€ä¹ˆå¯¹æ€»çº¿æ“ä½œï¼Ÿ</p>
<p><a href="https://zhuanlan.zhihu.com/p/422848235">å†…å­˜ä¸€è‡´æ€§(Memory Consistency) - çŸ¥ä¹</a></p>
<p>å¯ä»¥å†å¥½å¥½æ€»ç»“ã€‚ã€‚<strong><mark>TODO</mark></strong></p>
</blockquote>
<p>å®ç°ã€‚</p>
<blockquote>
<p>ä¸º add/inc ç­‰æŒ‡ä»¤å¢åŠ  lock çš„å‰ç¼€ï¼Œå¤„ç†å™¨ç¡¬ä»¶ä¼šå®ç°å°†è¿™æ¡æŒ‡ä»¤å®ç°ä¸ºåŸå­æŒ‡ä»¤ã€‚</p>
</blockquote>
<p><img alt="image-20250108234540240" src="pic/image-20250108234540240.png" /></p>
<p>è¿›ä¸€æ­¥ï¼Œå€ŸåŠ©ç¡¬ä»¶ <code>lock</code> å®ç°äº†äº’æ–¥åŠŸèƒ½ï¼Œæˆ‘ä»¬å°±èƒ½å®ç° 1 + 1 ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;lock addq $1, %0&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;+m&quot;</span><span class="p">(</span><span class="n">sum</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div>
<p>å†è¿›ä¸€æ­¥ï¼Œæˆ‘ä»¬è¦å®ç°äº’æ–¥ï¼Œæœ‰ä¸€ä¸ªé‡è¦çš„ç‚¹å°±æ˜¯ç‹¬å ï¼Œé‚£æ€ä¹ˆå€ŸåŠ©ç¡¬ä»¶æä¾›çš„ <code>lock</code> å®ç°å‘¢ï¼Ÿ</p>
<p>è¿™é‡Œæå‡ºè¿™ä¸ªè‡ªæ—‹é”è¿˜æ˜¯æŒºè‡ªç„¶çš„ï¼Œé¡ºç€ä¹‹å‰ä¸Šå•æ‰€çš„ä¾‹å­ï¼Œå•æ‰€æœ‰äººï¼ˆçº¿ç¨‹1ï¼‰ï¼Œæˆ‘ï¼ˆçº¿ç¨‹2ï¼‰å°±ä¸€ç›´åœ¨é—¨å£ç­‰ç€å‘—ï¼Ÿæˆ‘å°±å µåœ¨è¿™å‘—ï¼Œä»€ä¹ˆæ—¶å€™çº¿ç¨‹1å¥½äº†ï¼Œæˆ‘å†è¿›å»ä¸Šå•æ‰€å‘—ã€‚</p>
<blockquote>
<p>çœ‹åˆ°è¿™é‡Œæ€»æ˜¯ä¼šæƒ³ç€ä¼˜åŒ–ï¼Œè¿™ä¸ªçº¿ç¨‹å µäº†ï¼ŒOS è®© CPU æ‰§è¡Œåˆ«çš„ çº¿ç¨‹ï¼Œåˆ«æµªè´¹å‘€ã€‚æœ‰æ²¡æœ‰èƒ½ä¸å µçš„æ–¹æ³•ï¼Ÿè‚¯å®šæœ‰ï¼äº’æ–¥é”å—ï¼Ÿåœ¨ <code>FreeRTOS</code> é‡Œç”¨è¿‡ä¸€ç‚¹ï¼Œä½†æ˜¯æ˜¯å•æ ¸ MCU çš„ã€‚</p>
</blockquote>
<p><img src="pic/image-20241118212545883.png" alt="image-20241118212545883" style="zoom: 50%;" /></p>
<p>å…·ä½“åˆ†æä¼ªä»£ç ï¼š</p>
<p>å¥½çš„ï¼Œæˆ‘ä»¬æ¥è¯¦ç»†åˆ†æ<code>atomic_xchg</code>è¿™æ¡æŒ‡ä»¤ä¸ºä»€ä¹ˆèƒ½å®ç°äº’æ–¥ã€‚</p>
<ol>
<li><strong><code>atomic_xchg(&amp;status, âŒ)</code> è¿™æ¡æŒ‡ä»¤ä¸»è¦åšäº†ä»€ä¹ˆï¼Ÿ</strong>**<ol>
<li><strong>è¯»å–æ—§å€¼</strong>ï¼šå®ƒé¦–å…ˆè¯»å–<code>status</code>å˜é‡çš„å½“å‰å€¼ã€‚è¿™ä¸ªè¯»å–æ“ä½œæ˜¯åŸå­æ€§çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨è¯»å–è¿‡ç¨‹ä¸­ï¼Œå…¶ä»–å¤„ç†å™¨ä¸èƒ½å¯¹<code>status</code>è¿›è¡Œå†™æ“ä½œã€‚è¿™ä¿è¯äº†è¯»å–åˆ°çš„<code>status</code>å€¼æ˜¯æœ€æ–°çš„ã€æœªè¢«å…¶ä»–å¤„ç†å™¨ä¿®æ”¹è¿‡çš„å€¼ã€‚</li>
<li><strong>å†™å…¥æ–°å€¼</strong>ï¼šåœ¨è¯»å–åˆ°<code>status</code>çš„æ—§å€¼ä¹‹åï¼Œç«‹å³å°†<code>status</code>çš„å€¼è®¾ç½®ä¸º<code>âŒ</code>ã€‚è¿™ä¸ªå†™æ“ä½œä¹Ÿæ˜¯åŸå­æ€§çš„ï¼Œä¸ä¼šè¢«å…¶ä»–å¤„ç†å™¨çš„æ“ä½œæ‰“æ–­ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä»è¯»å–æ—§å€¼åˆ°å†™å…¥æ–°å€¼çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œæ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„æ“ä½œã€‚</li>
</ol>
</li>
<li><strong>äº’æ–¥çš„å®ç°åŸç†</strong><ol>
<li><strong>èµ„æºé”å®šé˜¶æ®µï¼ˆ<code>lock</code>å‡½æ•°ï¼‰</strong><ul>
<li>å½“ä¸€ä¸ªå¤„ç†å™¨æ‰§è¡Œ<code>lock</code>å‡½æ•°æ—¶ï¼Œå®ƒä¼šè°ƒç”¨<code>atomic_xchg(&amp;status, âŒ)</code>ã€‚å‡è®¾æ­¤æ—¶<code>status</code>çš„å€¼ä¸º<code>âœ…</code>ï¼Œè¡¨ç¤ºèµ„æºæ˜¯ç©ºé—²çš„ã€‚</li>
<li><code>atomic_xchg</code>æŒ‡ä»¤é¦–å…ˆè¯»å–åˆ°<code>status</code>çš„æ—§å€¼<code>âœ…</code>ï¼Œç„¶åå°†<code>status</code>è®¾ç½®ä¸º<code>âŒ</code>ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯åŸå­æ€§çš„ï¼Œå…¶ä»–å¤„ç†å™¨åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ— æ³•å¯¹<code>status</code>è¿›è¡Œä¿®æ”¹ã€‚</li>
<li>ç”±äº<code>got</code>å˜é‡å¾—åˆ°äº†<code>âœ…</code>ï¼Œè¡¨ç¤ºå½“å‰å¤„ç†å™¨æˆåŠŸè·å–äº†èµ„æºé”ã€‚æ­¤æ—¶ï¼Œ<code>status</code>çš„å€¼ä¸º<code>âŒ</code>ï¼Œå…¶ä»–å¤„ç†å™¨åœ¨æ‰§è¡Œ<code>atomic_xchg(&amp;status, âŒ)</code>æ—¶ï¼Œè¯»å–åˆ°çš„<code>status</code>å€¼å°†æ˜¯<code>âŒ</code>ï¼Œå› æ­¤å®ƒä»¬çš„<code>got</code>å˜é‡ä¼šå¾—åˆ°<code>âŒ</code>ï¼Œè¿›å…¥<code>retry</code>å¾ªç¯ï¼Œç­‰å¾…èµ„æºé‡Šæ”¾ã€‚</li>
</ul>
</li>
<li><strong>èµ„æºé‡Šæ”¾é˜¶æ®µï¼ˆ<code>unlock</code>å‡½æ•°ï¼‰</strong><ul>
<li>å½“æŒæœ‰èµ„æºçš„å¤„ç†å™¨å®Œæˆä»»åŠ¡åï¼Œå®ƒä¼šè°ƒç”¨<code>unlock</code>å‡½æ•°ï¼Œæ‰§è¡Œ<code>atomic_xchg(&amp;status, âœ…)</code>ã€‚</li>
<li>è¿™æ¡æŒ‡ä»¤å°†<code>status</code>çš„å€¼ä»<code>âŒ</code>è®¾ç½®å›<code>âœ…</code>ã€‚ç”±äºè¿™ä¸ªæ“ä½œæ˜¯åŸå­æ€§çš„ï¼Œå…¶ä»–å¤„ç†å™¨åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ— æ³•å¯¹<code>status</code>è¿›è¡Œä¿®æ”¹ã€‚</li>
<li>ä¸€æ—¦<code>status</code>è¢«è®¾ç½®ä¸º<code>âœ…</code>ï¼Œå…¶ä»–åœ¨<code>retry</code>å¾ªç¯ä¸­ç­‰å¾…çš„å¤„ç†å™¨å°±æœ‰æœºä¼šå†æ¬¡æ‰§è¡Œ<code>atomic_xchg(&amp;status, âŒ)</code>ï¼Œå¹¶æœ‰å¯èƒ½æˆåŠŸè·å–èµ„æºé”ã€‚</li>
</ul>
</li>
</ol>
</li>
<li><strong>ä¸ºä»€ä¹ˆ<code>atomic_xchg</code>èƒ½å®ç°äº’æ–¥</strong><ol>
<li><strong>åŸå­æ€§ä¿è¯</strong><ul>
<li><code>atomic_xchg</code>çš„åŸå­æ€§ç¡®ä¿äº†åœ¨è¯»å–å’Œå†™å…¥<code>status</code>çš„è¿‡ç¨‹ä¸­ï¼Œä¸ä¼šå‡ºç°ç«æ€æ¡ä»¶ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ä¼šå‡ºç°ä¸€ä¸ªå¤„ç†å™¨è¯»å–äº†<code>status</code>çš„æ—§å€¼ï¼Œä½†åœ¨å†™å…¥æ–°å€¼ä¹‹å‰ï¼Œå¦ä¸€ä¸ªå¤„ç†å™¨ä¿®æ”¹äº†<code>status</code>çš„æƒ…å†µã€‚</li>
<li>è¿™ç§åŸå­æ€§æ“ä½œä½¿å¾—<code>status</code>çš„å€¼å§‹ç»ˆèƒ½å¤Ÿå‡†ç¡®åæ˜ èµ„æºçš„å ç”¨çŠ¶æ€ã€‚å½“<code>status</code>ä¸º<code>âœ…</code>æ—¶ï¼Œè¡¨ç¤ºèµ„æºç©ºé—²ï¼›å½“<code>status</code>ä¸º<code>âŒ</code>æ—¶ï¼Œè¡¨ç¤ºèµ„æºè¢«å ç”¨ã€‚</li>
</ul>
</li>
<li><strong>äº’æ–¥çš„å®ç°</strong><ul>
<li>é€šè¿‡<code>atomic_xchg</code>æŒ‡ä»¤ï¼Œæ¯ä¸ªå¤„ç†å™¨åœ¨å°è¯•è·å–èµ„æºæ—¶ï¼Œéƒ½èƒ½å‡†ç¡®åœ°è¯»å–åˆ°<code>status</code>çš„å½“å‰å€¼ï¼Œå¹¶ä¸”åœ¨è®¾ç½®æ–°å€¼æ—¶ä¸ä¼šè¢«å…¶ä»–å¤„ç†å™¨å¹²æ‰°ã€‚</li>
<li>å½“ä¸€ä¸ªå¤„ç†å™¨æˆåŠŸå°†<code>status</code>è®¾ç½®ä¸º<code>âŒ</code>æ—¶ï¼Œå…¶ä»–å¤„ç†å™¨åœ¨è¯»å–<code>status</code>æ—¶ä¼šå¾—åˆ°<code>âŒ</code>ï¼Œä»è€Œè¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚åªæœ‰å½“æŒæœ‰èµ„æºçš„å¤„ç†å™¨å°†<code>status</code>è®¾ç½®å›<code>âœ…</code>åï¼Œå…¶ä»–å¤„ç†å™¨æ‰æœ‰æœºä¼šå†æ¬¡å°è¯•è·å–èµ„æºã€‚</li>
<li>è¿™ç§æœºåˆ¶ç¡®ä¿äº†åœ¨åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªå¤„ç†å™¨èƒ½å¤ŸæˆåŠŸè·å–èµ„æºé”ï¼Œä»è€Œå®ç°äº†äº’æ–¥ã€‚</li>
</ul>
</li>
</ol>
</li>
</ol>
<p>å†æ¥ç€ï¼Œå…·ä½“çœ‹çœ‹è‡ªæ—‹é”çš„ä¸€ä¸ªå®ç°ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">lock</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">expected</span><span class="p">;</span>
<span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Try compare status with expected.</span>
<span class="w">        </span><span class="c1">// If the comparison succeeded, perform</span>
<span class="w">        </span><span class="c1">// an exchange.</span>
<span class="w">        </span><span class="n">expected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UNLOCKED</span><span class="p">;</span>
<span class="w">        </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="p">(</span>
<span class="w">            </span><span class="s">&quot;lock cmpxchgl %2, %1&quot;</span>
<span class="w">            </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;+a&quot;</span><span class="w"> </span><span class="p">(</span><span class="n">expected</span><span class="p">)</span><span class="w"> </span><span class="c1">// Value for comparison.</span>
<span class="w">                              </span><span class="c1">// x86 uses eax/rax.</span>
<span class="w">            </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;m&quot;</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="p">),</span><span class="w">   </span><span class="c1">// Memory location.</span>
<span class="w">              </span><span class="s">&quot;r&quot;</span><span class="w"> </span><span class="p">(</span><span class="n">LOCKED</span><span class="p">)</span><span class="w">    </span><span class="c1">// Value to be written if</span>
<span class="w">                              </span><span class="c1">// status == expected</span>
<span class="w">            </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;memory&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cc&quot;</span><span class="w">                                                                                              </span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">expected</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">UNLOCKED</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">unlock</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// To be safer:</span>
<span class="w">    </span><span class="c1">//</span>
<span class="w">    </span><span class="c1">// asm volatile (</span>
<span class="w">    </span><span class="c1">//     &quot;movl %1, %0&quot;</span>
<span class="w">    </span><span class="c1">//     : &quot;=m&quot; (status)</span>
<span class="w">    </span><span class="c1">//     : &quot;r&quot; (UNLOCKED)</span>
<span class="w">    </span><span class="c1">//     : &quot;memory&quot;</span>
<span class="w">    </span><span class="c1">// );</span>

<span class="w">    </span><span class="c1">// But actually we can do this:</span>
<span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="o">:::</span><span class="w"> </span><span class="s">&quot;memory&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UNLOCKED</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>åŸå­çš„ load-store å¯ä»¥å¸®åŠ©æˆ‘ä»¬å®ç°ï¼š</p>
<ol>
<li>å–å‡ºå†…å­˜ä¸­çš„æ•°å€¼</li>
<li>å†™å…¥ä¸€ä¸ªæ•°å€¼ï¼Œå¹¶ä¸”æŒ‡ä»¤çš„æ‰§è¡Œåœ¨å¤šå¤„ç†å™¨ç³»ç»Ÿä¸Šä¾æ—§å¸¦æœ‰ â€œstop-the-worldâ€ çš„æ•ˆæœã€‚</li>
</ol>
<p>å› æ­¤ï¼Œæ— è®ºæœ‰å¤šå°‘çº¿ç¨‹åŒæ—¶æ‰§è¡Œ <code>lock()</code>ï¼Œä»…æœ‰ä¸€ä¸ªèƒ½è·å¾— <code>UNLOCKED</code> çš„æ•°å€¼ï¼Œä»è€Œå®ç°äº’æ–¥ã€‚</p>
<p>ç»ˆäºï¼Œæˆ‘ä»¬å€ŸåŠ©<strong>è®¡ç®—æœºç¡¬ä»¶æä¾›çš„çŸ­æ—¶åŸå­æ€§</strong>å®ç°äº†å¤šå¤„ç†å™¨é—´çš„äº’æ–¥ã€‚</p>
<blockquote>
<p>è¿™ç§æ¡ä»¶å†™å…¥ï¼Œæˆ‘åœ¨åš PA çš„æ—¶å€™ä¹Ÿç”¨åˆ°è¿‡ï¼Œåœ¨å®ç°ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ—¶å€™ï¼Œç”¨çš„ RISC-V çš„ <code>csrrw sp, mscratch, sp</code>ï¼Œè¿™ç±»æŒ‡ä»¤å„å®¶ ISA éƒ½æœ‰ï¼Ÿç»éªŒï¼Ÿè¿˜æ˜¯ï¼Ÿ</p>
<blockquote>
<p>å“¦ï¼æˆ‘é‚£ä¸ªæ—¶å€™çš„ä¸Šä¸‹æ–‡åˆ‡æ¢é—®é¢˜åº”è¯¥è¦å…³ä¸­æ–­å‘€ï¼è¿™æ ·ä¼šå¸¦æ¥å¹¶å‘é—®é¢˜çš„ï¼å¦‚æœæœºç¼˜å·§åˆä¸‹ä¸­æ–­å‘ç”Ÿåœ¨äº†è¿™ä¸ªæŒ‡ä»¤ï¼Œè€Œæˆ‘çš„æ¨¡æ‹Ÿå™¨åˆæ²¡æœ‰çœŸæ­£åœ°å®ç°åŸå­çš„äº¤æ¢ï¼Œé‚£æ ·å°±ä¼šå‡ºé—®é¢˜ï¼Ÿ</p>
<p>ä¸å¯¹ï¼Œåœ¨è¿›å…¥è¿™ä¸ªå¼‚å¸¸å¤„ç†çš„ç¨‹åºä¹‹å‰ï¼Œæˆ‘å°±å·²ç»å…³ä¸­æ–­äº†ï¼Œæˆ‘è¿˜åªæ˜¯å•æ ¸çš„å¤„ç†å™¨ã€‚</p>
</blockquote>
<p>æœ‰ â€œå¸¦æ¡ä»¶å†™å…¥â€ çš„ç‰ˆæœ¬ï¼šèŠ‚çº¦å†™å…¥å†…å­˜å¸¦å®½</p>
<p>Test-And-Set (TAS), Compare-And-Swap (CAS), COMPXCHG (Compare-And-Exchange)</p>
</blockquote>
<h2 id="2">å¹¶å‘æ§åˆ¶ï¼šäº’æ–¥ï¼ˆ2ï¼‰</h2>
<h3 id="_4">ç°å®è¦æ±‚ä½†æœ‰äººä¸éµå®ˆ</h3>
<p>ç†æƒ³çš„å®ç°ä»¥åŠæ•ˆæœã€‚</p>
<p><img alt="image-20250109120936754" src="pic/image-20250109120936754.png" /></p>
<p>éƒ½å¾—éµå¾ªè¿™ä¸ªè§„åˆ™ã€‚å¦‚æœæ²¡æœ‰ï¼Ÿå¿˜è®°åŠ é”ã€ä¸Šçš„ä¸æ˜¯åŒä¸€æŠŠé”ã€‚</p>
<p><img alt="image-20250109120904253" src="pic/image-20250109120904253.png" /></p>
<h3 id="_5">æ“ä½œç³»ç»Ÿå†…æ ¸ä¸­çš„è‡ªæ—‹é”</h3>
<blockquote>
<p>ä¹‹å‰è¯¾ä¸Šçš„ä¾‹å­æ˜¯åœ¨åº”ç”¨ç¨‹åºä¸Šçš„å®ç°äº’æ–¥ï¼Œå› ä¸ºåº”ç”¨ç¨‹åºä¸èƒ½å…³ä¸­æ–­ã€‚</p>
<p>ä½†åˆ«å¿˜äº†ï¼Œæ“ä½œç³»ç»Ÿæ‰æ˜¯ç¬¬ä¸€ä¸ªå¹¶å‘ç¨‹åºï¼Œæˆ‘ä»¬éœ€è¦è§£å†³å†…æ ¸ä¸­æ€ä¹ˆåšåˆ°äº’æ–¥ä»¥å®ç°æ­£ç¡®çš„å¹¶å‘ï¼Œ</p>
<p>åªæœ‰æ“ä½œç³»ç»Ÿä¸ºå®é™…è®¡ç®—ä¸­çš„å¹¶å‘æ‰“ä¸‹åŸºç¡€ï¼Œåº”ç”¨ç¨‹åºæ‰èƒ½ç›´åˆ°å¦‚ä½•ç®¡ç†å¤šä¸ªçº¿ç¨‹å’Œè¿›ç¨‹ã€‚</p>
</blockquote>
<p>ä½†æˆ‘è¿˜å¯ä»¥æ¥ç€ä¹‹å‰åº”ç”¨ç¨‹åºçš„å†…å®¹æ¥å®ç°å†…æ ¸ç›¸å…³çš„å†…å®¹ã€‚æœ‰äº†lockï¼Œé‚£å°±èƒ½ä¿è¯äº’æ–¥ï¼Ÿå¯¹äºå†…æ ¸æ¥è¯´ï¼Ÿå›æƒ³è®¡ç®—æœºçŠ¶æ€æœºçš„æ¨¡å‹ï¼š</p>
<p><img alt="image-20250109122200699" src="pic/image-20250109122200699.png" /></p>
<p><strong>èƒ½æ”¹å˜å½“å‰è®¡ç®—æœºçš„çŠ¶æ€çš„ï¼Œè¿˜æœ‰ä¸­æ–­ã€‚</strong></p>
<blockquote>
<ul>
<li>æ“ä½œç³»ç»Ÿæ¥ç®¡äº†å®Œæ•´çš„è®¡ç®—æœºç³»ç»Ÿ<ul>
<li>æ¯ä¸ªå¤„ç†å™¨éƒ½å¹¶è¡Œ x++</li>
<li>æ¯ä¸ªå¤„ç†å™¨ä¸­æ–­å‘ç”Ÿæ—¶æ‰§è¡Œ x += 1000000000</li>
<li>(å‡æƒ³ x æ˜¯æ“ä½œç³»ç»Ÿä¸­çš„æ•°æ®ç»“æ„ï¼Œä¾‹å¦‚è¿›ç¨‹è¡¨)</li>
</ul>
</li>
<li>å¦‚ä½•æ­£ç¡®å®ç° x çš„åŸå­è®¿é—®ï¼Ÿ<ul>
<li>ä»…ä»…è‡ªæ—‹æ˜¯ä¸å¤Ÿçš„</li>
<li><strong><mark>å› ä¸ºè¿˜æœ‰ä¸­æ–­</mark></strong></li>
</ul>
</li>
</ul>
</blockquote>
<p>lock() -&gt; sum++ -&gt; ä¸­æ–­æ¥äº† -&gt; (æœ‰ä¸´ç•ŒåŒºï¼Œä¸­æ–­ä¹Ÿæƒ³å¯¹sum++) -&gt; (ä½†æ˜¯ä¹‹å‰å·²ç»lockè¿‡ï¼Œæ‰€ä»¥å°±æ­»åœ¨è¿™é‡Œäº†ï¼deadlock)</p>
<blockquote>
<p>ä¸­æ–­çš„å‘æ˜ï¼Œç”±äº IO æ¯” CPU æ…¢å¾ˆå¤šï¼ŒIO åšå®Œäº†å†å‘Šè¯‰ CPU æ¥å¤„ç†æˆ‘ç›¸å…³çš„ï¼Œå®ƒä»¬æ˜¯å¼‚æ­¥çš„ã€‚</p>
</blockquote>
<p>é‚£æ€ä¹ˆåšï¼Ÿä¹‹å‰è¿˜æ²¡å®ç°åŸå­æ€§çš„æ—¶å€™ï¼Œå•æ ¸æ€ä¹ˆåšçš„äº’æ–¥ï¼šå…³ä¸­æ–­ï¼ŒåŠ åˆ°è¿™é‡Œæ¥ã€‚</p>
<p>é‚£ä¹Ÿè‡ªç„¶å¸¦æ¥ä¸€ä¸ªé—®é¢˜ï¼šæ˜¯åœ¨lockå‰å…³ä¸­æ–­è¿˜æ˜¯lockåå…³ä¸­æ–­ï¼Ÿ</p>
<p>è‡ªç„¶æ˜¯åœ¨ lock å‰å…³ä¸­æ–­ï¼Œå¦‚æœæ˜¯åœ¨lockåï¼Œé‚£åœ¨é‚£ä¸€ç¬é—´è¿˜æ˜¯ä¼šæ¥ä¸­æ–­ï¼Œä¾ç„¶ä¼šé€ æˆdeadlockã€‚</p>
<blockquote>
<p>Thread A åœ¨å†…æ ¸æ€è¿è¡Œä¸” acquire é”lock1æ—¶ï¼Œè§¦å‘ä¸­æ–­è¿›å…¥ä¸­æ–­å¤„ç†ç¨‹åºï¼Œä¸­æ–­å¤„ç†ç¨‹åºä¹Ÿåœ¨å†…æ ¸æ€ä¸­è¯·æ±‚é”lock1ï¼Œç”±äºé”lock1åœ¨ Thread A æ‰‹ä¸Šï¼Œä¸”åªæœ‰ Thread A æ‰§è¡Œæ—¶æ‰èƒ½release é”lock1ï¼Œå› æ­¤ä¸­æ–­å¤„ç†ç¨‹åºå¿…é¡»è¿”å›ï¼Œé”æ‰èƒ½è¢«é‡Šæ”¾ã€‚é‚£ä¹ˆæ­¤æ—¶ä¸­æ–­å¤„ç†ç¨‹åºä¼šæ°¸è¿œæ‹¿ä¸åˆ°é”ï¼Œé™·å…¥æ— é™å¾ªç¯ï¼Œè¿›å…¥æ­»é”ã€‚</p>
<div class="highlight"><pre><span></span><code>Thread A: è·å–é”  ------------------&gt; å…³ä¸­æ–­
                      |
                      |-----&gt; ISR: å°è¯•è·å–åŒä¸€ä¸ªé” --&gt; ä¸€ç›´è‡ªæ—‹ deadlock
</code></pre></div>
</blockquote>
<p>æ­£ç¡®çš„ä¸ºï¼š<code>disable irq</code> -&gt; <code>lock</code> -&gt; <code>sum++</code> -&gt;<code>enable irq</code></p>
<p>ä½†è¿˜æœ‰é—®é¢˜ï¼Œlockå‰å…³äº†ä¸­æ–­ï¼Œä½†åˆ°æœ€åçš„æ—¶å€™ï¼Œå˜æˆäº†å¼€ä¸­æ–­ã€‚ä½†å¦‚æœåœ¨ <code>disable irq</code> ä¹‹å‰çš„ CPU çŠ¶æ€å°±æ˜¯ å…³ä¸­æ–­å‘¢ï¼Ÿæ‰€ä»¥ï¼Œéœ€è¦ä¿å­˜ä¸­æ–­çŠ¶æ€ï¼</p>
<blockquote>
<p>è¿™å°±æ˜¯æˆ‘åœ¨ NEMU ç§»æ¤ Linux çš„æ—¶å€™çœ‹çš„ Linux kernel çš„ <code>arch/risc-v</code> é‡Œçœ‹åˆ°çš„ <code>arch_local_save_flags</code> ï¼Ÿ</p>
<div class="highlight"><pre><span></span><code><span class="cp">#ifdef CONFIG_TRACE_IRQFLAGS_SUPPORT</span>
<span class="cp">#define irqs_disabled()                 \</span>
<span class="cp">    ({                      \</span>
<span class="cp">        unsigned long _flags;           \</span>
<span class="cp">        raw_local_save_flags(_flags);       \</span>
<span class="cp">        raw_irqs_disabled_flags(_flags);    \</span>
<span class="cp">    })</span>
<span class="cp">#else </span><span class="cm">/* !CONFIG_TRACE_IRQFLAGS_SUPPORT */</span>
<span class="cp">#define irqs_disabled() raw_irqs_disabled()                                                                               </span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_TRACE_IRQFLAGS_SUPPORT */</span>
<span class="c1">//include/linux/irqflags.h</span>

<span class="cp">#define raw_local_save_flags(flags)         \                                                                             </span>
<span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span><span class="w">                        </span>\
<span class="w">        </span><span class="n">typecheck</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span><span class="w">    </span>\
<span class="w">        </span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arch_local_save_flags</span><span class="p">();</span><span class="w">    </span>\
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="c1">// include/linux/irqflags.h</span>

<span class="cm">/* read interrupt enabled status */</span>
<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">arch_local_save_flags</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">csr_read</span><span class="p">(</span><span class="n">CSR_STATUS</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* unconditionally enable interrupts */</span>
<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">arch_local_irq_enable</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">csr_set</span><span class="p">(</span><span class="n">CSR_STATUS</span><span class="p">,</span><span class="w"> </span><span class="n">SR_IE</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// arch/riscv/include/asm/irqflags.h</span>
</code></pre></div>
</blockquote>
<p><img src="pic/image-20250109130549323.png" alt="image-20250109130549323" style="zoom:50%;" /></p>
<blockquote>
<p>æ— è®ºå®ç°ä»€ä¹ˆï¼Œå…ˆè®¤ä¸ºæ˜¯å¯¹çš„ï¼Œå…ˆå†™ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Ÿ</p>
<p>å®ç°ä¸€ä¸ªè‡ªæ—‹é”ï¼Œç›¸æ¯”å®ç°ä¸€ä¸ªè‡ªæ—‹é”çš„test driver ä¸é‚£ä¹ˆé‡è¦ã€‚ï¼Ÿï¼Ÿ</p>
</blockquote>
<p>å…³äº è€å¸ˆçš„ç§»æ¤å®ç°åˆ†æï¼Œè§ï¼š[L1] <mark><strong>TODO</strong></mark></p>
<h3 id="72-read-copy-update">7.2 æ“ä½œç³»ç»Ÿå†…æ ¸ä¸­çš„ (åŠ) æ— é”äº’æ–¥ï¼šRead-Copy-Update ğŸŒ¶ï¸</h3>
<p><strong>åœ¨çœŸæ­£çš„æ“ä½œç³»ç»Ÿä¸­å®ç°äº’æ–¥ï¼Œå…¶å®æ²¡æœ‰é‚£ä¹ˆç®€å•ã€‚</strong></p>
<blockquote>
<p>è¦çœŸæ­£åœ¨æ“ä½œç³»ç»Ÿå†…æ ¸ä¸­ç”¨èµ·æ¥ï¼Œè¿˜è¦è€ƒè™‘å¾ˆå¤šã€‚</p>
<p>Scalability(ä¼¸ç¼©æ€§ã€å»¶å±•æ€§...): æ€§èƒ½çš„æ–°ç»´åº¦</p>
<ul>
<li>ä¸¥è°¨çš„ç»Ÿè®¡å¾ˆéš¾<ul>
<li>CPU åŠ¨æ€åŠŸè€—</li>
<li>ç³»ç»Ÿä¸­çš„å…¶ä»–è¿›ç¨‹</li>
<li>è¶…çº¿ç¨‹</li>
<li>NUMA</li>
<li>â€¦â€¦</li>
</ul>
</li>
</ul>
<p><a href="https://gernot-heiser.org/benchmarking-crimes.html">Benchmarking crimes</a> by Gernot Heiser</p>
</blockquote>
<p>å‡å¦‚é‡‡ç”¨ä¸Šé¢çš„é‚£ç§æ–¹æ¡ˆå®ç°äº’æ–¥ï¼šè‡ªæ—‹ + å…³ä¸­æ–­ã€‚</p>
<p>é¦–å…ˆï¼Œè‡ªæ—‹é”çš„ç¼ºç‚¹ï¼Œscalability éå¸¸å·®ï¼Œæ¯æ¬¡éœ€è¦å¹¶å‘æ§åˆ¶çš„æ—¶å€™ï¼Œå†…æ ¸å°±å¡åœ¨é‚£é‡Œä¸åŠ¨ï¼Œå¦‚æœæ—¶é—´å¾ˆé•¿ï¼Œæå¤§åœ°æµªè´¹äº†ç¡¬ä»¶èµ„æºã€‚</p>
<p>å†è€…ï¼Œå…³ä¸­æ–­åŒæ ·ä¹Ÿä¸èƒ½å…³å¤ªé•¿ï¼Œå…³ 1 ç§’çš„ä¸­æ–­ï¼Œå°±å¿½ç•¥äº†å¾ˆå¤šçš„æ—¶é’Ÿä¸­æ–­ï¼ˆå°±å‡å¦‚10msæ¥ä¸€ä¸ªï¼Œ100ä¸ªï¼‰ï¼Œåœ¨è¿™äº›æ—¶é’Ÿä¸­æ–­ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸ä¼šåˆ‡æ¢åˆ°åˆ«çš„çº¿ç¨‹ï¼Œé‚£è¿™æ ·å¾ˆå¤šçº¿ç¨‹/ä»»åŠ¡è€—è´¹çš„æ—¶é—´å¾ˆé•¿ï¼Œæå¤§å½±å“æ€§èƒ½ã€‚</p>
<p>ç»¼ä¸Šï¼Œåœ¨å†…æ ¸ä¸­ï¼Œä¸Šé¢è¿™ç§æ–¹æ¡ˆå°¤å…¶è‡ªæ—‹é”ï¼Œåªèƒ½ç”¨åœ¨å¾ˆçŸ­çš„ä¸´ç•ŒåŒºï¼ˆæ¯”å¦‚å¹¶å‘çš„æ•°æ®ç»“æ„ï¼Œå¾€ä¸€ä¸ªé“¾è¡¨é‡Œæ·»åŠ ä¸€ä¸ªå…ƒç´ ã€æŒ‰é”®æŒ‰ä¸‹é”®ç æ”¾é˜Ÿåˆ—ï¼‰ï¼Œä¸´ç•Œå‡ ä¹ä¸æ‹¥å µï¼Œè¦è¿…é€Ÿç»“æŸã€‚</p>
<p><img alt="image-20250109213447063" src="pic/image-20250109213447063.png" /></p>
<blockquote>
<ul>
<li>
<p>Kernel é‡Œæœ‰ ~180K ä¸ªå¹¶å‘æ§åˆ¶å‡½æ•°è°ƒç”¨ï¼</p>
<p>è‡ªæ—‹é”å½“ç„¶ä¸ scale</p>
<p><a href="https://www.usenix.org/conference/osdi10/analysis-linux-scalability-many-cores">An Analysis of Linux Scalability to Many Cores | USENIX</a></p>
</li>
</ul>
</blockquote>
<p>æ€ä¹ˆåŠï¼Ÿ</p>
<blockquote>
<ul>
<li>è®¸å¤šæ“ä½œç³»ç»Ÿå†…æ ¸å¯¹è±¡å…·æœ‰ â€œ<strong>read-mostly</strong>â€ ç‰¹ç‚¹<ul>
<li>è·¯ç”±è¡¨<ul>
<li>æ¯ä¸ªæ•°æ®åŒ…éƒ½è¦è¯»</li>
<li>ç½‘ç»œæ‹“æ‰‘æ”¹å˜æ—¶æ‰å˜æ›´</li>
</ul>
</li>
<li>ç”¨æˆ·å’Œç»„ä¿¡æ¯<ul>
<li>æ— æ—¶ä¸åˆ»åœ¨æ£€æŸ¥ (Permission Denied)</li>
<li>ä½†å‡ ä¹ä»ä¸ä¿®æ”¹ç”¨æˆ·</li>
</ul>
</li>
</ul>
</li>
</ul>
</blockquote>
<p>è¯»å†™ä¸å¯¹ç§°æ€§</p>
<p>å†™æ—¶å¤åˆ¶</p>
<p>å¤šç‰ˆæœ¬</p>
<p>è¯» ä¸ä¸Šé”ï¼Œå†™ ä¸Šé”</p>
<h3 id="_6">åº”ç”¨ç¨‹åºä¸­çš„äº’æ–¥</h3>
<p>ç°åœ¨è€ƒè™‘åœ¨å¤šæ ¸çš„åº”ç”¨ç¨‹åºä¸­ï¼Œè‡ªæ—‹å¸¦æ¥çš„æ€§èƒ½é—®é¢˜</p>
<ul>
<li>
<p>æ€§èƒ½é—®é¢˜ (1)</p>
<p>é™¤äº†è¿›å…¥ä¸´ç•ŒåŒºçš„çº¿ç¨‹ï¼Œå…¶ä»–å¤„ç†å™¨ä¸Šçš„çº¿ç¨‹éƒ½åœ¨<strong>ç©ºè½¬</strong></p>
<ul>
<li>äº‰æŠ¢é”çš„å¤„ç†å™¨è¶Šå¤šï¼Œåˆ©ç”¨ç‡è¶Šä½</li>
<li>å¦‚æœä¸´ç•ŒåŒºè¾ƒé•¿ï¼Œä¸å¦‚æŠŠå¤„ç†å™¨è®©ç»™å…¶ä»–çº¿ç¨‹</li>
</ul>
</li>
<li>
<p>æ€§èƒ½é—®é¢˜ (2)</p>
<p>åº”ç”¨ç¨‹åºä¸èƒ½å…³ä¸­æ–­â€¦â€¦</p>
<ul>
<li>æŒæœ‰è‡ªæ—‹é”çš„çº¿ç¨‹è¢«åˆ‡æ¢</li>
<li>å¯¼è‡´ 100% çš„èµ„æºæµªè´¹</li>
<li>(å¦‚æœåº”ç”¨ç¨‹åºèƒ½ â€œå‘Šè¯‰â€ æ“ä½œç³»ç»Ÿå°±å¥½äº†)</li>
</ul>
</li>
</ul>
<p>æƒ³æƒ³ï¼Œå¦‚æœåœ¨64æ ¸çš„64ä¸ªçº¿ç¨‹å¯¹ä¸€ä¸ªèµ„æºè¿›è¡ŒæŠ¢å ï¼Œæœ‰ä¸€ä¸ªæŠ¢åˆ°äº†ï¼Œé‚£å‰©ä¸‹çš„ 63 ä¸ªæ€ä¹ˆåšï¼Ÿç©ºè½¬ï¼Ÿä¸€ç›´æµªè´¹å•Šï¼</p>
<p>æ²¡æ³•è¿›å…¥ä¸´ç•ŒåŒºè¿›è¡Œè®¡ç®—ï¼Œé‚£æœ€è‡ªç„¶çš„æƒ³æ³•æ˜¯ä»€ä¹ˆï¼Ÿæ—¢ç„¶ä¸€ç›´åœ¨è¿™ç­‰ç€ä¸è¡Œï¼Œé‚£å°±ä¸ç­‰äº†ï¼Ÿå»åšæœ‰æ„ä¹‰çš„è®¡ç®—ï¼Ÿ</p>
<p>å›æƒ³è®¡ç®—æœºçŠ¶æ€æœºæ¨¡å‹ï¼Œå¦‚æœçŠ¶æ€ä¸€ç›´å¡åœ¨è¿™é‡Œï¼Œæ€ä¹ˆåŠï¼Ÿè¿˜æ˜¯åº”ç”¨ç¨‹åºï¼Ÿåªèƒ½ <code>syscall</code>ã€‚ï¼ˆä¹Ÿå°±æ˜¯äº’æ–¥é”ï¼‰</p>
<p>æŠŠè¿™ç§é”æ”¾åˆ° kernel å®ç°å°±å¥½å•¦ï¼Œå› ä¸º kernel æœ‰èƒ½åŠ›åšä¸Šä¸‹æ–‡åˆ‡æ¢å‘€ï¼Œèƒ½åˆ‡æ¢åˆ«çš„çº¿ç¨‹ã€‚</p>
<p><img alt="image-20250109220653328" src="pic/image-20250109220653328.png" /></p>
<blockquote>
<p>è¿™ä¸ª OJ ä¾‹å­è¿˜æ˜¯æŒºå½¢è±¡çš„å“ˆå“ˆï¼Œåˆæ¯”å¦‚ç­‰æˆç»©çš„æ—¶å€™ï¼Œåˆ«ç­‰äº†ï¼Œæœ¬æ¥å°±å•¥ä¹Ÿå¹²ä¸äº†ï¼Œå»åšåˆ«çš„ã€‚</p>
<p>æƒ³åˆ°ä¹‹å‰å­¦ä¹  <code>FreeRTOS</code> çš„äº’æ–¥é”äº†ï¼Œæ—¢ç„¶ç­‰ä¸åˆ°ï¼Œé‚£å°±ç”¨ <code>mutex_acquire</code> æ”¾å¼ƒè¿™ä¸ªä»»åŠ¡ï¼Œå»åšåˆ«çš„çº¿ç¨‹çš„ä»»åŠ¡å§ã€‚æœ‰ç‚¹ç±»ä¼¼ã€‚</p>
</blockquote>
<p>æ¨¡å‹ï¼š</p>
<p><img src="pic/image-20250109221906985.png" alt="image-20250109221906985" style="zoom: 67%;" /></p>
<p>æˆ‘è§‰å¾—è¿™ä¸ªå›¾å·²ç»å½¢è±¡åœ°æè¿°äº†ã€‚</p>
<p>æ‰€ä»¥ä¸€å¥—é…å¥—æ“ä½œï¼Œå’Œè‡ªæ—‹é”çš„éƒ½æŒºç±»ä¼¼</p>
<div class="highlight"><pre><span></span><code><span class="n">mutex_lock</span><span class="p">()</span><span class="w">    </span><span class="c1">// acquire</span>
<span class="n">mutex_unlock</span><span class="p">()</span><span class="w">  </span><span class="c1">// release</span>
</code></pre></div>
<h4 id="pthread-mutex-lock"><code>pthread Mutex Lock</code></h4>
<blockquote>
<ul>
<li>
<p>ä¸€ä¸ªè¶³å¤Ÿé«˜æ€§èƒ½çš„å®ç°</p>
<ul>
<li>å…·æœ‰ç›¸å½“ä¸é”™çš„ scalability</li>
<li>æ›´å¤šçº¿ç¨‹äº‰æŠ¢æ—¶ä¹Ÿæ²¡æœ‰æä¸ºæ˜¾è‘—çš„æ€§èƒ½ä¸‹é™</li>
</ul>
</li>
<li>
<p>ä½¿ç”¨æ–¹æ³•ï¼šä¸è‡ªæ—‹é”å®Œå…¨ä¸€è‡´</p>
<div class="highlight"><pre><span></span><code><span class="n">pthread_mutex_t</span><span class="w"> </span><span class="n">lock</span><span class="p">;</span><span class="w"> </span>
<span class="n">pthread_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"> </span>
<span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span><span class="w"> </span>
<span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span><span class="w"> </span>
</code></pre></div>
</li>
</ul>
</blockquote>
<h4 id="futex-fast-userspace-mutexes">Futex: Fast Userspace muTexes ğŸŒ¶ï¸</h4>
<blockquote>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬ä¸Šé”å’Œè§£é”åˆä¼šæœ‰ <code>syscall</code>ï¼Œè€Œè¿™ä¸ªä¸ä¼šï¼Œè¿™ç§æ–¹æ³•ä¼šæŠŠå°½å¯èƒ½å¤šçš„è¿ç®—æ”¾åˆ°ç”¨æˆ·ç©ºé—´</p>
</blockquote>
<ul>
<li>
<p>å°å­©å­æ‰åšé€‰æ‹©ã€‚æ“ä½œç³»ç»Ÿå½“ç„¶æ˜¯å…¨éƒ½è¦å•¦ï¼</p>
<ul>
<li>
<p><strong>æ€§èƒ½ä¼˜åŒ–çš„æœ€å¸¸è§æŠ€å·§ï¼š</strong></p>
<p><strong>è€ƒè™‘å¹³å‡è€Œä¸æ˜¯æç«¯æƒ…å†µ</strong></p>
<ul>
<li><strong>RCU å°±ç”¨äº†è¿™ä¸ªæ€æƒ³ï¼</strong></li>
</ul>
</li>
</ul>
</li>
<li>
<p>Fast Path: è‡ªæ—‹ä¸€æ¬¡</p>
<ul>
<li>ä¸€æ¡åŸå­æŒ‡ä»¤ï¼ŒæˆåŠŸç›´æ¥è¿›å…¥ä¸´ç•ŒåŒº</li>
</ul>
</li>
<li>
<p>Slow Path: è‡ªæ—‹å¤±è´¥</p>
<ul>
<li>è¯·æ±‚ç³»ç»Ÿè°ƒç”¨ <code>futex_wait</code></li>
<li>è¯·æ“ä½œç³»ç»Ÿå¸®æˆ‘è¾¾åˆ°è‡ªæ—‹çš„æ•ˆæœ<ul>
<li>(å®é™…ä¸Šå¹¶ä¸çœŸçš„è‡ªæ—‹)</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>æ€ä¹ˆå®ç°ï¼Ÿ</p>
<blockquote>
<ul>
<li>æ¯”ä½ æƒ³è±¡çš„å¤æ‚</li>
<li>
<p>å¦‚æœæ²¡æœ‰é”çš„äº‰æŠ¢ï¼ŒFast Path ä¸èƒ½è°ƒç”¨ <code>futex_wake</code></p>
<ul>
<li>è‡ªæ—‹å¤±è´¥ â†’ è°ƒç”¨ <code>futex_wait</code>â†’ çº¿ç¨‹ç¡çœ </li>
<li>
<p>å¦‚æœåˆšå¼€å§‹ç³»ç»Ÿè°ƒç”¨ï¼Œè‡ªæ—‹é”è¢«ç«‹å³é‡Šæ”¾ï¼Ÿ</p>
<ul>
<li>å¦‚æœä»»ä½•æ—¶å€™éƒ½å¯èƒ½å‘ç”Ÿä¸­æ–­ï¼Ÿ</li>
</ul>
</li>
<li>
<p>å¹¶å‘ï¼šæ°´é¢ä¸‹çš„å†°å±±</p>
</li>
<li><a href="https://lwn.net/Articles/360699/">LWN: A futex overview and update</a></li>
<li><a href="https://cis.temple.edu/~giorgio/cis307/readings/futex.pdf">Futexes are tricky</a> by Ulrich Drepper</li>
</ul>
</li>
</ul>
</blockquote>
<p>å…³é”®åœ¨äºç”¨ç³»ç»Ÿè°ƒç”¨æ¥å®ç°è¿™ä¸ªï¼Ÿ</p>
<p><strong><mark>TODOï¼šç•™å‘</mark></strong></p>
<h4 id="_7">å¯¹æ¯”ä¸‰ç§äº’æ–¥æ‰‹æ®µ</h4>
<p>å­¦ä¹ åˆ°äº†ï¼Œåœ¨ AI æ—¶ä»£ï¼Œä½¿ç”¨è‰¯å¥½çš„ prompt å­¦ä¼šç§‘å­¦åœ°æé—®ï¼Œæ€»èƒ½å¤§å¹…æé«˜ä½ çš„æ•ˆç‡ï¼Œä½†æˆ‘è®¤ä¸ºæˆ‘åº”è¯¥æ¸…æ¥šæˆ‘æ­£åœ¨åšä»€ä¹ˆï¼Œæˆ‘æœ‰ä»€ä¹ˆç›®çš„ï¼Œèƒ½å¦æ¸…æ™°åœ°æè¿°å‡ºæˆ‘çš„éœ€æ±‚ã€‚</p>
<p><img alt="image-20250109230621303" src="pic/image-20250109230621303.png" /></p>
<p>ç®€å•æ€»ç»“ï¼š</p>
<p>æˆ‘ç†è§£çš„æ˜¯äº’æ–¥æ˜¯æˆ‘ä»¬å®ç°çš„ç»ˆæç›®çš„ï¼Œè€Œé”æ˜¯ä¸€ç§æ¯”è¾ƒå¸¸ç”¨çš„æ‰‹æ®µã€‚
åœ¨å•æ ¸å¤„ç†å™¨ä¸­ã€‚æ— è®ºæ˜¯åº”ç”¨ç¨‹åºè¿˜æ˜¯æ“ä½œç³»ç»Ÿå†…æ ¸ã€‚ä»¥å…³ä¸­æ–­ä¸ºåŸºç¡€ï¼Œå®ç°è‡ªæ—‹é”ã€äº’æ–¥é”ç­‰é”ï¼Œå³å¯å®ç°äº’æ–¥ï¼›å¦‚æœè¿™ç§å•æ ¸å¤„ç†å™¨è¿˜æ”¯æŒåŸå­æ“ä½œï¼Œé‚£å°±å¯ä»¥ç”¨åŸå­æ“ä½œä¸ºåŸºç¡€ï¼Œå®ç°è‡ªæ—‹é”ã€äº’æ–¥é”ç­‰é”ï¼Œç”±æ­¤æ¥å®ç°äº’æ–¥ã€‚</p>
<blockquote>
<p>å¯¹äºåµŒå…¥å¼æ“ä½œç³»ç»Ÿæ¥è¯´ï¼Œåº”è¯¥æå‡ºä¸è‡ªæ—‹ä¼šæ›´åŠ è‡ªç„¶ç‚¹ï¼Œæ¯”å¦‚åœ¨å•æ ¸ä¸Šçš„ <code>FreeRTOS</code>ï¼Œé‡åˆ°æ•°æ®ç«äº‰ï¼ŒæŸä¸ªçº¿ç¨‹é‡åˆ°é”ï¼Œç¬¬ä¸€ååº”åº”è¯¥æ˜¯è®©è¿™ä¸ªçº¿ç¨‹ç¡çœ ï¼Ÿè¿™æ ·ç›¸å¯¹ä¸å½±å“æ€§èƒ½ï¼Ÿä¹Ÿå°±æ˜¯ä¸Šé¢é‚£ä¸ªåº”ç”¨ç¨‹åºçš„äº’æ–¥é”ã€‚</p>
</blockquote>
<p>åœ¨å¤šæ ¸å¤„ç†å™¨ä¸­ã€‚å¯¹äºåº”ç”¨ç¨‹åºï¼Œä»…ä»…é åŸå­æŒ‡ä»¤å³å¯å®ç°äº’æ–¥ï¼Œå› ä¸ºä¸å…è®¸å…³ä¸­æ–­ã€‚ä½†å¦‚æœæ˜¯æ“ä½œç³»ç»Ÿå†…æ ¸ï¼Œé‚£æœ‰åŸå­æŒ‡ä»¤è¿˜ä¸å¤Ÿï¼Œå› ä¸ºä¸­æ–­ä¹Ÿèƒ½å½±å“åˆ°ç¨‹åºçš„çŠ¶æ€è¿ç§»ï¼Œï¼ˆå›æƒ³ä¸Šé¢çš„ä¾‹å­ï¼Œï¼‰å› æ­¤è¿˜éœ€è¦å…³ä¸­æ–­ã€‚</p>
<blockquote>
<p>è¿™ä¸ªæ—¶å€™æ„Ÿè§‰ä¼šä¸ä¼šå†…å®¹ç¨å¾®å¤šäº†ç‚¹ï¼Ÿå¯ä»¥å°† OS è¯¾åˆ†æˆ OS å†…æ ¸å’Œ OS åº”ç”¨ä¸¤é—¨è¯¾ï¼Ÿ</p>
</blockquote>
<h2 id="_8">è°ƒè¯•ç†è®ºä¸å®è·µ</h2>
<blockquote>
<ul>
<li>
<p>å¹¶å‘ç¼–ç¨‹ï¼šä¸èƒ½ç›¸ä¿¡è‡ªå·±</p>
<ul>
<li>å¹¶å‘ bug çš„è§¦å‘éœ€è¦ï¼š<ul>
<li>ç¼–è¯‘å™¨ + ç¼–è¯‘é€‰é¡¹ + ç‰¹åˆ«çš„æœºå™¨ + ç‰¹åˆ«çš„è¿æ°”</li>
</ul>
</li>
<li>å†…å­˜æ¨¡å‹ï¼š<a href="https://github.com/seL4/seL4/pull/199">ä¸“å®¶ä¹Ÿåšä¸å¯¹</a></li>
<li>æµ‹è¯•å…¨å¯¹<ul>
<li>Online Judge è¢«æ‹’ç» </li>
</ul>
</li>
</ul>
</li>
<li>
<p>åˆå­¦è€…ï¼šå¦‚æœå¯ä»¥ï¼Œåªç”¨ â€œç»å¯¹æ­£ç¡®â€ çš„å®ç°</p>
<p>è‡ªå¸¦ä¸€åˆ‡ barrier çš„å‡½æ•°</p>
<ul>
<li><code>atomic_xchg</code></li>
<li><code>pthread_mutex_lock</code></li>
</ul>
</li>
</ul>
<p>æ­£å¥½çš„ä¾‹å­ï¼Œå¯¹æˆ‘ä»¬åˆå­¦è€…æ¥è¯´ï¼Œå°±ç”¨ä¸šç•Œæˆç†Ÿåšå¥½çš„åº“ã€‚</p>
</blockquote>
<h3 id="_9">å¬æ•…äº‹</h3>
<p>ç¡¬ä»¶bug <a href="https://faculty.lynchburg.edu/~nicely/pentbug/bugmail1.html">Original Pentium FDIV flaw e-mail</a></p>
<p>è½¯ä»¶bugã€‚</p>
<blockquote>
<p>â€œ...attempted to convert large, unexpected 64-bit floating point numbers representing horizontal velocity into 16-bit integers. This resulted in an overflow error, causing the onboard computer to crash.â€</p>
</blockquote>
<h3 id="_10">è°ƒè¯•ç†è®º</h3>
<blockquote>
<p>å¬è€å¸ˆå¥½å¥½è®²å°±è¡Œè¿™èŠ‚è¯¾ã€‚ä¸‹é¢éƒ½æ˜¯pptçš„å†…å®¹ã€‚</p>
</blockquote>
<p>ç¨‹åº/è½¯ä»¶æ˜¯äººç±»éœ€æ±‚åœ¨ä¿¡æ¯ä¸–ç•Œçš„æŠ•å½±ã€‚</p>
<ul>
<li>
<p>â€œè½¯ä»¶â€ çš„ä¸¤å±‚å«ä¹‰</p>
<ul>
<li>äººç±»éœ€æ±‚åœ¨ä¿¡æ¯ä¸–ç•Œçš„æŠ•å½±<ul>
<li>ç†è§£é”™éœ€æ±‚ â†’ bug</li>
</ul>
</li>
<li>è®¡ç®—è¿‡ç¨‹çš„ç²¾ç¡® (æ•°å­¦) æè¿°<ul>
<li>å®ç°é”™è¯¯ â†’ bug</li>
</ul>
</li>
</ul>
</li>
<li>
<p>è°ƒè¯•ä¸ºä»€ä¹ˆå›°éš¾ï¼Ÿ</p>
<ul>
<li>Bug çš„è§¦å‘ç»å†äº†æ¼«é•¿çš„è¿‡ç¨‹</li>
<li>å¯è§‚æµ‹çš„ç°è±¡æœªå¿…èƒ½ç›´æ¥å¯¹åº”åˆ° root cause ä¸Š</li>
</ul>
</li>
</ul>
<p><mark>éœ€æ±‚ â†’ è®¾è®¡ â†’ ä»£ç  (<strong>Fault/bug</strong>) â†’ æ‰§è¡Œ (<strong>Error</strong>) â†’ å¤±è´¥ (<strong>Failure</strong>)</mark></p>
<ul>
<li>æˆ‘ä»¬åªèƒ½è§‚æµ‹åˆ° failure (å¯è§‚æµ‹çš„ç»“æœé”™)ï¼Œä½†æ˜¯æˆ‘ä»¬çŠ¯é”™çš„æ˜¯ fault</li>
<li>æˆ‘ä»¬å¯ä»¥æ£€æŸ¥çŠ¶æ€çš„æ­£ç¡®æ€§ (ä½†éå¸¸è´¹æ—¶)</li>
<li>æ— æ³•é¢„çŸ¥ bug åœ¨å“ªé‡Œ (æ¯ä¸€è¡Œ â€œçœ‹èµ·æ¥â€ éƒ½æŒºå¯¹çš„)</li>
<li>äººæ€»æ˜¯ â€œé»˜è®¤â€ (ä¸é»˜è®¤ï¼Œæµªè´¹çš„æ—¶é—´å°±å¤ªå¤šäº†)</li>
</ul>
<blockquote>
<p><strong>è°ƒè¯•ç†è®ºï¼šå¦‚æœæˆ‘ä»¬èƒ½åˆ¤å®šä»»æ„ç¨‹åºçŠ¶æ€çš„æ­£ç¡®æ€§ï¼Œé‚£ä¹ˆç»™å®šä¸€ä¸ª failureï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡äºŒåˆ†æŸ¥æ‰¾å®šä½åˆ°ç¬¬ä¸€ä¸ª error çš„çŠ¶æ€ï¼Œæ­¤æ—¶çš„ä»£ç å°±æ˜¯ fault (bug)ã€‚</strong></p>
</blockquote>
<p>å…¶å®ä»å¾ˆä¹…ä¹‹å‰å°±å­¦ä¼šç”¨è¿™ç§æ€æƒ³äº†ã€‚åœ¨ç¨‹åºå‡ºé”™ä¹‹å‰åŠ ä¸€æ¡ logã€‚ä¸æ–­äºŒåˆ†ï¼Œæ€»èƒ½æ‰¾åˆ°bugã€‚ </p>
<p>è¿›ä¸€æ­¥æ¨è®º</p>
<ul>
<li>ä¸ºä»€ä¹ˆæˆ‘ä»¬å–œæ¬¢ â€œå•æ­¥è°ƒè¯•â€ï¼Ÿ<ul>
<li>ä»ä¸€ä¸ªå‡å®šæ­£ç¡®çš„çŠ¶æ€å‡ºå‘</li>
<li>æ¯ä¸ªè¯­å¥çš„è¡Œä¸ºæœ‰é™ï¼Œå®¹æ˜“åˆ¤å®šæ˜¯å¦æ˜¯ errorã€‚æˆ‘ä»¬å¯¹æ¯ä¸€æ¡è¯­å¥æ‰§è¡Œçš„åæœ/çŠ¶æ€è¿ç§»åº”è¯¥éƒ½æ˜¯æ˜ç™½çš„ã€‚</li>
<li>single step(step in)ã€step over(step out)</li>
</ul>
</li>
<li>ä¸ºä»€ä¹ˆè°ƒè¯•ç†è®ºçœ‹èµ·æ¥å¾ˆæ²¡ç”¨ï¼Ÿ<ul>
<li>â€œåˆ¤å®šçŠ¶æ€æ­£ç¡®â€ éå¸¸å›°éš¾</li>
<li>(æ˜¯å¦åœ¨è°ƒè¯• DP é¢˜/å›¾è®ºç®—æ³•æ—¶é™·å…¥æ—¶é—´é»‘æ´ï¼Ÿ)</li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>è§‚å¯ŸçŠ¶æ€æœºæ‰§è¡Œçš„ä¸¤ä¸ªåŸºæœ¬å·¥å…·</strong></p>
<ul>
<li>
<p><code>printf</code> â†’ è‡ªå®šä¹‰ log çš„ trace</p>
<ul>
<li>çµæ´»å¯æ§ã€èƒ½å¿«é€Ÿå®šä½é—®é¢˜å¤§æ¦‚ä½ç½®ã€é€‚ç”¨äºå¤§å‹è½¯ä»¶</li>
<li>æ— æ³•ç²¾ç¡®å®šä½ã€å¤§é‡çš„ logs ç®¡ç†èµ·æ¥æ¯”è¾ƒéº»çƒ¦</li>
</ul>
<p>è®© LLM å¸®æˆ‘ä»¬ <code>printf</code> è°ƒè¯•</p>
</li>
<li>
<p><code>gdb</code> â†’ æŒ‡ä»¤/è¯­å¥çº§ trace</p>
<ul>
<li>ç²¾ç¡®ã€æŒ‡ä»¤çº§ å®šä½ã€ä»»æ„<strong>æŸ¥çœ‹ç¨‹åºå†…éƒ¨çŠ¶æ€</strong></li>
<li>è€—è´¹å¤§é‡æ—¶é—´</li>
</ul>
</li>
</ul>
</blockquote>
<ul>
<li>
<p><strong>æ€»ç»“</strong></p>
<p>é‡åˆ° â€œä»»ä½•é—®é¢˜â€ æ—¶å€™ï¼Œå…ˆ self-checkï¼ˆé‡åˆ°é—®é¢˜å¿ƒé‡Œé»˜å¿µ/é—®è‡ªå·±ï¼‰ï¼š</p>
<ol>
<li>
<p>æ˜¯æ€æ ·çš„ç¨‹åº (çŠ¶æ€æœº) åœ¨è¿è¡Œï¼Ÿ</p>
<blockquote>
<p>èƒ½ä¸èƒ½å°†æ•´ä¸ªçŠ¶æ€æœºæ‰“å‡ºæ¥çœ‹ï¼Ÿå°±åƒ <code>make -nB</code> é‚£æ ·</p>
</blockquote>
</li>
<li>
<p>æˆ‘ä»¬é‡åˆ°äº†æ€æ ·çš„ failureï¼Ÿ</p>
</li>
<li>
<p>æˆ‘ä»¬èƒ½ä»çŠ¶æ€æœºçš„è¿è¡Œä¸­ä»æ˜“åˆ°éš¾å¾—åˆ°ä»€ä¹ˆä¿¡æ¯ï¼Ÿï¼ˆ<code>printf</code>ã€<code>gdb</code>....ï¼‰</p>
</li>
<li>
<p>å¦‚ä½•äºŒåˆ†æ£€æŸ¥è¿™äº›ä¿¡æ¯å’Œ error ä¹‹é—´çš„å…³è”ï¼Ÿ</p>
</li>
</ol>
</li>
</ul>
<h3 id="_11">è°ƒè¯•ä¸€åˆ‡</h3>
<h4 id="example0">example0</h4>
<p><strong>ä¸‡èƒ½æ–¹æ³•ï¼šå‡è®¾ä½ é‡åˆ°çš„é—®é¢˜æ˜¯åˆ«äººä¹Ÿé‡åˆ°çš„ï¼šStackOverflowã€GPTã€Google...</strong></p>
<div class="highlight"><pre><span></span><code>bash:<span class="w"> </span>curl:<span class="w"> </span><span class="nb">command</span><span class="w"> </span>not<span class="w"> </span>found<span class="w"> </span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>fatal<span class="w"> </span>error:<span class="w"> </span><span class="s1">&#39;sys/cdefs.h&#39;</span>:<span class="w"> </span>No<span class="w"> </span>such<span class="w"> </span>file<span class="w"> </span>or<span class="w"> </span>directory<span class="w"> </span><span class="c1">#include &lt;sys/cdefs.h&gt; </span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>/usr/bin/ld:<span class="w"> </span>cannot<span class="w"> </span>find<span class="w"> </span>-lgcc:<span class="w"> </span>No<span class="w"> </span>such<span class="w"> </span>file<span class="w"> </span>or<span class="w"> </span>directory<span class="w"> </span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>make<span class="o">[</span><span class="m">2</span><span class="o">]</span>:<span class="w"> </span>***<span class="w"> </span>run:<span class="w"> </span>No<span class="w"> </span>such<span class="w"> </span>file<span class="w"> </span>or<span class="w"> </span>directory.<span class="w">  </span>Stop.<span class="w"> </span>Makefile:31:<span class="w"> </span>recipe<span class="w"> </span><span class="k">for</span><span class="w"> </span>target<span class="w"> </span><span class="s1">&#39;run&#39;</span><span class="w"> </span>failed<span class="w"> </span>
</code></pre></div>
<ul>
<li>
<p>ä½†å¦‚æœè¿™æ˜¯ä¸€ä¸ªå…¨æ–°çš„é—®é¢˜ï¼Ÿæˆ–è€…è¯´ç¬¬ä¸€ä¸ªè§£å†³ä¸Šè¿°é—®é¢˜å¹¶åˆ†äº«åˆ°ç½‘ä¸Šçš„äººæ˜¯æ€ä¹ˆåšçš„ï¼Ÿåˆ«äººæ˜¯æ€ä¹ˆæƒ³çš„ï¼Ÿ</p>
<p>ä¸€åˆ‡éƒ½æ˜¯çŠ¶æ€æœºï¼Œå°†çŠ¶æ€æœºçš„æŸä¸€ä¾§é¢æ‰“å¼€ï¼Œçœ‹ <code>error</code>ã€‚</p>
<p>å¦‚ä¸Šé¢ï¼šå¤§éƒ¨åˆ† Error å’Œ Failure éƒ½æ¯”è¾ƒæ¥è¿‘</p>
<ul>
<li>å‡ºé”™æ—¶ï¼Œä½¿ç”¨ <code>perror</code> æ‰“å°æ—¥å¿—ï¼Œè¿™ä¸ª <code>error message</code> å·²ç»ç¼©çŸ­äº† <code>failure</code> å’Œ <code>error</code> çš„è·ç¦»ï¼Œå»è¿›ä¸€æ­¥è§£å†³ã€‚</li>
</ul>
<p>å†è¿›ä¸€æ­¥ï¼Œè¿˜æ˜¯æ‰¾ä¸åˆ°åŸå› ï¼Ÿ</p>
<ul>
<li><strong>å‡ºé”™åŸå› æŠ¥å‘Šä¸å‡†ç¡®</strong></li>
<li>ç¨‹åºæ‰§è¡Œçš„è¿‡ç¨‹çœ‹ä¸åˆ°<ul>
<li>é‚£æˆ‘ä»¬æƒ³åŠæ³• â€œçœ‹åˆ°â€ çŠ¶æ€æœºçš„æ‰§è¡Œè¿‡ç¨‹å°±å¥½äº†ï¼ï¼ˆå°†çŠ¶æ€æœºæ‹†å¼€ï¼‰</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>
<p>ç†è§£çŠ¶æ€æœºæ‰§è¡Œï¼šä¸æ˜¯ â€œè°ƒè¯•â€ï¼Œä¹Ÿæ˜¯ â€œè°ƒè¯•â€ </p>
<ul>
<li><code>ssh</code>ï¼šä½¿ç”¨ <code>-v</code> é€‰é¡¹æ£€æŸ¥æ—¥å¿—   <code>verbose</code></li>
<li><code>gcc</code>ï¼šä½¿ç”¨ <code>-v</code> é€‰é¡¹æ‰“å°å„ç§è¿‡ç¨‹</li>
<li><code>make</code>ï¼šä½¿ç”¨ <code>-nB</code> é€‰é¡¹æŸ¥çœ‹å®Œæ•´å‘½ä»¤å†å²</li>
</ul>
</li>
<li>
<p>è°ƒè¯•ï¼šä¸ä»…æ˜¯ â€œè°ƒè¯•å™¨â€</p>
<ul>
<li>Profiler: <code>perf</code> - â€œé‡‡æ ·â€ çŠ¶æ€æœº</li>
<li>Trace: <code>strace</code> - è¿½è¸ªç³»ç»Ÿè°ƒç”¨</li>
</ul>
</li>
</ul>
</blockquote>
</li>
</ul>
<h4 id="example1syscdefsh-no-such-file-or-directory">example1ï¼š<code>sys/cdefs.h: No such file or directory</code></h4>
<ul>
<li>(è¿™çœ‹èµ·æ¥æ˜¯ç”¨ <code>perror()</code> æ‰“å°å‡ºæ¥çš„ï¼)</li>
<li>é—®é¢˜åˆ†æ<ul>
<li><code>#include</code> = å¤åˆ¶ç²˜è´´ï¼Œè‡ªç„¶ä¼šç»è¿‡è·¯å¾„è§£æ</li>
<li>æ˜æ˜ <code>/usr/include/x86_64-linux-gnu/sys/cdefs.h</code> æ˜¯å­˜åœ¨çš„ (<code>man 1 locate</code>) </li>
</ul>
</li>
<li>ä¸¤ç§æ–¹æ³•<ul>
<li>æ—¥å¿— --verbose</li>
<li>straceï¼Œç›´æ¥çœ‹è®¿é—®è¿‡çš„æ–‡ä»¶ï¼</li>
</ul>
</li>
</ul>
<p>ç®€å•å°è¯•ä¸‹è€å¸ˆè¯¾ä¸Šçš„æ“ä½œï¼šä¸‡èƒ½å¤´æ–‡ä»¶æ€ä¹ˆå·¥ä½œçš„ï¼š</p>
<div class="highlight"><pre><span></span><code>strace<span class="w"> </span>-f<span class="w"> </span>g++<span class="w"> </span>a.cc<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>vim<span class="w"> </span>-

vim:
:%!grep<span class="w"> </span><span class="se">\.</span>h
:%!grep<span class="w"> </span>-v<span class="w"> </span>ENOENT
:%!grep<span class="w"> </span>open
</code></pre></div>
<p>ç‰›å•Šï¼Œåˆä¸€æ¬¡æ„Ÿå—åˆ°UNIXå·¥å…·çš„å‰å®³</p>
<blockquote>
<p>LLM</p>
<ul>
<li>
<p><strong><code>strace</code> å‘½ä»¤</strong>ï¼š</p>
<ul>
<li><code>strace</code> æ˜¯ä¸€ä¸ªå¼ºå¤§çš„è°ƒè¯•å·¥å…·ï¼Œå¯ä»¥è·Ÿè¸ªè¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨å’Œä¿¡å·ã€‚å®ƒå¯ä»¥å¸®åŠ©ä½ ç†è§£ç¨‹åºåœ¨è¿è¡Œæ—¶ä¸æ“ä½œç³»ç»Ÿäº¤äº’çš„ç»†èŠ‚ã€‚</li>
<li><code>-f</code> é€‰é¡¹ç”¨äºè·Ÿè¸ªæ‰€æœ‰è¢« <code>g++</code> åˆ›å»ºçš„å­è¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨ã€‚è¿™å¯¹äºç¼–è¯‘è¿‡ç¨‹ç‰¹åˆ«æœ‰ç”¨ï¼Œå› ä¸º <code>g++</code> ä¼šåˆ›å»ºå¤šä¸ªå­è¿›ç¨‹æ¥å¤„ç†ä¸åŒçš„ç¼–è¯‘æ­¥éª¤ã€‚</li>
</ul>
</li>
<li>
<p><code>2&gt;&amp;1</code></p>
<p>å°†æ ‡å‡†é”™è¯¯é‡å®šå‘åˆ°æ ‡å‡†è¾“å‡ºï¼Œç¡®ä¿æ‰€æœ‰è¾“å‡ºéƒ½é€šè¿‡ç®¡é“ä¼ é€’ã€‚</p>
</li>
<li>
<p><code>| vim -</code></p>
<ul>
<li><code>|</code>ï¼šç®¡é“ç¬¦å·ï¼Œå°†å‰ä¸€ä¸ªå‘½ä»¤çš„è¾“å‡ºä½œä¸ºä¸‹ä¸€ä¸ªå‘½ä»¤çš„è¾“å…¥ã€‚</li>
<li><code>vim -</code>ï¼šåœ¨ Vim ä¸­æ‰“å¼€æ ‡å‡†è¾“å…¥çš„å†…å®¹ã€‚<code>-</code> è¡¨ç¤ºä»æ ‡å‡†è¾“å…¥è¯»å–æ•°æ®ã€‚</li>
</ul>
</li>
<li>
<p><code>:%!grep</code></p>
<ul>
<li><code>:%!grep</code> æ˜¯ä¸€ä¸ª Vim å‘½ä»¤ï¼Œç”¨äºå¯¹å½“å‰ç¼–è¾‘çš„æ–‡ä»¶çš„æ‰€æœ‰è¡Œï¼ˆ<code>%</code> è¡¨ç¤ºå½“å‰æ–‡ä»¶çš„æ‰€æœ‰è¡Œï¼‰åº”ç”¨ <code>grep</code> å‘½ä»¤ï¼Œå¹¶å°†ç»“æœæ›¿æ¢å½“å‰æ–‡ä»¶çš„å†…å®¹ã€‚</li>
<li>è¿™ä¸ªå‘½ä»¤éå¸¸æœ‰ç”¨ï¼Œå¯ä»¥å¿«é€Ÿè¿‡æ»¤æ–‡ä»¶å†…å®¹ï¼Œåªä¿ç•™åŒ¹é…ç‰¹å®šæ¨¡å¼çš„è¡Œã€‚</li>
<li><code>:%</code> æ˜¯ä¸€ä¸ª Vim èŒƒå›´æŒ‡å®šç¬¦ï¼Œè¡¨ç¤ºå½“å‰æ–‡ä»¶çš„æ‰€æœ‰è¡Œã€‚</li>
<li><code>:%!command</code> è¡¨ç¤ºå¯¹å½“å‰æ–‡ä»¶çš„æ‰€æœ‰è¡Œåº”ç”¨ <code>command</code>ï¼Œå¹¶å°†ç»“æœæ›¿æ¢å½“å‰æ–‡ä»¶çš„å†…å®¹ã€‚</li>
<li><code>:%grep command</code> è¡¨ç¤ºåœ¨å½“å‰æ–‡ä»¶çš„æ‰€æœ‰è¡Œä¸­æŸ¥æ‰¾åŒ¹é… <code>command</code> çš„è¡Œï¼Œå¹¶å°†ç»“æœä¿å­˜åœ¨ä¸´æ—¶æ–‡ä»¶ä¸­ã€‚</li>
</ul>
<blockquote>
<ul>
<li><strong><code>!</code></strong>ï¼šåœ¨ Vim å‘½ä»¤ä¸­ï¼Œ<code>!</code> ç”¨äºè¡¨ç¤ºâ€œè¿‡æ»¤â€æˆ–â€œæ›¿æ¢â€æ“ä½œã€‚å…·ä½“æ¥è¯´ï¼Œ<code>:%!command</code> è¡¨ç¤ºå¯¹å½“å‰æ–‡ä»¶çš„æ‰€æœ‰è¡Œåº”ç”¨ <code>command</code>ï¼Œå¹¶å°† <code>command</code> çš„è¾“å‡ºç»“æœæ›¿æ¢å½“å‰æ–‡ä»¶çš„å†…å®¹ã€‚</li>
<li><strong>æ²¡æœ‰ <code>!</code></strong>ï¼šå¦‚æœæ²¡æœ‰ <code>!</code>ï¼Œåˆ™è¡¨ç¤ºä¸è¿›è¡Œæ›¿æ¢æ“ä½œï¼Œè€Œæ˜¯å°†ç»“æœä¿å­˜åœ¨å¿«é€Ÿä¿®å¤åˆ—è¡¨ä¸­ï¼Œä¸ä¿®æ”¹å½“å‰æ–‡ä»¶çš„å†…å®¹ã€‚</li>
</ul>
</blockquote>
</li>
</ul>
</blockquote>
<ul>
<li>æ€»ç»“<ol>
<li><strong>ç¡®è®¤æ–‡ä»¶å­˜åœ¨</strong>ï¼šä½¿ç”¨ <code>locate</code> æˆ– <code>find</code> ç¡®è®¤æ–‡ä»¶ç¡®å®å­˜åœ¨ã€‚</li>
<li><strong>æ£€æŸ¥ç¼–è¯‘å™¨æœç´¢è·¯å¾„</strong>ï¼šä½¿ç”¨ <code>gcc -v</code> æˆ– <code>clang -v</code> æŸ¥çœ‹ç¼–è¯‘å™¨çš„æœç´¢è·¯å¾„ã€‚</li>
<li><strong>ä½¿ç”¨ <code>strace</code></strong>ï¼šè·Ÿè¸ªç¼–è¯‘å™¨æ‰§è¡Œæ—¶è®¿é—®çš„æ–‡ä»¶ï¼Œç¡®è®¤æ˜¯å¦å°è¯•è®¿é—®äº†æ­£ç¡®çš„è·¯å¾„ã€‚</li>
<li><strong>æ˜¾å¼æŒ‡å®šè·¯å¾„</strong>ï¼šå¦‚æœéœ€è¦ï¼Œä½¿ç”¨ <code>-I</code> é€‰é¡¹æ˜¾å¼æŒ‡å®šæœç´¢è·¯å¾„ã€‚</li>
</ol>
</li>
</ul>
<h4 id="example2real-bug">example2ï¼šreal bug</h4>
<ul>
<li>è£…äº† 100 å°ä¸€æ¨¡ä¸€æ ·çš„æœºå™¨ï¼Œä½†æœ‰ä¸€å°å‡ºé—®é¢˜äº†<ul>
<li>åå­—å« â€œpmâ€ çš„ Kernel thread å ç”¨ 100% CPU</li>
<li>LLM æœ‰éå¸¸å¥½çš„è§£é¢˜ç›´è§‰</li>
</ul>
</li>
</ul>
<blockquote>
<p>è¿˜æ˜¯è®°ä½è¿™å¥è¯ï¼ševerything is state machineã€‚æˆ–è€…ç”¨æ›´å¥½è®°çš„ä¸€å¥è¯ï¼Œå†¤æœ‰å¤´å€ºæœ‰ä¸»ï¼Œé‡åˆ° bugè‚¯å®šæœ‰å€ºä¸»ï¼Œè‚¯å®šæ˜¯å“ªé‡Œå¯¼è‡´ CPU å‡ºé—®é¢˜çš„ã€‚</p>
<p>ç”¨ <code>sudo perf top</code> </p>
<p>é€šè¿‡ <code>perf</code> å·¥å…·é‡‡æ ·çŠ¶æ€æœºï¼Œæ¯ä¸€ä¸ªé‡‡æ ·ç‚¹ï¼Œçœ‹åˆ°åº•æ˜¯å“ªä¸€ä¸ªå‡½æ•°å ç”¨æ—¶é—´ï¼Œåœ¨æ¯ä¸€ä¸ªé‡‡æ ·ç‚¹è¿›è¡Œ <code>backtrace</code> æ‰“å°å½“å‰çº¿ç¨‹è°ƒç”¨å †æ ˆã€‚-&gt;  å‘ç° <code>xhci</code> ï¼šUSB subsystem -&gt; æ‰¾åˆ°äº†è¢«æ’çƒ‚äº†çš„ USB æ¥å£ï¼ŒçŸ­è·¯äº†ï¼Œå¯¼è‡´ç”µæºç®¡ç†å‡ºäº†é—®é¢˜ã€‚ã€‚ </p>
</blockquote>
<p>æ€ä¹ˆåšåˆ°çš„ï¼Ÿ</p>
<p>everything is state machineã€‚</p>
<p>ä¼šä½¿ç”¨ç›¸å…³çš„å·¥å…·</p>
<h4 id="example3">example3</h4>
<p><img alt="image-20250110185657629" src="pic/image-20250110185657629.png" /></p>
<p>é€šè¿‡æŠ¥é”™ä¿¡æ¯çŸ¥é“ï¼Œè¿™æ˜¯ä»£ç æ‰“å°å‡ºæ¥çš„æŠ¥é”™ä¿¡æ¯ï¼Œé‚£èƒ½ä¸èƒ½æ‰¾åˆ°è¿™æ¡æŠ¥é”™ä¿¡æ¯åœ¨å“ªé‡Œï¼Ÿå› ä¸ºè¿™æ˜¯ä¸€ä¸ª Ubuntu çš„å®‰è£…é•œåƒï¼Œæ‰€ä»¥èƒ½ä¸èƒ½è§£å¼€ï¼Œç„¶åç›´æ¥æœç´¢æˆ–è€… <code>grep</code>ï¼Ÿæœ€åæ‰¾åˆ°äº†ä¸€å¤„åœ°æ–¹ï¼ˆshellè„šæœ¬ï¼‰ï¼Œé€šè¯»/è°ƒè¯•ä¸Šä¸‹æ–‡ä»£ç ï¼ŒçŸ¥é“è¿™éƒ¨åˆ†ä»£ç æ˜¯ç”¨æ¥æ‰«æç³»ç»Ÿæ‰€æœ‰çš„ç£ç›˜ï¼Œæ‰¾åˆ°ä¸€ä¸ªå®‰è£…ç£ç›˜å°±å®‰è£…ã€‚è‚¯å®šæœ‰åŸå› ä¸ºä»€ä¹ˆæ²¡æ‰¾åˆ°ç£ç›˜ã€‚æ€ä¹ˆè§£å†³ï¼Ÿè¿›ä¸€æ­¥çœ‹æ‰‹å†Œï¼Œå¼ºè¡ŒæŒ‡å®šä¸€ä¸ªè®¾å¤‡å®‰è£…/åˆ«çš„æ–¹æ³•</p>
<h4 id="summary">summary</h4>
<p>ä¸Šé¢è¿™äº›ä¾‹å­å…ˆæŠ›å¼€å„ç§å„æ ·çš„å‰ç½®åŸºç¡€çŸ¥è¯†ä¸è°ˆï¼Œæˆ‘æ˜¯ä¸€ä¸ªåˆå­¦è€…ï¼Œæˆ‘é‡åˆ°çš„é—®é¢˜åˆ«äººè‚¯å®šä¹Ÿé‡åˆ°è¿‡ã€‚ä½†æ˜¯æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ¯”è¾ƒå¥½çš„æˆ–è€…æ¯”è¾ƒ principal approachï¼ˆeverything is state machineï¼‰ï¼Œå‡ºé”™äº†ä¸€å®šæ˜¯è‡ªå·±çš„é—®é¢˜ï¼Œæˆ‘ä»¬èƒ½è§£å†³å®ƒï¼Œå®ƒä¸€å®šæ˜¯æœ‰åŸå› çš„ï¼Œä¸€æ­¥æ­¥åœ°å»è§£å†³é—®é¢˜ï¼Œæ‰©å……è‡ªå·±çš„åŸºç¡€çŸ¥è¯†ã€‚</p>
<blockquote>
<p>å®é™…ä¸Šæˆ‘è§‰å¾—æ•´ä¸ªè°ƒè¯•ç†è®ºä¸å•å•èƒ½ç”¨åœ¨è½¯ä»¶ï¼Œç”Ÿæ´»ä¸­çš„ç»™æ–¹é¢åº”è¯¥éƒ½èƒ½ç”¨ï¼Ÿé¢˜å¤–è¯ã€‚</p>
</blockquote>
<p>å†å›åˆ°è°ƒè¯•ç¨‹åºã€‚æˆ‘ä»¬ä¾æ—§éœ€è¦ <a href="https://sourceware.org/gdb/current/onlinedocs/gdb.html/">RTFM: Top (Debugging with GDB</a> </p>
<blockquote>
<p>åˆä¸€æ¬¡æé†’è‡ªå·±è¯¥è¯»è¯»æ‰‹å†Œäº†ï¼Œæ€»èƒ½å‘ç°ä¸€äº›å¾ˆå¥½ç©çš„ä¸œè¥¿ã€‚</p>
</blockquote>
<ul>
<li>å¦åˆ™æˆ‘ä»¬ç”šè‡³ä¸çŸ¥é“ <code>gdb</code> æœ‰å¤šå¼ºå¤§</li>
</ul>
<p>Cheat Sheet é‡Œæ²¡æœ‰çš„åŠŸèƒ½</p>
<ul>
<li>Text UI (æˆ‘å·²ç»é»˜è®¤å¯åŠ¨)</li>
<li>Stack, optimized code, macros, ...</li>
<li>Reverse execution</li>
<li>Record and replay</li>
<li>Scheduler</li>
</ul>
<blockquote>
<p>åˆä¸€ä¸ªä¾‹å­ï¼šçŠ¶æ€æœºå›æº¯ï¼Ÿé€†ç€çŠ¶æ€æœºçš„æ‰§è¡Œæµã€‚</p>
</blockquote>
<p>åªè¦ä½ æƒ³è¿™ä¸ªä¸œè¥¿ï¼Œé‚£è¿™ä¸ªä¸œè¥¿ä¸ºä»€ä¹ˆæ²¡æœ‰ï¼Œä¸ºä»€ä¹ˆä¸å¯ä»¥æœ‰ï¼Ÿé‚£åº”è¯¥æœ‰æ‰å¯¹ï¼Ÿ</p>
<blockquote>
<p><img alt="image-20250110191752496" src="pic/image-20250110191752496.png" /></p>
<p>å½“æˆ‘ç¬¬ä¸€æ¬¡çœ‹åˆ°è¿™æ®µè¯çš„æ—¶å€™ï¼Œæˆ‘å…¶å®å¹¶æ²¡æœ‰æ„è¯†ä»–ç©¶ç«Ÿæƒ³å‘Šè¯‰æˆ‘ä»€ä¹ˆï¼Œç®€å•åœ°è®¤è¯†äº†ä¸€ä¸ªç»“è®ºï¼šAI Copilot èƒ½å¤Ÿå¸®æˆ‘æŠŠäº‹æƒ…åšå¾—æ›´å¥½ã€‚</p>
<p>è‡ªä»é«˜ä¸­ä»¥æ¥éƒ½æ˜¯ä¹ æƒ¯æ¥å—åˆ«äººä¼ æˆçš„çŸ¥è¯†ï¼Œå­¦ä¹ æŠ€æœ¯æ€»æ˜¯ä¼šå»çœ‹åˆ«äººçš„æ€»ç»“/æ•™ç¨‹ï¼Œæ€»æ˜¯æƒ³ç€åˆ«äººåš¼çƒ‚äº†æ‰ç¢äº†å‘Šè¯‰æˆ‘ï¼Œä»æ¥æ²¡æƒ³è¿‡ä¸ºä»€ä¹ˆæˆ‘ä¸èƒ½å»é˜…è¯»ç¬¬ä¸€æ‰‹çš„èµ„æ–™ã€‚ï¼ˆå½“ç„¶ï¼Œæˆ‘è§‰å¾—åˆå­¦è€…éƒ½æ˜¯ä»è¿™ä¸ªé˜¶æ®µè¿‡æ¥çš„ï¼Œé‚£ä¹‹åå‘¢ï¼Ÿæ²¡æœ‰è¿™ç§èƒ½åŠ›ä¸ä¸€ç›´è¦ç­‰ç€åˆ«äººï¼Ÿï¼‰</p>
<p>åœ¨åš PA çš„æ—¶å€™å·²ç»æˆ–å¤šæˆ–å°‘å‘Šè¯‰è‡ªå·±åº”è¯¥æ¥å—ä¸€æ‰‹çš„çŸ¥è¯†ï¼Œåº”è¯¥æœé›†å„ç§èµ„æ–™ç‹¬ç«‹å®Œæˆï¼Œä½†åœ¨æ˜¨æ™šä¸€éƒ¨åˆ†ä¹‹åï¼Œä¸çŸ¥æ˜¯ä»¥å‰çš„ä¹ æƒ¯ä½¿ç„¶è¿˜æ˜¯è‡ªå·±çš„æƒ°æ€§å¤ªå¼ºï¼Œå¯¼è‡´åˆæœ‰ç‚¹å˜å›ä¹‹å‰çš„çŠ¶å†µï¼Œæ€»æ˜¯è¢«è¿«ç”¨è‚Œè‚‰è®°å¿†å®Œæˆå„ç§ä»»åŠ¡ã€‚</p>
<p>è¿™é‡Œè€å¸ˆç»™äº†ä¸€ä¸ªæé†’ï¼ŒAI Copilot æˆ–è®¸èƒ½å¤Ÿå……å½“è¿™ä¹ˆä¸€ä¸ªè§‚å¯Ÿè€…ï¼Œæˆ–è€…è¯´ç›‘ç£è€…çš„è§’è‰²ã€‚copilot æˆ–è®¸èƒ½å¤Ÿè®°å½•æˆ‘ä»¬åˆšæ‰åšè¿‡çš„äº‹æƒ…ï¼Œä»–èƒ½å¸®æˆ‘ä»¬æ€»ç»“æˆ–è€…ç»™å‡ºä¸€äº›å»ºè®®æ¥æé†’æˆ‘ä»¬æ˜¯ä¸æ˜¯èƒ½åšå¾—æ›´å¥½ã€‚æˆ–è®¸æœªæ¥æ€»ä¼šæœ‰è¿™ä¸ªå‘æ˜çš„å‡ºç°ï¼Ÿæˆ–è®¸è¿™å°±æ˜¯ä¸€ä¸ªé¡¹ç›®ï¼Ÿæˆ–è®¸å¯ä»¥å°è¯•ä¸‹ï¼Œæ–°çš„å‘æ˜å¾€å¾€éƒ½æ˜¯ç”±è¿™æ ·çš„æƒ³æ³•é“¸é€ è€Œæˆã€‚</p>
<p>å¦å¤–å¯¹äºè‡ªå·±æ¥è¯´ï¼Œè¶ç°åœ¨è¿˜å¹´è½»ï¼Œå¯ä»¥é¡¶ç€è‚Œè‚‰è®°å¿†æˆ–è€…è¶ç€è‚Œè‚‰è®°å¿†è¿˜æ²¡å®ç°çš„æ—¶å€™ï¼Œå»å­¦ä¹ æ–°çš„å†…å®¹ã€‚</p>
<blockquote>
<p>è¿™é‡Œæƒ³èµ·æ¥ä¹‹å‰è‡ªå·±çš„ä¸€äº›çœ‹æ³•ï¼šä¸å–œæ¬¢æŠ˜è…¾å’Œå­¦ä¹ æ–°çš„æŠ€æœ¯ï¼Œç°åœ¨çœ‹æ¥å…¶å®æ˜¯ä¸çŸ›ç›¾çš„ï¼Œå­¦ä¹ æ–°çš„æŠ€æœ¯å¯èƒ½è§£å†³çš„æ˜¯åŒæ ·çš„é—®é¢˜ï¼Œä½†æŸä¸€å¤©è¿™å°±èƒ½ç”¨åœ¨åˆ«çš„åœ°æ–¹ï¼Œæœ€ç»ˆæ€ä¹ˆè§£å†³/åˆ†æé—®é¢˜ï¼Œæ˜¯å‡­ç€ä½ é‚£ä¸ªæ—¶å€™çš„å…·ä½“æƒ…å†µå…·ä½“åˆ†æçš„ã€‚æ‰€ä»¥ï¼Œå»å­¦å§ï¼</p>
</blockquote>
</blockquote>
<h3 id="_12">è°ƒè¯•ç†è®ºçš„åº”ç”¨</h3>
<p><strong>éœ€æ±‚ â†’ è®¾è®¡ â†’ ä»£ç  â†’ Fault â†’ Error â†’ Failure</strong></p>
<p>ä»ä¸Šé¢è¿™å¯¹äºæˆ‘ä»¬è®¾è®¡ç»™å‡ºä¸‰ä¸ªç›¸å¯¹é‡è¦çš„å»ºè®®ï¼š</p>
<ol>
<li>
<p><strong><mark>éœ€æ±‚ â†’ è®¾è®¡ â†’ ä»£ç  â†’ Fault</mark></strong> â†’ Error â†’ Failure</p>
<ul>
<li>
<p><strong>å†™å¥½ä»£ç </strong>ï¼šä¸è¦åœ¨å†™ä»£ç çš„æ—¶å€™å¿˜è®°éœ€æ±‚å’Œè®¾è®¡</p>
<blockquote>
<p>è¿™é‡Œæˆ‘çš„ä½“ä¼šæ˜¯ï¼šå¤šèŠ±ä¸€äº›æ—¶é—´åœ¨è‡ªå·±çš„è®¾è®¡å’Œéœ€æ±‚åˆ†æä¸Šï¼Œæƒ³æƒ³è‡ªå·±ä»¥å‰å†™ä»£ç éƒ½æ˜¯å­å“§å­å“§æ— è„‘ä¸Šå¤´å†™ï¼Œé‡åˆ°bugäº†ï¼Œä¸€ç›´è°ƒï¼Œè§£å†³ä¸äº†å°±é—® AIï¼ŒæŸ¥èµ„æ–™ï¼Œå‡­ç€è‡ªå·±çš„ç›´è§‰ä¸€å¾€æ— å‰ï¼Œä½†è‡ªå·±çš„ç›´è§‰åˆå¾€å¾€æ²¡æœ‰è€å¸ˆé‚£ä¹ˆå¥½ã€‚</p>
<p>å…¶å®æˆ‘å¯ä»¥å…ˆåœ¨çº¸ä¸Šæˆ–è€… markdown ç®€å•å†™å†™æ•´ä¸ªçš„æµç¨‹ï¼Œè‡ªå·±å¿ƒé‡Œåº”è¯¥æœ‰ä¸ªåº•çš„ï¼Œæˆ–è®¸ä»£ç å†™çš„å°‘äº†ï¼Œé¡¹ç›®åšçš„å°‘ã€‚</p>
</blockquote>
</li>
<li>
<p>ä¸è¨€è‡ªæ˜ (Self-explanatory)</p>
<ul>
<li>èƒ½é€šè¿‡å­—é¢çŸ¥é“éœ€æ±‚ (æµç¨‹)</li>
</ul>
</li>
<li>
<p>ä¸è¨€è‡ªè¯ (Self-evident)</p>
<ul>
<li>èƒ½é€šè¿‡å­—é¢ç¡®è®¤ä»£ç å’Œéœ€æ±‚ä¸€è‡´</li>
</ul>
</li>
</ul>
<p><strong>ä»£ç é¦–å…ˆæ˜¯ç»™äººçœ‹åˆ°ï¼Œå…¶æ¬¡æ‰æ˜¯æœºå™¨æ‰§è¡Œçš„</strong></p>
<blockquote>
<p><strong>ä¸€ä¸ªè¯„åˆ¤æ ‡å‡†</strong></p>
<ul>
<li>AI æ˜¯å¦èƒ½æ­£ç¡®ç†è§£/ç»´æŠ¤ä½ çš„ä»£ç : <a href="http://git.nju.edu.cn/jyy/toybox">toybox</a></li>
</ul>
<blockquote>
<p>Programs are meant to be read by humans and only incidentally for computers to execute. (Donald E. Knuth)</p>
</blockquote>
</blockquote>
</li>
<li>
<p>éœ€æ±‚ â†’ è®¾è®¡ â†’ ä»£ç  â†’ <strong><mark>Fault â†’ Error</mark></strong> â†’ Failure</p>
<ul>
<li><strong>åšå¥½æµ‹è¯•</strong>ï¼šæœªæµ‹ä»£ç æ°¸è¿œæ˜¯é”™çš„<ul>
<li>æ®‹é…·çš„ç°å®ï¼šç›¸ä¿¡è‡ªå·±å†™ä¸å¯¹ä»£ç </li>
<li>LLM ä¸€æ ·ç»å¸¸çŠ¯ â€œå‚»â€ é”™</li>
</ul>
</li>
</ul>
<blockquote>
<p>Small Scope Hypothesis</p>
<p>If a system does not have a counterexample (i.e., an error or a bug) for a certain property within a small scope (a limited size or configuration), then it is unlikely to have a counterexample in a larger scope. (Daniel Jackson)</p>
<p><strong><mark>TODO</mark></strong></p>
</blockquote>
<p>å®é™…ä¸Šæˆ‘å¯¹è¿™éƒ¨åˆ†çš„å†…å®¹ï¼Œå®é™…ä¸Šå¹¶ä¸æ˜¯ç‰¹åˆ«åœ°äº†è§£ï¼Œå¤§å®¶ä¸€ç›´åœ¨è¯´çš„æµ‹è¯•é©±åŠ¨å¼€å‘ï¼ˆTDDï¼‰æˆ‘ä¹Ÿä¸æ‡‚ï¼Œè‡ªå·±çš„ç»å†ä¹Ÿå°±åªæ˜¯åœ¨åš PA çš„æ—¶å€™ï¼Œè‡ªå·±å®ç°ä¸€ä¸ªå‡½æ•°åŠŸèƒ½ï¼Œç„¶åç”¨è¿™ä¸ªå‡½æ•°ï¼Œçœ‹çœ‹æœ‰æ²¡è¾¾æˆæƒ³è¦çš„æ•ˆæœï¼Ÿï¼ˆæ¯”å¦‚ <code>strcpy</code>ã€<code>strcmp</code>ç­‰ï¼‰ä¸è¿‡å¾ˆå¤šæ—¶å€™éƒ½æ˜¯å€ŸåŠ© GPT æ¥å¸®åŠ©æˆ‘å†™è¿™ä¸ªä¸œè¥¿ã€‚æ‰€ä»¥è¿™é‡Œç•™å‘ï¼Œå‡†å¤‡å»çœ‹çœ‹ç›¸å…³çš„ä¹¦ç±ã€‚ <strong><mark>TODO</mark></strong></p>
</li>
<li>
<p>éœ€æ±‚ â†’ è®¾è®¡ â†’ ä»£ç  â†’ Fault â†’ <strong><mark>Error â†’ Failure</mark></strong></p>
<ul>
<li>
<p>å¤šå†™æ–­è¨€</p>
<p>ï¼šæŠŠä»£ç ä¸­çš„ â€œéšè—æ€§è´¨â€ å†™å‡ºæ¥</p>
<ul>
<li>Error æš´éœ²çš„è¶Šæ™šï¼Œè°ƒè¯•è¶Šå›°éš¾</li>
<li>è¿½æº¯å¯¼è‡´ assert failure çš„å˜é‡å€¼ (slice) é€šå¸¸å¯ä»¥å¿«é€Ÿå®šä½åˆ° bug</li>
</ul>
</li>
</ul>
<blockquote>
<p>â€œThere are two ways of constructing a software design: One way is to make it so simple that there are obviously no deficiencies, and the other way is to make it so complicated that there are no obvious deficienciesâ€ (Tony Hoare)</p>
</blockquote>
<p>å…¶å®è¯´æ¥æƒ­æ„§ï¼Œåš PA çš„æ—¶å€™ä¸€ç›´éƒ½çŸ¥é“è¦å¤šå†™æ–­è¨€ï¼Œä½†æ˜¯åªæœ‰åœ¨æƒ³èµ·æ¥çš„æ—¶å€™æ‰ä¼šåšï¼Œå¹¶æ²¡æœ‰æŠŠè¿™ä¸ªå½“ä½œä¸€ä¸ªä¹ æƒ¯ï¼Œä¹‹åå…»æˆä¹ æƒ¯å§ã€‚</p>
<p><img alt="image-20250111210424564" src="pic/image-20250111210424564.png" /></p>
<blockquote>
<p>ä»¥å¾€éƒ½æ˜¯å…ˆå­¦äº†æŸä¸ªä¸œè¥¿çš„æ€§è´¨ï¼Œç„¶åå……åˆ†åº”ç”¨ä»–çš„æ€§è´¨æ¥å®å„ç§å„æ ·çš„åŠŸèƒ½ï¼Œä½†æ˜¯ç°åœ¨ï¼Œæˆ‘å®ç°å¾—ä¸æ­£ç¡®ï¼Œæ­£ç¡®çš„æ€§è´¨è‡ªç„¶ä¹Ÿå°±ä¸æ»¡è¶³ï¼Œè‡ªç„¶ä¹Ÿå°±éœ€è¦ä¸Šé¢è¿™äº›çœ‹èµ·æ¥å‚»é‡Œå‚»æ°”çš„æ–­è¨€æ¥å¸®åŠ©æˆ‘æ‰¾å‡º bugsã€‚</p>
</blockquote>
<p>æœ‰äº› â€œæ˜æ˜¾â€ çš„æ–­è¨€ï¼Œå†™èµ·æ¥ä¼šå½»åº•ç ´åä»£ç çš„å¯è¯»æ€§</p>
<div class="highlight"><pre><span></span><code><span class="n">assert</span><span class="p">(</span><span class="n">first</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">last</span><span class="p">(</span><span class="n">obj</span><span class="p">));</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">// Assumes ptr is valid. </span>
</code></pre></div>
<ul>
<li>
<p>ä½†å¦‚æœæœ‰è¿™æ ·çš„æ–­è¨€ï¼Œä½ å°±ä¸ç”¨æ‹…å¿ƒæ•°ç»„è¶Šç•Œäº†ï¼</p>
<p>Bad practice: <code>int elements[MaxN + 100];</code></p>
</li>
<li>
<p>ä¸€ä¸ªç¥å¥‡çš„ç¼–è¯‘é€‰é¡¹</p>
<div class="highlight"><pre><span></span><code><span class="o">-</span><span class="n">fsanitize</span><span class="o">=</span><span class="n">address</span>
</code></pre></div>
<p>Address Sanitizer; asan â€œåŠ¨æ€ç¨‹åºåˆ†æâ€</p>
</li>
</ul>
<p>è¿™ç§äº‹æƒ…ç¼–è¯‘å™¨åº”è¯¥ç”±ç¼–è¯‘å™¨åšï¼Œä¸ç„¶æ¯æ¬¡éƒ½åŠ ï¼ŒçœŸå¾—å¾ˆéº»çƒ¦ã€‚</p>
</li>
</ol>
<h2 id="1_1">å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥ï¼ˆ1ï¼‰</h2>
<p>åŒæ­¥æ˜¯ä»€ä¹ˆï¼Ÿè¿™ä¸ªä¸œè¥¿æ˜¯å¹²å•¥çš„ï¼Ÿ</p>
<p>å›æƒ³ï¼šå¹¶å‘æ§åˆ¶çš„è¦æ±‚ï¼Ÿäº’æ–¥å®ç°çš„æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p>äº’æ–¥ä¿è¯äº†æˆ‘ä»¬çš„åŸå­æ€§ï¼Œä½†æ˜¯æƒ³è¦è°ƒæ§ä¸¤ä»½ä»£ç æ‰§è¡Œçš„é¡ºåºå…³ç³»è¿˜æ˜¯åšä¸åˆ°çš„ã€‚</p>
<p><strong>Synchronizationï¼šæ§åˆ¶å¹¶å‘ï¼šä½¿å¾— â€œä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šéšæ—¶é—´å˜åŒ–çš„é‡åœ¨å˜åŒ–è¿‡ç¨‹ä¸­==ä¿æŒä¸€å®šçš„ç›¸å¯¹å…³ç³»==â€</strong></p>
<p>è¿˜æ˜¯è®°ä½æ–¹æ³•ï¼š</p>
<ul>
<li>çº¿ç¨‹ = æˆ‘ä»¬è‡ªå·±</li>
<li>å…±äº«å†…å­˜ = ç‰©ç†ç©ºé—´</li>
</ul>
<h3 id="_13">çº¿ç¨‹åŒæ­¥</h3>
<h4 id="example1">example1ï¼šæ¼”å¥éŸ³ä¹</h4>
<ul>
<li>æ¼”å¥éŸ³ä¹ä¸­çš„åŒæ­¥<ul>
<li>æ¯ä¸ªä¹æ‰‹éƒ½æ˜¯ä¸€ä¸ª â€œçº¿ç¨‹â€</li>
<li>èŠ‚æ‹ <em>i</em>  åˆ°è¾¾ â†’ æ¼”å¥ n~i~</li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">T_player</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">end</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wait_next_beat</span><span class="p">();</span><span class="w"> </span><span class="c1">// åŒæ­¥ï¼Œç­‰å¾…æŒ‡æŒ¥å‘å‡ºèŠ‚æ‹æŒ‡ä»¤</span>
<span class="w">        </span><span class="n">play_next_note</span><span class="p">();</span><span class="w"> </span><span class="c1">// æ¼”å¥å¯¹åº”èŠ‚æ‹</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="example2">example2ï¼šçº¦ä¼š</h4>
<p>ä¸¤äººçº¦å®šå‡ ç‚¹å‡ åˆ†åŒæ—¶åœ¨ xxx åœ°ç‚¹è§é¢ã€‚</p>
<p>å¦‚æœæŸäººå…ˆåˆ°äº†ï¼Œé‚£ä»–å°±å¾—ä¸€ç›´ç­‰å¦ä¸€ä¸ªäººï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥å»ç©åˆ«çš„ä¸œè¥¿ï¼Œä½†æ˜¯åˆ°çº¦å®šæ—¶é—´ï¼Œå¿…é¡»å‡ºç°åœ¨é‚£é‡Œï¼‰ã€‚</p>
<h4 id="example3_1">example3ï¼šæ›´è¿›ä¸€æ­¥</h4>
<p><strong>åœ¨æŸä¸ªç¬é—´è¾¾åˆ° â€œäº’ç›¸å·²çŸ¥â€ çš„çŠ¶æ€</strong></p>
<ul>
<li>NPY: ç­‰æˆ‘æ´—ä¸ªå¤´å°±å‡ºé—¨</li>
<li>NPY: ç­‰æˆ‘æ‰“å®Œè¿™å±€æ¸¸æˆå°±æ¥</li>
<li>èˆå‹ï¼šç­‰æˆ‘ä¿®å¥½è¿™ä¸ª bug å°±åƒé¥­</li>
<li>å¯¼å¸ˆï¼šç­‰æˆ‘å‡ºå·®å›æ¥å°±è®¨è®ºè¿™ä¸ªè¯¾é¢˜</li>
<li>
<p>join(): ç­‰æ‰€æœ‰çº¿ç¨‹ç»“æŸå°±ç»§ç»­</p>
</li>
<li>
<p>â€œå…ˆåˆ°å…ˆç­‰â€ï¼Œåœ¨æ¡ä»¶è¾¾æˆçš„ç¬é—´å†æ¬¡æ¢å¤å¹¶è¡Œ</p>
<p>åŒæ—¶å¼€å§‹å‡ºå»ç©/åƒé¥­/è®¨è®º</p>
</li>
</ul>
<h4 id="_14">çŠ¶æ€æœºè§†è§’</h4>
<p>æŒºæ¸…æ™°çš„å›¾ï¼Œä¸¤ä¸ªçº¿ç¨‹éƒ½åœ¨åˆå§‹çš„æŸä¸ªçŠ¶æ€ä¸Šï¼Œå“ªæ€•ä¹‹åä¸æ–­çŠ¶æ€è¿ç§»ï¼Œåšäº†å¾ˆå¤šåˆ«çš„äº‹æƒ…ï¼Œ</p>
<p>ä½†å¹¶å‘æ§åˆ¶ï¼ˆåŒæ­¥ï¼‰å°±è¦æ±‚æˆ‘ä»¬åœ¨ä¹‹ååˆå›åˆ°ç»Ÿä¸€çš„çŠ¶æ€ä¸Šï¼ˆå†æ¬¡æ¢å¤å¹¶è¡Œï¼‰ï¼Œå†å›çœ‹ä¹‹å‰çš„ä¾‹å­åº”è¯¥ä¹ŸæŒºå¥½ç†è§£çš„ã€‚</p>
<p><img alt="image-20250112110354311" src="pic/image-20250112110354311.png" /></p>
<p>åœ¨æŸä¸€ä¸ªæ—¶åˆ»ï¼š</p>
<p>æ‰€æœ‰çš„ players éƒ½å®Œæˆäº†ç¬¬ n æ‹ï¼ˆå¤„äºç›¸åŒçš„çŠ¶æ€ï¼‰</p>
<p>ç„¶åæŒ‡æŒ¥ä¸‹è¾¾å‘½ä»¤ï¼šæ‰“ n+1 æ‹</p>
<p>ï¼ˆå¯èƒ½æœ‰äººï¼ˆçº¿ç¨‹ï¼‰ä¼šèµ°ç¥ï¼Œä¼šæŠ¢æ‹ï¼ˆç»å†å¤æ‚çš„è°ƒåº¦ï¼Œå¤šæ ¸éƒ½åšå„è‡ªçš„äº‹æƒ…ï¼Œä½†æœ€ç»ˆå›åˆ°åŒä¸€çŠ¶æ€ï¼‰ï¼‰</p>
<p>æ‰€æœ‰äººç¬¬ n+1 æ‹å®Œæˆï¼ˆå¤„äºç›¸åŒçš„çŠ¶æ€ï¼Œåªæ˜¯æ‹å­æ•° + 1ï¼‰</p>
<p><img alt="image-20250112111059315" src="pic/image-20250112111059315.png" /></p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">T_player</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">end</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wait_next_beat</span><span class="p">();</span>
<span class="w">        </span><span class="n">play_next_note</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">T_conductor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">end</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wait_next_beat</span><span class="p">();</span>
<span class="w">        </span><span class="n">release</span><span class="p">();</span><span class="w"> </span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span><span class="w"> </span>
<span class="c1">// release() ä¹‹åï¼Œplayer éƒ½ä¼šæ¼”å¥ä¸‹ä¸€æ‹</span>
<span class="c1">// ä¼ªä»£ç </span>
</code></pre></div>
<p>æœ‰äº†å…·ä½“ä¾‹å­è¾…åŠ©ç†è§£ï¼Œæ¥ç€å°±åˆ°äº†æ€ä¹ˆå®ç°åŒæ­¥ã€‚è¿˜æ˜¯ä»¥æ€ä¹ˆå®ç°æ¼”å¥éŸ³ä¹ä¸ºä¾‹ï¼šæ€ä¹ˆç­‰å¾…ä¸‹ä¸€ä¸ªæ‹ï¼Ÿ</p>
<p>å…¶å®åˆšå¼€å§‹æˆ‘è§‰å¾—è‡ªæ—‹åº”è¯¥å°±èƒ½è§£å†³é—®é¢˜çš„ï¼Œå°±æ¯”å¦‚åŠ ä¸ª if åˆ¤æ–­çœ‹æ˜¯å¦æ”¶åˆ°äº†æŒ‡æŒ¥çš„å‘½ä»¤ï¼Œæ²¡æ”¶åˆ°å°±ä¸€ç›´ç©ºè½¬è‡ªæ—‹ï¼Œä½†è¿™æ ·ä¼šä¸ä¼šå¤ªæ…¢ï¼Ÿ</p>
<blockquote>
<p>å…¶å®è¿˜çœŸæ˜¯ï¼šæˆ‘æƒ³çš„ if åˆ¤æ–­å°±æ˜¯åŒæ­¥æ¡ä»¶ï¼Œä¹Ÿå°±æ˜¯åŒæ­¥çš„å…³é”®ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆä¸ç”¨ whileï¼Ÿ</p>
</blockquote>
<ul>
<li>çº¿ç¨‹æœ‰å…ˆåï¼Œå…ˆæ¥å…ˆç­‰å¾…</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">wait_next_beat</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="nl">retry</span><span class="p">:</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">next_beat_has_come</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">retry</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="-">ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ä¸æ¡ä»¶å˜é‡(â­)</h3>
<blockquote>
<p>â€99% çš„å®é™…å¹¶å‘é—®é¢˜éƒ½å¯ä»¥ç”¨ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹æ¥è§£å†³â€œï¼Œeg. å°†ç®—æ³•å¹¶è¡ŒåŒ–</p>
<p>â€æ¡ä»¶å˜é‡èƒ½è§£å†³ 100% çš„å¹¶å‘é—®é¢˜â€œ</p>
</blockquote>
<ul>
<li>Producer å’Œ Consumer å…±äº«ä¸€ä¸ªç¼“å†²åŒº<ul>
<li>Producer (ç”Ÿäº§æ•°æ®)ï¼šå¦‚æœ<strong>ç¼“å†²åŒº</strong>æœ‰ç©ºä½ï¼Œæ”¾å…¥ï¼›å¦åˆ™ç­‰å¾…</li>
<li>Consumer (æ¶ˆè´¹æ•°æ®)ï¼šå¦‚æœ<strong>ç¼“å†²åŒº</strong>æœ‰æ•°æ®ï¼Œå–èµ°ï¼›å¦åˆ™ç­‰å¾…</li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">produce</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">obj</span><span class="p">);</span><span class="w"> </span>
<span class="n">Object</span><span class="w"> </span><span class="nf">consume</span><span class="p">();</span>
</code></pre></div>
<p><strong><mark>åŒæ­¥ï¼Œå…³é”®åœ¨äºå®ç°åŒæ­¥çš„æ¡ä»¶ã€‚ç­‰åˆ°æŸä¸€ä¸ªæ¡ä»¶æˆç«‹æ—¶æ‰èƒ½åšæŸäº‹</mark></strong></p>
<p>è¿›ä¸€æ­¥ç®€åŒ–ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">produce</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;(&quot;</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"> </span>
<span class="kt">void</span><span class="w"> </span><span class="nf">consume</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;)&quot;</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"> </span>
</code></pre></div>
<ul>
<li>
<p>ç”Ÿäº§ = æ‰“å°å·¦æ‹¬å· (push into buffer)    æ”¾å…¥ç¼“å†²åŒº</p>
</li>
<li>
<p>æ¶ˆè´¹ = æ‰“å°å³æ‹¬å· (pop from buffer)    ä»ç¼“å†²åŒºä¸­å–å‡º</p>
</li>
<li>
<p>åœ¨ <code>printf</code> å‰åå¢åŠ ä»£ç ï¼Œä½¿å¾—æ‰“å°çš„æ‹¬å·åºåˆ—æ»¡è¶³</p>
<p><strong>ç¼“å†²åŒºæœªæ»¡ï¼šå¯ä»¥æ‰“å°å·¦æ‹¬å·</strong></p>
<p><strong>ç¼“å†²åŒºæœ‰è´§ï¼šå¯ä»¥æ‰“å°å³æ‹¬å·</strong></p>
<ul>
<li>ä¸€å®šæ˜¯æŸä¸ªåˆæ³•æ‹¬å·åºåˆ—çš„å‰ç¼€</li>
<li>æ‹¬å·åµŒå¥—çš„æ·±åº¦ä¸è¶…è¿‡ n<ul>
<li>n=3ï¼š<code>((())())(((</code> åˆæ³•</li>
<li>n=3ï¼š<code>(((())))</code>, <code>(()))</code> ä¸åˆæ³•</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">produce</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">wait_until</span><span class="p">(</span><span class="n">æ‹¬å·æ·±åº¦</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;(&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">consume</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">wait_until</span><span class="p">(</span><span class="n">æ‹¬å·æ·±åº¦</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;)&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="version1">version1</h4>
<div class="highlight"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">T_produce</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="nl">retry</span><span class="p">:</span>
<span class="w">        </span><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">depth</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
<span class="w">        </span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ready</span><span class="p">)</span><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="n">retry</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// context switch</span>
<span class="w">        </span><span class="c1">// assert(depth &lt; n);</span>

<span class="w">        </span><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;(&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">depth</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">T_consume</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="nl">retry</span><span class="p">:</span>
<span class="w">        </span><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">depth</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ready</span><span class="p">)</span><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="n">retry</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// assert(depth &gt; 0);</span>

<span class="w">        </span><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;)&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">depth</span><span class="o">--</span><span class="p">;</span>
<span class="w">        </span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>why wrongï¼Ÿ</p>
<p>æŒºå¥½ç†è§£çš„ï¼Œè¿˜æ˜¯ä¹‹å‰çš„é‚£æ ·ï¼Œç¬¬ 8 è¡Œçš„ ready æ˜¯ä¸€ä¸ªå…±äº«èµ„æºæ¥çš„ï¼Œæ²¡å¯¹å®ƒåŠ é”ï¼Œè‡ªç„¶å°±æœ‰å¯èƒ½è¯»åˆ°çš„æ˜¯æ—§çš„ readyï¼ˆåˆšå¥½ç¬¬ 8 è¡Œåä¸Šä¸‹æ–‡åˆ‡æ¢ã€æ¥ä¸­æ–­ï¼Œå› ä¸ºè¿˜æ²¡æœ‰æ›´æ–°ç¼“å†²åŒºï¼Œå¯¼è‡´åˆ«çš„çº¿ç¨‹çš„ç¬¬ 13 åˆ° ç¬¬ 16 è¡Œçš„ä»£ç å°±ä¼šå°†ç¼“å†²åŒºå¡«æ»¡ï¼Œè¿™ä¸ªæ—¶å€™ 11 è¡Œçš„ assert å°±æœ‰é—®é¢˜ï¼‰ã€‚</p>
<p>åªè¦å­˜åœ¨å¤šä¸ªæ¶ˆè´¹è€…ï¼Œé‚£å°±ä¼šåœ¨å¹¶å‘çš„æ—¶å€™å½±å“åˆ° ready çš„å€¼ã€‚</p>
<p>ä¹Ÿå¾ˆå®¹æ˜“è§£å†³ï¼Œå…¶å®å°±æ˜¯ 5 åˆ° 8 è¡Œå¯¹ ready é”çš„æ—¶é—´ä¸å¤Ÿé•¿ï¼Œå°†æ•´ä¸ª produce çš„æ“ä½œéƒ½å˜æˆåŸå­çš„ï¼Œéƒ½é”ä½ã€‚</p>
<h4 id="version2">version2</h4>
<div class="highlight"><pre><span></span><code><span class="cp">#define CAN_PRODUCE (depth &lt; n)</span>
<span class="cp">#define CAN_CONSUME (depth &gt; 0)</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">T_produce</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="nl">retry</span><span class="p">:</span>
<span class="w">        </span><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">CAN_PRODUCE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">retry</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// The check of sync condition (depth &lt; n) is within</span>
<span class="w">        </span><span class="c1">// the same critical section. As long as we safely</span>
<span class="w">        </span><span class="c1">// protected the shared state, this condition should</span>
<span class="w">        </span><span class="c1">// always hold at this point.</span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">depth</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>

<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;(&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">depth</span><span class="o">++</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// And at this point, the condition (depth &gt; 0) is</span>
<span class="w">        </span><span class="c1">// satisfied. However, a consumer could proceed with</span>
<span class="w">        </span><span class="c1">// checking depth only if the lock is released.</span>
<span class="w">        </span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">T_consume</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="nl">retry</span><span class="p">:</span>
<span class="w">        </span><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">CAN_CONSUME</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">retry</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">depth</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;)&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">depth</span><span class="o">--</span><span class="p">;</span>

<span class="w">        </span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>ç”±æ­¤å¾—å‡ºè¿™ä¸ªä¸‡èƒ½æ¨¡å‹ï¼Œå…³é”®åœ¨äºæ€ä¹ˆæ¢è¿™ä¸ªåŒæ­¥æ¡ä»¶ã€‚</p>
<p>è¿›ä¸€æ­¥ï¼ŒOS å¼€å‘è€…å°†ä¸Šé¢çš„å†…å®¹æ”¹è¿›å˜æˆäº†ç”¨æ¡ä»¶å˜é‡æ¥å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ã€‚</p>
<h4 id="conditional-variable">conditional variable</h4>
<p>å¯¹äºä¸Šé¢çš„å®ç°ï¼Œæœ€å¤§çš„é—®é¢˜å°±æ˜¯çº¿ç¨‹æµªè´¹ <code>cpu</code>ï¼Œä¾ç„¶è‡ªæ—‹ç©ºè½¬ã€‚</p>
<blockquote>
<p>å¦‚æœ ç”Ÿäº§è€…å·²ç»æ”¾æ…¢äº†èµ„æºåˆ°ç¼“å†²åŒºï¼Œä½†æ˜¯æ¶ˆè´¹è€…è¿˜æ²¡æœ‰æ¶ˆè´¹å®Œï¼Œé‚£ç”Ÿäº§è€…å°±ä¸€ç›´è‡ªæ—‹åœ¨é‚£äº†ã€‚</p>
</blockquote>
<p>è¿›ä¸€æ­¥ä¸Šé¢è§‚å¯Ÿä¸Šé¢ç‰¹å¾ï¼šåŒæ­¥æ¡ä»¶ + è‡ªæ—‹ã€‚ </p>
<p>å›æƒ³å‰å‡ è¯¾çš„å†…å®¹ï¼Œæ—¢ç„¶ç©ºè½¬æµªè´¹èµ„æºï¼Œé‚£å°±ä½ ç¡å»å§ï¼Œè®©åˆ«äººï¼ˆçº¿ç¨‹ï¼‰æ¥åšã€‚</p>
<p>å¦å¤–ï¼ŒåŒæ­¥æ¡ä»¶ -&gt; å˜é‡</p>
<p>å…·ä½“æ¥è¯´ï¼Œåœ¨åŒæ­¥æ¡ä»¶ä¸æˆç«‹çš„æ—¶å€™ï¼ˆä¾ç„¶è§£é”é”ï¼‰ï¼Œä¸ä½¿ç”¨ retryï¼Œè€Œå°†çº¿ç¨‹ç¡çœ ï¼Œä¹‹åç­‰åˆ°æ¡ä»¶æ»¡è¶³ï¼ŒæŸäººå°†æˆ‘å”¤é†’ï¼Œé†’æ¥ä¹‹åå†ä¸Šé”ï¼Œå†æ¬¡åˆ¤æ–­æ˜¯å¦æ»¡è¶³åŒæ­¥æ¡ä»¶ï¼Œå¦‚æœæ»¡è¶³äº†ï¼Œå°±å¯ä»¥å»åšå®é™…çš„è®¡ç®—ä»»åŠ¡ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
<span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">CAN_PRODUCE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
<span class="w">    </span><span class="n">wait_for_someone_wake_me_up</span><span class="p">();</span>
<span class="w">    </span><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span><span class="w">    </span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>æŠŠæ¡ä»¶ç”¨ä¸€ä¸ªå˜é‡æ¥æ›¿ä»£ï¼š<code>CAN_PRODUCE</code>  -&gt; <code>cond_t cv</code></li>
<li>æ¡ä»¶ä¸æ»¡è¶³æ—¶ç­‰å¾…ï¼Œæ¡ä»¶æ»¡è¶³æ—¶å”¤é†’ï¼š<code>wait_for_someone_wake_me_up</code> + <code>mutex_lock</code>  -&gt; <code>cond_wait</code></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">mutex_t</span><span class="w"> </span><span class="n">lk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MUTEX_INIT</span><span class="p">();</span>
<span class="n">cond_t</span><span class="w"> </span><span class="n">cv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">COND_INIT</span><span class="p">();</span>

<span class="cp">#define CAN_PRODUCE (depth &lt; n)</span>
<span class="cp">#define CAN_CONSUME (depth &gt; 0)</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">T_produce</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">CAN_PRODUCE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cv</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
<span class="w">            </span><span class="c1">// We are here if the thread is being waked up, with</span>
<span class="w">            </span><span class="c1">// the mutex being acquired. Then we check once again,</span>
<span class="w">            </span><span class="c1">// and move out of the loop if CAN_PRODUCE holds.</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// We still hold the mutex--and we check again.</span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">CAN_PRODUCE</span><span class="p">);</span>

<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;(&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">depth</span><span class="o">++</span><span class="p">;</span>

<span class="w">        </span><span class="n">cond_broadcast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cv</span><span class="p">);</span>
<span class="w">        </span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">T_consume</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">CAN_CONSUME</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cv</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;)&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">depth</span><span class="o">--</span><span class="p">;</span>

<span class="w">        </span><span class="n">cond_broadcast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cv</span><span class="p">);</span>
<span class="w">        </span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cv</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lk</span><span class="p">)</span><span class="err">ï¼›</span><span class="w"> </span><span class="c1">// å¯¹äºè¿™ä¸ªåŒæ­¥æ¡ä»¶cvä¸æˆç«‹ï¼Œè¿›å…¥ç¡çœ æ¨¡å¼ï¼Œè¿›å…¥ç­‰å¾…ï¼ŒåŒæ—¶é‡Šæ”¾é”lkï¼Œè¢«å”¤é†’ååˆé‡æ–°ä¸Šé”</span>

<span class="c1">//æœ‰äººåœ¨ç­‰å¾…æˆ‘çš„æ¡ä»¶ï¼Œæˆ‘å°†ä»–å”¤é†’</span>
<span class="n">cond_signal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cv</span><span class="p">);</span><span class="w">  </span><span class="c1">// Wake up a (random) thread</span>
<span class="n">cond_broadcast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cv</span><span class="p">);</span><span class="w">  </span><span class="c1">// Wake up all threads</span>
</code></pre></div>
<ul>
<li>
<p><strong>æ¡ä»¶å˜é‡çš„æ­£ç¡®æ‰“å¼€æ–¹å¼</strong></p>
<p><strong>ä½¿ç”¨ while å¾ªç¯å’Œ broadcast</strong></p>
<ul>
<li><strong>æ€»æ˜¯åœ¨å”¤é†’åå†æ¬¡æ£€æŸ¥åŒæ­¥æ¡ä»¶</strong></li>
<li><strong>æ€»æ˜¯å”¤é†’æ‰€æœ‰æ½œåœ¨å¯èƒ½è¢«å”¤é†’çš„äºº</strong></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">COND</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cv</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">assert</span><span class="p">(</span><span class="n">cond</span><span class="p">);</span>

<span class="p">...</span>

<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
</code></pre></div>
<p>åªè¦æœ‰æˆ‘å¯¹å…±äº«èµ„æºåšäº†ä¸€äº›æ”¹åŠ¨ï¼Œæˆ‘éƒ½å«é†’è¿™ä¸ªä¸–ç•Œçš„æ‰€æœ‰äººï¼ˆçº¿ç¨‹ï¼‰å»æ£€æŸ¥ä¸€ä¸‹è‡ªå·±çš„åŒæ­¥æ¡ä»¶ï¼ˆå¹¿æ’­ï¼‰ï¼Œå¦‚æœæ¡ä»¶æ»¡è¶³äº†ï¼Œé‚£å°±å¯ä»¥å»æ‰§è¡Œäº†ã€‚</p>
</li>
</ul>
<blockquote>
<p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªç‰ˆæœ¬ï¼šä½¿ç”¨çš„æ˜¯ <code>if</code> å’Œ <code>cond_signal</code> å»å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ï¼Œä½†æ˜¯éœ€è¦ä¸¤ä¸ªæ¡ä»¶å˜é‡ï¼Œå…·ä½“ä¸ºä»€ä¹ˆï¼Œç®€å•å°±æ˜¯ï¼šæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±åŒæ­¥æ¡ä»¶ã€‚æ¯ä¸€ä¸ªçº¿ç¨‹åŒæ­¥æ¡ä»¶ä¸ä¸€æ ·ã€‚ï¼ˆä¸¤ç±»ä¸åŒçš„çº¿ç¨‹ï¼šç”Ÿäº§è€…ã€æ¶ˆè´¹è€…ï¼‰</p>
<p>è¯¦ç»†å†…å®¹çœ‹æ•™æï¼š<a href="https://pages.cs.wisc.edu/~remzi/OSTEP/threads-cv.pdf">ç¬¬ 30 ç«  - Condition Variables</a></p>
</blockquote>
<p><strong><mark>å¯ä»¥è®°ä½è¿™ç§ä»£ç æ¨¡æ¿å†™æ³•ï¼Œæ€»èƒ½è§£å†³å¹¶å‘é—®é¢˜</mark></strong></p>
<h3 id="_15">åŒæ­¥æœºåˆ¶çš„åº”ç”¨</h3>
<p>è§£å†³åŒæ­¥é—®é¢˜çš„æ ¸å¿ƒï¼šå¼„æ¸…æ¥šåŒæ­¥æ¡ä»¶ã€‚</p>
<h4 id="_16">å¹¶è¡Œè®¡ç®—ï¼šå®ç°è®¡ç®—å›¾</h4>
<p>å¦‚æœç”¨å¤šå¤„ç†å™¨å¹¶è¡Œç¼–ç¨‹å®Œæˆå¾ˆå¤§çš„<strong>è®¡ç®—ä»»åŠ¡</strong>ï¼Œé¦–å…ˆè¦åšçš„å°±æ˜¯å°†ä»»åŠ¡åˆ†æˆè‹¥å¹²æ­¥ï¼šè®¡ç®—ä»»åŠ¡æ„æˆæœ‰å‘æ— ç¯å›¾</p>
<blockquote>
<p>é…åˆä¾‹å­å’Œå›¾ï¼ˆç®—ç´ æ•°è¡¨ï¼‰ï¼š</p>
<p><img src="pic/image-20250114215612517.png" alt="image-20250114215612517" style="zoom: 67%;" /></p>
</blockquote>
<ul>
<li>
<p>(u,v)âˆˆE(<em>u</em>,<em>v</em>)âˆˆ<em>E</em> è¡¨ç¤º v<em>v</em> è¦ç”¨åˆ°å‰ u<em>u</em> çš„å€¼</p>
</li>
<li>
<p><strong>åªè¦è°ƒåº¦å™¨ (ç”Ÿäº§è€…) åˆ†é…ä»»åŠ¡æ•ˆç‡å¤Ÿé«˜ï¼Œç®—æ³•å°±èƒ½å¹¶è¡Œ</strong></p>
<blockquote>
<p>è¿™æ˜¯ç‰©ç†å†…å­˜åˆ†é…çš„æƒ³æ³•å—ï¼Ÿè¿™ä¸ªè°ƒåº¦å™¨æ€ä¹ˆå®ç°ï¼Ÿå¾ˆé‡è¦ã€‚</p>
</blockquote>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">T_worker</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">consume</span><span class="p">().</span><span class="n">run</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">T_scheduler</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">jobs</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">jobs</span><span class="p">.</span><span class="n">find_ready</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">produce</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>
<p><strong>å®ç°</strong></p>
<ul>
<li>
<p>ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹</p>
<p>ç”Ÿäº§è€…éå†è®¡ç®—å›¾ï¼Œæ¶ˆè´¹è€…å®é™…åšè®¡ç®—ã€‚ï¼ˆä»¥ç´ æ•°è¡¨ä¸ºä¾‹ï¼Œéå†æ—¶é—´å‡ å¾®ç§’ï¼Œè®¡ç®—æ—¶é—´å‡ ç§’ï¼Œå°±å¾ˆå¥½ï¼‰</p>
<p>ç”Ÿäº§è€…éå†åï¼Œå°†ä¸€ä¸ªä¸ªä»»åŠ¡æ”¾è‡³ç¼“å†²åŒºä¸­ã€‚æ¯ä¸€ä¸ªæ¶ˆè´¹è€… worker å°±å»ç¼“å†²åŒºä¸­å–ä»»åŠ¡è®¡ç®—ã€‚</p>
<p><strong><mark>åªè¦èƒ½å°†ä»»åŠ¡åˆ†è§£æˆæœ‰å‘æ— ç¯å›¾çš„å½¢å¼ï¼Œç”¨ä¸€ä¸ªç”Ÿäº§è€…ï¼Œå¤šä¸ªæ¶ˆè´¹è€…å³å¯å®ç°å¤šä»»åŠ¡å¹¶è¡Œã€‚</mark></strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">// author: kimi</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pthread.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;queue&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;mutex&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;condition_variable&gt;</span>

<span class="n">std</span><span class="o">::</span><span class="n">queue</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">jobs</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="w"> </span><span class="n">mtx</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">condition_variable</span><span class="w"> </span><span class="n">cv</span><span class="p">;</span>
<span class="kt">bool</span><span class="w"> </span><span class="n">done</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">produce</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">job</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">mtx</span><span class="p">);</span>
<span class="w">    </span><span class="n">jobs</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">job</span><span class="p">);</span>
<span class="w">    </span><span class="n">cv</span><span class="p">.</span><span class="n">notify_one</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">consume</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">mtx</span><span class="p">);</span>
<span class="w">    </span><span class="n">cv</span><span class="p">.</span><span class="n">wait</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="o">!</span><span class="n">jobs</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">done</span><span class="p">;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">jobs</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="c1">// è¡¨ç¤ºæ²¡æœ‰æ›´å¤šä»»åŠ¡</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jobs</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
<span class="w">    </span><span class="n">jobs</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">job</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">T_worker</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">consume</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">job</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">// æ‰§è¡Œä»»åŠ¡</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Processing job: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">job</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// æ¨¡æ‹Ÿè®¡ç®—æ—¶é—´</span>
<span class="w">        </span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">T_scheduler</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">produce</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">done</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="n">cv</span><span class="p">.</span><span class="n">notify_all</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">num_workers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">pthread_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">workers</span><span class="p">(</span><span class="n">num_workers</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num_workers</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">workers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">))</span><span class="n">T_worker</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">T_scheduler</span><span class="p">();</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num_workers</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pthread_join</span><span class="p">(</span><span class="n">workers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<ol>
<li><strong>ç”Ÿäº§è€…ï¼ˆT_schedulerï¼‰</strong>ï¼š<ul>
<li>ç”Ÿæˆ 10 ä¸ªä»»åŠ¡ï¼Œå¹¶å°†å®ƒä»¬æ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—ä¸­ã€‚</li>
<li>è®¾ç½® <code>done</code> æ ‡å¿—ä¸º <code>true</code>ï¼Œè¡¨ç¤ºæ²¡æœ‰æ›´å¤šä»»åŠ¡ã€‚</li>
<li>é€šçŸ¥æ‰€æœ‰ç­‰å¾…çš„æ¶ˆè´¹è€…çº¿ç¨‹ã€‚</li>
</ul>
</li>
<li><strong>æ¶ˆè´¹è€…ï¼ˆT_workerï¼‰</strong>ï¼š<ul>
<li>ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡ã€‚</li>
<li>å¦‚æœä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºä¸” <code>done</code> æ ‡å¿—ä¸º <code>true</code>ï¼Œåˆ™é€€å‡ºå¾ªç¯ã€‚</li>
<li>å¤„ç†ä»»åŠ¡ï¼Œæ¨¡æ‹Ÿè®¡ç®—æ—¶é—´ã€‚</li>
</ul>
</li>
<li>å…³é”®ç‚¹<ul>
<li><strong>ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹</strong>ï¼šç”Ÿäº§è€…è´Ÿè´£ç”Ÿæˆä»»åŠ¡å¹¶æ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ¶ˆè´¹è€…ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡å¹¶æ‰§è¡Œã€‚</li>
<li><strong>æ¡ä»¶å˜é‡</strong>ï¼šç”¨äºçº¿ç¨‹é—´çš„åŒæ­¥ï¼Œç¡®ä¿æ¶ˆè´¹è€…çº¿ç¨‹åœ¨ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºæ—¶ç­‰å¾…ï¼Œç”Ÿäº§è€…çº¿ç¨‹åœ¨ç”Ÿæˆä»»åŠ¡åé€šçŸ¥æ¶ˆè´¹è€…çº¿ç¨‹ã€‚</li>
<li><strong>äº’æ–¥é”</strong>ï¼šä¿æŠ¤å…±äº«èµ„æºï¼ˆä»»åŠ¡é˜Ÿåˆ—ï¼‰çš„è®¿é—®ï¼Œç¡®ä¿çº¿ç¨‹å®‰å…¨ã€‚</li>
</ul>
</li>
</ol>
</li>
</ul>
<blockquote>
<p>more exampleï¼šçº¿ç¨‹æ± </p>
<p>æ¯ä¸€ä¸ª worker å°±æ˜¯ä¸€ä¸ªå·¥ä½œçš„çº¿ç¨‹ï¼ŒæŠŠä¸€ä¸ªä¸ªå°çš„ä»»åŠ¡æ”¾åˆ°çº¿ç¨‹æ± ï¼Œç„¶åçº¿ç¨‹æ± æœ‰ä¸ªè°ƒåº¦å™¨ï¼Œè°ƒåº¦å™¨å†å°†è¿™äº›ä»»åŠ¡å†åˆ†ç»™ workerã€‚</p>
</blockquote>
<p><strong>å½“ç„¶è¿˜èƒ½ç”¨æ¡ä»¶å˜é‡å®ç°åŒæ­¥</strong></p>
<ul>
<li>
<p>æ¡ä»¶å˜é‡</p>
<p>ä¸ºæ¯ä¸€ä¸ªè®¡ç®—èŠ‚ç‚¹éƒ½è®¾ç½®ä¸€ä¸ªæ¡ä»¶å˜é‡</p>
<div class="highlight"><pre><span></span><code><span class="c1">// kimi </span>
<span class="c1">// ä¸»è¦çœ‹é€»è¾‘</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;queue&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;mutex&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;condition_variable&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;thread&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;functional&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unordered_map&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;list&gt;</span>

<span class="c1">// ä»»åŠ¡èŠ‚ç‚¹</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">Task</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="n">func</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dependencies</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ready_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// è®¡ç®—å›¾</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ComputeGraph</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">addTask</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">dependencies</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">tasks</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="n">dependencies</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">};</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">dep</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">dependencies</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">task_dependencies</span><span class="p">[</span><span class="n">dep</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// åˆå§‹åŒ–å°±ç»ªä»»åŠ¡é˜Ÿåˆ—</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="p">[</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">task</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">tasks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">dependencies</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">ready_tasks</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// å¯åŠ¨è°ƒåº¦çº¿ç¨‹</span>
<span class="w">        </span><span class="n">scheduler_thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ComputeGraph</span><span class="o">::</span><span class="n">scheduler</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// å¯åŠ¨å·¥ä½œçº¿ç¨‹</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num_workers</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">workers</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ComputeGraph</span><span class="o">::</span><span class="n">worker</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// ç­‰å¾…è°ƒåº¦çº¿ç¨‹ç»“æŸ</span>
<span class="w">        </span><span class="n">scheduler_thread</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// ç­‰å¾…å·¥ä½œçº¿ç¨‹ç»“æŸ</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">worker</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">workers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">worker</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">Task</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tasks</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">task_dependencies</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">queue</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ready_tasks</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="w"> </span><span class="n">mtx</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">condition_variable</span><span class="w"> </span><span class="n">cv</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">done</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">&gt;</span><span class="w"> </span><span class="n">workers</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="w"> </span><span class="n">scheduler_thread</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">num_workers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">scheduler</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ready_tasks</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">task_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ready_tasks</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
<span class="w">            </span><span class="n">ready_tasks</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>

<span class="w">            </span><span class="c1">// é€šçŸ¥å·¥ä½œçº¿ç¨‹</span>
<span class="w">            </span><span class="n">cv</span><span class="p">.</span><span class="n">notify_one</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// è®¾ç½® done æ ‡å¿—ï¼Œé€šçŸ¥æ‰€æœ‰å·¥ä½œçº¿ç¨‹</span>
<span class="w">        </span><span class="n">done</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">        </span><span class="n">cv</span><span class="p">.</span><span class="n">notify_all</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">worker</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">mtx</span><span class="p">);</span>
<span class="w">            </span><span class="n">cv</span><span class="p">.</span><span class="n">wait</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="k">this</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="o">!</span><span class="n">ready_tasks</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">done</span><span class="p">;</span><span class="w"> </span><span class="p">});</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">done</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ready_tasks</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">task_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ready_tasks</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
<span class="w">            </span><span class="n">ready_tasks</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
<span class="w">            </span><span class="n">lock</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>

<span class="w">            </span><span class="c1">// æ‰§è¡Œä»»åŠ¡</span>
<span class="w">            </span><span class="n">tasks</span><span class="p">[</span><span class="n">task_id</span><span class="p">].</span><span class="n">func</span><span class="p">();</span>

<span class="w">            </span><span class="c1">// æ›´æ–°ä¾èµ–å…³ç³»</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">dependent_id</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">task_dependencies</span><span class="p">[</span><span class="n">task_id</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">mtx</span><span class="p">);</span>
<span class="w">                </span><span class="n">tasks</span><span class="p">[</span><span class="n">dependent_id</span><span class="p">].</span><span class="n">ready_count</span><span class="o">++</span><span class="p">;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tasks</span><span class="p">[</span><span class="n">dependent_id</span><span class="p">].</span><span class="n">ready_count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">tasks</span><span class="p">[</span><span class="n">dependent_id</span><span class="p">].</span><span class="n">dependencies</span><span class="p">.</span><span class="n">size</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">ready_tasks</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">dependent_id</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">task1</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Task 1&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">task2</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Task 2&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">task3</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Task 3&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">task4</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Task 4&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ComputeGraph</span><span class="w"> </span><span class="n">graph</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// æ·»åŠ ä»»åŠ¡</span>
<span class="w">    </span><span class="n">graph</span><span class="p">.</span><span class="n">addTask</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">task1</span><span class="p">,</span><span class="w"> </span><span class="p">{});</span>
<span class="w">    </span><span class="n">graph</span><span class="p">.</span><span class="n">addTask</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">task2</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">});</span>
<span class="w">    </span><span class="n">graph</span><span class="p">.</span><span class="n">addTask</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">task3</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">});</span>
<span class="w">    </span><span class="n">graph</span><span class="p">.</span><span class="n">addTask</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">task4</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">});</span>

<span class="w">    </span><span class="c1">// è¿è¡Œè®¡ç®—å›¾</span>
<span class="w">    </span><span class="n">graph</span><span class="p">.</span><span class="n">run</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</li>
<li>
<p>example</p>
</li>
</ul>
</li>
</ul>
<h4 id="_17">åœºæ™¯ï¼šåŠ¨æ€è§„åˆ’</h4>
<blockquote>
<p>è¿˜æœ‰å“ªäº›åœºæ™¯å¹¶è¡ŒåŠ é€Ÿï¼Ÿ
</p>
</blockquote>
<p><img alt="image-20250114164832957" src="pic/image-20250114164832957.png" /></p>
<p>å¦‚æœä¸€ä¸ªç®—æ³•çš„åä¸€æ­¥å®Œå…¨ä¾èµ–äºå‰ä¸€æ­¥ï¼Œé‚£è¿™ä¸ªç®—æ³•å°±ä¸å¥½å¹¶è¡Œçš„ã€‚æ‰€ä»¥è¦å°†è¿™ä¸ªæœ‰å‘æ— ç¯å›¾åšå¾—å¾ˆå®½å¾ˆå®½çš„ï¼Œè¦è¶³å¤Ÿå®½ã€‚</p>
<blockquote>
<p>è¿™å°±æœ‰ä¸ªé—®é¢˜ï¼Œæ€ä¹ˆçœ‹è¿™ä¸ªå¹¶è¡Œä¹‹åçš„æ€§èƒ½å’Œæ²¡å¹¶è¡Œçš„æ€§èƒ½å·®å¼‚ï¼Ÿé€šè¿‡ä»€ä¹ˆå·¥å…·ï¼Ÿä»€ä¹ˆæŒ‡æ ‡ï¼Ÿ</p>
</blockquote>
<p>ä¸€ä¸ªé¢è¯•é—®é¢˜ï¼šå¤šå¤„ç†å™¨å¾ˆæ™®åŠçš„æƒ…å†µä¸‹ï¼Œæ€ä¹ˆå°†ä¸€ä¸ªé—®é¢˜å¹¶è¡ŒåŠ é€Ÿï¼Ÿ</p>
<p>ç¬¬ä¸€ååº” åº”è¯¥æ˜¯ äº†è§£è®¡ç®—å›¾æ˜¯ä»€ä¹ˆï¼Œå®ƒçš„ç»“æ„æ˜¯ä»€ä¹ˆï¼Œå®ƒçš„åˆ‡åˆ†æ–¹æ³•ã€‚</p>
<blockquote>
<p>æ¥è‡ª AIï¼š</p>
<ol>
<li>
<p><strong>è®¡ç®—å›¾çš„æ¦‚å¿µ</strong></p>
</li>
<li>
<p>è®¡ç®—å›¾æ˜¯ä¸€ç§ç”¨äºè¡¨ç¤ºè®¡ç®—è¿‡ç¨‹çš„æœ‰å‘å›¾ã€‚åœ¨å›¾ä¸­ï¼ŒèŠ‚ç‚¹ï¼ˆé¡¶ç‚¹ï¼‰é€šå¸¸è¡¨ç¤ºæ“ä½œï¼ˆå¦‚åŠ æ³•ã€ä¹˜æ³•ç­‰ï¼‰æˆ–è€…å˜é‡ï¼ˆè¾“å…¥ã€ä¸­é—´ç»“æœã€è¾“å‡ºç­‰ï¼‰ï¼Œè¾¹è¡¨ç¤ºæ•°æ®çš„æµå‘ã€‚ä¾‹å¦‚ï¼Œåœ¨æ·±åº¦å­¦ä¹ ä¸­ï¼Œä¸€ä¸ªç®€å•çš„ç¥ç»ç½‘ç»œçš„å‰å‘ä¼ æ’­è¿‡ç¨‹å¯ä»¥è¡¨ç¤ºä¸ºè®¡ç®—å›¾ã€‚å‡è®¾æœ‰ä¸€ä¸ªä¸¤å±‚çš„ç¥ç»ç½‘ç»œï¼Œè¾“å…¥å±‚æœ‰ä¸€ä¸ªèŠ‚ç‚¹ ( x )ï¼Œéšè—å±‚æœ‰ä¸€ä¸ªèŠ‚ç‚¹ ( h )ï¼Œè¾“å‡ºå±‚æœ‰ä¸€ä¸ªèŠ‚ç‚¹ ( y )ã€‚å…¶ä¸­éšè—å±‚èŠ‚ç‚¹ ( h ) çš„è®¡ç®—æ˜¯ ( h = W_1x + b_1 )ï¼Œè¾“å‡ºå±‚èŠ‚ç‚¹ ( y ) çš„è®¡ç®—æ˜¯ ( y = W_2h + b_2 )ã€‚è¿™é‡Œ ( W_1, W_2, b_1, b_2 ) æ˜¯æƒé‡å’Œåç½®å‚æ•°ã€‚é‚£ä¹ˆè®¡ç®—å›¾ä¸­ä¼šæœ‰èŠ‚ç‚¹ ( x, h, y ) ä»¥åŠå¯¹åº”çš„æƒé‡å’Œåç½®èŠ‚ç‚¹ï¼Œè¾¹è¡¨ç¤ºæ•°æ®ä»è¾“å…¥å±‚æµå‘éšè—å±‚ï¼Œå†ä»éšè—å±‚æµå‘è¾“å‡ºå±‚ã€‚</p>
</li>
<li>
<p>è®¡ç®—å›¾åœ¨æ•°æ®æµç¼–ç¨‹æ¨¡å‹ä¸­éå¸¸é‡è¦ã€‚å®ƒèƒ½å¤Ÿæ¸…æ™°åœ°æè¿°æ•°æ®æ˜¯å¦‚ä½•åœ¨å„ä¸ªæ“ä½œä¹‹é—´æµåŠ¨çš„ï¼Œä»¥åŠå„ä¸ªæ“ä½œä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚è¿™ç§å›¾ç»“æ„ä½¿å¾—å¹¶è¡Œè®¡ç®—å’Œè‡ªåŠ¨å¾®åˆ†ç­‰æ“ä½œå˜å¾—æ–¹ä¾¿ã€‚ä¾‹å¦‚ï¼Œåœ¨è‡ªåŠ¨å¾®åˆ†ä¸­ï¼Œé€šè¿‡è®¡ç®—å›¾å¯ä»¥å¾ˆå®¹æ˜“åœ°åº”ç”¨é“¾å¼æ³•åˆ™æ¥è®¡ç®—æ¢¯åº¦ï¼Œå› ä¸ºå›¾çš„ç»“æ„å·²ç»æ˜ç¡®äº†æ“ä½œçš„é¡ºåºå’Œä¾èµ–å…³ç³»ã€‚</p>
</li>
<li>
<p><strong>åˆ‡åˆ†è®¡ç®—å›¾</strong></p>
</li>
<li>
<p>ä»»åŠ¡åˆ’åˆ†ï¼šæ ¹æ®è®¡ç®—å›¾çš„ç»“æ„ï¼Œå°†è®¡ç®—ä»»åŠ¡åˆ’åˆ†åˆ°ä¸åŒçš„å¤„ç†å™¨ä¸Šã€‚å¯ä»¥é‡‡ç”¨å‡ ç§å¸¸è§çš„åˆ‡åˆ†æ–¹æ³•ï¼š</p>
<ul>
<li><strong>æŒ‰èŠ‚ç‚¹åˆ’åˆ†</strong>ï¼šå°†è®¡ç®—å›¾ä¸­çš„èŠ‚ç‚¹ï¼ˆæ“ä½œï¼‰åˆ†é…ç»™ä¸åŒçš„å¤„ç†å™¨ã€‚ä¾‹å¦‚ï¼Œåœ¨æ·±åº¦å­¦ä¹ çš„ç¥ç»ç½‘ç»œå‰å‘ä¼ æ’­è®¡ç®—å›¾ä¸­ï¼Œå¯ä»¥å°†ä¸åŒå±‚çš„æ“ä½œåˆ†é…åˆ°ä¸åŒçš„å¤„ç†å™¨ã€‚å¦‚æœæ˜¯ä¸€ä¸ªæœ‰ 10 å±‚çš„ç¥ç»ç½‘ç»œï¼Œå¯ä»¥å°†å‰ 5 å±‚çš„æ“ä½œåˆ†é…ç»™å¤„ç†å™¨ 1ï¼Œå 5 å±‚çš„æ“ä½œåˆ†é…ç»™å¤„ç†å™¨ 2ã€‚ä½†æ˜¯è¿™ç§æ–¹æ³•éœ€è¦è€ƒè™‘æ•°æ®ä¼ è¾“çš„å¼€é”€ï¼Œå› ä¸ºä¸åŒå±‚ä¹‹é—´å¯èƒ½éœ€è¦ä¼ è¾“æ•°æ®ã€‚</li>
<li><strong>æŒ‰è¾¹åˆ’åˆ†</strong>ï¼šå¦‚æœè®¡ç®—å›¾ä¸­çš„è¾¹ä»£è¡¨æ•°æ®ä¼ è¾“ï¼Œå¯ä»¥è€ƒè™‘æŒ‰ç…§æ•°æ®ä¼ è¾“çš„è·¯å¾„æ¥åˆ’åˆ†ä»»åŠ¡ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ªæ•°æ®æµå›¾ä¸­ï¼Œæ•°æ®ä»èŠ‚ç‚¹ A æµå‘èŠ‚ç‚¹ Bï¼Œå†æµå‘èŠ‚ç‚¹ Cã€‚å¯ä»¥å°† A åˆ° B çš„æ•°æ®å¤„ç†å’Œä¼ è¾“åˆ†é…ç»™ä¸€ä¸ªå¤„ç†å™¨ï¼ŒB åˆ° C çš„å¤„ç†å’Œä¼ è¾“åˆ†é…ç»™å¦ä¸€ä¸ªå¤„ç†å™¨ã€‚è¿™ç§æ–¹æ³•é€‚ç”¨äºæ•°æ®ä¼ è¾“å’Œå¤„ç†ç´§å¯†ç›¸å…³çš„åœºæ™¯ã€‚</li>
<li><strong>åŒºåŸŸåˆ’åˆ†</strong>ï¼šå¯¹äºä¸€äº›å…·æœ‰ç©ºé—´å±€éƒ¨æ€§çš„è®¡ç®—å›¾ï¼Œå¦‚å›¾åƒå¤„ç†ä¸­çš„åƒç´ æ“ä½œè®¡ç®—å›¾ï¼Œå¯ä»¥æŒ‰ç…§å›¾åƒçš„åŒºåŸŸæ¥åˆ’åˆ†ä»»åŠ¡ã€‚å°†å›¾åƒåˆ†æˆå¤šä¸ªåŒºåŸŸï¼Œæ¯ä¸ªå¤„ç†å™¨è´Ÿè´£ä¸€ä¸ªåŒºåŸŸå†…çš„åƒç´ æ“ä½œã€‚è¿™ç§æ–¹æ³•å¯ä»¥å‡å°‘æ•°æ®ä¼ è¾“ï¼Œå› ä¸ºç›¸é‚»åƒç´ ä¹‹é—´çš„æ“ä½œå¾€å¾€æœ‰æ•°æ®å±€éƒ¨æ€§ã€‚</li>
</ul>
</li>
<li>
<p><strong>è´Ÿè½½å‡è¡¡</strong>ï¼šåœ¨åˆ‡åˆ†è®¡ç®—å›¾æ—¶ï¼Œè¦å°½é‡ä¿è¯å„ä¸ªå¤„ç†å™¨çš„è´Ÿè½½å‡è¡¡ã€‚å¦‚æœä¸€ä¸ªå¤„ç†å™¨åˆ†é…åˆ°çš„ä»»åŠ¡é‡è¿‡å¤§ï¼Œè€Œå…¶ä»–å¤„ç†å™¨ä»»åŠ¡é‡è¿‡å°ï¼Œä¼šå¯¼è‡´å¤„ç†å™¨ä¹‹é—´ç­‰å¾…ï¼Œé™ä½æ•´ä½“æ•ˆç‡ã€‚å¯ä»¥é€šè¿‡ä¼°ç®—æ¯ä¸ªæ“ä½œçš„è®¡ç®—å¤æ‚åº¦æ¥åˆ†é…ä»»åŠ¡ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ªè®¡ç®—å›¾ä¸­ï¼Œæœ‰äº›æ“ä½œæ˜¯ç®€å•çš„åŠ æ³•ï¼Œæœ‰äº›æ“ä½œæ˜¯å¤æ‚çš„çŸ©é˜µæ±‚é€†ã€‚å¯ä»¥å°†è®¡ç®—å¤æ‚åº¦é«˜çš„æ“ä½œé€‚å½“åˆ†æ•£åˆ°ä¸åŒçš„å¤„ç†å™¨ä¸Šï¼Œä½¿æ¯ä¸ªå¤„ç†å™¨çš„è®¡ç®—æ—¶é—´å¤§è‡´ç›¸å½“ã€‚</p>
</li>
<li>
<p><strong>å¤„ç†æ•°æ®ä¼ è¾“å’ŒåŒæ­¥</strong></p>
</li>
<li>
<p>æ•°æ®ä¼ è¾“ä¼˜åŒ–</p>
<p>ï¼šåœ¨å¤šå¤„ç†å™¨å¹¶è¡Œè®¡ç®—ä¸­ï¼Œæ•°æ®ä¼ è¾“æ˜¯ä¸€ä¸ªå…³é”®é—®é¢˜ã€‚å½“è®¡ç®—å›¾è¢«åˆ‡åˆ†åˆ°ä¸åŒçš„å¤„ç†å™¨åï¼Œå¤„ç†å™¨ä¹‹é—´å¯èƒ½éœ€è¦ä¼ è¾“æ•°æ®ã€‚å¯ä»¥é‡‡ç”¨ä»¥ä¸‹æ–¹æ³•ä¼˜åŒ–æ•°æ®ä¼ è¾“ï¼š</p>
<ul>
<li><strong>å‡å°‘ä¼ è¾“é‡</strong>ï¼šåªä¼ è¾“å¿…è¦çš„æ•°æ®ã€‚ä¾‹å¦‚ï¼Œåœ¨çŸ©é˜µä¹˜æ³•å¹¶è¡Œè®¡ç®—ä¸­ï¼Œå¦‚æœå°†çŸ©é˜µ A<em>A</em> çš„ä¸åŒè¡Œåˆ†é…ç»™ä¸åŒçš„å¤„ç†å™¨ï¼Œé‚£ä¹ˆæ¯ä¸ªå¤„ç†å™¨åªéœ€è¦ä¼ è¾“å®ƒæ‰€è´Ÿè´£è¡Œç›¸å…³çš„æ•°æ®ï¼Œè€Œä¸æ˜¯æ•´ä¸ªçŸ©é˜µ A<em>A</em>ã€‚</li>
<li><strong>ä½¿ç”¨é«˜æ•ˆä¼ è¾“åè®®</strong>ï¼šåœ¨åˆ†å¸ƒå¼è®¡ç®—ç¯å¢ƒä¸­ï¼Œå¯ä»¥ä½¿ç”¨ MPIï¼ˆMessage Passing Interfaceï¼‰ç­‰é«˜æ•ˆçš„é€šä¿¡åè®®æ¥ä¼ è¾“æ•°æ®ã€‚MPI æä¾›äº†ä¸°å¯Œçš„é€šä¿¡æ“ä½œï¼Œå¦‚ç‚¹å¯¹ç‚¹é€šä¿¡ã€é›†ä½“é€šä¿¡ï¼ˆå¦‚å¹¿æ’­ã€å½’çº¦ç­‰ï¼‰ï¼Œå¯ä»¥é’ˆå¯¹ä¸åŒçš„æ•°æ®ä¼ è¾“éœ€æ±‚é€‰æ‹©åˆé€‚çš„é€šä¿¡æ“ä½œã€‚</li>
</ul>
</li>
<li>
<p><strong>åŒæ­¥æœºåˆ¶</strong>ï¼šä¸ºäº†ä¿è¯è®¡ç®—çš„æ­£ç¡®æ€§ï¼Œéœ€è¦åœ¨å¤„ç†å™¨ä¹‹é—´è¿›è¡ŒåŒæ­¥ã€‚å¯ä»¥ä½¿ç”¨äº’æ–¥é”ã€ä¿¡å·é‡ã€å±éšœï¼ˆBarrierï¼‰ç­‰åŒæ­¥åŸè¯­ã€‚ä¾‹å¦‚ï¼Œåœ¨è®¡ç®—å›¾ä¸­ï¼Œå¦‚æœä¸€ä¸ªæ“ä½œä¾èµ–äºå¤šä¸ªå…¶ä»–æ“ä½œçš„ç»“æœï¼Œå¯ä»¥åœ¨è¿™äº›æ“ä½œæ‰§è¡Œå®Œæ¯•åï¼Œé€šè¿‡å±éšœåŒæ­¥ï¼Œç¡®ä¿æ‰€æœ‰ä¾èµ–çš„æ“ä½œéƒ½å®Œæˆåï¼Œå†æ‰§è¡Œå½“å‰æ“ä½œã€‚åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå¯ä»¥ä½¿ç”¨äº’æ–¥é”æ¥æ§åˆ¶å¯¹å…±äº«èµ„æºï¼ˆå¦‚è®¡ç®—å›¾ä¸­çš„ä¸­é—´ç»“æœå­˜å‚¨åŒºï¼‰çš„è®¿é—®ï¼Œé˜²æ­¢æ•°æ®ç«äº‰ã€‚</p>
</li>
<li>
<p><strong>è®¡ç®—å›¾æ‰€å±çš„çŸ¥è¯†é¢†åŸŸ</strong></p>
</li>
<li>
<p><strong>æ•°æ®ç»“æ„ä¸ç®—æ³•</strong>ï¼šè®¡ç®—å›¾æœ¬èº«æ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œå®ƒç”¨å›¾çš„å½¢å¼æ¥ç»„ç»‡æ•°æ®å’Œæ“ä½œã€‚åœ¨æ•°æ®ç»“æ„ä¸­ï¼Œå›¾æ˜¯ä¸€ç§åŸºæœ¬çš„æ•°æ®ç»“æ„ï¼ŒåŒ…æ‹¬æœ‰å‘å›¾å’Œæ— å‘å›¾ç­‰ç±»å‹ã€‚è®¡ç®—å›¾æ˜¯å›¾çš„ä¸€ç§åº”ç”¨å½¢å¼ã€‚ä»ç®—æ³•è§’åº¦æ¥çœ‹ï¼Œå¯¹è®¡ç®—å›¾çš„æ“ä½œï¼Œå¦‚éå†ï¼ˆç”¨äºå‰å‘ä¼ æ’­è®¡ç®—ç»“æœæˆ–è€…åå‘ä¼ æ’­è®¡ç®—æ¢¯åº¦ï¼‰ã€æ‹“æ‰‘æ’åºï¼ˆç¡®å®šæ“ä½œçš„æ‰§è¡Œé¡ºåºï¼Œç‰¹åˆ«æ˜¯åœ¨æœ‰ä¾èµ–å…³ç³»çš„æ“ä½œä¸­ï¼‰ç­‰éƒ½æ¶‰åŠåˆ°ç®—æ³•çŸ¥è¯†ã€‚ä¾‹å¦‚ï¼Œæ‹“æ‰‘æ’åºç®—æ³•å¯ä»¥ç”¨äºç¡®å®šåœ¨è®¡ç®—å›¾ä¸­å„ä¸ªèŠ‚ç‚¹ï¼ˆæ“ä½œï¼‰çš„æ‰§è¡Œé¡ºåºï¼Œç¡®ä¿åœ¨æ‰§è¡Œä¸€ä¸ªæ“ä½œä¹‹å‰ï¼Œå…¶ä¾èµ–çš„æ‰€æœ‰æ“ä½œéƒ½å·²ç»å®Œæˆã€‚</p>
</li>
<li><strong>è®¡ç®—æœºä½“ç³»ç»“æ„å’Œæ“ä½œç³»ç»Ÿ</strong>ï¼šå½“æ¶‰åŠåˆ°å¤šçº¿ç¨‹è®¡ç®—å›¾æ—¶ï¼Œå°±åƒé¢˜ç›®ä¸­æåˆ°çš„ä½¿ç”¨äº’æ–¥é”æ¥å®ç°è®¡ç®—å›¾çš„è®¡ç®—ï¼Œè¿™å°±å’Œæ“ä½œç³»ç»Ÿä¸­çš„çº¿ç¨‹åŒæ­¥æœºåˆ¶ç›¸å…³ã€‚äº’æ–¥é”æ˜¯æ“ä½œç³»ç»Ÿæä¾›çš„ä¸€ç§åŒæ­¥åŸè¯­ï¼Œç”¨äºä¿è¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å¯¹å…±äº«èµ„æºçš„äº’æ–¥è®¿é—®ã€‚åœ¨è®¡ç®—å›¾çš„å¤šçº¿ç¨‹å®ç°ä¸­ï¼Œé€šè¿‡åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­å¯¹äº’æ–¥é”è¿›è¡Œ acquireï¼ˆè·å–ï¼‰å’Œ releaseï¼ˆé‡Šæ”¾ï¼‰æ“ä½œï¼Œæ¥æ§åˆ¶è®¡ç®—å›¾ä¸­å„ä¸ªèŠ‚ç‚¹ï¼ˆæ“ä½œï¼‰çš„æ‰§è¡Œé¡ºåºï¼Œç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§å’Œæ“ä½œçš„æ­£ç¡®æ€§ã€‚è¿™ä½“ç°äº†æ“ä½œç³»ç»Ÿåœ¨å¤šçº¿ç¨‹ç¼–ç¨‹å’Œèµ„æºç®¡ç†æ–¹é¢çš„çŸ¥è¯†ã€‚</li>
<li>
<p><strong>å¹¶è¡Œè®¡ç®—å’Œåˆ†å¸ƒå¼è®¡ç®—</strong>ï¼šåœ¨å¤§è§„æ¨¡çš„è®¡ç®—ä»»åŠ¡ä¸­ï¼Œå¦‚æ·±åº¦å­¦ä¹ è®­ç»ƒï¼Œè®¡ç®—å›¾å¯ä»¥åˆ†å¸ƒåœ¨å¤šä¸ªå¤„ç†å™¨æˆ–è€…å¤šå°æœºå™¨ä¸Šè¿›è¡Œå¹¶è¡Œè®¡ç®—ã€‚è¿™å°±æ¶‰åŠåˆ°å¹¶è¡Œè®¡ç®—ä¸­çš„ä»»åŠ¡åˆ’åˆ†ã€æ•°æ®ä¼ è¾“ã€è´Ÿè½½å‡è¡¡ç­‰çŸ¥è¯†ã€‚ä¾‹å¦‚ï¼Œåœ¨åˆ†å¸ƒå¼è®­ç»ƒä¸­ï¼Œè®¡ç®—å›¾çš„ä¸åŒéƒ¨åˆ†å¯èƒ½åœ¨ä¸åŒçš„æœºå™¨ä¸Šæ‰§è¡Œï¼Œéœ€è¦é€šè¿‡ç½‘ç»œé€šä¿¡æ¥ä¼ è¾“æ•°æ®ï¼Œå¹¶ä¸”è¦åˆç†åœ°åˆ’åˆ†è®¡ç®—å›¾çš„ä»»åŠ¡åˆ°å„ä¸ªæœºå™¨ä¸Šï¼Œä»¥æé«˜è®¡ç®—æ•ˆç‡ã€‚</p>
</li>
<li>
<p><strong>åˆ©ç”¨å¤šå¤„ç†å™¨æ¶æ„ç‰¹æ€§</strong></p>
</li>
<li>
<p><strong>å¤šæ ¸å¤„ç†å™¨ä¼˜åŒ–</strong>ï¼šå¯¹äºå¤šæ ¸å¤„ç†å™¨ï¼Œå¯ä»¥åˆ©ç”¨çº¿ç¨‹åº“ï¼ˆå¦‚ POSIX çº¿ç¨‹åº“ pthreadsï¼‰æ¥åˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Œå¹¶å°†è®¡ç®—å›¾çš„ä»»åŠ¡åˆ†é…ç»™ä¸åŒçš„çº¿ç¨‹ã€‚æ¯ä¸ªçº¿ç¨‹å¯ä»¥åœ¨ä¸€ä¸ªæ ¸å¿ƒä¸Šæ‰§è¡Œï¼Œä»è€Œå®ç°å¹¶è¡ŒåŠ é€Ÿã€‚åŒæ—¶ï¼Œè¦è€ƒè™‘åˆ°ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ã€‚åœ¨å¤šæ ¸å¤„ç†å™¨ä¸­ï¼Œæ¯ä¸ªæ ¸å¿ƒæœ‰è‡ªå·±çš„ç¼“å­˜ï¼Œå½“å¤šä¸ªçº¿ç¨‹è®¿é—®å…±äº«æ•°æ®æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç¼“å­˜ä¸ä¸€è‡´ã€‚å¯ä»¥é€šè¿‡åˆç†çš„æ•°æ®åˆ†é…å’Œè®¿é—®æ¨¡å¼æ¥å‡å°‘ç¼“å­˜ä¸ä¸€è‡´çš„å½±å“ã€‚ä¾‹å¦‚ï¼Œå°½é‡è®©çº¿ç¨‹è®¿é—®æœ¬åœ°ç¼“å­˜ä¸­çš„æ•°æ®ï¼Œå‡å°‘è·¨æ ¸å¿ƒçš„ç¼“å­˜è®¿é—®ã€‚</p>
</li>
<li>
<p><strong>åˆ†å¸ƒå¼ç³»ç»Ÿä¼˜åŒ–</strong>ï¼šåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¯ä»¥åˆ©ç”¨å¤šå°æœºå™¨çš„å¤„ç†å™¨èµ„æºã€‚å¯ä»¥ä½¿ç”¨åˆ†å¸ƒå¼è®¡ç®—æ¡†æ¶ï¼ˆå¦‚ Apache Hadoopã€Apache Spark ç­‰ï¼‰æ¥ç®¡ç†è®¡ç®—ä»»åŠ¡ã€‚è¿™äº›æ¡†æ¶æä¾›äº†ä»»åŠ¡è°ƒåº¦ã€æ•°æ®å­˜å‚¨å’Œç®¡ç†ç­‰åŠŸèƒ½ã€‚ä¾‹å¦‚ï¼Œåœ¨ Spark ä¸­ï¼Œå¯ä»¥å°†è®¡ç®—å›¾çš„ä»»åŠ¡å®šä¹‰ä¸º RDDï¼ˆResilient Distributed Datasetï¼‰æ“ä½œï¼ŒSpark ä¼šè‡ªåŠ¨å°†è¿™äº›æ“ä½œåˆ†é…åˆ°ä¸åŒçš„èŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼Œå¹¶ä¸”å¤„ç†èŠ‚ç‚¹ä¹‹é—´çš„æ•°æ®ä¼ è¾“å’Œä»»åŠ¡è°ƒåº¦ã€‚åŒæ—¶ï¼Œè¦è€ƒè™‘åˆ°ç½‘ç»œå¸¦å®½å’Œå»¶è¿Ÿå¯¹åˆ†å¸ƒå¼è®¡ç®—çš„å½±å“ï¼Œåˆç†åœ°è®¾è®¡æ•°æ®å­˜å‚¨å’Œä¼ è¾“ç­–ç•¥ã€‚</p>
</li>
<li>
<p><strong>æ€»ç»“</strong></p>
</li>
<li>
<p>è®¡ç®—å›¾æ˜¯ä¸€ç§å¼ºå¤§çš„å·¥å…·ï¼Œç”¨äºè¡¨ç¤ºå’Œç®¡ç†å¤æ‚çš„è®¡ç®—è¿‡ç¨‹ã€‚å®ƒè·¨è¶Šäº†æ•°æ®ç»“æ„ä¸ç®—æ³•ã€è®¡ç®—æœºä½“ç³»ç»“æ„å’Œæ“ä½œç³»ç»Ÿã€å¹¶è¡Œè®¡ç®—å’Œåˆ†å¸ƒå¼è®¡ç®—ç­‰å¤šä¸ªçŸ¥è¯†é¢†åŸŸã€‚é€šè¿‡åˆç†åœ°æ„å»ºå’Œæ“ä½œè®¡ç®—å›¾ï¼Œå¯ä»¥å®ç°é«˜æ•ˆçš„è®¡ç®—ï¼Œç‰¹åˆ«æ˜¯åœ¨æ·±åº¦å­¦ä¹ ç­‰éœ€è¦å¤§é‡è®¡ç®—çš„é¢†åŸŸã€‚åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œåˆ©ç”¨äº’æ–¥é”ç­‰åŒæ­¥æœºåˆ¶æ¥æ§åˆ¶è®¡ç®—å›¾çš„æ‰§è¡Œï¼Œæ˜¯ç¡®ä¿è®¡ç®—æ­£ç¡®æ€§çš„é‡è¦æ‰‹æ®µã€‚</p>
</li>
</ol>
<p>æ¥è‡ª AIï¼š</p>
<ol>
<li>
<p>ä»»åŠ¡åˆ†è§£</p>
<p>å°†å¤§ä»»åŠ¡åˆ†è§£ä¸ºå¤šä¸ªå°ä»»åŠ¡æ˜¯å¹¶è¡ŒåŒ–çš„ç¬¬ä¸€æ­¥ã€‚è¿™äº›å°ä»»åŠ¡å¯ä»¥æ˜¯ç‹¬ç«‹çš„ï¼Œä¹Ÿå¯ä»¥å­˜åœ¨ä¾èµ–å…³ç³»ã€‚ä»»åŠ¡åˆ†è§£çš„ç›®æ ‡æ˜¯ç¡®ä¿æ¯ä¸ªä»»åŠ¡çš„è®¡ç®—é‡å¤§è‡´ç›¸ç­‰ï¼Œä»¥å®ç°è´Ÿè½½å‡è¡¡ã€‚</p>
<ul>
<li>
<p>ç¤ºä¾‹ï¼šçŸ©é˜µä¹˜æ³•</p>
<p>å‡è®¾ä½ éœ€è¦è®¡ç®—ä¸¤ä¸ªçŸ©é˜µçš„ä¹˜ç§¯ ( C = A \times B )ã€‚å¯ä»¥å°†çŸ©é˜µ ( A ) å’Œ ( B ) åˆ†è§£ä¸ºå¤šä¸ªå­çŸ©é˜µï¼Œæ¯ä¸ªå­çŸ©é˜µçš„ä¹˜ç§¯å¯ä»¥å¹¶è¡Œè®¡ç®—ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">matrix_multiply_parallel</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cp">#pragma omp parallel for</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">B</span><span class="p">[</span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</li>
</ul>
</li>
<li>
<p>ä½¿ç”¨å¹¶è¡Œç¼–ç¨‹æ¨¡å‹</p>
<p>é€‰æ‹©åˆé€‚çš„å¹¶è¡Œç¼–ç¨‹æ¨¡å‹å¯ä»¥å¤§å¤§ç®€åŒ–å¹¶è¡ŒåŒ–çš„å¤æ‚æ€§ã€‚å¸¸è§çš„å¹¶è¡Œç¼–ç¨‹æ¨¡å‹åŒ…æ‹¬ï¼š</p>
<ul>
<li>
<p><strong>OpenMP</strong>ï¼šç”¨äºå¤šçº¿ç¨‹å¹¶è¡Œç¼–ç¨‹ï¼Œæ”¯æŒ Cã€C++ å’Œ Fortranã€‚</p>
</li>
<li>
<p><strong>MPI</strong>ï¼šç”¨äºåˆ†å¸ƒå¼å†…å­˜å¹¶è¡Œç¼–ç¨‹ï¼Œé€‚ç”¨äºé«˜æ€§èƒ½è®¡ç®—é›†ç¾¤ã€‚</p>
</li>
<li>
<p><strong>CUDA</strong>ï¼šç”¨äº NVIDIA GPU çš„å¹¶è¡Œç¼–ç¨‹ï¼Œé€‚ç”¨äºé«˜æ€§èƒ½è®¡ç®—å’Œæœºå™¨å­¦ä¹ ã€‚</p>
</li>
<li>
<p><strong>Intel TBB</strong>ï¼šç”¨äºå¤šæ ¸ CPU çš„å¹¶è¡Œç¼–ç¨‹ï¼Œæä¾›é«˜çº§å¹¶è¡Œç®—æ³•å’Œæ•°æ®ç»“æ„ã€‚</p>
</li>
<li>
<p>ç¤ºä¾‹ï¼šOpenMP</p>
<p>ä½¿ç”¨ OpenMP å¯ä»¥è½»æ¾åœ°å°†å¾ªç¯å¹¶è¡ŒåŒ–ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;omp.h&gt;</span>
<span class="w">                                                                                </span>
<span class="kt">void</span><span class="w"> </span><span class="nf">compute</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cp">#pragma omp parallel for</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// è®¡ç®—ä»»åŠ¡</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</li>
</ul>
</li>
<li>
<p>è´Ÿè½½å‡è¡¡</p>
<p>ç¡®ä¿æ¯ä¸ªå¤„ç†å™¨çš„è´Ÿè½½å¤§è‡´ç›¸ç­‰ï¼Œä»¥é¿å…æŸäº›å¤„ç†å™¨è¿‡è½½è€Œå…¶ä»–å¤„ç†å™¨é—²ç½®ã€‚è´Ÿè½½å‡è¡¡å¯ä»¥é€šè¿‡é™æ€æˆ–åŠ¨æ€è°ƒåº¦å®ç°ã€‚</p>
<ul>
<li><strong>é™æ€è°ƒåº¦</strong>ï¼šåœ¨ä»»åŠ¡å¼€å§‹å‰ï¼Œå°†ä»»åŠ¡å‡åŒ€åˆ†é…ç»™æ¯ä¸ªå¤„ç†å™¨ã€‚</li>
<li>
<p><strong>åŠ¨æ€è°ƒåº¦</strong>ï¼šåœ¨è¿è¡Œæ—¶æ ¹æ®å¤„ç†å™¨çš„è´Ÿè½½æƒ…å†µåŠ¨æ€åˆ†é…ä»»åŠ¡ã€‚</p>
</li>
<li>
<p>ç¤ºä¾‹ï¼šåŠ¨æ€è°ƒåº¦</p>
<p>ä½¿ç”¨ OpenMP çš„åŠ¨æ€è°ƒåº¦ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;omp.h&gt;</span>
<span class="w">                                                                                </span>
<span class="kt">void</span><span class="w"> </span><span class="nf">compute</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cp">#pragma omp parallel for schedule(dynamic)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// è®¡ç®—ä»»åŠ¡</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</li>
</ul>
</li>
<li>
<p>å‡å°‘é€šä¿¡å¼€é”€</p>
<p>åœ¨å¹¶è¡Œè®¡ç®—ä¸­ï¼Œé€šä¿¡å¼€é”€æ˜¯ä¸€ä¸ªä¸»è¦çš„æ€§èƒ½ç“¶é¢ˆã€‚å°½é‡å‡å°‘å¤„ç†å™¨ä¹‹é—´çš„é€šä¿¡ï¼Œæˆ–è€…ä½¿ç”¨é«˜æ•ˆçš„é€šä¿¡ç®—æ³•å’Œåº“ã€‚</p>
<ul>
<li><strong>å±€éƒ¨æ€§ä¼˜åŒ–</strong>ï¼šç¡®ä¿æ¯ä¸ªå¤„ç†å™¨è®¿é—®çš„æ•°æ®å°½å¯èƒ½å±€éƒ¨åŒ–ï¼Œå‡å°‘å†…å­˜è®¿é—®å»¶è¿Ÿã€‚</li>
<li>
<p><strong>æ‰¹é‡é€šä¿¡</strong>ï¼šå°†å¤šä¸ªå°çš„é€šä¿¡æ“ä½œåˆå¹¶ä¸ºä¸€ä¸ªå¤§çš„é€šä¿¡æ“ä½œï¼Œå‡å°‘é€šä¿¡å¼€é”€ã€‚</p>
</li>
<li>
<p>ç¤ºä¾‹ï¼šæ‰¹é‡é€šä¿¡</p>
<p>ä½¿ç”¨ MPI è¿›è¡Œæ‰¹é‡é€šä¿¡ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;mpi.h&gt;</span>
<span class="w">                                                                                </span>
<span class="kt">void</span><span class="w"> </span><span class="nf">communicate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">MPI_Request</span><span class="w"> </span><span class="n">requests</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
<span class="w">    </span><span class="n">MPI_Status</span><span class="w"> </span><span class="n">statuses</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
<span class="w">                                                                                </span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">MPI_Isend</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_INT</span><span class="p">,</span><span class="w"> </span><span class="n">dest</span><span class="p">,</span><span class="w"> </span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">requests</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">                                                                                </span>
<span class="w">    </span><span class="n">MPI_Waitall</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">requests</span><span class="p">,</span><span class="w"> </span><span class="n">statuses</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</li>
</ul>
</li>
<li>
<p>ä½¿ç”¨å¹¶è¡Œç®—æ³•</p>
<p>é€‰æ‹©é€‚åˆå¹¶è¡ŒåŒ–çš„ç®—æ³•å¯ä»¥æ˜¾è‘—æé«˜æ€§èƒ½ã€‚ä¾‹å¦‚ï¼Œåˆ†æ²»ç®—æ³•ã€å½’å¹¶æ’åºã€å¿«é€Ÿæ’åºç­‰éƒ½å¯ä»¥å¹¶è¡ŒåŒ–ã€‚</p>
<ul>
<li>
<p>ç¤ºä¾‹ï¼šå¹¶è¡Œå½’å¹¶æ’åº</p>
<p>ä½¿ç”¨ OpenMP å®ç°å¹¶è¡Œå½’å¹¶æ’åºï¼š</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;omp.h&gt;</span>
<span class="w">                                                                                </span>
<span class="kt">void</span><span class="w"> </span><span class="nf">merge_sort_parallel</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">array</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">left</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">right</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">right</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">mid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">left</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">right</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">        </span><span class="cp">#pragma omp parallel sections</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="cp">#pragma omp section</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">merge_sort_parallel</span><span class="p">(</span><span class="n">array</span><span class="p">,</span><span class="w"> </span><span class="n">left</span><span class="p">,</span><span class="w"> </span><span class="n">mid</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="cp">#pragma omp section</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">merge_sort_parallel</span><span class="p">(</span><span class="n">array</span><span class="p">,</span><span class="w"> </span><span class="n">mid</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">right</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">merge</span><span class="p">(</span><span class="n">array</span><span class="p">,</span><span class="w"> </span><span class="n">left</span><span class="p">,</span><span class="w"> </span><span class="n">mid</span><span class="p">,</span><span class="w"> </span><span class="n">right</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</li>
</ul>
</li>
<li>
<p>åˆ©ç”¨ç¡¬ä»¶ç‰¹æ€§</p>
<p>å……åˆ†åˆ©ç”¨å¤šå¤„ç†å™¨ç¡¬ä»¶çš„ç‰¹æ€§ï¼Œå¦‚å¤šæ ¸ CPUã€GPUã€FPGA ç­‰ï¼Œå¯ä»¥è¿›ä¸€æ­¥æé«˜å¹¶è¡Œè®¡ç®—çš„æ•ˆç‡ã€‚</p>
<ul>
<li><strong>å¤šæ ¸ CPU</strong>ï¼šä½¿ç”¨ OpenMP æˆ– Intel TBB è¿›è¡Œå¤šçº¿ç¨‹å¹¶è¡Œç¼–ç¨‹ã€‚</li>
<li><strong>GPU</strong>ï¼šä½¿ç”¨ CUDA æˆ– OpenCL è¿›è¡Œå¹¶è¡Œè®¡ç®—ã€‚</li>
<li>
<p><strong>FPGA</strong>ï¼šä½¿ç”¨ç¡¬ä»¶æè¿°è¯­è¨€ï¼ˆHDLï¼‰è¿›è¡Œå®šåˆ¶åŒ–å¹¶è¡Œè®¡ç®—ã€‚</p>
</li>
<li>
<p>ç¤ºä¾‹ï¼šCUDA</p>
<p>ä½¿ç”¨ CUDA è¿›è¡Œå¹¶è¡Œè®¡ç®—ï¼š</p>
<p>```c
<strong>global</strong> void vector_add(int <em>a, int </em>b, int <em>c, int n) {
    int index = threadIdx.x + blockIdx.x * blockDim.x;
    if (index &lt; n) {
        c[index] = a[index] + b[index];
    }
}
int main() {
    int n = 1024;
    int </em>a, <em>b, </em>c;
    int <em>d_a, </em>d_b, *d_c;</p>
<div class="highlight"><pre><span></span><code>// åˆ†é…ä¸»æœºå†…å­˜
a = (int *)malloc(n * sizeof(int));
b = (int *)malloc(n * sizeof(int));
c = (int *)malloc(n * sizeof(int));

// åˆ†é…è®¾å¤‡å†…å­˜
cudaMalloc((void **)&amp;d_a, n * sizeof(int));
cudaMalloc((void **)&amp;d_b, n * sizeof(int));
cudaMalloc((void **)&amp;d_c, n * sizeof(int));

// åˆå§‹åŒ–æ•°æ®
for (int i = 0; i &lt; n; i++) {
    a[i] = i;
    b[i] = i;
}

// ä»ä¸»æœºå¤åˆ¶æ•°æ®åˆ°è®¾å¤‡
cudaMemcpy(d_a, a, n * sizeof(int), cudaMemcpyHostToDevice);
cudaMemcpy(d_b, b, n * sizeof(int), cudaMemcpyHostToDevice);

// å¯åŠ¨å†…æ ¸
int threadsPerBlock = 256;
int blocksPerGrid = (n + threadsPerBlock - 1) / threadsPerBlock;
vector_add&lt;&lt;&lt;blocksPerGrid, threadsPerBlock&gt;&gt;&gt;(d_a, d_b, d_c, n);

// ä»è®¾å¤‡å¤åˆ¶æ•°æ®åˆ°ä¸»æœº
cudaMemcpy(c, d_c, n * sizeof(int), cudaMemcpyDeviceToHost);

// é‡Šæ”¾è®¾å¤‡å†…å­˜
cudaFree(d_a);
cudaFree(d_b);
cudaFree(d_c);

// é‡Šæ”¾ä¸»æœºå†…å­˜
free(a);
free(b);
free(c);
return 0;
</code></pre></div>
<p>}
 ```</p>
</li>
</ul>
</li>
</ol>
</blockquote>
<h4 id="_18">ä¹ é¢˜/é¢è¯•é¢˜</h4>
<p>å¯¹äºè¿™ç§ä¸Šé¢çš„æ–¹æ³•ä¸å¥½è§£å†³çš„æ–¹æ³•ï¼Œå»æƒ³åŒæ­¥æ¡ä»¶æ˜¯ä»€ä¹ˆã€‚</p>
<p><img src="pic/image-20250114204356246.png" alt="image-20250114204356246" style="zoom: 67%;" /></p>
<blockquote>
<p><strong>å¥‡æ€ªçš„åŒæ­¥é—®é¢˜</strong>ï¼šæˆ‘ä»¬å¯ä»¥æ„é€ å‡º â€œå¥‡æ€ªâ€ çš„åŒæ­¥æ¡ä»¶ï¼Œä¾‹å¦‚æœ‰ä¸‰ç§çº¿ç¨‹ï¼Œåˆ†åˆ«æ­»å¾ªç¯æ‰“å° <code>&lt;</code>ã€<code>&gt;</code>ã€<code>_</code>ã€‚å¦‚ä½•åŒæ­¥è¿™äº›çº¿ç¨‹ï¼Œä½¿å¾—å±å¹•ä¸Šçœ‹åˆ°çš„æ€»æ˜¯ <code>&lt;&gt;&lt;_</code> å’Œ <code>&gt;&lt;&gt;_</code> çš„ç»„åˆï¼Ÿè€Œåªè¦æˆ‘ä»¬èƒ½åˆ—å‡ºåŒæ­¥æ¡ä»¶ï¼Œå°±å¯ä»¥ç›´æ¥ä½¿ç”¨æ¡ä»¶å˜é‡è§£å†³ã€‚</p>
</blockquote>
<p>è§‚å¯Ÿï¼Œçœ‹çœ‹å„ä¸ªå­—ç¬¦å‡ºç°çš„ä½ç½®ï¼Œéƒ½çŸ¥é“è¦æƒ³ç€æ‰¾åŒæ­¥æ¡ä»¶æ˜¯ä»€ä¹ˆï¼šæ¯ç§å­—ç¬¦å‡ºç°çš„ä½ç½®çš„è¦æ±‚ã€‚</p>
<p>ä»€ä¹ˆæ—¶å€™èƒ½æ‰“å° <code>&lt;</code>ï¼Ÿåœ¨å¼€å¤´/ <code>_</code>ã€<code>&gt;</code> åé¢ã€‚</p>
<p>ä»€ä¹ˆæ—¶å€™èƒ½æ‰“å° <code>&gt;</code>ï¼Ÿåœ¨å¼€å¤´/ <code>_</code>ã€<code>&lt;</code> åé¢ã€‚</p>
<p>ä»€ä¹ˆæ—¶å€™èƒ½æ‰“å° <code>_</code>ï¼Ÿå‡ºç°åœ¨æœ€åä¸€ä¸ªå­—ç¬¦ã€‚</p>
<p>è€å¸ˆç»™å‡ºçš„è¿›ä¸€æ­¥æ€»ç»“ï¼šéœ€è¦çŸ¥é“ä¸€ä¸ªæ‰“å°çš„ historyã€‚</p>
<p>ç”±å½“å‰çš„çŠ¶æ€ï¼ˆå†å²ï¼‰æ¥çœ‹æœªæ¥ä»€ä¹ˆå¯ä»¥åšä»€ä¹ˆä¸å¯ä»¥åšï¼ŸçŠ¶æ€æœºï¼</p>
<h3 id="summary_1">Summary</h3>
<p>å†æ¬¡å›é¡¾ï¼Œä»€ä¹ˆå«åŒæ­¥ï¼Ÿè®°ä½é‚£ä¸ªæ¼”å¥éŸ³ä¹çš„ä¾‹å­ã€‚ç®€å•ç†è§£å°±æ˜¯å¤§å®¶å›åˆ°åŒä¸€èµ·è·‘çº¿ï¼Œä¸€èµ·ç­‰æ‹ã€‚</p>
<p>æ¯ä¸€ä¸ªäººéƒ½æœ‰è‡ªå·±ç»§ç»­çš„æ¡ä»¶ã€‚</p>
<h2 id="2_1">å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥ï¼ˆ2ï¼‰</h2>
<h3 id="_19">ä¿¡å·é‡</h3>
<h4 id="_20">ä½¿ç”¨äº’æ–¥é”å®ç°åŒæ­¥</h4>
<ul>
<li>åˆ›å»ºé”æ—¶ï¼Œç«‹å³ â€œè·å¾—â€ å®ƒ (æ€»æ˜¯æˆåŠŸ)</li>
<li>å…¶ä»–äººæƒ³è¦è·å¾—æ—¶å°±ä¼šç­‰å¾…<ul>
<li>æ­¤æ—¶ release å°±å®ç°äº†åŒæ­¥</li>
</ul>
</li>
<li>ä¸€ä¸ªçº¿ç¨‹ä¸Šé”ï¼Œåœ¨å¦ä¸€ä¸ªçº¿ç¨‹è§£é”</li>
</ul>
<blockquote>
<ul>
<li>å…ˆæŠŠå•æ‰€é—¨éƒ½é”ä¸Š</li>
<li>çº¿ç¨‹åˆ°è¾¾ä»¥åç­‰å¾…</li>
<li>ç®¡ç†å‘˜æŠŠæ‰€æœ‰é—¨éƒ½æ‰“å¼€</li>
</ul>
</blockquote>
<h4 id="_21"><strong>ä½¿ç”¨äº’æ–¥é”å®ç°è®¡ç®—å›¾</strong></h4>
<blockquote>
<p>Acquire-Release å®ç°è®¡ç®—å›¾</p>
</blockquote>
<ul>
<li>ä¸ºæ¯ä¸€æ¡è¾¹ e=(u,v) åˆ†é…ä¸€ä¸ªäº’æ–¥é” </li>
<li>åˆå§‹æ—¶ï¼Œå…¨éƒ¨å¤„äºé”å®šçŠ¶æ€</li>
<li>å¯¹äºä¸€ä¸ªèŠ‚ç‚¹ï¼Œå®ƒéœ€è¦è·å¾—æ‰€æœ‰å…¥è¾¹çš„é”æ‰èƒ½ç»§ç»­<ul>
<li>å¯ä»¥ç›´æ¥è®¡ç®—çš„èŠ‚ç‚¹ç«‹å³å¼€å§‹è®¡ç®—</li>
</ul>
</li>
<li>è®¡ç®—å®Œæˆåï¼Œé‡Šæ”¾æ‰€æœ‰å‡ºè¾¹å¯¹åº”çš„é”</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="mi">1</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mi">2</span>
<span class="mi">2</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mi">3</span>
<span class="mi">2</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mi">4</span>
<span class="mi">2</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mi">5</span>
<span class="mi">4</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mi">6</span>
<span class="mi">5</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mi">6</span>
<span class="mi">4</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mi">7</span>
</code></pre></div>
<h4 id="_22">å®ç°ä¿¡å·é‡</h4>
<ul>
<li>
<p>Release-Acquire å®ç°äº† <strong>happens-before</strong></p>
<ul>
<li>Acquire = ç­‰å¾… token</li>
<li>Release = å‘å‡º token </li>
</ul>
</li>
<li>
<p>Token å¯ä»¥ç†è§£ä¸ºç°å®ç”Ÿæ´»ä¸­çš„ â€œèµ„æºâ€</p>
<ul>
<li>
<p>åœè½¦åœºï¼šåœè½¦ä½</p>
</li>
<li>
<p>æ¸¸æ³³é¦†ï¼š</p>
<p>è·å¾—æ‰‹ç¯ (token) çš„äººå¯ä»¥è¿›å…¥æ›´è¡£å®¤</p>
<blockquote>
<p>mutex å®ç° token ä¼¼ä¹æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ <code>token = 1</code> åªæœ‰ä¸€ä¸ªèµ„æº -&gt; ä¸€ä¸ªåœè½¦ä½/æ¸¸æ³³é¦†ä¸€ä¸ªäºº</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<p>è¿›ä¸€æ­¥æ”¹è¿›ï¼š</p>
<ul>
<li>
<p>ä¸€ä¸ªèƒ½ â€œè®¡æ•°â€ çš„ mutex:</p>
<ul>
<li>å‘ n ä¸ªæ‰‹ç¯ï¼</li>
<li>æ‰‹ç¯ = synchronization token</li>
<li>mutex æ˜¯ n=1 çš„ç‰¹æ®Šæƒ…å†µ</li>
</ul>
</li>
<li>
<p>Acquire</p>
<p>è·å¾—æ‰‹ç¯çš„åŒå­¦è¿›å…¥æ¸¸æ³³æ±  (æ‰‹ç¯ä¸å¤Ÿï¼Œç­‰å¾…)</p>
</li>
<li>
<p>Release</p>
<p>å½’è¿˜ä¸€ä¸ªæ‰‹ç¯ (ä¸€ä¸ªç­‰å¾…çš„åŒå­¦å°±èƒ½å¾—åˆ°æ‰‹ç¯äº†)</p>
</li>
</ul>
<blockquote>
<p>åœè½¦åœºæœ‰ n ä¸ªè½¦ä½</p>
<ul>
<li>Acquire: åœ¨æœ‰è½¦ä½æ—¶è¿›å…¥åœè½¦åœº</li>
<li>Release: å‡ºåœè½¦åœºï¼›è½¦ä½ + 1</li>
</ul>
</blockquote>
<p><strong>ç”¨è¿™ä¸ªä¾‹å­ç†è§£ä¿¡å·é‡å³å¯</strong></p>
<p>è¢‹å­é‡Œæœ‰ n ä¸ªçƒ</p>
<ul>
<li>Acquire: ä»è¢‹å­é‡Œå–ä¸€ä¸ªçƒ<ul>
<li>å¦‚æœæ²¡æœ‰çƒï¼Œéœ€è¦ç­‰å¾…ï¼Œç¡çœ </li>
</ul>
</li>
<li>Release: å‘è¢‹å­é‡Œæ”¾ä¸€ä¸ªçƒ<ul>
<li>å¦‚æœæœ‰äººåœ¨ç­‰å¾…ï¼Œç›´æ¥æŠŠçƒäº¤ç»™ä»–</li>
</ul>
</li>
<li>æ³¨æ„æˆ‘ä»¬å¯ä»¥æœ‰å¤šä¸ªå£è¢‹ï¼</li>
</ul>
<p>ä»¥å–çƒçš„ä¾‹å­ï¼ŒåŒæ­¥æ¡ä»¶å°±æ˜¯ç›’å­é‡Œæœ‰çƒï¼Œå°±èƒ½å–ï¼ˆPï¼‰ï¼Œæ²¡æœ‰å°±ç­‰å¾…ï¼Œç­‰åˆ°æ”¾çƒè¿›æ¥ï¼ˆVï¼‰ï¼Œç”±æ­¤å®ç°åŒæ­¥ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">P</span><span class="p">(</span><span class="n">sem_t</span><span class="w"> </span><span class="o">*</span><span class="n">sem</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// P - prolaag</span>
<span class="w">    </span><span class="c1">//     try + decrease/down/wait/acquire</span>
<span class="w">    </span><span class="n">atomic</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wait_until</span><span class="p">(</span><span class="n">sem</span><span class="o">-&gt;</span><span class="n">count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">sem</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">--</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">V</span><span class="p">(</span><span class="n">sem_t</span><span class="w"> </span><span class="o">*</span><span class="n">sem</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// V - verhoog</span>
<span class="w">    </span><span class="c1">//     increase/up/post/signal/release</span>
<span class="w">    </span><span class="n">atomic</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">sem</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>ä¿¡å·é‡å†…éƒ¨æœ‰ç€è¿™ä¸ª è®¡æ•°å™¨ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è¿ç»­çš„ releaseã€åŠ çƒè¿›å»ã€‚</p>
<h3 id="_23">ä½¿ç”¨ä¿¡å·é‡å®ç°åŒæ­¥</h3>
<h4 id="_24">å¤§éƒ¨åˆ†åº”ç”¨åœºæ™¯</h4>
<ol>
<li>
<p>å®ç°ä¸€æ¬¡ä¸´æ—¶çš„ happens-before: Aâ†’B</p>
<ul>
<li>Aâ†’V(s)â†’P(s)â†’B<ul>
<li>è¿™å°±æ˜¯åˆšæ‰çš„ â€œäº’æ–¥é”å®ç°åŒæ­¥â€</li>
</ul>
</li>
</ul>
</li>
<li>
<p>ç®¡ç†è®¡æ•°å‹èµ„æº</p>
<ul>
<li>æ¸¸æ³³æ± é‡Œçš„äººä¸èƒ½è¶…è¿‡ n ä¸ª</li>
<li>åœè½¦åœºé‡Œçš„è½¦ä¸èƒ½è¶…è¿‡ n ä¸ª</li>
<li>ä½†å¯ä»¥æœ‰å¤šä¸ª â€œåœè½¦åœºâ€ã€â€œæ¸¸æ³³æ± â€</li>
<li>æˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ›é€ å‡ºè½¦ä½</li>
</ul>
</li>
</ol>
<h4 id="1-join">ä¾‹å­ï¼ˆ1ï¼‰ï¼šä¿¡å·é‡å®ç°çº¿ç¨‹ join</h4>
<p>ä¸¤ç§æ–¹æ³•ï¼š</p>
<ul>
<li>ç”¨ä¸€ä¸ªä¿¡å·é‡å®ç°ä¸€æ¬¡ä¸´æ—¶çš„ happens-before</li>
<li>
<p>ç”¨ä¸€ä¸ªè®¡æ•°å‹ä¿¡å·é‡ç­‰å¾…æ•°é‡æ­£ç¡®çš„çº¿ç¨‹ç»“æŸã€‚</p>
</li>
<li>
<p>å½¢æˆ happens-before</p>
<ul>
<li>worker: V(done~t~)</li>
<li>main: P(done~1~)â†’P(done~2~)â€¦â†’P(done~T~)</li>
<li>æè¿°äº†ä¸€ä¸ª â€œè®¡ç®—å›¾â€</li>
</ul>
</li>
<li>
<p><strong>ä½¿ç”¨è®¡æ•°å‹èµ„æº</strong></p>
<ul>
<li>worker: V(done)</li>
<li>main: P(done)Ã—T</li>
</ul>
<p>èƒ½ç”¨ä¸€ä¸ªè®¡æ•°å™¨ï¼ˆä¸€ä¸ªæ•´æ•°ï¼‰æ¥è¡¨ç¤ºåŒæ­¥æ¡ä»¶çš„æ—¶å€™ï¼Œå³å¯ç”¨ä¿¡å·é‡å®ç°ç›¸å…³ä»»åŠ¡ã€‚</p>
</li>
</ul>
<h4 id="2-">ä¾‹å­ï¼ˆ2ï¼‰ï¼šä¿¡å·é‡å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…</h4>
<p>è®¾è®¡æ€è·¯</p>
<ul>
<li>è€ƒè™‘ â€œçƒâ€/â€œæ‰‹ç¯â€ (æ¯ä¸€å•ä½çš„ â€œ<strong>èµ„æº</strong>â€) æ˜¯ä»€ä¹ˆ</li>
<li>ç”Ÿäº§è€…/æ¶ˆè´¹è€… = æŠŠçƒä»ä¸€ä¸ªè¢‹å­é‡Œæ”¾åˆ°å¦ä¸€ä¸ªè¢‹å­é‡Œ</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">produce</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">P</span><span class="p">(</span><span class="o">&amp;</span><span class="n">empty</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;(&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">V</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fill</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">consume</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">P</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fill</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;)&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">V</span><span class="p">(</span><span class="o">&amp;</span><span class="n">empty</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<blockquote>
<p>æœ€åˆçš„æå‡ºå°±æ˜¯ä¸ºäº†å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…</p>
</blockquote>
<p>ç”Ÿäº§è€…æŠŠçƒä» empty å£è¢‹å–èµ°ï¼Œpush ä¹‹åæŠŠçƒæ”¾å…¥ filled å£è¢‹ï¼›</p>
<p>æ¶ˆè´¹è€…åˆ™æ°å¥½ç›¸åã€‚æ•´ä¸ªç³»ç»Ÿæ»¡è¶³ empty + filled + æ­£åœ¨æ‰“å°çš„çº¿ç¨‹ = ç¼“å†²åŒºå¤§å°çš„å…¨å±€çº¦æŸã€‚</p>
<h3 id="_25">ä¿¡å·é‡ã€æ¡ä»¶å˜é‡ã€åŒæ­¥</h3>
<p>lock ordering</p>
<p>æ€»ç»“</p>
<p>ä¿¡å·é‡çš„ä½¿ç”¨åœºæ™¯ï¼š</p>
<p>æ¡ä»¶å˜é‡çš„ä½¿ç”¨åœºæ™¯ï¼š</p>
<h2 id="_26">çœŸå®ä¸–ç•Œçš„å¹¶å‘ç¼–ç¨‹</h2>
<h3 id="_27">æˆ‘ä»¬èº«è¾¹çš„å¹¶å‘ç¼–ç¨‹</h3>
<h4 id="web-20">Web 2.0 æ—¶ä»£çš„å¹¶å‘ç¼–ç¨‹</h4>
<ul>
<li>
<p>é‚£ä¸ªæ—¶å€™çš„Challenges</p>
<ul>
<li>çº¿ç¨‹ (åœ¨ 1990s) å¼€é”€å¾ˆå¤§</li>
<li>çº¿ç¨‹åŒæ­¥å¾ˆéš¾å†™å¯¹</li>
</ul>
<p>æ—¢ç„¶å¾ˆéš¾ï¼Œé‚£æ€ä¹ˆåœ¨ <code>JavaScript</code> ä¸­å†™å¹¶å‘ç¨‹åºï¼Œé‚£å°±ä¸è®©å®ƒå¹¶å‘ï¼ˆå°±åƒäº’æ–¥é”é‚£æ ·ï¼Œä¸ºäº†è®©æˆ‘ä»¬ç†è§£ï¼Œä¸è®©å¤šçº¿ç¨‹å¹¶è¡Œï¼‰</p>
<p>åœ¨ <code>JavaScript</code> é‡Œï¼Œæ¯ä¸ªçº¿ç¨‹ä»£ç åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œç›¸å½“äº stop the world äº†ï¼Œä¹Ÿå°±ä¸ä¼šå‡ºç°å¹¶å‘é‡Œé¢çš„ä¸€äº› bugsï¼Œç›´åˆ°æ¯ä¸ªçº¿ç¨‹ä»£ç æ‰§è¡Œå®Œï¼ˆå‡½æ•°è¿”å›ï¼‰ã€‚</p>
<p>ä½†åˆå› ä¸ºå¼‚æ­¥æ“ä½œå’Œå›è°ƒå‡½æ•°çš„åŠŸèƒ½ï¼Œå³å¯å®ç°å¤šçº¿ç¨‹çš„ç¨‹åºã€‚å³ï¼š</p>
<p>å¯¹äºæ¯ä¸€ä¸ªäº‹ä»¶ä»»åŠ¡å‡†å¤‡ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œç­‰åˆ°æ•°æ®ï¼ˆè¿”å›ï¼‰å†æ‰§è¡Œå®ƒï¼Œè€Œå¯¹äºæœ¬çº¿ç¨‹/äº‹ä»¶ï¼Œé‚£å°±ç›´æ¥è¿”å›äº†æ‰§è¡Œåˆ«çš„äº‹ä»¶äº†ã€‚</p>
<blockquote>
<p>å¼‚æ­¥æ“ä½œï¼šåŒºåˆ«äºåŒæ­¥ï¼Œä¸ç”¨ä¸€èµ·ç­‰ï¼Œå¯ä»¥å…ˆè‡ªå·±åšè‡ªå·±çš„äº‹æƒ…ï¼Œç­‰åˆ°æŸä¸ªæ ‡å¿—æˆ–è€…äº‹ä»¶å‘ç”Ÿåå†å›æ¥åšæŸäº‹ã€‚è€Œå¼‚æ­¥æ“ä½œéƒ½ä¼šè·Ÿä¸€æ®µä»£ç ï¼ˆå°±æ˜¯å‰é¢å›æ¥åšåˆ°äº‹ï¼‰ï¼Œè¿™æ®µä»£ç å°±å«å›è°ƒå‡½æ•°ï¼ˆå›è°ƒï¼Œè¿è¡Œå®Œäº†å†å›æ¥è°ƒç”¨ï¼ŒçœŸçš„å¾ˆå½¢è±¡çš„è§£é‡Šå•Šï¼ï¼‰</p>
</blockquote>
<p>æ¯”å¦‚ï¼Œåœ¨è¿›è¡Œç½‘é¡µæœåŠ¡è¯·æ±‚çš„æ—¶å€™ï¼Œæ­£åœ¨ç­‰å¾…ç½‘ç»œè¿”å›çš„æ—¶å€™ï¼Œåˆ«çš„çº¿ç¨‹çš„äº‹ä»¶åˆå¯ä»¥å¼€å§‹æ‰§è¡Œäº†ï¼ˆçº¿ç¨‹åˆ‡æ¢ï¼‰ã€‚è€Œç›´åˆ°åˆšå¼€å§‹çš„é‚£ä¸ªçº¿ç¨‹çš„äº‹ä»¶ï¼Œç½‘é¡µè¿”å›ç»“æœï¼Œè‡ªç„¶æƒ³åˆ°çš„å°±æ˜¯ç»§ç»­æ‰§è¡Œä»£ç ï¼Œé‚£è¿™éƒ¨åˆ†ä¹Ÿå°±æ˜¯å›è°ƒå‡½æ•°äº†ã€‚</p>
<p>åŒç†ï¼Œå¯¹äºå¤šä¸ªçº¿ç¨‹éƒ½æ˜¯è¿™æ ·ã€‚ä½†æ˜¯åˆæ²¡æœ‰å¹¶å‘ï¼Œè¿™æ˜¯äº‹ä»¶é©±åŠ¨çš„ã€‚</p>
<p>ä¹Ÿå°±æ˜¯ä¸‹é¢çš„æ€»ç»“ã€‚</p>
<blockquote>
<p>æ¬¸ï¼Œé‚£åç¨‹èƒ½ä¸èƒ½æ›¿ä»£ä¸Šé¢çš„ callbackï¼Ÿ</p>
</blockquote>
</li>
<li>
<p><strong>Solution: Event-based concurrency (åŠ¨æ€è®¡ç®—å›¾)ã€</strong></p>
<ul>
<li>
<p>å…è®¸éšæ—¶åˆ›å»ºè®¡ç®—èŠ‚ç‚¹</p>
<ul>
<li>ä¾‹å¦‚ç½‘ç»œè¯·æ±‚ã€å®šæ—¶å™¨</li>
</ul>
</li>
<li>
<p>ç¦æ­¢è®¡ç®—èŠ‚ç‚¹å¹¶è¡Œ</p>
<ul>
<li>ç½‘ç»œè®¿é—®å å¤§éƒ¨åˆ†æ—¶é—´ï¼›æµè§ˆå™¨å†…è®¡ç®—åªæ˜¯å°éƒ¨åˆ†</li>
</ul>
</li>
<li>
<p>ä»¥äº‹ä»¶ä¸ºå•ä½è°ƒåº¦</p>
<ul>
<li><strong>äº‹ä»¶å¯ä»¥åœ¨æµè§ˆå™¨é‡Œçœ‹åˆ°ï¼</strong></li>
</ul>
<blockquote>
<p>æ‰€ä»¥ï¼Œæœ‰ä¸ªæµè§ˆå™¨å°±èƒ½åšå‰ç«¯å¼€å‘å“ˆå“ˆ</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>å·²ç»å¬äº†å¾ˆå¤šæ¬¡åˆ«äººè¯´è¿™ä¸ªäº‹ä»¶é©±åŠ¨ï¼Œå…ˆå€ŸåŠ© AI äº†è§£çœ‹çœ‹ï¼Œå†è¿ç§»åˆ°è‡ªå·±çš„é¡¹ç›®ä¸­ç©ç©ã€‚</p>
<blockquote>
<ol>
<li>
<p>äº‹ä»¶é©±åŠ¨ç¼–ç¨‹æ˜¯ä»€ä¹ˆ</p>
<p>äº‹ä»¶é©±åŠ¨ç¼–ç¨‹ï¼ˆEvent-Driven Programming, EDPï¼‰æ˜¯ä¸€ç§ç¼–ç¨‹èŒƒå¼ï¼Œå…¶ä¸­ç¨‹åºçš„æ‰§è¡Œæµç¨‹ç”±äº‹ä»¶çš„è§¦å‘å’Œå¤„ç†é©±åŠ¨ã€‚åœ¨è¿™ç§æ¨¡å‹ä¸­ï¼Œç¨‹åºä¼šç­‰å¾…ç‰¹å®šäº‹ä»¶çš„å‘ç”Ÿï¼Œç„¶åæ ¹æ®è¯¥äº‹ä»¶æ‰§è¡Œç›¸åº”çš„ä»£ç å—ã€‚è¿™äº›äº‹ä»¶å¯ä»¥æ˜¯ç”¨æˆ·è¾“å…¥ã€ç½‘ç»œæ•°æ®åŒ…åˆ°è¾¾ã€æ–‡ä»¶ç³»ç»Ÿå˜åŒ–ã€è®¡æ—¶å™¨åˆ°æœŸç­‰ã€‚äº‹ä»¶é©±åŠ¨ç¼–ç¨‹çš„æ ¸å¿ƒåœ¨äºäº‹ä»¶å¾ªç¯ï¼Œäº‹ä»¶å¾ªç¯æ˜¯ä¸€ä¸ªä¸æ–­è¿è¡Œçš„è¿‡ç¨‹ï¼Œè´Ÿè´£ç›‘å¬äº‹ä»¶ã€åˆ†å‘äº‹ä»¶å’Œå¤„ç†äº‹ä»¶ã€‚</p>
</li>
<li>
<p>åœ¨Cè¯­è¨€ä¸­å¦‚ä½•å®ç°äº‹ä»¶é©±åŠ¨ç¼–ç¨‹</p>
<p>åœ¨Cè¯­è¨€ä¸­ï¼Œäº‹ä»¶é©±åŠ¨ç¼–ç¨‹å¯ä»¥é€šè¿‡ä»¥ä¸‹å‡ ç§æ–¹å¼å®ç°ï¼š</p>
<ol>
<li>
<p>å›è°ƒå‡½æ•°ï¼ˆCallback Functionsï¼‰</p>
<p>å›è°ƒå‡½æ•°æ˜¯å®ç°äº‹ä»¶é©±åŠ¨ç¼–ç¨‹çš„åŸºç¡€ã€‚é€šè¿‡å°†å‡½æ•°æŒ‡é’ˆä½œä¸ºå‚æ•°ä¼ é€’ï¼Œå¯ä»¥åœ¨äº‹ä»¶å‘ç”Ÿæ—¶è°ƒç”¨ç›¸åº”çš„å¤„ç†å‡½æ•°ã€‚</p>
<p><strong>å®šä¹‰å’Œä½¿ç”¨å›è°ƒå‡½æ•°ï¼š</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">EventCallback</span><span class="p">)(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">onEvent</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// å¤„ç†äº‹ä»¶</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Event occurred with data: %sn&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">triggerEvent</span><span class="p">(</span><span class="n">EventCallback</span><span class="w"> </span><span class="n">callback</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">callback</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">callback</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">eventData</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Sample Event Data&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">triggerEvent</span><span class="p">(</span><span class="n">onEvent</span><span class="p">,</span><span class="w"> </span><span class="n">eventData</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</li>
<li>
<p>äº‹ä»¶å¾ªç¯ï¼ˆEvent Loopï¼‰</p>
<p>äº‹ä»¶å¾ªç¯æ˜¯äº‹ä»¶é©±åŠ¨ç¼–ç¨‹çš„æ ¸å¿ƒéƒ¨åˆ†ã€‚å®ƒè´Ÿè´£ä¸æ–­åœ°æ£€æŸ¥äº‹ä»¶æºï¼Œå¹¶è°ƒç”¨ç›¸åº”çš„å›è°ƒå‡½æ•°å¤„ç†äº‹ä»¶ã€‚</p>
<p><strong>åŸºæœ¬ç»“æ„ï¼š</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Event</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_event</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">event_handler</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</li>
<li>
<p>äº‹ä»¶é©±åŠ¨æ¡†æ¶ï¼ˆEvent-driven Frameworkï¼‰</p>
<p>Cè¯­è¨€ä¸­æœ‰ä¸€äº›å¼€æºçš„äº‹ä»¶é©±åŠ¨æ¡†æ¶ï¼Œä¾‹å¦‚libeventå’Œlibuvã€‚è¿™äº›æ¡†æ¶æä¾›äº†ä¸€äº›é«˜çº§çš„APIå’Œå·¥å…·ï¼Œä½¿å¾—äº‹ä»¶é©±åŠ¨ç¼–ç¨‹æ›´åŠ æ–¹ä¾¿å’Œé«˜æ•ˆã€‚<strong>ä½¿ç”¨libeventåº“ï¼š</strong></p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;event2/event.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="w">            </span>
<span class="kt">void</span><span class="w"> </span><span class="nf">onEvent</span><span class="p">(</span><span class="n">evutil_socket_t</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="kt">short</span><span class="w"> </span><span class="n">what</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Event occurredn&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="w">            </span>
<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">event_base</span><span class="w"> </span><span class="o">*</span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">event_base_new</span><span class="p">();</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">event</span><span class="w"> </span><span class="o">*</span><span class="n">ev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">event_new</span><span class="p">(</span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="n">EV_TIMEOUT</span><span class="o">|</span><span class="n">EV_PERSIST</span><span class="p">,</span><span class="w"> </span><span class="n">onEvent</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">timeval</span><span class="w"> </span><span class="n">tv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">};</span>
<span class="w">    </span><span class="n">event_add</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>
<span class="w">    </span><span class="n">event_base_dispatch</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
<span class="w">    </span><span class="n">event_free</span><span class="p">(</span><span class="n">ev</span><span class="p">);</span>
<span class="w">    </span><span class="n">event_base_free</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</li>
</ol>
</li>
<li>
<p>äº‹ä»¶é©±åŠ¨ç¼–ç¨‹åœ¨Cè¯­è¨€ä¸­çš„åº”ç”¨</p>
<p>äº‹ä»¶é©±åŠ¨ç¼–ç¨‹åœ¨Cè¯­è¨€ä¸­æœ‰å¹¿æ³›çš„åº”ç”¨ï¼Œä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„åº”ç”¨åœºæ™¯ï¼š</p>
<ol>
<li>
<p>GUIç¼–ç¨‹</p>
<p>åœ¨GUIç¼–ç¨‹ä¸­ï¼ŒæŒ‰é’®ç‚¹å‡»ã€é¼ æ ‡ç§»åŠ¨ç­‰äº‹ä»¶éƒ½å¯ä»¥é€šè¿‡å›è°ƒå‡½æ•°æ¥å¤„ç†ã€‚</p>
</li>
<li>
<p>ç½‘ç»œç¼–ç¨‹</p>
<p>åœ¨ç½‘ç»œç¼–ç¨‹ä¸­ï¼Œæ•°æ®æ¥æ”¶ã€è¿æ¥å»ºç«‹ç­‰äº‹ä»¶ä¹Ÿå¯é€šè¿‡å›è°ƒå‡½æ•°å¤„ç†ã€‚</p>
</li>
<li>
<p>ç¡¬ä»¶é©±åŠ¨ç¨‹åº</p>
<p>åœ¨ç¡¬ä»¶é©±åŠ¨ç¨‹åºä¸­ï¼Œè®¾å¤‡ä¸­æ–­ã€æ•°æ®è¯»å–ç­‰äº‹ä»¶å¯ä»¥é€šè¿‡äº‹ä»¶é©±åŠ¨ç¼–ç¨‹æ¥å¤„ç†ã€‚</p>
</li>
<li>
<p>å®šæ—¶å™¨äº‹ä»¶</p>
<p>å¯ä»¥ä½¿ç”¨POSIXå®šæ—¶å™¨å®ç°å®šæ—¶äº‹ä»¶ï¼Œå¹¶åœ¨å®šæ—¶å™¨è§¦å‘æ—¶è°ƒç”¨å›è°ƒå‡½æ•°å¤„ç†äº‹ä»¶ã€‚</p>
</li>
</ol>
</li>
<li>
<p>æ€»ç»“</p>
<p>äº‹ä»¶é©±åŠ¨ç¼–ç¨‹æ˜¯ä¸€ç§çµæ´»ä¸”é«˜æ•ˆçš„ç¼–ç¨‹èŒƒå¼ï¼Œç‰¹åˆ«é€‚ç”¨äºéœ€è¦å¤„ç†å¤šä¸ªå¼‚æ­¥äº‹ä»¶çš„åº”ç”¨ç¨‹åºã€‚åœ¨Cè¯­è¨€ä¸­ï¼Œå¯ä»¥é€šè¿‡å›è°ƒå‡½æ•°ã€äº‹ä»¶å¾ªç¯å’Œäº‹ä»¶é©±åŠ¨æ¡†æ¶æ¥å®ç°äº‹ä»¶é©±åŠ¨ç¼–ç¨‹ã€‚è¿™äº›æŠ€æœ¯å¯ä»¥æ„å»ºçµæ´»ã€é«˜æ•ˆçš„äº‹ä»¶é©±åŠ¨ç³»ç»Ÿï¼Œé€‚ç”¨äºå„ç§åº”ç”¨åœºæ™¯ã€‚</p>
</li>
</ol>
</blockquote>
<p><strong>åœ¨ PA ä¸­åº”è¯¥ä¹Ÿè§åˆ°è¿‡ç±»ä¼¼äº‹ä»¶é©±åŠ¨/å›è°ƒçš„å†…å®¹ï¼šåŸºäºä¿¡å·å’Œå®šæ—¶å™¨çš„äº‹ä»¶é©±åŠ¨ï¼Œç”¨äºå‘¨æœŸæ€§çš„å‡ºå‘å›è°ƒå‡½æ•°ã€‚</strong></p>
<blockquote>
<p>å¯èƒ½ä¸æ˜¯ä¼ ç»Ÿçš„å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹ï¼ˆå¦‚åŸºäºçº¿ç¨‹æˆ–åç¨‹çš„å¼‚æ­¥æ“ä½œï¼‰ï¼Œä½†ä»æŸç§æ„ä¹‰ä¸Šæ¥è¯´ï¼Œå®ƒä¹Ÿå¯ä»¥è¢«è§†ä¸ºä¸€ç§â€œå¼‚æ­¥æ“ä½œâ€ï¼š</p>
<ol>
<li><strong>å¼‚æ­¥è§¦å‘ï¼š</strong><ul>
<li>å®šæ—¶å™¨çš„è§¦å‘æ˜¯å¼‚æ­¥çš„ï¼Œå®ƒä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹çš„æ‰§è¡Œã€‚ä¸»çº¿ç¨‹åœ¨è®¾ç½®å¥½å®šæ—¶å™¨åå¯ä»¥ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡ã€‚</li>
<li>ä¿¡å·å¤„ç†å™¨<code>alarm_sig_handler</code>ä¼šåœ¨å®šæ—¶å™¨åˆ°æœŸæ—¶è¢«å†…æ ¸è‡ªåŠ¨è°ƒç”¨ï¼Œè€Œä¸éœ€è¦ä¸»çº¿ç¨‹ä¸»åŠ¨è½®è¯¢ã€‚</li>
</ul>
</li>
<li><strong>å›è°ƒæœºåˆ¶ï¼š</strong><ul>
<li>é€šè¿‡å›è°ƒå‡½æ•°çš„æ–¹å¼ï¼Œç”¨æˆ·å¯ä»¥å®šä¹‰åœ¨å®šæ—¶å™¨åˆ°æœŸæ—¶éœ€è¦æ‰§è¡Œçš„æ“ä½œã€‚è¿™ç§åŸºäºå›è°ƒçš„æœºåˆ¶æ˜¯å¼‚æ­¥ç¼–ç¨‹çš„å…¸å‹ç‰¹å¾ã€‚</li>
</ul>
</li>
<li><strong>ä¸ä¸»çº¿ç¨‹è§£è€¦ï¼š</strong><ul>
<li>å®šæ—¶å™¨çš„è§¦å‘å’Œå›è°ƒå‡½æ•°çš„æ‰§è¡Œä¸ä¸»çº¿ç¨‹çš„æ‰§è¡Œé€»è¾‘è§£è€¦ã€‚ä¸»çº¿ç¨‹ä¸éœ€è¦ç­‰å¾…å®šæ—¶å™¨åˆ°æœŸï¼Œè€Œæ˜¯å¯ä»¥ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡ã€‚</li>
</ul>
</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="cp">#define MAX_HANDLER 8</span>

<span class="k">static</span><span class="w"> </span><span class="n">alarm_handler_t</span><span class="w"> </span><span class="n">handler</span><span class="p">[</span><span class="n">MAX_HANDLER</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">add_alarm_handle</span><span class="p">(</span><span class="n">alarm_handler_t</span><span class="w"> </span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAX_HANDLER</span><span class="p">);</span>
<span class="w">  </span><span class="n">handler</span><span class="p">[</span><span class="n">idx</span><span class="w"> </span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">alarm_sig_handler</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">signum</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">idx</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">handler</span><span class="p">[</span><span class="n">i</span><span class="p">]();</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">init_alarm</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">sigaction</span><span class="w"> </span><span class="n">s</span><span class="p">;</span>
<span class="w">  </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
<span class="w">  </span><span class="n">s</span><span class="p">.</span><span class="n">sa_handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alarm_sig_handler</span><span class="p">;</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sigaction</span><span class="p">(</span><span class="n">SIGVTALRM</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">  </span><span class="n">Assert</span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Can not set signal handler&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">itimerval</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">  </span><span class="n">it</span><span class="p">.</span><span class="n">it_value</span><span class="p">.</span><span class="n">tv_sec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="n">it</span><span class="p">.</span><span class="n">it_value</span><span class="p">.</span><span class="n">tv_usec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000000</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">TIMER_HZ</span><span class="p">;</span>
<span class="w">  </span><span class="n">it</span><span class="p">.</span><span class="n">it_interval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">it</span><span class="p">.</span><span class="n">it_value</span><span class="p">;</span>
<span class="w">  </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">setitimer</span><span class="p">(</span><span class="n">ITIMER_VIRTUAL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">it</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">  </span><span class="n">Assert</span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Can not set timer&quot;</span><span class="p">);</span>
<span class="p">}</span><span class="w">     </span>
</code></pre></div>
</blockquote>
<p>æˆ‘è§‰å¾—è¿™ç§é€šè¿‡ä¿¡å·å’Œå®šæ—¶å™¨å®ç°å¼‚æ­¥ä»»åŠ¡ï¼Œæ— éœ€åˆ›å»ºçº¿ç¨‹ï¼Œè¿˜æ˜¯æ¯”è¾ƒè½»é‡çº§çš„ï¼Œæ¯”è¾ƒé€‚åˆç®€å•çš„å‘¨æœŸæ€§ä»»åŠ¡ï¼Œé€‚åˆèµ„æºå—é™çš„åµŒå…¥å¼ç³»ç»Ÿã€‚</p>
<blockquote>
<p>ä¸ä¼ ç»Ÿå¼‚æ­¥ç¼–ç¨‹ç›¸æ¯”ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align: left;">ç‰¹æ€§</th>
<th style="text-align: left;">çº¿ç¨‹/åç¨‹å¼‚æ­¥</th>
<th style="text-align: left;">ä¿¡å·/å®šæ—¶å™¨å¼‚æ­¥</th>
<th style="text-align: left;">æ˜¾å¼äº‹ä»¶å¾ªç¯</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>å®ç°æ–¹å¼</strong></td>
<td style="text-align: left;">ä½¿ç”¨çº¿ç¨‹æˆ–åç¨‹</td>
<td style="text-align: left;">ä½¿ç”¨ä¿¡å·å’Œå®šæ—¶å™¨</td>
<td style="text-align: left;">ä½¿ç”¨å¾ªç¯å’Œå›è°ƒ</td>
</tr>
<tr>
<td style="text-align: left;"><strong>å¹¶å‘èƒ½åŠ›</strong></td>
<td style="text-align: left;">é«˜ï¼ˆå¤šçº¿ç¨‹/åç¨‹ï¼‰</td>
<td style="text-align: left;">ä½ï¼ˆå•çº¿ç¨‹ï¼‰</td>
<td style="text-align: left;">ä½ï¼ˆå•çº¿ç¨‹ï¼‰</td>
</tr>
<tr>
<td style="text-align: left;"><strong>èµ„æºæ¶ˆè€—</strong></td>
<td style="text-align: left;">é«˜ï¼ˆçº¿ç¨‹åˆ‡æ¢å¼€é”€ï¼‰</td>
<td style="text-align: left;">ä½ï¼ˆæ— çº¿ç¨‹åˆ‡æ¢ï¼‰</td>
<td style="text-align: left;">ä½ï¼ˆå•çº¿ç¨‹ï¼‰</td>
</tr>
<tr>
<td style="text-align: left;"><strong>é€‚ç”¨åœºæ™¯</strong></td>
<td style="text-align: left;">å¹¶è¡Œä»»åŠ¡å¤„ç†</td>
<td style="text-align: left;">å‘¨æœŸæ€§ä»»åŠ¡ã€èµ„æºå—é™ç³»ç»Ÿ</td>
<td style="text-align: left;">ç®€å•äº‹ä»¶é©±åŠ¨ç¨‹åº</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ä»£ç å¤æ‚åº¦</strong></td>
<td style="text-align: left;">é«˜ï¼ˆçº¿ç¨‹åŒæ­¥é—®é¢˜ï¼‰</td>
<td style="text-align: left;">ä½ï¼ˆç®€å•ä¿¡å·å¤„ç†ï¼‰</td>
<td style="text-align: left;">ä¸­ï¼ˆäº‹ä»¶å¾ªç¯é€»è¾‘ï¼‰</td>
</tr>
</tbody>
</table>
</blockquote>
<p>å¦å¤–ï¼Œæˆ‘è®°å¾—åµŒå…¥å¼é¢†åŸŸæœ‰ä¸ªå¸¸è§çš„ QP/C æ¡†æ¶ï¼Œå°±æ˜¯åŸºäºäº‹ä»¶é©±åŠ¨çš„ã€‚</p>
<blockquote>
<p>QP/Cæ¡†æ¶æ˜¯ä¸€ä¸ªè½»é‡çº§ã€å¼€æºçš„å®æ—¶åµŒå…¥å¼æ¡†æ¶ï¼ŒåŸºäºäº‹ä»¶é©±åŠ¨å’Œä¸»åŠ¨å¯¹è±¡ï¼ˆActive Objectsï¼‰æ¨¡å‹ï¼Œé€‚ç”¨äºæ„å»ºå¼‚æ­¥ã€äº‹ä»¶é©±åŠ¨çš„åµŒå…¥å¼ç³»ç»Ÿã€‚å®ƒé€šè¿‡äº‹ä»¶å¯¹è±¡åœ¨æ´»åŠ¨å¯¹è±¡ä¹‹é—´è¿›è¡Œå¼‚æ­¥é€šä¿¡ï¼Œé¿å…äº†ä¼ ç»Ÿå¹¶å‘æ¨¡å‹ä¸­çš„é˜»å¡å’Œå…±äº«çŠ¶æ€é—®é¢˜ã€‚</p>
</blockquote>
<p>æ›´å¤šå†…å®¹ï¼Œè¿˜æœ‰ä¸­æ–­ä¹Ÿæ˜¯å¼‚æ­¥çš„å‘€</p>
<blockquote>
<p>æ›´å¤šçš„å†…å®¹ï¼š</p>
<ol>
<li>
<p>GUIç¼–ç¨‹ä¸­çš„äº‹ä»¶é©±åŠ¨</p>
<p>åœ¨GUIç¼–ç¨‹ä¸­ï¼Œäº‹ä»¶é©±åŠ¨ç¼–ç¨‹æ˜¯æ ¸å¿ƒæœºåˆ¶ä¹‹ä¸€ã€‚å½“ç”¨æˆ·è¿›è¡Œæ“ä½œï¼ˆå¦‚ç‚¹å‡»æŒ‰é’®ã€ç§»åŠ¨é¼ æ ‡ï¼‰æ—¶ï¼Œç³»ç»Ÿä¼šç”Ÿæˆäº‹ä»¶ï¼Œå¹¶é€šè¿‡å›è°ƒå‡½æ•°å¤„ç†è¿™äº›äº‹ä»¶ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„åŸºäºGTKåº“ï¼ˆä¸€ä¸ªæµè¡Œçš„Cè¯­è¨€GUIåº“ï¼‰çš„ç¤ºä¾‹ã€‚ç¤ºä¾‹ä»£ç ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;gtk/gtk.h&gt;</span>

<span class="c1">// å›è°ƒå‡½æ•°ï¼šå¤„ç†æŒ‰é’®ç‚¹å‡»äº‹ä»¶</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">on_button_clicked</span><span class="p">(</span><span class="n">GtkWidget</span><span class="w"> </span><span class="o">*</span><span class="n">widget</span><span class="p">,</span><span class="w"> </span><span class="n">gpointer</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">g_print</span><span class="p">(</span><span class="s">&quot;Button clicked! Data: %sn&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">GtkWidget</span><span class="w"> </span><span class="o">*</span><span class="n">window</span><span class="p">;</span>
<span class="w">    </span><span class="n">GtkWidget</span><span class="w"> </span><span class="o">*</span><span class="n">button</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// åˆå§‹åŒ–GTK</span>
<span class="w">    </span><span class="n">gtk_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// åˆ›å»ºçª—å£</span>
<span class="w">    </span><span class="n">window</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gtk_window_new</span><span class="p">(</span><span class="n">GTK_WINDOW_TOPLEVEL</span><span class="p">);</span>
<span class="w">    </span><span class="n">gtk_window_set_title</span><span class="p">(</span><span class="n">GTK_WINDOW</span><span class="p">(</span><span class="n">window</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;Event-Driven GUI Example&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">gtk_window_set_default_size</span><span class="p">(</span><span class="n">GTK_WINDOW</span><span class="p">(</span><span class="n">window</span><span class="p">),</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span>
<span class="w">    </span><span class="n">g_signal_connect</span><span class="p">(</span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;destroy&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">G_CALLBACK</span><span class="p">(</span><span class="n">gtk_main_quit</span><span class="p">),</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// åˆ›å»ºæŒ‰é’®</span>
<span class="w">    </span><span class="n">button</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gtk_button_new_with_label</span><span class="p">(</span><span class="s">&quot;Click Me!&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">g_signal_connect</span><span class="p">(</span><span class="n">button</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;clicked&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">G_CALLBACK</span><span class="p">(</span><span class="n">on_button_clicked</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;Hello from GTK!&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// å°†æŒ‰é’®æ·»åŠ åˆ°çª—å£</span>
<span class="w">    </span><span class="n">gtk_container_add</span><span class="p">(</span><span class="n">GTK_CONTAINER</span><span class="p">(</span><span class="n">window</span><span class="p">),</span><span class="w"> </span><span class="n">button</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// æ˜¾ç¤ºæ‰€æœ‰çª—å£ç»„ä»¶</span>
<span class="w">    </span><span class="n">gtk_widget_show_all</span><span class="p">(</span><span class="n">window</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// è¿›å…¥ä¸»äº‹ä»¶å¾ªç¯</span>
<span class="w">    </span><span class="n">gtk_main</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<ol>
<li><strong>äº‹ä»¶å¾ªç¯</strong>ï¼š<code>gtk_main()</code>æ˜¯ä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼Œè´Ÿè´£ç›‘å¬å’Œåˆ†å‘äº‹ä»¶ã€‚</li>
<li><strong>å›è°ƒå‡½æ•°</strong>ï¼šé€šè¿‡<code>g_signal_connect</code>å°†äº‹ä»¶ï¼ˆå¦‚æŒ‰é’®ç‚¹å‡»ï¼‰ç»‘å®šåˆ°å›è°ƒå‡½æ•°ã€‚</li>
<li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šé€‚ç”¨äºéœ€è¦ä¸ç”¨æˆ·äº¤äº’çš„å›¾å½¢ç•Œé¢ç¨‹åºã€‚</li>
</ol>
</li>
<li>
<p>ç½‘ç»œç¼–ç¨‹ä¸­çš„äº‹ä»¶é©±åŠ¨</p>
<p>åœ¨ç½‘ç»œç¼–ç¨‹ä¸­ï¼Œäº‹ä»¶é©±åŠ¨ç¼–ç¨‹å¸¸ç”¨äºå¤„ç†ç½‘ç»œäº‹ä»¶ï¼Œå¦‚è¿æ¥è¯·æ±‚ã€æ•°æ®æ¥æ”¶ç­‰ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªåŸºäº<code>libevent</code>åº“çš„ç®€å•TCPæœåŠ¡å™¨ç¤ºä¾‹ï¼Œç”¨äºå¤„ç†å®¢æˆ·ç«¯è¿æ¥å’Œæ•°æ®æ¥æ”¶ã€‚ç¤ºä¾‹ä»£ç ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;event2/listener.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;event2/bufferevent.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;event2/event.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;arpa/inet.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>

<span class="c1">// å›è°ƒå‡½æ•°ï¼šå¤„ç†å®¢æˆ·ç«¯è¿æ¥</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">accept_conn_cb</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">evconnlistener</span><span class="w"> </span><span class="o">*</span><span class="n">listener</span><span class="p">,</span><span class="w"> </span><span class="n">evutil_socket_t</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span>
<span class="w">                    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sockaddr</span><span class="w"> </span><span class="o">*</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">socklen</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">event_base</span><span class="w"> </span><span class="o">*</span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">evconnlistener_get_base</span><span class="p">(</span><span class="n">listener</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bufferevent</span><span class="w"> </span><span class="o">*</span><span class="n">bev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bufferevent_socket_new</span><span class="p">(</span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">BEV_OPT_CLOSE_ON_FREE</span><span class="p">);</span>
<span class="w">    </span><span class="n">bufferevent_setcb</span><span class="p">(</span><span class="n">bev</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">bufferevent_enable</span><span class="p">(</span><span class="n">bev</span><span class="p">,</span><span class="w"> </span><span class="n">EV_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">EV_WRITE</span><span class="p">);</span>

<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Client connectedn&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// å›è°ƒå‡½æ•°ï¼šå¤„ç†æ•°æ®æ¥æ”¶</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">read_cb</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bufferevent</span><span class="w"> </span><span class="o">*</span><span class="n">bev</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">buffer</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bufferevent_read</span><span class="p">(</span><span class="n">bev</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="n">buffer</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Received: %sn&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// å›å¤å®¢æˆ·ç«¯</span>
<span class="w">    </span><span class="n">bufferevent_write</span><span class="p">(</span><span class="n">bev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Echo: &quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">);</span>
<span class="w">    </span><span class="n">bufferevent_write</span><span class="p">(</span><span class="n">bev</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">event_base</span><span class="w"> </span><span class="o">*</span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">event_base_new</span><span class="p">();</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sockaddr_in</span><span class="w"> </span><span class="n">sin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="w">    </span><span class="n">sin</span><span class="p">.</span><span class="n">sin_family</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AF_INET</span><span class="p">;</span>
<span class="w">    </span><span class="n">sin</span><span class="p">.</span><span class="n">sin_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">htons</span><span class="p">(</span><span class="mi">9999</span><span class="p">);</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">evconnlistener</span><span class="w"> </span><span class="o">*</span><span class="n">listener</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">evconnlistener_new_bind</span><span class="p">(</span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="n">accept_conn_cb</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">                                                              </span><span class="n">LEV_OPT_CLOSE_ON_FREE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">LEV_OPT_REUSEABLE</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span>
<span class="w">                                                              </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sin</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sin</span><span class="p">));</span>

<span class="w">    </span><span class="n">event_base_dispatch</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<ol>
<li><strong>äº‹ä»¶å¾ªç¯</strong>ï¼š<code>event_base_dispatch</code>è´Ÿè´£ç›‘å¬ç½‘ç»œäº‹ä»¶ã€‚</li>
<li><strong>å›è°ƒå‡½æ•°</strong>ï¼šé€šè¿‡<code>evconnlistener_new_bind</code>å’Œ<code>bufferevent_setcb</code>ç»‘å®šäº‹ä»¶å›è°ƒå‡½æ•°ã€‚</li>
<li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šé€‚ç”¨äºé«˜æ€§èƒ½ç½‘ç»œæœåŠ¡å™¨ï¼Œå¦‚WebæœåŠ¡å™¨æˆ–èŠå¤©æœåŠ¡å™¨ã€‚</li>
</ol>
</li>
<li>
<p>ç¡¬ä»¶é©±åŠ¨ç¨‹åºä¸­çš„äº‹ä»¶é©±åŠ¨</p>
<p>åœ¨ç¡¬ä»¶é©±åŠ¨ç¨‹åºä¸­ï¼Œäº‹ä»¶é©±åŠ¨ç¼–ç¨‹å¸¸ç”¨äºå¤„ç†è®¾å¤‡ä¸­æ–­æˆ–æ•°æ®è¯»å–ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„Linuxå­—ç¬¦è®¾å¤‡é©±åŠ¨ç¨‹åºç¤ºä¾‹ï¼Œä½¿ç”¨ä¸­æ–­å¤„ç†ç¨‹åºæ¥å“åº”ç¡¬ä»¶äº‹ä»¶ã€‚ç¤ºä¾‹ä»£ç ï¼ˆLinuxå­—ç¬¦è®¾å¤‡é©±åŠ¨ï¼‰ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/module.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/kernel.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/interrupt.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/fs.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/cdev.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/slab.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/types.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/sched.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/wait.h&gt;</span>
<span class="w">            </span>
<span class="cp">#define DEVICE_NAME &quot;my_device&quot;</span>
<span class="cp">#define IRQ_NUMBER 1 </span><span class="c1">// å‡è®¾ä½¿ç”¨ä¸­æ–­å·1</span>
<span class="w">            </span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">my_open</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="w"> </span><span class="s">&quot;Device openedn&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="w">            </span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">my_release</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="n">inode</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="w"> </span><span class="s">&quot;Device closedn&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="w">            </span>
<span class="c1">// ä¸­æ–­å¤„ç†å‡½æ•°</span>
<span class="k">static</span><span class="w"> </span><span class="n">irqreturn_t</span><span class="w"> </span><span class="nf">my_interrupt_handler</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">irq</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">dev_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="w"> </span><span class="s">&quot;Interrupt receivedn&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>
<span class="w">            </span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">my_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request_irq</span><span class="p">(</span><span class="n">IRQ_NUMBER</span><span class="p">,</span><span class="w"> </span><span class="n">my_interrupt_handler</span><span class="p">,</span><span class="w"> </span><span class="n">IRQF_SHARED</span><span class="p">,</span><span class="w"> </span><span class="n">DEVICE_NAME</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="w"> </span><span class="s">&quot;Failed to request IRQn&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="w"> </span><span class="s">&quot;Driver loadedn&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="w">            </span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__exit</span><span class="w"> </span><span class="nf">my_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">free_irq</span><span class="p">(</span><span class="n">IRQ_NUMBER</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="w"> </span><span class="s">&quot;Driver unloadedn&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="w">            </span>
<span class="n">module_init</span><span class="p">(</span><span class="n">my_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">my_exit</span><span class="p">);</span>
<span class="w">            </span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Your Name&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;A simple event-driven device driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="s">&quot;0.1&quot;</span><span class="p">);</span>
</code></pre></div>
<ol>
<li><strong>ä¸­æ–­å¤„ç†</strong>ï¼šé€šè¿‡<code>request_irq</code>æ³¨å†Œä¸­æ–­å¤„ç†å‡½æ•°ã€‚</li>
<li><strong>äº‹ä»¶é©±åŠ¨</strong>ï¼šç¡¬ä»¶ä¸­æ–­è§¦å‘æ—¶ï¼Œå†…æ ¸ä¼šè°ƒç”¨ä¸­æ–­å¤„ç†å‡½æ•°ã€‚</li>
<li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šé€‚ç”¨äºéœ€è¦å“åº”ç¡¬ä»¶äº‹ä»¶çš„è®¾å¤‡é©±åŠ¨ç¨‹åºã€‚</li>
</ol>
</li>
</ol>
</blockquote>
</blockquote>
<p>ä½†æ˜¯æœ‰ä¸ªé—®é¢˜ï¼šCallback hell (å›è°ƒåœ°ç‹±)â€</p>
<div class="highlight"><pre><span></span><code><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
<span class="w">    </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;/api/user&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
<span class="w">            </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="sb">`/api/user/</span><span class="si">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">/friends`</span><span class="p">,</span>
<span class="w">            </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">friends</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
<span class="w">                    </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="sb">`/api/friend/</span><span class="si">${</span><span class="nx">friends</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">                    </span><span class="p">...</span>
<span class="w">                </span><span class="p">});</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="p">...</span>
<span class="p">});</span>
</code></pre></div>
<p>é‚£æ€ä¹ˆåŠï¼Ÿç¤¾åŒºæ€»ä¼šæœ‰äººæ³¨æ„åˆ°çš„å‘€ï¼Œèƒ½å¤Ÿåæ€è§£å†³ã€‚å¸¦æ¥çš„å„ç§æ¡†æ¶ä½œå“ï¼š</p>
<ul>
<li>
<p>ECMAScript 2015 (ES6)</p>
<ul>
<li>ä¸€ç»Ÿç¬¬ä¸‰æ–¹åº“ â€œå†›é˜€æ··æˆ˜â€ çš„å±€é¢</li>
<li>å¼€æºç”Ÿæ€å¼€å§‹èµ·é£</li>
</ul>
</li>
<li>
<p>ç°ä»£å‰ç«¯çš„ä»£è¡¨ä½œå“</p>
<ul>
<li>Angular, React, Vue</li>
<li>Express.js, Next.js</li>
<li>Bootstrap, Tailwindcss</li>
<li>Electron (<a href="https://code.visualstudio.com/Docs/editor/whyvscode#:~:text=Using Electron%2C VS Code combines web technologies such,editor%2C Internet Explorer's F12 Tools%2C and other projects.">Why Visual Studio Code?</a>)<ul>
<li>2016 å¹´ï¼Œè¿˜ç”¨å…ˆçƒˆ <a href="https://github.blog/2022-06-08-sunsetting-atom/">Github Atom</a> åšè¿‡å®éªŒ</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>ç†è§£äº‹ä»¶é©±åŠ¨å‹å¹¶å‘ -&gt; åŠ¨æ€è®¡ç®—å›¾ï¼Œè„‘æµ·ä¸­æœ‰æƒ³è±¡ã€‚</p>
<p>å®ç°äº‹ä»¶é©±åŠ¨ï¼Œå®ç°å„ä¸ªè®¡ç®—æœºç»“ç‚¹ã€‚ï¼ˆä¸€ä¸ªä¸ªfetchï¼ŒæŒ‰é¡ºåºï¼Œä¸€ä¸ªèŠ‚ç‚¹æ¥ç€ä¸€ä¸ªèŠ‚ç‚¹ã€‚äººçœ‹å›¾å’Œç»“ç‚¹è¿˜æ˜¯æ¯”è¾ƒæœ‰å°è±¡çš„ï¼Œä½†å¯¹åº”åˆ°ä»£ç ä¸ºä»€ä¹ˆä¸Šå°±ä¸å¤ªä¸€æ ·äº†ï¼‰ï¼‰</p>
<p><img alt="image-20250123215740720" src="pic/image-20250123215740720.png" /></p>
<p>é‚£å°±å¸¦æ¥ä¸€ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨ç¼–ç¨‹è¯­è¨€é‡Œå»å†™è®¡ç®—å›¾å‘¢ï¼Ÿ</p>
<p>è€å¸ˆçš„ä¾‹å­ï¼Œæ›´åƒè®¡ç®—å›¾ï¼Œä»£ç è´¨é‡æ›´é«˜ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">fetch</span><span class="p">(</span><span class="sb">`/api/localhost/?action=demo&amp;path=</span><span class="si">${</span><span class="nx">path</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">fetchedData</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setData</span><span class="p">(</span><span class="nx">fetchedData</span><span class="p">))</span>
<span class="p">},</span><span class="w"> </span><span class="p">[]);</span>

<span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
<span class="w">    </span><span class="nx">fetch</span><span class="p">(...).</span><span class="nx">then</span><span class="p">(...),</span>
<span class="w">    </span><span class="nx">fetch</span><span class="p">(...).</span><span class="nx">then</span><span class="p">(...),</span>
<span class="w">    </span><span class="nx">fetch</span><span class="p">(...).</span><span class="nx">then</span><span class="p">(...),</span>
<span class="p">]).</span><span class="nx">then</span><span class="p">(</span>
<span class="w">    </span><span class="c1">// succeeded</span>
<span class="p">).</span><span class="k">catch</span><span class="p">(</span>
<span class="w">    </span><span class="c1">// error handling (catches exceptions in the fetch)</span>
<span class="p">)</span>
</code></pre></div>
<p>AI è§£é‡Šã€‚</p>
<h4 id="_28">æŠ€æœ¯æ€è€ƒ</h4>
<ul>
<li>
<p>PC â†’ Web â†’ Web 2.0 (UGC) â†’ AI (AGI)</p>
<ul>
<li>
<p>â€œæ¡†æ¶â€ æ˜¯é©±åŠ¨æŠ€æœ¯å‘å±•çš„åŸåŠ¨åŠ›</p>
</li>
<li>
<p>æˆ‘ä»¬éœ€è¦<strong>å¥½çš„æŠ½è±¡</strong>æ¥è¡¨è¾¾äººç±»ä¸–ç•Œä¸­çš„éœ€æ±‚</p>
<ul>
<li><strong>ç®€å•å¯é </strong>ï¼Œèšé›†å¤§é‡è¡Œä¸šå¼€å‘è€…<ul>
<li><strong>çµæ´»é€šç”¨</strong>ï¼Œæ„é€ å„ç§åº”ç”¨ç¨‹åº</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>å•æœº â†’ äº’è”ç½‘ â†’ ç§»åŠ¨è®¡ç®— â†’ ???</p>
<ul>
<li>æœºé‡å’Œä¸ç¡®å®š</li>
<li>é£é™©å’Œå›æŠ¥</li>
</ul>
</li>
</ul>
<p>å‰ç«¯è®©è¶Šæ¥è¶Šå¤šçš„äººæ¥è§¦åˆ°äº†è®¡ç®—æœºçš„é¢†åŸŸï¼Œæœ‰å¥½ä¹Ÿæœ‰åå§ï¼Œä»»ä½•äººéƒ½å¯ä»¥æ¥å†™å‡ è¡Œä»£ç ï¼Œä¸å†åƒä¹‹å‰åªæœ‰geekæ‰èƒ½å†™ï¼Œä½ å†™ä¸å¥½ä»£ç è¿˜ä¼šè¢«äººå–·ï¼Œå‰ç«¯çš„ç¤¾åŒºå°±ä¼šæœ‰å¥½çš„å¤šã€‚</p>
<p>çœŸçš„å¯ä»¥å­¦å­¦å‰ç«¯ï¼Œå€ŸåŠ© AIï¼Œæ›´å¿«ä¸Šæ‰‹ã€‚</p>
<p>å†äº†è§£ä¸‹å®ƒçš„å†å²ï¼š<a href="https://www.bilibili.com/video/BV1eC411p73m?spm_id_from=333.788.recommend_more_video.1&amp;vd_source=ecc99d78ae961113010161a48a475a35">å‰ç«¯æŠ€æœ¯çš„åå…«å¹´é£é›¨ï¼ˆ2006-2024ï¼‰</a></p>
<h3 id="_29">é«˜æ€§èƒ½è®¡ç®—ä¸­çš„å¹¶è¡Œç¼–ç¨‹</h3>
<h4 id="example">example</h4>
<blockquote>
<p>â€œA technology that harnesses the power of supercomputers or computer clusters to solve complex problems requiring massive computation.â€ (IBM)</p>
</blockquote>
<p>æºè‡ªæ•°å€¼å¯†é›†å‹ç§‘å­¦è®¡ç®—ä»»åŠ¡ï¼Œå°±æ˜¯æœ‰è¿™ä¹ˆä¸€ä¸ªçœŸå®çš„éœ€æ±‚ï¼š</p>
<ul>
<li>ç‰©ç†ç³»ç»Ÿæ¨¡æ‹Ÿ<ul>
<li>å¤©æ°”é¢„æŠ¥ã€èˆªå¤©ã€åˆ¶é€ ã€èƒ½æºã€åˆ¶è¯ã€â€¦â€¦</li>
<li>å¤§åˆ°å®‡å®™å°åˆ°é‡å­ï¼Œæœ‰æ¨¡å‹å°±èƒ½æ¨¡æ‹Ÿ</li>
</ul>
</li>
<li>çŸ¿å‚</li>
<li>AI: æ–°æ—¶ä»£çš„é«˜æ€§èƒ½è®¡ç®— (ä¹‹åä¸“é—¨è®²è§£)</li>
<li><a href="http://www.hpc100.cn/top100/22/">HPC-China 100</a></li>
</ul>
<h4 id="openmp">OpenMP</h4>
<p>é€šå¸¸è®¡ç®—å›¾å®¹æ˜“<strong>é™æ€åˆ‡åˆ†</strong> (æœºå™¨-çº¿ç¨‹ä¸¤çº§ä»»åŠ¡åˆ†è§£)</p>
<ul>
<li>
<p>ç”Ÿäº§è€…-æ¶ˆè´¹è€…è§£å†³ä¸€åˆ‡</p>
<ul>
<li><a href="https://hpc-tutorials.llnl.gov/mpi/">MPI</a> - â€œmessage passing librariesâ€</li>
<li><a href="https://www.openmp.org/">OpenMP</a> - â€œmulti-platform shared-memory parallel programming (C/C++ and Fortran)â€</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">// #pragma omp parallel num_threads(nthread)</span>
<span class="c1">// #pragma omp for schedule(static)</span>
<span class="cp">#pragma omp parallel num_threads(128)</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1024</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="p">}</span>
</code></pre></div>
<p>æ—¢ç„¶æˆ‘å†™ä¸å‡ºé«˜è´¨é‡çš„ä»£ç ï¼Œé‚£ç›´æ¥è®©ç¼–è¯‘å™¨åšå‘€ï¼</p>
<blockquote>
<p>å…·ä½“çœ‹çœ‹ç¤ºä¾‹ <strong>Mandelbrot</strong> çš„ä»£ç ï¼</p>
</blockquote>
</li>
<li>
<p>Challenges</p>
<p>ç½‘ç»œé€šä¿¡ã€åŠŸè€—ç®¡ç†ã€ç¨³å®šæ€§å’Œå®¹é”™ã€è½¯ä»¶å’Œå·¥å…·é“¾ (éƒ½ä¸æ˜¯è¿™é—¨è¯¾è®¨è®ºçš„å†…å®¹)</p>
<p>æ¯ä¸€ä¸ªé¢†åŸŸéƒ½å¯ä»¥å°è¯•çœ‹çœ‹ï¼Œçœ‹çœ‹è‡ªå·±çš„å…´è¶£ã€‚</p>
</li>
</ul>
<h3 id="_30">æ•°æ®ä¸­å¿ƒä¸­çš„å¹¶å‘ç¼–ç¨‹</h3>
<h3 id="_31">äººå·¥æ™ºèƒ½æ—¶ä»£çš„å¹¶å‘ç¼–ç¨‹</h3>
<p><strong>æ¨èå­¦ä¹ èµ„æ–™ï¼š<a href="https://udlbook.github.io/udlbook/">Understanding Deep Learning</a></strong></p>
<h4 id="example_1">example</h4>
<p><img alt="image-20250123185943926" src="pic/image-20250123185943926.png" /></p>
<p><img alt="image-20250123185340762" src="pic/image-20250123185340762.png" /></p>
<p>å„ä¸ªæ–¹é¢éƒ½å¹¶è¡Œ</p>
<h4 id="simd">SIMD</h4>
<p><strong>Single Instruction, Multiple Data</strong></p>
<h4 id="simt">SIMT</h4>
<p><strong>Single Instruction, Multiple Threads</strong></p>
<h2 id="bugs">å¹¶å‘bugs</h2>
<p>å®é™…ä¸­çš„å¹¶å‘ bugs </p>
<h3 id="_32">æ­»é”</h3>
<p><img src="pic/image-20250122105026321.png" alt="image-20250122105026321" style="zoom: 80%;" /></p>
<p>ä¸€äº›ä¾‹å­ï¼š</p>
<ul>
<li>
<p>AA-Deadlock</p>
<div class="highlight"><pre><span></span><code><span class="n">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
<span class="c1">// xchg(&amp;lk-&gt;locked, LOCKED) == âœ…</span>
<span class="p">...</span>

<span class="w">    </span><span class="c1">// Possibly in interrupt handler</span>
<span class="w">    </span><span class="n">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// xchg(&amp;lk-&gt;locked, LOCKED) == âŒ</span>
</code></pre></div>
<ul>
<li>çœŸå®ç³»ç»Ÿçš„å¤æ‚æ€§ç­‰ç€ä½ <ul>
<li>å¤šå±‚å‡½æ•°è°ƒç”¨</li>
<li>éšè—çš„æ§åˆ¶æµ</li>
</ul>
</li>
<li>xv6: é˜²å¾¡æ€§ç¼–ç¨‹</li>
</ul>
<p>å†™å†…æ ¸çš„æ—¶å€™ï¼Œåƒ xv6 ä¸€æ ·å†™ä»£ç ï¼Œé‡åˆ°è§£å¼€åŒä¸€æŠŠé”å°±panic</p>
</li>
<li>
<p>ABBA-Deadlock</p>
<p>å“²å­¦å®¶åƒé¥­é—®é¢˜</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">T_philosopher</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">P</span><span class="p">(</span><span class="o">&amp;</span><span class="n">avail</span><span class="p">[</span><span class="n">lhs</span><span class="p">]);</span>
<span class="w">    </span><span class="n">P</span><span class="p">(</span><span class="o">&amp;</span><span class="n">avail</span><span class="p">[</span><span class="n">rhs</span><span class="p">]);</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="n">V</span><span class="p">(</span><span class="o">&amp;</span><span class="n">avail</span><span class="p">[</span><span class="n">lhs</span><span class="p">]);</span>
<span class="w">    </span><span class="n">V</span><span class="p">(</span><span class="o">&amp;</span><span class="n">avail</span><span class="p">[</span><span class="n">rhs</span><span class="p">]);</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>T1: P(0) - æˆåŠŸ, P(1) - ç­‰å¾…</li>
<li>T2: P(1) - æˆåŠŸ, P(2) - ç­‰å¾…</li>
<li>T3: P(2) - æˆåŠŸ, P(3) - ç­‰å¾…</li>
<li>T4: P(3) - æˆåŠŸ, P(4) - ç­‰å¾…</li>
<li>T5: P(4) - æˆåŠŸ, P(0) - ç­‰å¾…</li>
</ul>
</li>
</ul>
<p>è¿™é‡Œè¯´çš„æ˜¯ç±»ä¼¼è‡ªæ—‹é”çš„ï¼Œåœ¨å†…æ ¸ä¸­ï¼Œæ˜¯è¿™ä¹ˆåšçš„ã€‚</p>
<h4 id="_33">æ­»é”äº§ç”Ÿçš„å¿…è¦æ¡ä»¶</h4>
<ul>
<li><a href="https://dl.acm.org/doi/10.1145/356586.356588">System deadlocks (1971)</a>: æŠŠé”çœ‹æˆè¢‹å­é‡Œçš„çƒ<ol>
<li>Mutual-exclusionï¼ˆäº’æ–¥ï¼‰ - ä¸€ä¸ªå£è¢‹ä¸€ä¸ªçƒï¼Œå¾—åˆ°çƒæ‰èƒ½ç»§ç»­</li>
<li>Wait-forï¼ˆè¯·æ±‚ä¸ç­‰å¾…ï¼‰ - å¾—åˆ°çƒçš„äººæƒ³è¦æ›´å¤šçš„çƒ ï¼ˆé™¤éä¸€æŠŠå¤§é”ï¼Œä½†æ€§èƒ½å¤ªå·®ï¼Œå› æ­¤å¿…é¡»æŠŠé”æ‹†å°ï¼‰</li>
<li>No-preemptionï¼ˆä¸å¯å‰¥å¤ºï¼‰ - ä¸èƒ½æŠ¢åˆ«äººçš„æŒæœ‰çš„çƒ</li>
<li>Circular-chainï¼ˆå¾ªç¯ç­‰å¾…ï¼‰- å½¢æˆå¾ªç¯ç­‰å¾…çƒçš„å…³ç³»ï¼ˆå“²å­¦å®¶é—®é¢˜çš„åŒæ—¶æ‹¿èµ·å·¦æ‰‹çš„å‰å­ï¼Œéƒ½åœ¨ç­‰å¯¹æ–¹ï¼‰</li>
</ol>
</li>
</ul>
<p>â€œå¿…è¦æ¡ä»¶â€ï¼Ÿ</p>
<ul>
<li>æ‰“ç ´ä»»ä½•ä¸€ä¸ªæ¡ä»¶ï¼Œå°±ä¸ä¼šå‘ç”Ÿæ­»é”äº†</li>
</ul>
<p>ç¬¬å››ä¸ªæœ€å®¹æ˜“æ‰“ç ´ï¼Ÿ</p>
<p>ç¬¬äºŒä¸ªåº”è¯¥ä¹Ÿå¯ä»¥ï¼šåˆ©ç”¨ç¼–ç¨‹è¯­è¨€çš„ <code>atomic</code> ã€<code>intel</code> çš„ TSX-memoryï¼ˆç¡¬ä»¶çŸ­ä¸´ç•ŒåŒºï¼‰ã€‚</p>
<h4 id="_34">å®é™…ç³»ç»Ÿä¸­é¿å…æ­»é”ï¼Ÿ</h4>
<ul>
<li>
<p><strong>Lock ordering</strong></p>
<ul>
<li>ä»»æ„æ—¶åˆ»ç³»ç»Ÿä¸­çš„é”éƒ½æ˜¯æœ‰é™çš„</li>
<li><strong>ç»™æ‰€æœ‰é”ç¼–å· (Lock Ordering)</strong><ul>
<li><strong>ä¸¥æ ¼æŒ‰ç…§ä»å°åˆ°å¤§çš„é¡ºåºè·å¾—é”</strong></li>
</ul>
</li>
</ul>
<blockquote>
<p>å“²å­¦å®¶åƒé¥­çš„é—®é¢˜ï¼ŒåŠ äº†ä¸€ä¸ªè«åå…¶å¦™çš„é¡ºåºã€‚</p>
<p>ä¸ºä»€ä¹ˆè¿™æ ·å­å¯ä»¥ï¼Ÿ</p>
<p>é¦–å…ˆï¼Œé”é¡ºåºé€šè¿‡è§„å®šæ‰€æœ‰çº¿ç¨‹ä»¥ç›¸åŒçš„é¡ºåºè·å–é”ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‰€æœ‰çº¿ç¨‹éƒ½å…ˆè·å–é”Aå†è·å–é”Bï¼Œé‚£ä¹ˆå°±ä¸ä¼šå‡ºç°çº¿ç¨‹1æŒæœ‰é”Aç­‰å¾…é”Bï¼Œè€Œçº¿ç¨‹2æŒæœ‰é”Bç­‰å¾…é”Açš„æƒ…å†µã€‚</p>
<p>ä¹Ÿå°±ä¸ä¼šå‡ºç°ä¸Šé¢å®šä¹‰è¯´çš„ä½ ç­‰æˆ‘ï¼Œæˆ‘ç­‰ä½ ã€‚</p>
<p>å…·ä½“ä¾‹å­ï¼š</p>
<p><div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pthread.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>

<span class="c1">// å®šä¹‰ä¸¤ä¸ªé”</span>
<span class="n">pthread_mutex_t</span><span class="w"> </span><span class="n">lock1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTHREAD_MUTEX_INITIALIZER</span><span class="p">;</span>
<span class="n">pthread_mutex_t</span><span class="w"> </span><span class="n">lock2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTHREAD_MUTEX_INITIALIZER</span><span class="p">;</span>

<span class="c1">// å®šä¹‰å…¨å±€é”é¡ºåº</span>
<span class="cp">#define LOCK_ORDER(lock_a, lock_b) \</span>
<span class="cp">    do { \</span>
<span class="cp">        pthread_mutex_lock(&amp;lock_a); \</span>
<span class="cp">        pthread_mutex_lock(&amp;lock_b); \</span>
<span class="cp">    } while (0)</span>

<span class="cp">#define UNLOCK_ORDER(lock_a, lock_b) \</span>
<span class="cp">    do { \</span>
<span class="cp">        pthread_mutex_unlock(&amp;lock_b); \</span>
<span class="cp">        pthread_mutex_unlock(&amp;lock_a); \</span>
<span class="cp">    } while (0)</span>

<span class="c1">// çº¿ç¨‹1çš„å‡½æ•°</span>
<span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="nf">thread1</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Thread 1: Trying to acquire locks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">LOCK_ORDER</span><span class="p">(</span><span class="n">lock1</span><span class="p">,</span><span class="w"> </span><span class="n">lock2</span><span class="p">);</span><span class="w"> </span><span class="c1">// æŒ‰ç…§lock1 -&gt; lock2çš„é¡ºåºè·å–é”</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Thread 1: Acquired locks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// æ¨¡æ‹Ÿå·¥ä½œ</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Thread 1: Releasing locks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">UNLOCK_ORDER</span><span class="p">(</span><span class="n">lock1</span><span class="p">,</span><span class="w"> </span><span class="n">lock2</span><span class="p">);</span><span class="w"> </span><span class="c1">// æŒ‰ç…§lock2 -&gt; lock1çš„é¡ºåºé‡Šæ”¾é”</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// çº¿ç¨‹2çš„å‡½æ•°</span>
<span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="nf">thread2</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Thread 2: Trying to acquire locks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">LOCK_ORDER</span><span class="p">(</span><span class="n">lock1</span><span class="p">,</span><span class="w"> </span><span class="n">lock2</span><span class="p">);</span><span class="w"> </span><span class="c1">// æŒ‰ç…§lock1 -&gt; lock2çš„é¡ºåºè·å–é”</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Thread 2: Acquired locks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// æ¨¡æ‹Ÿå·¥ä½œ</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Thread 2: Releasing locks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">UNLOCK_ORDER</span><span class="p">(</span><span class="n">lock1</span><span class="p">,</span><span class="w"> </span><span class="n">lock2</span><span class="p">);</span><span class="w"> </span><span class="c1">// æŒ‰ç…§lock2 -&gt; lock1çš„é¡ºåºé‡Šæ”¾é”</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">pthread_t</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">t2</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹</span>
<span class="w">    </span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">thread1</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">thread2</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ç­‰å¾…çº¿ç¨‹ç»“æŸ</span>
<span class="w">    </span><span class="n">pthread_join</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">pthread_join</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Main thread: Exiting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</p>
</blockquote>
</li>
<li>
<p><strong>Proof (sketch)</strong></p>
<ul>
<li>ä»»æ„æ—¶åˆ»ï¼Œæ€»æœ‰ä¸€ä¸ªçº¿ç¨‹è·å¾— â€œç¼–å·æœ€å¤§â€ çš„é”</li>
<li>è¿™ä¸ªçº¿ç¨‹æ€»æ˜¯å¯ä»¥ç»§ç»­è¿è¡Œ</li>
</ul>
</li>
</ul>
<h3 id="data-racerace-condition">æ•°æ®ç«äº‰/data race/race condition ï¼ˆé‡è¦ï¼‰</h3>
<p><strong>(æ‰€ä»¥ä¸ä¸Šé”ä¸å°±æ²¡æœ‰æ­»é”äº†å—ï¼Ÿå¸¦æ¥äº†å¦ä¸€ä¸ªé—®é¢˜ï¼šæ•°æ®ç«äº‰ï¼Œè¿™ä¸ªè¿˜æ˜¯æœ€å¸¸è§çš„)</strong></p>
<h4 id="_35">å®šä¹‰</h4>
<p><strong>ä¸åŒçš„çº¿ç¨‹</strong>åŒæ—¶è®¿é—®<strong>åŒä¸€å†…å­˜</strong>ï¼Œä¸”<strong>è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯å†™</strong>ã€‚</p>
<ul>
<li>ä¸¤ä¸ªå†…å­˜è®¿é—®åœ¨ â€œèµ›è·‘â€ï¼Œâ€œè·‘èµ¢â€ çš„æ“ä½œå…ˆæ‰§è¡Œï¼Œå¯¼è‡´éé¢„æœŸç»“æœï¼ˆè·‘èµ¢çš„é‚£ä¸ªè¢«è¦†ç›–ï¼‰</li>
<li>ä¾‹å­ï¼šå…±äº«å†…å­˜ä¸Šå®ç°çš„ Peterson ç®—æ³•</li>
</ul>
<p><img alt="image-20250122115408223" src="pic/image-20250122115408223.png" /></p>
<blockquote>
<p><a href="https://en.cppreference.com/w/c/language/memory_model">Memory model - cppreference.com</a></p>
<p>åŸæ¥è¿™é‡Œè¿˜æœ‰è¿™äº›å†…å®¹å‘€ï¼çœŸæ²¡å¥½å¥½çœ‹ï¼</p>
<ul>
<li>
<p>Threads and data races</p>
<p>A thread of execution is a flow of control within a program that begins with the invocation of a top-level function by <a href="https://en.cppreference.com/w/c/thread/thrd_create">thrd_create</a> or other means.</p>
<p>Any thread can potentially access any object in the program (objects with automatic and thread-local <a href="https://en.cppreference.com/w/c/language/storage_duration">storage duration</a> may still be accessed by another thread through a pointer).</p>
<p>Different threads of execution are always allowed to access (read and modify) different <em>memory locations</em> concurrently, with no interference and no synchronization requirements. (note that it is not safe to concurrently update two non-atomic bit-fields in the same structure if all members declared between them are also (non-zero-length) bit-fields, no matter what the sizes of those intervening bit-fields happen to be)</p>
<p><strong>When an <a href="https://en.cppreference.com/w/c/language/eval_order">evaluation</a> of an expression writes to a memory location and another evaluation reads or modifies the same memory location, the expressions are said to <em>conflict</em>. A program that has two conflicting evaluations has a <em>data race</em> unless eitherï¼ˆé™¤éä¸¤ä¸ªçŸ›ç›¾æ“ä½œæ—¶åŸå­çš„æˆ–è€…æœ‰æ“ä½œå‘ç”Ÿçš„å…ˆåå…³ç³»ï¼ˆhappens-beforeï¼‰ï¼‰</strong></p>
<ul>
<li>both conflicting evaluations are <a href="https://en.cppreference.com/w/c/language/atomic">atomic operations</a></li>
<li>one of the conflicting evaluations <em>happens-before</em> another (see <a href="https://en.cppreference.com/w/c/atomic/memory_order">memory_order</a>)</li>
</ul>
<p><strong>If a data race occurs, the behavior of the program is undefined.</strong></p>
<p>(in particular, <a href="https://en.cppreference.com/w/c/thread/mtx_unlock">mtx_unlock</a> is <em>synchronized-with</em>, and therefore, <em>happens-before</em> <a href="https://en.cppreference.com/w/c/thread/mtx_lock">mtx_lock</a> of the same mutex by another thread, which makes it possible to use mutex locks to guard against data races)</p>
</li>
<li>
<p>Memory order</p>
<p>When a thread reads a value from a memory location, it may see the initial value, the value written in the same thread, or the value written in another thread. See <a href="https://en.cppreference.com/w/c/atomic/memory_order">memory_order</a> for details on the order in which writes made from threads become visible to other threads.</p>
</li>
</ul>
<p>è¿™é‡Œæˆ‘åˆæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œåˆ°åº•ä»€ä¹ˆæ˜¯å†…å­˜æ¨¡å‹ï¼Ÿä¹‹å‰å¬ç»ªè®ºæ²¡æœ‰å¬æ˜ç™½ï¼Ÿ</p>
</blockquote>
<h4 id="_36">ä¾‹å­</h4>
<ul>
<li>
<p>Case 1: ä¸Šé”™äº†é”</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">T_1</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">A</span><span class="p">);</span><span class="w"> </span><span class="n">sum</span><span class="o">++</span><span class="p">;</span><span class="w"> </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">A</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">T_2</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">B</span><span class="p">);</span><span class="w"> </span><span class="n">sum</span><span class="o">++</span><span class="p">;</span><span class="w"> </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">B</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>
<p>åº”è¯¥ä¸ŠåŒä¸€æŠŠé”å‘€ï¼</p>
</li>
<li>
<p>Case 2: å¿˜è®°ä¸Šé”</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">T_1</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">A</span><span class="p">);</span><span class="w"> </span><span class="n">sum</span><span class="o">++</span><span class="p">;</span><span class="w"> </span><span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">A</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">T_2</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">sum</span><span class="o">++</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>
</li>
<li>
<p><strong>ä¸åŒçš„çº¿ç¨‹</strong>åŒæ—¶è®¿é—®<strong>åŒä¸€å†…å­˜</strong>ï¼Œä¸”<strong>è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯å†™</strong></p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">wait_next_beat</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">expect</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// This is a spin-wait loop.</span>
<span class="nl">retry</span><span class="p">:</span>
<span class="w">    </span><span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// This read is protected by a mutex.</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">got</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="w">    </span><span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Case 2: å¿˜è®°ä¸Šé”</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">expect</span><span class="p">)</span><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="n">retry</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>å®é™…ä¸æ˜¯å¿˜è®°ä¸Šé”ï¼Œæ˜¯ç”¨é”™äº†å˜é‡</li>
<li>æ›´è‡´å‘½çš„ï¼šbug (error state) å¾ˆéš¾è§¦å‘ â€œHeisenbugsâ€</li>
</ul>
<blockquote>
<p>åˆä¸€æ¬¡æ„Ÿè§‰åˆ° C çš„ç¼ºé™·ï¼Œä¸ºä»€ä¹ˆä¸ä¼šæé†’æˆ‘ï¼Ÿä¸ºä»€ä¹ˆè¿™æ ·å­ä¸èƒ½è§£å†³ï¼Ÿè¦è®°å¾—åšå‹åŠ›æµ‹è¯•ï¼è¶³å¤Ÿå‹åŠ›ï¼</p>
</blockquote>
</li>
</ul>
<p><strong><mark>è®°ä½ï¼ï¼ï¼</mark></strong></p>
<p><img alt="image-20250124145322954" src="pic/image-20250124145322954.png" /></p>
<h4 id="more-bugcomplex">é¢„å‘Š more bug/complex</h4>
<blockquote>
<p>å®é™…ç³»ç»Ÿé¢ä¸´æ›´å¤æ‚çš„æƒ…å†µ</p>
</blockquote>
<ul>
<li>â€œå†…å­˜â€ å¯ä»¥æ˜¯åœ°å€ç©ºé—´ä¸­çš„ä»»ä½•å†…å­˜<ul>
<li>å¯ä»¥æ˜¯å…¨éƒ¨å˜é‡</li>
<li>å¯ä»¥æ˜¯å †åŒºåˆ†é…çš„å˜é‡</li>
<li>å¯ä»¥æ˜¯æ ˆ</li>
</ul>
</li>
<li>â€œè®¿é—®â€ å¯ä»¥æ˜¯ä»»ä½•ä»£ç <ul>
<li>å¯èƒ½å‘ç”Ÿåœ¨ä½ çš„ä»£ç é‡Œ</li>
<li>å¯ä»¥å‘ç”Ÿåœ¨æ¡†æ¶ä»£ç é‡Œ</li>
<li>å¯èƒ½æ˜¯ä¸€è¡Œä½ æ²¡æœ‰è¯»åˆ°è¿‡çš„æ±‡ç¼–ä»£ç </li>
<li>å¯èƒ½æ˜¯ä¸€æ¡ ret æŒ‡ä»¤</li>
</ul>
</li>
</ul>
<blockquote>
<p>å‰§é€ L2 çš„bugï¼š</p>
<p>ä¸­æ–­è¿”å›ï¼Œå€ŸåŠ©æ ˆã€‚å¦‚æœåœ¨è¿™ä¸ªæ—¶å€™ï¼Œä¸€ä¸ªçº¿ç¨‹åˆ‡æ¢åˆ°å¦ä¸€ä¸ªCPUä¸Šï¼Ÿè¿™ä¸ªå½“å‰çº¿ç¨‹å€Ÿç”¨å½“å‰çš„æ ˆè¿›è¡Œä¸­æ–­è¿”å›ï¼Œä½†æ˜¯å¦ä¸€ä¸ª CPU ä¸Šè¿™ä¸ªçº¿ç¨‹å¼€å§‹è¿è¡Œï¼Œè¿™æ ·å°±data raceäº†ï¼Ÿ</p>
<p>å¦å¤–ä¸€ä¸ªCPUä¼šå€Ÿç”¨å®ƒ(çº¿ç¨‹)çš„æ ˆã€‚ä¸åŒçº¿ç¨‹ï¼ŒåŒä¸€å˜é‡ã€‚</p>
</blockquote>
<h3 id="_37">åŸå­æ€§/é¡ºåºè¿å</h3>
<ul>
<li>
<p>äººç±»æ˜¯ sequential creature</p>
<p>æˆ‘ä»¬åªèƒ½ç”¨ sequential çš„æ–¹å¼æ¥ç†è§£å¹¶å‘</p>
<ul>
<li>ç¨‹åºåˆ†æˆè‹¥å¹² â€œå—â€ï¼Œæ¯ä¸€å—çœ‹èµ·æ¥éƒ½æ²¡è¢«æ‰“æ–­ (åŸå­)<ul>
<li>ä¾‹å­ï¼šproduce â†’ (happens-before) â†’ consume</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>å¹¶å‘æ§åˆ¶çš„æœºåˆ¶å®Œå…¨æ˜¯ â€œåæœè‡ªè´Ÿâ€ çš„</strong></p>
<ul>
<li>äº’æ–¥é” (lock/unlock) å®ç°åŸå­æ€§<ul>
<li>å¿˜è®°ä¸Šé”â€”â€”åŸå­æ€§è¿å (Atomicity Violation, AV)</li>
</ul>
</li>
<li>æ¡ä»¶å˜é‡/ä¿¡å·é‡ (wait/signal) å®ç°å…ˆåé¡ºåºåŒæ­¥<ul>
<li>å¿˜è®°åŒæ­¥â€”â€”é¡ºåºè¿å (Order Violation, OV)</li>
</ul>
</li>
</ul>
<p>å°±æ˜¯å¹¶å‘æ§åˆ¶é‡Œé‡è¦çš„ä¸¤ç‚¹ï¼šäº’æ–¥ã€åŒæ­¥</p>
<ul>
<li><a href="https://dl.acm.org/doi/10.1145/1065010.1065042">Threads cannot be implemented as a library</a></li>
</ul>
</li>
</ul>
<p><img alt="image-20250122121410156" src="pic/image-20250122121410156.png" /></p>
<h4 id="atomicity-violation">åŸå­æ€§è¿å(Atomicity Violation)</h4>
<p><img alt="image-20250122122321812" src="pic/image-20250122122321812.png" /></p>
<p>ä¸å•å•æ˜¯åº”ç”¨ç¨‹åºä¸­å¹¶å‘ï¼Œæ“ä½œç³»ç»Ÿä¸­è¿˜æœ‰æ›´å¤šçš„å…±äº«çŠ¶æ€</p>
<p><img alt="image-20250122122846598" src="pic/image-20250122122846598.png" /></p>
<ul>
<li><a href="https://www.usenix.org/legacy/events/fast05/tech/full_papers/wei/wei.pdf">TOCTTOU vulnerabilities in UNIX-style file systems: An anatomical study</a> (FAST'05); æˆ‘ä»¬å¯ä»¥å»ºæ¨¡è¿™ä¸ªè¡Œä¸º</li>
</ul>
<h4 id="order-violation">é¡ºåºè¿å (Order Violation)</h4>
<p><img alt="image-20250122122349192" src="pic/image-20250122122349192.png" /></p>
<ul>
<li>è½¯ä»¶ï¼šï¼ˆå†…æ ¸ï¼‰concurrent use-after-free</li>
<li>ç¡¬ä»¶ä¹Ÿæœ‰bugï¼š<a href="https://www.vusec.net/projects/ghostrace/">GhostRace</a> (USENIX Sec'24)</li>
<li>meltdown æ¼æ´ï¼š<a href="https://zhuanlan.zhihu.com/p/32757727">è§£è¯» Meltdown &amp; Spectre CPU æ¼æ´ </a></li>
</ul>
<h2 id="bugs_1">åº”å¯¹å¹¶å‘bugs</h2>
<h3 id="_38">è½¯ä»¶å±æœº</h3>
<ul>
<li>
<p>Specification Crisis</p>
<ul>
<li>è½¯ä»¶çš„è§„çº¦è”ç³»äº†äººç±»ä¸–ç•Œ</li>
<li>æˆ‘ä»¬<strong>æ— æ³•</strong>ç”¨ç¼–ç¨‹è¯­è¨€å†™å‡ºå…¨éƒ¨è§„çº¦</li>
<li>å³ä¾¿èƒ½å†™å‡ºçš„è§„çº¦ï¼Œä¹Ÿå¾ˆéš¾<strong>è¯æ˜</strong></li>
</ul>
<p>å›æƒ³ä¸€ä¸‹ï¼Œç¨‹åºæ˜¯ç‰©ç†ä¸–ç•Œè¿‡ç¨‹åœ¨ä¿¡æ¯ä¸–ç•Œä¸­çš„<strong>æœ‰æŸ</strong>æŠ•å½±ï¼Œæœ‰è½¯ä»¶èƒ½å®ç°è¿™ç§ spec å—ï¼Ÿ</p>
<p>éƒ½æ˜¯äººå®šä¸‹çš„è§„å®šå‘€ã€‚</p>
</li>
<li>
<p>Search-space Curse</p>
<ul>
<li>ç‰¹æ€§çš„äº¤äº’ç»„åˆæ˜¯æŒ‡æ•°å¢é•¿çš„</li>
<li>å³ä¾¿çŸ¥é“ specificationï¼Œä½ ä¹Ÿå¾ˆéš¾è¯æ˜å¤æ‚çš„çŠ¶æ€æœºæ»¡è¶³å®ƒ</li>
<li>çŒœæƒ³ï¼šâ€œComplex systems are chaotic.â€</li>
</ul>
</li>
</ul>
<p>æœ‰è§£å†³çš„åŠæ³•å—ï¼Ÿ</p>
<h3 id="_39">åº”å¯¹æ­»é”</h3>
<p>æ•™ç§‘ä¹¦æ¨èåˆ°åšæ³•ï¼šä»¥æ­£ç¡®çš„ lock ordering æ¥é¿å…æ­»é”ï¼Œç¡®å®æœ‰ç”¨ï¼š</p>
<ul>
<li>
<p>Linux Kernel: <a href="https://elixir.bootlin.com/linux/latest/source/mm/rmap.c">mm/rmap.c</a></p>
<div class="highlight"><pre><span></span><code><span class="cm">/*</span>
<span class="cm"> * Lock ordering in mm:</span>
<span class="cm"> *</span>
<span class="cm"> * inode-&gt;i_rwsem   (while writing or truncating, not reading or faulting)</span>
<span class="cm"> *   mm-&gt;mmap_lock</span>
<span class="cm"> *     mapping-&gt;invalidate_lock (in filemap_fault)</span>
<span class="cm"> *       folio_lock</span>
<span class="cm"> *         hugetlbfs_i_mmap_rwsem_key (in huge_pmd_share, see hugetlbfs below)</span>
<span class="cm"> *           vma_start_write</span>
<span class="cm"> *             mapping-&gt;i_mmap_rwsem</span>
<span class="cm"> *               anon_vma-&gt;rwsem</span>
<span class="cm"> *                 mm-&gt;page_table_lock or pte_lock</span>
<span class="cm"> *                   swap_lock (in swap_duplicate, swap_info_get)</span>
<span class="cm"> *                     mmlist_lock (in mmput, drain_mmlist and others)</span>
<span class="cm"> *                     mapping-&gt;private_lock (in block_dirty_folio)</span>
<span class="cm"> *                       folio_lock_memcg move_lock (in block_dirty_folio)</span>
<span class="cm"> *                         i_pages lock (widely used)</span>
<span class="cm"> *                           lruvec-&gt;lru_lock (in folio_lruvec_lock_irq)</span>
<span class="cm"> *                     inode-&gt;i_lock (in set_page_dirty&#39;s __mark_inode_dirty)</span>
<span class="cm"> *                     bdi.wb-&gt;list_lock (in set_page_dirty&#39;s __mark_inode_dirty)</span>
<span class="cm"> *                       sb_lock (within inode_lock in fs/fs-writeback.c)</span>
<span class="cm"> *                       i_pages lock (widely used, in set_page_dirty,</span>
<span class="cm"> *                                 in arch-dependent flush_dcache_mmap_lock,</span>
<span class="cm"> *                                 within bdi.wb-&gt;list_lock in __sync_single_inode)</span>
<span class="cm"> *</span>
<span class="cm"> * anon_vma-&gt;rwsem,mapping-&gt;i_mmap_rwsem   (memory_failure, collect_procs_anon)</span>
<span class="cm"> *   -&gt;tasklist_lock</span>
<span class="cm"> *     pte map lock</span>
<span class="cm"> *</span>
<span class="cm"> * hugetlbfs PageHuge() take locks in this order:</span>
<span class="cm"> *   hugetlb_fault_mutex (hugetlbfs specific page fault mutex)</span>
<span class="cm"> *     vma_lock (hugetlb specific lock for pmd_sharing)</span>
<span class="cm"> *       mapping-&gt;i_mmap_rwsem (also used for hugetlb pmd sharing)</span>
<span class="cm"> *         folio_lock</span>
<span class="cm"> */</span>
</code></pre></div>
</li>
</ul>
<p>å°½ç®¡æ•™ç§‘ä¹¦ä¸Šå»ºè®®å§‹ç»ˆä»¥ç›¸åŒé¡ºåºé”å®šä»¥é¿å…æ­»é”ï¼Œä½†è¿™ç§æ–¹æ³•åœ¨å®é™…åº”ç”¨ä¸­å¹¶ä¸å¥æ•ˆã€‚å› ä¸ºåˆ›å»ºæ–°é”ï¼ˆæ·»åŠ æ–°çš„ä»£ç ï¼‰æ—¶å¾€å¾€æ— æ³•äº†è§£æ•´ä¸ªé¡¹ç›®çš„é”çš„å±‚çº§ç»“æ„ï¼ˆä¸çŸ¥é“åˆ«äººåœ¨å“ªé‡Œæ·»åŠ äº†å¤šå°‘é”ï¼‰ã€‚</p>
<blockquote>
<p><a href="https://www.kernel.org/doc/html/latest/kernel-hacking/locking.html">Unreliable Guide to Locking</a>: Textbooks will tell you that if you always lock in the same order, you will never get this kind of deadlock. <strong>Practice will tell you that this approach doesn't scale</strong>: when I create a new lock, I don't understand enough of the kernel to figure out where in the 5000 lock hierarchy it will fit.</p>
<p>The best locks are encapsulated: they <strong>never get exposed in headers</strong>, and are <strong>never held around calls to non-trivial functions outside the same file</strong>. You can read through this code and see that it will never deadlock, because it never tries to grab another lock while it has that one. People using your code don't even need to know you are using a lock.</p>
</blockquote>
<p>é”çš„æœ«ç«¯ï¼Ÿ</p>
<blockquote>
<p>é¢å¤–çœ‹åˆ°äº†ä¸€ç¯‡ï¼š<a href="https://yarchive.net/comp/linux/lock_ordering.html">Lock ordering (Linus Torvalds)</a></p>
<ul>
<li><strong>åŠ é”é¡ºåºå¾ˆé‡è¦</strong>ï¼šä¸ºäº†é¿å…æ­»é”ï¼ŒåŠ é”é¡ºåºå¿…é¡»ä¸€è‡´ã€‚</li>
<li><strong>è§£é”é¡ºåºä¸é‡è¦</strong>ï¼šè§£é”é¡ºåºå¯ä»¥ä¸åŠ é”é¡ºåºç›¸åŒï¼Œä¹Ÿå¯ä»¥ä¸åŒï¼Œåªè¦é€»è¾‘æ­£ç¡®å³å¯ã€‚</li>
</ul>
<p>ä¸å¤ªç†è§£ï¼Ÿ</p>
</blockquote>
<p>æ­»é”è¿›ä¸€æ­¥å¯¼è‡´æ­»å±€ï¼Œæ€ä¹ˆåŠï¼Ÿäººç±»æ€»æœ‰åŠæ³•åº”å¯¹ï¼šåŠ¨æ€ç¨‹åºåˆ†æ</p>
<p><img alt="image-20250122213445098" src="pic/image-20250122213445098.png" /></p>
<h3 id="_40">åº”å¯¹æ­»å±€ï¼šç»å¤„é€¢ç”Ÿ</h3>
<blockquote>
<p>è¿è¡Œæ—¶æ£€æŸ¥ï¼Œæœ‰ç‚¹åƒä¼šä¸ä¼šæ˜¯çœ‹é—¨ç‹—ï¼Ÿ</p>
<blockquote>
<p>è¿è¡Œæ—¶æ£€æŸ¥ï¼ˆåŠ¨æ€ç¨‹åºåˆ†æï¼‰å’Œçœ‹é—¨ç‹—è™½ç„¶åœ¨æŸç§ç¨‹åº¦ä¸Šéƒ½ä¸â€œç›‘æ§â€æœ‰å…³ï¼Œä½†å®ƒä»¬çš„ç›®æ ‡å’Œæœºåˆ¶æœ‰å¾ˆå¤§ä¸åŒï¼š</p>
<ul>
<li><strong>çœ‹é—¨ç‹—ï¼ˆWatchdogï¼‰</strong>ï¼š<ul>
<li>ä¸»è¦ç”¨äºé˜²æ­¢ç³»ç»Ÿæˆ–ç¨‹åºå› é•¿æ—¶é—´æ— å“åº”è€Œé™·å…¥æ­»é”æˆ–å¡é¡¿ã€‚</li>
<li>é€šå¸¸æ˜¯ç¡¬ä»¶æˆ–æ“ä½œç³»ç»Ÿå±‚é¢çš„æœºåˆ¶ï¼Œé€šè¿‡å®šæ—¶å™¨æ£€æµ‹ç¨‹åºæ˜¯å¦åœ¨è§„å®šæ—¶é—´å†…å®ŒæˆæŸäº›æ“ä½œã€‚</li>
<li>å¦‚æœç¨‹åºæ²¡æœ‰å“åº”ï¼Œçœ‹é—¨ç‹—å¯èƒ½ä¼šé‡å¯ç³»ç»Ÿæˆ–ç¨‹åºã€‚</li>
</ul>
</li>
<li><strong>è¿è¡Œæ—¶æ£€æŸ¥ï¼ˆåŠ¨æ€ç¨‹åºåˆ†æï¼‰</strong>ï¼š<ul>
<li>ç›®çš„æ˜¯æ£€æµ‹ç¨‹åºè¿è¡Œæ—¶çš„é”™è¯¯ï¼Œå¦‚æ­»é”ã€æ•°æ®ç«äº‰ã€æ•´æ•°æº¢å‡ºç­‰ã€‚</li>
<li>æ˜¯ä¸€ç§è½¯ä»¶å±‚é¢çš„åˆ†æå·¥å…·ï¼Œé€šå¸¸é€šè¿‡æ’å…¥é¢å¤–çš„ä»£ç æˆ–ä½¿ç”¨ä¸“é—¨çš„å·¥å…·æ¥ç›‘æ§ç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹ã€‚</li>
<li>ä¸æ˜¯ä¸ºäº†é‡å¯ç³»ç»Ÿï¼Œè€Œæ˜¯ä¸ºäº†å‘ç°å¹¶ä¿®å¤æ½œåœ¨çš„é”™è¯¯ã€‚</li>
</ul>
</li>
</ul>
</blockquote>
</blockquote>
<h4 id="_41">åŠ¨æ€ç¨‹åºåˆ†æ</h4>
<ul>
<li>Tipsï¼š<strong>æˆ‘ä»¬å¯ä»¥åœ¨è¿è¡Œæ—¶æ£€æŸ¥ä¸€åˆ‡æ˜ç¡®çš„ Specificationï¼</strong><ul>
<li>AA/ABBA å‹æ­»é”</li>
<li>æ•°æ®ç«äº‰</li>
<li>å¸¦ç¬¦å·æ•´æ•°æº¢å‡º (undefined behavior)</li>
<li>Use after free</li>
</ul>
</li>
</ul>
<p>æœ‰è¿™ä¹ˆä¸€ä¸ªåº”å¯¹æ­»å±€çš„è‡ªæ•‘æ–¹æ³•ï¼š<strong>åŠ¨æ€ç¨‹åºåˆ†æ</strong>ï¼šçŠ¶æ€æœºæ‰§è¡Œå†å²çš„ä¸€ä¸ªå‡½æ•° f(Ï„)</p>
<ul>
<li>ä»˜å‡ºç¨‹åºæ‰§è¡Œå˜æ…¢çš„ä»£ä»·</li>
<li>æ‰¾åˆ°æ›´å¤š bugs</li>
</ul>
<blockquote>
<p>ä»€ä¹ˆå«åŠ¨æ€åˆ†æï¼Ÿ</p>
<p>å°±æ˜¯æ•´ä¸ªçŠ¶æ€æœºçŠ¶æ€æ‰§è¡Œå†å²çš„å‡½æ•° f(Ï„)ã€‚</p>
<p>ï¼ˆç¼–ç¨‹é—®é¢˜ -&gt; æ•°å­¦ç®—æ³•é—®é¢˜ï¼ï¼æ‰€æœ‰ï¼Œè¿™å°±æ˜¯é‚£äº›ç¦»æ•£æ•°å­¦å’Œæ•°æ®ç»“æ„ä¸ç®—æ³•çš„ç”¨å¤„äº†ï¼Ÿï¼‰</p>
</blockquote>
<p>æ¯”å¦‚ï¼š</p>
<ul>
<li>
<p>AA/ABBA å‹æ­»é”ï¼šå¯ä»¥çœ‹è¿™ä¸ªåŠ¨æ€åˆ†æé‡Œå‡ºç°çš„ lock å’Œ unlock çŠ¶æ€æ˜¯å¦é…å¯¹ã€‚</p>
</li>
<li>
<p>æ•°æ®ç«äº‰ï¼šçœ‹è¿™ä¸ªçŠ¶æ€æœºçš„å†…å­˜è®¿é—®ï¼ˆå›æƒ³å®šä¹‰ï¼‰ -&gt; çœ‹æ‰€æœ‰çš„ load/store + å“ªä¸ªçº¿ç¨‹</p>
</li>
</ul>
<blockquote>
<p>è¿™é‡Œå†å›æƒ³çœ‹çœ‹ï¼Œè‡ªå·±åœ¨ PA ä¸­çš„åšçš„å„ä¸ª traceï¼Œæ˜¯ä¸æ˜¯å°±æ˜¯è¿™æ ·ï¼ï¼</p>
<p>ç†è§£èµ·æ¥å°±æ˜¯è¦æ‰¾åˆ°å„ä¸ªspecï¼Œæ˜ç¡®å‡ºæ¥ï¼Œæ‰¾å‡ºå„ç±»å‹ bug çš„æ ¹æœ¬åŸå› ï¼Ÿä¼šä¸ä¼šæœ‰ç‚¹åƒä»€ä¹ˆç¬¬ä¸€æ€§åŸç†ï¼Ÿ</p>
</blockquote>
<h4 id="lockdep-lock-ordering">Lockdepï¼šè¿è¡Œæ—¶ lock ordering æ£€æŸ¥</h4>
<p>ä¾‹å­ï¼šå½¢æˆäº†ç¯ï¼ˆABBAï¼‰</p>
<p><img alt="image-20250122213154284" src="pic/image-20250122213154284.png" /></p>
<p>æ€ä¹ˆæƒ³åˆ°è¿™ä¹ˆä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼Ÿ</p>
<blockquote>
<p>å›æƒ³ PA ä¸­å„ä¸ª trace éƒ½æ˜¯ä¸ºäº†è§£å†³ä»€ä¹ˆé—®é¢˜æœ‰ä»€ä¹ˆéœ€æ±‚ï¼Œæ‰å†™å‡ºæ¥çš„ï¼Ÿ</p>
<ul>
<li><code>ftrace</code>ï¼šæ‰¾åˆ°å‡½æ•°/çŠ¶æ€çš„æ‰§è¡Œæµç¨‹</li>
<li><code>strace(syscall strace</code>ï¼šæŸ¥çœ‹å„ä¸ª åº”ç”¨ç¨‹åºçš„ä»£ç æ€ä¹ˆå€ŸåŠ©æ“ä½œç³»ç»Ÿæä¾›çš„èµ„æºçš„</li>
<li><code>mtrace</code>ï¼šè®¿å­˜ä¹Ÿæ˜¯å¿…ä¸å¯å°‘çš„</li>
</ul>
</blockquote>
<p>ä¸ºäº†è¿›ä¸€æ­¥æ»¡è¶³ lock orderingï¼ˆä¸å‡ºç°ä½ ç­‰æˆ‘ï¼Œæˆ‘ç­‰ä½ çš„æƒ…å†µï¼‰ï¼Œé‚£è‡ªç„¶ä¹Ÿä¼šæƒ³åˆ°èƒ½ä¸èƒ½åœ¨ lock å’Œ unlock ä¹‹é—´æ‰“å°æ—¥å¿—ï¼Œå‘Šè¯‰æˆ‘ä»¬è¿™æ˜¯ä¸Šçš„å“ªä¸€æŠŠé”ã€å“ªä¸€ä¸ªçº¿ç¨‹ã€é”çš„çŠ¶æ€...è¿™æ ·å°±èƒ½æ‰¾å‡ºä»£ç ä¸­ä¸æ»¡è¶³ lock ordering çš„åœ°æ–¹è¿›è¡Œä¿®æ”¹ã€‚</p>
<blockquote>
<ul>
<li>
<p>ä¸ºæ¯ä¸€ä¸ª acquire/release è®°å½• tid å’Œ lock name</p>
</li>
<li>
<p>Assert:</p>
<p>G(V,E) æ— æˆç¯</p>
<ul>
<li>V: æ‰€æœ‰çš„ lock names</li>
<li>E: æ¯å½“è§‚æµ‹åˆ°æŒæœ‰ u æ—¶è·å– v å°±æŠŠ (u,v) åŠ å…¥ E</li>
</ul>
</li>
</ul>
<p><div class="highlight"><pre><span></span><code>T1<span class="w"> </span>ACQ<span class="w"> </span>a
T1<span class="w"> </span>ACQ<span class="w"> </span>b
T1<span class="w"> </span>REL<span class="w"> </span>b
T2<span class="w"> </span>ACQ<span class="w"> </span>b
T2<span class="w"> </span>REL<span class="w"> </span>b
...
</code></pre></div>
</p>
</blockquote>
<p>æœ‰ä¸ªé—®é¢˜ï¼ŒçœŸå®åº”ç”¨ç³»ç»Ÿä¸­ï¼Œä¹Ÿæ˜¯è¿™æ ·åšçš„ï¼Ÿåƒå‡ ä¸‡è¡Œä»£ç çš„é¡¹ç›®ï¼Œäº§ç”Ÿè¶…çº§å¤§çš„ logï¼Ÿè¿™æ ·æ‹–æ…¢ç³»ç»Ÿè¿è¡Œé€Ÿåº¦å’Œå¼€å‘é€Ÿåº¦èƒ½æ¥å—å—ï¼Ÿ</p>
<p>åƒä¸Šé¢é‚£ç§ trace ä¸€ä¸ªåˆæ ¼çš„è®¡ç®—æœºç³»å­¦ç”Ÿåº”è¯¥éƒ½èƒ½æƒ³åˆ°ï¼Œå·¥ç¨‹ä¸Šæ›´åŠ å¤æ‚ï¼Œå¥½åƒè¿™äº›é”è¿˜æ˜¯ä¼šåŠ¨æ€åˆ›å»ºçš„ï¼é‚£ä¸Šé¢é”çš„å›¾çš„è¾¹ä¸€ç›´å¢åŠ /åˆ é™¤ã€‚ä¸ºæ¯ä¸€ä¸ªé”éƒ½è¿½è¸ªä¸Šé”çš„é¡ºåºä¼šå¸¦æ¥ç›¸å½“çš„å¼€é”€ã€‚ï¼ˆè¿™é‡Œè€å¸ˆè¿˜çœŸè®²äº†è¿™ä¸ªé—®é¢˜ï¼‰</p>
<p>å®é™…è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ<strong>è§£å†³é”çš„ â€œå‘½åâ€ é—®é¢˜</strong>ï¼š</p>
<ul>
<li>
<p>å¯ä»¥æ˜¯é”çš„åœ°å€</p>
</li>
<li>
<p>ä¹Ÿå¯ä»¥æ˜¯é”çš„åˆå§‹åŒ–ä½ç½® (æ›´ä¸¥æ ¼ï¼›å¼€é”€æ›´å°)</p>
<ul>
<li><a href="https://lwn.net/Articles/185666/">The kernel lock validator</a></li>
<li>Since Linux Kernel 2.6.17, also in <a href="https://gitee.com/openharmony">OpenHarmony</a> v1</li>
</ul>
<p>é‚£ä¸ªæ—¶å€™çš„ Linux ä»å•æ ¸å˜æˆå¤šæ ¸ä¹‹å‰ï¼Œç”¨çš„æ˜¯ä¸€æŠŠå¤§é”ä¿å¹³å®‰ï¼ˆbig kernel lockï¼‰ï¼Œä½†æ˜¯å¤šæ ¸ä¹‹åï¼Œä¸ºäº†æ€§èƒ½çš„æå‡ï¼Œé”ä¸æ–­åœ°æ‹†å°ï¼Œè€Œæ‹†å°çš„ä»£ä»·å°±ä¼šå¸¦æ¥æ­»é”ï¼Œå…·ä½“ä¹Ÿå°±æœ‰äº†ä¸Šé¢çš„æ–‡ç« ã€‚</p>
</li>
</ul>
<blockquote>
<p>è€å¸ˆçš„å±±å¯¨ç‰ˆå®ç°ï¼š</p>
<p>æ›´ç»æµçš„æ–¹å¼æ˜¯æŠŠæ‰€æœ‰åœ¨åŒä¸€è¡Œä»£ç ä¸­åˆå§‹åŒ–çš„é”éƒ½çœ‹æˆæ˜¯ â€œåŒä¸€ä¸ªé”â€ï¼Œè¿™æ ·é”çš„æ•°é‡å°±å¤§å¹…å‡å°‘äº†ã€‚</p>
<p>å½“ç„¶è¿™ä¹Ÿä¼šæŸå¤±ä¸€äº›æ£€æµ‹ç²¾åº¦ï¼Œä¾‹å¦‚å“²å­¦å®¶åƒé¥­é—®é¢˜ä¸­ï¼Œå¦‚æœæ‰€æœ‰çš„é”éƒ½åœ¨åŒä¸€è¡Œä»£ç ä¸­åˆå§‹åŒ–ï¼Œæˆ‘ä»¬å°±ä¸èƒ½åŒºåˆ†å®ƒä»¬çš„ä¸Šé”é¡ºåºäº†ã€‚</p>
</blockquote>
<ul>
<li>
<p>æ€ä¹ˆå®ç°çš„ï¼Ÿ</p>
<p><strong><mark>TODO</mark></strong></p>
<p>ç©¶ç«Ÿæ€ä¹ˆæ£€æµ‹åˆ°ç¯çš„ï¼Ÿ</p>
<p>å·¥ç¨‹å¸ˆè®¤ä¸ºï¼šåœ¨åŒä¸€è¡Œçš„ä»£ç åˆ†é…çš„ï¼Œéƒ½æ˜¯åŒä¸€æŠŠé”ï¼Œç”¨åå­—/è¡Œæ•°ï¼ŒCé‡Œçš„ <code>#</code> æ“ä½œç¬¦</p>
<p>å…·ä½“çœ‹çœ‹ä»£ç å®ç°ã€‚è€å¸ˆä»£ç çš„å‘ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">mutex_t</span><span class="w"> </span><span class="n">mutex</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">lock_t</span><span class="p">;</span>

<span class="cp">#define STRINGIFY(s) #s</span>
<span class="cp">#define TOSTRING(s) STRINGIFY(s)</span>
<span class="cp">#define LOCK_INIT() \</span>
<span class="cp">    ((lock_t) { \</span>
<span class="cp">        .mutex = MUTEX_INIT(), \</span>
<span class="cp">        .name = __FILE__ &quot;:&quot; TOSTRING(__LINE__), \</span>
<span class="cp">    })</span>
<span class="c1">// &quot;a.c&quot; &quot;:&quot; &quot; 3&quot;</span>
<span class="c1">// &quot;a.c: 3&quot;</span>
</code></pre></div>
<blockquote>
<p>çœŸçš„æ˜¯æœ‰å¿…è¦å»å­¦è¿™ä¸ªç¦»æ•£æ•°å­¦å’Œæ•°æ®ç»“æ„ä¸ç®—æ³•å•Šï¼æ·¦</p>
</blockquote>
<p>é™æ€åœ°åˆ›å»ºå¥½äº†é”çš„å›¾ï¼Œè¿™æ ·å°±èƒ½å°½å¯èƒ½åœ°é™ä½åŠ¨æ€å¼€é”€ï¼Ÿå†çœ‹çœ‹ä¸Šé¢çš„æ–‡ç« é‡Œçš„ã€‚</p>
</li>
<li>
<p>ä½¿ç”¨</p>
<p>å®é™…ç³»ç»Ÿä¸­æ¯”è¾ƒå¸¸è§çš„åšæ³•ï¼Œè€Œä¸æ˜¯ç›´æ¥ç”¨ <code>LOCK_INIT</code>ï¼šå°†é”ç»‘å®šåˆ°å¯¹è±¡ï¼ˆå¯¹è±¡åˆå§‹åŒ–çš„æ—¶å€™å°±åˆå§‹åŒ–è¿™æŠŠé”ï¼‰ï¼Œå› ä¸ºåœ¨çœŸå®çš„ç³»ç»Ÿä¸­ç»å¤§æ•°å†…å®¹éƒ½æ˜¯åŠ¨æ€åˆ†é…çš„ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="n">lock_t</span><span class="w"> </span><span class="n">lk1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LOCK_INIT</span><span class="p">();</span>
<span class="n">lock_t</span><span class="w"> </span><span class="n">lk2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LOCK_INIT</span><span class="p">();</span>
<span class="n">lock_t</span><span class="w"> </span><span class="n">lk3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LOCK_INIT</span><span class="p">();</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">some_object</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">lock_t</span><span class="w"> </span><span class="n">lock</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">object_init</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">some_object</span><span class="w"> </span><span class="o">*</span><span class="n">obj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LOCK_INIT</span><span class="p">();</span>
<span class="w">    </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">create_object</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">some_object</span><span class="w"> </span><span class="o">*</span><span class="n">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">some_object</span><span class="p">));</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
<span class="w">    </span><span class="n">object_init</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

<span class="w">    </span><span class="n">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="w">    </span><span class="n">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

<span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</li>
</ul>
<h4 id="threadsanitizer">ThreadSanitizerï¼šè¿è¡Œæ—¶çš„æ•°æ®ç«äº‰æ£€æŸ¥</h4>
<p>é™¤äº†æ­»é”ï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªæ•°æ®ç«äº‰çš„é—®é¢˜ï¼Œé‚£å‰äººæ€ä¹ˆæƒ³çš„ï¼Ÿ</p>
<p>å›åˆ°æ•°æ®ç«äº‰çš„å®šä¹‰ï¼Œå¯¹åŒä¸€å˜é‡ï¼Œè‡³å°‘æœ‰ä¸€ä¸ªå†™ï¼Œé‚£å°±æ˜¯å¯¹å†…å­˜çš„è®¿é—®ï¼é‚£å°±æœ‰ç‚¹åƒ <code>mtrace</code> äº†ï¼ä½†æ˜¯æ“ä½œå¤šçº¿ç¨‹çš„</p>
<blockquote>
<p>åŒæ—¶å‘ç”Ÿåœ¨ä¸åŒçº¿ç¨‹ã€åŒä¸€å˜é‡ã€è‡³å°‘ä¸€ä¸ªæ˜¯å†™æ“ä½œï¼š</p>
<p><code>T1: load(x);</code></p>
<p><code>T1: t = t + 1;</code></p>
<p><code>T2: store(x);</code></p>
</blockquote>
<p>é‚£æ€ä¹ˆè¿›è¡Œspecçš„æ£€æŸ¥ï¼Œæ£€æŸ¥ä»€ä¹ˆï¼Ÿå¯¹äºå‘ç”Ÿåœ¨ä¸åŒçº¿ç¨‹ä¸”è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯å†™çš„ x,y æ£€æŸ¥ï¼Œå…·ä½“åæ˜ åˆ°ä»£ç ä¸Šï¼Œæ€ä¹ˆå®ç°ï¼Ÿ</p>
<p>æˆ‘ä»¬æ˜¯é€šè¿‡åŠ é”æ¥è§£å†³å…±äº«å˜é‡ data race çš„ï¼Œé‚£ï¼Œè¿›ä¸€æ­¥ä½“ç°åˆ°å°±æ˜¯è¿™ä¸ªå…±äº«å˜é‡å­˜åœ¨ â€œHappens-before raceâ€ï¼Œé‚£ä¹Ÿå°±æ˜¯è¯´ï¼Œæ€ä¹ˆè§‚æµ‹è¿™ä¸ª Happens-before å…³ç³»ï¼Œè§‚æµ‹åˆ°è¿™ä¸ªå°±çŸ¥é“è‡ªå·±çš„é”ä¸Šçš„å¯¹ä¸å¯¹ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯å¼ºè¡Œè®©ä»–å­˜åœ¨æ—¶é—´å…ˆåå…³ç³»ï¼Ÿæ€ä¹ˆåœ¨ä»£ç ä¸Šå®ç°ï¼Ÿ</p>
<ul>
<li>â€œHappens-before raceâ€</li>
<li>å®ç°ï¼šLamport's Vector Clock: <a href="https://dl.acm.org/doi/10.1145/359545.359563">Time, clocks, and the ordering of events in a distributed system</a></li>
</ul>
<p>å…ˆä¸ç®¡å®ç°äº†ï¼Œå…ˆç”¨ï¼šç›´æ¥åŠ ï¼š<code>CFLAGS += -fsanitize=thread</code></p>
<h4 id="summarysanitizer">Summaryï¼šSanitizer</h4>
<p><strong><mark>ç°ä»£å¤æ‚è½¯ä»¶ç³»ç»Ÿå¿…å¤‡çš„æ”¯æ’‘å·¥å…·ï¼šsanitizer</mark></strong></p>
<p><strong>æ ¸å¿ƒæ€æƒ³å°±æ˜¯è¿è¡Œæ—¶æ£€æŸ¥ spec</strong>ï¼Œæ¯ä¸ªäººéƒ½èƒ½åšä¸ªè‡ªå·±é¢†åŸŸçš„sanitizerï¼</p>
<ul>
<li>AddressSanitizer (asan); (paper): éæ³•å†…å­˜è®¿é—®<ul>
<li>Buffer (heap/stack/global) overflow, use-after-free, use-after-return, double-free, ...</li>
<li>æ²¡æœ‰ <a href="https://www.kernel.org/doc/html/latest/dev-tools/kasan.html">KASAN</a>, Linux Kernel çš„è´¨é‡/å®‰å…¨æ€§ç›´æ¥å´©ç›˜</li>
</ul>
</li>
<li>ThreadSanitizer (tsan): æ•°æ®ç«äº‰<ul>
<li>KCSAN: <a href="https://lwn.net/Articles/816850/">Concurrency bugs should fear the big bad data-race detector</a></li>
</ul>
</li>
<li><a href="https://clang.llvm.org/docs/MemorySanitizer.html">MemorySanitizer</a> (msan), <a href="https://clang.llvm.org/docs/UndefinedBehaviorSanitizer.html">UBSanitizer</a> (ubsan), ...</li>
<li>SpecSanitizer: åŸºäº AI/LLM çš„ â€œspecification æ£€æŸ¥â€<ul>
<li>å°±ç­‰ä½ æ¥å¼€å‘äº†</li>
</ul>
</li>
</ul>
<blockquote>
<p>åœ¨ â€œæœ‰ specificationâ€ çš„æƒ…å†µä¸‹ï¼Œå¼€å‘è€…ä¸€å®šä¼šæƒ³åˆ°åˆé€‚çš„æ–¹æ³•æ£€æŸ¥å®ƒä»¬ï¼Œä»¥æé«˜è½¯ä»¶çš„è´¨é‡ã€‚</p>
<p>å¾ˆæ˜¾ç„¶ï¼ŒC è¯­è¨€åªæä¾› â€œåº•å±‚æœºåˆ¶â€ çš„è®¾è®¡ï¼Œåœ¨ç®¡ç†å¤§å‹å¤æ‚é¡¹ç›®æ—¶æ‰è¥Ÿè§è‚˜ã€‚Linux Kernel å¦‚æœæ²¡æœ‰ ASAN å’Œ TSAN æœºåˆ¶ï¼Œå°†ä¼šå˜å¾—åƒç–®ç™¾å­”ã€‚</p>
</blockquote>
<p>éœ€è¦æ›´å¤šçš„å®è·µæ¥è¯•éªŒè¿™äº›å†…å®¹ï¼Œè¿˜æœ‰ï¼Œåœ¨åµŒå…¥å¼é¢†åŸŸå¥½åƒå¹¶æ²¡æœ‰è¿™ä¹ˆå¤šçš„å·¥å…·ï¼Ÿåº”è¯¥æ˜¯æˆ‘çŸ¥é“çš„å¤ªå°‘äº†ï¼Œå¯ä»¥å°†è¿™äº›å†…å®¹è¿ç§»è¿‡å»çœ‹çœ‹ï¼Ÿ</p>
<h3 id="deadline">åº”å¯¹æ­»çº¿ (Deadline)ï¼šé˜²å¾¡æ€§ç¼–ç¨‹</h3>
<p>å¯¹äº OS è¯¾å®éªŒï¼Œåšä¸Šé¢è¿™ä¹ˆä¸€ä¸ªå·¥å…·æœ‰ç‚¹ä¸å¤ªæƒ³ï¼Œæ¯•ç«Ÿæœ‰deadlineï¼Œä½†å®ç°ä¸ªä¸ç‰ˆçš„ï¼Œåº”è¯¥å¯ä»¥æŠŠï¼Ÿï¼</p>
<p><img alt="image-20250123110218256" src="pic/image-20250123110218256.png" /></p>
<p>ç›¸ä¿¡è‡ªå·±ï¼Œæ—¢ç„¶åšä¸äº†æ¯”è¾ƒå®Œå¤‡çš„ï¼ˆä¹Ÿä¸å¤ªå¯èƒ½ï¼‰ï¼Œé‚£å°±å®ç°ä¸å®Œæ•´çš„æ£€æŸ¥å‘€ï¼Œä¸€æ­¥æ­¥æŸ¥ã€‚</p>
<p>æŠŠä¸Šé¢é‚£äº› sanitizerï¼ˆç¼–è¯‘å™¨å¸®æˆ‘ä»¬åšï¼‰ï¼Œåœ¨åŸºç¡€æ¯”è¾ƒå…³é”®çš„åœ°æ–¹ï¼Œæˆ‘ä»¬æ‰‹åŠ¨åœ°æ’å…¥å‡ æ¡ assertionã€‚</p>
<p><strong><mark>ç”¨å¾ˆå°‘çš„ä»£ç å®ç°æ‰“æŠ˜ä½†70%çš„æ•ˆæœ</mark></strong></p>
<h4 id="canarystack-guard">Canaryï¼šStack Guard</h4>
<p>æ ˆæº¢å‡º</p>
<div class="highlight"><pre><span></span><code><span class="cp">#define MAGIC 0x55555555</span>
<span class="cp">#define BOTTOM (STK_SZ / sizeof(u32) - 1)</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">stack</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">STK_SZ</span><span class="p">];</span><span class="w"> </span><span class="p">};</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">canary_init</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">stack</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">u32</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">CANARY_SZ</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="n">ptr</span><span class="p">[</span><span class="n">BOTTOM</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAGIC</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">canary_check</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">stack</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">u32</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">CANARY_SZ</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">panic_on</span><span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="n">BOTTOM</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">MAGIC</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;underflow&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">panic_on</span><span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">MAGIC</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;overflow&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>ç»™åç¨‹/çº¿ç¨‹/è¿›ç¨‹åˆ†é…æ ˆçš„æ—¶å€™ï¼Œç‰ºç‰²ä¸€äº›æ ˆé¡¶/æ ˆåº•çš„ç©ºé—´ï¼Œæ¥å†™ä¸€ä¸ªMAGIC_NUMBERï¼Œæ¯æ¬¡åœ¨ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ—¶å€™éƒ½çœ‹çœ‹é‚£äº›ä½ç½®çš„å€¼è¿˜æ˜¯ä¸æ˜¯MAGIC_NUMBERï¼Œç”±æ­¤æ¥åˆ¤æ–­æ˜¯å¦å‘ç”Ÿæº¢å‡ºï¼ˆoverflowã€underflowï¼‰</p>
<h4 id="lockdep">é˜²å¾¡æ€§ç¼–ç¨‹ï¼šä½é…ç‰ˆ Lockdep</h4>
<p>é«˜é…ç‰ˆ lockdep å¤ªå¤æ‚ï¼Ÿ</p>
<ul>
<li>ç»Ÿè®¡å½“å‰çš„ <code>spin count</code></li>
<li>å¦‚æœè¶…è¿‡æŸä¸ªæ˜æ˜¾ä¸æ­£å¸¸çš„æ•°å€¼ (100,000,000) å°±æŠ¥å‘Š<ul>
<li>ä½ æ„Ÿè§‰åˆ° â€œhangâ€ äº†</li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="n">spin_cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="p">,</span><span class="w"> </span><span class="err">âŒ</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="err">âŒ</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">spin_cnt</span><span class="o">++</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">SPIN_LIMIT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;Spin limit exceeded @ %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">__FILE__</span><span class="p">,</span><span class="w"> </span><span class="n">__LINE__</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>é…åˆè°ƒè¯•å™¨å’Œçº¿ç¨‹ backtrace ä¸€ç§’è¯Šæ–­æ­»é”</li>
</ul>
<h4 id="addresssanitizer">é˜²å¾¡æ€§ç¼–ç¨‹ï¼šä½é…ç‰ˆ AddressSanitizer</h4>
<p>ä½¿ç”¨canary</p>
<p>å—åˆ° åˆå§‹åŒ–å†…å­˜å€¼çš„å¯å‘ï¼š</p>
<p><img alt="image-20250123112308172" src="pic/image-20250123112308172.png" /></p>
<p>åˆ†é…äº†å“ªéƒ¨åˆ†å†…å­˜ï¼Œé‚£å°±åœ¨è¿™ç‰‡åŒºåŸŸå†™ä¸€äº›åˆ·æˆé»„è‰²ï¼Œå›æ”¶å°±æŠŠè¿™ç‰‡åŒºåŸŸåˆ·æˆç™½è‰²ï¼Œå¦‚æœå†…å­˜åˆ†é…å™¨è¿”å›å›æ¥çš„ä¸æ˜¯ç™½è‰²çš„ï¼Œé‚£å°±å‘ç”Ÿäº† double-allocationã€‚å¦å¤–ï¼Œåœ¨è§£å¼•ç”¨ä»»ä½•å†…å­˜åœ°å€çš„æ—¶å€™ï¼Œéƒ½è¦æ±‚è¿™ç‰‡åŒºåŸŸæ˜¯é»„è‰²çš„ï¼Œå¦åˆ™å°±æ˜¯ use-after-freeã€‚</p>
<p>ååº”åˆ°ä»£ç ä¸Šï¼Œä¸å°±æ˜¯å†™ä¸€äº›ç‰¹æ®Šå€¼å—ï¼Ÿè¿›ä¸€æ­¥å°±æ˜¯ L1 å†…å­˜åˆ†é…å™¨çš„ specificationï¼š</p>
<ul>
<li>å·²åˆ†é…å†…å­˜ S=[â„“0,r0)âˆª[â„“1,r1)âˆªâ€¦</li>
<li>kalloc(s<em>s</em>) è¿”å›çš„ [â„“,r)[â„“,<em>r</em>) å¿…é¡»æ»¡è¶³ [â„“,r)âˆ©S=âˆ…</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">// allocation</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">panic_on</span><span class="p">(((</span><span class="n">u32</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MAGIC</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;double-allocation&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAGIC</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// free</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">alloc_size</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">panic_on</span><span class="p">(((</span><span class="n">u32</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;double-free&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<blockquote>
<p>å†™ä»£ç æ—¶ï¼Œå¤šè€ƒè™‘ spec æ˜¯ä»€ä¹ˆï¼Ÿ</p>
</blockquote>
<h4 id="threadsanitizer_1">é˜²å¾¡æ€§ç¼–ç¨‹ï¼šä½é…ç‰ˆ ThreadSanitizer</h4>
<p>æ•°æ®ç«äº‰çš„è¡¨ç°ï¼š</p>
<ul>
<li>è·‘èµ¢è·‘è¾“çš„ç»“æœä¼šå½±å“çŠ¶æ€</li>
<li>æˆ‘ä»¬<strong>è§‚æµ‹</strong>çŠ¶æ€å½±å“å°±å¯ä»¥äº†ï¼</li>
</ul>
<p>è®©ä¸€ä¸ªçº¿ç¨‹è·‘çš„ç‰¹åˆ«å¿«ï¼Œä¸€ä¸ªè·‘çš„ç‰¹åˆ«æ…¢ï¼Œæ€»èƒ½å‡ºç»“æœã€‚</p>
<p>åœ¨é‚£ä¸ªè·‘å¾—å¿«çš„çº¿ç¨‹é‡Œï¼Œä¸€ç›´å¯¹è§‚æµ‹ç»“æœè¿›è¡Œassertionï¼Œå› ä¸ºæ¯ä¸€æ¬¡çš„loadç»“æœéƒ½åº”è¯¥æ˜¯ç›¸åŒçš„å‘€ï¼å¦‚æœè¢«æ”¹äº†ï¼Œå°±æ˜¯æœ‰æ•°æ®ç«äº‰ï¼</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Suppose x is lock-protected</span>

<span class="p">...</span>
<span class="kt">int</span><span class="w"> </span><span class="n">observe1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="n">delay</span><span class="p">();</span>
<span class="kt">int</span><span class="w"> </span><span class="n">observe2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>

<span class="n">assert</span><span class="p">(</span><span class="n">observe1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">observe2</span><span class="p">);</span>
<span class="p">...</span>
</code></pre></div>
<ul>
<li><a href="https://www.usenix.org/legacy/events/osdi10/tech/full_papers/Erickson.pdf">Effective data-race detection for the Kernel</a> (OSDI'10)</li>
</ul>
<h4 id="semanticsanitizer">é˜²å¾¡æ€§ç¼–ç¨‹ï¼šSemanticSanitizer</h4>
<ul>
<li>æ£€æŸ¥æ•´æ•°æ˜¯å¦åœ¨æŸä¸ªèŒƒå›´</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="cp">#define CHECK_INT(x, cond) \</span>
<span class="cp">    ({ panic_on(!((x) cond), \</span>
<span class="cp">       &quot;int check fail: &quot; \</span>
<span class="cp">       #x &quot; &quot; #cond); \</span>
<span class="cp">    })</span>
</code></pre></div>
<ul>
<li>æ£€æŸ¥æŒ‡é’ˆæ˜¯å¦ä½äºå †åŒº</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="cp">#define CHECK_HEAP(ptr) \</span>
<span class="cp">    ({ panic_on(!IN_RANGE((ptr), heap)); })</span>
</code></pre></div>
<p>ç”¨äºï¼š</p>
<ul>
<li>
<p>æ£€æŸ¥å†…éƒ¨æ•°æ®ä¸€è‡´æ€§</p>
<ul>
<li><code>CHECK_INT(waitlist-&gt;count, &gt;= 0);</code></li>
<li><code>CHECK_INT(pid, &lt; MAX_PROCS);</code></li>
<li><code>CHECK_HEAP(ctx-&gt;rip); CHECK_HEAP(ctx-&gt;cr3);</code></li>
</ul>
</li>
<li>
<p>ä»£å…¥ â€œå˜é‡è¯­ä¹‰â€</p>
<ul>
<li>
<p><code>CHECK_INT(count, &gt;= 0);</code></p>
</li>
<li>
<p><code>CHECK_INT(count, &lt;= 10000);</code></p>
</li>
<li>
<p>é¢„é˜²å¤šç§é”™è¯¯ï¼Œç”šè‡³</p>
<p>éƒ¨åˆ†æ‰¿æ‹…äº† AddressSanitizer çš„åŠŸèƒ½</p>
<ul>
<li>Overflow, use-after-free éƒ½å¯èƒ½å¯¼è‡´ memory corruption</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="summary_2">Summaryï¼šè¿™æ‰æ˜¯çœŸæ­£çš„ â€œç¼–ç¨‹â€</h4>
<ul>
<li>
<p>çŸ­çŸ­å‡ è¡Œä»£ç ï¼Œæˆ‘ä»¬å®ç°äº†</p>
<ul>
<li>Stack guard</li>
<li>Lockdep (simple)</li>
<li>AddressSanitizer (simple)</li>
<li>ThreadSanitizer (simple)</li>
<li>SemanticSanitizer</li>
</ul>
<blockquote>
<p>ä¼¼ä¹è¿˜æœ‰ä¸€ä¸ªå« <code>SystemTap</code> çš„å·¥å…·ï¼Œä¹Ÿå¯ä»¥äº†è§£çœ‹çœ‹ï¼ŒåŒæ ·ä¹Ÿæ˜¯åŠ¨æ€è·Ÿè¸ªçš„å·¥å…·ï¼Œä¸è¿‡å¥½åƒæ˜¯å…³æ³¨äºæ€§èƒ½å’ŒåŠŸèƒ½çš„ã€‚<a href="https://sourceware.org/systemtap/tutorial.pdf">SystemTap tutorial</a></p>
</blockquote>
</li>
<li>
<p>å®ƒä»¬æ˜¯ä¸€ä¸ªç§å­</p>
<ul>
<li>æŒ‡å‘ â€œengineeringâ€ é‡Œæ— é™çš„ç©ºé—´</li>
<li>ä¹ŸæŒ‡å¼•æˆ‘ä»¬åæ€ç¼–ç¨‹è¯­è¨€çš„æœºåˆ¶è®¾è®¡</li>
</ul>
</li>
</ul>
<p>å¾ˆå¤šè¿ç”¨åˆ°å®é™…å†…æ ¸ä¸­çš„å·¥å…·éƒ½æ˜¯ä»è¿™ä¹ˆä¸€ç‚¹ç‚¹å°çš„æƒ³æ³•å‘å±•å‡ºæ¥çš„ã€‚</p>
<p>è€Œè¿™ä¸€ç‚¹ç‚¹å°çš„æƒ³æ³•åˆæ˜¯å»ºç«‹åœ¨æˆ‘ä»¬èƒ½å¤Ÿæ¸…æ¥šåœ°è¿½æº¯åˆ°é—®é¢˜äº§ç”Ÿçš„æœ¬æºï¼ˆæ•°æ®ç«äº‰ã€æ­»é”ï¼‰ï¼Œå†å°†æƒ³æ³•ä»˜è¯¸å®ç°ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªè§£å†³é—®é¢˜çš„å¥½æ–¹æ³•ã€‚</p>
<blockquote>
<p>å±±å¯¨çš„ sanitizers åœ¨æš—ä¸­å¸®åŠ©ä½ å®ç° fail-fast çš„ç¨‹åºï¼Œä»è€Œå‡è½»ä½ è°ƒè¯•é—®é¢˜çš„è´Ÿæ‹…ã€‚å¸Œæœ›è¿™èŠ‚è¯¾èƒ½å¯å‘ã€å¸®åŠ©ä½ é‡æ–°æ€è€ƒ â€œç¼–ç¨‹â€ è¿™ä»¶äº‹ã€‚</p>
</blockquote>
<h2 id="summary_3">Summary</h2>
<p>ç”±æ­¤ï¼Œå¤šæ ¸å¤„ç†å™¨äº†è§£ä¸€ç‚¹äº†ï¼Œå¯¹äºä¸€äº›å¹¶å‘çš„å†…å®¹ï¼šäº’æ–¥ã€åŒæ­¥ã€åŸå­æ€§ç­‰å†…å®¹ä¹Ÿæœ‰æ¯”ä»¥å‰æ›´åŠ æ·±å…¥çš„äº†è§£äº†ã€‚</p>
<p>è¿›ä¸€æ­¥ï¼Œéœ€è¦å®è·µæ¥çœ‹çœ‹ã€‚</p>
<p>è¿˜æœ‰å°½å¯ä»¥branchä¸€äº›è‡ªå·±çš„é—®é¢˜ã€‚</p>
<h2 id="_42">ä¸€äº›é—®é¢˜</h2>
<h3 id="barriersequence">barrierã€sequence</h3>
<ul>
<li>å…³äºç¼–è¯‘å™¨æŒ‡ä»¤é‡æ’å’Œå†…å­˜å±éšœå’Œ CPU çš„ä¹±åºæ‰§è¡Œè¿™äº›æ’åºåŒºåˆ«å’Œå…³ç³»ä½œç”¨ï¼Ÿéƒ½æ˜¯ä¸ºäº†è§£å†³ä»€ä¹ˆè€Œæå‡ºçš„ï¼Ÿæ„Ÿè§‰æ··åœ¨ä¸€èµ·äº†</li>
<li>å†…å­˜æ¨¡å‹åˆæ˜¯æ€ä¹ˆæå‡ºæ¥çš„ï¼Ÿ</li>
</ul>
<p>è¿™äº›éœ€è¦è¡¥å……ä¸€äº›å¹¶å‘åŸºç¡€çŸ¥è¯†ã€‚</p>
<p><a href="https://en.cppreference.com/w/c/atomic/memory_order">memory_order - cppreference.com</a></p>
<h3 id="paper">paper</h3>
<ul>
<li>PPT ä¸­çš„å¾ˆå¤šè®ºæ–‡å‘€ï¼Œéƒ½æƒ³çœ‹çœ‹å¤§å®¶æ˜¯æ€ä¹ˆè§£å†³è¿™äº›é—®é¢˜çš„ã€‚</li>
<li>ç¦»æ•£æ•°å­¦ã€æ•°æ®ç»“æ„ä¸ç®—æ³•å¾ˆé‡è¦ï¼Œä¸ºäº†è§£å†³ä¸Šé¢çš„ä¸€äº›é—®é¢˜ï¼ŒçœŸçš„æ˜¯éœ€è¦ç”¨åˆ°çš„å‘€ï¼</li>
</ul>
<h3 id="todo"><strong><mark>TODO</mark></strong></h3>
<ul>
<li><a href="https://dl.acm.org/doi/pdf/10.1145/356586.356588">System Deadlocks</a></li>
<li><a href="https://www.hboehm.info/misc_slides/pldi05_threads.pdf">Threads Cannot be  Implemented as a  Library</a></li>
</ul>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class="timeago" datetime="2025-02-12T18:33:04+01:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2025-02-12</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class="timeago" datetime="2025-01-05T17:02:30+01:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2025-01-05</span>
  </span>

    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../1.%20introduction/introduction.html" class="md-footer__link md-footer__link--prev" aria-label="Previous: introduction">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256l137.3-137.4c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                introduction
              </div>
            </div>
          </a>
        
        
          
          <a href="../3.%20virtualization/virtualization.html" class="md-footer__link md-footer__link--next" aria-label="Next: virtualization">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                virtualization
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="https://github.com/JAILuo" target="_blank" rel="noopener" title="JAILuo" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../../../..", "features": ["navigation.footer"], "search": "../../../../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../../../assets/javascripts/bundle.83f73b43.min.js"></script>
      
        <script src="../../../../../js/timeago.min.js"></script>
      
        <script src="../../../../../js/timeago_mkdocs_material.js"></script>
      
        <script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
      
    
  </body>
</html>